# V8.14 P1 設計差異分析

**日期**：2026-01-19  
**版本**：V8.14  
**狀態**：📋 **差異分析（僅討論，未定案）**

---

## 📋 分析目的

比較現有 P1 設計與新定位的差異，識別：
- ✅ **符合**：現有設計已符合新定位的部分
- ❌ **違背**：現有設計與新定位衝突的部分
- 🔧 **可補強**：現有設計可優化的部分
- ⚠️ **遺漏**：新定位要求但現有設計缺少的部分

---

## 🔍 核心定位對比

### **現有設計**
- **定位**：三層適配檢查（ENG_Fit, STRUCT_Fit, TIME_ROLE_Fit）
- **輸出**：三池分類（Master_Candidates, Tracking_Pool, Rejection_Pool）
- **繼承**：P0 + P0.7

### **新定位**
- **定位**：產業鏈公司定位與結構分級（Industry Chain Tiering）
- **輸出**：公司池 + 結構定位 + 受益/受害機制 + 分級（S/A/B/X）
- **繼承**：P0 + P0.5 + P0.7

### **差異分析**
- ⚠️ **定位差異**：現有設計強調「適配檢查」，新定位強調「結構分級」
- ⚠️ **輸出差異**：現有設計使用「三池分類」，新定位使用「Tier S/A/B/X」
- ⚠️ **繼承差異**：現有設計缺少 P0.5 的明確繼承

---

## 1️⃣ AI 模型配置差異

### **現有設計**
```javascript
// src/02_M0_CONFIG.js
TASK_TO_EXECUTOR = {
  "P1": "SONNET",  // 單一執行者
  // 審查者：GPT-5.2（自動選擇）
}
```

### **新定位**
- **Step 1（股票池生成）**：Gemini Flash 3.0
- **Step 2（結構分級）**：Gemini Pro 3.0
- **審查者**：GPT-5.2（不變）

### **差異分析**
- ❌ **違背**：現有設計使用單一模型（SONNET），新定位要求兩階段、兩模型
- ⚠️ **遺漏**：現有設計沒有區分「股票池生成」和「分級」兩個階段

---

## 2️⃣ 執行模式差異

### **現有設計**
- **單一階段**：一次呼叫完成所有分析
- **流程**：讀取 P0/P0.7 → 構建 Prompt → 提交 M0 → 處理結果 → 保存三池

### **新定位**
- **兩階段執行**：
  1. **Step 1（股票池生成）**：Gemini Flash 3.0
     - 根據 P0/P0.5/P0.7 找出所有相關公司
     - 讀取財報 Business Description 驗證
     - 產出 15-30 檔公司清單（美:台:日 = 5:3:2）
  2. **Step 2（結構分級）**：Gemini Pro 3.0
     - 檢視 Step 1 的結果
     - 按 Tier S/A/B/X 分級
     - 分析受益/受害機制

### **差異分析**
- ❌ **違背**：現有設計是單一階段，新定位要求兩階段
- ⚠️ **遺漏**：現有設計沒有明確的「股票池生成」階段
- ⚠️ **遺漏**：現有設計沒有明確的「分級」階段

---

## 3️⃣ 繼承規則差異

### **現有設計**
```javascript
// src/20_P1_COMPANY_POOL.js
m0InputPayload = {
  p0_output: p0Output,
  p0_7_output: p0_7Output,
  // ⚠️ 沒有明確包含 P0.5
}
```

### **新定位**
- **必須繼承**：P0 + P0.5 + P0.7
- **P0.5 內容**：產業鏈地圖（Nodes / 上中下游 / 互補 / 替代）
- **禁止事項**：
  - ❌ 不得改寫 P0 主敘事
  - ❌ 不得加入新宏觀論述
  - ✅ 唯一可新增：公司與節點的映射、受益/受害機制、分級理由

### **差異分析**
- ⚠️ **遺漏**：現有設計沒有明確繼承 P0.5
- ✅ **符合**：現有設計有繼承 P0 和 P0.7
- ⚠️ **可補強**：現有 Prompt 沒有明確禁止改寫 P0 主敘事

---

## 4️⃣ 股票池生成差異

### **現有設計**
- **方式**：AI 模型根據 P0/P0.7 輸出直接生成公司清單
- **驗證**：三層適配檢查（ENG_Fit, STRUCT_Fit, TIME_ROLE_Fit）
- **數量**：測試模式限制每個 Theme 10 間公司

### **新定位**
- **方式**：Gemini Flash 3.0 根據 P0/P0.5/P0.7 找出所有相關公司
- **驗證**：必須讀取最新一季財報 Business Description 段落
- **財報來源**：程式直接抓取（SEC/MOPS/EDINET），零搜尋、零登入
- **數量**：15-30 檔（美:台:日 = 5:3:2，建議比例，無法達成沒關係）
- **分類**：上游/中游/下游/互補性產業/受害性產業（主動獵殺舊技術龍頭）
- **證明**：必須附上財報段落證明公司對位正確
- **缺失處理**：如果抓不到財報，標記但不剔除（避免單點失效）

### **差異分析**
- ❌ **違背**：現有設計沒有要求讀取財報 Business Description
- ⚠️ **遺漏**：現有設計沒有明確的市場比例要求（美:台:日 = 5:3:2）
- ⚠️ **遺漏**：現有設計沒有「受害性產業」的識別
- ⚠️ **遺漏**：現有設計沒有要求附上財報段落證明
- ⚠️ **遺漏**：現有設計沒有「主動獵殺舊技術龍頭」的機制

---

## 5️⃣ 分級系統差異

### **現有設計**
- **分級方式**：三池分類
  - Master_Candidates（三層適配全部 Pass）
  - Tracking_Pool（部分 Pass，證據不足/時間錯位）
  - Rejection_Pool（任一 Fail）
- **分級依據**：三層適配檢查結果

### **新定位**
- **分級方式**：Tier S/A/B/X
  - **Tier S**：核心瓶頸/不可取代（Kingmaker）
  - **Tier A**：高連動受益/次核心（Contender）
  - **Tier B**：順風受益/邊緣紅利（Beneficiary）
  - **Tier X**：結構性受害者（Victim/Squeezed）
- **分級依據**：結構性特徵（Choke Point、Pricing Power、Substitutability 等）

### **差異分析**
- ❌ **違背**：現有設計使用「三池分類」，新定位使用「Tier S/A/B/X」
- ⚠️ **遺漏**：現有設計沒有 Tier X（結構性受害者）的概念
- ⚠️ **遺漏**：現有設計沒有明確的 Tier S/A/B 定義

---

## 6️⃣ 禁止事項差異

### **現有設計**
- **禁止**：沒有明確的禁止事項列表
- **允許**：三層適配檢查、Moat_Type 分類、Rerate_State 分類

### **新定位**
- **禁止使用作為分級依據**：
  - ❌ EPS / 成長率 / 營收佔比 / 毛利率數字
  - ❌ 估值（P/E、FPE、PEG）
  - ❌ 技術分析（均線、支撐壓力）
  - ❌ 用股價漲跌證明地位
- **允許的證據**：
  - ✅ 公司的產品/服務是否對應 P0 的節點
  - ✅ 供應鏈位置與依賴關係
  - ✅ 產業常識級的競爭格局
  - ✅ P0.7 的週期風險如何影響該位置

### **差異分析**
- ⚠️ **遺漏**：現有設計沒有明確禁止使用財務數據作為分級依據
- ⚠️ **遺漏**：現有設計沒有明確禁止使用估值、技術分析、股價作為證據
- ⚠️ **可補強**：現有 Prompt 可以加入更明確的禁止事項

---

## 7️⃣ 數據來源差異

### **現有設計**
- **數據來源**：P0 和 P0.7 的輸出
- **驗證方式**：三層適配檢查
- **外部數據**：沒有明確要求讀取財報

### **新定位**
- **數據來源**：必須完全來自系統內已完成的 P0/P0.5/P0.7
- **驗證方式**：必須讀取最新一季財報 Business Description
- **財報來源**：程式直接抓取（已寫死），不需要搜尋
  - 🇺🇸 美股：SEC API（Ticker → CIK → 最新 10-K/10-Q）
  - 🇹🇼 台股：MOPS（固定 URL 結構）
  - 🇯🇵 日股：EDINET/金融廳（固定索引）
- **外部數據**：
  - ✅ 允許：正式官方發布資料（財報、年報、法說會逐字稿）
  - ❌ 禁止：網路搜尋「非官方」資料、不知名來源

### **差異分析**
- ⚠️ **遺漏**：現有設計沒有明確要求讀取財報 Business Description
- ⚠️ **遺漏**：現有設計沒有明確禁止使用網路搜尋資料
- ⚠️ **可補強**：現有設計可以加入更明確的數據來源要求

---

## 8️⃣ 輸出格式差異

### **現有設計**
```json
{
  "master_candidates": [...],
  "tracking_pool": [...],
  "rejection_pool": [...],
  "confidence_level": 0.0-1.0
}
```

### **新定位**
- **Step 1 輸出**：公司池清單（15-30 檔，含財報證明段落）
- **Step 2 輸出**：結構分級（Tier S/A/B/X）+ 受益/受害機制

### **差異分析**
- ❌ **違背**：現有設計使用「三池分類」，新定位使用「Tier S/A/B/X」
- ⚠️ **遺漏**：現有設計沒有「受益/受害機制」的明確輸出
- ⚠️ **遺漏**：現有設計沒有財報證明段落的輸出

---

## 9️⃣ 審查規則差異

### **現有設計**
- **審查者**：GPT-5.2
- **審查內容**：沒有明確的審查清單

### **新定位**
- **審查者**：GPT-5.2（不變）
- **審查清單**：
  1. 繼承一致性：是否引用並對齊 P0/P0.5/P0.7，不得改寫敘事
  2. Tier 合理性：S/A/B/X 是否符合定義（不可用財務）
  3. 受益/受害機制完整：每家公司至少 1 條機制描述
  4. 證據足夠：High/Medium/Low confidence 是否合理

### **差異分析**
- ⚠️ **遺漏**：現有設計沒有明確的審查清單
- ⚠️ **可補強**：現有設計可以加入更明確的審查規則

---

## 📊 差異總結表

| 項目 | 現有設計 | 新定位 | 狀態 |
|------|---------|--------|------|
| **AI 模型** | SONNET（單一） | Gemini Flash 3.0 + Gemini Pro 3.0（兩階段） | ❌ 違背 |
| **執行模式** | 單一階段 | 兩階段（股票池生成 + 分級） | ❌ 違背 |
| **繼承來源** | P0 + P0.7 | P0 + P0.5 + P0.7 | ⚠️ 遺漏 |
| **財報驗證** | 無 | 必須讀取 Business Description | ⚠️ 遺漏 |
| **分級系統** | 三池分類 | Tier S/A/B/X | ❌ 違背 |
| **受害性產業** | 無 | Tier X（結構性受害者） | ⚠️ 遺漏 |
| **禁止事項** | 無明確列表 | 明確禁止財務數據/估值/技術分析 | ⚠️ 遺漏 |
| **數據來源** | P0/P0.7 | 必須來自 P0/P0.5/P0.7，禁止網路搜尋 | ⚠️ 遺漏 |
| **市場比例** | 無 | 美:台:日 = 5:3:2 | ⚠️ 遺漏 |
| **財報證明** | 無 | 必須附上財報段落證明 | ⚠️ 遺漏 |
| **受益/受害機制** | 無明確輸出 | 必須輸出機制描述 | ⚠️ 遺漏 |
| **審查清單** | 無明確清單 | 明確的 4 項審查規則 | ⚠️ 遺漏 |

---

## 💡 補強建議（已確認）

### **1. 兩階段執行架構** ✅
- **設計**：將 P1 拆分為兩個順序執行的 M0 Job
  - Job 1：股票池生成（Gemini Flash 3.0）
  - Job 2：結構分級（Gemini Pro 3.0，使用 Job 1 的輸出）
- **執行順序**：必須順序執行，Step 2 等待 Step 1 完成

### **2. P0.5 繼承** ✅
- **設計**：在 `P1_Execute()` 中明確讀取 P0.5 快照
- **假設**：P0.5 一定會先執行，符合單線繼承概念
- **好處**：確保產業鏈地圖資訊被正確使用

### **3. 財報驗證機制** ✅
- **設計**：在 Step 1 中加入財報 Business Description 讀取邏輯
- **財報來源**（程式直接抓取，零搜尋、零登入）：
  
  **🇺🇸 美股（SEC）— 完全自動**
  - 使用公司 Ticker → CIK 對照表（公開）
  - 呼叫 SEC 的 company filings JSON API
  - 取得最新一筆：10-K / 20-F 或 10-Q（若需要季報）
  - **直接避開 PDF：抓 HTML**（最穩、最小、最不會超限）
  - 取得 filing 的 HTML 連結，把 HTML（或只抓 Item 1）丟給 Flash
  - 這不是搜尋，是 API 讀索引
  
  **🇹🇼 台股（MOPS）— 公開資訊觀測站**
  - URL 結構固定，可直接用公司代碼抓「最新一季」
  - MOPS 的設計本來就是給機器抓的（政府網站）
  - PDF 通常跑不掉，使用 Gemini File API 處理
  
  **🇯🇵 日股（EDINET/金融廳）**
  - 有固定索引，文件結構雖醜，但不用登入
  - 可自動抓最新 Annual / Quarterly
  - 能拿 HTML 就拿 HTML，不行就 PDF
  
- **PDF 處理**：使用 Gemini File API（推薦 ⭐⭐⭐）
  - GAS 下載 PDF (Blob)
  - GAS 呼叫 upload endpoint → 取得 fileUri
  - GAS 呼叫 generateContent → 附上 `file_data: { file_uri: "..." }`
  - 適合場景：財報年報 (10-K)，因為年報通常很大（幾十 MB），用這種方式最穩定，不會塞爆 GAS 的請求限制
  
- **缺失處理**：如果抓不到財報，標記為「財報缺失」或「證據不足」，但不剔除（避免單點失效）

### **4. Tier 分級系統** ✅
- **設計**：完全取代「三池分類」，改用「Tier S/A/B/X」
- **舊系統**：Master_Candidates/Tracking_Pool/Rejection_Pool → **刪除**
- **新系統**：Tier S/A/B/X（完全取代）

### **5. 禁止事項明確化** ✅
- **禁止使用作為分級依據**：
  - ❌ **財務績效數據**：EPS / 成長率 / 毛利率數字
  - ❌ **估值**：P/E、FPE、PEG
  - ❌ **技術分析**：均線、支撐壓力
  - ❌ **股價**：用股價漲跌證明地位
- **✅ 允許使用**：
  - ✅ **業務結構佔比（Revenue Exposure / Mix）**：作為判斷「純度」的依據
    - **目的**：區分「靠這個吃飯」（S/A）vs「只是有這個部門」（B）
    - **範例**：Microsoft 的 AI 營收很大，但佔總營收比例可能不如 Palantir
      - 如果不看佔比，Microsoft 很容易因為「具有定價權」被歸類為 S
      - 但它其實比較像 B（受惠但業務雜）
    - **約束**：禁止使用「財務績效數據」（如營收成長率、毛利率數字），但允許使用「業務結構佔比」
  - ✅ 公司的產品/服務是否對應 P0 的節點
  - ✅ 供應鏈位置與依賴關係
  - ✅ 產業常識級的競爭格局
  - ✅ P0.7 的週期風險如何影響該位置

### **6. 數據來源限制** ✅
- **設計**：在 Prompt 中明確要求只使用 P0/P0.5/P0.7 的輸出
- **財報來源**：已寫死（SEC/MOPS/EDINET），不需要搜尋
- **禁止**：網路搜尋「非官方」資料
- **允許**：正式官方發布資料（財報、年報、法說會逐字稿）

### **7. 主動獵殺舊技術** ✅ **新增**
- **設計**：在 P1 Step 1 的 Prompt 中，明確要求 Gemini Flash：
  - 根據 P0 的技術替代路徑（例如光取代銅）
  - **主動搜尋「目前提供舊技術的主流公司」**
  - 將其列入清單並標記為 Tier X 候選
- **理由**：P1 必須主動去獵殺舊技術的龍頭，而不能只被動等 P0.5 給名單
- **重要性**：這是 Tier X（結構性受害者）識別的關鍵機制

### **8. 業務結構佔比（Revenue Exposure）** ✅ **新增**
- **設計**：允許使用 Revenue Exposure / Mix 作為判斷「純度」的依據
- **目的**：區分「靠這個吃飯」（S/A）vs「只是有這個部門」（B）
- **範例**：Microsoft 的 AI 營收很大，但佔總營收比例可能不如 Palantir
  - 如果不看佔比，Microsoft 很容易因為「具有定價權」被歸類為 S
  - 但它其實比較像 B（受惠但業務雜）
- **約束**：禁止使用「財務績效數據」（如營收成長率、毛利率數字），但允許使用「業務結構佔比」

### **9. Confidence / Evidence Sufficiency 規則** ✅ **新增**
- **設計**：因本次硬性要求都要有財報段落，但如果抓不到：
  - 標記為「財報缺失」或「證據不足」
  - 但不剔除（避免單點失效）
  - 在 Confidence 欄位標註 Low

---

## ⚠️ 關鍵衝突點

### **衝突 1：分級系統**
- **現有**：三池分類（Master_Candidates, Tracking_Pool, Rejection_Pool）
- **新定位**：Tier S/A/B/X
- **影響**：需要重新設計輸出格式和後續 Phase 的輸入

### **衝突 2：執行模式**
- **現有**：單一階段（SONNET 一次完成）
- **新定位**：兩階段（Flash 生成 + Pro 分級）
- **影響**：需要重新設計 M0 Job 流程

### **衝突 3：繼承來源**
- **現有**：P0 + P0.7
- **新定位**：P0 + P0.5 + P0.7
- **影響**：需要修改 `P1_Execute()` 函數，讀取 P0.5 快照

---

## 📝 待討論問題（已確認）

### **✅ 問題 1：Tier 與三池的關係**
- **答案**：**Tier S/A/B/X 完全取代三池系統，舊的刪除**
- **影響**：需要重新設計輸出格式，移除 Master_Candidates/Tracking_Pool/Rejection_Pool

### **✅ 問題 2：兩階段執行順序**
- **答案**：**Step 1 和 Step 2 必須按順序執行**
- **影響**：Step 2 必須等待 Step 1 完成，並使用 Step 1 的輸出作為輸入

### **✅ 問題 3：財報驗證範圍**
- **答案**：**所有公司都必須讀取財報，真的沒有就標記但不剔除**
- **影響**：需要設計「財報缺失」的標記機制，避免單點失效

### **✅ 問題 4：受害性產業識別**
- **答案**：**Tier X 是獨立的分類，取代 Rejection_Pool**
- **影響**：需要設計 Tier X 的識別邏輯，包括主動獵殺舊技術龍頭

### **✅ 問題 5：數據來源限制**
- **答案**：**P0.5 一定會先執行，符合單線繼承概念**
- **影響**：P1 可以假設 P0.5 已完成，直接讀取 P0.5 快照

---

## 🎯 設計要點總結（已確認）

### **✅ 已確認的設計決策**

1. **Tier 系統**：完全取代三池，舊系統刪除
2. **兩階段執行**：必須順序執行，Step 2 等待 Step 1
3. **財報驗證**：所有公司都必須讀取，缺失標記但不剔除
4. **P0.5 繼承**：P0.5 一定會先執行，直接讀取快照
5. **財報來源**：程式直接抓取（SEC/MOPS/EDINET），零搜尋
6. **業務結構佔比**：允許使用 Revenue Exposure 判斷純度
7. **主動獵殺**：P1 Step 1 必須主動搜尋舊技術龍頭（Tier X 候選）
8. **市場比例**：美:台:日 = 5:3:2 是建議，無法達成沒關係

---

## 📋 待設計項目（待定案後實現）

### **1. 財報抓取機制**
- [ ] 美股 SEC API 整合（Ticker → CIK → 最新 10-K/10-Q HTML）
- [ ] 台股 MOPS 整合（固定 URL 結構，抓取最新一季 PDF）
- [ ] 日股 EDINET/金融廳整合（固定索引，抓取最新 Annual/Quarterly）
- [ ] Gemini File API 整合（上傳 PDF，取得 fileUri）

### **2. 兩階段 M0 Job 設計**
- [ ] Step 1 Job：股票池生成（Gemini Flash 3.0）
- [ ] Step 2 Job：結構分級（Gemini Pro 3.0）
- [ ] 順序執行邏輯（Step 2 等待 Step 1 完成）

### **3. Tier 分級系統**
- [ ] 移除三池分類（Master_Candidates/Tracking_Pool/Rejection_Pool）
- [ ] 設計 Tier S/A/B/X 輸出格式
- [ ] 設計 Tier X 主動獵殺邏輯

### **4. Prompt 設計**
- [ ] Step 1 Prompt：股票池生成（含財報驗證、主動獵殺）
- [ ] Step 2 Prompt：結構分級（含 Tier 定義、禁止事項）
- [ ] 審查 Prompt：4 項審查規則

### **5. 數據結構**
- [ ] 更新 `Phase1_Master_Candidates` Schema（改為 Tier 系統）
- [ ] 新增財報證明欄位
- [ ] 新增受益/受害機制欄位
- [ ] 新增 Revenue Exposure 欄位

---

## 🎯 下一步行動（待定案）

1. ⏳ **等待用戶說「定案」**：確認所有設計決策
2. ⏳ **設計新架構**：兩階段執行、Tier 分級、財報驗證機制
3. ⏳ **實現財報抓取**：SEC/MOPS/EDINET 整合
4. ⏳ **更新 Prompt**：加入所有補強和禁止事項
5. ⏳ **更新 SSOT**：記錄所有設計決策

---

**此文檔完成 P1 設計差異分析，已確認所有補強和問題回答，等待用戶說「定案」後才開始設計新架構和實現。**
