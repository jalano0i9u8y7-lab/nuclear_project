# 🧪 輕測試系統評估指南 V8.0

## 測試重點

### 1. ✅ 程式是否能夠順利完成

**檢查項目：**
- 執行狀態：`status === "COMPLETED"`
- 執行時間：`duration` 是否在合理範圍內
- 錯誤日誌：檢查是否有 `ERROR` 或異常中斷
- 快照保存：確認各 Phase 的快照已正確保存

**需要檢查的表格/欄位：**
- `M0__JOB_QUEUE`：`status` 欄位應為 `"DONE"`，`error_code` 應為空
- `M0__RESULT`：`status` 欄位應為 `"DONE"`
- 各 Phase 快照表（`P0__SNAPSHOT`、`P1__SNAPSHOT` 等）：確認有新增記錄

---

### 2. 📊 AI 對 Prompt 的回應是否合乎要求

**這是重點評估項目，需要檢查以下表格欄位：**

#### **M0__RESULT 表格**
- **`final_output`**（JSON 字串）：
  - 解析後檢查是否包含所有必需的欄位
  - 格式是否為有效的 JSON
  - 結構是否符合 Prompt 要求的輸出格式

#### **M0__CROSSCHECK_LOG 表格**
- **`step`**：執行步驟（EXECUTOR / AUDITOR）
- **`model_id`**：使用的 AI 模型
- **`input_snapshot`**：輸入給 AI 的完整 Prompt 和上下文
- **`output_snapshot`**：AI 的完整回應（這是評估重點）
- **`note`**：額外註記

**各 Phase 需要檢查的 AI 輸出欄位：**

##### **P0（產業工程學分析）**
檢查 `M0__RESULT.final_output` 或 `M0__CROSSCHECK_LOG.output_snapshot`（EXECUTOR 步驟）：
- ✅ `themes` 陣列：
  - 測試模式：應有 **2 個** themes（1 個工程瓶頸類 + 1 個定價權獨佔類）
  - 正式模式：應包含所有找出的面向
  - 每個 theme 必須包含：
    - `theme_id`、`theme_name`、`description`
    - `analysis_type`：`"ENG"` / `"STRUCT"` / `"BOTH"`
    - **P0-3 強制輸出（五項缺一不可）**：
      - `problem_oneliner`：工程/結構問題一句話
      - `failure_mode`：不用會怎樣（物理/合規/流程失效）
      - `no_alternative_reason`：為何不可替代
      - `convergence_evidence`：工程/制度/行為收斂證據
      - `long_term_time_window`：3-10 年窗口
    - `p0_eng`：工程必然分析（如果 `analysis_type` 為 `ENG` 或 `BOTH`）
    - `p0_struct`：結構性定價權分析（如果 `analysis_type` 為 `STRUCT` 或 `BOTH`）
    - `rejection_check`：否決檢查結果

- ✅ `subthemes` 陣列：
  - 格式同 themes，但必須有 `theme_id` 關聯

##### **P0.7（系統動力學分析）**
檢查 `M0__RESULT.final_output`：
- ✅ `system_dynamics`：系統動力學分析結果
- ✅ `feedback_loops`：反饋循環識別
- ✅ `time_delays`：時間延遲分析

##### **P1（公司池生成）**
檢查 `M0__RESULT.final_output`：
- ✅ `master_candidates` 陣列：
  - 測試模式：每個 theme/subtheme 應有 **5 間公司**
  - 每間公司必須包含：
    - `ticker`、`company_name`、`market`
    - `fit_checks`：三項適配檢查結果
    - `fit_score`：適配分數

##### **P2（基本面分析）**
檢查 `M0__RESULT.final_output`：
- ✅ `tier_assignments`：分層配置結果
- ✅ `financial_analysis`：財務分析結果

##### **P2.5（籌碼面分析）**
檢查數據收集和 AI 分析：
- ✅ `M0__CROSSCHECK_LOG`：確認 CSE_SEARCH 步驟有執行
- ✅ `institutional_data`：機構級數據收集結果
- ✅ `smart_money_analysis`：聰明錢分析

##### **P3（技術面分析）**
檢查 `M0__RESULT.final_output`：
- ✅ `technical_results`：技術分析結果
- ✅ `cat_assignments`：Cat 分類結果

##### **P5 Daily（每日監控）**
檢查數據收集：
- ✅ `P5__DAILY_SNAPSHOT`：每日快照
- ✅ 新聞數據：`news_data` 欄位
- ✅ OHLCV 數據：`ohlcv_data` 欄位
- ✅ 技術指標：`technical_indicators` 欄位

##### **P5 Weekly（週度策略）**
檢查 `M0__RESULT.final_output`：
- ✅ `worldview`：世界觀分析
- ✅ `stock_strategies`：個股策略決策
- ✅ `factor_weights`：動態因子權重
- ✅ `earnings_smart_money_weight`：財報相關聰明錢權重（動態調整）

**評估標準：**
- ✅ 所有必需欄位都存在
- ✅ 數據類型正確（陣列、對象、字符串等）
- ✅ 內容符合 Prompt 要求（例如：P0 的 P0-3 五項強制輸出）
- ✅ 邏輯一致性（例如：`analysis_type` 與實際分析內容對應）
- ⚠️ 如果缺少欄位或格式不符，需要修改 Prompt

---

### 3. 🔄 數據蒐集管線是否暢通

**檢查項目：**

#### **外部數據源**
- ✅ CSE 搜尋：檢查 `M0__CROSSCHECK_LOG` 中是否有 `CSE_SEARCH` 步驟
- ✅ Gemini 搜尋：檢查是否有 `GEMINI_SEARCH` 步驟
- ✅ OHLCV 數據：檢查 `P5__DAILY_SNAPSHOT` 中的 `ohlcv_data`
- ✅ 新聞數據：檢查 `news_data` 欄位是否有內容

#### **數據流轉**
- ✅ P0 → P0.7 → P1：檢查快照 ID 關聯
- ✅ P1 → P2 → P2.5 → P3：檢查 `master_candidates` 是否正確傳遞
- ✅ P2/P3 → P4：檢查 `tier_assignments` 和 `cat_assignments` 是否正確傳遞
- ✅ P4 → P5：檢查配置結果是否正確傳遞

**需要檢查的表格：**
- `M0__CROSSCHECK_LOG`：確認所有搜尋步驟都有執行
- 各 Phase 快照表：確認數據正確保存和讀取
- `P5__DAILY_SNAPSHOT`：確認每日數據收集正常

---

### 4. 🎯 P5 能否整合多面向資料並做出完整策略

**檢查項目：**

#### **P5 Weekly 輸入整合**
檢查 `M0__RESULT.final_output`（P5_WEEKLY 的 job_id）：
- ✅ `p2_snapshot`：基本面分析結果是否正確讀取
- ✅ `p3_snapshot`：技術面分析結果是否正確讀取
- ✅ `p4_snapshot`：資金配置結果是否正確讀取
- ✅ `weekly_market_data`：週度市場數據
- ✅ `institutional_data`：機構級數據
- ✅ `earnings_calendar`：財報行事曆數據

#### **P5 Weekly 輸出完整性**
檢查 `M0__RESULT.final_output`：
- ✅ `worldview`：
  - 是否整合了所有輸入數據
  - 是否包含多面向分析（基本面、技術面、籌碼面、宏觀面）
  
- ✅ `stock_strategies` 陣列：
  - 每檔股票是否都有策略決策
  - 決策是否基於多面向數據（不只是單一面向）
  - 是否包含：
    - `action`：BUY / SELL / HOLD / INCREASE / DECREASE
    - `reasoning`：決策理由（應引用多個數據源）
    - `confidence`：信心度
    - `risk_assessment`：風險評估

- ✅ `factor_weights`：
  - 是否動態調整（特別是財報相關的 `earnings_smart_money_weight`）
  - 權重分配是否合理

- ✅ `portfolio_adjustments`：
  - 是否基於 P4 配置結果進行調整
  - 調整理由是否充分

**評估標準：**
- ✅ 所有輸入數據都被使用（不是只用了部分數據）
- ✅ 決策邏輯清晰，引用多個數據源
- ✅ 策略完整（包含行動、理由、風險評估）
- ⚠️ 如果決策只基於單一面向，需要檢查 Prompt 或邏輯

---

### 5. 🔍 全部 Phase 的雙模型交叉分析+審查系統是否正常運作

**這是核心架構檢查項目，需要確認雙模型系統正常運作：**

#### **雙模型系統架構**
- **EXECUTOR（執行者）**：執行主要分析任務
- **AUDITOR（審查者）**：審查執行者的結果，提供審查意見

#### **需要檢查的表格欄位**

##### **M0__CROSSCHECK_LOG 表格（審計鏈）**
檢查每個 Phase 的 job_id 對應的記錄：

1. **EXECUTOR 步驟記錄**：
   - `step` 欄位：應為 `"EXECUTOR"`
   - `model_id` 欄位：應為該 Phase 對應的執行者模型（例如：P0 使用 OPUS，P1 使用 SONNET）
   - `input_snapshot` 欄位：應包含完整的 Prompt 和輸入數據
   - `output_snapshot` 欄位：執行者的完整輸出（JSON 字串）
   - `created_at` 欄位：執行時間

2. **AUDITOR 步驟記錄**：
   - `step` 欄位：應為 `"AUDITOR"`
   - `model_id` 欄位：應為該 Phase 對應的審查者模型（通常是 GPT-5.2）
   - `input_snapshot` 欄位：應包含執行者的輸出作為輸入
   - `output_snapshot` 欄位：審查者的審查結果（應包含審查意見、修正建議等）
   - `created_at` 欄位：執行時間（應在 EXECUTOR 之後）

##### **M0__RESULT 表格（最終結果）**
檢查 `final_output` 是否正確整合了雙模型的結果：
- 應包含執行者的分析結果
- 應包含審查者的審查意見（通常在 `auditor_review`、`audit_review` 或類似欄位）
- 應包含最終的置信度（`confidence_level`）

#### **各 Phase 的雙模型檢查重點**

##### **P0（產業工程學分析）**
- ✅ EXECUTOR：應使用 **OPUS** 模型
- ✅ AUDITOR：應使用 **GPT-5.2** 模型
- ✅ 檢查 `final_output` 中是否有 `auditor_review` 欄位
- ✅ 檢查 `confidence_level` 是否由審查者提供

##### **P0.7（系統動力學分析）**
- ✅ EXECUTOR：應使用 **O3** 模型
- ✅ AUDITOR：應使用 **GPT-5.2** 或 **OPUS** 模型
- ✅ 檢查審查者是否審查了系統動力學分析的邏輯一致性

##### **P1（公司池生成）**
- ✅ EXECUTOR：應使用 **SONNET** 模型
- ✅ AUDITOR：應使用 **GPT-5.2** 模型
- ✅ 檢查審查者是否驗證了公司適配檢查的合理性

##### **P2（基本面分析）**
- ✅ EXECUTOR：應使用 **SONNET** 模型
- ✅ AUDITOR：應使用 **GPT-5.2** 模型
- ✅ 檢查審查者是否驗證了財務分析的準確性

##### **P3（技術面分析）**
- ✅ EXECUTOR：應使用 **SONNET** 模型
- ✅ AUDITOR：應使用 **GPT-5.2** 模型
- ✅ 檢查審查者是否驗證了技術分析的邏輯

##### **P5 Weekly（週度策略）**
- ✅ EXECUTOR：應使用 **SONNET** 模型
- ✅ AUDITOR：應使用 **GPT-5.2** 模型
- ✅ 檢查審查者是否審查了策略決策的合理性
- ✅ 檢查審查者是否驗證了多面向數據的整合

#### **檢查項目清單**

**對於每個 Phase，確認：**

1. ✅ **步驟完整性**：
   - `M0__CROSSCHECK_LOG` 中該 job_id 應有 **2 條記錄**（EXECUTOR + AUDITOR）
   - 兩條記錄的 `created_at` 時間順序正確（EXECUTOR 在前，AUDITOR 在後）

2. ✅ **模型正確性**：
   - EXECUTOR 使用的模型符合 `TASK_TO_EXECUTOR` 配置
   - AUDITOR 使用的模型符合審查者配置（通常是 GPT-5.2）

3. ✅ **數據流轉**：
   - AUDITOR 的 `input_snapshot` 應包含 EXECUTOR 的 `output_snapshot`
   - 確認審查者確實審查了執行者的輸出

4. ✅ **結果整合**：
   - `M0__RESULT.final_output` 應包含執行者的分析結果
   - `M0__RESULT.final_output` 應包含審查者的審查意見
   - 最終結果應反映審查者的修正或確認

5. ✅ **審查品質**：
   - 審查者的輸出不應只是簡單的「通過」，應有具體的審查意見
   - 如果執行者有問題，審查者應指出問題並提供修正建議

#### **異常情況檢查**

- ❌ **只有 EXECUTOR，沒有 AUDITOR**：雙模型系統未正常運作
- ❌ **AUDITOR 的 input_snapshot 不包含 EXECUTOR 的輸出**：數據流轉有問題
- ❌ **final_output 中沒有審查意見**：結果整合有問題
- ❌ **審查者輸出為空或格式錯誤**：審查步驟執行失敗

#### **需要檢查的 SQL/查詢邏輯**

對於每個 Phase 的 job_id，在 `M0__CROSSCHECK_LOG` 中：
```sql
SELECT * FROM M0__CROSSCHECK_LOG 
WHERE job_id = '[job_id]' 
ORDER BY created_at
```

應返回 2 條記錄：
1. 第一條：`step = "EXECUTOR"`
2. 第二條：`step = "AUDITOR"`

---

## 📋 測試報告格式

執行測試後，請提供以下資訊：

### Phase: [Phase 名稱]
### Status: [COMPLETED / SUBMITTED / ERROR]
### Duration: [執行時間]

### AI Output Fields:
[列出所有 AI 回應的欄位，格式：]
```
欄位名稱: 值（或類型）
- themes[0].theme_name: "xxx"
- themes[0].problem_oneliner: "xxx"
- themes[0].failure_mode: {...}
...
```

### Prompt Evaluation:
```json
{
  "completeness": {
    "has_eng": true/false,  // P0: 是否有工程瓶頸類
    "has_struct": true/false,  // P0: 是否有定價權獨佔類
    "theme_count": 2,  // 實際數量
    "required_fields_present": true/false  // 所有必需欄位是否存在
  },
  "quality": {
    "json_valid": true/false,  // JSON 格式是否有效
    "logic_consistent": true/false,  // 邏輯是否一致
    "content_quality": "GOOD/FAIR/POOR"  // 內容品質評估
  },
  "issues": [
    {
      "severity": "HIGH/MEDIUM/LOW",
      "field": "欄位名稱",
      "issue": "問題描述",
      "suggestion": "建議修改"
    }
  ]
}
```

### Data Pipeline Status:
- ✅/❌ CSE Search: [執行狀態]
- ✅/❌ Gemini Search: [執行狀態]
- ✅/❌ OHLCV Data: [數據量]
- ✅/❌ News Data: [數據量]

### P5 Integration Check:
- ✅/❌ All inputs integrated: [是否整合所有輸入]
- ✅/❌ Multi-faceted analysis: [是否多面向分析]
- ✅/❌ Complete strategies: [策略是否完整]

### Dual-Model System Check:
- ✅/❌ EXECUTOR step executed: [執行者步驟是否執行]
- ✅/❌ AUDITOR step executed: [審查者步驟是否執行]
- ✅/❌ Models correct: [使用的模型是否正確]
- ✅/❌ Data flow correct: [數據流轉是否正確（AUDITOR 是否收到 EXECUTOR 的輸出）]
- ✅/❌ Results integrated: [最終結果是否整合了雙模型的輸出]
- ✅/❌ Audit quality: [審查品質（是否有具體審查意見）]

**詳細檢查：**
```
EXECUTOR:
  - Model: [模型名稱]
  - Output fields: [列出主要輸出欄位]
  
AUDITOR:
  - Model: [模型名稱]
  - Review content: [審查意見摘要]
  - Confidence level: [置信度]
```

---

## 🔍 重點提醒

1. **AI 回應評估是最重要的**：這直接影響 Prompt 的修改方向
2. **必須檢查 `M0__CROSSCHECK_LOG.output_snapshot`**：這是 AI 的完整原始回應
3. **必須檢查 `M0__RESULT.final_output`**：這是處理後的結果
4. **對比 Prompt 要求與實際輸出**：找出差距，作為修改 Prompt 的依據
5. **數據管線檢查**：確認數據正確流轉，沒有遺漏或錯誤
6. **雙模型系統檢查**：確認 EXECUTOR 和 AUDITOR 都正常運作，審查機制有效
