# Nuclear Project SSOT V8.52 架構定案文檔

## 📋 版本說明

- **版本**: V8.52（2026-02-05 Shared Progress Protocol 版）
- **定案日期**: 2026-01-15
- **封存日期**: 2026-01-17
- **系統設計完成日期**: 2026-01-19
- **最後更新**: 2026-02-04（⭐ **V8.45 動態學習層架構重大升級**：【核心理念】Learn "where we die" before learning "how to win"；【三類輸出】Hard Caps/Soft Bias/Banned Patterns（禁止其他）；【Context Layer】context_signature 必備、無簽名不可學習；【四個子系統】Trace Pack（無封包不出 output）、Factor Signature Engine（因子組合簽名）、Outcome Attribution（7 類錯誤分類含 EXECUTION_SLIPPAGE）、Policy Compiler（TTL/Decay 必備）；【四個成熟階段】冷啟動→觀察→軟影響→強制約束，門檻上修適應世界觀依賴型多因子系統；【Counterfactual-lite】學習安全閥、單點異常不改 policy；【Policy 層級】System > Sector > Symbol，更嚴格者優先；【工程鐵律】Learning constraints override strategy preferences、8 條檢查清單；融合 V7 原設計（Claims 結構化、Evidence Pointers、UNCERTAIN_CAUSE、回寫頻率限制 ±0.05/週）與新設計（情境索引、因子簽名、4 階段成熟）；保留現有三層記憶模型）（⭐ **V8.44 SSOT 完整清理與補強**：【新增】史官鐵律專節、Daily 最高目標專節、歷史與現狀銜接原則專節；【新增】P5 Daily 新架構（D-1~D-4）完整定義章節—含 AI 模型配置表、D-1A/D-1B 全程分離原則、多維度標籤系統完整定義、REVERSAL_NOISE 檢測）（⭐ **V8.43**：D-1B 論壇白名單 V1 與搜尋策略；D-1A 與 D-1B 全程分離原則）（⭐ **V8.42**：檢查報告採納補強）（⭐ **V8.41**：平台說明 GAS 已中止、全面搬遷 Python）（⭐ **V8.40 P2.5 與 Daily/Weekly 定案**）（⭐ V8.39-V8.35）✅ **系統設計階段完成，進入測試流程**
- **⭐ V8.52 Shared Progress Protocol (2026-02-05)**：實現 CLI ↔ Agent 共享進度機制。**Run Log**（`logs/run_log.jsonl`）：CLI 執行後自動 append 結構化日誌，供 Agent 讀取。**Milestone**（`docs/milestone.yaml`）：雙方共用的里程碑檢查點與銜接任務（pending_handoff）。**分工原則**：CLI 更新 run_log + milestone；Agent 更新 milestone + SSOT（架構變更時）。**Agent Skill**：`.gemini/skills/read_progress/` 提供讀取 CLI 進度的標準流程。詳見「Shared Progress Protocol」專節。
- **⭐ V8.51 Skills 模組化 (2026-02-05)**：將 SSOT 重複規則抽離為版本化 Skill 模組。**目錄結構** `src/nuclear/skills/`：`constitution/` 憲法類（ssot_core、dsfp、role_calibrator）、`rubrics/` 方法論類（narrative_link、derivative_reading、tech_structure、risk_overlay、evidence_protocol）、`schemas/` 輸出格式（d3、d4、wb1、wb2、p3）。**Skill Loader** 支援版本化載入（`load_skill()`）、Phase→Skills 映射（`load_skills_for_phase()`）、Schema 取得（`get_schema()`）。**核心收益**：輸出穩定（Validator 可程式化）、規則一致（修一次全生效）、版本控制（可回滾）。詳見「Skills 模組系統」專節。
- **⭐ M00 Build (2026-02-04)**：建立 Windows 一鍵自動化工作流 (`dev.ps1`)，整合 setup/wb/test/clean 指令，確保無 API Key 環境下可通過核心測試。新增檔案：`dev.ps1`, `.env.example`, `tests/test_m00_flow.py`。
- **⭐ V8.30 定案**：Weekly 新設計 **WB-1 / WB-2 / W-A**（目標架構，與現行 P5-B/P5-A 並存至實現完成）；執行順序 WB-1 宏觀 → 若劇變則 W-A 審查/重建 → WB-1 個股 → 若 escalation 則 W-A 審查 + P1–P4 → WB-2；模型 WB-1 Hermes 4 405B 無審查、WB-2 Hermes 4 405B + o3 batch 審查、W-A o3 不 batch 僅觸發時；個股 escalation 重跑範圍 P1–P4（不含 P0）；見模型配置表與 Weekly_final 流程與產出專節。**WB-1 須依 DSFP（V8.32）五模組對關鍵資產做身份裁決**，產出 world_state_snapshot、asset_identity_map、narrative_map、identity_shift_signals_summary、framework_stability_score、rebuild_recommendation、rebuild_reason_top5；**WB-2 每個 order 須引用 worldview_version 與 identity_context**（例如：Gold currently behaves as risk-on momentum asset），嚴禁自行改寫世界框架。
- **⭐ V8.32 定案**：**動態現況優先原則（DSFP）** 與 **DSFP 五模組與全 Phase 植入規範**；任何金融商品判斷不得依賴歷史標籤、必須依賴當前狀態；Daily 只標記、Weekly 身份裁決；≥3 項顯著變化 → IDENTITY_DRIFT = TRUE；WB-1 為 DSFP 身份裁決執行層；各 Phase 加強塊、GLOBAL_SYSTEM_BLOCK_DSFP_V1、P2.5/P4 行為、輸出欄位與下游；見「動態現況優先原則」與「DSFP 五模組與全 Phase 植入規範」專節。
- **⭐ V8.33 定案**：**目標架構與 GAS 過渡說明**；本 SSOT 描述者為目標架構設計，曾因 GAS 限制而妥協的項目（執行層、資料存儲、數據源、觀測）已改寫為目標版；實作時不得複製 GAS 妥協設計；詳細工程方法見《GAS 妥協清算與 Python 重建工程備忘錄》。架構總覽新增：執行層與任務調度（目標架構）、資料存儲（目標架構）；數據源目標為 OHLCV/宏觀主來源可靠 API、GOOGLEFINANCE 僅 P6 或備援。
- **⭐ V8.16 更新**：AI 工作流程優化（移除裁決者、審查者看到原始資料、觸發式審查、Delta Pack 設計、P5-B Validator）✅ **已完成**
- **⭐ V8.17 更新**：Batch API 整合（統一 Batch 抽象層、Provider Adapter、適用 Phase 預設 Batch、50% 成本折扣、全局開關、P1_STEP2 排除）✅ **已完成**
- **⭐ V8.17 補丁**：P1 Prompt 補丁（結構分級原則，不錯殺）、P2 Prompt 補丁（Runway = 風險，不是死刑）、P4 風控補丁（讓數學負責殘酷，AI 保持創造力）、P4 風險檢查（除以零風險、變數名稱對接、Infinity/NaN 檢查）✅ **已完成**
- **⭐ V8.17 地雷修復**：AI 記憶體無限膨脹（三層記憶模型）、人類訊號被 AI 覆蓋（Human Lock 機制）✅ **已完成**。**執行層**：GAS 時代曾以「6 分鐘斷頭台→可重入設計」「殭屍 Trigger 堆疊→命名空間清掃」為過渡；**目標架構**為任務隊列 + Worker + 長任務原生支援 + 狀態機，見架構總覽「執行層與任務調度（目標架構）」與《GAS 妥協清算與 Python 重建工程備忘錄》，新平台實作時不得複製可重入/Trigger 串接為核心。
- **⭐ V8.17 三大行事曆數據流完整性**：重大財經事件、板塊龍頭財報、持股財報的 input/output 數據流完整確認，包含五年歷史市場反應、建議加強監控數據、Weekly 掃描觸發監控、Daily 關鍵數據監控、Weekly 決策要點整合 ✅ **已完成**
- **⭐ V8.17 持股財報完整分析系統**：P4 完成後自動生成（一次完成：五年歷史經驗 + 預估今年財報日期），使用 Hermes 4（正式模式）或 Gemini Flash 3.0（測試模式），Daily 新聞更新使用 AI 分類（`Earnings_Date_Announcement`）✅ **已完成**
- **⭐ V8.17.1 三軸評級分數增強**：Safety_Score 硬風控 Caps（CFO < 0 → cap 59、Interest Coverage < 1.5 → cap 49、FRONTIER runway < 4 → cap 55）、共用函數抽取（computeSafetyScore、computeGrowthQualityScore、computeFuturePotentialScore）、Growth_Quality_Score Validator（範圍檢查 0-100、缺資料動態權重重分配、至少 2 個分項可用）、Future_Potential_Score Evidence Validation（檢查 evidence 來源 P0/P0.5/P0.7/P1、Executability Coverage 檢查、Frontier 安全鎖 Runway < 4 cap 70）、Evidence 微調（safety_adjustment_delta -15 ~ +15）✅ **已完成**
- **⭐ V8.17.3 P3 趨勢位階檢查增強**：新增多時間維度分析（週線優先、日線驗證）、主力誘多識別機制（週線派發結構末端 + 日線吸籌型態 = Bull Trap）、Cat 裁決基於趨勢位階檢查結果、保持靈活性但遵循核心原則 ✅ **已完成**
- **⭐ V8.17.3 P5 Weekly 掛單策略代碼增強**：輸出 IBKR-ready 的掛單策略代碼（Order DSL）、支援 STOP_LIMIT/LIMIT/BRACKET 三種掛單類型、OCO 互斥機制（Breakout 與 Pullback 必須互斥）、風險約束整合（P0.7、risk_overlay、p5_weekly_flags）、保持靈活性（AI 根據結構選擇訂單類型）✅ **已完成**
- **⭐ V8.17.5 P2.5 ICDZ 增強方案**：引入「機構成本防守區（ICDZ）」概念，實現跨模組協作（P2.5 提供信號、P3 估算區間、P5 Weekly 轉成定價錨點）、AI 區間判斷（避免假精準）、ICDZ 適用性檢查（根據 Cat 類型決定是否使用）、掛單價位設在機構成本區上緣 ✅ **已完成**
- **⭐ V8.18 系統增強**：9 個關鍵增強實現，將 V8.0 從「會算」升級到「會活下來、會賺到錢」的層級：
  - ✅ **1. P5 Weekly: 訂單保鮮期管理 (Order Freshness / GTD)**：根據 Setup 類型設定訂單有效期（Momentum/Breakout: DAY 或 GTD +1~2 days，Pullback: GTC 或本週五，Re-entry: DAY），避免「過期牛奶」問題 ✅ **已完成**
  - ✅ **2. P4 Calculator: Portfolio Correlation Lock**：實現板塊曝險上限檢查（30-40%），避免「假分散」風險，超標時優先選最強的，其餘縮倉或不買 ✅ **已完成**
  - ✅ **3. P3: 迴力鏢協議 (Boomerang / Re-entry)**：添加 re_entry_price 和資格檢查（Cat ≠ PARABOLIC/LATE DISTRIBUTION，時間 < 5 trading days，量能放大或收盤站回關鍵結構位），識別洗盤後的買回機會 ✅ **已完成**
  - ✅ **4. P5 Weekly: 財報前強制清倉 (Earnings Ejection)**：檢查未來 7 天財報，禁止開新倉，現有持倉必須減倉 50% 或設寬鬆停損 ✅ **已完成**
  - ✅ **5. P5 Weekly: 掛單滑價優化 (Adaptive Algo)**：添加 execution_preference 欄位（ADAPTIVE/SNAP_PRIMARY/LIMIT_ONLY），作為執行提示 ✅ **已完成**
  - ✅ **6. P0.5: 瓶頸轉移 (Bottleneck Migration)**：添加觀測任務，識別瓶頸轉移信號（current_bottleneck、easing_signals、next_bottleneck_candidates），捕捉「瓶頸轉移」機會 ✅ **已完成**
  - ✅ **7. P2: 營運槓桿拐點 (Operating Leverage Inflection)**：添加 OPERATING_LEVERAGE_INFLECTION 標記（營收持續成長 + R&D/SG&A/Opex Ratio 趨於持平或下降），提前一季埋伏倍數股 ✅ **已完成**
  - ✅ **8. P3: 相對強度抗跌測試**：計算 RS = Stock % Change - Index % Change，評估抗跌性（market_context、stock_behavior、interpretation、confidence），低風險進場核心 ✅ **已完成**
  - ✅ **9. P5 Weekly: 拋物線清倉 (Selling into Strength)**：添加 EXIT_SCENARIO: PARABOLIC_EXHAUSTION（Cat = Momentum/Late-stage，Price vs MA20 deviation > 95th percentile，Volume spike），Sell 30-50% into strength，剩餘部位交給 trailing stop ✅ **已完成**
  - **詳細設計**：請參考 `V8.18_系統增強實現計劃_2026-01-23.md` 和 `V8.18_訂單保鮮期管理實現報告_2026-01-23.md`
- **⭐ V8.19 實戰模擬五項增強**（機構級生存系統升級）✅ **已定案並實現**
  - **定位**：將 V8.x 從「會算」升級為「活下來 + 把錢留住」的機構級生存系統；五項缺一不可。
  - **✅ 1. Bull Trap 防禦（P3 生死線）**：
    - **問題**：Prompt 要求看週線，但只傳日線 → AI 腦補週線，防騙能力為零。
    - **實作**：① `22_P3_DATA_COLLECTOR.js` 已具 `aggregateDailyToWeekly()`，產出真實週線（約 50 週）；② **強制在 Prompt 中分區**：`[WEEKLY_CHART]`（last 50 週 K 棒 + 趨勢結構）+ `[DAILY_CHART]`（last 60 日，僅用於觸發/進場時機）；③ **SSOT 硬規則**：若 `WEEKLY_STRUCTURE = DISTRIBUTION` 或 `LATE_STAGE` → 日線突破**不得**產出 `MOMENTUM_BUY`，至多 `FAKE_BREAKOUT` / `TRAP_ALERT`。
    - **實現位置**：`22_P3_DATA_COLLECTOR.js`、`22_P3_AI_ANALYSIS.js`（buildP3Prompt 分區 + 規則）
  - **✅ 2. Sector Collapse 防禦（P4 保命鎖）**：
    - **問題**：P4 僅算個股，無板塊/相關性視野 → 假分散（例：60% 半導體）。
    - **實作**：① `applyPortfolioCorrelationLock()` 已實現板塊曝險上限（30–40%）、超標時等比例縮減；② 縮減優先序：Tier 高 > RS 高 > 波動低 > 既有倉位優先；③ 可選升級：`sector_exposure > 40%` **或** `avg_corr(sector) > 0.75` → 觸發鎖定。
    - **實現位置**：`10_P4_CALCULATOR.js`
  - **✅ 3. Choppy Market 學習斷鏈修復（勝率保護）**：
    - **問題**：Learning 只寫筆記，不改行為；P5 未載入 Learning State / Recent Failures。
    - **實作**：① P5 Weekly 開頭強制 `getLatestLearningState()`（彙總 `learning_log_history`、`failure_cases`、策略比對 misaligned）；② 將「當前不適合的策略」與 `failed_patterns` 注入 Prompt 的 `[MISSION_CONSTRAINTS]`；③ **SSOT 原則**：「Learning constraints override strategy preferences.」
    - **實現位置**：`24_P5_WEEKLY_DATA.js`（getLatestLearningState）、`24_P5_WEEKLY_CORE.js`（載入並傳遞）、`24_P5_WEEKLY_DUAL_LAYER.js`（Prompt 新增 MISSION_CONSTRAINTS 區塊）
  - **✅ 4. Parabolic Exit（主動止盈 / 利潤守門員）**：
    - **問題**：缺乏「賣給瘋子」的主動止盈；抱上山又抱下山，利潤回吐。
    - **實作**：**程式規則**（非 AI 判斷）：`IF price > MA20 * 1.3 AND volume > avg_volume * 2 THEN` 觸發 `PARABOLIC_EXHAUSTION` → 立即賣出 30–50%，其餘交 trailing stop。置於 P5 Weekly 的 Exit Rules 層，在產出 `order_plan` / `weekly_trade_actions` 前檢查。
    - **實現位置**：`24_P5_WEEKLY_FINAL_OUTPUT.js` 或專用 `checkParabolicExhaustion()` + 整合至最終產出流程
  - **✅ 5. Cash is a Position（空手藝術 / 熊市防呆）**：
    - **問題**：系統隱性假設「總有東西可買」；熊市時不減曝險。
    - **實作**：**市場氣候濾網**：`IF P0.7 = LATE_CYCLE AND P5 世界觀 = BEARISH THEN FORCE_MAX_EXPOSURE = 30%`。覆寫層級：**Market Climate Override > P4 Allocation > P5 Strategy > Individual Buy**。強制覆寫 P4 的 U（利用率），使系統在熊市主動拒絕大部分買入、持有現金。
    - **實現位置**：`10_P4_CALCULATOR.js`（`getCurrentUV8_15` 整合 Market Climate Override）；P5 Weekly 將最新 world view 寫入可讀取處（如 PropertiesService 或 P5 快照），供 P4 使用。
  - **✅ 6. P5 Weekly 三層決策架構（硬約束 + 軟引導 + 自由空間）**（⭐ 2026-01-25 新增；⭐ 2026-01-26 完善）：
    - **問題**：權重決定機制不清晰、因子整合邏輯缺失、衝突解決機制缺失（C1）。
    - **實作**：① **Layer 1 硬約束**：系統級（LATE+HIGH 禁 Cat3、defcon1、emergencyExit）、產業級（divergenceAlert、industryPhaseOut）、個股級（insiderSelling、safetyLock）、數學邊界（權重總和、position_cap、buy_ladder）；② **Layer 2 軟引導**：基準權重、情境建議（財報前、突破型態、高波動、Milestone 驗證）、優先級規則；③ **Layer 3 自由空間**：AI 在 Layer 1/2 框架內自主推理。④ `enforceHardConstraints` / `applyHardConstraints` 在個股策略產出後程式強制覆寫。
    - **實現位置**：`24_P5_WEEKLY_DECISION_FRAMEWORK.js`；已整合至 P5 Weekly 個股策略流程（`24_P5_WEEKLY_CORE.js`）。
    - **詳細**：`V8.19_三層決策架構實施總結_2026-01-25.md`
    - **⭐ V8.26 C1 修復：權重決定機制完善** ✅ **已完成**：
      - **問題**：硬約束檢查已調用，但 Prompt 中缺少基準權重指引，AI 不知道「合理的權重配置」是什麼樣子。
      - **修復**：① 在 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 中添加基準權重指引（fundamental 30%、chips 25%、tech 25%、macro 10%、sentiment 10%）；② 明確允許偏差範圍（±15%），超過 ±20% 需說明理由；③ 提供調整原則（系統級風險優先、籌碼面與基本面衝突時優先相信籌碼等）。
      - **實現位置**：`src/24_P5_WEEKLY_DUAL_LAYER.js` 中的 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 函數。
      - **狀態**：✅ **已完成**
  - **✅ 7. C2 學習系統斷鏈修復（LEARNING_STATE 注入、SCENARIO_MEMORY、Safety Lock）**（⭐ 2026-01-25 新增；⭐ 2026-01-26 完善）：
    - **問題**：Learning 只寫筆記，不改行為；P5 未載入 Learning State / Recent Failures；缺乏情境記憶和 Safety Lock 機制。
    - **實作**：① **LEARNING_STATE 參數注入**：`getLatestLearningState()` 返回 `learning_params`（`breathing_weights`、`entry_confirmation_atr_multiple`、`lock_profit_atr_multiple` 等），在 `context.learning_params` 中提供給 P5 Weekly；② **SCENARIO_MEMORY / Safety Lock**：創建 `24_P5_WEEKLY_SCENARIO_MEMORY.js`，實現 `extractScenarioSignature`、`getHistoricalScenarios`、`checkSafetyLock`，在 P5 Weekly Core 中整合 Safety Lock 檢查，若死亡率 > 0.5 則觸發 Safety Lock（`max_exposure` 上限）；③ **參數調整建議**：待實現（`compareStrategyWithReality` 的 Scorecard 可產出「參數調整建議」結構）。
    - **實現位置**：`24_P5_WEEKLY_DATA.js`（`getLatestLearningState`）、`24_P5_WEEKLY_SCENARIO_MEMORY.js`（Safety Lock）、`24_P5_WEEKLY_CORE.js`（整合）。
    - **⭐ V8.26 C2 修復：學習反饋 Prompt 整合** ✅ **已修復**：
      - **問題**：`getLearningFeedback()` 有寫入但沒有在 P5-B Prompt 中使用，導致系統會不斷重複犯同樣的錯誤。
      - **修復**：在 `buildP5_BPrompt()` 和 `buildP5_BUserPayloadForBatch()` 中添加 `learning_feedback` 指令區塊，明確要求 AI 參考 `Parameter_Bias_Adjustment`、`Safety_Lock_Recommendations`、`Recent_Reflections`、`Similar_Failure_Cases`。
      - **實現位置**：`src/24_P5_WEEKLY_DUAL_LAYER.js` 中的 `buildP5_BPrompt()` 和 `buildP5_BUserPayloadForBatch()` 函數。
  - **✅ 8. M1 P3 週線技術指標計算**（⭐ 2026-01-25 新增；2026-01-25 完善）：
    - **問題**：P3 Prompt 要求看週線，但只傳日線 → AI 腦補週線，防騙能力為零。
    - **實作**：① 在 `22_P3_DATA_COLLECTOR.js` 中新增 `calculateWeeklyIndicators` 函數，計算週線 MA20/50/200、RSI（14 週）、MACD（12, 26, 9）；② **已整合到 P3 Prompt**：在 `collectTechnicalDataFromExternalSources` 中計算週線指標並添加到 `technicalData[ticker].weekly_indicators`；③ 在 `formatTechnicalDataWithWeeklyDailyBlocks` 中將週線指標顯示在 `[WEEKLY_CHART]` 區塊內，確保 AI 能直接使用週線技術指標進行分析。
    - **實現位置**：`22_P3_DATA_COLLECTOR.js`、`22_P3_AI_ANALYSIS.js`（formatTechnicalDataWithWeeklyDailyBlocks）。
  - **✅ 9. M2 Delta Pack 關鍵訊號始終包含**（⭐ 2026-01-25 新增）：
    - **問題**：Delta Pack 只包含變動，關鍵訊號未變動時遺漏，AI 誤判為「無資訊」。
    - **實作**：定義 `CRITICAL_SIGNALS` 列表，在 `buildMarketLevelDelta` 和 `buildStockLevelDelta` 中始終包含關鍵訊號（`vix`、`market_regime`、`defcon_level`、`p0_7_time_position`、`p0_7_turning_point_risk`、`p2_5_insider_selling_alert`、`p2_5_abnormal_13f_distribution`），並標註 `changed` / `UNCHANGED` 狀態。
    - **實現位置**：`24_P5_WEEKLY_DELTA_PACK.js`。
  - **✅ 10. M3 P2 Milestone 驗證時間窗口與部分達成**（⭐ 2026-01-25 新增）：
    - **問題**：Milestone 驗證缺乏時間窗口邏輯，無法處理部分達成情況。
    - **實作**：① **驗證時間窗口**：在 `24_P5_WEEKLY_MILESTONE_VERIFICATION.js` 中新增 `generateMilestoneVerificationWindow` 函數，依里程碑類型推算 `earliest_check`、`optimal_check`、`latest_check`；② **部分達成**：定義 `partial_completion_threshold = 0.70`，實現 `checkMilestoneAchievementWithPartial` 函數，支持 `PARTIALLY_VERIFIED` 狀態。
    - **實現位置**：`24_P5_WEEKLY_MILESTONE_VERIFICATION.js`。
  - **✅ 11. N1 P1 財報提取完整性檢查（C5）**（⭐ 2026-01-25 新增；⭐ 2026-01-26 確認）：
    - **問題**：Flash 提取後未驗證必含章節（P1/P2/P3），不完整時無標記。
    - **實作**：① 新增 `validateFinancialReportExtraction(extractedData)`，檢查 P1/P2/P3 為陣列、非全空；② 不完整時標記 `INCOMPLETE_EXTRACTION`、`incomplete_reasons`，並寫入 `Financial_Report_Extraction_Status`；③ 在 `saveFinancialReportExtraction` 內提取後先驗證再寫入。
    - **實現位置**：`20_P1_FINANCIAL_REPORTS.js`。
    - **⭐ V8.26 確認**：已在 `saveFinancialReportExtraction` 中調用 `validateFinancialReportExtraction`，功能完整。
  - **✅ 12. N2 P2.5 機構評級時間維度簡化**（⭐ 2026-01-25 新增；2026-01-25 調整）：
    - **問題**：機構評級可信度為短期 5d、中期 15d、長期 30d，時間維度過於複雜。
    - **實作**：簡化為 **短期 7d、中期 15d**（移除長期維度，30天太長）。① `24_P5_INSTITUTIONAL_RATINGS_UPDATE_CREDIBILITY.js`：觸發更新改為 7d / 15d；② `24_P5_WEEKLY_SENTIMENT.js`：`getPriceReactionMultiTimeframe` 改為 short 7d、mid 7–15d；③ `24_P5_INSTITUTIONAL_RATINGS_LEARNING.js`：短期 7d、中期 15d，最終可信度 = `calculateFinalCredibilityScore(short, mid, null)`。
    - **實現位置**：`24_P5_INSTITUTIONAL_RATINGS_UPDATE_CREDIBILITY.js`、`24_P5_WEEKLY_SENTIMENT.js`、`24_P5_INSTITUTIONAL_RATINGS_LEARNING.js`。
  - **✅ 13. N3 P6「殘影機制」更名為「20 分鐘動能追蹤」**（⭐ 2026-01-25 新增）：
    - **問題**：「殘影」命名易誤解，需統一語意。
    - **實作**：文檔與日誌用詞統一為 **20 分鐘動能追蹤**。① `28_P6_SHADOW_MECHANISM.js`：模組說明、註解、Logger 訊息；② `28_P6_LOGGER.js`、`28_P6_INTRADAY_MONITOR.js`、`26_TRIGGER_SETUP.js`：相關註解與日誌；③ `01_SHEETS_STRUCTURE.js`：`price_20min_ago` 欄位註解。表格名 `P6_SHADOW_PRICES` 保留以兼容既有 schema。
    - **實現位置**：`28_P6_SHADOW_MECHANISM.js`、`28_P6_LOGGER.js`、`28_P6_INTRADAY_MONITOR.js`、`26_TRIGGER_SETUP.js`、`01_SHEETS_STRUCTURE.js`。
- **V8.9 更新**：機構評級獨立資料庫 + 新聞品質優化 + 歷史動態學習系統整合
- **V8.10 更新**：泡沫監控戰略升級：從「左側減倉」轉向「右側動態鎖利」
- **V8.12 更新**：新聞系統戰略升級 - 多維度標籤系統、個股新聞索引、數據驗證機制、Daily DB擴充 + Weekly系統優化（避免重複工作100次）
- **⭐ V8.13 更新**：動態學習系統完整補強 - V7設計完整統整（Closed-loop Brain）、策略比對機制（四項Scorecard）、數據-策略-結果追蹤鏈（STRATEGY_SNAPSHOT/OUTCOME_SNAPSHOT）、錯誤歸因引擎、參數校準（LEARNING_STATE）、情境記憶（SCENARIO_MEMORY/Safety Lock）、工程限制清單
- **⭐ V8.14 更新**：P0/P0.5/P1 戰略升級 - P0 時效性防呆機制（Gemini File API 驗證）、P0.5 產業鏈地圖 Prompt 設計、P1 兩階段執行（Flash 股票池生成 + Pro 結構分級）、Tier S/A/B/X 分級系統取代三池、財報驗證機制（SEC/MOPS/EDINET）、Flash 三欄位提取（P1/P2/P3 分離）
- **⭐ V8.15 更新**：P2 成長性分析完整架構（三軸評級系統、雙軌制、交互矩陣、驗證里程碑、Runway 硬門檴）、P0.5 產業鏈動態監控完整架構（雙模式設計、三階段推理、8個核心信號、4區輸出格式、與P0.7雙向接口、台股月度監控每月12號）、P3-P6 整合更新（P3 風控覆蓋層、P4 資金配置規則、P5 Weekly 雙層架構與輸入接口強化、P6 緊急退出條件）、Weekly 輸入資料完整性檢查與補強清單、P5 Weekly 工程增強修改建議（Strategy Skeleton + AI Parameter Layer、雙層 AI 架構完整設計、Weekly Snapshot 資料補齊、動態學習系統角色明確化、Sector ETF Flow 與 Mag 7 分析、P2.5 異常硬觸發、最終產出對齊 IB 批次下單） ✅ **架構定案完成，核心功能已實現** ⭐ V8.17 完成
- **基礎版本**: V7.1
- **主要變更**: Phase 順序調整與職權分工優化，對齊執行頻率，補強項目實現（100% 完成度），V7.1 補充手冊整合，所有待完成項目實現完成，GOOGLEFINANCE 數據源整合，P6 盤中監測系統設計，P4.6/P5.4/P5.5/P5.6 功能完全統整到 P6，V8.9 機構評級獨立資料庫與新聞品質優化，V8.12 新聞系統戰略升級與Weekly系統優化，V8.13 動態學習系統補強（策略比對機制 + 數據-策略-結果追蹤鏈），V8.14 P0/P0.5/P1 戰略升級（時效性防呆、產業鏈地圖、兩階段執行、Tier 分級），V8.15 P2/P0.5 完整架構補強（三軸評級、雙模式監控、動態推理）
- **狀態**: ✅ **V8.0 系統設計完成，實作平台為 Python**；gas_archive 僅供對照（V8.9～V8.17 架構已完成，所有補丁已應用，所有工程地雷已修復）

---

## 🎯 V8.0 核心原則

**V8.0 是 V7.1 的修改版本，大致幾乎保留 V7.1 的內容，僅做一些 phase 的順序調整或拆開，使其任務歸屬更加符合邏輯順序與職權分工，也對齊執行頻率。**

**⚠️ 重要提醒**：V8.0 必須完整保留所有 V4.0-V6.0 已定案的設計，絕對不能遺漏。請參考 `SSOT版本對照檢查表_V8.0.md` 和 `SSOT更新防遺漏機制_V8.0.md` 進行檢查。

### ⭐⭐⭐⭐⭐ 最高等級設計原則

#### 核彈投資系統最高總則（憲法）⭐ V8.29 定案 + V8.31 補丁

以下六條為系統最高層原則，所有 Phase 設計與 Prompt 不得與之抵觸：

1. **未來可驗證** ⭐ **V8.31 升格為憲法第一條**：所有 Phase 產物必須以「**未來可驗證**」為終點（milestone / trigger / falsifiable conditions），不是以「分析完整」為終點。若無法轉成未來驗證點 → 視為低價值輸出。任何結論必須輸出：**未來 1～3 個關鍵驗證訊號 + 時間窗口**。（P2 Milestone to Verify、各 Phase 驗證時間窗口等已往此對齊；本條將其升格為全系統第一原則。）
2. **未來優先**：所有分析與輸出須服務「預測未來」，而非僅描述現狀或歷史。
3. **市場視角高於真相**：決策以市場參與者（尤其主力/機構）的視角與行為為依歸，而非以「客觀真相」為唯一標準。
4. **因果鏈完整性**：推論須保持因果鏈完整，不跳步、不隱藏假設；不確定時須標註。
5. **反敘事義務**：有義務檢視主流敘事與數據是否一致，發現敘事與現實錯位時須標記並納入決策。
6. **角色即主力**：技術與籌碼分析須以「機構/主力如何看、如何動」為核心，角色即主力視角。

**實施**：各 Phase Prompt 最前加入「角色校準器」、最後加入「未來對齊三問」；產出須含驗證訊號與時間窗口；詳見 `各階段Prompt補強參考_2026-01-26.md`。

#### 動態現況優先原則（DSFP）⭐ V8.32 定案

- **定義**：任何金融商品的判斷**不得依賴歷史標籤**，必須依賴**當前狀態**。資產 ≠ 名稱；資產 = 當前結構 × 資金狀態 × 規則環境。
- **核心公式**：`Asset Identity = Structure × Liquidity × Derivatives × Participants × Rules`（DSFP 五模組）。
- **鐵律**：任何投資決策前，先判斷它是「**哪一個版本的自己**」。結構變了，就不是原本那個資產。
- **角色分工**：**Daily（D-3/D-4）**：只記錄與連接，**不裁決身份**；只輸出 `IDENTITY_SHIFT_SIGNALS`（signal）、`EVENT_CLUSTER_UPDATE`、`WEEKLY_ESCALATION_HINT`；嚴禁世界觀重建與策略建議（與史官鐵律一致）。**宏觀類金融商品**（貴金屬、油價、匯率、美債等）的**當日現狀數據或快照**由 **Daily** 收集／更新；WB-1 做 DSFP 身份裁決時**引用** Daily 產出的該類數據。**Weekly**：**身份裁決層**；DSFP 為 Weekly「世界觀裁決層」的**核心判斷框架之一**（不是獨立 Phase）。⭐ V8.30 目標架構下 **WB-1 為 DSFP 身份裁決的執行層**：對**關鍵資產**做 DSFP-5 判斷，產出 `asset_identity_map`、`identity_shift_signals_summary`、`framework_stability_score`、`rebuild_recommendation`。**關鍵資產清單** ⭐ **V8.42**：提供 V1 預設清單與**數量上限**，工程可配置（不寫死）；必含項至少：美元、美債、VIX、油、金、銅、主要股指/板塊；具體清單與上限見工程備忘錄。
- **Weekly 裁決規則**：以下五模組中 **≥3 項**出現顯著變化 → `IDENTITY_DRIFT = TRUE`：① 價格區間極端 ② 成交量與 ETF 流異常 ③ 衍生品/槓桿密度上升 ④ 參與者結構失衡 ⑤ 規則或機制改變。
- **系統行為**：當 `IDENTITY_DRIFT = TRUE` 時：**P5 Weekly（或 WB-1/WB-2）** 必須下修信任權重、提升風險因子、強制輸出「身份轉變說明」；**P4** 自動降低利用率 U、增加現金權重（與現有 Market Climate Override、Portfolio Correlation Lock 並存，不覆蓋既有風控）。
- **與憲法並存**：DSFP「當前狀態優先」與憲法「未來可驗證」並存；RECHECK_TRIGGER 可對接驗證時間窗口與 Milestone。詳見下「DSFP 五模組與全 Phase 植入規範」。

#### 因子角色與時間維度總則 (Factor Role & Timeframe Doctrine) ⭐ V8.50 定案

**定位**：與憲法、DSFP 並列的第三大設計原則。

**一、市場三層結構總則**

市場行為來自三層同時作用：
| 層級 | 說明 |
|------|------|
| 結構層 (Structure) | 長期趨勢、產業地位、資產身份 |
| 參與者層 (Participants) | 籌碼分布、機構行為、資金流向 |
| 觸發層 (Triggers) | 新聞事件、財報公布、技術突破 |

**核心規則**：任何因子都必須被標記其：① 屬於哪一層 ② 在哪個時間尺度 ③ 扮演什麼角色。

**二、因子角色分類 (Role Taxonomy)**

| 角色 | 英文 | 定義 | 使用規範 |
|------|------|------|----------|
| 背景 | BACKGROUND | 結構背景，定義大框架 | ❌ 不可作為進出場理由 |
| 放大器 | AMPLIFIER | 放大既有方向，本身不決定方向 | ❌ 不可單獨作為方向判斷 |
| 觸發器 | TRIGGER | 造成短期價格行為改變的直接原因 | ✅ 可作為即時進出場依據 |

**三、時間維度分類 (Time Horizon)**

| 層級 | 英文 | 含義 |
|------|------|------|
| 結構層 | MONTHLY+ | 月以上，財報趨勢、產業地位 |
| 週層 | WEEKLY | 1–4 週，趨勢結構、籌碼 |
| 日層 | DAILY | 1–3 天，技術結構、突破 |
| 盤中 | INTRADAY | 分鐘～小時，即時監控 |

**四、時間衝突解決原則**

**鐵律**：高時間尺度觀點 > 低時間尺度觀點（MONTHLY > WEEKLY > DAILY > INTRADAY）。若 WEEKLY 為空頭，DAILY 多頭訊號只能當反彈，不可當趨勢反轉。

**五、框架 / 規則 / 任務分離**

| 類別 | 存放位置 | 精神 |
|------|----------|------|
| Framework | System Prompt | 給 AI 眼睛（世界觀） |
| Rules | 程式 Validator | 給系統剎車（安全網） |
| Task | Task Prompt | 給 AI 方向（目標） |

**六、動態角色升級規則**

因子角色由 **時間尺度 × 當前市場結構 × 資金行為** 動態決定。符合以下條件時允許升級（BACKGROUND → AMPLIFIER → TRIGGER）：Z-score > 2、百分位 > 95%、多市場同步異常、伴隨價格結構破壞。

**七、Phase × Factor Role 消費矩陣**

| Phase | 時間尺度 | 主要消費角色 | 禁止 |
|-------|----------|--------------|------|
| P0/P0.5/P1 | MONTHLY+/WEEKLY+ | BACKGROUND | TRIGGER |
| P2/P2.5 | WEEKLY | BACKGROUND, AMPLIFIER | - |
| P3 | DAILY/WEEKLY | TRIGGER, AMPLIFIER | - |
| P6 | INTRADAY | TRIGGER | BACKGROUND |
| D-1~D-4 | DAILY | TRIGGER, AMPLIFIER | BACKGROUND 重構 |
| WB-1/WB-2 | WEEKLY | BACKGROUND, AMPLIFIER | 單日 TRIGGER 推翻框架 |

**八、給 AI 的總指令**

> 請先判斷每個因子在當前時間尺度下的角色（BACKGROUND / AMPLIFIER / TRIGGER），再進行任何敘事或策略推導。

**九、與 DSFP 關係**

DSFP 判斷資產「是誰」（IDENTITY_DRIFT）；因子角色總則決定因子「怎麼用」。兩者協作：① DSFP 判斷身份漂移 → ② 因子角色總則決定各因子使用方式 → ③ 時間層級原則解決衝突。

#### 史官鐵律 ⭐ V8.31 定案

**定位**：史官鐵律是 D-3（個股統整師）與 D-4（宏觀世界觀統整師）的**最高行為規範**。

**核心原則**：
1. **不得改寫歷史**：D-3/D-4 不得修改已記錄的歷史事件內容
2. **僅能追加**：只能追加 delta（變化）、link（連結）、tag（標籤）、branch（分支）
3. **必須保留舊 evidence**：舊數據必須保留，新數據以追加方式記錄
4. **記錄須如同同一觀察者連續撰寫**：產出當日快照前須先讀取前三天歷史快照，保持敘事連貫性

**禁止事項**：
- ❌ 覆寫歷史數據
- ❌ 刪除過去的標記或結論
- ❌ 改變歷史事件的分類或評價
- ❌ 重新詮釋已記錄的歷史事件

**允許事項**：
- ✅ 追加新的觀察（delta）
- ✅ 新增連結到歷史事件（link）
- ✅ 新增標籤（tag）
- ✅ 在既有敘事上新增分支觀點（branch）

#### Daily 最高目標 ⭐ V8.40 定案

**核心目標**：建立**時間連續世界模型**

**執行原則**：
1. **不寫死「不分析」**：Daily 須做統整與連接，不是只做純蒐集
2. **須連接歷史**：產出當日快照須讀取前三天歷史快照
3. **須產出統整摘要**：不只是原始數據，須有結構化統整
4. **程式數據來源與公式摘要須記錄**：所有硬數據須記錄來源

**與 Weekly 分工**：
- **Daily（D-3/D-4）**：只記錄與連接，**不裁決身份**；僅輸出 signals/hints/flags
- **Weekly（WB-1）**：**身份裁決層**；做 DSFP 判斷、策略決定

#### 歷史與現狀銜接原則 ⭐ V8.35 定案

**核心**：前三天歷史快照 + 同一觀察者連續撰寫

**規則**：
1. D-3/D-4 產出當日快照前，**必須**讀取前三天的歷史快照
2. 輸出須如同同一位觀察者**連續撰寫**日誌
3. 不可出現敘事斷裂或矛盾（除非標記為「立場轉變」）

#### 原則 1：機構級預測視角（P3 核心靈魂）

**P3 技術分析模組的本質不是「技術分析」，而是「機構級預測」**

- ✅ **視角定位**：以機構主力、大型對沖基金、高盛、摩根等大機構的視角來分析
- ✅ **目標定位**：目標是「預測未來」，而不是套用公式
- ✅ **分析邏輯**：「量大於價」、解釋主力行為、判斷真正意圖、預測未來操作
- ✅ **執行策略**：跟著主力來順風獲利，而非只是單純程式就能做的技術分析
- ✅ **數據使用**：必須整合 P2.5 的機構級數據，技術指標已由程式計算好，直接使用
- ✅ **輸出要求**：必須包含「主力行為解釋」、「意圖判斷」、「未來預測」
- ✅ **禁止事項**：禁止輸出「根據 RSI、MACD、均線、支撐壓力」等程式就能算的結論

**詳細說明**：請參考 `系統核心設計原則_V8.0.md` 的「最高等級原則 1」

#### 原則 2：P2 同業比較與相對位置原則 ⭐ **兩階段流程設計**

**P2 財務指標分析的重點不是指標的絕對數值，而是跟同業比較**

- ✅ **核心任務**：
  - 判斷公司在同業中的相對位置（前段、中段、還是後段？）
  - 判斷在同一板塊裡，它是結構性優勢者，還是結構性弱者？
  - 判斷財務特徵是否「不像這個板塊的正常公司」？
- ✅ **同業定義**：
  - **不是「同板塊」**（板塊太大，不適合），而是「相同細分產業」
  - 必須由 AI 模型交叉判定，基於相同細分產業、相似業務模式、相似市場定位
  - 不需要太多間（3-5 家）
- ✅ **同業分類要求** ⭐ **關鍵**：
  - **絕對不能拿產業龍頭跟新創公司比！必須按照公司規模分類比較：**
    * **龍頭公司（Market Leader）**：產業中市值最大、市占率最高的公司
    * **中大型公司（Mid-to-Large Cap）**：市值和規模中等偏大的公司
    * **小型新創公司（Small Cap / Startup）**：市值較小或新創公司
  - **分類比較要求**：

#### 原則 2.1：P2 統一數據源設計 ⭐⭐⭐ **V8.0 SSOT 定案**

**防止財報計算方式偏移：P2 的持股清單與同業財報數據都要來自同一個權威財報網站**

- ✅ **設計目的**：
  - 確保財報計算方式一致，避免不同數據源的計算差異導致比較基準偏移
  - 確保持股清單（目標公司）和同業公司的財務數據來自同一數據源
- ✅ **數據源配置**：
  - **美股和台股**：統一使用 **財報狗網站**（`GOOGLE_CSE_CX_P2_US_TAIWAN`）
  - **日股**：統一使用 **buffet code 網站**（`GOOGLE_CSE_CX_P2_JAPAN`）
- ✅ **實施要求**：
  - 目標公司和同業公司必須使用相同的 CSE 進行財務數據收集
  - CSE 後台必須設定為只搜尋指定的單一財報網站（避免混用多個數據源）
  - 程式碼中的 CSE 配置和函數調用必須嚴格遵循此設計
- ⚠️ **注意事項**：
  - 此設計不適用於其他 Phase（如 P2.5 機構籌碼數據使用 `INSTITUTIONAL_DATA` CSE）
  - 此設計僅針對 P2 財務數據收集，確保同業比較的基準一致性

---
    * 目標公司是龍頭 → 與其他龍頭公司比較
    * 目標公司是中大型 → 與其他中大型公司比較
    * 目標公司是小型新創 → 與其他小型新創公司比較
    * ❌ **禁止跨分類比較**（例如：龍頭 vs 小型新創）
- ✅ **兩階段執行流程** ⭐ **關鍵設計**：
  - **Stage 1（AI 執行）**：識別同業公司清單
    * 識別目標公司的規模分類（龍頭/中大型/小型新創）
    * 找出 3-5 家同業公司（必須與目標公司屬於相同規模分類）
    * 同時提取目標公司和同業公司的財務指標
    * 輸出同業公司清單（包含規模分類和選擇理由）
  - **Stage 2（程式執行）**：收集數據並計算相對位置
    * 優先從 Stage 1 的 AI 輸出中獲取同業財務指標
    * 計算目標公司在每個指標的相對位置（前段/中段/後段）
    * 判斷結構性優勢/弱勢
    * 判斷異質性風險
  - **為什麼採用兩階段流程**：
    * 避免兩次 AI 模型無法承接上下文
    * AI 專注於需要推理的任務（識別同業、分類規模）
    * 程式專注於需要精確計算的任務（排名、百分位數、相對位置）
- ✅ **Gate 檢查標準**：
  - Gate 檢查應基於同業比較結果，而非絕對數值
  - 多數指標在前段且無重大異質性風險 → PASS
  - 多數指標在中段但核心指標良好 → PARTIAL
  - 多數指標在後段或存在重大異質性風險 → FAIL
- ✅ **同業數據收集** ⭐⭐⭐ **V8.0 SSOT 定案：統一數據源設計**：
  - 同業數據必須從相同白名單數據源抓取（確保比較基準一致，偏移可以被抵消）
  - ⭐⭐⭐ **統一數據源設計**：目標公司和同業公司都必須來自同一財報網站
    * 目標公司是台股 → 同業也從 `P2_US_TAIWAN` CSE（財報狗）抓取
    * 目標公司是美股 → 同業也從 `P2_US_TAIWAN` CSE（財報狗）抓取
    * 目標公司是日股 → 同業也從 `P2_JAPAN` CSE（buffet code）抓取
  - ⚠️ **重要**：此設計防止財報計算方式偏移，確保持股清單與同業財報數據來自同一權威財報網站

#### 原則 2.2：P2 雙 FPE 制度 ⭐⭐⭐ **V6.0 原始設計恢復（已修正）**

**防止市場情緒誤判：使用雙 FPE 制度區分公司財測與市場共識**

- ✅ **FPE_A（基於公司財測/來期業績推導的 Forward P/E）**：
  - **定義**：用「公司財報指引中自己給的財測/來期業績」去推 forward EPS → forward P/E
  - **推導方式**：FPE_A = 當前股價 / 公司財測/來期業績的 Forward EPS
  - **特性**：偏公司端/可驗證，來自公司官方財測
  - **限制**：FPE_A 公布時就已經股價反應，沒有未來增幅的效用
  - **在 P2 中的定位**：FPE 在 P2 的安全性分析權重不高
  - **數據來源**：財報狗（美股/台股）、buffet code（日股）的財報搜尋結果（提取財測/來期業績）

- ✅ **FPE_B（市場分析師共識的 Forward P/E）**：
  - **定義**：市場上分析師的大致共識（分析師預估的 Forward P/E）
  - **特性**：不準確數據，偏向市場氣氛，來源無法驗證，可能人為操縱
  - **重要特性**：真正對股價有推動力的是後來不斷更新的 FPE_B
  - **限制**：外來資訊僅做為參考與輔助，我們的系統才是真正能全方位算出最接近未來 FPE 的工具
  - **用途**：判斷市場溫度計（普遍樂觀/中性/悲觀）
  - **使用方式**：
    1. 必須要跟同業的數據做比較
    2. 判斷出是整個板塊市場情緒都是樂觀/中性/悲觀，還是只有該公司被市場特別的樂觀/中性/悲觀
    3. 其結論作為 FPE_A 的輔助資料或驗證資料（是否與公司官方相符/背離）使用
  - **數據來源**（可選方案，需評估）：
    * Yahoo Finance Analysis 頁面（爬蟲，非 CSE）
    * 財報狗網站（P2_US_TAIWAN CSE）- 財報狗的 Forward P/E 實際上是分析師預估
    * 需要評估哪個更合適

- ✅ **FPE 在系統中的定位**：
  - ⚠️ **FPE 在 P2 的安全性分析權重不高**
  - ✅ **FPE 在股價漲幅潛力面卻是非常重要的因素**
  - ✅ **FPE 更像是 P3 的因子**：P3 判斷現在股價是否便宜/合理/昂貴的因子之一
  - ✅ **數據繼承**：FPE A/B 都要繼承給 P3 作為綜合判斷調整 cat 使用
  - ⚠️ **禁止使用 FPE 單一項來決定**：FPE A/B 僅是眾多決策因子的一環

**詳細說明**：請參考 `系統核心設計原則_V8.0.md` 的「最高等級原則 2」和 `P2同業比較兩階段流程設計_V8.0.md`

#### 原則 3：白名單數據源原則

**所有系統數據都要由白名單去拿，不能讓 AI 模型自己去找，以免偏差**

- ✅ **數據收集控制**：所有數據類的資料一律不由 AI 模型自己搜尋，全部由程式從白名單數據源獲取
- ✅ **白名單數據源** ⭐⭐⭐ **V8.0 SSOT 定案：P2 統一數據源設計** + **⭐ V8.33 目標架構：OHLCV/宏觀主來源為可靠 API**：
  - **P2 財務數據**：使用白名單 CSE（`P2_US_TAIWAN` 財報狗、`P2_JAPAN` buffet code）；美股和台股統一使用財報狗，日股統一使用 buffet code，防止財報計算方式偏移。
  - **⭐ V8.33 目標架構（數據源）**：**OHLCV 與宏觀數據主來源應為可靠 API**（如 yfinance、官方 API、或同級穩定來源），備援為 stooq 等；**資料源須有抽象層、cache、fallback**。**GOOGLEFINANCE 僅可用於 P6 快速監控或備援，不得作為核心 OHLCV/宏觀主來源**（其非同步延遲、#N/A、週末 timeout 等不適合作為核心依賴）。
  - **GAS 過渡**：GAS 現行以 GOOGLEFINANCE 為優先來源為過渡；新平台（如 Python）實作時須依目標架構改為可靠 API 為主、GOOGLEFINANCE 僅 P6 或備援，見《GAS 妥協清算與 Python 重建工程備忘錄》。
  - **⭐ V8.40 Python 數據來源原則**：若 Python 有**品質更好、更穩、更即時、更乾淨**的數據來源，就**改用**；**GAS 時代妥協的產物，有更好的就取代掉，不要把舊的妥協帶到新系統**。白名單原則不變，但來源可升級（如專用 API、官方 API 取代 CSE/GOOGLEFINANCE）。
  - **若仍使用 GOOGLEFINANCE 時**（僅 P6 或備援）：宏觀可用 `CURRENCY:XXXYYY`、`INDEXCBOE:XXX`、商品 ETF 代理；OHLCV 可用 `NASDAQ:TICKER`、`TPE:TICKER`、`TYO:TICKER` 等；須有等待/重試機制，技術指標由程式計算。
  - P5 Daily 新聞：使用白名單 CSE（P5_NEWS）
  - P3 技術數據：優先從結構化存儲（如 MARKET_INDICATORS_DAILY、MARKET_OHLCV_DAILY 或 DB 等效）讀取，不足才從主來源或備援補充
  - P6 盤中監測：可用快速來源（目標架構下 GOOGLEFINANCE 僅在此角色或備援）
- ✅ **數據繼承**：P3 讀取歷史 OHLCV 優先從存儲讀取；不足時由主來源或備援補充。P2-2 產出 Phase2_Output 後，P3 繼承使用（下游一律讀 Phase2_Output）。
- ✅ **Prompt 要求**：所有 Prompt 必須明確說明「所有數據類的資料一律不由 AI 模型自己搜尋，全部由程式從白名單數據源獲取」

**詳細說明**：請參考 `系統核心設計原則_V8.0.md` 的「最高等級原則 6」、`系統數據收集清單_V8.0.md`

#### **⭐ V8.40 三層架構原則（工作搭配正確處理端）**
- **定位**：**三層架構（Collector 抓 Raw / Calculator 算 Computed+Flags / Interpreter 用 AI 判讀）** 是我們本來就在做的方向，是**各種工作要搭配正確處理端的基本原則**，**並不是指哪個 Phase 做哪個工作**。
- **同一模組內可兼有程式與 AI**：例如 **P5 D-3** 當中也有**程式計算**衍生品期權等指標，也有**AI 統整**各個指標對應的意義；Collector/Calculator/Interpreter 是「工作類型」的分配原則，不是「Phase 與層級一一對應」。
- **衍生品與結構性風險監控**：討論串中 A–G 七大類與監控總表須**補強與融合進 SSOT**，並**確定分工、避免打架與重複工作**；見《Daily每日蒐集清單與白名單_SSOT級_2026-01-26.md》與衍生品監控清單。
- **程式數據來源與公式**：**每項該用程式寫的數據來源與相關公式摘要**須記錄，以免遷移時遺漏；見《SSOT細節缺口與遷移備忘錄_2026-01-26.md》及工程備忘錄。

---

## 📊 V8.0 架構總覽

### ⭐ 目標架構與 GAS 過渡說明（必讀）⭐ **V8.33 定案**

- **本 SSOT 描述者為「目標架構設計」**：以下所有章節以「換平台後應有的完美版設計」為準，**不得**將曾因 GAS 平台限制而採用的妥協或閹割性設計原樣複製到新平台（含 Python 重建）；否則換平台等於白換，系統將死在初期。
- **曾因 GAS 限制而妥協的項目**（已在本 SSOT 改寫為目標版）：① 執行層：應為任務隊列 + Worker + 長任務原生支援 + 任務狀態機，**禁止**以「時間觸發串接」或「6 分鐘切段可重入」為核心架構。② 資料存儲：核心應為結構化資料庫（如 Postgres/Supabase 或等效），**禁止**以 Spreadsheet/表格為核心資料庫；表格僅為 Dashboard 或手動介面。③ 數據源：OHLCV/宏觀主來源應為可靠 API（如 yfinance/官方 API 等），**禁止**以 GOOGLEFINANCE 為核心主來源；GOOGLEFINANCE 僅可用於 P6 快速監控或備援。④ 觀測與可追溯：每次 run 須有 run_id/trace_id 全鏈路追蹤；Hard Constraints 程式覆寫須寫入 audit_log。
- **詳細工程實現方法**（如具體 Queue 選型、DB schema、API 清單、測試與告警實作）除非為必備重要概念，否則**不寫入 SSOT**，改寫入 **《GAS 妥協清算與 Python 重建工程備忘錄》**；實作時以本 SSOT 為架構依歸、以該備忘錄為工程依歸。
- **⭐ 平台與實作說明（V8.41）**：**GAS 版本已確定中止**，原程式碼僅保留於 `gas_archive/` 作為未來撰寫 Python 時對照細節之用；接下來**全面搬移至 Python**，目前尚未正式開始實作。文中「實現位置」所載之 `.js` 路徑均指 `gas_archive/` 內對照用程式碼；實作時以 **Python** 為準。

- **⭐ 設計名詞對照（V8.41，避免混淆）**：
  - **P5 Daily**：目標架構使用 **D-1、D-2、D-3、D-4** 四模型（新聞／索引／個股統整／宏觀世界觀）。**P5.1、P5.2、P5.3 舊稱已廢止**，改用「Daily 新聞與宏觀數據（D-1 對應）」「Daily OHLCV 蒐集」「Daily 籌碼／衍生品蒐集」；不再使用 P5.1／P5.2／P5.3。
  - **P5 Weekly**：目標架構使用 **WB-1、WB-2、W-A**（宏觀與個股分析／個股策略與掛單／觸發式審查或重建）。**P5-B、P5-A** 為 GAS 時代之舊稱，對應關係為 P5-B ≈ WB-1+WB-2 之評估層、P5-A ≈ 升級池審查；主文以 WB-1／WB-2／W-A 為準，P5-B／P5-A 僅於附錄或 gas_archive 對照時出現。

### ⭐ 核心架構原則（V6.0 原始設計，必須保留）

#### One Way 架構 ⭐ **V6.0 原始設計 + V8.0 擴展**
- **執行順序**：P0 → P0.7 → P1 → P2 → P3 → P4 → P5 → P6
- **核心原則**：
  - ✅ 後段不得改動前段結論
  - ✅ 只能標註風險、降權、剔除
  - ✅ Phase 5 以 Append-only 方式新增版本
  - ✅ Phase 6 盤中監測獨立運行，不影響 P0-P5 結論（只記錄異常）
  - ✅ **Daily（D-1～D-4）為史官層** ⭐ V8.31：僅記錄與連接，世界框架與策略屬 Weekly；D-3/D-4 須遵守**史官鐵律**（不得改寫歷史、僅能追加 delta/link/tag/branch，保留舊 evidence），見下「Daily 史官鐵律」。

#### 快照機制 ⭐ **V6.0 原始設計**
- **核心功能**：
  - ✅ 每個 Phase 執行後保存完整快照
  - ✅ 自動比對上一版
  - ✅ 自動觸發下游（有變動時）
- **下游引用鐵律** ⭐ **V8.34**：下游僅能**引用**當次 Run 的 Snapshot/Delta Pack，**不得**重新執行上游 Phase 以取得結論；同一決策「生成一次，多處引用」。
- **實現位置**：`src/06_SNAPSHOT_MANAGER.js`（GAS）；目標架構下快照存於結構化 DB，見「資料存儲（目標架構）」與工程備忘錄。

#### 規則衝突優先權總表 ⭐ **V8.34 定案**
- **目的**：當兩條規則衝突時，工程師可一眼看到誰優先；避免隱性打架。
- **覆寫順序**（由高到低）：
  1. **風控層**：Hard Constraints（數學邊界、defcon1、emergencyExit、Safety Lock 等）— 程式強制執行，AI 無法繞過
  2. **市場氣候**：Market Climate Override（如 P0.7=LATE_CYCLE 且世界觀=BEARISH → FORCE_MAX_EXPOSURE=30%）
  3. **P4 配置**：Portfolio Correlation Lock、IDENTITY_DRIFT 降 U、P4 Allocation
  4. **Learning / Safety Lock**：Learning constraints override strategy preferences；情境記憶死亡率 > 0.5 → max_exposure 上限
  5. **P5 策略**：WB-2 個股策略、權重與掛單
  6. **個股買入**：Individual Buy 決策
- **審查覆寫**：Deep Auditor 產出之該 Phase **最終結論**覆寫 Analyst+Scout；Scout 僅補強時不觸發 Deep Auditor。
- **參考**：`架構師級SSOT檢查清單_V8.md`、`SSOT架構師級審查報告_V8.34_2026-01-26.md`。

#### AI 決策層原則（架構師級審查補強）⭐ **V8.34 定案**
- **不決策出口**：決策類 Prompt 應支援「不決策」出口，避免逼 AI 硬猜。建議輸出值：**DATA_INSUFFICIENT**、**NEED_MORE_CONTEXT**、**FRAME_UNCERTAIN**；輸出時須簡述理由（如：缺少哪類資料、需補何種情境）。GLOBAL_SYSTEM_BLOCK_DSFP_V1 已規定「資料不足時標記 INSUFFICIENT_STATE_DATA，不得腦補」；其餘決策 Phase 實作時應對齊此原則。
- **決策可追溯**：每次決策應可追溯三層原因（觸發規則 / 輸入狀態 / 輸出結論）；結合 run_id、trace_id、audit_log（Hard Constraints 程式覆寫須寫入），供除錯與合規。
- **模型無關原則**：Prompt 與輸出 schema 不依賴單一模型特性；換模型時僅調整 M0 配置與必要參數，不重寫業務邏輯。
- **規則生命週期**：風控規則由版本號/變更日標記；策略與權重建議由 Learning 與季度審查更新；Prompt 區塊由 SSOT 版本對應；重大規則變更須經審查並更新 SSOT 版本。

#### 執行層與任務調度（目標架構）⭐ **V8.33 定案**

- **目標設計**：**任務隊列 + Worker**（或雲端等效），長任務（Monthly/Quarterly 全跑、P0.7 模擬、P5 Weekly 全量整合）可單次執行或由隊列排程分段；**任務狀態機**（RUNNING / PARTIAL / RETRYING / FAILED / COMPLETED）；可控並行與每 provider 節流；**分層優先級**（P6 emergency > Daily > Weekly1 > Weekly2 > Monthly/Quarterly）。**禁止**以「時間觸發串接」或「固定時間切段可重入」為核心架構。
- **GAS 過渡說明**：GAS 時代因 6 分鐘執行上限曾採用「可重入設計」「Trigger 串接」「殭屍 Trigger 清掃」等妥協；該等實現為過渡，**新平台實作時不得複製**，須依上述目標設計。具體工程方法（Queue 選型、狀態機、節流）見《GAS 妥協清算與 Python 重建工程備忘錄》。

#### 資料存儲（目標架構）⭐ **V8.33 定案 + V8.36 架構提前納入**

- **目標設計**：**核心資料存儲為結構化資料庫**（如 Postgres、Supabase 或等效）；snapshots、events、narratives、learning_state、orders、alerts、audit_log 等為結構化表；Run ID / Snapshot ID 與資料血緣可追溯。**Spreadsheet/表格僅為 Dashboard 或手動輸入介面，不得作為核心資料庫。**
- **GAS 過渡說明**：GAS 現行以 Google Sheets 表名為存儲為過渡；新平台實作時須改為 DB 為核心，詳見工程備忘錄。
- **⭐ V8.36 架構提前納入（實作時必須一次到位）**：
  1. **Hermes 4 輸出表（ai_outputs / strategy_executions）**：凡使用 Hermes 4 的 Phase 產出，須含 `final_answer`（熱）、`reasoning_trace`（冷，可存 R2 或 TEXT，索引須能追到）、`storage_key`（若 reasoning_trace 存冷儲存）、`model_name` + `include_reasoning`（可稽核）；M0 Adapter 須有「think 抽取器」（Parser）與「禁止 OpenRouter 過濾 think」的保護。見 M0 Hermes 4 思考過程保存。
  2. **Weekly / Order DSL**：WB-2 每個 order 須引用 `worldview_version` 與 `identity_context`；Order DSL 須帶此兩欄位；資料模型須支援。Weekly pipeline 須支援「條件式重跑範圍」（escalation → P1–P4，不含 P0），用**任務圖/狀態機**寫法，不得硬寫死 P5 流水線。
  3. **P6 資料保留**：P6 表須區分「一般監測」vs「異常需保留」（至少 flag）；清除動作**不得**用 cron 亂刪；須「本週策略產出完成 → 解鎖 → 才允許清除上週一般數據」的**清除鎖**；不包含已寫入共用 OHLCV 表的資料。見 P6 數據保留規則。
  4. **DSFP / worldview 快照**：`world_state_snapshot`、`asset_identity_map`、`narrative_map` 等 WB-1 產物須能存（熱索引 + 冷內容）；WB-2 下單時須讀這些身份裁決並寫進每筆 order 的 `identity_context`。須有「worldview / identity」類型的 snapshot 分支，供下游引用。

#### M0 統一 AI 調用 ⭐ **V6.0 原始設計 + V8.16/V8.17 更新 + ⭐ V8.29 API 架構定案**
- **核心原則**：
  - ✅ 所有 AI 調用統一通過 M0__JOB_QUEUE
  - ✅ P0-P5 不直接調 API
  - ✅ **API 路由** ⭐ V8.29 定案：除 **o3**（Batch 維持 OpenAI API 直連）外，**其餘模型一律經 OpenRouter API**；M0 保留為統一路由層（Job 隊列、重試、Token 統計、審查觸發、Batch 提交），內部改為 **OpenRouter Adapter**（非 o3）+ **OpenAI 直連 Adapter**（僅 o3）。
  - ✅ **Hermes 4 推理模式（Think Mode）** ⭐ **必開**：所有使用 **Hermes 4 / Hermes 4 405B** 的工作**一律須開啟推理模式（Reasoning Mode / Think Mode）**，以獲得深度推理結果。Hermes 4 405B 的推理模式可透過 **API 參數** 或 **Prompt 引導** 觸發；**推薦**經 OpenRouter 呼叫時在 API Request Body 中加入 **`"include_reasoning": true`**（或依 OpenRouter 最新文件使用 `extra_body.provider.reasoning.enabled` 等）。效果：模型會先輸出 `<think>` 標籤內容進行思考，由 OpenRouter 解析後回傳；會增加 Output Token 消耗（費用較高），但為本系統所需之推理品質。實作時見 M0 配置或工程備忘錄。
  - ✅ **Hermes 4 思考過程保存（必做）** ⭐ **付費買白箱**：Hermes 4 的思考過程**全部計費**（Output Token），**既然每一分錢都花在 Token 上，不把「大腦切片（思考過程）」存下來簡直是浪費。** Hermes 4 相比 OpenAI o3 的優勢：**OpenAI 是「付費買黑箱」，Hermes 4 是「付費買白箱」。** 實作要求：**(1) API 端**：強制 `include_reasoning: true`，**不要讓 OpenRouter 過濾掉 `<think>` 標籤**；(2) **程式端**：Parser 將 `<think>` 內內容獨立提取，存入資料庫 **`reasoning_trace`** 欄位，其餘存 **`final_answer`** 傳給下游。戰略意義：P4 風控黑盒解密（敢不敢執行看 Trace）、Debug 邏輯死鎖（Prompt 打架可追溯）、未來微調（累積高品質思考路徑訓練小模型）。**對於所有使用 Hermes 4 的模組（特別是 P3、P4、WB-1/WB-2、Deep Auditor），必須強制開啟 `include_reasoning`，並將 `<think>` 內容獨立存入 `reasoning_trace`；這是未來資產，絕對不能丟棄。** **Python 實作必須強制**：呼叫 Hermes 4 時須帶 `include_reasoning: true`（M0 層檢查），Parser 輸出須寫入 `reasoning_trace`；DB schema 須含 `reasoning_trace`（熱/冷儲存由工程決定）。詳細實作（Payload、Parser、DB Schema）見《GAS 妥協清算與 Python 重建工程備忘錄》「Hermes 4 思考過程強制回傳與保存」。
  - ✅ 雙模型流程（執行者 ≠ 審查者）⭐ V8.16 更新：部分 Phase 改為觸發式審查或無審查者；⭐ V8.29 新增：**Scout（第一層審查）+ 分歧時 Deep Auditor（最高層仲裁，一律 o3）**，見下「AI 雙模型與 Scout/Deep Auditor」。
  - ✅ **Batch API 優先** ⭐ V8.17 新增：適用 Phase 預設使用 Batch（50% 成本折扣）
- **⭐ V8.16 核心變更**：
  - **移除裁決者**：大多數工作不需要第三個裁決者模型，裁決功能由規則引擎 + Snapshot Diff + Kill Switch 取代
  - **審查者必須看到原始資料**：所有 Phase 的審查者都必須同時看到原始輸入資料和執行者輸出，才能發現執行者的「隱性省略」
    - **審查者應該拿到的「關鍵原始資料」**：
      - P1/P2 的 evidence_json（已實現）
      - 財報段落：最多每段 1–2 句 + page/period/source
      - P3 技術指標與計算輸入（全部是程式算的數值）
      - P5 新聞索引：不是全文，只給 cluster 標題、標籤、嚴重度、關聯股票、時間戳
      - 快照 diff：上週 vs 本週的差異表
    - **絕對不要給的東西**：
      - 全量新聞全文
      - 全量歷史策略全文
      - 多檔股票混在一起的長上下文（除非做 P5-A 世界觀統整）
  - **觸發式審查**：P3 和 P5-B 改為觸發式審查，降低成本
  - **Delta Pack 設計**：P5 Weekly 必須使用 Delta Pack（變動摘要），而非完整資料
- **⭐ V8.17 核心變更：Batch API 整合**：
  - **統一 Batch 抽象層**：工程師只處理統一的內部 Batch Job 格式，不直接處理各 Provider API
  - **內部 Batch Job Schema**：
    ```json
    {
      "job_id": "P5B_2026W04",
      "provider": "anthropic|openai",
      "model": "claude-sonnet-4.5|claude-opus-4.5|gpt-5.2|o3",
      "requests": [
        {
          "custom_id": "P5B_NVDA_2026W04",
          "system_blocks": ["STATIC_RULES_BLOCK_ID"],
          "user_payload": { "delta_pack": "...", "snapshots": "...", "schema": "..." },
          "max_output_tokens": 1200
        }
      ],
      "postprocess": { "schema_validate": true, "rule_validate": true }
    }
    ```
  - **Provider Adapter**：兩個薄 Adapter（Anthropic、OpenAI）負責轉換內部格式到 Provider API
  - **Batch 適用條件**：
    - ✅ 任務彼此獨立
    - ✅ 不需要即時回傳
    - ✅ 可容忍 1h 內完成
  - **適用 Phase（預設 Batch）**：
    - ✅ P1 Step1（股票池生成）：每家公司獨立
    - ✅ P2 / P2.5：每家公司獨立
    - ✅ P3（技術面）：每家公司獨立
    - ✅ P5-B（Weekly Evaluator）：每家公司獨立
    - ✅ P5-A（升級池）：每家公司獨立
    - ✅ P5 Monthly / Quarterly 回顧：每股票獨立
    - ✅ P0.5 Mode-2（Chain Dynamics Monitor）：各產業獨立
  - **不適用 Batch**：
    - ❌ P0（產業分析）：單一巨上下文
    - ❌ P0.7（系統動力學）：因果循環
    - ❌ P5 Daily 新聞：即時性
    - ❌ P5 世界觀統整：多模組合併後再推理
    - ❌ P6 盤中：即時性
  - **Prompt Caching 策略** ⭐ **省 o3 成本關鍵**：
    - **目的**：P1-2 到 P5（每檔個股）、D1-4（每則新聞/每檔索引）都是**重複 prompt 呼叫 100 次**，固定前綴必須 cache 以大幅降低 input 成本。
    - **Anthropic**：system blocks 使用 `cache_control: {type: "ephemeral"}`
    - **OpenAI**：固定 system prompt 模板（o3 支援 prompt caching，>1024 tokens 以 128 token 為單位自動 cache，cached input 約 50% 折扣）
    - **可 Cache 內容**（固定前綴）：SSOT / Phase rules / 評分標準 / schema / 硬約束條文
    - **變動內容**（per-request）：delta pack / ticker 事實 / 新聞片段 id / 當次 snapshot
    - **實作要點**：固定前綴須**完全一致**（同一 batch/run 內不可變動），才能多檔吃到 cache；變動內容只放在後段 user message。**Scout/Deep Auditor 的 context 不可省**（省掉 = 降品質），但固定規則仍可 cache。
  - **成本折扣**：Batch API 提供 50% 成本折扣（Input 和 Output 都打折，含 o3 reasoning tokens）
  - **錯誤處理與 fallback**：Batch 提交失敗時重試、部分成功時記錄失敗 custom_id 並單獨重試、超時時降級同步 API、結果驗證見工程備忘錄。**Fallback 模型或 provider 清單**（含鎖 provider 時之備援）見工程備忘錄或 M0 配置，後補。
  - **⭐ 省 o3 隱形思考（reasoning）tokens 三招**（完全不犧牲品質）：
    - **招式 A：Prompt Caching**（已定案，見上）→ 降 input 成本（固定前綴約 50% 折扣）
    - **招式 B：Batch API**（已定案）→ 降整單成本（input + output 含 reasoning 約 50% 折扣）；o3 batch 已用於：P2-2 Scout、P2.5、P3、WB-2 Scout
    - **招式 C：程式前置裁剪**（部分已實現）→ 降 o3 reasoning 體積（讓 o3 不必在思考中重跑「可計算」的檢查）；**原則**：不是用程式取代分析，而是用程式砍掉「o3 在腦中重跑規則引擎」的負擔；**只移走「確定性檢查 + 已寫死規則」，不移走「需判斷」的項目**；詳細清單見工程備忘錄「o3 成本優化」專節
- **實現位置**：`src/03_M0_CORE.js`、`src/02_M0_CONFIG.js`、`src/04_M0_ADAPTERS.js`、`src/04_M0_BATCH_RUNNER.js`（新增）、`src/04_M0_BATCH_ADAPTERS.js`（新增）

#### AI 雙模型與 Scout / Deep Auditor ⭐ V8.29 定案

- **機制**：在現有「分析者（Analyst）+ 第一層審查（Scout）」基礎上，當 Analyst 與 Scout 意見**明顯分歧**時，呼叫**最高層最終仲裁（Deep Auditor）**產出該 Phase **最終結論（覆寫）**；若 Scout 僅補強、未分歧則不觸發 Deep Auditor。
- **Scout 定位與職權**：
  - **定位**：發現「分析框架本身」的盲點與視角偏差，而非補 Checklist。
  - **三職權**：Meta-level 框架盲點、權重配置認知偏差、敘事一致但現實不一致。
  - **三層次**：Consistency & Blind Spot Check（門檻）、Orthogonal Signal Discovery（關鍵）、Counterfactual World（高階）。
  - **輸出結構**：Critique、Discovery 兩方向；固定 JSON 格式輸出：Most_Probable_Alternative、Weight_Sensitivity、Hidden_Signal_Candidates、Decisive_Tests。
- **Deep Auditor 定位與職權**：
  - **觸發條件**（OR）：分歧、高風險、高影響、自信度不足、輸出不一致、資料異常等（詳見各 Phase 觸發清單）。
  - **輸出**：Rebuild the Causal Chain、Scenario Probability Table、Action Under Uncertainty、What Analyst Missed；輸出為該 Phase **最終結論（覆寫）**。
  - **模型**：Deep Auditor 一律使用 **o3**。
- **適用範圍**：除 **P0.7、P2-1、P5 Daily D-1～D-4** 無 Scout/Deep Auditor 外，其餘有審查者的 Phase 皆套用。
- **參考**：`各階段Prompt補強參考_2026-01-26.md`。

#### DSFP 五模組與全 Phase 植入規範 ⭐ V8.32 定案

- **五模組與系統對應**：① 價格位置（Relative Position）→ P3 趨勢位階、Weekly Regime、Sector RS ② 成交與流動性（Volume & Liquidity）→ P2.5 籌碼、ETF Flow、OI/Volume Delta ③ 衍生品與槓桿密度（Derivatives & Leverage）→ Gamma/OI、Options Flow、Leveraged ETF ④ 參與者結構（Participant Structure）→ Smart Money、13F、Sector Concentration、P2.5 ⑤ 規則與機制（Rules & Mechanics）→ 政策事件、新 ETF/新法規、行事曆。
- **Weekly 身份裁決子模組**：對重要金融商品（指數、板塊、黃金/債/匯/比特幣等）做**當前身份狀態**評估；禁止使用歷史標籤，須依五模組交叉驗證；≥3 項顯著變化 → `IDENTITY_DRIFT = TRUE`；產出身份轉變說明、`asset_identity_map`、`framework_stability_score`（見上「動態現況優先原則」）；⭐ V8.30 目標架構下由 **WB-1** 執行。
- **各 Phase 加強塊要點**（只加 System/User block，不改主體）：**P0** INDUSTRY_STATE_SNAPSHOT、INDUSTRY_IDENTITY_SHIFT；產業候選只來自「結構性必然」或「狀態漂移造成之新定價」。**P0.5** 節點標記 STRUCTURE_ROLE、FLOW_SENSITIVITY、DERIVATIVE_SENSITIVITY；若產業狀態漂移可輸出 CHAIN_MAP_VERSION_BUMP。**P1 Step1** INDUSTRY_FIT、REPRICING_VECTOR、STATE_FIT_EVIDENCE；禁止只用「題材對」入選。**P1 財報提取** 只輸出原文與位置；若遇身份漂移線索標記 IDENTITY_SIGNAL_QUOTE。**P1 Step2** INDUSTRY_TYPE、BUSINESS_MODEL_SIGNATURE、PRIMARY_TRUTH_METRICS、FORBIDDEN_METRICS；後續判斷須引用 PRIMARY_TRUTH_METRICS。**P2-1** 同業須狀態一致；輸出 STATE_DEPENDENCE、RECHECK_TRIGGER（高狀態依賴時下週重算）。**P2-2** Step0 Industry Logic Injection：INDUSTRY_PLAYBOOK、CFO_QUESTIONS_TOP10、CHAIRMAN_FORWARD_VIEW_LENS；Step1 僅引用白名單+原文，無證據則 UNKNOWN_NOT_GUESS。**P3** 型態判斷前先輸出 DISTORTION_RISK（NONE/LOW/MED/HIGH）；若為 gamma/ETF/槓桿扭曲；HIGH 時禁止高信心突破、改為 TRAP_RISK 或 WAIT_CONFIRMATION。**Daily D3/D4** 嚴禁世界觀重建與策略建議；只允許 EVENT_CLUSTER_UPDATE、IDENTITY_SHIFT_SIGNALS（僅 signal）、WEEKLY_ESCALATION_HINT。
- **GLOBAL_SYSTEM_BLOCK_DSFP_V1**（可選注入各 Phase System prompt 前）：禁止依「資產名稱」套用歷史標籤；須先做 DSFP 身份判定再分析/分類/結論。五模組（Relative Position, Liquidity & Flow, Derivatives & Leverage, Participant Structure, Rules & Mechanics）。輸出須含 ASSET_IDENTITY、IDENTITY_SHIFT；資料不足時標記 INSUFFICIENT_STATE_DATA，不得腦補。可依 Phase 取用相關子集，不強制全部 Phase 同一長度。
- **P2.5 / P4 行為**：**P2.5** 若機構比例極端 → 標記 PARTICIPANT_IMBALANCE；若 ETF 流量極端 → 標記 FLOW_DISTORTION（與現有 Smart Money、異常警報並存）。**P4** 當 IDENTITY_DRIFT = TRUE（由 Weekly 傳入）時，自動降低 U、增加現金權重；與現有 Market Climate Override、Portfolio Correlation Lock 並存，不覆蓋既有風控。
- **輸出欄位與下游**：IDENTITY_DRIFT、IDENTITY_SHIFT_SIGNALS、asset_identity_map、identity_shift_signals_summary、framework_stability_score 等由 Weekly（或 WB-1）產出並寫入版本化快照/記憶；P4、WB-2、Learning 讀取。DISTORTION_RISK、STATE_DEPENDENCE、RECHECK_TRIGGER 等由各 Phase 產出，下游與驗證時間窗口、Milestone 對接。詳見 `DSFP身份動態化原則_討論整理_待定案.md`（已定案並納入 SSOT）。

#### Skills 模組系統 ⭐ V8.51 定案

- **定位**：將 SSOT 中重複出現的規則、標準、輸出格式抽離為**版本化、可重用的 Skill 模組**，實現 SSOT 真正可執行化。
- **目錄結構**：`src/nuclear/skills/`
  ```
  skills/
  ├── __init__.py           # 模組入口
  ├── loader.py             # Skill 載入器
  ├── constitution/         # 憲法類（每次都帶）
  │   ├── ssot_core_v1.md   # 憲法六條 + 未來對齊三問
  │   ├── dsfp_v1.md        # DSFP 五模組 + 判定規則
  │   └── role_calibrator_v1.md  # 機構視角校準
  ├── rubrics/              # 方法論類（按需注入）
  │   ├── narrative_link_v1.md       # 敘事連結分類（延續/轉折/淡化/強化/分支/新敘事）
  │   ├── derivative_reading_v1.md   # 衍生品解讀（OI/Gamma/IV/Skew/DISTORTION_RISK）
  │   ├── tech_structure_v1.md       # 技術結構（週→日→盤中 + Bull Trap）
  │   ├── risk_overlay_v1.md         # 風險覆蓋政策（System>Sector>Symbol）
  │   └── evidence_protocol_v1.md    # 證據引用協議（evidence_id/禁止腦補）
  └── schemas/              # 輸出格式
      ├── d3_output.json    ├── d4_output.json
      ├── wb1_output.json   ├── wb2_output.json
      └── p3_output.json
  ```
- **Skill Loader API**：
  - `load_skill(skill_id, version)` → 載入單一 skill 內容
  - `load_skills_for_phase(phase)` → 載入該 Phase 所需全部 skills
  - `get_schema(phase)` → 取得輸出 JSON Schema
- **Phase → Skills 映射**（硬編碼，未來可升級為 Router）：
  | Phase | Skills |
  |-------|--------|
  | D3 | ssot_core, role_calibrator, evidence_protocol, narrative_link, derivative_reading |
  | D4 | ssot_core, dsfp, evidence_protocol, narrative_link, derivative_reading |
  | WB1 | ssot_core, dsfp, role_calibrator, evidence_protocol |
  | WB2 | ssot_core, role_calibrator, risk_overlay, evidence_protocol |
  | P3 | ssot_core, role_calibrator, tech_structure, derivative_reading, evidence_protocol |
- **核心收益**：
  - ✅ **輸出穩定**：JSON Schema 標準化，Validator 可程式化
  - ✅ **規則一致**：憲法/DSFP/角色校準器集中管理，修一次全生效
  - ✅ **版本控制**：欄位變更可回滾，不會崩盤
  - ✅ **Prompt 縮短**：重複規則抽離，每次只注入必要 skills
- **測試**：`pytest tests/test_skills_loader.py -v`（19 tests passed）
- **擴展方式**：
  - 新增 Skill：在對應目錄建立 `{name}_v{version}.md`
  - 新增 Phase 映射：編輯 `loader.py` 的 `PHASE_SKILLS` dict
  - 升級為 Router：將映射表抽為 config 檔案

#### Shared Progress Protocol ⭐ V8.52 定案

- **定位**：實現 CLI（自動化工程任務）與 Agent（高邏輯/架構任務）之間的進度共享與銜接機制。
- **三層進度記錄**：
  | 層級 | 檔案 | 寫入者 | 用途 |
  |------|------|--------|------|
  | **Run Log** | `logs/run_log.jsonl` | CLI | 每次執行的結構化日誌（append-only） |
  | **Milestone** | `docs/milestone.yaml` | CLI + Agent | 里程碑檢查點與銜接任務 |
  | **SSOT** | `V8.x_SSOT.md` | Agent Only | 架構決策與設計變更 |
- **分工原則**：
  - **CLI**：執行完成後自動更新 `run_log.jsonl` + `milestone.yaml`
  - **Agent**：任務完成後更新 `milestone.yaml` + SSOT（若有架構變更）
- **Run Log 結構**（JSONL）：
  ```json
  {"timestamp": "...", "command": "wb1", "status": "success", "run_id": "...", "summary": "...", "artifacts": [...], "metrics": {...}}
  ```
- **Milestone 結構**：
  ```yaml
  version: "2026-02-05T04:46Z"
  current_phase: M08
  checkpoints:
    - id: SKILLS_V1
      status: completed
      completed_by: agent
  pending_handoff:
    - from: agent
      to: cli
      task: "Run pytest on VM"
  ```
- **API**（`from nuclear.progress import ...`）：
  - `log_run(command, status, run_id, summary)` - CLI 自動呼叫
  - `update_checkpoint(id, status, updated_by)` - 更新里程碑
  - `add_handoff(from_actor, to_actor, task)` - 新增銜接任務
  - `get_pending_handoffs(to_actor)` - 取得待處理銜接
- **Agent Skill**：`.gemini/skills/read_progress/SKILL.md` 提供讀取 CLI 進度的標準流程

#### 模型配置表（分析師/審查官總表）⭐⭐⭐⭐⭐ **V6.3 定案 + V8.16 更新 + ⭐ V8.29 定案**
- **配置位置**：`src/02_M0_CONFIG.js` 的 `TASK_TO_EXECUTOR`、`getAuditor()`（Scout）、Deep Auditor 觸發邏輯
- **配置內容**（⭐ V8.29 更新：Scout 模型與無 Scout/Deep 之 Phase 明列）：
  - **P0**: Claude o3（執行者）+ Scout GPT-5.2 → 分歧時 Deep Auditor o3
  - **P0.5**: Claude o3（執行者）+ Scout GPT-5.2 → 分歧時 Deep Auditor o3
  - **P0.7**: O3（執行者）+ Claude o3（審查者）；**無 Scout/Deep Auditor**
  - **P1**: ⭐ V8.14 兩階段 + V8.16（Step1 無審查者）
    - **P1_STEP1**: Gemini Flash 3.0（執行者）+ **無審查者**
    - **P1_STEP2**: Gemini Pro 3.0（執行者）+ **Scout Llama 3.3 70B** ⭐ V8.29 → 分歧時 Deep Auditor o3
  - **P2_QUARTERLY / P2_MONTHLY**：拆為 P2-1 + P2-2（見下「P2 工作拆分」）
    - **P2-1**: DeepSeek V3 (671B)（執行者）+ **Scout Llama 3.3 70B** ⭐ V8.29；**無 Deep Auditor**（僅事實層）
    - **P2-2**: Hermes 4（執行者）+ Scout o3 batch → 分歧時 Deep Auditor o3
  - **P2_5**: Claude Hermes 4（執行者）+ Scout GPT-5.2 → 分歧時 Deep Auditor o3
  - **P3**: Claude Hermes 4（執行者）+ Scout GPT-5.2（觸發式審查 15-25%）→ 分歧時 Deep Auditor o3
  - **P5_DAILY**：拆為 D-1～D-4 四模型（見下「P5 Daily 工作拆分」）；**D-1～D-4 皆無 Scout/Deep Auditor**
  - **P5_WEEKLY**:
    - **P5-B**: Claude Hermes 4（執行者）+ 無審查者（只用 Validator）
    - **P5-A**: Claude o3（執行者）+ Scout GPT-5.2（10-20%）→ 分歧時 Deep Auditor o3
  - **P5_MONTHLY / P5_QUARTERLY**: Claude Hermes 4（執行者）+ Scout GPT-5.2 → 分歧時 Deep Auditor o3
- **⭐ V8.30 新設計：Weekly 演進為 WB-1 / WB-2 / W-A**（目標架構，與現行 P5-B/P5-A 並存至實現完成）：
  - **WB-1（分析）**：Hermes 4 405B；無審查（沒觸發時無審查）。任務：宏觀世界觀統整與分析、個股狀態快照與 escalation 判定。
  - **WB-2（分析）**：Hermes 4 405B；**審查**：o3（原廠 batch）。任務：兩類個股（輕度/重度）產出本週策略、掛單。
  - **W-A（僅被觸發時工作）**：o3（不 batch）。兩種觸發：① 世界觀劇變 → 審查 WB-1 重建要求 → 通過則 o3 重建 NEW_WORLDVIEW_FRAMEWORK；② 個股 escalation → 審查觸發原因與該股資料 → 產出審查報告 → 該股 P1–P4 更新 → WB-2 重度更新。
  - **W-A 觸發個股重跑範圍**：**P1–P4**（不含 P0）。產業論述（P0）不涉及個股，產業面變化已有季度與重跑機制，故個股 escalation 不重跑 P0。
- **W-2 觸發** ⭐ V8.29：採用「Weekly B → Weekly A 嚴格觸發條件清單（A～F 類）」作為世界觀框架改變時觸發 W-2；觸發後由 **o3 重跑 W-1 整週策略**（或世界觀+策略，以 SSOT 與實現為準）。
- **⭐ V8.16 核心變更**（保留）：
  - **審查者必須看到原始資料**：Scout 須同時看到原始輸入與執行者輸出
  - **觸發式審查**：P3、P5-A 為觸發式審查
  - **Delta Pack 設計**：P5 Weekly 必須使用 Delta Pack

---

### Phase 0 系列：產業工程學分析（季度執行）

#### **P0: 產業面分析找出潛力產業** ⭐ V8.14 更新
- **檔案**: `09_P0_INDUSTRY_ENGINEERING.js`
- **執行頻率**: 季度
- **功能**: 工程必然分析、結構性定價權分析、輸出「必然位置表」
- **AI 模型**: Claude o3（執行者）+ GPT-5.2（審查者）
- **⭐ 重要**: 純學術硬底子分析，**不包含任何籌碼面分析**
- **⭐ V8.14 新增：時效性防呆機制**
  - **目的**：確保 P0 分析基於最新、最準確的資料，避免源頭錯誤導致後續階段幾何指數放大
  - **機制**：
    1. OPUS 第一次分析後，提出「由於內建知識時效或廣度不足而必須查核的關鍵問題」
    2. 人工下載 PDF → 放入 Google Drive
    3. Gemini Flash 3.0 讀取 PDF 並提取相關原文段落（附頁數）
    4. OPUS 重新分析（標明問題已解決 + 資料來源 + 影響：支持/中立/修正）
    5. GPT-5.2 審查（原有流程）
  - **資料結構**：擴充 `P0__SNAPSHOT`，新增 `initial_analysis_json`、`validation_questions_json`、`validation_status`、`gemini_validation_results_json`、`final_analysis_json`
  - **技術**：使用 Gemini File API（上傳 PDF 到暫存，取得 fileUri）

#### **P0.5: 產業鏈地圖與供應鏈情報網** ⭐ V8.15 重大更新 + V8.18 瓶頸轉移觀測
- **檔案**: `08_P0_5_INDUSTRY_CHAIN.js`
- **⭐ V8.18 新增：瓶頸轉移觀測（Bottleneck Migration Scan）** ✅ **已實現**
  - **觀測任務**：檢查目前產業鏈中哪些關鍵節點的產能、良率、交期、資本支出正在明顯改善，推演下一個最可能限制整條鏈的環節
  - **輸出欄位**：`bottleneck_status`（current_bottleneck、easing_signals、next_bottleneck_candidates）
  - **實現位置**：`src/08_P0_5_INDUSTRY_CHAIN.js` 中的 P0.5 Prompt 和輸出格式
  - **重要原則**：這是觀測任務，不是預測任務（基於工程邏輯推演，禁止引用股價、新聞熱度或市場情緒）
  - **詳細設計**：請參考 `V8.18_系統增強實現計劃_2026-01-23.md`
- **執行頻率**: 
  - **Mode 1（Baseline Builder）**：季度（與 P0 同步）
  - **Mode 2（Chain Dynamics Monitor）**：⭐ **台股月度（每月 12 號）**、美日股季度
  - **⭐ 新系統簡化建議**：可考慮僅實作 Mode 2，Baseline 由 P0 產出以降低複雜度；**惟須確保 P0 的 baseline 產出（如生態系報告／產業邏輯卡等）已涵蓋 P0.5 Mode 2 所需之產業鏈 baseline**，否則仍須保留 Mode 1 或另行補足。
    - ⭐ **台股規定每月 10 日前必須公布上月營收，12 號執行確保資料完整，預留財報狗的更新時間**
    - ⭐ **台股月營收可以提前預判全球產業循環**（台股是上游，上游一轉全球會跟）
    - ⭐ **這是 P0.5 + P5 Weekly 的優勢系統化**
- **功能**: 雙模式設計
  - **Mode 1: Baseline Builder（第一次跑）**
    - **核心問題**：世界實際長什麼樣？誰卡誰？
    - **本質角色**：結構翻譯器（把 P0 的抽象必然性，翻譯成「現實世界的結構圖」）
    - **輸入**：P0 的輸出（themes, subthemes, key_nodes）
    - **輸出**：`industry_chain_map_json`
      - 產業鏈地圖（上游/中游/下游）
      - 關鍵製程/關鍵模組識別
      - Bottleneck 識別
      - 定價權分析
      - 單點失效節點識別
      - 強化 P0 選出的產業在整個供應鏈中的關鍵不可替代性
    - **🚫 此階段沒有監控、沒有異常、沒有判斷轉折**
  
  - **Mode 2: Chain Dynamics Monitor（後續監控）** ⭐ V8.15 新增
    - **核心問題**：上中下游行為是否一致？
    - **核心哲學**：與其試圖用財務模型猜產業，不如直接觀察上中下游彼此的真實行為是否一致
    - **觸發條件**：P1 已建立公司池 + 月度/季度更新時
    - **輸入**：
      - P1 公司池（按上中下游分類）
      - P2 財務數據（⭐ **台股月度營收、美日股季度營收**，從權威網站收集）
    - **三階段推理流程**：
      1. **Step 1: 產業生態識別**（Mandatory）：識別核心驅動、時間延遲、最早反映段
      2. **Step 2: 上中下游行為抽象**：程式提供標準化數據（不判斷、不貼標籤）
      3. **Step 3: 一致性與異常推演**：AI 自行建模，解釋行為是否一致
    - **輸出**：`chain_dynamics_monitor_json`（⭐ 4 區結構）
      - **meta**：版本與範圍（可追溯、可升級）
      - **signals**：8 個核心信號（可計算/可比）
        - `demand_pull_downstream`：下游需求拉動
        - `capacity_build_upstream`：上游擴產/CapEx 動能（⭐ 台股月營收 + 季報 CapEx proxy）
        - `inventory_pressure_midstream`：中游庫存/交期壓力
        - `pricing_power_node`：瓶頸節點是否仍有訂價權
        - `order_visibility`：訂單能見度（RPO/合約負債/Backlog proxy）
        - `substitution_pressure`：替代/被替代壓力
        - `capex_mismatch_divergence`：⭐ **上游 vs 下游不同步異常偵測（王牌）**
        - `credit_stress_chain`：產業鏈信用壓力
      - **diagnosis**：受限輸出（固定框架）
        - `current_chain_state`：7 種固定狀態之一（ACCELERATING / HEALTHY_EXPANSION / LATE_TIGHTENING / INVENTORY_BUILD / DEMAND_SOFTENING / MIXED_SIGNALS / UNKNOWN）
        - `state_rationale`：只允許引用 signals，不得引入外部敘事（≤ 120 字）
        - `industry_ecology_profile`：AI 針對該產業生態自動產出
        - `anomalies`：異常分析（pattern_id、description、likely_explanations、what_to_watch_next）
      - **handoff**：給後續模組用的接口欄位（最重要）
        - `p0_7_evidence_pack`：給 P0.7 的證據包（不推論、只給證據）
        - `p1_inputs`：給 P1 的節點優先級和風險標記
        - `p2_inputs`：給 P2 的驗證重點
        - `p5_weekly_flags`：給 P5 Weekly 的風控旗標
- **AI 模型**: Claude o3（執行者）+ GPT-5.2（審查者）
- **職權邊界**：
  - ✅ 只畫地圖（Mode 1）、只做偵測與推演（Mode 2）
  - ❌ 不下投資結論
  - ❌ 不做時間定位裁決（禁止輸出 Early/Mid/Late，這是 P0.7 的職責）
  - ❌ 不進行長期前瞻敘事（這是 P0 的職責）
- **與 P0.7 的雙向接口** ⭐ V8.15 新增
  - **P0.5 → P0.7**：提供 `p0_7_evidence_pack`（證據包）
  - **P0.7 → P0.5**：回寫 `p0_7_time_window_constraints`（時間窗口約束）
    - P0.5 下一輪監控會更聚焦（例如：如果 P0.7 說 Late + 高轉折風險 → P0.5 會更聚焦在「庫存反轉」「訂價鬆動」「上游營收/CapEx轉折」）
- **設計原則** ⭐ V8.15 新增
  - **不寫死情境與產業生態**：讓 AI 根據產業生態自行建模，禁止 if-then 情境硬編碼
  - **固定輸出框架，但允許 AI 自動生成情境假說**
  - **輸出必須可追溯、可程式化**（不要寫散文，要結構化）

#### **P0.7: 系統動力學驗證**
- **檔案**: `19_P0_7_SYSTEM_DYNAMICS.js`
- **執行頻率**: 季度（與 P0 同步）
- **功能**: 敘事狀態分析、循環主導分析、時間定位分析、槓桿角色類型分析
- **AI 模型**: O3（執行者）+ Claude o3（審查者）
- **⭐ 重要**: 純學術硬底子分析，**不包含任何籌碼面分析**

---

### Phase 1-4：公司篩選與分析

#### **P1: 產業鏈公司定位與結構分級（Industry Chain Tiering）** ⭐ V8.14 更新
- **檔案**: `20_P1_COMPANY_POOL.js`
- **執行頻率**: 季度（與 P0/P0.5/P0.7 同步）
- **功能**: 產業鏈公司定位與結構分級
  - **模組定位**：P1 的任務不是選股、不是估值、不是財報分析。P1 的唯一任務是：在 P0 得出紅利產業下，把「會吃到紅利」與「會被擠壓」的公司全部拉進池子，並完成結構定位檢查與等級分級，作為 P2 的輸入。
  - **一句話**：P1 是產業戰場的兵力部署圖（Order of Battle），不是財務審查。
- **AI 模型**: ⭐ V8.14 更新為兩階段 + ⭐ V8.16 更新（Step1 移除審查者）
  - **Step 1（股票池生成）**: Gemini Flash 3.0（執行者）+ **無審查者**（純提取資料，無分析）⭐ V8.16 更新
  - **Step 2（結構分級）**: Gemini Pro 3.0（執行者）+ GPT-5.2（審查者）
- **⭐ V8.14 新增：兩階段執行模式（職責明確分工）**
  - **Step 1（資料蒐集階段 - Gemini Flash 3.0）**：
    - **職責**：僅做資料蒐集，不做任何分析
    - 根據 P0/P0.5/P0.7 找出所有相關公司（上游/中游/下游/互補性產業/受害性產業）
    - 產出 15-30 檔公司清單（美:台:日 = 5:3:2，建議比例，未來可透過 UI 調整）
    - 提供公司基本資訊（ticker, company_name, market）
    - **財報下載階段**（Step 1 完成後自動觸發）：
      - 美股：GAS 自動抓取最新三季財報（SEC API，10-K/10-Q）
      - 台股/日股：GAS 在 Google Drive 創建子資料夾，等待人工下載 PDF
      - 若有法說會逐字稿或年報也可一併抓取
    - **Flash 財報提取階段**（財報下載完成後自動觸發）：
      - 使用 Gemini Flash 3.0 閱讀財報（原封不動提取，禁止分析與計算）
      - 提取三個欄位：P1_Industry_Evidence、P2_Financial_Evidence、P3_Technical_Evidence
      - 每段必須附上財報年份、季度、頁數
      - 存入表格（Phase1_Company_Pool 的三個 JSON 欄位）
  - **Step 2（分析分級階段 - Gemini Pro 3.0）**：
    - **職責**：讀取 Flash 提取的資料，進行分析、定位、分級
    - 讀取 Flash 提取的 P1_Industry_Evidence、P2_Financial_Evidence、P3_Technical_Evidence
    - **審查者（GPT-5.2）也必須對照 Flash 提取的財報資料進行審查**：
      - 審查者必須使用 Flash 提取的資料驗證執行者的分析是否正確
      - 審查者必須檢查執行者的論述是否能從財報資料中找到支持證據
      - 審查者必須驗證 Tier 分級、產業鏈定位、受益/受害機制是否與財報資料一致
    - **產業鏈位置定位**：
      - 將公司排入產業鏈正確的上中下游/互補/替代位置
      - 對應到 P0.5 產業鏈地圖的具體節點
      - 剔除完全無關的公司並說明理由
    - **主動獵殺舊技術龍頭**：
      - 根據 P0 的技術替代路徑，主動搜尋「目前提供舊技術的主流公司」
      - 標記為 Tier X 候選
    - **結構分級**：
      - 按 Tier S/A/B/X 分級
      - 分析受益/受害機制
- **⭐ V8.14 新增：Tier 分級系統（取代三池分類）**
  - **Tier S**：核心瓶頸/不可取代（Kingmaker）
  - **Tier A**：高連動受益/次核心（Contender）
  - **Tier B**：順風受益/邊緣紅利（Beneficiary）
  - **Tier X**：結構性受害者（Victim/Squeezed）
- **⭐ V8.14 新增：繼承規則**
  - **必須繼承**：P0 + P0.5 + P0.7（不得自行推翻或另起敘事）
  - **禁止事項**：不得改寫 P0 主敘事、不得加入新宏觀論述
  - **唯一可新增**：公司與節點的映射、受益/受害機制、分級理由
- **⭐ V8.14 新增：禁止事項**
  - ❌ 禁止使用財務績效數據（EPS/成長率/毛利率數字）作為分級依據
  - ❌ 禁止使用估值（P/E、FPE、PEG）、技術分析、股價作為證據
  - ✅ 允許使用業務結構佔比（Revenue Exposure / Mix）判斷「純度」
- **⭐ V8.14 新增：財報下載與提取機制**
  - **財報下載**：
    - 🇺🇸 美股：GAS 自動抓取最新三季（SEC API，Ticker → CIK → 最新三筆 10-K/10-Q HTML）
      - 完全自動化，失敗標註 FAILED，繼續處理其他公司
    - 🇹🇼 台股：GAS 在 Google Drive 母資料夾創建子資料夾，等待人工下載 PDF
      - 資料夾路徑：`/Financial_Reports/台股/{Ticker}_{CompanyName}/`
      - 人工下載完成後透過 UI 回報，GAS 掃描 PDF 並上傳到 Gemini File API
    - 🇯🇵 日股：同台股流程
  - **Flash 三欄位提取**：
    - 使用 Gemini Flash 3.0（gemini-3-flash-preview）
    - **嚴格限制**：禁止分析、禁止計算、僅提取原文段落
    - **三欄位分離**：
      - **P1_Industry_Evidence**：Business Description、Revenue Mix、Supply Chain Role、Competition、R&D、Capacity
      - **P2_Financial_Evidence**：Profitability、Growth、Balance Sheet、Cash Flow、Guidance、Risk Factors
      - **P3_Technical_Evidence**：Shareholding Structure、Dilution、Capital Actions、Dividends Policy
    - **提取要求**：
      - 原封不動提取原文（不得改寫）
      - 每段必須附上頁數（Page Number）
      - 每段必須標註財報年份和季度
      - 保留上下文（前後 1-2 句）
      - 表格轉換為 Markdown 格式
    - **存儲**：存入 `Phase1_Company_Pool` 表格的三個 JSON 欄位
  - **缺失處理**：
    - 美股抓取失敗：標註 FAILED，繼續處理其他公司
    - 台股/日股資料夾缺失：UI 提醒，人工輸入「已補上」或「跳過」
  - **資料存儲**：
    - 三個 JSON 欄位存入 `Phase1_Company_Pool` 表格
    - 欄位名稱：`P1_Industry_Evidence_JSON`、`P2_Financial_Evidence_JSON`、`P3_Technical_Evidence_JSON`
    - 提取狀態欄位：`Financial_Report_Extraction_Status`（PENDING / EXTRACTED / FAILED）
  - **流程整合**：
    - Step 1 完成後自動觸發財報下載
    - 美股立即進行 Flash 提取並存儲
    - 台股/日股等待人工下載完成後，執行 `P1_ScanAndExtractDrivePDFs(jobId)` 進行掃描和提取
    - Step 2 執行前自動讀取 Flash 提取的資料並傳入 Prompt
- **⭐ 重要**: 只挑選符合 P0 結論的公司，**不包含任何籌碼面分析**

#### **P2: 基本面財務分析** ⭐ **同業比較與相對位置原則（兩階段流程）+ 雙 FPE 制度 + 三軸評級系統（Safety/Growth/Future）+ 雙軌制（CORE/FRONTIER）**
- **⭐ P2 內部拆分與下游介面**：P2 內部拆為 **P2-1（事實建模）** 與 **P2-2（因果推演）**；僅 P2-2 寫入對外暴露的 **Phase2_Output**；P3 及所有下游（含 Weekly）一律讀取 **Phase2_Output**，不讀 P2_1_FACT_MODEL。P2_1_FACT_MODEL 為內部中間表，不對外暴露。以下原則適用 P2 整體（含 P2-1/P2-2）；產出與介面分工詳見下「P2 工作拆分」。
- **檔案**: `21_P2_FUNDAMENTAL_ANALYSIS.js` ⭐ **已更新 Prompt 為同業比較原則，已實現兩階段流程，V8.14 新增成長性分析，V8.15 完整架構成長性分析系統**
- **執行頻率**: 
  - **月度**: P2_MONTHLY（針對所有 Master_Candidates）
  - **季度**: P2_QUARTERLY（更深入的分析）
- **功能**: Gate 檢查、分層決策、財務指標分析、同業比較、雙 FPE 制度、三軸評級系統（Safety/Growth Momentum/Future Breakout）、雙軌制（Track A: CORE vs Track B: FRONTIER）、交互矩陣（6類公司分類）
- **⭐ V8.15 核心原則**：
  - **安全性是投資的基礎**：股災來臨時的安全墊，防止爆雷
  - **成長性與未來潛力是獲利的最大關鍵**：股價看的是未來，現在再好也沒有用
  - **目標不是只找到巴菲特的可口可樂，而是找到下一個 TSLA/NVDA**
  - **安全性跟成長性缺一不可，他們兩個負責完全不同的面向**
- **⭐ V8.14 新增：P1 財報資料使用**
  - **資料來源**：使用 P1 階段由 Gemini Flash 3.0 提取的財報資料（P2_Financial_Evidence）作為輔助對照
  - **使用方式**：
    1. 對照驗證：將外部財務數據與財報原文對照，確保數據一致性
    2. 成長性分析：從財報原文中提取成長相關的證據（營收成長、訂單能見度、產能擴張等）
    3. 未來成長潛力分析：從財報原文中提取管理層指引、未來規劃、結構性支撐等證據
- **⭐ V8.15 完整架構：三軸評級系統（S/A/B/X）+ 雙軌制（CORE/FRONTIER）+ 交互矩陣（6類公司分類）**
  - **三軸評級系統**：
    - **Safety（安全性）**：不死的底盤（S/A/B/X）
      - S: 多數指標在同業前段（Top 25%）且 CFO 必須為正
      - A: 多數指標在同業中段（25%-75%）且核心指標良好
      - B: 多數指標在中段或後段，但尚可維持營運
      - X: 多數指標在後段或存在重大異質性風險
    - **Growth Momentum（成長動能持續性）**：短中期股價引擎（S/A/B/X）
      - S: Growth Quality Score ≥ 80 且 Growth Quality vs Peers = 前段
      - A: Growth Quality Score ≥ 60 且 Growth Quality vs Peers ≥ 中段
      - B: Growth Quality Score ≥ 40
      - X: Growth Quality Score < 40 或成長質量 = "靠借債成長/靠稀釋股權成長"
    - **Future Breakout（未來爆發潛力）**：5–10 倍的上限（S/A/B/X）
      - S: Future Potential Score ≥ 80 且 Inevitability ≥ 70 且 Executability ≥ 70
      - A: Future Potential Score ≥ 60 且 (Inevitability ≥ 60 或 Executability ≥ 60)
      - B: Future Potential Score ≥ 40
      - X: Future Potential Score < 40 或 Future Potential Grade = "BUBBLE_NARRATIVE"
  - **⭐ V8.15 新增：P2-4.5 成長性分析模組（Growth Quality）**
    - **目標**：判斷「現在的成長是不是健康的、可延續的？」
    - **核心思想**：不是單點數字（例如「營收 YoY 很高」），而是成長品質（可持續性、可複製性、可擴張性）
    - **分析維度**（基於同業比較與相對位置，程式可算）：
      - **Growth Rate（成長率趨勢）**：營收/毛利/營業利益/自由現金流（TTM + 最近三季趨勢），與同業比較
      - **Growth Consistency（成長一致性）**：最近 8–12 季中，正成長季度比例，或斜率穩定度
      - **Operating Leverage Proxy（營運槓桿代理）**：營收成長時，營業利益率是否同步改善（用趨勢方向/相關性）
      - **Cash Conversion（現金轉換率）**：FCF / Net Income 或 CFO / Net Income（避免「會計成長」）
    - **輸出**：Growth_Quality_Score (0-100) + Growth_Momentum_Grade (S/A/B/X) + 同業相對位置 + 1 句原因（AI 生成，但只能引用數據表）
  - **⭐ V8.15 新增：P2-4.6 未來成長潛力分析模組（Future Potential / Optionality）**
    - **目標**：判斷「未來飆升是『吹的泡泡』還是『高機率必然』？」
    - **核心思想**：證據型前瞻（Evidence-backed forward view），不是預測股價
    - **拆成兩個分數**：
      - **必然性（Inevitability Score, 0-100）**：如果產業大趨勢成立，這家公司吃到紅利的「結構必然」有多高？
        - 證據來源（必須引用 P0/P0.5/P0.7/P1 結論）：
          - P0 必然性支撐：產業是否在 P0 中被判定為「結構性必然」？
          - P0.5 產業鏈位置：該公司在產業鏈中的位置是否具有結構性優勢（瓶頸節點、定價權）？
          - P0.7 時間窗口：當前時間位置是否有利於該公司的成長（Early/Mid/Late）？
          - P1 Tier 分級：該公司是否被 P1 判定為 Tier S/A（結構性受益者）？
        - AI 任務：基於以上證據判斷必然性（0-100），必須附上證據來源
      - **可實現性（Executability Score, 0-100）**：它有沒有能力把故事做成現金流？（不是嘴巴講）
        - 證據來源（程式可算的 Proxy + P1 財報段落）：
          - **硬體/製造模板**：R&D 強度（R&D / Revenue）同業百分位、Capex 強度（Capex / Revenue）與折舊、擴產節奏（用趨勢）、存貨週轉、合約負債
          - **軟體/平台模板**：RPO / Remaining performance obligations、Deferred revenue（遞延收入）、毛利率趨勢、S&M/R&D 的效率（營收增長對應費用增長的斜率）、客戶數/ARPU/留存（如果有就用）
          - **指引與可驗證承諾**：從 P1 提取的財報 Business / Outlook 段落中，抓「產品/量產/時程/客戶類型」句子（只存引用，不做結論）
          - **需求可見度 proxy**：Backlog / RPO（如果該產業常見且數據源抓得到就算；抓不到就留空，不硬做）
          - **毛利結構趨勢**：毛利率是否能在擴張中維持/提升（同業相對 + 趨勢）
        - **重要**：沒數據時不計入權重，權重重新分配（不要用平均分）
        - AI 任務：基於以上數據判斷可實現性（0-100），必須附上證據指針（最多 5 條，可追溯到 P1 段落或數據表欄位）
    - **Future_Potential_Score 計算**：Future_Potential_Score = 0.5 × Inevitability_Score + 0.5 × Executability_Score
    - **Time Window Penalty（P0.7 窗口懲罰）**：
      - P0.7 Time Position = Late → Future Breakout Grade 最高為 A（不允許 S）
      - P0.7 Turning Point Risk = HIGH → Future Breakout Grade 最高為 A
      - P0.7 Time Position = Late 且 Turning Point Risk = HIGH → Future Breakout Grade 最高為 B
      - 這是輸出標記與分數 cap，不是交易決策
    - **驗證里程碑（Milestones to Verify）**：
      - Future Breakout = S/S+ 時，強制輸出「驗證里程碑」（最多 5 個）
      - 里程碑類型：量產時程、客戶類型、指標（RPO/backlog/CapEx/出貨指引）、競品狀態、P0.7 的窗口
      - 每個里程碑必須包含：target、verification_source、verification_method
  - **⭐ V8.15 新增：雙軌制（Track A: CORE/Quality vs Track B: FRONTIER/Optionality）**
    - **Track A: CORE / Quality（主倉候選）**：
      - 特徵：成熟/大型公司、安全 + 成長都強、適合重倉（CORE/STABLE_SWING）
      - 判斷：公司規模 = "龍頭" 或 "中大型" → track_type = "CORE"
    - **Track B: FRONTIER / Optionality（前沿噴發倉候選）**：
      - 特徵：新創/小型/研發前沿/敘事型、安全可能不足，但成長潛力極高
      - 判斷：公司規模 = "小型新創" 且 R&D_Intensity > 同業前段 且 Future_Potential_Score ≥ 70 且 Safety_PARTIAL 或以上 → track_type = "FRONTIER"
      - **Frontier 特殊驗證**：
        - **Runway（生存跑道）**：現金與等價物 / 現金消耗（每季 burn）→ 估算 runway（季度數）
          - Runway < 4 季 → Execution Risk = HIGH，Frontier Gate = FAIL（硬門檴）
          - Runway ≥ 4 季 → 允許進入 OPTIONALITY
        - **真成長 vs 假成長（測謊機）**：
          - 軟體/AI 產品型：RPO/遞延收入、客戶數/ARPU/留存、指引與上修頻率、Unit Economics Proxy（毛利率趨勢、S&M/R&D 效率）
          - 硬體/製造型：CapEx/存貨/合約負債、產能擴張計劃的具體性
        - **必然性來自 P0.7**：Window Fit: HIGH/MED/LOW + 理由（引用 P0.7）
    - **Gate 對 Frontier 的處理**：
      - Safety Gate FAIL 不應終止 Frontier（OPTIONALITY），改為自動標記 OPTIONALITY_ONLY
      - Frontier 允許 Safety = X，但必須 Runway ≥ 4 季
      - 輸出：gate_result_for_frontier = "OPTIONALITY_ONLY" + max_position_cap_suggestion + frontier_conditions
  - **⭐ V8.15 新增：交互矩陣（6類公司分類）**
    - **A 類：動能成長股（MOMENTUM_COMPOUNDER）**
      - Safety: S/A + Growth Momentum: S/A + Future Breakout: A/S
      - 定位：短中期就會跑，市場已開始認，賺錢的主力引擎
      - Position Role: MOMENTUM
      - Tier: CORE 或 STABLE_SWING
    - **B 類：鑽石早期（EARLY_DIAMOND / UNDERFOLLOWED）**
      - Safety: A/B + Growth Momentum: B + Future Breakout: S/A
      - 定位：市場還沒認，但「結構必然性」高，在市場發現前建底倉
      - Position Role: DIAMOND
      - Tier: CORE 或 AGGRESSIVE（取決於 P0.7 Time Position）
      - 必須有 milestones_to_verify
    - **C 類：前沿噴發倉（FRONTIER_OPTIONALITY / 10X_BETS）**
      - Safety: X/B + Growth Momentum: X/B + Future Breakout: S
      - 定位：追 5-10 倍的來源，但失敗率高
      - Position Role: OPTIONALITY
      - Tier: AGGRESSIVE 或 OPPORTUNISTIC（取決於風險）
      - 必須標記：OPTIONALITY_ONLY + max_position_cap_suggestion + milestones_to_verify + Runway ≥ 4 季
    - **D 類：成熟牛皮股（SAFE_BUT_STAGNANT / VALUE_TRAP）**
      - Safety: S/A + Growth Momentum: B/X + Future Breakout: B/X
      - 定位：不會死，但通常跑不動
      - Position Role: DEFENSIVE
      - Tier: OPPORTUNISTIC 或降級（不能佔用攻擊資本）
    - **E 類：高風險動能（HOT_BUT_FRAGILE / HYPE_BUBBLE）**
      - Safety: X/B + Growth Momentum: S/A + Future Breakout: X/B
      - 定位：最容易變成追高踩雷
      - Position Role: REJECT 或標記風險
      - Tier: 禁止進 CORE，需強制要求證據型催化或 P3 主力行為證明
    - **F 類：淘汰/觀察（REJECT / WATCHLIST）**
      - Growth Momentum: X 且 Future Breakout: X
      - 定位：故事股、純敘事、沒有實現性
      - Position Role: REJECT
      - 動作：不進入 Tier，標記為 WATCHLIST 或 REJECT
  - **⭐ V8.15 新增：最低必要證據欄位**
    - 每個 S/A/B/X 評級都必須附上「最低必要證據」
    - Safety Grade 證據：CFO、FCF、Net_Debt_EBITDA 等指標的具體數值、vs_peers、source
    - Growth Momentum Grade 證據：Revenue_YoY_Trend、Growth_Consistency、Operating_Leverage、Cash_Conversion 等
    - Future Breakout Grade 證據：Inevitability 證據（引用 P0/P0.5/P0.7/P1）、Executability 證據（引用數據或 P1 財報段落）
  - **⭐ V8.15 新增：P1 財報段落使用方式（符合「P2 權威數據源不變」原則）**
    - P2 仍以權威數據源（財報狗/buffet code）為主
    - P1 財報段落只做「佐證/對照」，不改變數據源權威性
    - **一致性檢查（Consistency Check）**：若數據顯示成長很強，但 Business 段落完全看不出主力產品/需求來源 → 標記「敘事與數據不一致（需要 Weekly 特別審）」
    - **證據指針（Evidence Pointer）**：P2 的 "Future Potential" 結論，必須附 1–3 句引用（P1 抽取的原文段落片段），避免 AI 自己幻想「未來會爆發」
- **⭐ 雙 FPE 制度（V6.0 原始設計，已修正）**：
  - **FPE_A**：基於公司財測/來期業績推導的 Forward P/E（FPE_A = 當前股價 / 公司財測/來期業績的 Forward EPS）
  - **FPE_B**：市場分析師共識的 Forward P/E，不準確數據，作用為「判斷市場溫度計」，必須要跟同業的數據做比較，判斷出是整個板塊市場情緒還是只有該公司被市場特別看待，其結論作為 FPE_A 的輔助資料或驗證資料使用
  - **定位**：FPE 在 P2 的安全性分析權重不高，更像是 P3 判斷股價是否便宜/合理/昂貴的因子之一，FPE A/B 都要繼承給 P3 作為綜合判斷調整 cat 使用
- **⭐ 核心原則（同業比較與相對位置）**：
  - **重點不是指標的絕對數值，而是跟同業比較**
  - **同業定義**：不是「同板塊」，而是「相同細分產業」，必須由 AI 交叉判定
  - **同業分類**：必須分開龍頭/中大型/小型新創來比較，禁止跨分類比較
  - **必須判斷公司在同業中的相對位置**（前段、中段、還是後段？）
  - **必須判斷在同一板塊裡，它是結構性優勢者，還是結構性弱者？**
  - **必須判斷財務特徵是否「不像這個板塊的正常公司」？**
  - **Gate 檢查應基於同業比較結果，而非絕對數值**
- **⭐ 兩階段執行流程**：
  - **Stage 1（AI 執行）**：
    * AI 識別目標公司的規模分類（龍頭/中大型/小型新創）
    * AI 找出 3-5 家同業公司（必須與目標公司屬於相同規模分類）
    * AI 同時提取目標公司和同業公司的財務指標
    * AI 輸出同業公司清單（包含規模分類和選擇理由）
  - **Stage 2（程式執行）**：
    * 程式優先從 Stage 1 的 AI 輸出中獲取同業財務指標
    * 程式計算目標公司在每個指標的相對位置（前段/中段/後段）
    * 程式判斷結構性優勢/弱勢
    * 程式判斷異質性風險
  - **實現函數**：
    * `collectPeerFinancialData()` - 收集同業財務數據
    * `calculateRelativePositions()` - 計算相對位置
    * `calculateOverallPosition()` - 計算整體相對位置
    * `judgeStructuralAdvantage()` - 判斷結構性優勢/弱勢
    * `judgeHeterogeneityRisk()` - 判斷異質性風險
- **⭐ 數據來源（白名單原則）**：
  - **財務數據**：使用白名單 CSE（P2_TAIWAN、INSTITUTIONAL_DATA、P2_JAPAN）
  - **同業數據**：**必須從相同白名單數據源抓取**（確保比較基準一致，偏移可以被抵消）
  - **所有數據都由程式從白名單數據源獲取，不讓 AI 模型自己去找**
- **AI 模型**: Claude Hermes 4（執行者）+ GPT-5.2（審查者）
- **⭐ V8.15 Gate 檢查調整（Safety 硬門檴 + Growth/Future 決定上限）**
  - **Safety 是硬門檴**：Safety_FAIL → 直接 FAIL（避免爆雷股）
  - **Safety_PASS 之後，才看**：
    - Growth_Quality_Score（當下動能品質）
    - Future_Potential_Score（未來上限與必然性）
  - **Gate 判定標準**：
    - **PASS**：Safety 前段 +（Growth 或 Future 其中一個在前段）+ 無重大異質性風險
    - **PARTIAL**：Safety OK，但 Growth/Future 都中段或證據不足
    - **FAIL**：Safety 後段或異質性風險高
  - **Frontier 特殊處理**：
    - Safety Gate FAIL 不應終止 Frontier（OPTIONALITY），改為自動標記 OPTIONALITY_ONLY
    - Frontier 允許 Safety = X，但必須 Runway ≥ 4 季（硬門檴）
    - 輸出：gate_result_for_frontier = "OPTIONALITY_ONLY" + max_position_cap_suggestion + frontier_conditions
- **⭐ V8.17.1 三軸評級分數增強（程式計算 + 硬風控）**
  - **Safety_Score 計算**：
    - 基於 Safety_Grade 轉換（S=95, A=80, B=60, X=40）⭐ **固定分數映射，不允許 AI 調整**
    - **Hint 機制**（AI 輸出，不影響分數，供下游使用）：
      - `safety_score_adjustment_hint: "UPPER" | "MID" | "LOWER"`
      - AI 可以在 evidence 中寫「偏上緣 / 偏下緣」，但 Safety_Score 本體固定
    - **硬風控 Caps**（程式寫死，不可被 AI 覆蓋）：
      - CFO < 0 → cap 到 59
      - Interest Coverage < 1.5 → cap 到 49（可選）
      - FRONTIER runway < 4 → cap 到 55（可選）
    - 記錄 `safety_caps_applied` 陣列
  - **Growth_Quality_Score 計算**：
    - 公式：`0.30 × growth_rate_score + 0.25 × growth_consistency_score + 0.20 × operating_leverage_score + 0.25 × cash_conversion_score`
    - **Validator**：
      - 範圍檢查：所有分項必須在 0-100（超出範圍自動 clamp）
      - 缺資料處理：至少 2 個分項可用即可計算（動態重分配權重）
      - 記錄 `validation_errors` 陣列
    - **硬標記**（供下游使用）：
      - `cash_conversion_score < 40 && growth_rate_score > 70` → 標 `GROWTH_LOW_QUALITY`
      - 方便後續週更策略降權、提高風控
    - **⭐ V8.26 C3 確認**：✅ **已完整實現**
      - **實現位置**：`src/21_P2_FUNDAMENTAL_ANALYSIS.js` 中的 `computeGrowthQualityScore()` 函數
      - **功能確認**：公式完整、Validator 完整、硬標記完整，無需修改
  - **Future_Potential_Score 計算**：
    - 公式：`0.5 × inevitability_score + 0.5 × executability_score`
    - **Evidence Validation**：
      - 檢查 `inevitability_evidence` 是否引用 P0/P0.5/P0.7/P1（至少 2 條）
      - Evidence 不足時自動降級 inevitability_score（>70 → 70）
    - **Executability Coverage**：
      - 計算可用 proxy 覆蓋率（rnd_intensity, capex_intensity, inventory_turnover, contract_liabilities, rpo, deferred_revenue, guidance_evidence）
      - Coverage < 0.4 → cap executability_score 到 65
    - **Frontier 安全鎖**：
      - Track_Type = FRONTIER 且 Runway < 4 → cap Future_Potential_Score 到 70
    - **防泡沫硬規則**（供下游使用）：
      - `inevitability_score >= 80 && executability_score <= 40` → 標 `NARRATIVE_HEAVY`
      - 防止「故事很大但實現性很低」的情況（只標記，不 cap 分數，保留 option value）
    - 記錄 `validation_errors` 和 `caps_applied` 陣列
  - **共用函數設計**：
    - `computeSafetyScore(gateResult, financialMetrics, ticker)` - 統一 Safety_Score 計算邏輯
    - `computeGrowthQualityScore(growthAnalysis, ticker)` - 統一 Growth_Quality_Score 計算邏輯
    - `computeFuturePotentialScore(futurePotentialAnalysis, financialMetrics, trackType, runwayQuarters, ticker)` - 統一 Future_Potential_Score 計算邏輯
    - `validateInevitabilityEvidence(futurePotentialAnalysis)` - 驗證 Inevitability Evidence
    - 兩個處理函數（`P2_ProcessBatchResults` 和 `generateP2Output`）都使用相同共用函數，確保計算一致性
- **⭐ V8.15 分層決策整合（基於三軸評級 + Position Role）**
  - **CORE**：
    - Safety: S/A + Growth Momentum: S/A + Future Breakout: A/S
    - Position Role: MOMENTUM 或 DIAMOND
    - Track Type: CORE
  - **STABLE_SWING**：
    - Safety: S/A + (Growth Momentum: A/B 或 Future Breakout: A)
    - Position Role: MOMENTUM
    - Track Type: CORE
  - **AGGRESSIVE**：
    - Safety: B 或以上 + Future Breakout: S/A（但 Growth Momentum 可能 B）
    - 或 Track Type: FRONTIER 且 Future Breakout = S
    - Position Role: DIAMOND 或 OPTIONALITY
  - **OPPORTUNISTIC**：
    - Safety: B/X + Future Breakout: B/X
    - 或 Position Role: DEFENSIVE（成熟牛皮股）
    - 或 Position Role: REJECT（故事股）
- **⭐ 重要**: 純基本面分析，**不包含任何籌碼面分析**

#### **P2.5: 機構級籌碼分析** ⭐ V7.1 新增 + **V8.40 定案**
- **⭐ V8.40 定位**：**大型機構級深層數據分析**；負責**大框架的月/季度級**機構數據蒐集與框架分析，作為**每月/季全部個股重跑世界觀的程序之一**。日度數據蒐集與週度分析由 P5 Daily / P5 Weekly 負責，P2.5 不重複日/週頻細部蒐集。
- **⭐ V8.40 數據引用原則**：P2.5 月/季全部個股重跑時，若需要的**機構級籌碼面數據已經是 P5 Daily 每日都在蒐集的**，則**直接引用 P5 資料、不需重蒐集**。同理：**已高頻率蒐集的資料，低頻率分析就可直接引用，不要重複工作**（例如 P6 已有 20 分鐘級監控，週/月分析時直接引用 P6 或 Daily 產出）。
- **檔案**: 
  - `21_P2_5_SMART_MONEY.js`（核心執行）
  - `21_P2_5_DATA.js`（數據收集）
  - `21_P2_5_PROMPT.js`（Prompt 構建）
  - `21_P2_5_ANALYSIS.js`（AI 分析結果處理）
  - `21_P2_5_SCORING.js`（評分計算）
  - `21_P2_5_SNAPSHOT.js`（快照管理）
- **執行頻率**: 
  - **月度**: P2.5_MONTHLY（與 P2_MONTHLY 同步）
  - **季度**: P2.5_QUARTERLY（與 P2_QUARTERLY 同步，包含 13F 分析）
- **功能**: 13F 機構持倉變化分析、內部人交易分析、期權活動分析、Dark Pool 活動分析、對沖基金 Clone 分析、計算 Smart_Money_Score
- **數據來源**: 從 P5 Daily 收集的 `SMART_MONEY_DAILY` 表格讀取；月/季重跑時若該類數據 P5 Daily 已在每日蒐集則**直接引用、不重蒐集**
- **AI 模型**: Claude Hermes 4（執行者）+ GPT-5.2（審查者）⭐ V8.16 補強配置
- **⭐ V8.16 模型配置補強**：
  - **配置位置**：`src/02_M0_CONFIG.js` 的 `TASK_TO_EXECUTOR` 和 `getAuditor()`
  - **P2_5_MONTHLY**: Claude Hermes 4（執行者）+ GPT-5.2（審查者）
  - **P2_5_QUARTERLY**: Claude Hermes 4（執行者）+ GPT-5.2（審查者）
- **⭐ 對沖基金 Clone 詳細實現（需補強）**：
  - 明確列出 Top 10 對沖基金清單（Berkshire Hathaway、Bridgewater Associates、Renaissance Technologies、Tiger Global、Coatue Management、D1 Capital Partners、Viking Global、Lone Pine Capital、Maverick Capital、Citadel）
  - 明確 Clone 評分邏輯：如果某檔股票出現在 >= 5 家 Top 基金的新增持倉 → 強力信號（聰明錢一致看多）
  - 實現 Clone 評分計算（基於 Top 10 對沖基金持倉）

#### P2 工作拆分（P2-1 事實建模 + P2-2 因果推演）⭐ V8.29 定案

- **拆分原則**：原 P2 拆為 P2-1（事實建模層）與 P2-2（因果推演層）；**原 P2 所有功能保留，不刪不減**。
- **P0/P1 產業邏輯卡鏈**：
  - **P0 結束後**：產出該產業的**生態系報告或產業邏輯卡**並入庫。
  - **P1 結束後**：產出該位階（上中下游/替代互補）的**生態系報告或產業邏輯卡**並入庫。
  - **P2-2 輸入**：必須讀取 P0/P1 邏輯卡作為前備知識；P2-2 內「Step 0 產業邏輯注入」可引用/擴充這些卡。
- **P2-1（事實建模層）**：
  - **模型**：DeepSeek V3 (671B) / Scout Llama 3.3 70B；無 Deep Auditor。
  - **任務**：財報表/註解/管理層說明的分類；安全性/成長性/潛力突破指標及指標內部初步解釋；**保持中性、不推論、不編敘事**；同業比較 Stage 1（AI 找同業）、財務數據抓取與一致性、Growth Quality、Safety Score、FPE A/B 計算、P1 財報段落抽取。**不判斷好壞，只產出分數**。
  - **產出寫入**：**中間表** `P2_1_FACT_MODEL`；不對外暴露 Phase2_Output。
- **P2-2（因果推演層）**：
  - **模型**：Hermes 4 / Scout o3 batch；分歧時 Deep Auditor o3。
  - **任務**：因果鏈統整、權重與主導變數、前瞻推演（Base/Bull/Bear 三路徑）、會計與財務工程拆彈、產業鏈與循環位置、產業邏輯卡（Step 0）、Mispricing Map；**Gate 決策整合、Track 判定、6 類公司分類、Milestones to Verify** 均在 P2-2 完成。
  - **產出寫入**：僅 P2-2 寫入對外暴露的 **Phase2_Output**。
  - **⭐ Safety Score 計算邏輯**（P2-2 核心評分）：
    - **Safety Grade 映射表**（固定，AI 不得調整）：
      - `S`（Kingmaker）→ Base Score **95**
      - `A`（Contender）→ Base Score **80**
      - `B`（Beneficiary）→ Base Score **60**
      - `X`（Victim）→ Base Score **40**
    - **Hard Caps**（程式強制，AI 無法繞過）：
      - CFO < 0 → cap 到 **59**
      - Interest Coverage < 1.5 → cap 到 **49**
      - FRONTIER Track 且 Runway < 4 季 → cap 到 **55**
    - **實作位置**（GAS 對照）：`gas_archive/src/21_P2_FUNDAMENTAL_ANALYSIS.js:578-633`（`computeSafetyScore` 函數）
- **實現注意**：Phase2_Output Schema 與下游讀取介面不變；P2-1 僅為內部中間表。**P3 及 Weekly 讀取時一律使用 Phase2_Output**（不讀 P2_1_FACT_MODEL）。
- **P2_1_FACT_MODEL 最小介面（Minimal Contract）** ⭐ **V8.42**：中間表僅規範工程可執行之最小必要欄位，細節留工程備忘錄。**最小必要欄位**（概念）：`snapshot_id`、`ticker`、`fact_type`、`fact_value`、`source`、`confidence`、`as_of_date`；P2-2 讀取來源為 P2_1_FACT_MODEL，欄位擴充與 ERD 見工程備忘錄。

#### **P3: 技術面分析與掛單價位設定** ⭐ **機構級預測視角 + ⭐ V8.17 Batch API 整合**
- **檔案**: 
  - `22_P3_CORE.js`（核心執行）
  - `22_P3_DATA_COLLECTOR.js`（數據收集）⭐ **已實現讀取歷史 OHLCV 數據**
  - `22_P3_AI_ANALYSIS.js`（AI 分析）⭐ **已更新 Prompt 為機構級預測視角**
  - `22_P3_SNAPSHOT.js`（快照管理）
  - `22_P3_TRIGGER.js`（觸發邏輯）
  - `22_P3_TRIGGERED_REVIEW.js`（觸發式審查）⭐ V8.16 新增
- **執行頻率**: 
  - **統一調度（優先）**: 由 P5 Weekly/Monthly 統一調度
    * 並行執行 P2 和 P2.5
    * 兩者都完成後才觸發 P3
    * 確保 P3 使用最新的 P2 + P2.5 數據
  - **自動觸發（備用）**: 當 P2/P2.5 有變動時（僅在非 Weekly/Monthly 時段）
  - **週度（定期）**: 由 P5 Weekly 觸發
    * ⭐ **V8.0 修正**：週度只處理有變動的股票（根據 P2/P2.5 快照變動檢測）
- **功能**: Cat 分類、Buy 價格計算、技術指標分析
- **⭐ 整合 P2.5 輸出**: Smart_Money_Score 影響 Cat 分類和 Buy 價格調整
- **⭐ 機構級預測視角**：
  - 以機構主力、大型對沖基金、高盛、摩根等大機構的視角來分析
  - 目標是「預測未來」，而不是套用公式
  - 必須包含「主力行為解釋」、「意圖判斷」、「未來預測」
  - 禁止輸出「根據 RSI、MACD、均線、支撐壓力」等程式就能算的結論
- **⭐ 數據來源（白名單原則）**：
  - **技術指標**：已由 P5 Daily 程式計算好，直接從 `MARKET_INDICATORS_DAILY` 讀取
  - **歷史 OHLCV 數據**：優先從 `MARKET_OHLCV_DAILY` 表格讀取（已持倉個股可以使用留存的資料），不足才從 stooq.com 補充（通過 Cloud Function 代理）
  - **P2 財務指標**：已由 P2 收集並分析完成，直接繼承使用，不需要重複搜尋與計算
  - **所有數據都由程式從白名單數據源獲取，不讓 AI 模型自己去找**
- **AI 模型**: Claude Hermes 4（執行者，**Batch API**）+ GPT-5.2（審查者，**觸發式審查**，只審 15-25%）⭐ V8.16 更新 + ⭐ V8.17 更新（Batch API）
- **⭐ V8.17 Batch API 整合**：
  - **預設使用 Batch**：P3 每檔股票獨立，適用 Batch API（50% 成本折扣）
  - **Batch 提交時機**：收集所有股票的請求後，統一提交到 Batch API
  - **Prompt Caching**：System blocks（Phase rules、評分標準、schema）使用 `cache_control: {type: "ephemeral"}`
  - **觸發時間**：週度執行時，收集所有需要處理的股票，一次性提交 Batch
- **⭐ V8.16 觸發式審查機制** ⏳
  - **設計目的**：降低成本，只對需要升級或疑似不一致的股票進行審查
  - **Hard Trigger（必審）**：任何一條成立 → 直接送 GPT-5.2 審查
    - **H1**: 輸出違反硬規則 / 不可交易狀態（Buy/Stop 層級邏輯錯、核心倉 < 50%、必要欄位缺失）
    - **H2**: Cat「跳級」變動（Cat4/Cat5 → Cat2/Cat3 或反向且伴隨異常）
    - **H3**: risk_overlay_level 跳升（0/1 → 3/4 或連續兩週上升）
    - **H4**: 產業/宏觀風險旗標硬碰硬衝突（P0.7=Late 或 turning_point_risk=HIGH 且 P3 給出 Cat2/Cat3）
    - **H5**: P0.5 產業鏈重大警報 + P3 卻偏進攻（DIVERGENCE_ALERT / INVENTORY_BUILD_WARNING / PRICING_LOOSENING 任一 true 且 P3 提高 Buy1 比例）
    - **H6**: P2/P2.5 結構性風險已亮紅燈（Narrative_Consistency_Check != 一致 或 P2.5 distribution_risk=HIGH / insider_selling_alert=true 但 P3 沒有提高 overlay）
    - **H7**: 本週發生「狀態翻轉事件」（財報週/重大法說/監管事件 或 單日 gap ≥ 6%）
    - **H8**: 「策略變更幅度過大」（本週 Buy1/Buy2/Buy3 任一價位相對上週變動 > 8% 或 stop 變動 > 5% 或 max cap 變動 > 30%）
  - **Soft Trigger（計分）**：累積分數 ≥ 閾值（建議 ≥ 6 分）→ 送審，穩定控制在 15-25%
    - **S1**: Cat 變動 1 級：+2
    - **S2**: risk_overlay_level 變動 ±1：+2；變動 ≥2：+4
    - **S3**: 近 5 交易日報酬絕對值 ≥ 8%：+2；≥12%：+3
    - **S4**: ATR%（或波動 proxy）較上週增加 ≥ 40%：+2
    - **S5**: 量能（20D avg volume）較上週 ≥ 1.8x：+2
    - **S6**: 新增「高嚴重度新聞標籤」≥ 1 則：+3
    - **S7**: 觸發 P2 的 milestones 到期但未驗證：+2
    - **S8**: P2.5 中等警報（MED）新增：+2
  - **實施要求**：在 `22_P3_CORE.js` 中實現 Hard Trigger 和 Soft Trigger 邏輯，只對觸發的股票執行審查
- **⭐ V8.15 待實現：風控覆蓋層（risk_overlay_level）** ✅ **已實現**
  - **新增概念**：保留 Cat（純技術），新增 `risk_overlay_level`（0/1/2/3）
    - 0：無風控覆蓋（正常）
    - 1：輕度保守（降低 Buy1/2 權重）
    - 2：中度保守（降低 Cat2/3 權重，提高 Buy3 權重）
    - 3：重度保守（禁止 Cat3，只允許 Cat1/2/4-A/4-B）
  - **計算邏輯**：由 P0.5 `p5_weekly_flags` + P0.7 決定 `risk_overlay_level`
    - `P0.7=Late` 或 `turning_point_risk=HIGH` → `risk_overlay_level = 3`（禁止 Cat3）
    - `DIVERGENCE_ALERT = true` 或 `INVENTORY_BUILD_WARNING = true` → `risk_overlay_level = 2`（Cat2/3 降檔）
    - `LATE_CYCLE_RISK = true` → `risk_overlay_level = 1`（輕度保守）
  - **實施要求**：P3 輸出新增 `risk_overlay_level` 欄位，根據 P0.7/P0.5 訊號計算
  - **Time_Window_Penalty 整合**：讀取 `Time_Window_Penalty_JSON.p3_impact`，調整 Buy 價格和 Stop 設定
  - **✅ 已實現**：`risk_overlay_level` 計算邏輯已實現（在 `22_P3_AI_ANALYSIS.js` 中，`calculateRiskOverlayLevel()` 函數）⭐ V8.17 確認
  - **✅ 已實現**：P3 輸出完整包含 `risk_overlay_level` 欄位（在 `22_P3_CORE.js` 中輸出）⭐ V8.17 確認
  - **✅ 已實現**：P4 已讀取 `risk_overlay_level`（在 `groupStocksByTierV8_15()` 中）⭐ V8.17 確認
  - **⭐ V8.18 新增：迴力鏢協議（Boomerang / Re-entry）** ✅ **已實現**
    - **資格檢查**：Cat ≠ PARABOLIC/LATE DISTRIBUTION，時間 < 5 trading days，量能放大或收盤站回關鍵結構位
    - **輸出欄位**：`re_entry_price` 和 `re_entry_qualification`
    - **實現位置**：`src/22_P3_AI_ANALYSIS.js` 中的 P3 Prompt 和輸出格式
    - **詳細設計**：請參考 `V8.18_系統增強實現計劃_2026-01-23.md`
  - **⭐ V8.18 新增：相對強度抗跌測試（Relative Strength Filter）** ✅ **已實現**
    - **計算方式**：RS = Stock % Change - Index % Change（由 P3 數據收集模組計算）
    - **輸出欄位**：`relative_strength_assessment`（market_context、stock_behavior、rs_value、interpretation、confidence）
    - **實現位置**：`src/22_P3_DATA_COLLECTOR.js`（計算 RS）和 `src/22_P3_AI_ANALYSIS.js`（評估抗跌性）
    - **詳細設計**：請參考 `V8.18_系統增強實現計劃_2026-01-23.md`
  - **⭐ 工程師修復：P3 週線數據缺失** ✅ **已修復**
    - **問題**：P3 Prompt 要求分析週線結構，但沒有提供週線 OHLCV 數據
    - **修復**：在 `src/22_P3_DATA_COLLECTOR.js` 中添加 `fetchWeeklyOHLCV()` 和 `aggregateDailyToWeekly()` 函數
  - **⭐ P3 週線數據來源**：可來自 **(1) 日線聚合（aggregateDailyToWeekly）** 或 **(2) 數據源直接提供之週線**（若有則可直接下載使用）。Prompt 中須明確標註 **[WEEKLY_CHART]** 與 **[DAILY_CHART]**。
    - **實現**：從日線數據聚合為週線數據（52 週），並在 `technicalData` 中添加 `weekly_ohlcv` 欄位
    - **Prompt 更新**：在 P3 Prompt 中明確要求使用 `weekly_ohlcv` 進行趨勢位階檢查
  - **⭐ 工程師修復：Cat 轉換規則（SSOT 層規則）** ✅ **已實現** + **⭐ V8.26 C4 修復**
    - **規則**：Cat 只能「往後走」，不能自由跳來跳去（例如：BASE → MOMENTUM → LATE 允許，LATE → MOMENTUM 禁止）
    - **Reset 條件**：允許反向轉換的情況（multi-week base rebuild、volume structure reset、system-level regime change）
    - **實現位置**：`src/22_P3_SNAPSHOT.js` 中的 `validateCatTransition()` 函數
    - **輸出**：在快照變動中標記 `transition_valid` 和 `transition_warning`
    - **⭐ V8.26 C4 修復**：
      - **問題**：`validateCatTransition` 函數存在但未被調用，導致 Cat 轉換違規無法被檢測。
      - **修復**：在 `compareWithPreviousSnapshotP3` 中添加 Cat 轉換驗證，違規時強制回退到上週的 Cat（防止 AI 亂跳），並記錄驗證警告到 changes 中。
      - **實現位置**：`src/22_P3_SNAPSHOT.js` 中的 `compareWithPreviousSnapshotP3` 函數。
  - **詳細設計**：請參考 `V8.15_P3-P6更新補充_SSOT.md` 和 `P3-P6更新建議報告_V8.15.md`

#### **P2: 基本面財務分析** ⭐ **同業比較與相對位置原則（兩階段流程）+ 雙 FPE 制度 + 三軸評級系統（Safety/Growth/Future）+ 雙軌制（CORE/FRONTIER）+ V8.18 營運槓桿拐點**
- **⭐ V8.18 新增：營運槓桿拐點觀測（Operating Leverage Inflection Scan）** ✅ **已實現**
  - **觀測任務**：檢查最近 2-4 季，營收是否持續成長 + R&D/SG&A/Opex Ratio 是否趨於持平或下降
  - **輸出欄位**：`operating_leverage_inflection`（present、evidence、confidence）
  - **實現位置**：`src/21_P2_FUNDAMENTAL_ANALYSIS.js` 中的 P2 Prompt
  - **重要原則**：這是觀測標籤，不是分數調整（分數交給程式與 P5，AI 只負責識別「拐點是否出現」）
  - **詳細設計**：請參考 `V8.18_系統增強實現計劃_2026-01-23.md`

##### **P2 Safety Score 完整公式** ⭐ V8.17.1 定案 + V8.44 補強

**Safety Grade → Base Score 映射**（程式固定，AI 不得修改）：

| Safety Grade | Base Score |
|--------------|------------|
| S | 95 |
| A | 80 |
| B | 60 |
| X | 40 |

**Hard Caps** ⭐（程式強制約束，AI 無法繞過）：

| 條件 | 上限 | 說明 |
|------|------|------|
| CFO < 0 | cap 59 | 營業現金流為負 → 安全分最高 59 |
| Interest Coverage < 1.5 | cap 49 | 利息覆蓋率過低 → 安全分最高 49 |
| FRONTIER + Runway < 4 | cap 55 | 新創公司資金跑道不足 → 安全分最高 55 |

**程式範例**（GAS 邏輯，Python 需保留）：

```python
def compute_safety_score(gate_result, financial_metrics, ticker):
    safety_grade = (gate_result.get('safety_grade') or 'X').upper()
    
    # Step 1: Grade → Base Score 映射（固定）
    grade_to_score = {'S': 95, 'A': 80, 'B': 60, 'X': 40}
    safety_score = grade_to_score.get(safety_grade, 40)
    
    # Step 2: Hard Caps（程式強制）
    cfo = financial_metrics.get('cfo_ttm') or financial_metrics.get('cash_flow_from_operations')
    if isinstance(cfo, (int, float)) and cfo < 0:
        safety_score = min(safety_score, 59)
    
    interest_coverage = financial_metrics.get('interest_coverage')
    if interest_coverage is not None and interest_coverage < 1.5:
        safety_score = min(safety_score, 49)
    
    track_type = gate_result.get('track_type') or ''
    runway_quarters = financial_metrics.get('runway_quarters')
    if track_type == 'FRONTIER' and runway_quarters is not None and runway_quarters < 4:
        safety_score = min(safety_score, 55)
    
    return safety_score
```

**GAS 實作位置**：`gas_archive/src/21_P2_FUNDAMENTAL_ANALYSIS.js` 中的 `computeSafetyScore` 函數

#### **P4: 資金分配分析設定** ⭐ **V6.3 定案 + V8.15 增強**
- **心法定位** ⭐ V8.29：P4 定位為「**約束範圍、風險下限**」；讓數學負責殘酷，AI 保持創造力；Portfolio Correlation Lock、Market Climate Override 等皆為程式邏輯。
- **檔案**: `10_P4_CALCULATOR.js`
- **⭐ V8.17 新增：P4 完成後自動觸發持股財報完整分析**：
  - **觸發時機**：P4 完成並保存快照後
  - **執行函數**：`HoldingsEarningsComplete_Analysis(tickers)`（在 `27_HOLDINGS_EARNINGS_COMPLETE.js` 中）
  - **功能**：一次完成過去五年歷史經驗生成 + 預估今年財報日期生成
  - **AI 模型**：Hermes 4（正式模式，Batch API）或 Gemini Flash 3.0（測試模式，同步 API）
  - **輸出**：更新 `EARNINGS_CALENDAR` 和 `EARNINGS_HISTORICAL_EXPERIENCE` 表格
- **執行頻率**: 
  - **自動觸發**: 當 P3 有變動時
  - **週度**: 由 P5 Weekly 觸發
- **功能**: 讀取 P2/P3 最新快照，計算理想配置（W_ideal）和實際應配置（W_now）
- **純計算模組**: 無 AI，純數學計算
- **⭐ Cat 權重矩陣（V6.3 定案，必須保留）**：
  - **Cat1**: { buy1: 0, buy2: 0, buy3: 0 } - 未啟動，不配置
  - **Cat2**: { buy1: 0.3, buy2: 0.5, buy3: 0.2 } - 啟動期，Buy2 為主
  - **Cat3**: { buy1: 0.5, buy2: 0.3, buy3: 0.2 } - 主升段，Buy1 為主
  - **Cat4-A**: { buy1: 0.2, buy2: 0.3, buy3: 0.5 } - 高位回調，Buy3 為主
  - **Cat4-B**: { buy1: 0, buy2: 0, buy3: 1.0 } - 深度回調，全 Buy3
  - **Cat5**: { buy1: 0, buy2: 0, buy3: 0 } - 趨勢破壞，清倉
- **⭐ U（利用率）配置（V6.3 定案）**：
  - 初始：60%
  - 最大：80%
  - 觸發條件：
    * BULL_CONFIRMED → 75%
    * STRONG_MOMENTUM → 80%
    * BEAR_SIGNAL → 40%
    * HIGH_RISK → 30%
- **⭐ V8.15 待實現：Tier 映射規則（Position_Role → Tier）** ✅ **已實現**
  - **映射表**：先用 `Position_Role` 決定預設 Tier，再由 P0.7 + P0.5 flags 做「降級/限額」
    - `MOMENTUM_COMPOUNDER` → `CORE`（但若 P0.7/P0.5 風險訊號 → `STABLE_SWING`）
    - `EARLY_DIAMOND` → `AGGRESSIVE`（但若 P0.7=Late → `OPPORTUNISTIC`）
    - `FRONTIER_OPTIONALITY` → `OPPORTUNISTIC`（必須標記 `OPTIONALITY_ONLY=true`）
    - `SAFE_BUT_STAGNANT` → `DEFENSIVE`（或降級到 `OPPORTUNISTIC`）
    - `HOT_BUT_FRAGILE` → `REJECT`（禁止進 `CORE`）
  - **Cat 權重矩陣調整**：兩層修正
    - **(A) 角色倍率**：`MOMENTUM_COMPOUNDER`（Cat2/3 ×1.2）、`EARLY_DIAMOND`（Cat1/2 ×1.2）、`FRONTIER_OPTIONALITY`（Cat3 ×0.5）、`SAFE_BUT_STAGNANT`（Cat4A ×1.2）、`HOT_BUT_FRAGILE`（Cat2/3 ×0.5）
    - **(B) 風控降檔**：P0.7=Late 或 `turning_point_risk=HIGH` → 禁止 Cat3；`DIVERGENCE_ALERT` 或 `INVENTORY_BUILD_WARNING` → Cat2/3 降 1 檔
  - **U（利用率）優先級排序**：P0.7（系統級）> P0.5（產業級）> P2（個股級）> P3（技術狀態）
    - P0.7 決定全系統 U 上限（例如 Late + High turning point → U = 50%）
    - P0.5 只壓該產業的 U 或該產業所有股票的加碼權重
    - P2 決定同一個 U 上限下「誰吃到更多份額」
    - P3 決定「進出場節奏/掛單位置」
  - **FRONTIER Runway 硬門檴處理**：兩段式處理
    - `Runway < 4` 且 `Safety=X` → 禁止加碼 + 進入退出程序（Exit Plan），允許「極小觀察倉」只有在 `milestones_to_verify` 明確且落在 1–2 季內
    - `Runway < 4` 但 `Safety=B` → 可保留小倉觀察，但上限降到 `OPPORTUNISTIC` cap（例如 0.5%–1%）
  - **Time_Window_Penalty 整合**：讀取 `Time_Window_Penalty_JSON.p4_impact`，調整 Buy2/Buy3 配比、減少加碼頻率、Sell1/Sell2 提前、追蹤停利更緊
  - **✅ 已實現**：`groupStocksByTierV8_15()`、`mapPositionRoleToTier()`、`applyTierDowngrade()` 函數已實現（在 `10_P4_CALCULATOR.js` 中）⭐ V8.17 確認
  - **✅ 已實現**：FRONTIER Runway 硬門檴處理（`applyFrontierRunwayGate()` 函數已實現）⭐ V8.17 確認
  - **✅ 已實現**：Cat 權重兩層修正（`calculateTierAllocationsV8_15()` 中實現 `getRoleMultiplier()` 和 `applyRiskControlDowngrade()`）⭐ V8.17 確認
  - **✅ 已實現**：U 優先級排序（`getCurrentUV8_15()` 中實現 P0.7 > P0.5 > P2 > P3 優先級）⭐ V8.17 確認
  - **✅ 已實現**：Time_Window_Penalty 整合（`applyTimeWindowPenalty()` 中實現，調整 Buy 價格和 Stop 設定）⭐ V8.17 確認
  - **⭐ V8.18 新增：Portfolio Correlation Lock（板塊曝險上限檢查）** ✅ **已實現** + **⭐ V8.42 板塊定義一致性**
    - **硬規則**：單一細分產業總持倉不得超過 30-40%（保守 35%，積極 40%）
    - **超標處理**：優先選最強的（highest score / strongest structure），其餘縮倉或不買
    - **實現位置**：`src/10_P4_CALCULATOR.js` 中的 `applyPortfolioCorrelationLock()` 函數
    - **數據來源**：從 `Phase1_Company_Pool` 讀取 `Subtheme_ID`（細分產業）
    - **板塊定義一致性**：板塊（細分產業）**單一來源**為 P0 產出之 subthemes（subtheme_id）；P1 之 Subtheme_ID 須與 P0 一致；P4 讀取之 Subtheme_ID 來自 Phase1_Company_Pool，與 P0/P1 同源。若 P0 季度更新導致 subtheme_id 變更，須有**版本化與 migration/mapping 表**，以可追溯、不砍歷史。
    - **⭐ 工程師修復：明確優先序（SSOT 層規則）** ✅ **已增強**
      - **優先序**：1. Tier S > Tier A（CORE > STABLE_SWING > AGGRESSIVE > OPPORTUNISTIC）
      - **優先序**：2. Higher RS > Lower RS（從 P3 讀取 `relative_strength_assessment.rs_value`）
      - **優先序**：3. Lower volatility > Higher volatility（從 P3 讀取 ATR 或 volatility）
      - **優先序**：4. Existing position > New position（從 P4 快照讀取 `current_position`）
      - **實現位置**：`src/10_P4_CALCULATOR.js` 中的 `applyPortfolioCorrelationLock()` 排序邏輯
    - **詳細設計**：請參考 `V8.18_系統增強實現計劃_2026-01-23.md`
  - **詳細設計**：請參考 `V8.15_P3-P6更新補充_SSOT.md` 和 `P3-P6更新建議報告_V8.15.md`

#### **P4.5: 動態對沖系統**
- **檔案**: `11_P4_5_DYNAMIC_HEDGING.js`
- **功能**: 動態對沖策略調整

#### **P4.6: 緊急撤退協議** ⭐ V8.0 完全移除（已統整到 P6）
- **⭐ V8.0 變更**：P4.6 所有功能已完全搬移到 P6
- **原有功能**：緊急撤退協議執行（所有功能）
- **搬移後**：
  - **盤中緊急撤退**：由 P6 負責（盤中執行，Rule-Based）
  - **日結後戰略評估**：由 P5 Weekly 負責（整合到 P5 Weekly 策略制定中，AI 分析）
- **檔案**：`12_P4_6_EMERGENCY_EXIT.js` 已廢棄，相關功能移至 `28_P6_EMERGENCY_EXIT.js`

---

### Phase 5：數據監控與策略制定（最大最重要）

#### **P5 Daily: 數據監控**（每日執行）

##### P5 Daily 工作拆分（D-1～D-4 四模型）⭐ V8.29 定案 + V8.30 論壇併入 D-1 + **嚴格分隔原則**

- **D-1（grok 4.1 fast）**：使用**同一模型**，但**權威網站新聞**與**散戶論壇討論**必須**嚴格分隔、絕不互相汙染**。實作上以**分開 Prompt、分開呼叫**保證乾淨：
  - **D-1A（新聞管線）**：
    - **輸入**：僅權威網站新聞（白名單 CSE、機構評級等）；**禁止**混入任何論壇內容。
    - **Prompt**：新聞專用 Prompt（如 `buildD1_NewsPrompt` 或等效）；**禁止**在 system/user 中出現論壇語意或論壇輸出 schema。
    - **輸出**：僅寫入新聞相關表（如 `NEWS_ATOMS_DAILY`、`STOCK_NEWS_INDEX_DAILY` 等）；**禁止**寫入 `WEB_SENTIMENT_DAILY`。
    - **任務**：清洗、雜訊過濾、多語去重、提取核心資訊、標準化格式；分類為**多維度標籤**（事件屬性、影響層級、情緒極性、關聯股票）與**宏觀 10–12 類**對接、個股數據與相關新聞。
  - **D-1B（論壇管線）**：
    - **輸入**：僅散戶論壇討論文（每日固定搜尋之論壇白名單）；**禁止**混入任何權威新聞內容。
    - **Prompt**：論壇專用 Prompt（如 `buildD1_ForumPrompt` 或等效）；**禁止**在 system/user 中出現新聞語意或新聞輸出 schema。
    - **輸出**：僅寫入網路熱度表（如 `WEB_SENTIMENT_DAILY`）；**禁止**寫入新聞相關表。
    - **任務**：與 D-1A 後續處理方式一致—**內容清洗、多語去重、宏觀資訊分類**（分類時**須分開欄位註明來源為 D-1A 或 D-1B**，見下「D-1A 與 D-1B 全程分離原則」）；另含判讀、分析討論內容、判讀**網路散戶溫度計**、連結相關**個股索引**或**宏觀索引**。grok 使用 **X 資料訓練**，最適合判讀散戶語言。
  - **分隔鐵則**：**兩次獨立 API 呼叫**（不共用 context、不共用同一 batch）；不同輸入、不同 Prompt、不同輸出表；權威新聞與散戶論壇**絕對不能互相汙染**。**無 Scout/Deep Auditor**。
  - **⭐ V8.43 D-1A 與 D-1B 全程分離原則**：從**蒐集、整理、分類、紀錄到分析**，兩來源（權威新聞 vs 散戶論壇）**均須分欄或標註來源**，不得互相汙染或混淆。**(1) 分類**：宏觀資訊分類須**分開欄位**註明來源為 **D-1A（權威新聞）** 或 **D-1B（散戶論壇）**。**(2) D-2 建立索引**：須**分開欄位**標註資料源為 D-1A 或 D-1B，下游依欄位區分權威新聞與散戶論壇。**(3) D-3／D-4 紀錄連結統整快照**：須清楚**分開並註明**「權威新聞統整」與「散戶論壇統整」（分欄或標籤），不得混用或混淆。
- **D-2（DeepSeek V3 671B）**：判斷新聞關聯個股，建立新聞↔個股連接索引（非關鍵字，判斷產業面影響→持股關聯性）；範圍為 P4 跑完後的「購買清單」+「追蹤清單」。**⭐ V8.43**：建立索引時**須分開欄位**標註資料源為 **D-1A（權威新聞）** 或 **D-1B（散戶論壇）**，不得混欄或混淆；下游 D-3／D-4 依此欄位區分權威新聞與散戶論壇。**無 Scout/Deep Auditor**。
- **D-3（Llama 3.3 70B）** ⭐ **V8.40 定案 + V8.42 數據流釐清 + V8.43 來源分欄**：**個股專屬的全方位資訊紀錄統整師**。產出**每檔個股當天更新「當天最新 + 歷史（前三天）關聯連結」的快照**，統整該個股**全部資訊**：新聞+論壇事件集、現股狀態、衍生品狀態等；等於是該個股專屬的**全方位資訊紀錄統整**。**執行時點**：收盤後（依 Daily 流程，例如收盤後 30 分鐘內）。**輸入**：① D2 給的當日個股新聞索引（**須區分權威新聞與散戶論壇欄位**） ② **當日個股 OHLCV**：來自 **Daily OHLCV 蒐集**（收盤後寫入 `MARKET_OHLCV_DAILY`），**非** P6 盤中即時價；③ **P6 對 D-3 的輸入**：僅 P6 標記為「**需保留**」的**盤中異常事件**（可寫入 `P6_INTRADAY_ALERTS_DAILY` 或等效），供 D-3 統整當天最新+前三天時一併引用；④ D3 自蒐的個股衍生性商品資訊與歷史事件集。**產出**：每天這檔股票**最新的狀態報告**，可提到哪些數據有**明顯變化/異常/延續/轉折**等；**不負責分析個股漲跌或策略制定**。**⭐ V8.43**：紀錄連結統整快照時**須分開註明**「**權威新聞統整**」與「**散戶論壇統整**」（分欄或標籤），不得互相汙染或混淆。D-3 內既有**程式計算**（如衍生品期權等指標），也有**AI 統整**各指標對應的意義；須遵守史官鐵律。**無 Scout/Deep Auditor**。
- **D-4（Hermes 4）** ⭐ **V8.40 定案 + V8.43 來源分欄**：綜合當日**宏觀現貨與衍生品數據**與新聞，產出每日宏觀世界觀；須納入討論串中**所有的衍生性以及宏觀指標**，且**個股與宏觀 10–12 大類分清楚**（個股由 D-3 負責，宏觀由 D-4 負責）。**產出當日現狀概念快照前須先讀取前三天歷史快照**，再銜接產出。除整合的「目前金融市場與宏觀」總覽外，**各宏觀子世界**（10–12 類：利率與流動性、美元與全球資金、股權、貴金屬、能源、工業商品、信用與違約、衍生品結構、政策與制度、市場情緒與敘事、可選系統性風險）須依各自數據產出**當日敘事快照**，並與歷史快照銜接（Narrative_Snapshot_Day_T 串接 T-1），供各分析工作引用。**⭐ V8.43**：納入新聞或論壇相關敘事時**須分開欄位或註明**為「**權威新聞統整**」或「**散戶論壇統整**」，不得混淆。**無 Scout/Deep Auditor**。**須遵守下條「史官鐵律」**。
- **Daily 史官鐵律（Archivist Non-Rewrite Rule）** ⭐ **V8.31 定案**：Daily 定位為「**史官層 / Log Layer**」—僅記錄與連接，世界框架與策略屬 Weekly。**D-3 / D-4 不可違反**：Daily 模組（D-3、D-4）**不得改寫歷史事件內容**，只能**追加** delta、link、tag、branch，且**必須保留舊 evidence**。**不允許**：總結重寫、覆蓋舊摘要、刪除舊事件。此規則避免未來有人「優化」時改壞記錄層，導致歷史可追溯性與驗證鏈斷裂。
- **⭐ V8.40 Daily 最高目標**：Daily（D3/D4）的任務是建立「**可被 Weekly 解讀的時間連續世界模型**」；沒有連續性，就沒有預測。**注意**：不要寫死成「不分析」— Daily **仍要連接歷史數據、判斷今天的數據變動狀態以及怎麼去統整摘要**（例如 D-3 產出狀態報告、標註變化/異常/延續/轉折）；只是**不負責分析個股漲跌或策略制定**，該屬 Weekly 與決策系統。
- **⭐ V8.40 快照交付**：**所有 Daily 產出的快照**（個股當日快照、各宏觀子世界快照、總世界觀快照）**須交給後續的決策系統與動態學習系統**，供 Weekly、WB-1/WB-2、Learning 等引用。
- **⭐ 世界觀重建與 Daily 的區分**：D-4 產出的「每日宏觀世界觀」為 **append-only** 的事件／敘事流，不覆寫歷史。WB-1 的「世界觀統整」是**讀取** Daily 累積輸出後，產出**當週**世界觀快照。「世界觀重建」指 W-A 替換的是**週級** NEW_WORLDVIEW_FRAMEWORK，**不改寫** Daily 歷史；週級世界觀版本由版本化快照管理。
- **⭐ 歷史與現狀銜接原則**（適用所有此類紀錄或統整分析）：凡產出「歷史與現狀銜接」的紀錄或統整分析，須在產出當日／當次快照**前**先讀取前數日（建議至少**前三日**）歷史快照，再銜接產出，使紀錄如同**同一觀察者連續撰寫**，避免前後日紀錄斷裂或人格分裂。D-4、WB-1 及所有需與歷史銜接的模組皆須遵守。
- **與 D-1（新聞／宏觀）關係**：Daily 新聞原子化/去重/分類對應 D-1；D-2～D-4 為新增或重組之分工，實作時與既有 Daily 流程整合。

##### **P5 Daily 輸入總覽** ⭐ **新聞 / 宏觀 / 網路熱度 三類**

- **第一類：新聞**（白名單 CSE、機構評級）：見下「Daily 新聞與宏觀數據（D-1 對應）」。
- **第二類：宏觀數據**（GOOGLEFINANCE 等）：見下「Daily 新聞與宏觀數據」「Daily OHLCV 蒐集」。
- **第三類：網路文章與討論（網路熱度）** ⭐ **V8.30 新增**：見下「P5 Daily 網路文章與討論類別」。

##### P5 Daily 網路文章與討論類別（第三類輸入）⭐ V8.30 新增

- **定位**：在「新聞／宏觀」以外，新增**網路熱度**作為 Daily 的第三類輸入；供決策參考、市場對照、動態學習之**散戶溫度因子**。使用上**僅作研究散戶追逐趨勢與參考**；在 ETF 盛行的年代，對小型尤其新創敘事股為值得參考的指標；**絕對權重遠低於系統本身與機構／主力預測的結論**。
- **輸入來源一：使用者不定期貼文**
  - **行為**：使用者看到網路上產業討論、公司討論、股價討論等文章時，可將內容複製貼上至系統（之後在 UI 介面上實現）。
  - **系統職責**：
    1. **判讀真偽與邏輯**：AI 判斷內容是否可信、邏輯是否一致、是否有明顯錯誤或操縱敘事。
    2. **抽取真相與有價值的部分**：提取經判讀確認**真實且有價值**的內容。
    3. **連接個股索引**：將可留存內容與個股建立關聯，寫入個股新聞/討論索引或專用表。
    4. **納入參考因子**：僅**已判讀確認真實與有價值**的內容，方可納入個股或世界觀的參考因子；未通過判讀者不寫入決策用表。
  - **實現**：輸入介面（UI）待實現；後端需提供「接收使用者貼文 → AI 判讀與抽取 → 寫入索引/因子表」的流程（可沿用或擴充 Daily 新聞原子化／驗證管線）。
- **輸入來源二：每日固定論壇搜尋（系統化網路溫度）**
  - **行為**：每天固定搜尋數個中／英／日**散戶集中的知名投資論壇**的討論文；**清洗、判讀、多語去重、分析討論內容、判讀網路散戶溫度計、連結相關個股索引或宏觀索引**等作業由 **D-1B（論壇管線）** 處理，模型同為 grok 4.1 fast，但**與 D-1A（新聞管線）分開 Prompt、分開呼叫**，絕不混用輸入或輸出，保證權威新聞與散戶論壇**嚴格分隔、不互相汙染**（grok 使用 X 資料訓練，最適合判讀散戶語言）。
  - **用途**：納入「新聞／宏觀」以外的**第三類：網路熱度**，作為決策參考、市場對照、動態學習的散戶溫度因子之一。
  - **權重與使用原則**：
    - **絕對權重遠低於**：本系統 P0～P5 結論、機構數據（P2.5）、主力/技術結論（P3）。
    - 僅作**研究散戶追逐趨勢與參考**，不用於取代或覆寫機構／主力預測。
  - **⭐ V8.43 D-1B 論壇白名單 V1（2026-02-03）**：實作須使用白名單，禁止開放式爬蟲；可依此擴充，須維持白名單制。
    - **英文論壇（美股）**：Reddit r/wallstreetbets、Reddit r/stocks、StockTwits、SeekingAlpha Comments（評論區）。
    - **中文論壇（台股）**：PTT Stock 板、Mobile01 投資理財、理財寶社群（cmoney.tw）。
    - **日文論壇（日股）**：5ch（原 2ch）市況板、Yahoo! ファイナンス掲示板、みんなの株式（minkabu.jp）。
    - **搜尋策略**：每個論壇每日最多抓取 50 則熱門討論；過濾條件：回文數 > 10、發文時間 < 24 小時；總量控制：每日論壇數據 < 300 則（避免淹沒）。具體 URL 與實作對照見工程備忘錄或配置表。
  - **輸出與下游**：
  - **使用者貼文**：判讀結果 + 抽取之「真實且有價值」內容 → 寫入個股索引或專用表（如 `USER_PASTE_VERIFIED_DAILY` 或併入 `STOCK_NEWS_INDEX_DAILY` 並標記來源為 USER_PASTE）；可納入個股或世界觀參考因子（僅通過判讀者）。
  - **論壇熱度**：每日論壇討論經 **D-1B（論壇管線，grok 4.1 fast，獨立 Prompt 獨立呼叫）** 清洗／判讀／去重／分析／散戶溫度計／索引連結後 → 僅寫入**網路熱度表**（如 `WEB_SENTIMENT_DAILY`）；**須分開欄位註明來源為 D-1B（散戶論壇）**；Weekly 讀取時作為**散戶溫度因子**（低權重），與新聞索引、宏觀數據並列。
- **數據源原則**：使用者貼文為使用者提供，不經白名單搜尋；論壇搜尋需使用**論壇白名單**（見上 D-1B 論壇白名單 V1），禁止開放式爬蟲以免汙染與法律風險。

##### **Daily 新聞與宏觀數據（D-1 對應）：新聞多維度標籤與宏觀 10–12 類蒐集 + 重要財經判斷數據 + 機構評級資料庫** ⭐ **白名單數據源 + GOOGLEFINANCE + V8.9 新增 + V8.12 多維度標籤 + V8.40 宏觀 10–12 類**
- **檔案**: 
  - `24_P5_DAILY_NEWS.js`（新聞原子化）
  - `24_P5_DAILY_MACRO.js`（宏觀數據：油價、貴金屬、匯率、國債利率、VIX）
  - `24_P5_DAILY_INSTITUTIONAL_RATINGS.js`（機構評級資料收集，V8.9 新增）⭐
- **功能**: 多語新聞收集、新聞原子化、多語審查去重 + 分類、**簡單留存每日世界觀快照**、宏觀數據收集、**機構評級資料收集（V8.9 新增）**
- **⭐ V8.0 修正**：
  - Daily 只做簡單快照留存（使用 GEMINI_PRO），不進行推理分析
  - 整週的快照連貫性動態分析是 Weekly 的工作
  - 移除 GPT-5.2 的深度分析功能（關聯性分析、世界觀更新等）
- **⭐ V8.9 新增：機構評級獨立資料庫**：
  - **定位**：⚠️ 「帶風向面」的資料，用於事後驗證指標（非預先判斷）
  - **獨立資料庫**：`INSTITUTIONAL_RATINGS_DAILY`（獨立於 `NEWS_ATOMS_DAILY`）
  - **收集範圍**：只收錄有持股的歷史評級（從 `Phase1_Master_Candidates` 或 `Phase2_Output` 讀取）
  - **追蹤機構**：每個市場只追蹤五間以內龍頭機構
    * **美股**：Goldman Sachs, Morgan Stanley, JPMorgan, Citi, Bank of America/Barclays
    * **台股**：Morgan Stanley, JPMorgan, Goldman Sachs, Nomura, CLSA/Macquarie/UBS
    * **日股**：Nomura, Daiwa, SMBC Nikko, Goldman Sachs Japan, Mizuho/Jefferies
  - **數據來源**：專屬 CSE `P5_INSTITUTIONAL_RATINGS`（白名單：The Fly, StreetInsider, Benzinga, TipRanks, 鉅亨網, 經濟日報, 工商時報, Minkabu, Kabutan, Traders Web）
  - **標準化**：機構名稱標準化、評級動作標準化（多語支持）
  - **⭐ V8.9 更新（2026-01-18）：AI 處理流程（與一般新聞一致）**：
    * **Gemini Flash 原子化清洗**：雜訊過濾（廣告、社論、非正式新聞）、提取核心資訊、標準化格式
    * **Gemini Pro 多語去重**：識別同一機構評級事件的不同語言版本（例如：「高盛調升 AAPL 目標價至 $200」vs「Goldman Sachs raises AAPL target price to $200」），只保留一條（優先英文版本）

##### **⭐ V8.12 更新（2026-01-19）：新聞系統戰略升級**

**核心變更**：
1. **新聞收集方式修正**：從關鍵字搜尋 → 直接CSE搜尋（由CSE後臺白名單限制）
2. **多維度標籤系統**：從平面分類 → 多維度標籤系統（事件屬性、影響層級、情緒極性、關聯股票代碼）
3. **個股新聞索引**：新增反向索引（Inverted Index），讓Weekly可以用「股票代碼」反查所有相關新聞
4. **新聞驗證機制**：新增三層驗證（時效性、語意健檢、數據驗證、Proxy驗證）
5. **Daily DB擴充**：一次性擴充所有Tier 1 + Tier 2數據（用於新聞驗證）

**詳細說明**：

**1. 新聞收集方式修正（Phase 1）**
- **修改前**：使用關鍵字搜尋（"financial news today"）會遺漏非關鍵字新聞
- **修改後**：
  - 移除關鍵字搜尋，改為直接CSE搜尋（使用日期查詢）
  - 由CSE後臺白名單限制網站範圍，程式碼不加任何限制語句
  - 程式責任：判斷日期是當日最新（±6小時）
  - Flash清洗責任：洗掉雜訊 + 篩選出"當日"的"新聞"（不能是好幾天前發布的，不能是廣告或論壇）
- **實施檔案**：`24_P5_DAILY_NEWS.js` 的 `collectRawNews()` 和 `atomizeNewsWithGeminiFlash()`

**2. 多維度標籤系統（Phase 2）** ⭐ **V8.17 更新：新增財報日期檢測分類**
- **修改前**：只有「十大類」平面分類
- **修改後**：
  - **⭐ V8.17 新增：財報日期檢測分類（`Earnings_Date_Announcement`）**：
    - Flash 清洗時自動分類為 `Earnings_Date_Announcement`（財報日期公告）或 `Earnings_Result`（財報實際公布）
    - 自動提取 `earnings_date_info`（包含 ticker, quarter, earnings_date, announcement_date, confidence）
    - 用於 `27_HOLDINGS_EARNINGS_NEWS_UPDATER.js` 自動更新持股財報行事曆
    - **不再使用關鍵字檢測**：改為使用 AI 分類結果，提高準確性和完整性
  - **維度一：事件屬性 (Event Type)**：宏觀與政策、企業基本面、資金與籌碼、市場結構、專項追蹤、原物料與匯率
  - **維度二：影響層級 (Impact Scope)**：GLOBAL（影響全市場）、SECTOR（影響單一產業）、STOCK（僅影響單一公司）
  - **維度三：情緒極性 (Sentiment Polarity)**：VERY_BULLISH、SLIGHTLY_BULLISH、NEUTRAL、SLIGHTLY_BEARISH、VERY_BEARISH
  - **維度四：關聯股票代碼 (Related Tickers)**：從新聞中提取相關股票代碼列表
- **實施檔案**：`24_P5_DAILY_NEWS.js` 的 `deduplicateAndCategorizeWithGeminiPro()`、`01_SHEETS_STRUCTURE.js` 的 `NEWS_ATOMS_DAILY_SCHEMA`
- **輸出格式**：以weekly決策時如何好讀取已經夠精確為方向設計

**3. 個股新聞索引系統（Phase 3）**
- **設計概念**：反向索引 (Inverted Index)，讓Weekly可以用「股票代碼」反查所有相關新聞
- **實施流程**：
  1. Flash標記：每則新聞提取 `Related_Tickers: ["NVDA", "AMD"]`
  2. Daily聚合：Daily結算時產出「當日熱點表」（每個ticker的關聯新聞數量、情緒分布、新聞ID列表）
  3. Weekly讀取：Weekly AI先讀「當日熱點表」，發現「本週NVDA討論度暴增300%？」→ AI主動調閱NVDA相關的那12則新聞進行深度分析
- **主要功能**：上標籤，讓weekly做"個股當周策略"時，能夠快速引入做為決策因子之一
- **實施檔案**：`24_P5_DAILY_NEWS.js` 的 `buildTickerNewsIndex()`、`saveTickerNewsIndexToSheet()`、`01_SHEETS_STRUCTURE.js` 的 `STOCK_NEWS_INDEX_DAILY_SCHEMA`
- **⭐ 核心價值**：Weekly決策系統能夠更快更精準的讀取到每個個股的一週新聞索引，不用每分析一個股票都要自己重找一次（節省AI算力）

**4. 新聞驗證機制（Phase 4）**
- **設計哲學**：Daily是資料鑑識科（Forensics），只負責數據正確性、時效性、語意一致性檢查；Weekly是情報分析處（Intelligence），負責市場方向、影響程度、投資意義分析
- **驗證層級**：
  1. **時效性檢驗**：檢查新聞所引用的數據是否明顯不是「最近可得數據」（DATA_RECENCY = OK | STALE | UNCLEAR）
  2. **數據語意健檢**：判斷新聞是否存在明顯錯誤引用（DATA_COHERENCE = CONSISTENT | QUESTIONABLE | INCONSISTENT）
  3. **數據驗證（Cross-check）**：使用Daily DB硬數據驗證新聞中的數值（DATA_VERIFICATION = VERIFIED | NOT_VERIFIED | NOT_APPLICABLE）
  4. **Proxy驗證**：驗證「方向與敘事是否被市場行為支持」
     - 敘事方向檢驗（NARRATIVE_DIRECTION = CONSISTENT | UNCONFIRMED | CONFLICTING）
     - 市場重要性檢驗（MARKET_CONFIRMATION = STRONG | MODERATE | WEAK）
     - 共振檢驗（CROSS_ASSET_RESONANCE = STRONG | MODERATE | WEAK）
- **重要原則**：
  - ✅ 所有驗證邏輯都由Gemini Pro智慧模型執行，不可以用程式邏輯
  - ❌ **禁止讓AI去網路搜尋**，避免AI幻覺
  - ✅ 所有驗證數據都從Daily DB讀取後提供給AI
  - ❌ **禁止**：用ETF/proxy去驗證新聞中的精確數字
  - ✅ **允許**：用Proxy驗證「方向與敘事是否被市場行為支持」
- **實施檔案**：`24_P5_DAILY_NEWS.js` 的 `verifyNewsDataWithDailyDB()`、`batchVerifyNewsData()`

**6. Weekly系統優化（Phase 5）** ⭐ V8.12 新增
- **設計目標**：避免Weekly「重複工作100次」，類似個股新聞索引的模式
- **核心原則**：
  - ✅ 不做AI摘要（5天數據不需要AI摘要，會失真）
  - ✅ 使用程式計算提供硬數據（波動度、背離度、比對結果）
  - ✅ 建立反向索引，一次聚合，多次使用
- **優化項目**：
  1. **板塊/產業新聞索引**：
     - 問題：100檔股票，每檔都要搜尋所屬板塊/產業的新聞
     - 解決：Daily建立反向索引（板塊/產業 → 相關新聞列表）
     - 表格：`SECTOR_NEWS_INDEX_DAILY`
     - 實施檔案：`24_P5_DAILY_WEEKLY_OPTIMIZATION.js` 的 `buildSectorNewsIndex()`、`saveSectorNewsIndexToSheet()`
  2. **事件索引**：
     - 問題：100檔股票，每檔都要過濾事件列表
     - 解決：Daily建立反向索引（ticker → 相關事件列表）
     - 表格：`EVENTS_INDEX_WEEKLY`
     - 實施檔案：`24_P5_DAILY_WEEKLY_OPTIMIZATION.js` 的 `buildEventsIndex()`、`saveEventsIndexToSheet()`
  3. **宏觀數據週度波動度計算**：
     - 問題：Weekly需要了解本週宏觀數據的波動度和變化趨勢
     - 解決：用程式計算（不用AI）五天內各數據的價量波動度、背離度、與上週比對
     - 計算內容：
       - 價格波動度（標準差、最大振幅）
       - 成交量波動度
       - 價量相關性係數
       - 背離度評分
       - 與上一週波動度比對
     - 表格：`MACRO_DATA_WEEKLY_METRICS`
     - 實施檔案：`24_P5_DAILY_WEEKLY_OPTIMIZATION.js` 的 `calculateMacroWeeklyMetrics()`、`saveMacroWeeklyMetricsToSheet()`
  4. **技術指標週度波動度計算**：
     - 問題：Weekly可能需要了解本週技術指標的變化趨勢
     - 解決：用程式計算（不用AI）基於Daily已計算的技術指標，計算本週變化趨勢
     - 計算內容：
       - RSI變化範圍（最高、最低、變化幅度）
       - MACD背離檢測
       - 均線交叉情況
       - 成交量趨勢
       - 與上週對比
     - 表格：`TECHNICAL_INDICATORS_WEEKLY_METRICS`
     - 實施檔案：`24_P5_DAILY_WEEKLY_OPTIMIZATION.js` 的 `calculateTechnicalWeeklyMetrics()`、`saveTechnicalWeeklyMetricsToSheet()`
- **執行時機**：每週五（週度聚合），在 `P5_Daily_Execute()` 中自動觸發
- **實施檔案**：`24_P5_DAILY_WEEKLY_OPTIMIZATION.js` 的 `executeWeeklyOptimization()`
- **⭐ 核心價值**：
  - 避免Weekly重複搜尋板塊/產業新聞100次（約減少99%工作量）
  - 避免Weekly重複過濾事件列表100次（約減少99%工作量）
  - 提供硬數據給Weekly，不用AI摘要（避免失真、忽略細節）

**5. Daily DB擴充（Phase 5）**
- **擴充策略**：一次性擴充所有Tier 1 + Tier 2數據（全部擴充好，這個很簡單）
- **Tier 1（一級硬錨點）**：Daily必須抓，不能缺
  - MOVE Index（債券波動）或Proxy（用TLT的intraday volatility當proxy）
  - LQD（投資級公司債ETF）
  - RSP（SPX equal-weight，可選但非常有價值）
- **Tier 2（二級代理錨點）**：Daily抓，但Weekly解讀時自動降權
  - BITO / IBIT（BTC proxy）
  - XME（Metal & Mining ETF）
  - 戰略物資ETF：LIT（鋰）、REMX（稀土）、URA（鈾）、TAN（太陽能）
  - 板塊ETF：XLK（科技）、SOXX/SMH（半導體）、IGV（軟體）
- **未來擴充機制**：如果發現新聞多次出現DB沒有的數據，就一樣擴充上去
- **實施檔案**：`24_P5_DAILY_MACRO.js` 的 `collectMarketIndices()`

##### **⭐ V8.13 更新（2026-01-19）：動態學習系統完整補強（V7設計完整統整）**

**⚠️ 重要說明**：這是V7時就已經詳細定案的動態學習系統設計（Closed-loop Brain），但在後續討論中逐漸遺漏，沒有記進SSOT。現在完整統整，確保所有細節都被記錄。詳細設計請參考 `V8.13_V7動態學習系統設計完整統整.md`。

**核心目標**：最大化長期期望值（EV），並在風險環境下避免回撤致死。系統具備閉環控制：每次策略輸出都必須被未來市場驗證，並回饋到下一輪策略生成的「參數空間校準」。

**核心變更**：
1. **A. 數據–策略–結果追蹤鏈**：STRATEGY_SNAPSHOT + OUTCOME_SNAPSHOT + Claims結構化（V7設計）
2. **B. 策略比對機制**：四項Scorecard（方向準度、時機偏差、幅度偏差、最大回撤）（V7設計）
3. **C. 錯誤歸因引擎**：Type A/B/C/D分類 + Evidence pointers（V7設計）
4. **D. 參數校準**：LEARNING_STATE（權重呼吸 + 閾值縮放），禁止改邏輯（V7設計）
5. **E. 情境記憶**：SCENARIO_MEMORY + Safety Lock機制（V7設計）
6. **F. 工程限制清單**：5條防debug規則（V7設計）

**詳細說明**：

**A. 數據–策略–結果追蹤鏈（Data → Strategy → Outcome Trace）** ⭐ V7設計

- **設計目標**：系統每次輸出策略時寫入 STRATEGY_SNAPSHOT，包含當下資料摘要與「可驗證命題（Claims）」；對應觀察窗結束後寫入 OUTCOME_SNAPSHOT，形成可回放的追蹤鏈
- **數據結構**：
  - **STRATEGY_SNAPSHOT**（`P5__STRATEGY_SNAPSHOT`表格）：
    - `snapshot_id`、`created_at`、`period_type`、`period_id`
    - `data_summary_json` - 當下資料摘要
    - `claims_json` - 可驗證命題（**核心**，每個Claim包含claim_id、claim_type、claim_content、verification_window、verification_condition）
    - `strategy_output_json` - 策略輸出
    - `data_sources_json` - 數據來源記錄（V8.13已實現）
  - **OUTCOME_SNAPSHOT**（`P5__OUTCOME_SNAPSHOT`表格）：
    - `outcome_id`、`strategy_snapshot_id`（外鍵）、`created_at`、`period_type`、`period_id`
    - `market_data_json` - 市場真實反應數據
    - `claims_verification_json` - 可驗證命題驗證結果（**核心**）
    - `scorecard_json` - 四項Scorecard（見B節）
    - `attribution_json` - 錯誤歸因結果（見C節）
- **實施要求**：
  - 策略輸出時必須同時創建STRATEGY_SNAPSHOT，包含所有可驗證命題（Claims）
  - 觀察窗結束後必須創建OUTCOME_SNAPSHOT，對照市場真實反應
  - 只有被結構化成Claim的策略敘述才評分（避免亂評分導致亂調參數）
- **實施狀態**：✅ **已實現**（2026-01-24 確認）
  - ✅ **STRATEGY_SNAPSHOT**：在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（讀取/寫入 `P5__STRATEGY_SNAPSHOT` 表格）
  - ✅ **OUTCOME_SNAPSHOT**：在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（讀取/寫入 `P5__OUTCOME_SNAPSHOT` 表格）
  - ⏳ **Claims結構化**：待實現（需要將策略輸出結構化成 Claims）

**B. 策略比對機制（Weekly / Monthly / Quarterly）** ⭐ V7設計

**1. 策略比對機制（動態學習系統核心）**
- **設計哲學**：這是動態記憶學習系統的精神，逐漸不斷累積策略vs市場真實反應的經驗，將每次比對後學習到的觀念都儲存在永久大腦之中，作為新制定策略的記憶與依據
- **頻率分工**：
  - **Weekly**：在執行時比對「上一週的策略」與「本週的市場真實反應」
  - **Monthly**：在執行時比對「上一月的策略」與「本月的市場真實反應」，統整全月學習經驗，跟前三個月的經驗連結後更新月度結論
  - **Quarterly**：在執行時比對「上一季的策略」與「本季的市場真實反應」，統整全季學習經驗，跟前季的經驗再次統整，更新季度結論
  - **核心價值**：做的工作類似，但是時間維度不同，看到的結論就不同
- **比對內容**：
  - 讀取前一時間週期的策略（從`P5__WEEKLY_STOCK_STRATEGIES`或`P5__STRATEGY_SNAPSHOT`）
  - 讀取當前時間週期的市場真實反應（從`MARKET_OHLCV_DAILY`等）
  - 計算四項Scorecard（**V7設計要求**）：
    * **方向準度（Directional Accuracy）**：預測方向是否正確（0.0-1.0，優秀≥0.70）
    * **時機偏差（Timing Bias，日）**：預測時機是否準確（±3天內為優秀）
    * **幅度偏差（Magnitude Bias，%）**：預測幅度是否準確（±5%內為優秀）
    * **最大回撤（Max Drawdown，%）**：策略執行期間的最大回撤（<5%為優秀）
  - 保存比對結果到`P5__LEARNING_LOG`和`P5__OUTCOME_SNAPSHOT`（作為前一時間週期的策略比對紀錄）
- **實施檔案**：
  - `24_P5_WEEKLY_CORE.js`：在Step 5.5加入策略比對邏輯（比對上一週）
  - `24_P5_MONTHLY.js`：在Step 5.5加入策略比對邏輯（比對上一月）
  - `24_P5_QUARTERLY.js`：在Step 3.5加入策略比對邏輯（比對上一季）
  - `24_P5_WEEKLY_LEARNING.js`：
    * `compareStrategyWithReality(periodsAgo, periodType)` - 通用比對函數（支援週/月/季）
    * `saveStrategyComparisonToLearningLog(comparison, frequency)` - 保存比對結果到學習日誌
- **數據表**：
  - `P5__WEEKLY_STOCK_STRATEGIES` - 個股策略追蹤表（保存所有策略）
  - `P5__LEARNING_LOG` - 學習日誌表（保存策略比對紀錄和學習結果）

**C. 錯誤歸因引擎（Attribution Engine）** ⭐ V7設計

- **設計目標**：當 Scorecard 低於門檻時，AI 必須選擇單一主因（可選次因），並附上 Evidence pointers
- **錯誤類型**（必須實現）：
  - **Type A：數據源污染**（Data Source Contamination）- 使用的數據來源有問題
  - **Type B：邏輯幻覺**（Logic Hallucination）- AI邏輯推理錯誤
  - **Type C：執行滑價**（Execution Slippage）- 策略執行時的滑價問題
  - **Type D：黑天鵝**（Black Swan）- 無法預測的極端事件
- **實施要求**：
  - 必須選擇單一主因（不能同時選擇多個主因）
  - 可選次因（1-2個次要原因作為補充）
  - 必須附Evidence pointers（每個歸因都必須有具體的證據指向）
  - 缺證據時標記`UNCERTAIN_CAUSE`，不得驅動回寫
  - 保存到`P5__OUTCOME_SNAPSHOT`的`attribution_json`欄位
- **實施狀態**：⚠️ **部分實現**（2026-01-24 確認）
  - ✅ **錯誤歸因邏輯**：在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中 `generateReflection()` 函數實現（Type A/B/C/D 分類）
  - ⏳ **完整錯誤歸因引擎**：需要整合到策略比對流程中

**D. 參數校準（Write-back只允許參數校準，禁止改邏輯）** ⭐ V7設計

- **設計目標**：所有學習結果只能回寫到 LEARNING_STATE（JSON），禁止回寫或修改任何 Phase 策略邏輯與 if-then 決策
- **LEARNING_STATE**（`P5__LEARNING_STATE`表格）：
  - `state_id`、`created_at`、`updated_at`
  - `learning_state_json` - 學習狀態（JSON格式，**核心**）：
    * **權重呼吸（Breathing Weights）**：
      - `fundamental`、`chips`、`tech`、`macro`、`sentiment`（範圍：0.0-1.0，總和=1.0）
      - 每週最多 ±0.05（避免劇烈波動）
      - 每月才允許重新平衡到新穩態
    * **關鍵閾值縮放（Threshold Scaling）**：
      - `entry_confirmation_atr_multiple`（進場確認ATR倍數，預設1.5）
      - `lock_profit_atr_multiple`（鎖利ATR倍數，預設2.0）
      - `narrative_downgrade_strength`（敘事降權強度，預設0.3）
      - `risk_off_trigger_vix`（Risk-Off觸發VIX閾值，預設25.0）
      - `max_position_size`（單一持股最大權重，預設0.15）
      - 每次調整幅度不超過±10%
- **禁止事項**（嚴格執行）：
  - 禁止修改策略邏輯（不能修改任何Phase的策略邏輯）
  - 禁止修改if-then決策（不能修改任何if-then決策規則）
  - 禁止修改程式邏輯（程式端只讀取參數並計算，不做判斷）
  - **唯一可回寫檔**：LEARNING_STATE.json（其他地方禁止寫參數）
- **回寫頻率限制**：
  - 權重每週最多 ±0.05
  - 每月才允許重新平衡到新穩態
- **回寫觸發條件**：
  - Scorecard低於閾值
  - 錯誤歸因完成（有明確證據）
  - 不能因為缺證據就回寫（必須標記UNCERTAIN_CAUSE）
- **實施狀態**：✅ **已實現**（2026-01-24 確認）
  - ✅ **LEARNING_STATE**：在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（讀取/寫入 `P5__LEARNING_STATE` 表格）
  - ✅ **權重呼吸（Breathing Weights）**：已實現
  - ✅ **關鍵閾值縮放（Threshold Scaling）**：已實現

**E. 情境記憶（Scenario Memory / PTSD）** ⭐ V7設計

- **設計目標**：系統將每次策略時的環境特徵寫入 SCENARIO_MEMORY（簽章統計）。當某簽章在歷史上顯示高死亡率，系統輸出 Safety Lock 建議
- **SCENARIO_MEMORY**（`P5__SCENARIO_MEMORY`表格）：
  - `scenario_id`、`created_at`、`updated_at`
  - `scenario_signature_json` - 情境簽章（JSON格式，**核心**）：
    - `vix_level`（VIX水平：LOW/MEDIUM/HIGH/EXTREME）
    - `market_regime`（市場狀態：BULL/BEAR/SIDEWAYS/UNCERTAIN）
    - `sector_rotation`（板塊輪動，JSON格式）
    - `macro_indicators`（宏觀指標，JSON格式）
    - `news_sentiment`（新聞情緒：POSITIVE/NEUTRAL/NEGATIVE）
    - `technical_signals`（技術信號，JSON格式）
  - `historical_occurrences_json` - 歷史出現次數（包含total_count、success_count、failure_count、mortality_rate）
  - `safety_lock_recommendations_json` - Safety Lock建議（當死亡率>0.5時輸出）
- **Safety Lock機制**：
  - **不得硬鎖執行**：Safety Lock只能給Weekly限制建議，不能硬鎖執行
  - **可由Weekly Override**：Weekly可以覆蓋Safety Lock建議，但必須留下理由
  - **納入下一輪比對**：如果Weekly覆蓋了Safety Lock建議，必須將此決策納入下一輪比對
- **實施要求**：
  - 每次策略輸出時，必須提取環境特徵並生成情境簽章
  - 比對歷史情境簽章，計算死亡率
  - 當死亡率>0.5時，輸出Safety Lock建議
  - Safety Lock建議必須記錄到STRATEGY_SNAPSHOT中
- **實施狀態**：⏳ 待實現（需要新增表格和函數）
  - ⏳ **SCENARIO_MEMORY**：待實現（需要新增 `P5__SCENARIO_MEMORY` 表格）
  - ⏳ **Safety Lock機制**：待實現（需要實現情境簽章比對和死亡率計算）

**F. 工程限制清單（5條防debug規則）** ⭐ V7設計

**⚠️ 這5條是能讓你少debug 70%的條款（務必寫進SSOT）**：

1. **唯一可回寫檔：LEARNING_STATE.json（其他地方禁止寫參數）**
   - 嚴格執行：所有參數調整只能寫入`P5__LEARNING_STATE`表格
   - 禁止事項：禁止在其他任何地方（程式碼、配置文件、其他表格）寫入參數

2. **回寫頻率限制：權重每週最多 ±0.05；每月才允許重新平衡到新穩態**
   - 權重調整限制：每週權重調整幅度不得超過±0.05
   - 重新平衡限制：每月才允許重新平衡到新穩態（可以超過±0.05）
   - **防重複（強制要求）** ⭐ **V8.42**：Learning State 防重複為**強制要求**；實作可為「以 week_id / time_window / version_hash 判斷是否已調整」，實作方式不限定，但**必須保證同一時間窗只寫入一次**。

3. **Safety Lock不得硬鎖執行：只能給Weekly限制建議**
   - 設計原則：Safety Lock只能給建議，不能硬鎖執行
   - 實施要求：程式端不能因為Safety Lock就強制阻止執行，只能提供建議

4. **歸因無證據不得回寫：先標UNCERTAIN_CAUSE**
   - 嚴格執行：如果錯誤歸因沒有明確證據，必須標記`UNCERTAIN_CAUSE`
   - 禁止事項：不能因為沒有證據就跳過歸因，也不能因為沒有證據就回寫

5. **Claims才評分：沒有被結構化成Claim的策略敘述不評分（避免亂評分導致亂調參數）**
   - 設計原則：只有被結構化成Claim的策略敘述才評分
   - 實施要求：策略輸出時，必須將所有可驗證的預測結構化成Claims；只有Claims才會被評分，其他敘述不評分

**實施狀態對照表**：

| 功能模組 | V7設計 | V8.13現有實現 | 狀態 |
|---------|--------|--------------|------|
| STRATEGY_SNAPSHOT | ✅ | ✅ | ✅ **已實現**（2026-01-24 確認） |
| OUTCOME_SNAPSHOT | ✅ | ✅ | ✅ **已實現**（2026-01-24 確認） |
| Claims結構化 | ✅ | ❌ | ⏳ 待實現 |
| 四項Scorecard | ✅ | ⚠️ 部分實現 | ⏳ 需補充 |
| 錯誤歸因引擎 | ✅ | ❌ | ⏳ 待實現 |
| LEARNING_STATE | ✅ | ✅ | ✅ **已實現**（2026-01-24 確認） |
| SCENARIO_MEMORY | ✅ | ❌ | ⏳ 待實現 |
| Safety Lock | ✅ | ❌ | ⏳ 待實現 |
| 工程限制清單 | ✅ | ⚠️ 部分遵守 | ⚠️ 需強化 |

**⭐ 2026-01-24 更新**：
- ✅ **STRATEGY_SNAPSHOT**：已在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（讀取/寫入 `P5__STRATEGY_SNAPSHOT` 表格）
- ✅ **OUTCOME_SNAPSHOT**：已在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（讀取/寫入 `P5__OUTCOME_SNAPSHOT` 表格）
- ✅ **LEARNING_STATE**：已在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（讀取/寫入 `P5__LEARNING_STATE` 表格）
- ✅ **getLearningFeedback()**：已在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（整合學習反饋，包含 `principles_summary`、`recent_reflections`、`similar_failure_cases`、`safety_lock_recommendations`、`parameter_bias_adjustment`）
- ✅ **三層記憶模型**：已在 `src/24_P5_WEEKLY_MEMORY_MANAGER.js` 中實現（`buildWeeklyMemoryPack()` 函數組裝三層記憶包，包含 L1 STM、L2 MTM、L3 LTM）
- ✅ **記憶包 I/O 對接**：已在 `src/24_P5_WEEKLY_DATA.js` 中實現（`collectP5WeeklyAllData()` 調用 `buildWeeklyMemoryPack()`，記憶包傳遞到 context）
- ✅ **記憶包在 Prompt 中使用**：已在 `src/24_P5_WEEKLY_DUAL_LAYER.js` 和 `src/24_P5_WEEKLY_STOCK_STRATEGY.js` 中實現（`buildP5_BPrompt()`、`buildP5_APrompt()`、`buildStockStrategyBatchPrompt()` 都包含記憶包）

**詳細設計文檔**：請參考 `V8.13_V7動態學習系統設計完整統整.md`

**⭐ V8.13 核心價值**：
- **動態記憶學習系統**：逐漸不斷累積策略vs市場真實反應的經驗，將每次比對後學習到的觀念都儲存在永久大腦之中
- **頻率分工**：Weekly/Monthly/Quarterly各自負責對應時間範圍的策略比對，時間維度不同，看到的結論就不同
- **數據完整性**：所有進Weekly決策系統的數據與分析，以及最後的產出策略，都必須要跟後來市場的真實反應一起進入動態學習系統，去比對準確度、相關性等
- **學習結果應用**：Monthly統整全月學習經驗，跟前三個月的經驗連結後更新月度結論，給接下來的weekly決策系統使用；Quarterly統整全季學習經驗，跟前季的經驗再次統整，更新季度結論，給接下來的weekly決策系統使用

**⭐ V8.12 核心價值**：
- **Weekly決策系統優化**：
  - a. 得到更精準與準確度高、且分類更精細的本週新聞摘要，用以更新世界金融市場背景觀
  - b. 做每週持股動態策略時，能夠更快更精準的讀取到每個個股的一週新聞索引，不用每分析一個股票都要自己重找一次（這真的超重要，務必要實現正確的方向，不然AI算力會浪費到爆）
    * **按機構分開存儲**：每筆評級都有 `rating_firm` 欄位（標準化後的機構名稱，如 `GOLDMAN_SACHS`），可以按機構查詢歷史評級（例如：高盛對 AAPL, NVDA, ASML, TSM 的所有評級），用於追蹤每個機構的可信度（誠實好寶寶 vs 愛騙人的鬼）
- **⭐ V8.9 新增：新聞品質優化（適用於所有 P5 新聞管線）**：
  - **時效性測試**：±6 小時（避免與前一天新聞重複）
  - **範圍精準性測試**：涵蓋十大分類，無雜訊、無非正式新聞（論壇、社論）
  - **雜訊過濾優化**：針對白名單網站客製化（The Fly、鉅亨網、Minkabu 等）
  - **多語支持**：英文、中文、日文關鍵字過濾和內容檢測
- **⭐ 數據來源（白名單原則 + GOOGLEFINANCE）**：
  - **新聞收集**：使用白名單 CSE（P5_NEWS）
    * ⭐ **V8.9 設計原則（2026-01-19 明確）**：
      - **收集範圍**：收集**所有財經新聞**（不限於特定ticker），而非針對每個ticker收集
      - **搜尋查詢**：使用通用財經新聞查詢（多語支持：英文、中文、日文）
      - **後續處理**：由 AI 處理進行篩選、去重、多維度標籤分類（見 V8.12；宏觀依 10–12 類對接）
      - **ticker識別**：由後續AI處理識別相關ticker（如果新聞涉及特定股票）
      - **測試版要求**：英語中文日語新聞各10篇
  - **機構評級收集**：使用專屬 CSE（P5_INSTITUTIONAL_RATINGS，V8.9 新增）⭐
    * ⭐ **V8.9 測試版要求（2026-01-19）**：
      - **時效性**：測試版不要求當日最新，先看白名單CSE內有沒有足夠非當日評級
      - **正式版**：未來要恢復當日最新要求
  - **宏觀數據**：優先使用 GOOGLEFINANCE（免費、穩定），備用 stooq.com（通過 Cloud Function 代理）
    * 匯率：先嘗試直接代碼（例如 `EURUSD`），失敗再嘗試 `CURRENCY:EURUSD`（例如 `CURRENCY:EURUSD`, `CURRENCY:USDJPY`）
    * 國債利率：`INDEXCBOE:XXX`（例如 `INDEXCBOE:TNX` 10年美債, `INDEXCBOE:VIX`）
    * 商品期貨：使用 ETF 代理（例如 `USO` 原油, `GLD` 黃金, `SLV` 白銀）
    * ⭐ **V8.0 修正（2026-01-17）**：
      - 等待時間延長至 20秒（40次重試，原本 10秒）
      - 匯率數據需要更長暖機時間，已優化 ticker 格式（先嘗試直接代碼，失敗再嘗試 `CURRENCY:` 前綴）
  - **所有數據都由程式從白名單數據源獲取，不讓 AI 模型自己去找**

#### P5 Daily 新架構（D-1 ~ D-4）完整定義 ⭐ V8.30/V8.40/V8.43 定案

> [!IMPORTANT]
> D-1/D-2/D-3/D-4 **不是** P5.1/P5.2/P5.3 的改名，而是**完全不同的架構與分工**。
> 
> **舊設計（GAS 時代）**：按數據類型分工（新聞、OHLCV、籌碼）
> **新設計（目標架構）**：按處理流程與職責分工（蒐集→索引→個股統整→宏觀統整）

##### AI 模型配置表（目標架構）⭐ V8.30 定案

| 模組 | AI 模型 | 執行模式 | 職責 |
|------|---------|----------|------|
| **D-1A** | grok 4.1 fast | Batch | 權威新聞蒐集、清洗、去重、多維度標籤、宏觀分類 |
| **D-1B** | grok 4.1 fast | Batch | 散戶論壇蒐集、清洗、散戶溫度計、索引連結 |
| **D-2** | DeepSeek V3 (671B) | Batch | 僅處理 D-1A 宏觀/產業新聞，用 AI 知識推斷影響個股並加初步短評 |
| **D-3** | Llama 3.3 70B | Batch | 個股專屬統整：每日狀態報告、變化/異常/延續/轉折標註 |
| **D-4** | Hermes 4 | Batch | 宏觀世界觀統整：10-12 類子世界敘事快照 |
| **WB-1** | Hermes 4 405B | 非 Batch | 宏觀與個股快照、DSFP 身份裁決、escalation 判定 |
| **WB-2** | Hermes 4 405B + o3 審查 | Batch 審查 | Strategy Skeleton 生成、Order DSL、掛單策略 |
| **W-A** | o3 | 不 Batch | 觸發式審查（世界觀劇變、個股 escalation） |

##### D-1A：權威新聞蒐集管線

**模型**：grok 4.1 fast（Batch）

**職責**：
1. 從白名單 CSE 蒐集權威財經新聞
2. 時效性驗證（±6hr）
3. 雜訊過濾
4. 多維度標籤分類
5. 宏觀 12 類對接（供 D-4 直接使用）
6. **明確提及個股的新聞**：直接標記關聯股票代碼並建立索引（不需送 D-2）

**嚴格規則**：
- ⚠️ **禁止混入論壇內容**
- ⚠️ 與 D-1B **完全分離**，不得在同一個 Prompt 中處理

**多維度標籤系統**：

- **維度一：宏觀 12 類分類 (Macro Category)** ⭐ V8.44 修正
  1. 央行與貨幣政策（Central_Bank）
  2. 經濟數據（Econ_Data）
  3. 地緣政治（Geopolitics）
  4. 股市與指數（Stock_Index）
  5. 債券與利率（Bond_Yield）
  6. 匯率（Forex）
  7. 能源（Energy）
  8. 貴金屬（Precious_Metals）
  9. 工業金屬（Industrial_Metals）
  10. 加密貨幣（Crypto）
  11. VIX 與恐慌指標（Fear_Index）
  12. 資金流向與機構動態（Institutional_Flow）
  - **用途**：D-4 直接吃 12 類分類內容做整理、敘事連結與快照

- **維度二：影響層級 (Impact Scope)**：GLOBAL / SECTOR / STOCK

- **維度三：情緒極性 (Sentiment Polarity)**：VERY_BULLISH / SLIGHTLY_BULLISH / NEUTRAL / SLIGHTLY_BEARISH / VERY_BEARISH

- **維度四：關聯股票代碼與分流 (Related Tickers & Routing)** ⭐ V8.44 修正
  - **若新聞明確提及某個股或某些個股**：
    - 歸類為「個股新聞」
    - **直接**產生新聞與個股索引（不需送 D-2）
    - 標記 `news_type = "STOCK_SPECIFIC"`
  - **若新聞主體為技術/產業/宏觀內容（非明確描述單一或群體個股）**：
    - 歸類為「宏觀/產業新聞」
    - 標記 `news_type = "MACRO_OR_INDUSTRY"`
    - **送 D-2** 進行深度個股關聯判斷

**驗證標記**：DATA_RECENCY（OK/STALE/UNCLEAR）、DATA_COHERENCE（CONSISTENT/QUESTIONABLE/INCONSISTENT）、DATA_TYPE（HARD/SEMI_STRUCTURED/NARRATIVE）

##### D-1B：散戶論壇蒐集管線

**模型**：grok 4.1 fast（Batch）

**職責**：
1. 從白名單論壇蒐集散戶討論
2. 清洗與過濾
3. 散戶溫度計計算
4. **直接標記關聯股票代碼並建立索引**（散戶論壇討論通常以個股居多，不需送 D-2）
5. 宏觀 12 類對接（供 D-4 使用）

**嚴格規則**：
- ⚠️ **禁止混入權威新聞**
- ⚠️ 與 D-1A **完全分離**
- ⚠️ 論壇數據**絕對權重遠低於**系統本身與機構/主力預測結論
- ⚠️ **所有索引須註記 `source = "FORUM"`**（來自散戶論壇管線）

**多維度標籤系統**（與 D-1A 相同）：
- **維度一**：宏觀 12 類分類
- **維度二**：影響層級（GLOBAL / SECTOR / STOCK）
- **維度三**：情緒極性
- **維度四**：關聯股票代碼（**直接標記**，不送 D-2）

**與 D-2 的分工**：
- D-1B 產出的個股索引由 D-1B **直接完成**
- D-1B 產出**不送 D-2**進行深度連結
- D-1B 索引**須註記來源為散戶論壇管線**

**用途**：研究散戶追逐趨勢、小型/新創敘事股參考，**不取代機構與主力結論**

##### D-1A/D-1B 全程分離原則 ⭐ V8.43 定案 + V8.44 修正

**核心規則**：從蒐集到分析，權威新聞與散戶論壇**均須分欄或標註來源**，不得互相汙染。

**具體要求**：
1. **D-1A/D-1B**：分開 Prompt、分開呼叫、分開存儲
2. **D-2 索引建立**：**僅處理 D-1A 的宏觀/產業新聞**（D-1B 不送 D-2，因散戶論壇討論已直接標記個股）
3. **D-3 個股統整**：須**分欄註明**新聞來源（權威新聞 vs 散戶論壇 vs D-2 推斷）
4. **D-4 宏觀統整**：須**分欄區分**權威新聞 vs 散戶論壇
5. **Weekly 引用**：須清楚區分來源，給予不同權重

##### D-2：新聞↔個股深度連結（僅處理 D-1A 宏觀/產業新聞）⭐ V8.44 修正

**模型**：DeepSeek V3 (671B)（Batch）

**輸入來源**：
- **僅接收 D-1A** 標記為 `news_type = "MACRO_OR_INDUSTRY"` 的新聞
- **不接收 D-1B** 的內容（散戶論壇討論已由 D-1B 直接標記個股索引）

**職責**：
1. 對**沒有明確提及個股**的宏觀/產業/技術新聞，使用 **AI 內建知識**推斷該新聞會影響或牽連哪些個股
2. 建立新聞↔個股連接索引
3. 判斷影響是**產業面**還是**個股面**

**初步短評註記** ⭐（每個個股連接須加上）：
- `impact_direction`：POSITIVE / NEUTRAL / NEGATIVE / PENDING / REQUIRES_MULTI_FACTOR
  - **POSITIVE**：通常對該個股正向
  - **NEUTRAL**：中性，純資訊
  - **NEGATIVE**：通常對該個股負向
  - **PENDING**：待判斷，需更多資訊
  - **REQUIRES_MULTI_FACTOR**：須結合其他因子綜合判斷
- `impact_reasoning`：簡短說明判斷依據（1-2 句）

**輸出**：
- 個股新聞索引（每股 → 相關新聞列表）
- 須**分欄標註** `source = "D2_INFERENCE"`（來自 D-2 推斷，非新聞直接提及）
- 須包含 `impact_direction` 與 `impact_reasoning`

**存儲表格**：`STOCK_NEWS_INDEX_DAILY`

**與 D-1A/D-1B 的分工**：
| 新聞類型 | 處理者 | 說明 |
|----------|--------|------|
| **D-1A 個股新聞**（明確提及個股） | D-1A 直接標記 | `source = "D1A_DIRECT"` |
| **D-1A 宏觀/產業新聞**（無明確個股） | D-2 推斷 | `source = "D2_INFERENCE"` |
| **D-1B 散戶論壇討論** | D-1B 直接標記 | `source = "FORUM"`，不送 D-2 |

##### D-3：個股專屬統整師

**模型**：Llama 3.3 70B（Batch）

**職責**：
1. 整合個股當日所有新資訊（新聞、OHLCV、籌碼、衍生品）
2. 產出每日個股狀態報告
3. 標註變化/異常/延續/轉折
4. 讀取前三天歷史快照，保持敘事連貫

**⭐ 必須遵守：史官鐵律**
- 不得改寫歷史，僅能追加 delta/link/tag/branch
- 須讀取前三天歷史快照
- 敘事須如同同一觀察者連續撰寫

**⚠️ 嚴禁**：不負責策略建議、不分析漲跌、不做買賣判斷

**REVERSAL_NOISE 檢測**（個股層級）：
- 若同一個股主題 7 天內「情緒反轉 ≥ 3 次」→ `event_stability = "REVERSAL_NOISE"`
- 若同一個股主題 7 天內「情緒一致 ≥ 5 天」→ `event_stability = "STABLE_EVENT"`
- 輸出 `contradiction_pattern` 與 `contradiction_reasoning` 供 Weekly 深度思考

**輸出**：個股每日狀態快照、變化/異常/延續/轉折標註、IDENTITY_SHIFT_SIGNALS、EVENT_CLUSTER_UPDATE、WEEKLY_ESCALATION_HINT

**須分欄註明**：新聞來源（D-1A 權威新聞 vs D-1B 散戶論壇）

##### D-4：宏觀世界觀統整師

**模型**：Hermes 4（Batch）

**職責**：
1. 統整當日宏觀世界觀
2. 產出 10-12 類子世界敘事快照
3. 讀取前三天歷史快照，保持敘事連貫
4. 納入衍生品與宏觀指標

**⭐ 必須遵守：史官鐵律**（同 D-3）

**10-12 類宏觀子世界**：
1. 央行與貨幣政策（Fed、ECB、BOJ、PBOC）
2. 經濟數據（CPI、就業、PMI、GDP）
3. 地緣政治（戰爭、制裁、貿易政策）
4. 股市與指數（S&P 500、NASDAQ、道瓊、台股、日經）
5. 債券與利率（美債、殖利率曲線）
6. 匯率（美元、日圓、歐元、人民幣）
7. 能源（原油、天然氣）
8. 貴金屬（黃金、白銀）
9. 工業金屬（銅、鋁）
10. 加密貨幣（BTC、ETH）
11. VIX 與恐慌指標
12. 資金流向與機構動態

**REVERSAL_NOISE 檢測**（宏觀層級）：同 D-3 邏輯，用於宏觀主題

**輸出**：宏觀每日世界觀快照、各子世界敘事摘要、IDENTITY_SHIFT_SIGNALS、WEEKLY_ESCALATION_HINT

**須分欄區分**：權威新聞 vs 散戶論壇來源

---

##### **Daily OHLCV 蒐集（供 D-2/D-3 等使用）：每日市場與個股 OHLCV 數據蒐集** ⭐ **白名單數據源 + 技術指標分級計算** + **V8.33 目標架構：主來源可靠 API，GOOGLEFINANCE 僅備援**
- **檔案**: 
  - `24_P5_DAILY_OHLCV_CORE.js`（核心邏輯）
  - `24_P5_DAILY_OHLCV_GOOGLEFINANCE.js`（GOOGLEFINANCE 數據源，V8.0 新增）⭐
  - `24_P5_DAILY_OHLCV_STOOQ.js`（Stooq.com 數據源，通過 Cloud Function 代理，備用）
  - `24_P5_DAILY_OHLCV_TWSE.js`（台股數據源，TWSE/TPEX 官方數據源，備用）
  - `24_P5_DAILY_TECHNICAL.js`（技術指標計算，程式公式計算）⭐ **分級計算優化**
  - `26_TEST_GOOGLEFINANCE.js`（GOOGLEFINANCE 測試工具）⭐ V8.0 新增
  - `24_P5_DAILY.js`（包含 `getHistoricalOHLCV` 函數，供 P3 使用）
- **功能**: OHLCV 數據收集、技術指標計算
- **⭐ 技術指標分級計算（優化）**：
  - **每日計算（輕量）**: Close vs MA(50,200), Volume vs Volume MA, 基礎破位檢測
  - **每週計算（完整）**: MACD, RSI, Bollinger Bands（由 P5 Weekly 觸發）
  - **節省約 80% 每日計算量**
- **⭐ 市場寬度數據收集（需補強）**：
  - Advance/Decline（上漲/下跌股票數量）
  - New High/Low（創新高/新低股票數量）
  - Stocks Above MA50/MA200（站上均線股票比例）
  - 用於 P5 Weekly Regime 分析
- **⭐ 數據來源（V8.33 目標架構：主來源可靠 API，GOOGLEFINANCE 僅備援）**：
  - **OHLCV 數據（目標架構）**：主來源 **yfinance / 可靠 API**（Python 實作）；GOOGLEFINANCE 僅作為 **P6 盤中備援** 或 **GAS 時代遺留**
  - **（GAS 時代）**：優先使用 GOOGLEFINANCE（免費、穩定），備用 stooq.com（通過 Cloud Function 代理）、TWSE/TPEX（台股官方數據源）
    * 美股：`NASDAQ:TICKER` 或 `NYSE:TICKER`（例如 `NASDAQ:NVDA`, `NYSE:TSM`）
    * 台股：`TPE:TICKER`（例如 `TPE:2330`）
    * 日股：先嘗試直接代碼（例如 `8035`），失敗再嘗試 `TYO:8035`（例如 `TYO:8035`）
    * ⚠️ **注意**：GOOGLEFINANCE 有非同步延遲，需使用 `fetchGoogleFinanceSafe` 和 `fetchGoogleFinanceHistorySafe` 等待機制
    * ⭐ **V8.0 修正（2026-01-17）**：
      - 等待時間延長至 20秒（40次重試，原本 10秒）
      - 匯率和日股需要更長暖機時間，已優化 ticker 格式（先嘗試直接代碼，失敗再嘗試前綴格式）
  - **技術指標計算**：使用程式公式計算，不讓 AI 計算（GOOGLEFINANCE 不支援技術指標）
  - **數據存儲**：保存到 `MARKET_OHLCV_DAILY` 和 `MARKET_INDICATORS_DAILY` 表格
  - **供 P3 使用**：P3 可以調用 `getHistoricalOHLCV` 函數讀取歷史 OHLCV 數據（優先從表格讀取，不足才從 GOOGLEFINANCE 或 stooq.com 補充）

##### **Daily 籌碼／衍生品蒐集（供 D-3、P2.5 引用）：衍生品期權數據 + 機構級籌碼面數據** ⭐ V8.0 修正（頻率優化）
- **檔案**: 
  - `24_P5_DAILY_DERIVATIVES.js`（期權數據，每日）
  - `24_P5_WEEKLY_SMART_MONEY.js`（籌碼數據，每週）⭐ 新增
  - `24_P5_DAILY_CORE.js`（整合邏輯）
- **執行頻率**:
  - **每日收集**：期權數據（VIX, SKEW, Put/Call Ratio, IV, 期權異常流向）
  - **每週收集**：內部人交易（SEC Form 4）、Dark Pool 活動（僅持倉 10-20 檔）
  - **季度收集**：13F 持倉（配合 P2.5 Quarterly）
- **功能**: 
  - 期權數據收集（每日）
  - VIX 情緒指標（每日）
  - 機構級籌碼面數據收集：
    * 內部人交易（每週）⭐ 修正
    * Dark Pool 活動（每週，僅持倉）⭐ 修正
    * 13F 持倉（季度）⭐ 修正
- **⭐ V8.0 變更**: 調整籌碼數據收集頻率，節省約 85% API 成本
- **輸出表格**: 
  - `DERIVATIVES_DAILY`（期權數據）
  - `SMART_MONEY_WEEKLY`（籌碼數據）⭐ 新增
- **使用者**: 
  - P2.5 月度/季度分析
  - P5 Weekly 籌碼面彙總 ⭐ 新增

---

#### 【GAS 時代遺留設計 - 已作廢，Python 不實作】

> [!WARNING]
> **以下 P5.4/P5.5/P5.6 為 GAS 時代設計，功能已完全搬移到 P6。**  
> **Python 實作時不需實作這三個模組，僅保留以供對照參考。**

##### **P5.4: 監測持股大幅度波動或突發黑天鵝新聞** ⚠️ **GAS 舊設計（已搬移到 P6）**
- **⭐ V8.0 變更**: P5.4 的盤中監控功能已完全搬移到 P6
- **原有功能**: 
  - 監測持股大幅度波動（單日跌幅 > 5%、3日累計跌幅 > 10%）
  - 檢測突發黑天鵝新聞（從 `NEWS_ATOMS_DAILY` 中篩選高重要性、負面新聞）
  - 檢查是否符合緊急撤退觸發條件
- **搬移後**：
  - **盤中監控與緊急撤退**：由 P6 負責（盤中執行，Rule-Based）
  - **日結後新聞分析**：仍由 P5 Daily 負責（新聞原子化、分類整理）

##### **P5.5: 財報事件監控與策略執行** ⚠️ **GAS 舊設計（盤中監控已搬移到 P6）**
- **檔案**: 
  - `13_P5_5_EARNINGS_WARFARE.js`（財報戰系統）
  - `18_P5_CALENDAR_MANAGER.js`（行事曆管理）
  - `27_EARNINGS_REVENUE_MANAGER.js`（財報/營收管理）
- **功能**:
  - **每週職責（P5 Weekly）**:
    * 檢查未來 2 週財報日曆
    * 制定 if-then 策略（例如：if 財報 Beat then 加碼）
    * 將策略傳遞給 P6 盤中監控
  - **盤中監控職責（P6）** ⭐ V8.0 新增：
    * **從 P5 Daily 搬移**：原本在 Daily 收盤後檢查是否符合 Weekly 的 if-then 策略中的 if 條件
    * **現在改為盤中監控**：P6 在盤中（每 20 分鐘 / 每 5 分鐘）監控財報公布後的市場反應
    * **監控對象**：
      - Tier 1: 直接持倉（15-20 檔）
      - Tier 2: 產業龍頭（20-30 檔）
      - Tier 3: 系統指標（15-20 檔）
    * **特殊情形**：非一般掛單，通常是該股有重大事件（例如財報公布）必須隨市場反應才決策，不能事先掛單的特殊情形
    * **如果 if 條件觸發** → 通知使用者執行
  - **每日職責（P5 Daily）**:
    * ❌ **已移除**：不再監控 if-then 策略條件（已搬移到 P6）
    * ✅ **保留**：財報數據收集、整理（如有需要）
- **⭐ V8.0 變更**: 
  - 盤中監控從 P5 Daily 搬移到 P6（改為盤中即時監控，不等收盤）
  - P5 Weekly 只負責策略制定，將策略傳遞給 P6 監控
  - P5 Daily 不再負責盤中監控任務

##### **P5.6: 台股當日目標價監控** ⚠️ **GAS 舊設計（已搬移到 P6）**
- **⭐ V8.0 變更**: P5.6 的盤中監控功能已完全搬移到 P6
- **原有功能**: 
  - 檢查台股當天 OHLCV 是否觸及買入/賣出價位
  - 提醒使用者（只有台股需要，美日股都可以提前掛單）
- **搬移後**：
  - **盤中目標價監控**：由 P6 負責（盤中執行，Rule-Based，每 20 分鐘檢查）
  - **台股特殊需求**：只有台股需要，美日股都可以提前掛單
- **檔案**: `17_TAIWAN_ORDER_MONITOR.js` 已廢棄，相關功能移至 `28_P6_INTRADAY_MONITOR.js`

---

### Phase 6：盤中監測系統（Intraday Risk Radar）⭐ **V8.0 新增**

#### **P6: 盤中風險監測與緊急撤退** ⭐ **V8.0 新增 + V8.15 增強**

- **檔案**: 
  - `28_P6_INTRADAY_MONITOR.js`（核心監測邏輯）
  - `28_P6_DATA_COLLECTOR.js`（GOOGLEFINANCE 數據收集）
  - `28_P6_EMERGENCY_EXIT.js`（盤中緊急撤退協議，從 P4.6 搬移）
  - `28_P6_TRAILING_STOP.js`（移動停利機制，V8.10 新增）⭐
  - `28_P6_SHADOW_MECHANISM.js`（20 分鐘動能追蹤：計算 20 分鐘價格變化；表格名 P6_SHADOW_PRICES 保留以兼容既有 schema）
  - `28_P6_DEFCON_ADJUSTER.js`（DEFCON 盤中調整）
  - `28_P6_LOGGER.js`（日誌記錄）
- **執行頻率**: 
  - **一般監測**：每 20 分鐘（台/日股開盤到收盤，美股加上盤前與盤後交易）
  - **選擇權個股**：每 5 分鐘（僅已持有的選擇權對應標的個股，僅盤中時段）
- **監控對象**：
  - **持倉股票**（最高優先級）：從 P4 最新快照讀取，通常 20-50 檔
  - **選擇權個股**（特殊頻率）：僅已持有的選擇權對應標的個股，每 5 分鐘
  - **主要指數**：S&P 500 (`INDEXSP:.INX`), NASDAQ (`INDEXNASDAQ:.IXIC`), 道瓊 (`INDEXDJX:.DJI`), 台股加權 (`TPE:^TWII`), 日經 (`TYO:^N225`)
  - **板塊 ETF**：SPDR Sector ETFs (XLK, XLF, XLE, XLV, XLI, XLP, XLY, XLU, XLB, XLRE, XLC)
  - **追蹤池股票**：從 Phase1_Tracking_Pool 讀取
- **數據來源**：**目標架構（V8.33）**：P6 可用快速來源或備援；主來源應為可靠 API。GAS 過渡：現行主要使用 GOOGLEFINANCE（免費、穩定、適合高頻監控）；新平台實作時見架構總覽「數據源」。
  - **⭐ 核心功能**：
  1. **盤中異常偵測**（Rule-Based，無 AI）：
     * 暴跌監測（單檔跌幅 ≥ 6%、20 分鐘急殺 ≥ 2%、組合跌幅 ≥ 5%、主要指數暴跌 ≥ 4%）
     * 暴漲監測（漲幅 ≥ 6% 且 ≥ 1.8×ATR、量能 ≥ 2.5 倍平均量）
     * 爆量監測（成交量 ≥ 2.5 倍 20 日平均量）
  2. **⭐ V8.10 新增：移動停利機制（Trailing Stop）**（Rule-Based，無 AI）：
     * **觸發條件**：當 P5.9 判定為 LATE（瘋狗浪）階段時自動啟動
     * **動態防守線**：以「最近 3 日最高價」為基準
     * **觸發門檻**：
       - 從最高點回落 **-4%**（或市場特定閾值：台股/美股 -4%，日股 -3.5%）
       - 跌破 **MA10**（連續 2 次監測確認）
       - 量能確認（美股要求爆量，台股/日股不要求）
     * **觸發後動作**：執行 P6 緊急撤退（減倉 50%，核心持倉最多減 30%）
     * **邏輯**：不猜頭部，但頭部出現後的第一根長黑，必須比別人都快跳車
     * **目標**：吃到魚身（最後一段漲幅），但避開崩盤（從最高點回落 > 4%）
     * **檔案**：`28_P6_TRAILING_STOP.js`（V8.10 新增）
  3. **20 分鐘動能追蹤（Shadow Mechanism，原殘影機制）**（Rule-Based，無 AI）：
     * 記錄每次監測的價格點
     * 計算 20 分鐘價格變化（當前價格 vs 20 分鐘前價格）
     * 用於判斷是否為「急殺」或「急漲」
  4. **盤中緊急撤退協議**（從 P4.6 完全搬移）：
     * **⚠️ 重要**：只有緊急事件的情況才需要決策
     * **Layer 1：寫死的即時防禦**（無 AI）
       - 觸發條件與對應動作完全寫死
       - 減倉比例固定（例如：單檔暴跌 6% → 減倉 50%）
       - 執行速度 < 1 秒
     * **Layer 2：盤後 AI 分析**（整合到 P5 Weekly）
       - 事件定性（黑天鵝？系統性風險？個股特定？）
       - 判斷是否過度反應
       - 調整策略建議
     * **Layer 3：人類 Override**
       - 確認或取消撤退計劃
       - 調整減倉比例
  4. **DEFCON 盤中調整**（Rule-Based，無 AI）：
     * Rule-Based 調整（不依賴 AI）
     * 根據盤中異常嚴重程度自動調整 DEFCON 等級
  5. **財報事件盤中監控**（從 P5.5 搬移）：
     * **從 P5 Daily 搬移**：原本在 Daily 收盤後檢查是否符合 Weekly 的 if-then 策略中的 if 條件
     * **現在改為盤中監控**：P6 在盤中（每 20 分鐘 / 每 5 分鐘）監控財報公布後的市場反應
     * **監控對象**：
       - Tier 1: 直接持倉（15-20 檔）
       - Tier 2: 產業龍頭（20-30 檔）
       - Tier 3: 系統指標（15-20 檔）
     * **特殊情形**：非一般掛單，通常是該股有重大事件（例如財報公布）必須隨市場反應才決策，不能事先掛單的特殊情形
     * **從 P5 Weekly 讀取 if-then 策略**：如果 if 條件觸發 → 通知使用者執行
  7. **目標價監控（台股）**（從 P5.6 搬移，Rule-Based，無 AI）：
     * **從 P5 Daily 搬移**：原本在 Daily 收盤後檢查台股是否觸及買入/賣出價位
     * **現在改為盤中監控**：P6 在盤中（每 20 分鐘）檢查台股是否觸及買入/賣出價位
     * **特殊需求**：只有台股需要，美日股都可以提前掛單
     * **如果觸及價位** → 立即提醒使用者
  8. **日誌記錄與數據保留**（Rule-Based，無 AI）：
     * 記錄所有異常事件到 `P6_INTRADAY_LOG`
     * 記錄緊急撤退計劃到 `P6_EMERGENCY_EXIT_LOG`
     * **⭐ 數據保留規則**：
       - **清除對象**：僅限 **P6 產出之一般監測數據**（未標記需保留者）；**不包含**已寫入「共用 OHLCV 表」的資料（共用表保留策略由其他模組管理）。
       - **清除時機**：**本週策略產出完成後**（例如 P5 Weekly 產出並寫入完成後），清除**上一個完整交易週**的一般數據；當週剛分析完的數據不刪。清除前須確認 Daily/Weekly 已讀取並整合「需保留」數據；建議清除鎖（Daily 完成寫入後解鎖，P6 才執行清除）。
       - **保留長度**：一般監測數據**至少保留兩週**（可依存儲成本保留更長）。
       - **觸發異常的情況**：必須保留當天詳細數據，一同進入 P5 Daily 留存的日更資料
         * 觸發急漲/急跌的個股或市場（暴跌 ≥ 6%、暴漲 ≥ 6%、急殺 ≥ 2%、爆量 ≥ 2.5 倍等）
         * 觸發緊急撤退協議的個股
         * 觸發財報 if-then 策略的個股
         * 觸及目標價位的台股（買入/賣出價位）
       - **數據整合流程**：
         * P6 盤中檢測到異常 → 標記為「需保留」
         * P5 Daily 執行時（收盤後）→ 讀取 P6 標記為「需保留」的數據
         * 整合到 `MARKET_OHLCV_DAILY` 或專門的 `P6_INTRADAY_ALERTS_DAILY` 表格
         * P6 在本週策略產出完成後清除**上週**一般數據（保留異常數據的引用，詳細數據在 Daily 表格中）
- **⭐ 設計原則**：
  - **⚠️ 核心原則**：平常正常監控根本用不到 AI 模型（Rule-Based 即可）
  - **⚠️ 重要**：只有緊急事件的情況才需要決策
    * **盤中 = 防災演習 → SOP（Rule-Based）**：寫死的即時防禦，無 AI 參與
    * **盤後 = 調整戰略 → AI（整合到 P5 Weekly）**：緊急事件發生後，由 P5 Weekly 的 AI 分析事件定性、判斷是否過度反應、調整策略建議
  - **不做**：盤中交易決策、AI 判斷、頻繁訊號、正常監控使用 AI
  - **只做**：異常偵測、風險警報、緊急撤退觸發、財報事件盤中監控、目標價監控（台股，從 P5.6 搬移）— 全部使用 Rule-Based 邏輯
- **⭐ 數據整合與保留**：
  - **清除對象**：僅限 **P6 產出之一般監測數據**；**不包含**已寫入共用 OHLCV 表的資料。
  - **清除時機與保留長度**：**本週策略產出完成後**清除**上週**一般數據；**至少保留兩週**。當週數據不刪。
  - **一般正常情況**：P6 盤中監測數據（無異常）→ 依上規則於策略產出後清除上週，保留至少兩週。
  - **觸發異常的情況**：
    * P6 盤中檢測到異常（急漲/急跌、緊急撤退、財報觸發、目標價觸及等）→ 標記為「需保留」
    * P5 Daily 執行時（收盤後）→ 讀取 P6 標記為「需保留」的數據
    * 整合到 P5 Daily 的當天資訊中：
      - 詳細數據保存到 `MARKET_OHLCV_DAILY` 或專門的 `P6_INTRADAY_ALERTS_DAILY` 表格
      - 異常事件摘要保存到 Daily 日誌
    * P6 在本週策略產出完成後清除上週一般數據（但保留對 Daily 表格的引用）
  - **策略制定整合**：
    * P6 記錄（異常事件）→ 成為 P5 Weekly 制定策略的來源之一
    * P6 異常事件 → 標記為「盤後強制檢查」，由 P5 Weekly AI 分析（僅在緊急事件發生時）
- **⭐ 職權分工**：
  - **P6**：盤中監測、盤中緊急撤退協議、盤中緊急撤退執行、財報事件盤中監控、目標價監控（台股，從 P5.6 搬移）（全部 Rule-Based，無 AI）
  - **P5 Daily**：數據收集與整理（收盤後執行）、整合 P6 異常數據到日更資料
  - **P5 Weekly**：盤後 AI 分析緊急事件、長期調整建議（戰略層面，AI 參與）
  - **P4.6**：已完全移除，所有功能已統整到 P6
- **成本**：$0（GOOGLEFINANCE + Rule-Based 邏輯，無 AI Token 成本，僅在緊急事件發生後由 P5 Weekly 進行盤後 AI 分析）
- **⭐ V8.15 待實現：緊急退出條件更新** ✅ **已實現**
  - **✅ 已實現**：FRONTIER Runway 檢查（在 `applyFrontierRunwayGate()` 中實現，`Runway < 4` 且 `Safety=X` → 標記為 REJECT）⭐ V8.17 確認
  - **✅ 已實現**：驗證里程碑未達成檢查（`P6_CheckMilestoneFailure()` 和 `P6_TriggerMilestoneFailureExit()` 在 `28_P6_MILESTONE_CHECK.js` 中實現，觸發 P6 緊急退出）⭐ V8.17 完成
  - **✅ 已實現**：產業鏈背離訊號（`DIVERGENCE_ALERT` 在 P3 中計算 `risk_overlay_level = 2`，影響 Cat 權重）⭐ V8.17 確認
  - **詳細設計**：請參考 `V8.15_P3-P6更新補充_SSOT.md` 和 `P3-P6更新建議報告_V8.15.md`

#### **⚠️ P6 明文規範（防止未來走偏）** ⭐ V8.0 新增

**P6 唯一職權（嚴格限制）：**

  1. **盤中感測**（price / volume / range / proxy macro）
   - 使用 GOOGLEFINANCE 批量讀取價格、成交量、變化百分比
   - 使用 20 分鐘動能追蹤計算 20 分鐘價/量變化
   - 使用前一日的 ATR14 計算波動度門檻
   - 雙向監控：暴跌（% + ATR 兩層門檻）+ 暴漲（% + ATR 兩層門檻）

2. **狀態標記**（Append-only，寫入事件表）
   - 記錄異常到 `P6_INTRADAY_ALERTS_DAILY`（需保留的數據）
   - 記錄一般監測到 `P6_INTRADAY_LOG`（隔天清除）
   - 記錄緊急撤退到 `P6_EMERGENCY_EXIT_LOG`
   - 所有記錄為 Append-only，不修改歷史數據

3. **通知你**（LINE Bot / Email）
   - 發送異常警報
   - 發送緊急撤退計劃
   - 發送目標價到價提醒

**P6 永遠不做（明文禁止）：**

* ❌ 不自動下單
* ❌ 不改 P3 掛單
* ❌ 不改 P4 配置
* ❌ **不讓 AI 即時裁決**（盤中任何決策不得調用 AI）
* ❌ 不回寫 P0-P5 結論（完全對齊 SSOT 的 One-Way 架構）

**AI 僅能在盤後使用（明文規定）：**

* ✅ **P5 Daily / P5 Weekly 盤後報告**讀取 P6 事件表 → 作為"世界觀風險註記"
* ✅ **P3 下次週更**時讀取上週 P6 事件頻率 → 用來調整"信心/風險註記"，但**不改 P2 結論、不回寫 P0-P2**
* ✅ **P5 Weekly** 使用 P6 事件作為輔助因子，進行盤後戰略分析

**設計原則總結：**

> **P6 像地震儀：只記錄震動  
> P5 像氣象站：解釋天氣  
> P3 像交易官：下週調整掛單（仍然週更）**

- **⭐ V8.15 待實現：緊急退出條件更新** ✅ **已實現**
  - **✅ 已實現**：FRONTIER Runway 檢查（在 `applyFrontierRunwayGate()` 中實現，`Runway < 4` 且 `Safety=X` → 標記為 REJECT）⭐ V8.17 確認
  - **✅ 已實現**：驗證里程碑未達成檢查（`P6_CheckMilestoneFailure()` 和 `P6_TriggerMilestoneFailureExit()` 在 `28_P6_MILESTONE_CHECK.js` 中實現，觸發 P6 緊急退出）⭐ V8.17 完成
  - **✅ 已實現**：產業鏈背離訊號（`DIVERGENCE_ALERT` 在 P3 中計算 `risk_overlay_level = 2`，影響 Cat 權重）⭐ V8.17 確認
  - **詳細設計**：請參考 `V8.15_P3-P6更新補充_SSOT.md` 和 `P3-P6更新建議報告_V8.15.md`

**雙向監控設計（% + ATR 兩層門檻）：**

- **A. 暴跌事件（Risk Containment）**：
  * **觸發條件（同時滿足）**：
    - Pct 門檻：`changePct <= -X%`（建議 X=5 或 6）
    - ATR 門檻：`abs(price - prevClose) >= 1.6 * ATR14`
    - 可選加權：爆量 `volume >= 2.0 * volumeAvg20`
  * **觸發後動作（寫死）**：
    - `state = INTRADAY_DOWNSHOCK`
    - LINE 通知
    - 寫入事件表（append）
    - **不賣、不改單、不動倉**（只負責提醒與記錄）

- **B. 暴漲事件（Overextension）**：
  * **觸發條件（同時滿足）**：
    - Pct 門檻：`changePct >= +Y%`（建議 Y=6 或 8）
    - ATR 門檻：`abs(price - prevClose) >= 1.8 * ATR14`
    - 可選加權：爆量 `volume >= 2.5 * volumeAvg20`
  * **觸發後動作（寫死）**：
    - `state = INTRADAY_UPSHOCK`
    - LINE 通知
    - 寫入事件表（append）
    - **凍結追價類操作旗標**（例如在系統狀態表寫 `CHASE_FREEZE=TRUE`，只影響手動與盤後流程，不影響既有掛單）

**ATR14 來源：**

* **一律用日線留存資料計算**（前一日的 ATR14，從 `MARKET_INDICATORS_DAILY` 讀取）
* P6 盤中只拿「當下 price / high / low / volume」，拿不到也沒關係
* 因為 ATR 是「門檻」，用昨日 ATR 完全合理（盤中用當日 ATR 反而不穩）

**GOOGLEFINANCE 批量讀取優化：**

* 在 `SYS_G_FINANCE_PROXY` 放一整塊表格
* 一次塞入 50~100 檔公式
* `flush()` → 等待 → 一次讀回 range
* 再做計算與檢測
* 這樣：速度快、配額省、不容易讀到上一檔殘值造成「同價污染」

**三段式污染偵測：**

1. **基本合法性**：price 是否為數字、是否在合理範圍（>0 且 <1e6）、價格變化是否合理（單日不應超過 ±50%）
2. **跨資產 sanity check**：商品/匯率/利率不應共享同一價格
3. **短期一致性**：同一 ticker 連續兩次讀取差異不應為 0 且同時多 ticker 完全相同（可用"同值比例"檢查）

只要偵測到污染：
* 這次 ticker 結果直接標 `INVALID_DATA`
* 不要卡住整個 pipeline（可持續運行比完美抓到所有值更重要）

---

#### **P5 Weekly: 策略制定**（每週執行）⭐ V8.18 增強（訂單保鮮期管理、財報前強制清倉、掛單滑價優化、拋物線清倉）
- **心法定位** ⭐ V8.29：P5 定位為「**機率校準器**」；整合世界觀、權重與硬約束，產出掛單策略與 Order DSL；Learning constraints override strategy preferences。

##### **P5.7: 本週數據分析並世界觀統整** ⭐ V8.0 增強（籌碼面週報 + Sector ETF Flow 分析 + Mag 7 集體表現分析 + Regime 分析補強）
- **檔案**: `24_P5_WEEKLY_WORLDVIEW.js`
- **功能**: 
  - 統整整週的結論（Daily 數據蒐集 D-1～D-4 輸入、P6 等）
  - 更新週世界觀
  - 分析跟前幾週的世界觀連接或背離程度
  - 統整整週的結論（Daily 數據蒐集 D-1～D-4 輸入、P6 異常記錄）⭐ V8.0 修正：P5.4、P5.5、P5.6 的盤中監控已搬移到 P6
  - ⭐ **新增：籌碼面週報彙總**
    * 本週內部人交易異常（從 Daily 籌碼／衍生品蒐集，週度）
    * 本週期權流向總結（從 Daily 籌碼／衍生品蒐集，每日）
    * 本週 Dark Pool 活動（從 Daily 籌碼／衍生品蒐集，週度）
    * 輸出：籌碼面信號（BULLISH/NEUTRAL/BEARISH）
  - ⭐ **新增：Sector ETF Flow 分析**
    * 從 `SECTOR_ETF_DAILY` 讀取數據
    * 計算 5 日/20 日資金流向、momentum
    * 識別資金輪動、Rotation Signal（RISK_ON/RISK_OFF/ROTATION/CRISIS）
    * 整合到世界觀分析中
  - ⭐ **整合 P6 異常記錄**（V8.0 新增）：
    * 本週 P6 盤中異常事件（從 `P6_INTRADAY_ALERTS_DAILY` 讀取）
    * 本週緊急撤退記錄（從 `P6_EMERGENCY_EXIT_LOG` 讀取）
    * 整合到世界觀分析中，作為策略調整的參考
  - ⭐ **新增：Mag 7 集體表現分析**（V7.1 補充手冊整合）
    * Mag 7 成員：AAPL, MSFT, GOOGL, AMZN, NVDA, META, TSLA
    * 每檔財報評分：+2（Beat + 指引上調）、+1（Beat + 持平）、0（符合）、-1（Miss + 持平）、-2（Miss + 下調）
    * 總分範圍：-14 to +14
    * Regime 映射：+10 to +14 = BULL_STRONG（U_macro 0.80）、-14 to -10 = BEAR_STRONG（U_macro 0.30，DEFCON 1）
    * 整合到 Regime 判斷和 U_macro 調整中
    * 在財報季結束後（4-6 週）綜合評估
  - ⭐ **Regime 分析補強**：
    * Regime 類型包含：BULL_STRONG、BULL_WEAK、RANGE（震盪）、BEAR_WEAK、BEAR_STRONG
    * 使用市場寬度數據（Advance/Decline、New High/Low、Stocks Above MA50/MA200）
    * 實現 Regime 準度追蹤機制（保存預測、7 天後驗證、計算準度，目標 80%）
    * 輸出格式包含：`regime_transition`（維持概率、轉換概率）、`risk_assessment`（系統性風險評估）

##### **P5.8: DEFCON 動態對沖系統決定策略** ⭐ V6.0 原始設計 + V8.0 增強（結合籌碼面）
- **檔案**: 
  - `24_P5_WEEKLY_CORE.js`（核心邏輯）
  - `07_DEFCON_SYSTEM.js`（DEFCON 系統）⭐ **V6.0 原始設計**
  - `11_P4_5_DYNAMIC_HEDGING.js`（動態對沖）
- **功能**: 
  - **DEFCON 等級評估（V6.0 原始設計）**：
    * DEFCON 1-5 等級系統
    * 信號權重矩陣（VIX、Put/Call Ratio、Skew、FEAR_GREED 等）
    * 自動觸發機制
  - **動態對沖策略調整**
  - ⭐ **結合籌碼面信號（V8.0 增強）**：籌碼面 BEARISH → 提高 DEFCON

##### **P5.9: 泡沫監控系統決定總資金水位高低（可選）** ⭐ V8.0 調整 → **⭐ V8.10 戰略升級**
- **檔案**: 
  - `24_P5_WEEKLY_CORE.js`（整合邏輯）
  - `14_P5_6_BUBBLE_NAVIGATION.js`（泡沫監控系統）
  - `24_P5_SHARED.js`（U 調整邏輯）
- **功能**: 
  - 調用泡沫監控系統，根據泡沫階段決定 U 調整：
    - **EARLY**: U 不變或微調（維持高水位）
    - **MID**: U 降低 10-20%（謹慎加碼）
    - **⭐ V8.10 修正：LATE（瘋狗浪）**: **U 不強制降低，維持高水位（80-100%）**，系統進入「走鋼索模式（Tightrope Mode）」
      - **邏輯轉變**：承認 AI 工業革命級典範轉移，只要趨勢線（MA10/MA20）未破、機構籌碼（Daily 籌碼蒐集）未撤，就假設泡沫會無限延伸
      - **風險平衡**：P6 自動切換為「移動停利（Trailing Stop）」機制（從最近 3 日最高價回落 -4% 或跌破 MA10 觸發緊急撤退）
    - **BURST**: U 降低至最低（例如 30%），緊急撤退
  - **⭐ V8.10 新增：三層泡沫框架**
    - **Layer 1（定價是否昂貴）**：估值類指標（Forward P/E、CAPE、EV/FCF、調整後市值/GDP）
      - 用途：判斷「報酬是否被透支」，但**不做下車訊號**
      - 動態調整：考慮全球化溢價（海外營收占比）、無形資本、利率/ERP 動態估值合理性
    - **Layer 2（是否進入泡沫行為學）**：情緒/槓桿/交易狂熱（融資餘額、期權投機強度、成交周轉率、IPO/增發熱度、散戶槓桿、媒體敘事一致性）
      - 用途：比估值更準確的泡沫識別
      - 影響：調整「加碼方式與倉位結構」，而非「是否投資」
    - **Layer 3（是否出現結構性脆弱）**：市場廣度（少數 AI 股撐盤 vs 全面上漲）、集中度（前幾大權重占比）、波動/相關性（一起跌的風險）
      - 用途：決定「風險控管是否升級」
      - 影響：影響「最大回撤容忍」硬約束
  - **⭐ V8.10 新增：真實成長檢驗（生產力驗證）**
    - **執行時機**：P5 Weekly 每週執行時，對所有持倉股票進行成長檢驗
    - **數據來源**：從 P2 財務數據（`Phase2_Output` 表格）讀取：
      - **營收成長率**（`Revenue_YoY`）：最低要求 20%（美股）或 15%（台股/日股）
      - **CapEx/營收占比**：最低要求 15%（美股）或 12%（台股/日股）（需要從財務數據計算）
      - **毛利/營益率擴張**：要求毛利/營益率為正（簡化版本，需要歷史數據比較才能判斷是否擴張）
      - **現金流為正**：要求 CFO 或 FCF 為正
    - **檢驗邏輯**（Rule-Based，純程式，不需要 AI）：
      - 如果營收成長率 < 最低要求 → 警告
      - 如果現金流未為正 → 警告
      - 如果毛利/營益率未為正 → 警告
      - 如果 CapEx/營收占比 < 最低要求 → 警告（如果無法獲取數據，只記錄警告，不視為失敗）
    - **判定標準**：
      - 所有關鍵指標（營收成長率、現金流、毛利/營益率）都符合要求 → **通過（Pass）**
      - 任一關鍵指標不符合要求 → **失敗（Fail）**
    - **失敗後動作**：
      - 如果成長檢驗失敗，即使估值高也視為 **BURST（垃圾泡沫）**
      - 建議剔除失敗的股票（記錄到 `trigger_decisions` 中，建議 P4 剔除）
      - 只有通過檢驗的「真成長股」，才適用「不減倉策略」
    - **範例**：
      - **通過（Pass）**：2025 年 NVDA PE 50 倍，營收成長 80%，現金流為正 → 繼續持有
      - **失敗（Fail）**：某 AI 概念股 PE 100 倍，營收成長 5%，現金流為負 → 建議剔除
    - **檔案**：`24_P5_WEEKLY_GROWTH_VALIDATION.js`（V8.10 新增）
  - 將 U 調整記錄到快照或配置中
- **⭐ V8.0 變更**: 從獨立模組整合到 P5 Weekly，時機更合適
- **⭐ V8.10 核心哲學轉變**：
  - **從「左側減倉」→「右側動態鎖利」**：在泡沫末期，不因為「貴」而賣出，只因為「破」而離場
  - **從「估值預測」→「動能跟隨」**：以「流動性」取代「估值」，監控「資金水龍頭」是否關閉
  - **從「固定閾值」→「動態風險預算」**：讓泡沫監控影響「加碼方式與倉位結構」，而非「是否投資」
  - **索羅斯式泡沫論**：「當我看到泡沫形成時，我會衝進去買，而不是賣出」→ 只要 P6 沒有觸發「暴跌離場」，就假設泡沫會繼續吹大

##### **Weekly_final: 制定本週策略** ⭐ V8.0 增強（籌碼面影響 + AI 動態權重 + Hitchhiking 監控 + 財報日個股籌碼權重加強 + V8.9 機構評級歷史動態學習 + ⭐ V8.12 個股新聞索引整合 + ⭐ V8.12 Weekly系統優化整合 + ⭐ V8.13 動態學習系統補強 + ⭐ V8.15 雙層架構設計 + ⭐ V8.15 工程增強修改建議）
- **⭐ Weekly 實作指引**：**目標架構**為 **WB-1 / WB-2 / W-A**（見下）；新系統（如 Python）應**直接實作 WB-1/WB-2/W-A**，不帶入 P5-B/P5-A。**GAS 現行**為 P5-B/P5-A 雙層架構，僅供對照與既有程式維護；詳見**附錄：GAS 時代／現行設計對照（僅供對照，實作以目標架構為準）**。
- **⭐ V8.30 定案：新設計 WB-1 / WB-2 / W-A 流程與產出**（目標架構）
  - **執行順序**：**WB-1 宏觀** → 若世界觀劇變則 **W-A 審查** → 通過則 o3 重建 NEW_WORLDVIEW_FRAMEWORK → **WB-1 個股**（每檔狀態快照 + escalation 判定）→ 若個股觸發 escalation 則 **W-A 個股審查**（產出審查報告）→ 該股 **P1–P4 完整更新** → **WB-2**（在已確定世界觀下，對兩類個股產出本週策略與掛單）。
  - **WB-1**：分析 Hermes 4 405B；無審查（沒觸發時無審查）。宏觀：統整與分析當週宏觀、連結上週世界觀、產出當週世界觀快照、劇變與否。個股：融合分析本週個股新資訊、產出當週個股狀態快照、escalation 與否（硬觸發 P2.5 + 軟觸發 escalation_score ≥ 0.6，邏輯與現行 `calculateEscalationScore()` 一致）。
  - **WB-2**：分析 Hermes 4 405B；審查 o3（原廠 batch）。輸入：當前世界觀（B1 或 NEW_WORLDVIEW_FRAMEWORK）+ 兩類個股（輕度：未觸發 escalation；重度：已觸發 + W-A 審查報告 + P1–P4 更新）+ Delta Pack、Learning、記憶包、行事曆、Sector Flow/Mag7。產出：Strategy Skeleton（程式產生）+ parameter_adjustment_vector、Validator 驗證、weekly_trade_actions；重度路徑 Prompt 須強調該股異常、附 W-A 審查報告、要求產出新策略與舊策略緊急調整結論。
    - **⭐ Strategy Skeleton 生成公式**（程式計算，AI 不得修改結構）：
      - **Buy Ladder**：
        - `B1 = support_1 - (0.5 * ATR)`（k1 = 0.5，第一層買入）
        - `B2 = support_2 - (0.3 * ATR)`（k2 = 0.3，第二層買入）
        - `B3 = support_2 - (0.5 * ATR)`（k3 = 0.5，第三層買入）
      - **Sell Ladder**：
        - `S1 = resistance_1 + (0.3 * ATR)`（k3 = 0.3，第一層賣出）
        - `S2 = trailing_stop`（追蹤停利，動態計算）
      - **AI 僅輸出** `parameter_adjustment_vector`：`buy_bias`、`sell_bias`、`ladder_spacing_adjustment`、`trailing_stop_tightness`、`max_position_cap_override`
      - **實際掛單價格** = Skeleton 基礎價格 * (1 + bias * 0.1)
      - **實作位置**（GAS 對照）：`gas_archive/src/24_P5_WEEKLY_STRATEGY_SKELETON.js:28-124`（`generateStrategySkeleton` 與 `applyParameterAdjustmentVector` 函數）
  - **W-A**：僅被觸發時工作；o3（不 batch）。① **世界觀劇變**：審查 WB-1 重建要求是否正確合理 → 審查報告 → 若通過則 o3 重建 NEW_WORLDVIEW_FRAMEWORK（worldview_version_bump、new_assumption_set、new_risk_transmission_graph、deprecated_heuristics、updated_watchlist），寫入版本化快照。② **個股 escalation**：審查觸發原因 + 當前世界觀 + 該股歷史與資料 → 審查報告（嚴重問題與原因、重點變化，可機器讀取、供 WB-2 與 Learning 使用）→ 該股 P1–P4 更新 → WB-2 重度更新。
  - **W-A 觸發個股重跑範圍**：**P1–P4**（不含 P0）。產業論述（P0）不涉及個股，產業面變化已有季度與重跑機制。
  - **⭐ V8.42 escalation 狀態標記（WB-2 重度路徑判斷）**：任何經 escalation 重跑 P1–P4 的個股，**必須**產出 `escalation_path = true` 與對應 `snapshot_id`；**WB-2 只依此標記判斷重度路徑**（不另加流程）。
  - **AI 模型**：見上「模型配置表」⭐ V8.30 新設計欄位。
- **⭐ V8.15 待實現：Strategy Skeleton + AI Parameter Layer** ✅ **已實現**
  - **✅ 已實現**：Strategy Skeleton（策略骨架）：由程式生成，AI 不得修改結構（包含 `buy_ladder`、`sell_ladder`、`risk_frame`）（在 `24_P5_WEEKLY_STRATEGY_SKELETON.js` 中實現）
    - 來源：支撐壓力、趨勢結構（來自 P3 Snapshot）、ATR、價格（來自 P5 Daily / Weekly）
  - **✅ 已實現**：AI 只輸出「參數調整向量」：`parameter_adjustment_vector`（`buy_bias`、`sell_bias`、`ladder_spacing_adjustment`、`trailing_stop_tightness`、`max_position_cap_override`）
  - **✅ 已實現**：實際掛單價格 = 程式套公式算出（AI 不輸出價位）（在 `applyParameterAdjustmentVector()` 中實現）
  - **✅ 已實現**：導入 Strategy Skeleton 概念，修改 AI Prompt，程式根據 Skeleton + Adjustment Vector 計算實際掛單價格（⭐ V8.17 確認完成）
- **⭐ V8.15 待實現：Weekly Snapshot 必須納入的資料** ✅ **已實現** + **⭐ V8.16 更新（Delta Pack 設計）**
  - **✅ 已實現**：P0–P2 Snapshot（只讀）、P3 上一版結論、Daily 新聞索引（摘要）
  - **✅ 已實現**：Chain Dynamics Monitor JSON（若該產業啟用）完整讀取（在 `integrateStockFactors()` 中讀取 `p0_5_data.chain_monitor`）⭐ V8.17 確認
  - **✅ 已實現**：Dynamic Learning System：`getLearningFeedback()` 已實現，從 `LEARNING_STATE` 表格讀取學習系統反饋（`principles_summary`、`recent_reflections`、`similar_failure_cases`、`safety_lock_recommendations`、`parameter_bias_adjustment`）⭐ V8.17 確認
  - **✅ 已實現**：重大財經行事曆：FOMC / CPI / 非農、板塊龍頭財報（`getP5WeeklyCalendar()` 已實現，從 `P5_Calendar_ScanNextTwoWeeks()` 讀取）⭐ V8.17 確認
  - **✅ 已實現**：三大行事曆數據流完整性（⭐ V8.17 完成）：
    - **重大財經事件（P5__CALENDAR）**：
      - Input：用戶輸入 / AI 生成，包含五年歷史市場反應（`historical_performance_json`、`P5__CALENDAR_HISTORY`）、建議加強監控數據（`tracking_recommendations_json`、`risk_warnings_json`、`monitoring_suggestions_json`）
      - Weekly 掃描：`P5_Calendar_ScanNextTwoWeeks()` 每週掃描下兩週事件，自動觸發關鍵數據監控（前10-14天）和強化分析（前7天）
      - Output：Daily 關鍵數據監控（`P5__CALENDAR_ALERTS` 表格保存異常警報），Weekly 決策要點（`eventHistoricalContext` 傳遞給 P5-B/A，最高權重規則）
    - **板塊龍頭財報（EARNINGS_CALENDAR）**：
      - Input：用戶輸入 / AI 生成歷史經驗（`27_EARNINGS_HISTORICAL_EXPERIENCE.js` 使用 Gemini Flash 3.0），包含五年歷史市場反應（`historical_experience_json`、`EARNINGS_HISTORICAL_EXPERIENCE` 表格）
      - Weekly 掃描：`scanEarningsAndRevenueDates()` 每日掃描，財報前 14/7/3/1 天觸發分析，財報後3-7天收集市場反應
      - Output：Daily 關鍵數據監控（`P5_5_EARNINGS_RISK` 表格保存分析結果），Weekly 決策要點（整合到 `earnings_calendar`，傳遞給 P5-B/A）
    - **持股財報（HOLDINGS_EARNINGS_CALENDAR / EARNINGS_CALENDAR）**：
      - Input：P4 完成後 AI 自動生成（`27_HOLDINGS_EARNINGS_COMPLETE.js`，一次完成：五年歷史經驗 + 預估今年財報日期），Daily 新聞更新（`27_HOLDINGS_EARNINGS_NEWS_UPDATER.js` 使用 AI 分類 `Earnings_Date_Announcement`，不再使用關鍵字）
      - Weekly 掃描：與板塊龍頭財報共用 `scanEarningsAndRevenueDates()`
      - Output：與板塊龍頭財報相同的輸出機制
  - **✅ 已實現**：上週策略執行結果：是否成交、持股變化、平均成本（`getPreviousStrategyResults()`、`getCurrentPositions()`、`getOpenOrders()` 已實現）⭐ V8.17 確認
  - **✅ 已實現**：P0.5 快照讀取（`getLatestP0_5Snapshot()` 已實現，在 `collectP5WeeklyAllData()` 中收集，在 `integrateStockFactors()` 中使用）⭐ V8.17 確認
  - **✅ 已實現**：P2.5 快照讀取（`getLatestP2_5Snapshot()` 已實現，在 `collectP5WeeklyAllData()` 中收集，在 `integrateStockFactors()` 中使用）⭐ V8.17 確認
  - **⭐ V8.16 新增：Delta Pack 設計** ✅ **已實現**
    - **✅ 已實現**：Delta Pack 生成邏輯（在 `24_P5_WEEKLY_DELTA_PACK.js` 中實現，包含 `buildDeltaPack()` 函數）⭐ V8.17 確認
    - **✅ 已實現**：變動分三層（Market / Sector / Stock）
    - **✅ 已實現**：變動閾值配置（在 `DELTA_PACK_CONFIG` 中定義）
    - **✅ 已實現**：變動摘要格式（三段式：What changed、Why it changed、So what）
    - **✅ 已實現**：在 `24_P5_WEEKLY_DUAL_LAYER.js` 中使用 Delta Pack（在 `buildP5_BUserPayloadForBatch()` 和 `buildP5_AUserPayloadForBatch()` 中調用 `buildDeltaPack()`）
- **⭐ V8.15 待實現：動態學習系統在 Weekly 的角色明確化** ✅ **已實現** + **⭐ 工程師修復：學習系統斷鏈**
  - **原則**：學習不是改策略，學習是調整信任度與偏好；學習影響的是「參數邊界」，不是策略結構
  - **✅ 已實現**：V8.13 動態學習系統設計（策略比對機制），`compareStrategyWithReality()` 已實現
  - **✅ 已實現**：`learning_feedback` 結構整合到 Weekly 輸出（在 `collectP5WeeklyAllData()` 中調用 `getLearningFeedback()`，包含 `principles_summary`、`recent_reflections`、`similar_failure_cases`、`safety_lock_recommendations`、`parameter_bias_adjustment`）⭐ V8.17 確認
  - **⭐ 工程師修復：學習系統斷鏈** ✅ **已修復**
    - **問題**：`getLearningFeedback()` 有寫入但沒有在 Prompt 中使用，導致系統會不斷重複犯同樣的錯誤
    - **修復**：在 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 中添加 `learning_feedback` 到上下文數據，並添加明確的指令要求 AI 參考學習反饋
    - **實現位置**：`src/24_P5_WEEKLY_DUAL_LAYER.js` 中的 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 函數
    - **指令要求**：AI 必須參考 `Parameter_Bias_Adjustment`、`Safety_Lock_Recommendations`、`Recent_Reflections`、`Similar_Failure_Cases`
- **⭐ V8.17 新增：P5 Weekly Memory Manager 三層記憶模型** ✅ **已實現**
  - **實現位置**：`src/24_P5_WEEKLY_MEMORY_MANAGER.js`
  - **核心功能**：`buildWeeklyMemoryPack()` 函數組裝三層記憶包
  - **三層記憶模型**：
    - **L1: Short-Term Memory (STM)**：最近 6 週完整保留
      - 實現函數：`readShortTermMemory(weeks = 6)`
      - 數據來源：`P5__STRATEGY_SNAPSHOT` 表格
      - 內容：完整的策略快照和執行摘要
    - **L2: Mid-Term Memory (MTM)**：7-12 週壓縮為「Decision → Outcome → Lesson」
      - 實現函數：`readMidTermMemory()`
      - 數據來源：`P5__STRATEGY_SNAPSHOT` 和 `P5__OUTCOME_SNAPSHOT` 表格
      - 內容：壓縮格式（Decision → Outcome → Lesson），不保留推理細節
    - **L3: Long-Term Memory (LTM)**：超過 12 週，只保留教訓
      - 實現函數：`readLongTermMemory()`
      - 數據來源：`P5__OUTCOME_SNAPSHOT` 表格
      - 內容：每週最多 1-2 條「可遷移教訓」
  - **記憶壓縮機制**：
    - 實現函數：`compressAndArchiveOldMemory()`
    - 自動執行：每次讀取記憶時自動壓縮舊記憶
    - 防止無限膨脹：確保單個 Cell 不超過 50,000 字限制
  - **⭐ 目標架構（DB）下**：記憶庫改為 **append-only 或版本化表**；「壓縮」改為「**歸檔或摘要**」，可依排程（每週/每月）跑歸檔任務，或讀取時按時間窗過濾（最近 N 週完整、較舊的摘要）；**不必**每週覆蓋寫入，符合換平台最佳方式。
  - **I/O 對接完整性**：
    - **輸入來源**：
      - `P5__STRATEGY_SNAPSHOT`：策略快照（每週保存）
      - `P5__OUTCOME_SNAPSHOT`：結果快照（每週保存）
      - `P5__LEARNING_STATE`：學習狀態（Principles Summary）
    - **輸出使用**：
      - 在 `collectP5WeeklyAllData()` 中調用 `buildWeeklyMemoryPack()` 生成記憶包
      - 記憶包傳遞到 `context.memory_pack`
      - 在 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 中使用記憶包
      - 在 `buildStockStrategyBatchPrompt()` 中使用記憶包
    - **✅ 已確認**：記憶包的 I/O 對接完整，從數據庫讀取 → 組裝 → 提供給 AI 使用
- **⭐ V8.15 待實現：Sector ETF Flow 與 Mag 7 分析** ✅ **已實現**
  - **✅ 已實現**：Sector ETF Flow 分析（V8.12）
  - **✅ 已實現**：Mag 7 分析（V8.0 設計）
  - **✅ 已實現**：P5-B Input 明確新增：`macro_flow_context`（`sector_etf_flow`、`mag7_relative_strength`）
  - **✅ 已實現**：P5-B Prompt 補強：在判斷 `momentum_shift` 時，Sector ETF Flow 與 Mag7 相對強弱為高優先權因子（⭐ V8.17 完成）
- **⭐ V8.15 待實現：P2.5 異常 → Escalation Gate 硬觸發** ✅ **已實現**
  - **✅ 已實現**：P2.5 籌碼面數據讀取（`smartMoneyData`），籌碼面因子計算
  - **✅ 已實現**：Escalation Gate 修改（硬觸發）：`p2_5.insider_selling_alert === true` 或 `p2_5.abnormal_13f_distribution === true` → 直接觸發 P5-A（`escalation_score = 1.0`，強制升級）（在 `calculateEscalationScore()` 中實現）
  - **✅ 已實現**：輸出標記：`forced_escalation`（`trigger`、`type`、`confidence`、`note`）（⭐ V8.17 確認完成）
- **⭐ V8.15 待實現：最終產出（對齊 IB 批次下單）** ✅ **已實現** + **⭐ 工程師修復：V8.18 GTD 未落地**
  - P5 Weekly 最終輸出（給交易系統）：`weekly_trade_actions`（包含 `cancel_previous_orders`、`new_orders`、`strategy_version`）
  - **✅ 已實現**：`weekly_trade_actions` 結構化輸出（`generateWeeklyTradeActions()` 在 `24_P5_WEEKLY_FINAL_OUTPUT.js` 中實現）⭐ V8.17 確認
  - **✅ 已實現**：`cancel_previous_orders` 邏輯（從 `context.open_orders` 讀取上週掛單，標記需要取消）⭐ V8.17 確認
  - **✅ 已實現**：`strategy_version` 標記（格式：`W{year}-{weekNumber}`，例如：`W2026-03`）⭐ V8.17 確認
  - **⭐ 工程師修復：V8.18 GTD 未落地** ✅ **已修復**
    - **問題**：`24_P5_WEEKLY_FINAL_OUTPUT.js` 產出的 JSON 結構中，缺少 `order_validity` 或 `expiration_date` 欄位，導致所有單子預設都是 GTC，增加接刀風險
    - **修復**：在 `generateWeeklyTradeActions()` 中添加 `expiration_date` 和 `order_validity` 欄位
    - **實現位置**：`src/24_P5_WEEKLY_FINAL_OUTPUT.js` 中的 `buy_orders` 和 `sell_orders` 映射邏輯
    - **Prompt 更新**：在 `24_P5_WEEKLY_PROMPT.js` 和 `24_P5_WEEKLY_DUAL_LAYER.js` 中明確要求 AI 輸出 `expiration_date`（當 `time_in_force = "GTD"` 時）
- **⭐ V8.15 待實現：Weekly 輸入資料完整性補強** ✅ **已實現**
  - **✅ 已實現**：P0 Thesis 引用標記（`p0_thesis_ref`：在 `integrateStockFactors()` 中設置為 `p0_snapshot.snapshot_id`）⭐ V8.17 確認
  - **✅ 已實現**：P0.7 Time Window 可機器讀格式（`p0_7_time_window_constraints`：在 `integrateStockFactors()` 中從 P0.5 快照讀取）⭐ V8.17 確認
  - **✅ 已實現**：P2 V8.15 新增欄位完整提取（`extractP2V8_15Fields()` 函數已實現，讀取所有 V8.15 新增欄位）⭐ V8.17 確認
  - **✅ 已實現**：P2.5 異常訊號的直接警報（`p2_5_data.insider_selling_alert`、`p2_5_data.abnormal_13f_distribution` 在 `integrateStockFactors()` 中讀取）⭐ V8.17 確認
  - **✅ 已實現**：P3 輸出結構化欄位（`risk_overlay_level` 在 P3 中計算並輸出）⭐ V8.17 確認
  - **✅ 已實現**：學習系統產出完整傳遞（`learning_feedback` 在 `collectP5WeeklyAllData()` 中收集並傳遞到 context）⭐ V8.17 確認
  - **✅ 已實現**：P6 週度摘要讀取與頻率趨勢（`getP6WeeklySummary()` 已實現，讀取盤中異常頻率趨勢）⭐ V8.17 確認
  - **✅ 已實現**：P2 Milestones 自動對帳機制（`verifyP2Milestones()` 和 `integrateMilestoneVerification()` 在 `24_P5_WEEKLY_MILESTONE_VERIFICATION.js` 中實現，在 P5 Weekly Core 中整合）⭐ V8.17 完成
  - **✅ 已實現**：P4 狀態更新順序（在 `P5_Weekly_Execute()` 中正確調用 `P4_Calculate()`）⭐ V8.17 確認
  - **✅ 已實現**：持股財報完整分析系統（⭐ V8.17 完成）：
    - **P4 完成後自動生成**：`27_HOLDINGS_EARNINGS_COMPLETE.js` 在 P4 完成後自動觸發
    - **一次完成兩項任務**：過去五年歷史經驗 + 預估今年財報日期
    - **AI 模型配置**：
      - 正式模式：Hermes 4（Batch API）
      - 測試模式：Gemini Flash 3.0（同步 API）
    - **數據存儲**：
      - `EARNINGS_CALENDAR` 表格：預估財報日期
      - `EARNINGS_HISTORICAL_EXPERIENCE` 表格：五年歷史經驗
      - `HOLDINGS_EARNINGS_INDEX` 表格：個股索引
    - **Daily 新聞更新**：`27_HOLDINGS_EARNINGS_NEWS_UPDATER.js` 從 P5 Daily 新聞中檢測 `Earnings_Date_Announcement` 分類，自動更新財報日期
  - **詳細檢查結果**：請參考 `Weekly輸入資料完整性檢查報告_V8.15.md`、`P5_Weekly完整比對報告_V8.15_最終版.md`、`V8.0_三大行事曆數據流檢查報告_2026-01-19.md`
- **詳細設計**：請參考 `V8.15_P3-P6更新補充_SSOT.md`、`P3-P6更新建議報告_V8.15.md`、`P5_Weekly設計比對報告_V8.15.md`、`P5_Weekly完整比對報告_V8.15_最終版.md`
- **檔案**: 
  - `24_P5_WEEKLY_STOCK_STRATEGY.js`（個股策略）
  - `24_P5_WEEKLY_CORE.js`（核心整合）
  - `24_P5_WEEKLY_LEARNING.js`（學習機制）
  - `24_P5_WEEKLY_SENTIMENT.js`（市場情緒指標，V8.9 增強）⭐
- **功能**: 
  - 整合 P5.7-5.9 的結論
  - 自我歷史學習經驗
  - 制定本週持股掛單與各項操作指示
  - ⭐ **籌碼面影響個股策略**：籌碼面信號影響買入/持有/減倉決策
  - ⭐ **AI 動態權重**：因子權重由 AI 模型根據當下所有資訊動態決定，不應寫死
    * 所有因子：worldview、event、technical、fundamental、institutional、smart_money
    * AI 模型必須考慮所有提供的因子，不能忽略任何數據
    * AI 模型必須在輸出中說明權重決定的理由
  - ⭐ **Hitchhiking 監控**：整合機構出貨、內部人賣出、Dark Pool 轉向、期權 Put 保護激增信號
  - ⭐ **V8.9 新增：機構評級歷史動態學習系統**：
    * **機構評級資料來源**：從 `INSTITUTIONAL_RATINGS_DAILY` 讀取（由 P5 Daily 收集）
    * **多時間維度股價反應驗證**：
      - 短期（1-5 天）：機構放話後先演戲的階段
      - 中期（7-15 天）：真實意圖開始顯現
      - 長期（16-30 天）：最終驗證
    * **機構言行一致性分析**：結合評級動作與股價反應，判斷機構放話的真實意圖（誘多/誘空）
    * **可信度評分計算**：
      - 短期可信度：評級發布後 5 天更新
      - 中期可信度：評級發布後 15 天更新
      - 長期可信度：評級發布後 30 天更新
      - 最終可信度：加權平均（短期 30%、中期 40%、長期 30%）
    * **多數機構的預測共識 = FPE_B**：統計當天所有機構的評級動作（只統計有持股的股票），作為市場情緒指標
    * **歷史動態學習**：
      - 記錄各大機構在不同時間維度的可信度評分到 `INSTITUTIONAL_RATINGS_LEARNING_LOG`
      - 整合到 `P5__LEARNING_LOG` 的 `institutional_ratings_credibility` 欄位
      - 用於後續決策權重調整（例如：如果 Goldman Sachs 的短期可信度低，但中期可信度高，則在短期忽略其評級，在中期重視其評級）
    * **去重邏輯**：同一個機構對同一檔股票，一個月內只看最新的一條動作（最新覆蓋舊的）
    * **決策系統整合**：
      - `u_adjustment` 應參考機構評級的 `warnings`（誘多/誘空警告）
      - `trigger_decisions` 應參考機構評級的 `warnings`（建議觸發 P3/P4 重新分析）
      - `weekly_worldview.market_regime` 應參考多數機構的預測共識
    * 監控邏輯：2+ 個 HIGH severity 信號 → 減倉建議
    * 數據來源：P2.5 籌碼面數據 + P5 Daily 期權數據（用於警示功能）
  - ⭐ **V8.12 新增：個股新聞索引整合**：
    * **數據來源**：從 `STOCK_NEWS_INDEX_DAILY` 讀取（由 P5 Daily 建立）
    * **使用時機**：在決定每個個股的本週策略時，調閱該股本週的新聞索引
    * **讀取方式**：
      - Weekly AI先讀「當日熱點表」，發現「本週NVDA討論度暴增300%？」→ AI主動調閱NVDA相關的那12則新聞進行深度分析
      - 不需要讀完全部新聞，先讀索引，再根據索引調閱相關新聞
    * **核心價值**：
      - 更快更精準的讀取到每個個股的一週新聞索引
      - 不用每分析一個股票都要自己重找一次（節省AI算力）
      - 得到更精準與準確度高、且分類更精細的本週新聞摘要，用以更新世界金融市場背景觀
  - ⭐ **V8.30 新增：網路熱度（散戶溫度因子）整合**：
    * **數據來源**：從 `WEB_SENTIMENT_DAILY` 讀取（由 P5 Daily **D-1B 論壇管線**，grok 4.1 fast，**與 D-1A 新聞管線分開 Prompt 分開呼叫**產出）；使用者貼文經判讀後可併入個股索引或 `USER_PASTE_VERIFIED_DAILY`，Weekly 可讀取。
    * **使用方式**：作為**第三類輸入**（與新聞、宏觀並列），**僅作研究散戶追逐趨勢與參考**；**絕對權重遠低於**系統本身與機構／主力預測結論。
    * **用途**：決策參考、市場對照、動態學習之散戶溫度因子；小型/新創敘事股可適度參考，不取代機構與主力結論。
  - ⭐ **V8.12 新增：Weekly系統優化整合**：
    * **板塊/產業新聞索引**：
      - 數據來源：從 `SECTOR_NEWS_INDEX_DAILY` 讀取（由 P5 Daily 在週五建立）
      - 使用方式：Weekly分析每檔股票時，直接讀取該股票所屬板塊/產業的新聞索引，不用重新搜尋
      - 核心價值：避免重複搜尋板塊/產業新聞100次（約減少99%工作量）
    * **事件索引**：
      - 數據來源：從 `EVENTS_INDEX_WEEKLY` 讀取（由 P5 Daily 在週五建立）
      - 使用方式：Weekly分析每檔股票時，直接讀取該股票的相關事件索引，不用重新過濾
      - 核心價值：避免重複過濾事件列表100次（約減少99%工作量）
    * **宏觀數據週度波動度**：
      - 數據來源：從 `MACRO_DATA_WEEKLY_METRICS` 讀取（由 P5 Daily 在週五計算）
      - 使用方式：Weekly直接讀取計算好的硬數據（波動度、背離度、與上週比對），不用重新計算
      - 核心價值：提供清晰的數值指標，不依賴AI摘要（避免失真、忽略細節）
    * **技術指標週度波動度**：
      - 數據來源：從 `TECHNICAL_INDICATORS_WEEKLY_METRICS` 讀取（由 P5 Daily 在週五計算）
      - 使用方式：Weekly直接讀取計算好的硬數據（RSI變化、MACD背離、均線交叉、成交量趨勢），不用重新計算
      - 核心價值：提供清晰的數值指標，基於Daily已計算的技術指標
    * **實施檔案**：
      - `24_P5_WEEKLY_DATA_OPTIMIZED.js`：提供優化後的數據讀取函數
      - `24_P5_WEEKLY_DATA.js`：更新 `collectWeeklyMacroData()` 和 `getWeeklyTechnicalIndicatorsSummary()` 優先使用週度波動度
      - `24_P5_WEEKLY_CORE.js`：在生成個股策略前讀取所有優化索引
      - `24_P5_WEEKLY_STOCK_STRATEGY.js`：在 `integrateStockFactors()` 中整合優化後的索引數據，更新 `calculateEventFactor()` 優先使用事件索引
    * **整合位置**：`24_P5_WEEKLY_STOCK_STRATEGY.js`（個股策略制定時調用）
  - ⭐ **V8.13 新增：策略比對機制（動態學習系統核心）**：
    * **執行時機**：在Weekly執行時，在生成策略**前**先比對上一週的策略與市場真實反應
    * **比對內容**：
      - 讀取上一週的策略（從`P5__WEEKLY_STOCK_STRATEGIES`）
      - 讀取本週的市場真實反應（從`MARKET_OHLCV_DAILY`等）
      - 計算比對指標（準確度、相關性、方向偏差、幅度偏差、時機偏差）
      - 保存比對結果到`P5__LEARNING_LOG`（作為前一週的策略比對紀錄）
    * **核心價值**：逐漸不斷累積策略vs市場真實反應的經驗，將每次比對後學習到的觀念都儲存在永久大腦之中，作為新制定策略的記憶與依據
    * **實施檔案**：
      - `24_P5_WEEKLY_CORE.js`：在Step 5.5加入策略比對邏輯
      - `24_P5_WEEKLY_LEARNING.js`：`compareStrategyWithReality()`（通用函數，支援週/月/季）、`saveStrategyComparisonToLearningLog()`
    * **數據-策略-結果追蹤鏈**：
      - 記錄策略產出時使用的所有數據來源（宏觀數據、新聞、技術指標等）
      - 記錄策略產出
      - 記錄市場真實反應
      - 進行關聯分析，建立完整的追蹤鏈
  - ⭐ **財報日個股籌碼權重加強**（V7.1 補充手冊整合）：
    * 規則：若掃描兩週內目前持倉個股有公布財報，必須調整機構籌碼面的權重到短期最高
    * 具體要求：對於未來 14 天內有財報公布的持倉個股
      - `smart_money` 權重：必須提高到 **0.25-0.35**（短期最高）
      - `institutional` 權重：必須提高到 **0.15-0.20**（短期最高）
      - 其他因子權重相應降低，但總和仍為 1.0
    * 理由：財報前 1-2 週的籌碼面變化最能反映機構和內部人的真實預期
    * 實施：在 `buildStockStrategyBatchPrompt` 的 prompt 中明確標註需要加強籌碼權重的股票，並在權重決定要求中加入此規則

---

### 動態學習層架構 ⭐ V8.45 定案

> **核心理念**：Learn "where we die" before learning "how to win."
> 
> 動態學習不是要算出「每個因子的正確權重」（不可解/非唯一解），而是要做到：
> 1. 辨識哪些因子/模組在特定情境下容易失效
> 2. 辨識哪些「因子組合簽名」在歷史上高失敗率
> 3. 將以上結果轉化成可執行的決策約束與偏置

#### 核心總則（鐵律）

##### A1. 學習目標重新定義

學習層輸出只能是以下三種（其他自由發揮一律禁止）：

| 類型 | 說明 | 範例 |
|------|------|------|
| **Hard Caps**（硬上限） | max exposure、position cap、禁用某些 setup/cat | `max_exposure = 30%`、`frontier_cap = 8%` |
| **Soft Bias**（軟偏置） | 調整模組權重區間、提高確認門檻 | `tech_weight -10%`、`require_confirmation += 1` |
| **Banned Patterns**（失敗樣式） | 哪些簽名/情境下容易失敗 | `if signature in FAILSET then disallow` |

##### A2. 輸出必帶附件

每一條學習輸出必須帶：

| 欄位 | 說明 |
|------|------|
| `evidence` | 對應的歷史樣本 ids |
| `confidence` | 樣本數與一致性 |
| `decay` / `ttl` | 有效期限/半衰期 |

##### A3. 鐵律：Learning constraints override strategy preferences

**工程強制**：決策模組在執行開始第一件事必須 `loadLearningStateLatest()`，讀取失敗則進入 SAFE MODE（只允許減倉/不開新倉）。

---

#### Context Layer（情境層）

##### context_signature（情境簽名）

**定義**：任何決策與學習都必須帶上 `context_signature`，否則一律視為「不可學習樣本」。

**必備維度**：

| 維度 | 內容 | 值域範例 |
|------|------|----------|
| **市場氣候** | risk-on/off、流動性寬鬆/緊縮、波動 regime | `risk_on`、`risk_off`、`liquidity_tight` |
| **衍生品壓力** | gamma/volatility regime、槓桿密度、期貨基差壓力 | `gamma_high`、`basis_inverted` |
| **參與者結構** | 散戶主導/機構主導/做市商被迫對沖 | `retail_led`、`institutional_led`、`mm_hedging` |
| **規則環境** | 政策/監管/新 ETF/新合約規格 | `reg_change`、`new_etf` |
| **VIX 水平** | LOW/MEDIUM/HIGH/EXTREME | `vix_medium` |
| **市場狀態** | BULL/BEAR/SIDEWAYS/UNCERTAIN | `bull_market` |

**規則**：同一組因子在不同 context 下會完全相反，必須先分桶再談學習。

---

#### 四個子系統

##### C1. Trace Pack（決策可追溯封包）

**鐵律**：沒有 Trace Pack，就不允許產生決策輸出。

**必含欄位**：

| 欄位 | 說明 |
|------|------|
| `decision_id` | 唯一識別 |
| `inputs_digest` | 所有輸入快照的 hash + snapshot_id 列表 |
| `context_signature` | 情境簽名（必備） |
| `factor_signature` | 因子組合簽名 |
| `model_outputs` | 各模組輸出摘要（P2/P2.5/P3/P5…） |
| `final_decision` | 買賣/持倉調整/掛單 |
| `expected_outcome` | 預期方向、預期波動、預期時間窗（3d/7d/20d） |
| `constraints_applied` | 本次用了哪些 learning constraints（必填） |
| `claims_json` | 可驗證命題列表（V7 設計） |

**工程強制**：Trace Pack 寫入成功才算 run 成功。

##### C2. Factor Signature Engine（因子組合簽名）

**設計原則**：不要學「因子 1 好/壞」，要學「某些組合在某情境常爆炸」。

**因子離散化方式**：

| 因子 | Bucket |
|------|--------|
| `valuation_state` | cheap / neutral / expensive |
| `gamma_regime` | low / med / high |
| `breadth_state` | expanding / flat / collapsing |
| `chips_signal` | accumulation / distribution / neutral |
| `tech_cat` | breakout / pullback / parabolic / late_dist |
| `macro_regime` | tightening / easing / stagflation |

**簽名格式**：`SIG = (context_bucket, factor_bucket_1..n, action_type)`

**好處**：不需要解「因果」，只做「失敗率統計」，可快速累積樣本、可回測、可解釋。

##### C3. Outcome Attribution（結果歸因）

**設計原則**：只做「錯誤分類」，不做完全責任拆解。輸出是「這次錯屬於哪種錯」。

**四項 Scorecard**（V7 設計，必須計算）：

| 指標 | 定義 | 閾值 |
|------|------|------|
| **方向準度** | 預測方向是否正確 | ≥0.70 優秀 |
| **時機偏差** | 預測轉折點與實際轉折點時間差 | ±3天優秀 |
| **幅度偏差** | 預測幅度與實際幅度偏差 | ±5%優秀 |
| **最大回撤** | 策略執行期間最大回撤 | <5%優秀 |

**7 類錯誤分類**（V8.45 定案）：

| # | 代碼 | 性質 | 是否影響認知權重 |
|---|------|------|-----------------|
| 1 | `TIMING_WRONG` | 認知偏移 | ✅ 是 |
| 2 | `MAG_WRONG` | 認知偏移 | ✅ 是 |
| 3 | `REGIME_SHIFT` | 框架失效 | ✅ 是（高權重） |
| 4 | `SIGNAL_TRAP` | 訊號誤導 | ✅ 是 |
| 5 | `DATA_GAP` | 輸入不完整 | ⚠️ 調整 data_weight |
| 6 | `THESIS_INVALID` | 敘事錯誤 | ✅ 是（高權重） |
| 7 | `EXECUTION_SLIPPAGE` | 落地失敗 | ❌ **不懲罰認知** |

**⚠️ EXECUTION_SLIPPAGE 特殊規則**：
- **不得**用來懲罰因子、敘事或世界觀權重
- 只影響：position sizing、流動性門檻、下單方式（limit / staged / avoid）
- 否則會把「對的判斷」錯誤地學成「不敢判斷」

**Evidence 規則**（V7 設計）：
- 必須附 Evidence pointers
- 缺證據時標記 `UNCERTAIN_CAUSE`，不得驅動回寫

##### C4. Policy Compiler（學習輸出編譯器）

**輸出三類 Policy**：

| 類型 | 說明 | 範例 |
|------|------|------|
| **Hard Caps** | 硬上限 | `max_exposure = 30%`、`sector_cap = 25%` |
| **Soft Bias** | 軟偏置 | `tech_weight -10%`、`entry_atr_multiple += 0.5` |
| **Banned Patterns** | 禁用模式 | `if signature in FAILSET then disallow` |

**TTL/Decay 必備**：
- `half_life_days`
- `min_samples_required`
- `confidence_floor`

**回寫頻率限制**（V7 設計）：
- 權重每週最多 ±0.05
- 每月才允許重新平衡到新穩態

---

#### Policy 層級與衝突解決

##### 三層級優先順序

| 層級 | 本質 | 優先級 |
|------|------|--------|
| **System-level** | 生存層（風險氣候、總曝險） | 最高 |
| **Sector-level** | 結構層（板塊曝險、板塊禁用 setup） | 中 |
| **Symbol-level** | 戰術層（單股禁用某 cat、提高確認門檻） | 最低 |

##### 衝突解決規則（鐵律）

> **Policy Conflict Resolution Rule**  
> 若任一層級對某行為標記為 `DISALLOW`，則該行為在所有層級一律視為 `DISALLOW`。

- System 禁止 → 全部禁止
- Sector 禁止 → Symbol 不得 override
- Symbol 禁止 → 只影響該股

**設計目的**：系統永遠偏向「不犯致命錯誤」，而不是「追求多做一筆」。

---

#### 四個成熟階段（Learning Warm-Up Rule）

> **核心原則**：任何動態學習輸出，在未達統計與情境門檻前，只能「記錄」與「提示」，不得「約束」決策。
> 
> **白話翻譯**：前期只能當觀察者，不准當裁判。

| Phase | 名稱 | 門檻（保守穩健） | 可做 | 禁止 |
|-------|------|------------------|------|------|
| **0** | 冷啟動期 | ≥ **50-70** 次完整循環（6-8 週） | Trace Pack、記錄 context/factor signature、outcome、錯誤分類 | ❌ 調整權重、產生 policy、禁用策略 |
| **1** | 觀察學習期 | context ≥ **30**；signature ≥ **8** | 統計失敗率、排序高失敗簽名 Top-K、標記 Potential Risk Pattern | ❌ 影響實際決策，只輸出「警示註記」 |
| **2** | 軟影響期 | context ≥ **80-120**；signature ≥ **15**；失敗 ≥ 65% | Soft Bias（可被 override）、提高確認門檻、降低信心分數 | ❌ Hard Cap、禁用策略 |
| **3** | 強制約束期 | context ≥ **150-250**；signature ≥ **25-40**；失敗 ≥ 70-75% | Hard Caps、Banned Pattern、限制策略類型；必須有 TTL | - |

**上修理由**：本系統是「世界觀依賴型」多因子多層級系統，非單一策略，樣本要更多。

---

#### Counterfactual-lite 機制（學習安全閥）

**定位**：Learning Safety Valve，避免被單一黑天鵝牽著跑，防止權重像鐘擺來回擺。

**規則**：
> 當決策失敗時，**不得立即更新 policy**，必須先檢查：
> 1. 同 `context_signature`
> 2. 同 `factor_signature`
> 3. 最近 N 次（N ≥ 5-10）的成功率趨勢
>
> **若為單點異常** → 降低 `learning_rate`，**不改 policy**。

**目的**：讓系統「慢慢變聰明」，而不是「一下子變神經質」。

---

#### I/O 端口保證

##### D1. 寫入端（Output）

**唯一權威表**：`LEARNING_STATE_LATEST`

| 欄位 | 說明 |
|------|------|
| `version` | 版本號 |
| `generated_at` | 生成時間 |
| `context_signature_summary` | 情境摘要 |
| `policy_hard_caps` | Hard Caps 列表 |
| `policy_soft_bias` | Soft Bias 列表 |
| `fail_signatures_topK` | 失敗簽名 Top-K |
| `data_gap_watchlist` | 缺失數據監控清單 |
| `evidence_index` | 樣本 ids |
| `ttl` / `half_life` | 有效期限 |

**同時保留**：最新版（latest）+ 歷史版（append-only log）

##### D2. 讀取端（Input）

**強制規則**：
1. 每次 Weekly 決策、以及任何會產生 `order_plan` 的模組（P5）
2. 執行開始第一件事：`loadLearningStateLatest()`
3. 讀取失敗 → 整個 run fail（或降級到 SAFE MODE，只允許減倉/不開新倉）
4. Prompt 內強制插入 `[LEARNING_CONSTRAINTS]` 區塊

##### D3. 可驗證性

**強制規則**：每個決策輸出要附：
- `applied_learning_policy_ids`
- `policy_effects_summary`（例如 "sector cap applied", "momentum disabled due to fail signature"）

**工程檢查器**：若 `learning_state_version != null` 但 `applied_learning_policy_ids` 為空 → 視為 bug

---

#### 工程檢查清單

| # | 規則 | 違反後果 |
|---|------|----------|
| 1 | 每次決策必有 Trace Pack | 不允許出 output |
| 2 | 每次決策必載入 Learning State | fail 或 safe-mode |
| 3 | 每次決策必回填 applied policies | 視為 pipeline bug |
| 4 | Learning State 有 TTL/Decay | 避免早期樣本鎖死系統 |
| 5 | 所有 policy 必可追溯到 evidence ids | 不可黑箱 |
| 6 | Signature 相似度匹配存在 | 不拿完全不同 regime 來學 |
| 7 | Data Gap 反向驅動資料採集 | 缺什麼加入 watchlist |
| 8 | 學習輸出只允許三類 | 禁止長文敘事 |

---

#### 與現有架構融合點

##### 保留現有基礎設施

| 現有組件 | 狀態 | 融合方式 |
|----------|------|----------|
| 三層記憶模型（STM/MTM/LTM） | ✅ 保留 | 繼續使用 |
| `P5__STRATEGY_SNAPSHOT` | ✅ 保留 | 擴充為 Trace Pack |
| `P5__OUTCOME_SNAPSHOT` | ✅ 保留 | 擴充 7 類錯誤分類 |
| `P5__LEARNING_STATE` | ✅ 保留 | 升級為 `LEARNING_STATE_LATEST` |
| `P5__SCENARIO_MEMORY` | ✅ 保留 | 與 context_signature 整合 |
| `buildWeeklyMemoryPack()` | ✅ 保留 | 繼續使用 |
| `compareStrategyWithReality()` | ✅ 保留 | 擴充四項 Scorecard |

##### 升級現有輸出格式

| 現有輸出 | 升級為 |
|----------|--------|
| `parameter_bias_adjustment` | Soft Bias |
| `safety_lock_recommendations` | Hard Caps |
| `similar_failure_cases` | Banned Patterns / Failure Registry |

---

#### **P5 Monthly: 動態學習**（每月執行）

##### **1. 以本月總數據與世界觀，統整整月的結論，更新月世界觀**
- **檔案**: `24_P5_MONTHLY.js`
- **功能**: 統整整月的結論、更新月世界觀、分析跟前三個月的世界觀連接或背離程度

##### **2. 回顧策略與學習** ⭐ V8.0 增強（AI 模型驅動）+ ⭐ V8.13 補強（策略比對機制）
- **檔案**: `24_P5_MONTHLY.js` + `24_P5_WEEKLY_LEARNING.js`
- **功能**: 
  - 回顧本月 Weekly 的策略制定
  - ⭐ **V8.13 新增：比對上一月的策略與市場真實反應**（動態學習系統核心）
    * 在Monthly執行時，自動比對「上一月的策略」與「本月的市場真實反應」
    * 計算比對指標（準確度、相關性、方向偏差、幅度偏差、時機偏差）
    * 保存比對結果到`P5__LEARNING_LOG`（作為前一月的策略比對紀錄）
    * 將比對結果整合到月度學習分析中
  - 與事後市場真實數據比對偏移度
  - ⭐ **學習機制（AI 模型驅動）**:
    * 系統提供：前三個月歷史快照（Weekly 策略 + 實際結果）
    * AI 模型分析：預測 vs 實際偏移度、方向偏差、幅度偏差、時機偏差
    * AI 模型決定：權重調整、閾值調整、模式識別
    * 使用雙模型交叉驗證（Claude Hermes 4 + GPT-5.2）
  - 對每週的 Weekly 策略做出未來同樣情況該如何修正的學習過程
  - ⭐ **V8.13 核心價值**：逐漸不斷累積策略vs市場真實反應的經驗，將每次比對後學習到的觀念都儲存在永久大腦之中，統整全月學習經驗，跟前三個月的經驗連結後更新月度結論，給接下來的weekly決策系統使用

---

#### **P5 Quarterly: 重置機制**（每季執行）⭐ V8.13 補強（策略比對機制）

##### **0. ⭐ V8.13 新增：比對上一季的策略與市場真實反應**（動態學習系統核心）
- **檔案**: `24_P5_QUARTERLY.js` + `24_P5_WEEKLY_LEARNING.js`
- **功能**:
  - 在Quarterly執行時，自動比對「上一季的策略」與「本季的市場真實反應」
  - 計算比對指標（準確度、相關性、方向偏差、幅度偏差、時機偏差）
  - 保存比對結果到`P5__LEARNING_LOG`（作為前一季的策略比對紀錄）
  - 統整全季學習經驗，跟前季的經驗再次統整，更新季度結論，給接下來的weekly決策系統使用
  - ⭐ **核心價值**：做的工作類似Weekly和Monthly，但是時間維度不同，看到的結論就不同

##### **1. 每季重跑一次 P0** ⭐ V8.0 增強（持倉整合邏輯）
- **檔案**: `24_P5_QUARTERLY.js`
- **功能**: 
  - **a. 分析之前已經決定的產業面，有沒有任何新的變動或是失去優勢的地方**
  - **b. 重新分析試著找出之前沒有找到的符合產業**
  - **然後接下來就是 P0-P4 的過程全部重跑一次**
  - ⭐ **持倉整合邏輯**:
    * **Step 1: 分類現有持倉**
      - A_仍在新清單: 繼續持有，重新跑 P2-P4
      - B_不在新清單但 P2 基本面 OK: 標記為 'Phase_Out'，逐步減倉
      - C_不在新清單且 P2 基本面弱: 立即清倉
    * **Step 2: Phase_Out 策略**
      - 定義: 不再加碼，但不立即清倉
      - 處理: P3 Stop Loss 設嚴格（-5%），P4 權重逐週遞減（-10%/週），Weekly 如技術面破位 → 立即清倉
      - 期限: 最多保留 4 週
    * **Step 3: 輸出**
      - 新增清單: [新檔位, 買入價, 初始權重]
      - Phase_Out 清單: [舊檔位, 止損價, 減倉計劃]
      - 繼續持有清單: [檔位, 更新後的權重]
  - ⭐ **由 Weekly 全盤納入最終策略清單**

##### **2. 持股清單季財報深度分析**
- **檔案**: `24_P5_QUARTERLY.js` + `13_P5_5_EARNINGS_WARFARE.js`
- **功能**: 產生結論並給當週的 Weekly 作為重點策略調整因子

##### **3. 目前已經持有的股票清單，全部重新跑一次 P2-P4**
- **檔案**: `24_P5_QUARTERLY.js`
- **功能**: 跟最近一次 Weekly 紀錄的持股數量/掛單價位比對後做出季度更新

---

## 🔄 V7.1 到 V8.0 主要變更

### 1. **P0.5 與 P0.6 統整** ⭐
- **變更**: 將原 P0.6（供應鏈情報網）的功能統整到 P0.5（產業鏈地圖）
- **理由**: 功能高度重疊、數據來源相同、執行頻率一致、邏輯順序自然
- **檔案調整**: `15_P5_7_SUPPLY_CHAIN.js` → `08_P0_5_SUPPLY_CHAIN.js`

### 2. **P5.4 和 P4.6 完全搬移到 P6** ⭐
- **變更**: 將 P5.4（盤中監控）和 P4.6（緊急撤退協議）完全搬移到 P6
- **理由**: 
  - 盤中監控需要即時反應，應該由 P6 統一負責
  - P4.6 的所有功能（盤中緊急撤退、日結後戰略評估）應該完全統整
  - 職權分工更清晰：P6 = 盤中（Rule-Based），P5 Weekly = 盤後（AI）
- **檔案調整**: 
  - P5.4 和 P4.6 的盤中監控功能 → `28_P6_INTRADAY_MONITOR.js`、`28_P6_EMERGENCY_EXIT.js`
  - P4.6 的日結後戰略評估 → 整合到 P5 Weekly
  - `12_P4_6_EMERGENCY_EXIT.js` 已廢棄

### 3. **P5.9 整合到 P5 Weekly** ⭐
- **變更**: 將泡沫監控系統整合到 P5 Weekly，影響 U（總資金水位）
- **理由**: 時機更合適（Weekly 策略制定時決定資金水位）
- **檔案調整**: 在 `24_P5_WEEKLY_CORE.js` 中整合，修改 `24_P5_SHARED.js` 的 U 調整邏輯

### 4. **執行頻率對齊**
- **P0-P4**: 低頻執行（季度/月度），確保執行頻率對齊
- **P5**: 高頻執行（每日/週度），處理所有動態數據
- **P6**: 盤中高頻執行（每 20 分鐘 / 每 5 分鐘），處理盤中異常

### 5. **數據收集頻率優化** ⭐
- **變更**: 調整 Daily 籌碼／衍生品蒐集 頻率
- **理由**: 節省 API 成本，提高數據利用率
- **具體調整**:
  - 13F 持倉: 每日 → 季度（節省 99%）
  - 內部人交易: 每日 → 每週（節省 85%）
  - Dark Pool: 每日（全部）→ 每週（僅持倉）（節省 50%）
  - 期權數據: 保持每日（合理）
- **新增使用者**: P5 Weekly 籌碼面彙總

### 6. **P2 同業比較兩階段流程設計** ⭐
- **變更**: 實現兩階段同業比較流程（AI 識別同業 → 程式計算相對位置）
- **理由**: 避免兩次 AI 模型無法承接上下文，提高準確性和一致性
- **具體設計**:
  - Stage 1（AI）: 識別同業公司清單（包含規模分類：龍頭/中大型/小型新創）
  - Stage 2（程式）: 收集數據並計算相對位置（前段/中段/後段）
  - 同業定義: 不是「同板塊」，而是「相同細分產業」
  - 同業分類: 必須分開龍頭/中大型/小型新創來比較，禁止跨分類比較

### 7. **GOOGLEFINANCE 數據源整合** ⭐⭐⭐ **V8.0 新增**
- **變更**: 將 GOOGLEFINANCE 整合為主要數據源之一
- **理由**: 免費、穩定、無需 API Key、適合高頻監控（P6）
- **具體整合**:
  - **宏觀數據（Daily 新聞／D-1）**: 匯率、國債利率、VIX → 優先使用 GOOGLEFINANCE
  - **OHLCV 數據（Daily OHLCV 蒐集 / P6）**: 美股、台股、日股 → 優先使用 GOOGLEFINANCE
  - **技術實現**: 
    * 新增 `fetchGoogleFinanceSafe` 和 `fetchGoogleFinanceHistorySafe` 函數（解決非同步延遲問題）
    * 新增 `26_TEST_GOOGLEFINANCE.js` 測試工具
    * 新增 `24_P5_DAILY_OHLCV_GOOGLEFINANCE.js` 數據源模組
- **優勢**: 零成本、高穩定性、適合高頻監控
- **限制**: 歷史數據有延遲（需等待機制）、不支援技術指標（需自行計算）

### 8. **P6 盤中監測系統新增** ⭐⭐⭐ **V8.0 新增**
- **變更**: 新增 Phase 6 盤中監測系統
- **理由**: 提供全天候風險哨兵、盤中異常偵測、緊急撤退觸發
- **核心功能**:
  - 盤中異常偵測（暴跌、暴漲、爆量）— Rule-Based
  - 20 分鐘動能追蹤（計算 20 分鐘價格變化）— Rule-Based
  - 盤中緊急撤退協議（從 P4.6 完全搬移，寫死的即時防禦）— Rule-Based
  - DEFCON 盤中調整（Rule-Based）
  - 財報事件盤中監控（從 P5.5 搬移，原本在 Daily 收盤後檢查）— Rule-Based
  - 目標價監控（台股，從 P5.6 搬移）— Rule-Based
  - 日誌記錄與數據保留（一般正常情況隔天清除，異常情況保留到 Daily）— Rule-Based
- **職權分工**:
  - **P6**: 盤中監測、盤中緊急撤退協議、盤中緊急撤退執行、財報事件盤中監控（全部 Rule-Based，無 AI）
  - **P5 Weekly**: 盤後 AI 分析緊急事件、長期調整建議（戰略層面，AI 參與）
  - **P4.6**: 已完全移除，所有功能已統整到 P6 或 P5 Weekly
- **設計原則**: 
  - **⚠️ 核心原則**：平常正常監控根本用不到 AI 模型（Rule-Based 即可）
  - **⚠️ 重要**：只有緊急事件的情況才需要決策
    * 盤中 = Rule-Based（防災演習，無 AI）
    * 盤後 = AI（調整戰略，僅在緊急事件發生後由 P5 Weekly 分析）
- **成本**: $0（GOOGLEFINANCE + Rule-Based 邏輯，無 AI Token 成本，僅在緊急事件發生後由 P5 Weekly 進行盤後 AI 分析）

---

## 🎯 核心投資哲學（SSOT）

**基本面是底，籌碼面是因，技術面是果**

```
基本面（P2）→ 籌碼面（P2.5）→ 技術面（P3）
    ↓              ↓              ↓
長期持有的根柢   大資金的流向    籌碼流動的結果
                （無法隱瞞）    （可能短期會騙人）
```

---

## 📝 待完成工作（V8.0 升級）

### ⭐ V8.17 實現進度（2026-01-19）

**已完成項目**：
1. ✅ **Batch API 全局開關** - 實現 `GLOBAL_USE_BATCH_API` 配置，方便測試時切換同步/Batch 版本
2. ✅ **P1_STEP2 Batch 排除** - 從 Batch 適用列表中移除 P1_STEP2，避免與 P1_STEP1 的 Batch 衝突
3. ✅ **getP2SnapshotById 函數** - 實現根據 snapshot_id 查詢特定 P2 快照的功能（在 `06_SNAPSHOT_MANAGER.js` 中）
4. ✅ **P2.5 Batch API 實現** - 完成 P2.5 Monthly/Quarterly 的 Batch API 版本和同步版本雙實現
5. ✅ **P2.5 異常硬觸發確認** - 確認 `calculateEscalationScore()` 中已實現 P2.5 異常硬觸發邏輯（`insider_selling_alert` 和 `abnormal_13f_distribution` 直接觸發 P5-A）
6. ✅ **Sector ETF Flow 與 Mag 7 分析補強** - 在 P5-B System Blocks 和 User Payload 中明確提到 Sector ETF Flow 與 Mag7 為 momentum_shift 的高優先權因子
7. ✅ **Strategy Skeleton 確認** - 確認 `generateStrategySkeleton()` 和 `applyParameterAdjustmentVector()` 已完整實現
8. ✅ **P5-A 模型選擇修正** - P5-A Batch 版本和同步版本一律使用 Opus（因為已經只處理 20%+ Batch，沒必要妥協用便宜的模型）

**待完成項目**：
- ✅ **P5-B 和 P5-A Weekly Batch API 實現** ⭐ V8.17 完成
  - ✅ P5-B Batch API 實現（`P5_B_ExecuteWithBatch`、`P5_B_ProcessBatchResults`）
  - ✅ P5-A Batch API 實現（`P5_A_ExecuteWithBatch`、`P5_A_ProcessBatchResults`）
  - ✅ P5 Weekly Core 整合 Batch 結果處理
  - ✅ Batch items 保存到 context 供後續處理使用
- ⚠️ **P5 Monthly/Quarterly 和 P0.5 Mode-2**：這些是整體分析任務，不是多檔股票批次處理，不需要 Batch API
- ✅ **V8.15 核心功能已實現** ⭐ V8.17 完成
  - ✅ 雙層 AI 架構（P5-B / P5-A）
  - ✅ Strategy Skeleton + AI Parameter Layer
  - ✅ Weekly Snapshot 資料補齊（包含 Delta Pack）
  - ✅ 動態學習系統角色明確化
  - ✅ Sector ETF Flow 與 Mag 7 分析
  - ✅ P2.5 異常硬觸發
  - ✅ 最終產出對齊 IB 批次下單
  - ✅ 風控覆蓋層（risk_overlay_level）
  - ✅ Tier 映射規則（Position_Role → Tier）
  - ✅ 緊急退出條件更新（FRONTIER Runway 檢查）
  - ✅ **所有待確認項目已確認和實現** ⭐ V8.17 完成
    - ✅ Cat 權重兩層修正
    - ✅ U 優先級排序
    - ✅ Time_Window_Penalty 整合
    - ✅ P2 Milestones 自動對帳機制
    - ✅ P4 狀態更新順序
    - ✅ 驗證里程碑未達成檢查（P6 緊急退出）

### 高優先級
1. ✅ **P0.5 與 P0.6 統整**（已完成決策）
2. ✅ **P5.4 整合到 P5 Daily**（已完成實現並上傳）⭐ 2025-01-15
   - 在 `24_P5_DAILY_CORE.js` 中整合 P5.4 警報檢測
   - 如果檢測到緊急情況，自動調用 `P4_6_EmergencyExit()`
   - 新增 `getCurrentPositionsFromP4Snapshot()` 函數獲取當前持倉
3. ✅ **P5.9 整合到 P5 Weekly**（已完成實現並上傳）⭐ 2025-01-15
   - 在 `24_P5_WEEKLY_CORE.js` 中整合泡沫監控系統
   - 根據泡沫階段（EARLY/MID/LATE/BURST）調整 U（總資金水位）
   - 新增 `calculateUAdjustmentFromBubbleStage()` 函數
   - 如果 U 調整建議與當前值差異 > 5%，觸發 P4 U 調整
4. ✅ **P2.5 與 P3 統一調度**（已完成決策：只是統一調度，兩個還是分開的模組，各有各的任務）
5. ✅ **M0 配置更新**（已完成檢查，無需更新）⭐ 2025-01-15
   - 檢查結果：M0 配置已符合 V8.0 架構要求，無需額外更新
6. ✅ **P3 機構級預測視角原則**（已完成 Prompt 更新）
7. ✅ **白名單數據源原則**（已完成 P2/P3 Prompt 更新）
8. ✅ **P3 讀取歷史 OHLCV 數據**（已完成代碼實現）
9. ✅ **Sector ETF Flow 分析**（Daily 收集，Weekly 研判，已完成實現）⭐ 2025-01-14
10. ✅ **融合評分權重機制**（改為 AI 動態決定，加強 Prompt，已完成實現）⭐ 2025-01-14
11. ✅ **Regime 分析補強**（市場寬度數據收集、準度追蹤，已完成實現並上傳）⭐ 2025-01-15
   - ✅ 市場寬度數據收集：已實現 `collectMarketBreadthData()` 函數，收集 Advance/Decline、New High/Low、Stocks Above MA50/MA200
   - ✅ 新增 `MARKET_BREADTH_DAILY` 表格結構
   - ✅ Regime 準度追蹤機制：已實現 `saveRegimePrediction()`、`verifyRegimePredictions()`、`calculateRegimeAccuracy()` 函數
   - ✅ 新增 `REGIME_PREDICTION_TRACKING` 表格結構
   - ✅ 在 P5 Weekly 世界觀分析中整合 Regime 預測保存和驗證邏輯
12. ✅ **Hitchhiking 監控**（在 P5 Weekly 實現，已完成實現）⭐ 2025-01-14
13. ✅ **Weekly 財報日個股籌碼權重加強**（在 prompt 中補強，已完成實現）⭐ 2025-01-14
15. ✅ **Mag 7 集體表現分析**（整合到 P5 Weekly 世界觀分析，已完成實現）⭐ 2025-01-14
16. ✅ **GOOGLEFINANCE 數據源整合**（設計定案，大部分已實現）⭐ 2026-01-17 + ⭐ 2026-01-24 確認
   - ✅ 數據源配置設計定案
   - ✅ 技術實現方案定案（`fetchGoogleFinanceSafe`、`fetchGoogleFinanceHistorySafe`）
   - ✅ 測試工具實現（`26_TEST_GOOGLEFINANCE.js`）
   - ✅ **Daily 新聞／宏觀 實際整合 GOOGLEFINANCE 數據源**（2026-01-24 確認已實現）- `src/24_P5_DAILY_MACRO.js` 中 `getMacroFromGoogleFinance()` 函數大量使用 `fetchGoogleFinanceSafe`
   - ✅ **Daily OHLCV 蒐集 實際整合 GOOGLEFINANCE 數據源**（2026-01-24 確認已實現）- `src/24_P5_DAILY_OHLCV_GOOGLEFINANCE.js` 中完整實現 `fetchOHLCVFromGoogleFinance()` 和 `fetchHistoricalOHLCVFromGoogleFinance()`，在 `src/24_P5_DAILY_OHLCV_CORE.js` 中優先使用
   - ✅ **P6 整合 GOOGLEFINANCE 數據源**（2026-01-24 確認已實現）- `src/28_P6_DATA_COLLECTOR.js` 中大量使用 `fetchGoogleFinanceSafe` 獲取盤中數據
   - ⏳ 移除或標記為備用的原有數據源（待實現）
17. ✅ **P6 盤中監測系統設計**（設計定案，部分實現）⭐ 2026-01-17
   - ✅ 完整設計規格定案
   - ✅ 職權分工明確（P6 盤中 Rule-Based vs P5 Weekly 盤後 AI）
   - ✅ 決策機制定案（Layer 1 寫死 + Layer 2 AI 盤後，只有緊急事件才需要決策）
   - ✅ 設計原則明確（平常正常監控根本用不到 AI 模型）
   - ✅ 核心功能實現（大部分已實現）⭐ V8.10 更新 + ⭐ 2026-01-24 確認
     * ✅ 盤中異常偵測（Rule-Based）
     * ✅ 20 分鐘動能追蹤（20 分鐘價格變化計算，Rule-Based）
     * ✅ 盤中緊急撤退協議（從 P4.6 完全搬移，Rule-Based）
     * ✅ **移動停利機制（Trailing Stop，V8.10 新增）** - 當 P5.9 判定為 LATE 時自動啟動
     * ✅ **DEFCON 盤中調整**（2026-01-24 確認已實現）- `src/28_P6_DEFCON_ADJUSTER.js` 中完整實現
     * ✅ **財報事件盤中監控**（2026-01-24 確認已實現）- `src/28_P6_INTRADAY_MONITOR.js` 中 `checkEarningsTriggers()` 函數實現
     * ✅ **目標價監控（台股）**（2026-01-24 確認已實現）- `src/28_P6_INTRADAY_MONITOR.js` 中 `checkTargetPrices()` 函數實現
     * ✅ **日誌記錄與數據保留**（2026-01-24 確認已實現）- `src/28_P6_LOGGER.js` 中 `logIntradayMonitoring()` 函數實現，`P6_INTRADAY_LOG` 和 `P6_EMERGENCY_EXIT_LOG` 表格已實現
   - ⏳ Time-driven Trigger 設定（待實現）
   - ✅ **數據表格結構實現**（2026-01-24 確認已實現）：
     * ✅ `P6_INTRADAY_LOG` - `src/28_P6_LOGGER.js` 中實現
     * ✅ `P6_EMERGENCY_EXIT_LOG` - `src/28_P6_EMERGENCY_EXIT.js` 中實現
     * ⏳ `P6_INTRADAY_ALERTS_DAILY`（待確認）
   - ⏳ P6 記錄整合到 P5 Daily/Weekly（待實現）
     * P6 異常數據標記為「需保留」
     * P5 Daily 讀取並整合到日更資料
     * P6 隔天清除一般正常情況的數據（保留異常數據的引用）
   - ⏳ P4.6、P5.4、P5.5、P5.6 功能完全移除或遷移到 P6（待實現）

### 中優先級
16. ✅ **Daily 籌碼／衍生品蒐集（機構級籌碼面）**（已定案，不再變更）⭐ 2025-01-15
17. ✅ **P2.5 對沖基金 Clone 詳細實現**（明確 Top 10 清單和評分邏輯，已完成實現）⭐ 2025-01-14
18. ✅ **P5 Weekly Regime 輸出格式**（補充 `regime_transition`、`risk_assessment` 欄位，已完成實現）⭐ 2025-01-14

---

## 🎉 V8.0 實現完成總結（2025-01-15）

### ✅ 所有待完成項目已實現（GAS 時代；程式碼留存於 gas_archive 對照）

**實現狀態**：✅ **已完成**（實作已中止，對照用）

**實現完成項目**：
1. ✅ P5.4 整合到 P5 Daily（緊急撤退協議檢測整合）
2. ✅ P5.9 整合到 P5 Weekly（泡沫監控系統整合）
3. ✅ Regime 分析補強（市場寬度數據收集 + 準度追蹤機制）
4. ✅ M0 配置更新（檢查完成，無需更新）
5. ✅ P2.5 與 P3 描述修正（只是統一調度，不是整合）
6. ✅ Daily 籌碼／衍生品蒐集 標記為已完成（已定案）

**V7.1 補充手冊整合項目**：
1. ✅ Weekly 財報日個股籌碼權重加強
2. ✅ Mag 7 集體表現分析

**完成度**：100% ✅

---

## 📚 相關文檔

### 核心設計原則
- `系統核心設計原則_V8.0.md` ⭐ **最高等級設計原則** - 包含機構級預測視角、白名單數據源原則等
- `系統正式上線前準備工作計劃_V8.0.md` - 準備工作清單和檢查項目
- `系統數據流與結論流完整性檢查_V8.0.md` - 數據流和結論流完整性檢查

### 防遺漏機制 ⭐⭐⭐ **重要**
- `SSOT版本對照檢查表_V8.0.md` ⭐ **版本對照檢查表** - 列出所有 V4.0-V6.0 已定案設計，防止遺漏
- `SSOT更新防遺漏機制_V8.0.md` ⭐ **防遺漏機制** - 更新 SSOT 的標準流程和檢查方法

### 架構文檔
- `V7.1到V8.0架構審查報告.md` - 詳細的審查報告
- `P0.5與P0.6統整分析報告.md` - P0.5/P0.6 統整分析
- `系統架構概要_V7.1_最終版.md` - V7.1 架構概要
- `機構級籌碼面分析架構調整方案.md` - P2.5 模組設計

### 白名單原則
- `白名單原則檢查與修正總結_V8.0.md` - 白名單原則檢查與修正總結
- `P3歷史OHLCV數據獲取與白名單原則檢查_V8.0.md` - P3 歷史 OHLCV 數據獲取檢查

### P2 同業比較設計
- `P2同業比較與相對位置原則確認_V8.0.md` - P2 同業比較原則確認
- `P2同業比較兩階段流程設計_V8.0.md` ⭐ **兩階段流程設計文檔**

### GOOGLEFINANCE 數據源
- `系統數據收集清單_V8.0.md` ⭐ **GOOGLEFINANCE 數據源清單** - 列出所有數據點及其 GOOGLEFINANCE 可用性
- `Gemini建議審查報告_V8.0.md` - Gemini 的 GOOGLEFINANCE 建議審查報告
- `GOOGLEFINANCE測試使用說明_V8.0.md` - 測試工具使用說明
- `數據流測試修正總結_V8.0.md` - 非同步延遲問題修正總結
- ⭐ **V8.0/V8.1/V8.2 數據線暢通測試結果與修正（2026-01-17）**：
  - ✅ **90% 成功**：美股、美債、商品 ETF、板塊 ETF、歷史數據都秒殺成功
  - ⚠️ **10% 失敗**：匯率顯示 `#N/A` 或超時（Google Finance 的 `CURRENCY:` 命名空間在 GAS 環境下可能鎖死）
  - ✅ **V8.1 智能多重代碼讀取器**：
    * **核心機制**：備用代碼映射（Fallback Map）+ 自動回退機制
    * **匯率處理**：`CURRENCY:EURUSD` → 失敗 → 自動嘗試 `EURUSD` → 失敗 → 自動嘗試 `FX:EURUSD`（V8.2 新增）
    * **日股處理**：`TYO:8035` → 失敗 → 自動嘗試 `8035` 或 `SHE:8035` → 成功
    * **歷史數據處理**：`NYSE:TSM` → 失敗 → 自動嘗試 `TSM` → 成功
    * **單元格位置優化**：使用隨機單元格位置（Row 1-10）避免並發衝突
    * **等待時間優化**：每個代碼給 8 秒機會（16次 * 500ms），失敗自動切換備用代碼
  - ✅ **V8.3 混合雙引擎（Hybrid Engine）最終版 + Fail Fast**：
    * **匯率最終救援**：Google Finance（含智能備用代碼：CURRENCY:, EURUSD, FX:）→ 失敗 → 自動切換到 **Stooq 救援**
    * **邏輯流程**：`CURRENCY:EURUSD` → `EURUSD` → `FX:EURUSD` → 全部失敗 → `Stooq (EURUSD)` → 成功
    * **日股數據完整性保護**：
      - ⚠️ **移除危險的純數字 fallback**（如 "8035"），避免 Google 抓到錯誤市場（如香港 8035）
      - **日股必須使用明確前綴**：`TYO:8035` → 失敗 → 嘗試 `SHE:8035` → 若都失敗則回傳 null 交由備援機制
      - **價格合理性檢查**：日股價格 < 1 JPY 視為異常，強制失敗觸發備援
    * **⚠️ V8.3 Fail Fast 機制**：
      - **等待時間大幅縮短**：從 16次(8秒) 縮短至 **8次(4秒)**
      - **解決週末超時問題**：避免 5個匯率 x 3種前綴 x 20秒 = 300秒的超時
      - **快速切換救援**：Google 4秒無反應立即切換到 Stooq/Yahoo，總執行時間從 300秒降至 **30-60秒**
    * **數據來源標記**：成功時標記 `data_source` 為 `GOOGLE_INTERNAL`、`STOOQ_RESCUE` 或 `CSE_RESCUE`
    * **預期效果**：匯率成功率從 0% 提升至 **95%+**（Google 或 Stooq 至少一個可用），日股數據完整性 100%，執行時間縮短 **80%+**

### P6 盤中監測系統
- `P6盤中監測系統可行性分析_V8.0.md` - 可行性分析
- `P6盤中監測系統詳細規格_V8.0.md` ⭐ **詳細規格文檔** - 完整的 P6 設計規格
- `P6盤中監測系統修正規格與決策機制分析_V8.0.md` ⭐ **決策機制分析** - 緊急撤退決策機制深度分析

### GAS → Python 遷移與衍生品報告 ⭐ V8.37 新增
- `Prompt遷移確認報告_GAS至Python_2026-01-26.md` ⭐ **Prompt 遷移無遺漏清單** - GAS 全部 build*Prompt/build*Auditor 函數列表、SSOT 對照、遷移檢查清單，確保改寫 Python 時 Prompt 與詳細架構全量搬移
- `衍生品與數據收集監控分析完整報告_2026-01-26.md` ⭐ **衍生品/數據收集/監控/分析步驟對照** - 衍生品相關功能、數據收集、監控、分析完整內容與系統步驟對照表

### Prompt 對齊與 SSOT 缺口 ⭐ V8.38 新增
- `Prompt對齊與銜接原則_2026-01-26.md` ⭐ **Prompt 對齊原則** - 承襲 GAS、對齊憲法與架構、不遺漏既有功能、前後銜接與最高目標/產出精準檢查要點
- `SSOT細節缺口檢查報告_2026-01-26.md` ⭐ **SSOT 細節缺口** - 非 Prompt 之表結構/公式/閾值/狀態機/觸發條件/錯誤處理等缺口清單與 SSOT 補強建議
- `SSOT細節缺口與遷移備忘錄_2026-01-26.md` ⭐ **遷移備忘錄** - 缺口詳細記載、對齊當前設計；**正式寫程式時仍須再對照 gas_archive/src/ 舊程式碼**，備忘錄為檢查清單與索引
- `P2.5與Daily_Weekly微調討論整理_待定案.md` ⚠️ **待定案** - P2.5 月度機構級、D3/D4 角色與 I/O、宏觀分類 V2.0、三層架構（Collector/Calculator/Interpreter）、Daily 最高目標等討論整理；**用戶定案後再更新 SSOT**

### Daily 每日蒐集清單與白名單 ⭐ SSOT 級（V8.39 新增）
- `Daily每日蒐集清單與白名單_SSOT級_2026-01-26.md` ⭐ **Daily 每天需要蒐集的所有數據** - 討論串蒐集與監控清單全部寫入；D-1～D-4 輸入/產出、宏觀 10–12 類、衍生品 A–G 類 Raw；**來源都必須來自白名單**；**Python 數據來源選項**（GAS 用 CSE，Python 可選專用 API/白名單爬蟲）見該文
- `P2.5與Daily_Weekly修改差異清單_待最終確認.md` ✅ **已定案（V8.40）** - 定案補充 1–10 已納入本 SSOT；差異條列留存備查

### 更新確認
- `V8.0總指引更新確認_V8.0.md` - 總指引更新確認清單

---

## ✅ V8.0 定案確認

- **定案日期**: 2026-01-15
- **封存日期**: 2026-01-17
- **定案時最後更新**: 2026-01-17（GOOGLEFINANCE 數據源整合 + P6 盤中監測系統設計定案 + P4.6/P5.4/P5.5/P5.6 完全統整到 P6 + 數據保留規則明確化）。**全 SSOT 以版本說明之「最後更新」為準。**
- **定案人**: 用戶確認
- **狀態**: ✅ **V8.0 定案封存；實作平台為 Python**，gas_archive 僅供對照
- **實現狀態**: 
  - ✅ **GOOGLEFINANCE 數據源整合**（2026-01-24 確認大部分已實現）
    - ✅ Daily 新聞／宏觀 與 Daily OHLCV 蒐集 實際整合 GOOGLEFINANCE 數據源
    - ✅ P6 整合 GOOGLEFINANCE 數據源
    - ⏳ 移除或標記為備用的原有數據源（待實現）
  - ✅ **P6 盤中監測系統**（2026-01-24 確認大部分已實現）
    - ✅ DEFCON 盤中調整、日誌記錄、目標價監控、財報事件盤中監控
    - ⏳ Time-driven Trigger 設定、P6 記錄整合到 P5 Daily/Weekly（待實現）

### 過往更新內容（2026-01-17）

0. ⭐ **V8.43 D-1B 論壇白名單與 D-1A/D-1B 全程分離**（2026-02-03）：D-1B 論壇白名單 V1（英/中/日論壇具體清單）與搜尋策略（每論壇每日 ≤50 則、回文數 >10、發文 <24h、總量 <300 則）寫入 SSOT；D-1A 與 D-1B 後續處理一致（清洗、多語去重、宏觀資訊分類），且**全程分欄註明來源**：分類須分開欄位註明 D-1A 或 D-1B；D-2 建立索引須分開欄位標註權威新聞 vs 散戶論壇；D-3／D-4 紀錄連結統整快照須分開註明「權威新聞統整」與「散戶論壇統整」；蒐集、整理、分類、紀錄、分析兩來源不得互相汙染或混淆。

1. ⭐ **V8.42 檢查報告採納補強**（2026-02-03）：C4 Hermes 4 強制 include_reasoning/reasoning_trace（Python 實作與 DB schema）；C5 P2_1_FACT_MODEL 最小介面（Minimal Contract）；C6 escalation_path 狀態標記供 WB-2 判斷重度路徑；S2 D-3 與 P6 數據流釐清（收盤後 Daily OHLCV、P6 僅盤中異常）；S3 Learning 防重複強制；S4 板塊定義單一來源與 migration 表；S5 關鍵資產 V1 與數量上限、工程可配置；O1–O3 不進 SSOT、見《GAS 妥協清算與 Python 重建工程備忘錄》。

2. ✅ **GOOGLEFINANCE 數據源整合**：
   - 更新原則 3：白名單數據源原則，加入 GOOGLEFINANCE 配置
   - 更新 Daily 新聞／宏觀 與 Daily OHLCV 蒐集 的數據來源說明，優先使用 GOOGLEFINANCE
   - 新增技術實現說明（`fetchGoogleFinanceSafe`、`fetchGoogleFinanceHistorySafe`）
   - 新增測試工具說明（`26_TEST_GOOGLEFINANCE.js`）
   - ⭐ **數據線暢通測試結果與修正（2026-01-17）**：
     * 測試結果：90% 成功（美股、美債、商品 ETF、板塊 ETF、歷史數據），10% 失敗（匯率、日股）
     * 修正方案已實施：
       - 延長等待時間：從 10秒 (20次) 增加到 20秒 (40次)
       - 匯率 ticker 格式優化：先嘗試直接代碼（`EURUSD`），失敗再嘗試 `CURRENCY:EURUSD`
       - 日股 ticker 格式優化：先嘗試直接代碼（`8035`），失敗再嘗試 `TYO:8035`

3. ✅ **P6 盤中監測系統新增**：
   - 新增 Phase 6 完整設計說明
   - 定義監控對象、頻率、功能、設計原則
   - **⚠️ 核心原則明確**：平常正常監控根本用不到 AI 模型（Rule-Based 即可）
   - **⚠️ 重要**：只有緊急事件的情況才需要決策（盤中 Rule-Based，盤後 AI）
   - 整合到 One Way 架構執行順序

4. ✅ **P4.6 完全移除**：
   - P4.6 所有功能已完全統整到 P6 或 P5 Weekly
   - 盤中緊急撤退 → P6（Rule-Based）
   - 日結後戰略評估 → P5 Weekly（AI 分析）

5. ✅ **P5.5 財報監控任務搬移到 P6**：
   - 從 P5 Daily 收盤後檢查 → P6 盤中即時監控
   - 監控 Weekly 制定的 if-then 策略中的 if 條件（財報公布等特殊情形）

6. ✅ **P5.6 目標價監控任務搬移到 P6**：
   - 從 P5 Daily 收盤後檢查 → P6 盤中即時監控（每 20 分鐘）
   - 檢查台股是否觸及買入/賣出價位，立即提醒使用者

7. ✅ **P5.4 盤中監控功能搬移到 P6**：
   - 盤中異常偵測功能已搬移到 P6
   - P5 Daily 不再負責盤中監控任務

8. ✅ **P6 數據保留規則明確**：
   - **一般正常情況**：隔天即清除，不保留（節省存儲空間）
   - **觸發異常的情況**：必須保留當天詳細數據，一同進入 P5 Daily 留存的日更資料
     * 觸發急漲/急跌的個股或市場
     * 觸發緊急撤退協議的個股
     * 觸發財報 if-then 策略的個股
     * 觸及目標價位的台股
   - **數據整合流程**：P6 標記為「需保留」→ P5 Daily 整合到日更資料 → P6 隔天清除一般數據

6. ✅ **V7.1 到 V8.0 主要變更更新**：
   - 加入 GOOGLEFINANCE 數據源整合說明
   - 加入 P6 盤中監測系統新增說明
   - 明確 P4.6 和 P5.4 的功能搬移

### 之前更新內容（2025-01-14）

1. ✅ **加入最高等級設計原則**：
   - 原則 1：機構級預測視角（P3 核心靈魂）
   - 原則 2：P2 同業比較與相對位置原則（兩階段流程設計）
   - 原則 3：白名單數據源原則

2. ✅ **更新 P2 模組說明**：
   - 加入同業比較與相對位置原則（兩階段流程）
   - 加入同業定義（不是同板塊，而是相同細分產業）
   - 加入同業分類要求（龍頭/中大型/小型新創，禁止跨分類比較）
   - 加入兩階段執行流程說明（Stage 1: AI 識別同業，Stage 2: 程式計算相對位置）
   - 加入數據來源（白名單原則）說明

3. ✅ **更新 P2.5 模組說明**（補強項目）：
   - 加入對沖基金 Clone 詳細實現說明（Top 10 對沖基金清單、Clone 評分邏輯）

4. ✅ **更新 P3 模組說明**：
   - 加入機構級預測視角說明
   - 加入統一調度說明（P2/P2.5/P3 統一調度）
   - 加入數據來源（白名單原則）說明
   - 確認已實現讀取歷史 OHLCV 數據

5. ✅ **更新 P5 Daily 模組說明**：
   - 加入白名單數據源說明
   - 加入技術指標分級計算優化（每日輕量 vs 每週完整）
   - 確認技術指標由程式計算，不讓 AI 計算
   - 加入市場寬度數據收集說明（Advance/Decline、New High/Low、Stocks Above MA50/MA200）

6. ✅ **更新 Daily 籌碼／衍生品蒐集 模組說明**（Sonnet 審查修正）：
   - 修正數據收集頻率（13F: 季度，內部人: 每週，Dark Pool: 每週）
   - 加入新增使用者（P5 Weekly 籌碼面彙總）

7. ✅ **更新 P5 Weekly 模組說明**（Sonnet 審查修正 + 補強項目）：
   - P5.7: 加入籌碼面週報彙總功能 + Sector ETF Flow 分析 + Regime 分析補強
   - P5.8: 加入結合籌碼面信號
   - Weekly_final: 加入籌碼面影響個股策略 + AI 動態權重 + Hitchhiking 監控

8. ✅ **更新 P5.5 模組說明**（Sonnet 審查修正）：
   - 重構職責分工（Daily: 僅監控，Weekly: 制定策略）

9. ✅ **更新 P5 Monthly 模組說明**（Sonnet 審查修正）：
   - 加入學習機制 AI 模型驅動說明

10. ✅ **更新 P5 Quarterly 模組說明**（Sonnet 審查修正）：
    - 加入持倉整合邏輯詳細說明（Phase_Out 策略）

11. ✅ **更新 V7.1 到 V8.0 主要變更**：
    - 加入數據收集頻率優化
    - 加入 P2 同業比較兩階段流程設計

12. ✅ **更新待完成工作清單**：
    - 標記已完成的項目（P3 機構級預測視角、白名單原則、P3 讀取歷史 OHLCV 數據、P2 同業比較兩階段流程）
    - 加入補強項目（Sector ETF Flow 分析、融合評分權重機制、Regime 分析補強、Hitchhiking 監控、P2.5 Clone 詳細實現、P5 Weekly Regime 輸出格式）

13. ✅ **補強項目實現完成**（2025-01-14）：
    - ✅ Sector ETF Flow 分析：已實現 `analyzeSectorETFFlows()` 和 `identifyRotation()` 函數，整合到 P5 Weekly 世界觀分析
    - ✅ 融合評分權重機制：已改為 AI 動態決定權重，加強 Prompt，更新輸出格式
    - ⏳ Regime 分析補強：Prompt 輸出格式已更新（60%），市場寬度數據收集和準度追蹤待實現（40%）
    - ✅ Hitchhiking 監控：已實現 `monitorHitchhiking()` 函數，整合到 P5 Weekly 個股策略
    - ✅ P2.5 Clone 詳細實現：已明確 Top 10 對沖基金清單和 Clone 評分邏輯
    - ✅ P5 Weekly Regime 輸出格式：已補充 `regime_transition`、`u_macro_recommendation`、`risk_assessment` 欄位

14. ✅ **V7.1 補充手冊整合完成**（2025-01-14）：
    - ✅ **Weekly 財報日個股籌碼權重加強**：
      - 實現位置：`24_P5_WEEKLY_STOCK_STRATEGY.js` 的 `buildStockStrategyBatchPrompt` 函數
      - 實現內容：在 prompt 中補強，若掃描兩週內目前持倉個股有公布財報，必須調整機構籌碼面的權重到短期最高
      - 具體規則：smart_money 權重提高到 0.25-0.35，institutional 權重提高到 0.15-0.20
      - 新增函數：`checkEarningsEvent()` 用於檢查股票是否有財報事件
    - ✅ **Mag 7 集體表現分析**：
      - 實現位置：`24_P5_WEEKLY_WORLDVIEW.js`
      - 實現函數：`analyzeMag7CollectivePerformance()` 
      - 功能：Mag 7 成員財報評分（+2 到 -2），總分映射到 Regime 和 U_macro
      - 整合：整合到 P5 Weekly 世界觀分析和 prompt 中，影響 Regime 判斷和 U_macro 調整
      - Prompt 補強：在 `buildWorldviewPrompt` 中加入 Mag 7 集體表現分析說明和規則
    - ❌ **排除項目**（8 項）：籌碼面分析（T-7 天）、情境劇本系統、預期管理、相對表現分析、估值儀表盤、供應鏈傳導分析、撤退後評估機制、市場健康度儀表盤（已由現有機制覆蓋或不符合 V8.0 架構）

---

---

## ⚠️ 防遺漏機制（強化版）

### ⚠️ 重要教訓（2026-01-19）

**問題**：V7時就已經詳細定案的動態學習系統設計（Closed-loop Brain），在後續討論中逐漸遺漏，沒有記進SSOT，導致：
- 重複工作
- 重要設計遺漏
- 沒有備份可查

**解決方案**：
1. 所有已定案設計必須立即記進SSOT
2. 建立V7設計完整統整文檔（`V8.13_V7動態學習系統設計完整統整.md`）
3. 強化防遺漏機制，確保以後不會再發生類似問題

### 更新 SSOT 的標準流程（強化版）

**每次更新 SSOT 前必須執行**：

1. **讀取所有相關設計文檔**
   - 檔案：`SSOT版本對照檢查表_V8.0.md`
   - 檔案：`V8.13_V7動態學習系統設計完整統整.md`（V7設計）
   - 檔案：其他已定案的設計文檔
   - 確認所有已定案設計列表

2. **讀取現有 SSOT 文檔**
   - 確認現有內容
   - 標記已實現/待實現狀態

3. **對照檢查（嚴格執行）**
   - 確認每個已定案設計都在 SSOT 中
   - 標記缺失的項目
   - **特別注意**：檢查是否有遺漏的設計細節（如V7設計中的四項Scorecard、錯誤歸因、情境記憶等）

4. **執行更新（嚴格遵守）**
   - **保留所有已定案設計**（絕對不能刪除或忽略）
   - 只能補充或修正
   - 標記來源版本（例如：V6.0 原始設計、V7設計）
   - **新增設計必須立即記進SSOT**（不能等到後續討論）

5. **更新後驗證（必須執行）**
   - 再次對照所有設計文檔
   - 確認所有已定案設計都保留
   - 確認所有設計細節都被記錄（不能只記錄概要）

6. **建立備份文檔（新增）**
   - 對於重要的設計變更，建立獨立的備份文檔（如`V8.13_V7動態學習系統設計完整統整.md`）
   - 確保即使SSOT被壓縮摘要，詳細設計也不會遺漏

### 防遺漏檢查清單

**每次更新SSOT前必須檢查**：

- [ ] 是否讀取了所有相關設計文檔？
- [ ] 是否對照了所有已定案設計？
- [ ] 是否標記了所有缺失的項目？
- [ ] 是否保留了所有已定案設計（沒有刪除或忽略）？
- [ ] 是否標記了來源版本？
- [ ] 是否建立了備份文檔（對於重要設計）？
- [ ] 是否確認了所有設計細節都被記錄（不只是概要）？

**詳細說明**：請參考 `SSOT更新防遺漏機制_V8.0.md` 和 `V8.13_V7動態學習系統設計完整統整.md`

---

**此文檔為 V8.0 架構的 SSOT（Single Source of Truth），所有後續開發和調整都應基於此文檔。**

**⚠️ 重要提醒**：更新此文檔時，必須嚴格遵循防遺漏機制，確保所有 V4.0-V6.0 已定案設計都完整保留。

---

## ✅ 系統設計階段完成聲明

**完成日期**：2026-01-19

**完成狀態**：✅ **系統設計階段完成，實作平台為 Python**；gas_archive 僅供對照

### 完成項目總結

1. **核心功能實現**：100% 完成
   - V8.15：P2 成長性分析、P0.5 產業鏈動態監控、P3-P6 整合、P5 Weekly 雙層架構 ✅
   - V8.16：AI 工作流程優化 ✅
   - V8.17：Batch API 整合 ✅

2. **補丁應用**：100% 完成
   - P1 Prompt 補丁（結構分級原則）✅
   - P2 Prompt 補丁（Runway = 風險）✅
   - P4 風控補丁（風險上限）✅
   - P4 風險檢查（除以零、變數名稱、Infinity/NaN）✅

3. **工程地雷修復**：100% 完成
   - 地雷 1：AI 記憶體無限膨脹（三層記憶模型）✅
   - 地雷 2、3（執行層）：GAS 時代以可重入設計、Trigger 清掃為過渡 ✅；**目標架構**為任務隊列 + Worker + 長任務原生支援，新平台須依目標架構實作，見架構總覽與工程備忘錄
   - 地雷 4：人類訊號被 AI 覆蓋（Human Lock 機制）✅

4. **三大行事曆數據流完整性**：100% 完成 ✅
   - 重大財經事件（P5__CALENDAR）：Input/Output 數據流完整，包含五年歷史市場反應、建議加強監控數據、Weekly 掃描觸發監控、Daily 關鍵數據監控、Weekly 決策要點整合 ✅
   - 板塊龍頭財報（EARNINGS_CALENDAR）：Input/Output 數據流完整，包含五年歷史經驗、Weekly 掃描觸發監控、Daily 關鍵數據監控、Weekly 決策要點整合 ✅
   - 持股財報（HOLDINGS_EARNINGS_CALENDAR）：Input/Output 數據流完整，P4 完成後自動生成（一次完成：五年歷史經驗 + 預估今年財報日期），Daily 新聞更新使用 AI 分類（`Earnings_Date_Announcement`）✅

5. **持股財報完整分析系統**：100% 完成 ✅
   - P4 完成後自動生成（`27_HOLDINGS_EARNINGS_COMPLETE.js`）✅
   - 一次完成：過去五年歷史經驗 + 預估今年財報日期 ✅
   - AI 模型配置：Hermes 4（正式模式，Batch API）或 Gemini Flash 3.0（測試模式，同步 API）✅
   - Daily 新聞更新：使用 AI 分類（`Earnings_Date_Announcement`），不再使用關鍵字 ✅

**系統設計階段簽核**：✅ **完成**（實作平台為 Python，gas_archive 僅供對照）

---

## ⭐ 標準化工作流程規則（永久記憶）

### 規則 1：程式變動自動更新到 SSOT

**所有程式新增或變動都必須自動更新到 SSOT**

**執行時機**：每次完成程式變動後立即執行

**執行步驟**：
1. 列出所有新增的檔案
2. 列出所有修改的檔案
3. **立即更新 SSOT 文檔**（`V8.0架構定案文檔_SSOT.md`）
   - 記錄新增功能的位置、實現方式、關鍵函數
   - 記錄修改功能的變更內容、影響範圍
   - 標記實現狀態（✅ 已完成 / ⚠️ 待完成）
   - 添加版本標記（例如：⭐ V8.26 新增）

**SSOT 更新要求**：
- 必須在完成程式變動後立即更新，不得延遲
- 必須詳細記錄變更內容，不得遺漏
- 必須標記實現狀態和版本號
- 必須記錄實現位置（檔案路徑、函數名稱）

**實現位置**：`.cursorrules` 文件中的「標準化工作流程」章節

**⭐ SSOT 版本標示規則（V8.41）**：更新 SSOT 時**勿使用「最新」二字**，僅標示**版本流水號**（如 V8.xx）與**最後更新日期**，以免混淆。

**規則 2（已廢止）**：~~SSOT 更新後自動上傳到 GAS~~ — GAS 已中止，實作以 Python 為準；此規則不再適用。

---

**重要提醒**：
- 規則 1（程式變動須更新 SSOT）須在每次對話中嚴格遵守，不得遺漏
- 即使對話被壓縮或重置，此規則仍然有效
- 此規則已寫入永久記憶（`.cursorrules` 文件），AI 助手會自動遵循

---

## ⭐ V8.26 系統架構深度審查修復報告（2026-01-26）

### 審查範圍
- 完整系統架構、141個程式檔案、SSOT V8.0 文檔
- 審查角色：資深架構師 + 百億美金投資經理 + 幾十年產業研究員

### 致命級問題修復狀態

#### ✅ C2. 學習系統斷鏈（已完成）
- **問題**：`getLearningFeedback()` 有寫入但沒有在 P5-B Prompt 中使用，導致系統會不斷重複犯同樣的錯誤
- **修復**：在 `buildP5_BPrompt()` 和 `buildP5_BUserPayloadForBatch()` 中添加 `learning_feedback` 指令區塊
- **實現位置**：`src/24_P5_WEEKLY_DUAL_LAYER.js`
- **狀態**：✅ **已完成**

#### ✅ C5. P1 財報提取完整性檢查（已確認）
- **問題**：Flash 提取後未驗證必含章節（P1/P2/P3），不完整時無標記
- **修復**：已在 `saveFinancialReportExtraction` 中調用 `validateFinancialReportExtraction`
- **實現位置**：`src/20_P1_FINANCIAL_REPORTS.js`
- **狀態**：✅ **已確認完整**

#### ✅ C4. P3 Cat 轉換邏輯（已完成）
- **問題**：`validateCatTransition` 函數存在但未被調用，導致 Cat 轉換違規無法被檢測
- **修復**：在 `compareWithPreviousSnapshotP3` 中添加 Cat 轉換驗證，違規時強制回退到上週的 Cat
- **實現位置**：`src/22_P3_SNAPSHOT.js`
- **狀態**：✅ **已完成**

#### ✅ C1. P5 Weekly 權重決定機制（已於 V8.26 完成）
- **問題**：硬約束檢查已調用，但 Prompt 中缺少基準權重指引，AI 不知道「合理的權重配置」是什麼樣子
- **修復**：① 在 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 中添加基準權重指引；② 明確允許偏差範圍（±15%），超過 ±20% 需說明理由；③ 提供調整原則（系統級風險優先、籌碼面與基本面衝突時優先相信籌碼等）
- **實現位置**：`src/24_P5_WEEKLY_DUAL_LAYER.js`（gas_archive 對照用）
- **狀態**：✅ **已完成**

#### ✅ C3. P2 成長性分析（已確認）
- **問題**：Growth_Quality_Score 計算公式缺失
- **修復**：已完整實現 `computeGrowthQualityScore()` 函數，公式為 `0.30 × growth_rate_score + 0.25 × growth_consistency_score + 0.20 × operating_leverage_score + 0.25 × cash_conversion_score`
- **實現位置**：`src/21_P2_FUNDAMENTAL_ANALYSIS.js`
- **狀態**：✅ **已確認完整**

### Prompt 調整原則（V8.26 新增）

**核心原則**：AI 邏輯推理 > 一致性

**分層設計**：
1. **Layer 1: 硬約束（HARD CONSTRAINTS）**：數學邊界 + 系統級風控（程式強制執行，AI 無法繞過）
2. **Layer 2: 強烈建議（STRONG GUIDELINES）**：策略邏輯 + 經驗規則（AI 可以例外，但必須說明理由）
3. **Layer 3: 軟引導（SOFT GUIDELINES）**：基準參數 + 優先級原則（提供錨點，AI 自由調整 ±15%）
4. **Layer 4: 自由空間（FREE SPACE）**：完全 AI 自主的推理空間

**Prompt 寫作原則**：
- 明確區分層級（硬約束 vs 強烈建議 vs 軟引導）
- 提供基準但允許偏離（±15%，超過 ±20% 需說明理由）
- 例外機制（從「禁止」改為「謹慎 + 說明理由」）
- 要求說明理由（AI 調整時必須在 reasoning 中明確說明）

**預期修改**：
- 放鬆 Order Plan 規則（從「禁止」改為「謹慎 + 說明理由」）
- 軟化硬約束語氣（從「命令」改為「強烈建議 + 例外機制」）
- 提供權重基準但允許調整
- 明確區分硬約束與強烈建議

**狀態**：✅ **已完成**
- **修改內容**：
  1. ✅ **Order Plan 規則放鬆**：STOP_LIMIT 從「禁止使用」改為「謹慎使用 + 例外機制 + 說明理由」（在 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 中）
  2. ✅ **財報前清倉規則軟化**：從「硬規則（必須嚴格遵守）」改為「強烈建議規則（除非有明確反向證據，否則應遵守）」（在 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 中）
  3. ✅ **權重基準指引**：在 `buildP5_BPrompt()` 和 `buildP5_APrompt()` 中添加基準權重（fundamental 30%、chips 25%、tech 25%、macro 10%、sentiment 10%），允許偏差 ±15%，超過 ±20% 需說明理由
  4. ✅ **調整原則提供**：明確提供 7 條調整原則（系統級風險優先、籌碼面與基本面衝突時優先相信籌碼等）
- **實現位置**：`src/24_P5_WEEKLY_DUAL_LAYER.js`
- **核心原則**：AI 邏輯推理 > 一致性；提供基準但允許偏離；要求說明理由；例外機制而非絕對禁止

---

## ⭐ V8.27 終極增強方案實現狀態（2026-01-26）

### 實現狀態更新

#### ✅ 增強 1：Daily 新聞反覆矛盾檢測與標記（已完成）
- **實現位置**：
  - `src/24_P5_DAILY_NEWS.js`：`deduplicateAndCategorizeWithGeminiPro` 函數
  - `src/24_P5_WEEKLY_DUAL_LAYER.js`：`buildP5_BPrompt` 和 `buildP5_APrompt` 函數
- **修改內容**：
  - Daily Prompt 新增反覆矛盾檢測邏輯（`event_stability`、`contradiction_pattern`、`contradiction_reasoning`）
  - Weekly Prompt 新增深度思考指引（不直接忽略，而是深度思考為什麼會這樣）

#### ✅ 增強 2：P0 必然性驅動的動態集中度管理（已完成）
- **實現位置**：
  - `src/09_P0_INDUSTRY_ENGINEERING.js`：`buildP0Prompt` 函數（新增 conviction_level 輸出）
  - `src/21_P2_FUNDAMENTAL_ANALYSIS.js`：`buildP2Prompt` 函數（基於 P0 conviction_level 設定 Position_Role）
  - `src/10_P4_CALCULATOR.js`：`calculateTierAllocationsV8_15` 函數（動態調整 single_max）
- **修改內容**：
  - P0 輸出新增 `conviction_level`、`conviction_reasoning`、`conviction_confidence` 欄位
  - P2 Prompt 新增基於 P0 conviction_level 的 Position_Role 映射邏輯
  - P4 動態調整 single_max（ULTRA_HIGH → 30%，HIGH → 20%，其他保持預設）

#### ✅ 增強 3：掛單價格調整的逆向投資能力（已完成）
- **實現位置**：
  - `src/24_P5_WEEKLY_DUAL_LAYER.js`：`buildP5_BPrompt` 和 `buildP5_APrompt` 函數
  - `src/24_P5_WEEKLY_STRATEGY_SKELETON.js`：`applyParameterAdjustmentVector` 函數
- **修改內容**：
  - Weekly Prompt 新增逆向投資信號檢測（5 個條件全部成立）
  - 修正 `buy_bias` 公式（正數 = 價格上調，負數 = 價格下調）

#### ✅ 增強 4：P0 優先級與因子權重動態調整（已完成）
- **實現位置**：
  - `src/24_P5_WEEKLY_DUAL_LAYER.js`：`buildP5_BPrompt` 和 `buildP5_APrompt` 函數
  - `src/24_P5_WEEKLY_STOCK_STRATEGY.js`：`integrateStockFactors` 函數（提取 P0 conviction_level）
- **修改內容**：
  - Weekly Prompt 新增根據 P0 conviction_level 的動態權重基準
  - Weekly Prompt 新增 P2 安全閘門（硬約束，覆蓋所有權重）

#### ⚠️ 增強 5：學習系統反饋權重調整（待長期實施）
- **狀態**：此項為長期實施項目，需要建立 P5 Monthly 學習分析功能
- **計劃**：待系統運行一段時間後，根據實際表現數據建立學習分析機制

### 實現狀態

**狀態**：✅ **核心功能已完成**

**修改的檔案清單**：
1. `src/24_P5_DAILY_NEWS.js` - Daily 新聞反覆矛盾檢測
2. `src/24_P5_WEEKLY_DUAL_LAYER.js` - Weekly Prompt 增強（反覆矛盾思考、逆向投資、動態權重、P2 安全閘門）
3. `src/24_P5_WEEKLY_STRATEGY_SKELETON.js` - buy_bias 公式修正
4. `src/09_P0_INDUSTRY_ENGINEERING.js` - P0 conviction_level 輸出
5. `src/21_P2_FUNDAMENTAL_ANALYSIS.js` - P2 基於 P0 conviction_level 設定 Position_Role
6. `src/10_P4_CALCULATOR.js` - P4 動態集中度上限
7. `src/24_P5_WEEKLY_STOCK_STRATEGY.js` - 提取 P0 conviction_level

---

## ⭐ V8.28 GAS→Python 改寫準備：SSOT 補齊（2026-01-26）+ ⭐ V8.33 目標架構與工程備忘錄

**目的**：為 GAS 全部改寫成 Python 做準備，將程式碼中已實現但 SSOT 未集中記載的功能與 AI 工作細節補齊，避免改寫時遺漏。

**⭐ V8.33 必讀**：**Python 重建時須依《GAS 妥協清算與 Python 重建工程備忘錄》執行。** 本 SSOT 已將曾因 GAS 限制而採用的妥協/閹割性設計改寫為**目標架構（完美版設計）**（見架構總覽「目標架構與 GAS 過渡說明」「執行層與任務調度」「資料存儲」「數據源」）；實作時**不得**將 GAS 時代的可重入/Trigger 串接/Sheets 當 DB/GOOGLEFINANCE 為主等原樣複製，否則換平台等於白換。詳細工程實現方法見該備忘錄。

### 1. 全系統 AI 工作紀錄文檔

- **文檔名稱**：`全系統AI工作紀錄_2026-01-26.md`
- **內容**：按 Phase 整理所有會用到 AI 模型的工作內容、對齊目標、目前寫好的 Prompt 位置與要點。
- **涵蓋範圍**：P0、P0 時效性驗證、P0.5、P0.7、P1 Step1/Step2、P1 財報提取、P2（含 P2-1/P2-2 拆分）、P2.5、P3、P4（無 AI）、P5 Daily（含 D-1～D-4 四模型）、P5 Weekly（P5-B/P5-A）、P5 Monthly/Quarterly、持股財報完整分析、行事曆歷史經驗、P5 Weekly Learning、審查者/Scout/Deep Auditor Prompt；以及未經 M0 的直接 API 調用清單。
- **用途**：改寫 Python 時對照，確保每一處 AI 呼叫與 Prompt 邏輯都有對應實現。

### 1.1 各階段 Prompt 補強參考（⭐ V8.29 新增）

- **文檔名稱**：`各階段Prompt補強參考_2026-01-26.md`
- **性質**：建議與補強性質，僅作增量補強，不修改或覆蓋現有 Prompt。
- **內容**：Analyst/Scout/Deep Auditor 的補強概念、關注點、觸發與重點；角色校準器與未來對齊三問的實施參考。
- **用途**：實作或改寫時，在對應 Phase 的 Prompt 最前/最後加入校準器與三問區塊時對照。

### 1.2 定案用檢查清單（⭐ V8.29 新增）

- **文檔名稱**：`定案用檢查清單_2026-01-26.md`
- **目的**：在系統設計定案、一次性實作程式碼前，確認所有設計與介面已收斂。
- **內容**：最高原則與架構、AI 雙模型與審查、P2 拆分、P5 Daily 拆分、介面與資料流、Prompt 與心法、文件與版本、實作前最終確認。
- **用途**：定案前逐項勾選，確保無遺漏。
- **⭐ V8.34 補充**：每次改動後另須依 **架構師級 SSOT 檢查清單**（`架構師級SSOT檢查清單_V8.md`）五大區塊 17 項過濾，找出邏輯錯誤、系統打架、重複工作、I/O 遺失、接口錯誤、無限迴圈、結構錯位等「未來會爆炸的點」；審查報告見 `SSOT架構師級審查報告_V8.34_2026-01-26.md`。

### 2. 長任務與任務調度（目標架構）⭐ V8.33

- **目標設計**：長任務（Monthly/Quarterly 全跑、P0.7 模擬、P5 Weekly 全量整合）應可**單次執行**或由**任務隊列排程**分段，無需以「固定時間切段 + 可重入續跑」為核心架構。任務狀態機：RUNNING / PARTIAL / RETRYING / FAILED / COMPLETED。
- **GAS 過渡**：GAS 現行「可重入設計」實現位置（如 `20_P1_FINANCIAL_REPORTS_REENTRANT.js`、`24_P5_WEEKLY_REENTRANT.js`）為過渡；**新平台（如 Python）實作時不得以可重入/Trigger 串接為核心**，須依架構總覽「執行層與任務調度（目標架構）」改為任務隊列 + Worker + 長任務原生支援，具體工程方法見《GAS 妥協清算與 Python 重建工程備忘錄》。

### 3. 審查者 Prompt 一覽（實現位置）

- **通用審查者（含原始資料）**：`03_M0_CORE.js` → `buildAuditorPromptWithQuestions(executorQuestions, previousResult, originalData, projectId)`。審查者會收到原始資料（財務數據、master_candidates、P1 財報、同業、P2 evidence、P2.5、技術指標、snapshot_diff 等）以驗證執行者結論。
- **事實查證審查**：`03_M0_CORE.js` → `buildAuditorPromptWithFactCheck(executorQuestions, previousResult, auditorInitialReview, geminiSearchResult)`。
- **P1 Step 2 審查**：`03_M0_CORE.js` → `buildP1Step2AuditorPrompt(executorOutput, financialReportData, executorQuestions)`；須對照 Flash 提取的財報資料驗證結構分級。
- **P3 審查**：`22_P3_CORE.js` → `buildP3AuditorPrompt(executorOutput, stockData, reviewReasons)`；用於觸發式審查（約 15–25%）。

### 4. P0 時效性驗證與重新分析

- **流程**：P0 第一次分析（OPUS）→ 產出 validation_questions → 人工下載 PDF 至 Google Drive → Gemini File API 讀取 PDF 提取段落 → OPUS 重新分析（buildP0ReanalysisPrompt）→ GPT-5.2 審查。
- **Prompt 位置**：`09_P0_VALIDATION.js` → `buildP0ReanalysisPrompt(initialAnalysis, validationResults)`。Gemini 讀取 PDF 為 File API，不經 M0 隊列。

### 5. P5 Daily 新聞與網路熱度 AI 函數名

- **新聞原子化/清洗**：`24_P5_DAILY_NEWS.js` → `atomizeNewsWithGeminiFlash`、`processNewsBatchWithGeminiFlash`（使用 Gemini Flash，批次約 100 則）。
- **去重與多維度分類**：`24_P5_DAILY_NEWS.js` → `deduplicateAndCategorizeWithGeminiPro`（使用 Gemini Pro，多語去重、事件屬性、影響層級、情緒、Related_Tickers、Earnings_Date_Announcement 等）。
- **驗證（時效性/語意/數據/Proxy）**：`24_P5_DAILY_NEWS.js` → `verifyNewsDataWithDailyDB`、`batchVerifyNewsData`（依設計可能使用 Gemini 或程式邏輯，以實際程式為準）。
- **⭐ V8.30 新增：網路文章與討論（第三類輸入）**：
  - **使用者貼文判讀**：接收使用者貼上的網路文章/討論內容 → AI 判讀真偽與邏輯、抽取真相與有價值部分、連接個股索引；僅經判讀確認真實且有價值的內容納入個股或世界觀參考因子。實現：待新建或擴充 Daily 模組（如 `24_P5_DAILY_USER_PASTE.js`），UI 介面待實現。
  - **每日論壇熱度**：固定搜尋中/英/日散戶集中論壇（論壇白名單）→ **D-1B 論壇管線**（grok 4.1 fast，**與 D-1A 新聞管線分開 Prompt、分開 API 呼叫**，保證權威新聞與散戶論壇嚴格分隔不汙染）處理（內容清洗、判讀、多語去重、分析、散戶溫度計、連結個股或宏觀索引）→ 產出僅寫入 `WEB_SENTIMENT_DAILY`。實現時：**D-1A** = 新聞專用 Prompt + 新聞輸入 + 新聞輸出表；**D-1B** = 論壇專用 Prompt + 論壇輸入 + `WEB_SENTIMENT_DAILY`；兩次獨立呼叫。

### 6. 持股財報與行事曆 AI 函數名

- **持股財報完整分析（P4 完成後觸發）**：`27_HOLDINGS_EARNINGS_COMPLETE.js`（呼叫 M0 或同步 API）；`27_EARNINGS_HISTORICAL_EXPERIENCE.js` → `buildEarningsHistoricalExperiencePrompt(ticker, quarter)`；`27_HOLDINGS_EARNINGS_GENERATOR.js` → `buildEarningsDatesPrompt(ticker)`；`27_HOLDINGS_EARNINGS_COMPLETE.js` → `buildSingleTickerPrompt()`、`buildBatchPrompt()`。
- **重大財經事件歷史經驗**：`18_P5_CALENDAR_MANAGER.js` → `buildCalendarHistoricalExperiencePrompt(event)`。
- **M0 配置**：`02_M0_CONFIG.js` 中 `P5_CALENDAR_INTENSIVE_ANALYSIS`、`CALENDAR_HISTORICAL_EXPERIENCE`、`EARNINGS_HISTORICAL_EXPERIENCE`。

---

## 附錄：GAS 時代／現行設計對照（僅供對照，實作以目標架構為準）

**說明**：以下為 GAS 現行實現與舊設計文字，**僅供對照與既有程式維護**；新系統（如 Python）實作時**以主文目標架構為準**，不得將本附錄設計原樣複製到新平台。

### 附錄 A：Weekly 雙層 AI 架構（WB-1 / WB-2）— GAS 時代對照

- **⭐ V8.15 待實現：雙層 AI 架構（P5-B / P5-A）** ✅ **已實現** + **⭐ V8.16 更新（P5-B 移除審查者，改用 Validator）**
  - **Layer 1：P5-B（Weekly State Evaluator）**：每檔都跑（低成本，Claude Hermes 4）+ **無審查者**（只用 Validator）⭐ V8.16 更新
    - **輸出**：`state_vector`、`parameter_adjustment_vector`、`escalation_score`
    - **Validator 檢查項目**（⭐ V8.16 新增）：B1. Schema validation；B2. Range validation；B3. Rule validation；B4. Drift control
  - **Layer 2：P5-A（Weekly Deep Re-evaluation）**：僅升級少數（10-20%），Claude o3（執行者）+ GPT-5.2（審查者）；觸發 Gate：`escalation_score > 0.6`、`trend_integrity < 0.4`、`distribution_risk > 0.7`、`chain_dynamics_signal === "DIVERGENCE"`、`p2_5.insider_selling_alert === true`、`p2_5.abnormal_13f_distribution === true`
  - **✅ 已實現**：`P5_B_Execute()`、`P5_A_Execute()`、P5-B Validator、P5-B/P5-A Batch API、P5 Weekly Core 整合 Batch 結果處理（GAS 實現位置見主文相關章節或程式碼）。

---

### 附錄 B：GAS 時代作廢設計清單 ⭐ V8.44 新增

> [!WARNING]
> **以下設計已作廢，Python 實作時不得複製。**

#### 完全作廢的設計

| 設計 | GAS 原因 | 為何作廢 | Python 替代方案 |
|------|----------|----------|-----------------|
| **6 分鐘可重入設計** | GAS 執行時間上限 | Python 無此限制 | 任務隊列 + Worker Pool |
| **Sheets 作為核心 DB** | GAS 原生整合 | 效能低、無事務 | Postgres / Supabase |
| **GOOGLEFINANCE 主來源** | GAS 內建 | 不穩定、延遲高 | yfinance / 可靠 API（主）；GOOGLEFINANCE 僅 P6 備援 |
| **台股民國年轉換** | TWSE/TPEX 格式 | yfinance 標準格式 | 不需轉換 |
| **同步 API 呼叫** | GAS 無原生非同步 | 效能低 | 非同步 + Batch |
| **P5.1/P5.2/P5.3 分工** | 按數據類型 | 架構已改 | D-1~D-4（按流程分工） |
| **P5.4/P5.5/P5.6** | GAS 時代設計 | 已搬移到 P6 | P6 負責盤中監控 |
| **P5-B/P5-A 雙層** | GAS 設計 | 架構已改 | WB-1/WB-2/W-A |
| **CMD 常駐可重入** | GAS 時代需可重入模式處理中斷 | Python 長任務原生支援 | 狀態機 + 任務隊列 |
| **分時觸發累積** | GAS 時代規避 6 分鐘限制 | Python 無此限制 | 連續執行 |

#### 需轉換的設計（概念保留，實作方式改變）

| 設計 | GAS 實作 | Python 實作建議 |
|------|----------|-----------------|
| **PropertiesService 狀態存儲** | Google 屬性服務 | Redis / 環境變數 / DB |
| **Sheets 數據存儲** | Google Sheets | Postgres / Supabase |
| **Cloud Function 代理** | GCP Cloud Function | 直接 API 呼叫或本地代理 |
| **GOOGLEFINANCE 數據** | Sheets 公式 | yfinance / 其他 API |

---

### 附錄 C：Prompt 設計原則 ⭐ V8.44 新增

> [!IMPORTANT]
> **核心原則**：GAS 代碼作為 Prompt 主體 + SSOT 最高原則對齊，衝突時以 SSOT 為準。

#### 原則 1：GAS 代碼作為 Prompt 主體

每個 AI 呼叫的 Prompt 應**按照 GAS 舊程式碼的主體**：
- 保留核心業務邏輯
- 保留輸出 Schema
- 保留驗證邏輯

**GAS Prompt 函數清單**（需遷移）：

| 區塊/模組 | 函數名稱 | 檔案位置 |
|-----------|----------|----------|
| P1 | `buildP1Prompt` | `20_P1_FINANCIAL_REPORTS.js` |
| P2 | `buildP2Prompt` | `21_P2_FUNDAMENTAL_ANALYSIS.js` |
| P2.5 Monthly | `buildP2_5_MonthlyPrompt` | `21_P2_5_INSTITUTIONAL.js` |
| P2.5 Quarterly | `buildP2_5_QuarterlyPrompt` | `21_P2_5_INSTITUTIONAL.js` |
| P3 | `buildP3Prompt` | `22_P3_AI_ANALYSIS.js` |
| P5-B | `buildP5_BPrompt` | `24_P5_WEEKLY_DUAL_LAYER.js` |
| P5-A | `buildP5_APrompt` | `24_P5_WEEKLY_DUAL_LAYER.js` |
| P5 Stock Strategy | `buildStockStrategyBatchPrompt` | `24_P5_WEEKLY_STOCK_STRATEGY.js` |
| P5 Daily News | `processNewsBatchWithGeminiFlash` | `24_P5_DAILY_NEWS.js` |

#### 原則 2：SSOT 最高原則與憲法對齊

在 GAS 主體之上，須對齊 SSOT 中的最高原則：

| 原則 | 版本 | 適用範圍 |
|------|------|----------|
| 六條憲法 | V8.29 + V8.31 | 所有 Phase |
| DSFP 動態現況優先原則 | V8.32 | Daily / Weekly |
| 史官鐵律 | V8.31 | D-3 / D-4 |
| Daily 最高目標 | V8.40 | D-1 ~ D-4 |
| D-1A/D-1B 全程分離原則 | V8.43 | D-1A / D-1B / D-2 / D-3 / D-4 / Weekly |

#### 原則 3：衝突時以 SSOT 為準

**若 GAS 舊設計與 SSOT 新設計違背，則以 SSOT 為準。**

#### 原則 4：各模組 Prompt 強化方向

| 模組 | Prompt 強化方向 |
|------|-----------------|
| **D-1A** | 「僅處理權威新聞」「禁止混入論壇」「多維度標籤」「宏觀 10-12 類對接」 |
| **D-1B** | 「僅處理散戶論壇」「禁止混入權威新聞」「散戶溫度計」「權重遠低於機構」 |
| **D-2** | 「產業面影響判斷」「分欄標註資料源 D-1A/D-1B」 |
| **D-3** | 「史官鐵律」「不負責策略」「分欄註明來源」「前三天歷史銜接」「REVERSAL_NOISE」 |
| **D-4** | 「史官鐵律」「10-12 類宏觀子世界」「歷史與現狀銜接」「分欄區分來源」「REVERSAL_NOISE」 |
| **WB-1** | 「世界觀統整」「DSFP 身份裁決」「escalation 判定」 |
| **WB-2** | 「Strategy Skeleton」「參數調整向量」「Order DSL」「引用 worldview_version」 |
| **W-A** | 「觸發式審查」「世界觀重建」「P1-P4 重跑範圍」 |

---

**報告完成日期**：2026-02-04  
**狀態**：✅ **V8.44 SSOT 完整清理與補強完成**；包含史官鐵律、Daily 最高目標、D-1~D-4 完整定義、AI 模型配置表、REVERSAL_NOISE、P2 Safety Score Hard Caps、GAS 作廢設計清單、Prompt 設計原則。

---

#### V8.45 Terminology Alignment (T-NAME-01) — 2026-02-04

**Objective**: Eliminate dual terminology. Engineering milestones (Mxx) are internal build tags; SSOT terms are authoritative for all business logic.

| Engineering Milestone | Code Location | SSOT Ownership | User-facing term |
|---|---|---|---|
| M00 | dev.ps1 / cli entry | Infra | One-command workflow |
| M01 | src/nuclear/storage | Infra | Cold snapshot storage |
| M02 | src/nuclear/db | Infra | Run index + snapshot index |
| M03 | src/nuclear/history | Daily (D-3/D-4) | History reconciliation (read-only) |

**Rule**: All functional discussions and specs must use SSOT names (WB-1, D-3, etc.). Milestone IDs (M00-M03) appear only in changelogs or commit messages.
