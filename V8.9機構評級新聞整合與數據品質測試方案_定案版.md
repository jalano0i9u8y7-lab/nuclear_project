# V8.9 機構評級新聞整合與數據品質測試方案（定案版）

## 📋 問題分離

### 問題 1：新聞品質優化（適用於所有 P5 新聞管線）

**範圍**：
- 時效性測試（±6 小時，避免與前一天新聞重複）
- 雜訊過濾優化（針對白名單網站客製化）
- 多語支持（英文、中文、日文）
- 範圍精準性測試（涵蓋十大分類，無雜訊、無非正式新聞）

**十大分類**：
1. 財報/業績
2. 併購/重組
3. 監管/政策
4. 產業動態
5. 宏觀經濟
6. 市場情緒
7. 技術突破
8. 供應鏈
9. 競爭格局
10. 其他

**適用對象**：
- `NEWS_ATOMS_DAILY`（一般財經綜合新聞）
- `INSTITUTIONAL_RATINGS_DAILY`（機構評級新聞）

---

### 問題 2：機構評級資料的專屬設計

**範圍**：
- 獨立資料庫 `INSTITUTIONAL_RATINGS_DAILY`
- 多時間維度股價反應驗證
- 融入歷史動態學習系統

**時間維度定義**：
- **短期**：1-5 天（機構放話後先演戲的階段）
- **中期**：7-15 天（真實意圖開始顯現）
- **長期**：16 天到一個月左右（最終驗證）

**用途**：
- 分開做相關度計算
- 融入歷史動態學習系統
- 知道各大機構放話出來的真實可信度在不同時間段各有多少

---

## 🎯 改進方案

### 方案 1：新聞品質優化（全 P5 新聞管線）

#### 1.1 CSE 配置決策 ⭐ **待確認**

**選項 A：使用同一個 CSE（`P5_NEWS`）**
- **優點**：
  - 統一管理，減少配置複雜度
  - 機構評級新聞來源（The Fly、鉅亨網、Minkabu）可以加入 `P5_NEWS` 白名單
  - 共用時效性、雜訊過濾等優化邏輯
- **缺點**：
  - `P5_NEWS` 目前主要針對權威媒體和官方敘事源
  - 機構評級新聞來源（The Fly、鉅亨網、Minkabu）與現有來源類型不同
  - 可能影響搜尋精準度

**選項 B：創建專屬 CSE（`P5_INSTITUTIONAL_RATINGS`）**
- **優點**：
  - 專門針對機構評級新聞來源（The Fly、鉅亨網、Minkabu）
  - 搜尋查詢可以更精準（例如：專門搜尋 "upgrade"、"downgrade"、"target price"）
  - 不影響現有 `P5_NEWS` 的搜尋邏輯
- **缺點**：
  - 需要額外配置一個 CSE
  - 需要維護兩套白名單

**建議**：**選項 B（創建專屬 CSE）** ✅ **已確認**

**CSE 白名單配置（基於 Gemini 建議）**：

**🇺🇸 美股（US Markets）- 華爾街快訊三巨頭**：
- **The Fly (thefly.com)** ⭐ 絕對核心
  - 理由：華爾街公認最快、最乾淨的評級快訊源頭，90% 的財經新聞都是抄它的
  - 標題極度標準化（例如 "Goldman upgrades NVDA to Buy"），Regex 解析成功率最高
- **StreetInsider (streetinsider.com)**
  - 理由：專門有一個 "Analyst Ratings" 板塊，更新速度極快
- **Benzinga (benzinga.com)**
  - 理由：它的 "Analyst Ratings" 新聞流非常有結構，涵蓋面廣
- **TipRanks (tipranks.com)** ⭐ 輔助
  - 理由：雖然它是資料庫型網站，但其新聞摘要頁面常包含詳細的目標價變動

**🇹🇼 台股（Taiwan Markets）- 外資報告轉譯權威**：
- **鉅亨網 (news.cnyes.com)** ⭐ 核心
  - 理由：擁有專門的「外資觀點」標籤，標題通常會寫「外資調升/調降...目標價上看...」
- **經濟日報 (money.udn.com)**
  - 理由：老牌財經媒體，對於大型權值股（台積電、聯發科）的外資報告摘要非常詳盡
- **工商時報 (ctee.com.tw)** ⭐ 備援
  - 理由：作為鉅亨網的備援，有時會有獨家的法人觀點

**🇯🇵 日股（Japan Markets）- 本土散戶聖經**：
- **Minkabu (minkabu.jp)** ⭐ 核心
  - 理由：日本最大的股票資訊站，它的「証券アナリスト予想 (證券分析師預想)」更新極快
- **Kabutan (kabutan.jp)**
  - 理由：專注於速報，其「明日の好悪材料」和評級新聞非常即時
- **Traders Web (traders.co.jp)** ⭐ 專業性較高
  - 理由：專業性較高，常刊登詳細的機構評級變動表

**理由**：機構評級新聞的搜尋查詢格式與一般新聞不同（需要搜尋 "upgrade"、"downgrade"、"target price" 等關鍵字）
- 專屬 CSE 可以更精準地鎖定 Tier 2 快訊聚合網站
- 不影響現有 `P5_NEWS` 的搜尋邏輯

#### 1.2 時效性測試（±6 小時）

**測試方法**：
1. **時間戳提取**：
   - 從新聞標題/摘要中提取發布時間
   - 考慮各地區時差：
     - **美股**：EST/EDT（UTC-5/-4）
     - **台股**：CST（UTC+8）
     - **日股**：JST（UTC+9）

2. **「當天」定義**：
   - 當前時間 ±6 小時範圍內
   - 例如：如果當前是 2026-01-18 14:00（台股時間），則「當天」範圍為 2026-01-18 08:00 到 2026-01-18 20:00
   - **注意**：±6 小時是為了避免與前一天新聞重複，但也要確保能抓到當天最新新聞

3. **測試指標**：
   - 當天新聞比例（應 > 80%）
   - 過期新聞比例（> 3 天的新聞應 < 5%）
   - 時間戳提取成功率（應 > 90%）

#### 1.3 範圍精準性測試（涵蓋十大分類）

**測試方法**：
1. **分類驗證**：
   - 使用 AI 模型（GEMINI_FLASH）自動分類新聞
   - 確認 `category` 分類是否正確（涵蓋十大分類）
   - 檢查是否有明顯的非財經內容

2. **關鍵字過濾（多語支持）**：
   - **財經關鍵字白名單（多語）**：
     - 英文：`stock`, `market`, `trading`, `earnings`, `rating`, `target price`, `upgrade`, `downgrade`
     - 中文：`股票`, `市場`, `交易`, `財報`, `評級`, `目標價`, `調升`, `調降`
     - 日文：`株式`, `市場`, `取引`, `決算`, `レーティング`, `目標株価`, `引上げ`, `引下げ`
   - **非財經關鍵字黑名單（多語）**：
     - 英文：`celebrity`, `sports`, `movie`, `entertainment`（非財經相關）
     - 中文：`娛樂`, `體育`, `電影`, `明星`（非財經相關）
     - 日文：`芸能`, `スポーツ`, `映画`, `エンタメ`（非財經相關）

3. **測試指標**：
   - 財經相關新聞比例（應 > 95%）
   - 十大分類覆蓋率（每個分類都應該有新聞，或至少 8/10 個分類有新聞）
   - 誤分類新聞比例（應 < 3%）

#### 1.4 雜訊過濾測試（針對白名單網站客製化，無非正式新聞）

**測試方法**：
1. **URL 驗證（白名單網站特定）**：
   - **The Fly (thefly.com)**：
     - 有效模式：`/story/[ticker]-target-...`、`/news/[ticker]-upgrade...`
     - 無效模式：首頁、分類頁、廣告頁
   - **鉅亨網 (anue.com.tw)**：
     - 有效模式：`/news/id/[數字]`、`/amp/news/[標題]`
     - 無效模式：`/tag/`、`/category/`、廣告頁
   - **Minkabu (minkabu.jp)**：
     - 有效模式：`/stock/[代碼]/news`、`/stock/[代碼]/rating`
     - 無效模式：首頁、搜尋結果頁、廣告頁

2. **非正式新聞過濾（多語支持）**：
   - **論壇特徵檢測（多語）**：
     - 英文：`forum`, `discussion`, `thread`, `comment`, `user post`
     - 中文：`論壇`, `討論區`, `留言`, `網友`, `鄉民`
     - 日文：`掲示板`, `フォーラム`, `スレッド`, `コメント`
   - **社論特徵檢測（多語）**：
     - 明顯的觀點性文字、缺少事實陳述
     - 標題包含「我認為」、「我的看法」等主觀性詞彙
   - 使用 AI 模型（GEMINI_FLASH）檢測內容類型（多語支持）

3. **白名單網站特定雜訊過濾規則**：
   - **The Fly**：過濾「Market Movers」等非評級新聞
   - **鉅亨網**：過濾「投資教室」、「理財專欄」等非即時新聞
   - **Minkabu**：過濾「コラム」（專欄）類別的非評級新聞

4. **測試指標**：
   - 雜訊比例（應 < 5%，由於有白名單限制，預期會更低）
   - 非正式新聞比例（論壇、社論等，應 < 2%）
   - 白名單來源比例（應 = 100%，因為 CSE 已限制）
   - URL 有效性（應 > 95%）

#### 1.5 可驗證性測試

**測試方法**：
1. **URL 可訪問性**：測試每條新聞的 URL 是否可以訪問
2. **內容一致性**：對比新聞標題/摘要與實際網頁內容（抽樣測試）
3. **來源可信度**：確認新聞來源是否為可信的財經媒體

**測試指標**：
- URL 可訪問率（應 > 95%）
- 內容一致性（抽樣測試，應 > 90%）

---

### 方案 2：機構評級資料的專屬設計

#### 2.1 獨立資料庫 `INSTITUTIONAL_RATINGS_DAILY`

**表格結構**：
```
date                    - 評級發布日期
ticker                  - 股票代碼
market                  - 市場（US/TW/JP）
rating_firm             - 機構名稱（如 Goldman Sachs, 摩根士丹利）
rating_action           - 評級動作（Upgrade/Downgrade/Maintain/Initiate）
from_grade              - 原評級（如 Buy, Hold）
to_grade                - 新評級（如 Strong Buy, Buy）
from_price              - 原目標價
to_price                - 新目標價
target_change           - 目標價變化（格式化的文字，如 "$150 -> $180"）
news_title              - 新聞標題
news_summary            - 新聞摘要
news_url                - 新聞連結
news_source             - 新聞來源（The Fly, 鉅亨網, Minkabu）
rating_date             - 評級發布日期（從新聞中提取）
rating_time             - 評級發布時間（如果可提取）
implied_fpe             - 隱含 FPE（計算：to_price / consensus_forward_eps）
created_at              - 資料創建時間
```

#### 2.2 多時間維度股價反應驗證

**時間維度定義**：
- **短期**：1-5 天（機構放話後先演戲的階段）
- **中期**：7-15 天（真實意圖開始顯現）
- **長期**：16 天到一個月左右（最終驗證）

**驗證指標**（每個時間維度分別計算）：
- 累積漲跌幅（`changePct`）
- 成交量變化（`volumeSpike`：volume > 2x average volume）
- 價格反應一致性（評級動作與股價變化的方向是否一致）

**實施步驟**：
1. **擴展 `getPriceReaction()` 函數**：
   - 支援多時間維度查詢（短期 1-5 天、中期 7-15 天、長期 16-30 天）
   - 從 `MARKET_OHLCV_DAILY` 讀取對應時間範圍的價格數據
   - 返回每個時間維度的驗證結果

2. **升級 `analyzeSmartSentiment()` 函數**：
   - 整合多時間維度的股價反應驗證結果
   - 根據不同時間維度的股價反應，判斷機構放話的真實意圖
   - 生成更精確的 `warnings`（例如：「短期誘多但中期跟進」）

#### 2.3 融入歷史動態學習系統

**學習目標**：
- 各大機構放話出來的真實可信度在不同時間段各有多少
- 例如：Goldman Sachs 的 Upgrade 在短期（1-5 天）可信度 60%，中期（7-15 天）可信度 80%，長期（16-30 天）可信度 75%

**實施步驟**：
1. **創建 `INSTITUTIONAL_RATINGS_LEARNING_LOG` 表格**：
   ```
   rating_id              - 評級記錄 ID（關聯到 INSTITUTIONAL_RATINGS_DAILY）
   ticker                 - 股票代碼
   market                 - 市場
   rating_firm            - 機構名稱（標準化後的機構名稱，例如 "GOLDMAN_SACHS"）
   rating_action          - 評級動作（標準化後：UPGRADE/DOWNGRADE/MAINTAIN/INITIATE）
   rating_date            - 評級發布日期
   short_term_result      - 短期（1-5 天）股價反應結果（JSON）
   mid_term_result        - 中期（7-15 天）股價反應結果（JSON）
   long_term_result       - 長期（16-30 天）股價反應結果（JSON）
   credibility_score_short - 短期可信度評分（根據股價反應計算）
   credibility_score_mid   - 中期可信度評分
   credibility_score_long  - 長期可信度評分
   credibility_score_final - 最終可信度評分（加權平均）
   created_at             - 記錄創建時間
   updated_at              - 更新時間（每個時間維度完成後更新）
   ```

2. **機構分組設計**：
   - 每個機構獨立一個區塊（例如：高盛一個區塊、大摩一個區塊）
   - 只收錄我們有持股的歷史評級（從 `Phase1_Master_Candidates` 或 `Phase2_Output` 讀取持股清單）
   - 每個市場只追蹤五間以內龍頭機構

2. **計算可信度評分**：
   - **短期可信度**（評級發布後 5 天更新）：
     - 如果評級動作與短期股價反應一致（Upgrade + 上漲，或 Downgrade + 下跌），則可信度 +1
     - 如果不一致（Upgrade + 下跌，或 Downgrade + 上漲），則可信度 -1
     - 如果股價變化不明顯（< 2%），則可信度 0
   - **中期可信度**（評級發布後 15 天更新）：
     - 同樣邏輯，但看 7-15 天的累積股價反應
   - **長期可信度**（評級發布後 30 天更新）：
     - 同樣邏輯，但看 16-30 天的累積股價反應
   - **最終可信度**（所有時間維度完成後更新）：
     - 加權平均（短期 30%、中期 40%、長期 30%）
     - 範圍：-1（完全不可信）到 +1（完全可信）

3. **去重邏輯**：
   - 同一個機構對同一檔股票，一個月內只看最新的一條動作
   - 如果同一個機構在一個月內發布兩次評級，使用「最新覆蓋舊的」邏輯
   - 舊的評級標記為 `superseded_by`，但保留在資料庫中（用於分析「機構轉彎」的情況）

3. **整合到 `P5__LEARNING_LOG`**：
   - 在 `saveP5WeeklyLearningLog()` 中新增 `institutional_ratings_credibility` 欄位
   - 記錄各大機構在不同時間維度的可信度評分
   - 格式：`{ "GOLDMAN_SACHS": { "short_term": 0.6, "mid_term": 0.8, "long_term": 0.75, "final": 0.72 }, ... }`

4. **多數機構的預測共識 = FPE_B**：
   - 統計當天所有機構的評級動作（只統計我們有持股的股票）
   - 計算「多數機構的預測共識」（例如：5 家機構中，3 家 Upgrade，2 家 Maintain → 共識為「看多」）
   - 整合到現有的 `collectMarketSentimentIndicators()` 中，作為 `fpe_b` 的一部分
   - 用於預先判斷市場氣氛（而非事後驗證）

---

## ❓ 待確認問題

### 1. CSE 配置決策 ⭐ **關鍵問題**

**問題**：機構評級資料應該使用同一個 CSE（`P5_NEWS`）還是創建專屬 CSE（`P5_INSTITUTIONAL_RATINGS`）？

**建議**：創建專屬 CSE（`P5_INSTITUTIONAL_RATINGS`）
- 理由：機構評級新聞的搜尋查詢格式與一般新聞不同，專屬 CSE 可以更精準

**待確認**：是否同意此建議？

### 2. 時間維度定義 ✅ **已確認**

- **短期**：1-5 天
- **中期**：7-15 天
- **長期**：16 天到一個月左右（約 30 天）

### 3. 測試閾值 ✅ **已確認**

- **時效性**：±6 小時（避免與前一天新聞重複）
- **合格標準**：
  - 涵蓋十大分類
  - 沒有雜訊
  - 沒有非正式新聞（論壇、社論）
  - 時效性符合要求（±6 小時內）

### 4. 其他可能的問題

#### 4.1 機構評級資料的收集頻率

**問題**：機構評級資料應該每天收集，還是只在有評級變動時收集？

**建議**：每天收集（因為評級變動可能發生在任何時候）

**待確認**：是否同意？

#### 4.2 歷史資料回溯 ✅ **已確認**

**確認內容**：
- **逐步累積**：從系統上線那天開始搜尋，按照評級公布的日期開始分析
- **回朔期**：一個月（30 天）的歷史資料來做相關度計算
- **理由**：
  - 同一個機構對同一檔股票一個月內不太會變動（機構不是當沖客，轉向需要時間，有信譽成本）
  - 分析短中長期最多到一個月已經足夠，市場不太會超過一個月才反應
  - 超過一個月雜訊太多，已經無法判斷相關度
- **去重邏輯**：同一個機構對同一檔股票，一個月內只看最新的一條動作（最新覆蓋舊的）

**實施方式**：
- 系統上線當天：開始收集當天的機構評級資料
- 每天收集：持續收集當天的機構評級資料
- 逐步建立歷史資料庫：隨著時間推移，自然累積歷史資料
- 不需要立即回溯：避免資料庫爆掉和雜訊太多

#### 4.3 可信度評分的更新機制

**問題**：可信度評分應該何時更新？是在每個時間維度結束後立即更新，還是等所有時間維度都完成後再更新？

**建議**：
- 短期可信度：在評級發布後 5 天更新
- 中期可信度：在評級發布後 15 天更新
- 長期可信度：在評級發布後 30 天更新
- 最終可信度：在所有時間維度都完成後更新

**待確認**：是否同意此更新機制？

#### 4.4 多機構評級的處理 ✅ **已確認**

**確認內容**：
- **每個機構都分開獨立一個區塊**：
  - 例如：高盛發布的所有評級一個區塊、大摩的一個區塊、野村證券的一個區塊
  - 這樣才能累積歷史經驗後，知道哪些機構常常騙人或是帶假風向
- **只收錄我們有持股的歷史評級**：
  - 避免資料庫爆掉和雜訊太多
  - 只針對 `Phase1_Master_Candidates` 或 `Phase2_Output` 中的股票收集評級
- **每個市場大概抓五間以內龍頭機構的評級就可以**：
  - 不需要雜魚機構
  - **美股（US Markets）- 華爾街五虎**：
    1. **Goldman Sachs (高盛)** - 絕對的多頭總司令，趨勢製造者
    2. **Morgan Stanley (摩根士丹利)** - 報告深度夠，對半導體產業影響力大
    3. **JPMorgan (小摩)** - 資金量大，通常代表保守派資金的動向
    4. **Citi (花旗)** - 對總體經濟敏感，常作為風向轉折指標
    5. **Bank of America (美銀) / Barclays (巴克萊)** - 對於硬體製造業（如 Apple 供應鏈）有很深的調研
  - **台股（Taiwan Markets）- 喊得動台積電的外資**：
    1. **Morgan Stanley (大摩)** - 台股最具影響力的外資，沒有之一
    2. **JPMorgan (小摩)** - 常與大摩唱對台戲，兩者同向時威力巨大
    3. **Goldman Sachs (高盛)** - 對半導體週期判斷很準
    4. **Nomura (野村)** - 近年在 AI 伺服器領域的報告非常激進且精準
    5. **CLSA (里昂) / Macquarie (麥格理) / UBS (瑞銀)** - 對非電子股或中型股有獨到見解
  - **日股（Japan Markets）- 本土御三家 + 外資巨頭**：
    1. **Nomura (野村證券)** - 日本證券界絕對霸主，它的評級能直接決定當天日股走勢
    2. **Daiwa (大和證券)** - 僅次於野村，影響力巨大
    3. **SMBC Nikko (日興證券)** - 本土御三家之一
    4. **Goldman Sachs Japan** - 外資在日本的最強代表
    5. **Mizuho (瑞穗) / Jefferies** - 對日本科技股著墨較深
- **每筆評級都單獨記錄**：
  - 在計算「多數機構的預測共識」時，統計當天所有機構的評級動作
  - 在股價反應驗證時，分別驗證每筆評級
- **多數機構的預測共識 = FPE_B**：
  - 作為市場情緒指標
  - 整合到現有的 `collectMarketSentimentIndicators()` 中

#### 4.5 評級動作的標準化 ✅ **已確認（需要解釋）**

**什麼是「標準化」？**

**問題**：不同機構或不同新聞來源的評級動作用詞可能不同，例如：
- 英文：`upgrade`、`raise`、`lift`、`boost`、`increase`（都是「調升」的意思）
- 英文：`downgrade`、`cut`、`lower`、`reduce`、`decrease`（都是「調降」的意思）
- 中文：`調升`、`上調`、`調高`、`上修`、`調升評等`（都是「調升」的意思）
- 中文：`調降`、`下調`、`調低`、`下修`、`調降評等`（都是「調降」的意思）
- 日文：`引上げ`、`引き上げ`、`上方修正`（都是「調升」的意思）
- 日文：`引下げ`、`引き下げ`、`下方修正`（都是「調降」的意思）

**標準化的目的**：
- 統一不同來源的用詞，方便後續分析和統計
- 例如：將所有「調升」相關的詞彙統一轉換為 `"Upgrade"`
- 將所有「調降」相關的詞彙統一轉換為 `"Downgrade"`

**如何標準化？**

**實施方法**：在 `parseNewsTitleForRating()` 函數中建立標準化對照表

```javascript
// 評級動作標準化對照表（多語支持）
const RATING_ACTION_MAP = {
  // 調升（Upgrade）
  "upgrade": {
    "en": ["upgrade", "raise", "lift", "boost", "increase", "improve"],
    "zh": ["調升", "上調", "調高", "上修", "調升評等", "上調評等"],
    "ja": ["引上げ", "引き上げ", "上方修正", "引き上げる"]
  },
  // 調降（Downgrade）
  "downgrade": {
    "en": ["downgrade", "cut", "lower", "reduce", "decrease", "downgrade"],
    "zh": ["調降", "下調", "調低", "下修", "調降評等", "下調評等"],
    "ja": ["引下げ", "引き下げ", "下方修正", "引き下げる"]
  },
  // 維持（Maintain）
  "maintain": {
    "en": ["maintain", "reiterate", "keep", "hold", "unchanged"],
    "zh": ["維持", "重申", "保持", "不變"],
    "ja": ["維持", "据え置き", "変更なし"]
  },
  // 初始評級（Initiate）
  "initiate": {
    "en": ["initiate", "start", "begin", "cover", "new coverage"],
    "zh": ["初始", "開始", "首次", "新覆蓋"],
    "ja": ["開始", "新規", "初回"]
  }
};

// 標準化函數
function standardizeRatingAction(text, language) {
  const lowerText = text.toLowerCase();
  const langMap = {
    "en": "en",
    "zh": "zh",
    "ja": "ja",
    "zh-TW": "zh",
    "zh-CN": "zh"
  };
  const lang = langMap[language] || "en";
  
  // 檢查每個標準動作
  for (const [standardAction, variants] of Object.entries(RATING_ACTION_MAP)) {
    for (const variant of variants[lang] || []) {
      if (lowerText.indexOf(variant.toLowerCase()) > -1) {
        return standardAction.toUpperCase(); // 返回 "UPGRADE", "DOWNGRADE", "MAINTAIN", "INITIATE"
      }
    }
  }
  
  return null; // 無法識別
}
```

**標準化後的輸出格式**：
- `rating_action` 欄位統一使用：`"UPGRADE"`、`"DOWNGRADE"`、`"MAINTAIN"`、`"INITIATE"`
- 方便後續統計和分析（例如：統計「有多少機構調升了這支股票」）

**待確認**：是否需要建立標準化的評級動作對照表？ ✅ **已確認：需要**

---

## 📝 後續行動

**已確認事項**：
1. ✅ 時間維度定義（短期 1-5 天、中期 7-15 天、長期 16-30 天）
2. ✅ 測試閾值（時效性 ±6 小時、涵蓋十大分類、無雜訊、無非正式新聞）
3. ✅ 機構評級資料的定位和用途

**已確認事項**：
1. ✅ CSE 配置決策：創建專屬 CSE（`P5_INSTITUTIONAL_RATINGS`），使用 Gemini 建議的完整白名單
2. ✅ 機構評級資料的收集頻率：每天收集（列入 Daily）
3. ✅ 歷史資料回溯：從系統上線那天開始搜尋，逐步累積，回朔一個月的歷史資料，同一個機構對同一檔股票一個月內只看最新的一條動作
4. ✅ 可信度評分的更新機制：同意建議的更新機制（短期 5 天、中期 15 天、長期 30 天）
5. ✅ 多機構評級的處理：每個機構分開獨立區塊，只收錄有持股的歷史評級，每個市場抓五間以內龍頭機構
6. ✅ 評級動作的標準化：需要建立標準化的評級動作對照表（已解釋標準化概念和實施方法）
7. ✅ 多數機構的預測共識 = FPE_B，作為市場情緒指標

**等待用戶確認以下事項後再開始實施**：
1. ✅ 各市場的五大龍頭機構名單（已確認，使用 Gemini 建議的名單）

**定案後的行動**：
1. 實作新聞品質測試函數（適用於所有 P5 新聞管線）
2. 實作機構評級資料收集函數（P5 Daily）
3. 實作多時間維度股價反應驗證函數（P5 Weekly）
4. 實作可信度評分計算和學習系統整合
5. 測試所有功能

---

**文檔日期**：2026-01-18  
**版本**：V8.9（定案版）  
**狀態**：✅ **全部確認完成，準備實作**

---

## ⚠️ 重要提醒：數據流對接完整性

**用戶明確要求**：這些辛辛苦苦的資料與分析，都要進入：
1. ✅ **Weekly 的決策系統因子之中**
2. ✅ **歷史動態學習系統之中**

**數據流對接檢查**：

### 1. 機構評級資料 → P5 Weekly 決策系統 ✅

**整合點**：
- `collectMarketSentimentIndicators()` → `institutional_sentiment` → P5 Weekly Prompt
- **多數機構的預測共識 = FPE_B** → `fpe_b` → P5 Weekly Prompt
- `analyzeSmartSentiment()` 的 `warnings` 和 `sentiment_label` → P5 Weekly Prompt

**P5 Weekly 決策因子**：
- `u_adjustment` - 應參考機構評級的 `warnings`（誘多/誘空警告）
- `trigger_decisions` - 應參考機構評級的 `warnings`（建議觸發 P3/P4 重新分析）
- `weekly_worldview.market_regime` - 應參考多數機構的預測共識

### 2. 機構評級資料 → 歷史動態學習系統 ✅

**整合點**：
- `INSTITUTIONAL_RATINGS_LEARNING_LOG` - 記錄多時間維度可信度評分
- `P5__LEARNING_LOG` → `systematicLearning.institutional_ratings_credibility` - 記錄各大機構在不同時間維度的可信度評分
- 格式：`{ "GOLDMAN_SACHS": { "short_term": 0.6, "mid_term": 0.8, "long_term": 0.75, "final": 0.72 }, ... }`

**學習目標**：
- 知道各大機構放話出來的真實可信度在不同時間段各有多少
- 用於後續決策權重調整（例如：如果 Goldman Sachs 的短期可信度低，但中期可信度高，則在短期忽略其評級，在中期重視其評級）

### 3. 數據流完整性確認 ✅

**已確認的對接點**：
- ✅ 機構評級資料收集 → `INSTITUTIONAL_RATINGS_DAILY`
- ✅ 機構評級資料 → `collectMarketSentimentIndicators()` → P5 Weekly Prompt
- ✅ 多數機構的預測共識 → `fpe_b` → P5 Weekly Prompt
- ✅ 股價反應驗證 → `INSTITUTIONAL_RATINGS_LEARNING_LOG` → 可信度評分
- ✅ 可信度評分 → `P5__LEARNING_LOG` → 歷史動態學習系統
- ✅ P5 Weekly 決策系統使用機構評級資料（`u_adjustment`、`trigger_decisions`）

---

## 📋 實作準備清單

### 1. CSE 配置
- [ ] 在 Google CSE 後台創建 `P5_INSTITUTIONAL_RATINGS` CSE
- [ ] 設定白名單（The Fly, StreetInsider, Benzinga, TipRanks, 鉅亨網, 經濟日報, 工商時報, Minkabu, Kabutan, Traders Web）
- [ ] 在 GAS PropertiesService 中設置 `GOOGLE_CSE_CX_P5_INSTITUTIONAL_RATINGS`

### 2. 表格結構
- [ ] 創建 `INSTITUTIONAL_RATINGS_DAILY` 表格（在 `01_SHEETS_STRUCTURE.js` 中定義）
- [ ] 創建 `INSTITUTIONAL_RATINGS_LEARNING_LOG` 表格（在 `01_SHEETS_STRUCTURE.js` 中定義）

### 3. 機構白名單配置 ✅ **已確認名單**
- [x] 定義各市場的五大龍頭機構名單（已確認，使用 Gemini 建議的名單）
- [ ] 建立機構名稱標準化對照表（例如：Goldman Sachs → GOLDMAN_SACHS, 高盛 → GOLDMAN_SACHS, 摩根士丹利 → MORGAN_STANLEY）

**機構名稱標準化對照表（需要建立）**：
- **美股**：
  - Goldman Sachs → GOLDMAN_SACHS
  - Morgan Stanley → MORGAN_STANLEY
  - JPMorgan / J.P. Morgan → JPMORGAN
  - Citi / Citigroup → CITI
  - Bank of America / BofA → BANK_OF_AMERICA
  - Barclays → BARCLAYS
- **台股**：
  - Morgan Stanley / 大摩 / 摩根士丹利 → MORGAN_STANLEY
  - JPMorgan / 小摩 / 摩根大通 → JPMORGAN
  - Goldman Sachs / 高盛 → GOLDMAN_SACHS
  - Nomura / 野村 → NOMURA
  - CLSA / 里昂 → CLSA
  - Macquarie / 麥格理 → MACQUARIE
  - UBS / 瑞銀 → UBS
- **日股**：
  - Nomura / 野村證券 → NOMURA
  - Daiwa / 大和證券 → DAIWA
  - SMBC Nikko / 日興證券 → SMBC_NIKKO
  - Goldman Sachs Japan → GOLDMAN_SACHS_JAPAN
  - Mizuho / 瑞穗 → MIZUHO
  - Jefferies → JEFFERIES

### 4. 評級動作標準化
- [ ] 建立評級動作對照表（多語支持）
- [ ] 實作 `standardizeRatingAction()` 函數

### 5. 核心功能實作
- [ ] `collectInstitutionalRatings()` - P5 Daily 收集函數
- [ ] `getInstitutionalRatingsFromDatabase()` - P5 Weekly 讀取函數
- [ ] `getPriceReaction()` - 多時間維度股價反應驗證（擴展）
- [ ] `analyzeSmartSentiment()` - 升級版機構言行一致性分析
- [ ] 可信度評分計算函數
- [ ] 去重邏輯（同一個機構對同一檔股票，一個月內只看最新的一條）

### 6. 新聞品質測試
- [ ] `testNewsTimeliness()` - 時效性測試（±6 小時）
- [ ] `testNewsRelevance()` - 範圍精準性測試（涵蓋十大分類）
- [ ] `testNewsQuality()` - 雜訊過濾測試（針對白名單網站客製化，無非正式新聞）
- [ ] `testNewsVerifiability()` - 可驗證性測試

### 7. 整合
- [ ] 整合到 `P5_Daily_Execute()` 流程
- [ ] 整合到 `collectMarketSentimentIndicators()`（多數機構的預測共識 = FPE_B）
- [ ] 整合到 `saveP5WeeklyLearningLog()`（可信度評分記錄）
- [ ] **確認數據流對接完整性**：機構評級資料 → P5 Weekly 決策系統因子 → 歷史動態學習系統
