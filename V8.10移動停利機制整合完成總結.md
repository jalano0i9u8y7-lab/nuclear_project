# V8.10 移動停利機制整合完成總結

**版本**：V8.10  
**日期**：2026-01-18  
**狀態**：✅ **完成**

---

## ✅ 已完成的工作

### 1. 移動停利模組創建
- ✅ 創建 `28_P6_TRAILING_STOP.js` 模組
  - `P6_CheckTrailingStop()` - 移動停利監測主函數
  - `checkTrailingStopForStock()` - 檢查單檔股票的移動停利觸發條件
  - `getRecentHighestPrice()` - 獲取最近 3 日最高價（從 `MARKET_OHLCV_DAILY` 讀取）
  - `getMA10()` - 獲取 MA10（從 `MARKET_INDICATORS_DAILY` 讀取）
  - `checkVolumeSpikeForTrailingStop()` - 檢查量能確認（美股要求爆量）
  - `getPreviousTrailingStopCheck()` / `saveTrailingStopCheck()` - 確認跌破 MA10（連續 2 次）
  - `executeTrailingStopExit()` - 執行移動停利觸發後的緊急撤退

### 2. P6 盤中監測整合
- ✅ 在 `28_P6_INTRADAY_MONITOR.js` 中整合移動停利檢查
  - 在 `P6_RunIntradayMonitor()` 中新增移動停利檢查邏輯
  - 新增 `getCurrentBubbleStage()` 函數（從 PropertiesService 或 P5 Weekly 快照讀取）
  - 當泡沫階段為 LATE 時自動啟動移動停利機制
  - 觸發後自動執行緊急撤退

### 3. P5 Weekly 泡沫階段保存
- ✅ 在 `24_P5_WEEKLY_CORE.js` 中保存泡沫階段到 PropertiesService
  - P5 Weekly 執行時，將泡沫階段保存到 `PropertiesService`（供 P6 讀取）
  - 確保 P6 能夠即時獲取最新的泡沫階段

### 4. P6 緊急撤退協議更新
- ✅ 在 `28_P6_EMERGENCY_EXIT.js` 中新增 `TRAILING_STOP` 觸發類型
  - 減倉比例：50%（核心持倉最多減 30%）
  - 保留核心持倉邏輯
  - 移動停利專用的撤退邏輯

### 5. SSOT 文檔更新
- ✅ 更新 `V8.0架構定案文檔_SSOT.md` P6 章節
  - 新增移動停利機制說明
  - 更新檔案列表（新增 `28_P6_TRAILING_STOP.js`）

---

## 📊 移動停利機制工作流程

### 1. P5 Weekly 階段
1. P5 Weekly 執行時，調用 `P5_6_BubbleNavigation()` 判斷泡沫階段
2. 如果泡沫階段為 `LATE`，保存到 PropertiesService：`P5_9_BUBBLE_STAGE = "LATE"`
3. U（總資金水位）維持高水位（80-100%），進入走鋼索模式

### 2. P6 盤中監測階段
1. P6 每次執行時（每 20 分鐘），調用 `getCurrentBubbleStage()` 讀取泡沫階段
2. 如果泡沫階段為 `LATE`，啟動移動停利機制
3. 對每個持倉股票執行 `checkTrailingStopForStock()`：
   - 獲取最近 3 日最高價（從 `MARKET_OHLCV_DAILY` 讀取）
   - 計算從最高點回落的百分比
   - 檢查是否跌破 MA10（連續 2 次確認）
   - 檢查量能確認（美股要求爆量）

### 3. 觸發條件
- **回落觸發**：從最高點回落 > 4%（或市場特定閾值）
- **MA10 觸發**：跌破 MA10（連續 2 次監測確認）
- **量能確認**：美股要求爆量（> 2 倍平均量），台股/日股不要求

### 4. 觸發後動作
1. 調用 `executeTrailingStopExit()` 執行緊急撤退
2. 調用 `P6_EmergencyExit_Intraday()` 生成撤退計劃
3. 減倉比例：50%（核心持倉最多減 30%）
4. 記錄到 `P6_EMERGENCY_EXIT_LOG`
5. 通知使用者（LINE Bot）

---

## 📋 配置參數

### 觸發條件
- **回落閾值**：
  - 台股/美股：-4%
  - 日股：-3.5%
- **MA10 確認**：連續 2 次監測確認
- **量能確認**：
  - 美股：要求爆量（> 2 倍平均量）
  - 台股/日股：不要求

### 緊急撤退配置
- **減倉比例**：50%
- **核心持倉**：最多減 30%（保留至少 70%）
- **觸發類型**：`TRAILING_STOP`

---

## 🔄 數據流

1. **P5 Weekly** → 判斷泡沫階段（LATE）→ 保存到 PropertiesService
2. **P6 盤中監測** → 讀取泡沫階段（PropertiesService）→ 啟動移動停利機制
3. **移動停利檢查** → 讀取最近 3 日最高價（`MARKET_OHLCV_DAILY`）→ 計算回落百分比
4. **觸發條件** → 回落 > 4% 或跌破 MA10 → 執行緊急撤退
5. **緊急撤退** → 生成撤退計劃 → 記錄到 `P6_EMERGENCY_EXIT_LOG` → 通知使用者

---

## ✅ 整合狀態

- ✅ **移動停利模組**：已完成 `28_P6_TRAILING_STOP.js`
- ✅ **P6 盤中監測整合**：已完成 `28_P6_INTRADAY_MONITOR.js` 整合
- ✅ **P5 Weekly 泡沫階段保存**：已完成 `24_P5_WEEKLY_CORE.js` 更新
- ✅ **P6 緊急撤退協議更新**：已完成 `28_P6_EMERGENCY_EXIT.js` 更新
- ✅ **SSOT 文檔更新**：已完成 `V8.0架構定案文檔_SSOT.md` 更新

---

## 🎯 完成狀態

**所有 V8.10 移動停利機制整合已完成** ✅

**系統現在能夠：**
1. 在 LATE 階段維持高水位（80-100%），吃到最後一段漲幅
2. 使用移動停利機制動態防守（從最高點回落 > 4% 或跌破 MA10 觸發撤退）
3. 比別人更快跳車，避開崩盤

---

**修正日期**：2026-01-18  
**版本**：V8.10  
**狀態**：✅ 完成
