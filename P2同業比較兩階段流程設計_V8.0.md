# P2 同業比較兩階段流程設計 V8.0

## 📋 設計日期

**設計日期**：2025-01-14  
**狀態**：✅ 已設計並更新 Prompt

---

## 🎯 核心設計原則

### 1. 同業定義

**同業不是「同板塊」（板塊太大，不適合）**

- ✅ **相同細分產業**：處於相同的細分產業（例如：半導體設備、雲端軟體、電動車電池等）
- ✅ **相似業務模式**：具有相似的業務模式和商業邏輯
- ✅ **相似市場定位**：面向相似的客戶群體和市場
- ⚠️ **不是「同板塊」**：板塊太大（例如：整個科技板塊），不適合作為比較基準

### 2. 同業分類要求 ⭐ **關鍵**

**絕對不能拿產業龍頭跟新創公司比！必須按照公司規模分類比較：**

1. **龍頭公司（Market Leader）**：
   - 產業中市值最大、市占率最高的公司
   - 通常是產業的標竿企業

2. **中大型公司（Mid-to-Large Cap）**：
   - 市值和規模中等偏大的公司
   - 通常是產業中的主要參與者

3. **小型新創公司（Small Cap / Startup）**：
   - 市值較小或新創公司
   - 通常是產業中的新進者或成長型公司

**分類比較要求**：
- ✅ **目標公司是龍頭** → 與其他龍頭公司比較
- ✅ **目標公司是中大型** → 與其他中大型公司比較
- ✅ **目標公司是小型新創** → 與其他小型新創公司比較
- ❌ **禁止跨分類比較**（例如：龍頭 vs 小型新創）

---

## 🔄 兩階段執行流程

### Stage 1：AI 識別同業公司清單

**執行者**：AI 模型（Claude Sonnet 4.5）

**任務**：
1. **識別目標公司的規模分類**：
   - 判斷目標公司是「龍頭」、「中大型」還是「小型新創」
   - 基於市值、市占率、產業地位等綜合判斷

2. **找出同業公司**（3-5 家，不需要太多）：
   - 找出與目標公司處於**相同細分產業**的公司（不是同板塊）
   - **必須與目標公司屬於相同規模分類**（龍頭 vs 龍頭、中大型 vs 中大型、小型新創 vs 小型新創）
   - 使用推理能力和邏輯判斷，交叉判定哪些公司是真正的同業

3. **輸出同業公司清單**：
   - 必須在輸出中明確列出同業公司清單
   - 必須標註每個同業公司的規模分類
   - 必須說明選擇這些同業公司的理由

**輸出格式**：
```json
{
  "peer_comparison_requests": {
    "AAPL": {
      "ticker": "AAPL",
      "peer_companies": ["MSFT", "GOOGL"],
      "target_company_scale": "龍頭",
      "data_source": "INSTITUTIONAL_DATA CSE (SEC EDGAR)"
    }
  },
  "financial_metrics": {
    "AAPL": {
      "ticker": "AAPL",
      "revenue_yoy": 0.15,
      "gross_margin": 0.38,
      "operating_margin": 0.25,
      "net_margin": 0.20,
      "roic": 0.25,
      "current_ratio": 1.5,
      "peer_identification": {
        "target_company_scale": "龍頭",
        "peer_companies": [
          {
            "ticker": "MSFT",
            "name": "Microsoft",
            "scale": "龍頭",
            "selection_reason": "選擇理由"
          },
          {
            "ticker": "GOOGL",
            "name": "Alphabet",
            "scale": "龍頭",
            "selection_reason": "選擇理由"
          }
        ],
        "industry_definition": "同業定義說明（為什麼這些公司是同業，不是同板塊）"
      }
    },
    "MSFT": {
      "ticker": "MSFT",
      "revenue_yoy": 0.12,
      "gross_margin": 0.35,
      "operating_margin": 0.22,
      "net_margin": 0.18,
      "roic": 0.23,
      "current_ratio": 1.8
    },
    "GOOGL": {
      "ticker": "GOOGL",
      "revenue_yoy": 0.10,
      "gross_margin": 0.40,
      "operating_margin": 0.20,
      "net_margin": 0.15,
      "roic": 0.20,
      "current_ratio": 1.6
    }
  }
}
```

**重要**：
- ✅ **必須同時提取目標公司和同業公司的財務指標**（在 `financial_metrics` 中）
- ✅ 這樣 Stage 2 的程式計算可以直接使用這些指標值

---

### Stage 2：程式收集數據並計算相對位置

**執行者**：程式（JavaScript）

**任務**：
1. **獲取同業財務指標**：
   - 優先從 Stage 1 的 AI 輸出中獲取（`executorOutput.financial_metrics` 中應包含同業的財務指標）
   - 如果 AI 沒有提取，則從相同白名單數據源收集同業財務數據
   - 使用與目標公司相同的數據收集函數（`collectTaiwanStockFinancialData`、`collectUSStockFinancialData`、`collectJapanStockFinancialData`）
   - ⚠️ **注意**：如果同業數據只包含 `search_results`，需要額外步驟提取指標（建議在 Stage 1 由 AI 完成）

2. **計算相對位置**：
   - 對於每個財務指標，計算目標公司在同業中的排名
   - 計算百分位數
   - 判斷是**前段（Top 25%）**、**中段（25%-75%）**、還是**後段（Bottom 25%）**

3. **判斷結構性優勢/弱勢**：
   - 基於相對位置結果，判斷是結構性優勢者還是結構性弱者

4. **判斷異質性風險**：
   - 計算目標公司與同業平均值的差異
   - 判斷是否存在異質性風險

**實現函數**：
- `collectPeerFinancialData()` - 收集同業財務數據
- `calculateRelativePositions()` - 計算相對位置
- `calculateOverallPosition()` - 計算整體相對位置
- `judgeStructuralAdvantage()` - 判斷結構性優勢/弱勢
- `judgeHeterogeneityRisk()` - 判斷異質性風險

**輸出格式**：
```json
{
  "peer_comparison": {
    "peer_companies": ["MSFT", "GOOGL", "META"],
    "target_company_scale": "龍頭",
    "relative_positions": {
      "revenue_yoy": {
        "value": 0.15,
        "rank": 1,
        "total_count": 4,
        "percentile": 100,
        "position": "前段"
      }
    },
    "overall_position": "前段",
    "structural_advantage": {
      "type": "結構性優勢者",
      "reason": "多數指標在前段",
      "confidence": 0.75
    },
    "heterogeneity_risk": {
      "has_heterogeneity": false,
      "description": "財務特徵符合該板塊的正常公司"
    }
  }
}
```

---

## ✅ 為什麼採用兩階段流程？

### 優點

1. **避免上下文斷層**：
   - ✅ Stage 1 由 AI 識別同業（需要推理能力）
   - ✅ Stage 2 由程式計算相對位置（避免兩次 AI 模型無法承接上下文）

2. **提高準確性**：
   - ✅ AI 專注於需要推理的任務（識別同業、分類規模）
   - ✅ 程式專注於需要精確計算的任務（排名、百分位數、相對位置）

3. **降低成本**：
   - ✅ 相對位置計算是純數學計算，不需要 AI
   - ✅ 減少 AI 調用次數和 Token 使用量

4. **確保一致性**：
   - ✅ 程式計算相對位置，確保計算邏輯一致
   - ✅ 避免 AI 在不同調用中產生不一致的結果

---

## 📋 實現狀態

### ✅ 已實現

1. **P2 Prompt 更新**：
   - ✅ 加入同業定義與分類要求
   - ✅ 明確說明兩階段流程
   - ✅ 要求 AI 只執行 Stage 1（識別同業清單）

2. **Stage 2 函數實現**：
   - ✅ `collectPeerFinancialData()` - 收集同業財務數據
   - ✅ `calculateRelativePositions()` - 計算相對位置
   - ✅ `calculateOverallPosition()` - 計算整體相對位置
   - ✅ `judgeStructuralAdvantage()` - 判斷結構性優勢/弱勢
   - ✅ `judgeHeterogeneityRisk()` - 判斷異質性風險

3. **P2_ProcessM0Result 更新**：
   - ✅ 加入 Stage 2 執行邏輯
   - ✅ 整合同業比較結果到財務指標

### ✅ 已實現

1. **兩階段流程**：
   - ✅ Stage 1：AI 識別同業公司清單（包含規模分類）
   - ✅ Stage 2：程式收集數據並計算相對位置

2. **同業分類要求**：
   - ✅ Prompt 已要求分開龍頭/中大型/小型新創來比較
   - ✅ Prompt 已禁止跨分類比較

3. **程式計算函數**：
   - ✅ `collectPeerFinancialData()` - 收集同業財務數據
   - ✅ `calculateRelativePositions()` - 計算相對位置
   - ✅ `calculateOverallPosition()` - 計算整體相對位置
   - ✅ `judgeStructuralAdvantage()` - 判斷結構性優勢/弱勢
   - ✅ `judgeHeterogeneityRisk()` - 判斷異質性風險

### ⚠️ 待完善

1. **同業財務指標提取**：
   - ✅ **已更新 Prompt**：要求 AI 在 Stage 1 同時提取目標公司和同業公司的財務指標
   - ✅ **已更新函數**：`calculateRelativePositions` 和 `judgeHeterogeneityRisk` 優先從 `peerFinancialMetrics` 獲取指標值
   - ⚠️ **需要測試**：確認 AI 在 Stage 1 能正確提取同業的財務指標
   - ⚠️ **備用方案**：如果 AI 沒有提取，需要額外處理從 `search_results` 中解析指標

2. **數據提取邏輯**：
   - ✅ `calculateRelativePositions` 已實現優先從 `peerFinancialMetrics` 獲取指標值
   - ✅ `judgeHeterogeneityRisk` 已實現優先從 `peerFinancialMetrics` 獲取指標值
   - ⚠️ 需要測試實際運行時是否能正確獲取指標值

---

## 🎯 總結

### ✅ 設計完成

1. **兩階段流程**：AI 識別同業 → 程式計算相對位置 ✅
2. **同業分類要求**：必須分開龍頭/中大型/小型新創來比較 ✅
3. **同業定義**：不是「同板塊」，而是「相同細分產業」✅
4. **程式計算相對位置**：避免兩次 AI 模型無法承接上下文 ✅

### ⚠️ 待完善

1. **異質性風險判斷**：需要完善所有指標的檢查邏輯 ⚠️
2. **數據提取**：需要確保能正確從搜尋結果中提取財務指標 ⚠️

---

**文檔版本**：V1.1  
**最後更新**：2025-01-14  
**狀態**：✅ 設計完成，已實現核心功能，待測試確認
