# P6 盤中監測系統可行性分析與應用場景

> **版本**：V8.0  
> **日期**：2025-01-17  
> **定位**：盤中風險雷達（Risk Radar），非交易系統

---

## ✅ 一、可行性確認

### 1.1 使用量計算（150 檔 × 每 30 分鐘）

#### Google Sheets 公式負載
- **公式數量**：150 檔 × 5 個欄位 = **750 個 GOOGLEFINANCE 公式**
- **Google 限制**：單一 Sheet 可容納 **500 萬個儲存格**
- **結論**：✅ **完全安全，僅使用 0.015% 容量**

#### GAS 執行配額
- **執行頻率**：每 30 分鐘一次 = 每天 **48 次**
- **每次執行時間**：讀取 150 行數據約 **3-5 秒**
- **每日總執行時間**：48 × 5 秒 = **240 秒（4 分鐘）**
- **Google 一般帳號限制**：每天 **90 分鐘**
- **Google Workspace 限制**：每天 **6 小時**
- **結論**：✅ **僅使用 4.4%（一般）或 1.1%（商用），完全安全**

#### 數據更新機制
- **GOOGLEFINANCE 公式**：自動更新（Google 後端處理）
- **GAS 腳本**：只負責**讀取結果**和**判斷邏輯**
- **結論**：✅ **不會觸發 API 限制，因為不是 API 調用**

---

### 1.2 數據延遲影響評估

#### GOOGLEFINANCE 延遲特性
- **延遲時間**：15-20 分鐘
- **對中長期投資的影響**：✅ **可接受**
  - 監控的是「趨勢反轉」而非「秒級交易」
  - 黑天鵝事件通常持續數小時至數天
  - 20 分鐘延遲的警報仍能在災難擴大前通知

#### 實際應用場景
- **暴跌警報**：即使延遲 20 分鐘，仍能在當天通知，避免隔天才發現
- **目標價到價**：中長期投資的買賣點通常有緩衝區，20 分鐘延遲不影響
- **異常爆量**：爆量通常持續一段時間，延遲不影響偵測

---

## 🎯 二、系統定位與功能範圍

### 2.1 核心定位：**P6 盤中風險雷達（Intraday Risk Radar）**

**不做**：
- ❌ 盤中交易決策
- ❌ 短線技術分析
- ❌ 頻繁訊號生成
- ❌ AI 介入判斷

**只做**：
- ✅ **異常偵測**：價/量/波動度異常
- ✅ **風險警報**：觸發條件時通知
- ✅ **目標價監控**：到價通知（解決台股掛單問題）
- ✅ **緊急撤退觸發**：盤中級別的黑天鵝偵測

---

### 2.2 監控項目（Rule-Based，0 Token 成本）

#### A. 單日跌幅/漲幅超閾值
- **邏輯**：`changepct <= -6%` 或 `>= +8%`
- **用途**：偵測單日劇烈波動
- **觸發動作**：LINE 通知 + 記錄到 `P6_INTRADAY_ALERTS` 表格

#### B. 30 分鐘內急殺/急拉
- **邏輯**：`(當前價 - 30分前價) / 30分前價 <= -2%` 或 `>= +3%`
- **用途**：偵測盤中劇烈波動（需要「殘影機制」）
- **觸發動作**：LINE 通知（Critical 級別）

#### C. 成交量異常（相對平均量）
- **邏輯**：`volume / volumeavg >= 2.5`（爆量 2.5 倍以上）
- **用途**：偵測機構大舉進出或內線消息
- **觸發動作**：LINE 通知（Warning 級別）

#### D. 盤中高低幅度過大
- **邏輯**：`(high - low) / price >= 7%`（盤中振幅 > 7%）
- **用途**：偵測劇烈波動（即使收盤價變化不大）
- **觸發動作**：LINE 通知（Warning 級別）

#### E. 目標價到價
- **邏輯**：
  - `price <= buy_target_price`（跌到買點）
  - `price >= sell_target_price`（漲到賣點）
- **用途**：解決台股無法掛單的問題
- **觸發動作**：LINE 通知（Info 級別）+ 記錄到 `P6_TARGET_ALERTS` 表格

---

## 🔗 三、系統整合點

### 3.1 與 P4.6 緊急撤退協議整合

#### 現狀（日級別）
- P4.6 目前只在**日結後**觸發
- 觸發條件：單日跌幅 > 7%、DEFCON_1、VIX > 50 等

#### 整合後（盤中級別）
- **P6 盤中監測** → 偵測到異常 → **觸發 P4.6 盤中版本**
- **觸發條件擴展**：
  - 盤中單檔跌幅 > 6%（30 分鐘內急殺 > 2%）
  - 持倉組合整體跌幅 > 5%
  - 多檔同時爆量（可能有大事件）

#### 整合流程
```
P6 監測 → 偵測異常 → 判斷是否觸發 P4.6 → 
→ 是：發送 LINE 通知（Critical）+ 記錄到 P4.6 觸發日誌
→ 否：僅發送 LINE 通知（Warning）
```

---

### 3.2 與 DEFCON 系統整合

#### 現狀
- DEFCON 在 P5 Weekly 計算
- 基於週級別數據

#### 整合後
- **P6 盤中波動度** → 作為 DEFCON 的**即時信號**
- **新增 DEFCON 盤中調整機制**：
  - 如果盤中偵測到多檔急殺 → 臨時提高 DEFCON 等級
  - 如果盤中偵測到異常爆量 → 提高流動性壓力評分

#### 整合方式
- P6 監測結果 → 記錄到 `P6_DEFCON_SIGNALS` 表格
- P5 Weekly 計算 DEFCON 時 → 讀取 P6 信號 → 調整評分

---

### 3.3 與 P3 技術分析整合（目標價監控）

#### 現狀
- P3 技術分析會計算買賣點（Buy1/Buy2/Buy3, Sell1/Sell2/Sell3）
- 但沒有盤中監控機制

#### 整合後
- **P6 讀取 P3 最新快照** → 提取目標價位
- **盤中監控** → 價格到達目標價 → LINE 通知

#### 解決的問題
- ✅ **台股無法掛單**：到價通知，手動下單
- ✅ **美股/日股**：也可以設定到價通知，不用盯盤

---

### 3.4 與 P4 資金配置整合（持倉監控）

#### 現狀
- P4 計算理想配置（W_ideal）和實際配置（W_now）
- 持倉列表存在 P4 快照中

#### 整合後
- **P6 讀取 P4 最新快照** → 提取持倉列表
- **盤中監控持倉股票** → 優先監控持倉，其次監控追蹤池

#### 監控優先級
1. **持倉股票**（P4 快照）：最高優先級
2. **追蹤池股票**（Phase1_Tracking_Pool）：中等優先級
3. **觀察名單**（自定義）：低優先級

---

## 📊 四、數據結構設計

### 4.1 MONITOR_LIST 表格（監控清單）

| 欄位 | 說明 | 數據來源 |
|------|------|---------|
| **ticker** | 股票代碼（GOOGLEFINANCE 格式） | 手動輸入或從 P4/P1 讀取 |
| **name** | 股票名稱 | 手動輸入 |
| **market** | 市場（US/TW/JP） | 自動判斷 |
| **priority** | 優先級（HOLDING/TRACKING/WATCH） | 自動判斷 |
| **current_price** | `=GOOGLEFINANCE(ticker, "price")` | GOOGLEFINANCE 自動更新 |
| **changepct** | `=GOOGLEFINANCE(ticker, "changepct")` | GOOGLEFINANCE 自動更新 |
| **volume** | `=GOOGLEFINANCE(ticker, "volume")` | GOOGLEFINANCE 自動更新 |
| **volumeavg** | `=GOOGLEFINANCE(ticker, "volumeavg")` | GOOGLEFINANCE 自動更新 |
| **high** | `=GOOGLEFINANCE(ticker, "high")` | GOOGLEFINANCE 自動更新 |
| **low** | `=GOOGLEFINANCE(ticker, "low")` | GOOGLEFINANCE 自動更新 |
| **last_check_price** | 30 分鐘前價格（由 GAS 寫入） | GAS 腳本更新 |
| **buy_target** | 買入目標價（從 P3 讀取） | P3 快照 |
| **sell_target** | 賣出目標價（從 P3 讀取） | P3 快照 |
| **last_alert_time** | 上次警報時間（防重複通知） | GAS 腳本更新 |
| **alert_cooldown** | 冷卻時間（分鐘） | 配置（預設 60 分鐘） |

---

### 4.2 P6_INTRADAY_ALERTS 表格（警報記錄）

| 欄位 | 說明 |
|------|------|
| **alert_id** | 警報 ID |
| **timestamp** | 警報時間 |
| **ticker** | 股票代碼 |
| **alert_type** | 警報類型（DROP/SPIKE/VOLUME/RANGE/TARGET） |
| **alert_level** | 警報級別（CRITICAL/WARNING/INFO） |
| **trigger_value** | 觸發數值 |
| **current_price** | 當前價格 |
| **change_pct** | 變化百分比 |
| **message** | 警報訊息 |
| **line_sent** | 是否已發送 LINE 通知 |
| **p4_6_triggered** | 是否觸發 P4.6 |

---

### 4.3 P6_TARGET_ALERTS 表格（目標價警報）

| 欄位 | 說明 |
|------|------|
| **alert_id** | 警報 ID |
| **timestamp** | 警報時間 |
| **ticker** | 股票代碼 |
| **target_type** | 目標類型（BUY/SELL） |
| **target_price** | 目標價格 |
| **current_price** | 當前價格 |
| **p3_snapshot_id** | P3 快照 ID（追溯性） |
| **line_sent** | 是否已發送 LINE 通知 |

---

## 🚀 五、應用場景與價值

### 5.1 解決的痛點

#### ✅ 痛點 1：台股無法掛單
- **問題**：台股無法設定自動掛單，需要手動盯盤
- **解決**：P6 監控目標價 → 到價 LINE 通知 → 手動下單
- **價值**：不再需要整天盯盤，到價自動通知

#### ✅ 痛點 2：黑天鵝事件發現太晚
- **問題**：P4.6 只在日結後觸發，可能已經損失慘重
- **解決**：P6 盤中監測 → 盤中觸發 P4.6 → 當天就能減倉
- **價值**：從「隔天發現」變成「當天通知」，大幅降低損失

#### ✅ 痛點 3：異常爆量無法及時發現
- **問題**：異常爆量通常代表重大事件，但日結才發現
- **解決**：P6 監控成交量 → 爆量立即通知
- **價值**：可以及時了解市場動態，做出反應

#### ✅ 痛點 4：目標價位需要手動監控
- **問題**：P3 計算的買賣點需要手動監控
- **解決**：P6 自動監控目標價 → 到價通知
- **價值**：完全自動化，不需要盯盤

---

### 5.2 新增的戰略價值

#### 🎯 價值 1：完整的時間維度覆蓋
- **週級別**：P5 Weekly（AI 深度思考）
- **日級別**：P5 Daily（數據快照）
- **盤中級別**：P6 盤中監測（風險雷達）← **新增**

#### 🎯 價值 2：被動投資 + 主動防禦
- **平常**：完全不用看盤，系統自動監控
- **異常時**：LINE 通知，才需要介入
- **符合中長期投資風格**：不被盤中波動干擾，但重大事件不會錯過

#### 🎯 價值 3：零成本運行
- **數據源**：GOOGLEFINANCE（免費）
- **邏輯**：Rule-Based（0 Token）
- **通知**：LINE Notify（免費）
- **總成本**：$0

---

## ⚙️ 六、技術實現要點

### 6.1 去噪音機制（避免通知轟炸）

#### Cooldown 機制
- **同一檔股票**：60 分鐘內只通知一次（可配置）
- **同一類型警報**：30 分鐘內只通知一次
- **實現**：檢查 `last_alert_time` 欄位

#### 分級通知
- **CRITICAL**：立即通知（暴跌、急殺、觸發 P4.6）
- **WARNING**：延遲通知（爆量、振幅過大）
- **INFO**：批次通知（目標價到價，可以累積多檔後一起通知）

#### 批次通知
- **目標價到價**：可以累積 5-10 檔後，一次發送
- **減少通知頻率**：避免被訊息轟炸

---

### 6.2 殘影機制（30 分鐘變化計算）

#### 實現方式
1. **GAS 腳本執行時**：
   - 讀取 `current_price`（D 欄，GOOGLEFINANCE 自動更新）
   - 讀取 `last_check_price`（H 欄，上次寫入的價格）
   - 計算變化：`(current_price - last_check_price) / last_check_price`
   - 判斷是否觸發警報
   - **寫入當前價格到 `last_check_price`**（更新殘影）

2. **下次執行時**：
   - `last_check_price` 就是 30 分鐘前的價格
   - 可以計算 30 分鐘內的變化

---

### 6.3 市場開盤時間處理

#### 美股
- **開盤時間**：台灣時間 22:30 - 次日 05:00（冬令）/ 21:30 - 次日 04:00（夏令）
- **監控時段**：開盤期間每 30 分鐘執行一次
- **實現**：Time-driven trigger，設定在開盤時段

#### 台股
- **開盤時間**：台灣時間 09:00 - 13:30
- **監控時段**：開盤期間每 30 分鐘執行一次

#### 日股
- **開盤時間**：台灣時間 08:00 - 14:00
- **監控時段**：開盤期間每 30 分鐘執行一次

#### 多市場處理
- **方案 1**：分別設定不同市場的 trigger
- **方案 2**：統一 trigger，腳本內判斷市場是否開盤

---

## 📋 七、實施建議

### 7.1 分階段實施

#### 第一階段：基礎監控（MVP）
- ✅ 監控持倉股票（從 P4 快照讀取）
- ✅ 單日跌幅/漲幅警報
- ✅ 目標價到價通知
- ✅ LINE 通知功能

#### 第二階段：進階監控
- ✅ 30 分鐘內急殺/急拉監控
- ✅ 異常爆量監控
- ✅ 盤中振幅監控
- ✅ 與 P4.6 整合

#### 第三階段：完整整合
- ✅ 與 DEFCON 系統整合
- ✅ 多市場支援（美股/台股/日股）
- ✅ 批次通知優化
- ✅ 監控結果分析與報表

---

### 7.2 優先級建議

#### 最高優先級
1. **目標價監控**：解決台股掛單問題（立即價值）
2. **持倉暴跌警報**：與 P4.6 整合（風險控制）

#### 中等優先級
3. **異常爆量監控**：了解市場動態
4. **30 分鐘變化監控**：早期警報

#### 低優先級
5. **盤中振幅監控**：輔助判斷
6. **與 DEFCON 整合**：增強風險評估

---

## 🎯 八、結論

### 8.1 可行性結論

✅ **完全可行**：
- 使用量遠低於 Google 限制
- 技術實現簡單（Rule-Based）
- 成本為 $0
- 符合中長期投資風格

### 8.2 戰略價值

1. **時間維度完整**：週/日/盤中三層監控
2. **解決實際痛點**：台股掛單、黑天鵝發現太晚
3. **零成本運行**：完全免費
4. **被動投資 + 主動防禦**：符合系統定位

### 8.3 建議

**強烈建議實施 P6 盤中監測系統**，這將是 V8.0 系統的**最後一塊完美拼圖**，讓系統從「事後分析」升級為「即時防禦」。

---

**生成時間**：2025-01-17  
**狀態**：待實施  
**建議優先級**：高（解決實際痛點，零成本，高價值）
