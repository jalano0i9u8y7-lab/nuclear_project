# V8.9 機構評級新聞整合與數據品質測試方案

## 📋 問題分析

### 1. 功能重複性問題

**現狀**：
- ✅ **P5 Daily**：已具備 `collectNewsAtoms()` 函數，使用 `P5_NEWS` CSE 收集新聞，存儲在 `NEWS_ATOMS_DAILY` 表格
- ⚠️ **P5 Weekly**：目前自己搜尋機構評級新聞（使用 `P5_INSTITUTIONAL_RATINGS` CSE 或直接抓取 Yahoo/Finviz）
- ❌ **重複工作**：兩者都在做新聞收集，違反分工機制

**分工機制原則**：
- **P5 Daily** = **數據收集層**（負責所有數據收集工作）
- **P5 Weekly** = **數據分析層**（負責分析已收集的數據）

### 2. 數據品質測試缺失

**現狀**：
- ✅ 數據有收集到（已確認）
- ❌ **時效性測試**：未確認是否符合「當天最新」（考慮各地區時差）
- ❌ **範圍精準性測試**：未確認是否正確是財經資料
- ❌ **雜訊過濾測試**：未確認是否混入廣告或社論等雜訊
- ❌ **可驗證性測試**：未確認新聞內容是否可以驗證

---

## 🎯 改進方案

### 方案 1：機構評級新聞整合到 P5 Daily（獨立資料庫）

#### 1.1 定位與用途說明 ⭐ **關鍵設計決策**

**機構評級資料的定位**：
- ⚠️ **「帶風向面」的資料，不是一味聽信的資料**
- ✅ **主要用途：事後驗證指標**，用來跟後續股價變化比對，驗證機構放話背後的真正意圖
- ✅ **獨立於原來的十大分類之外**（不應該放在 `NEWS_ATOMS_DAILY` 的 `category` 欄位）
- ✅ **不同時間維度的比對**：
  - 短期：幾天到一週內
  - 中期：一週到三週
  - 長期：三週以上
- ✅ **預先判斷僅可用多數機構的預測共識**（表示當時的市場氣氛）

**設計原則**：
- **資料收集**：P5 Daily 負責收集機構評級新聞
- **資料分析**：P5 Weekly 負責分析並與股價反應比對
- **資料驗證**：用於驗證機構放話的真實意圖（誘多/誘空）

#### 1.2 創建獨立的機構評級資料庫

**實施步驟**：
1. **創建新表格 `INSTITUTIONAL_RATINGS_DAILY`**：
   - **獨立於 `NEWS_ATOMS_DAILY`**（不共用表格）
   - **結構化欄位**（用於後續股價反應驗證）：
     ```
     date                    - 評級發布日期
     ticker                  - 股票代碼
     market                  - 市場（US/TW/JP）
     rating_firm             - 機構名稱（如 Goldman Sachs, 摩根士丹利）
     rating_action           - 評級動作（Upgrade/Downgrade/Maintain/Initiate）
     from_grade              - 原評級（如 Buy, Hold）
     to_grade                - 新評級（如 Strong Buy, Buy）
     from_price              - 原目標價
     to_price                - 新目標價
     target_change           - 目標價變化（格式化的文字，如 "$150 -> $180"）
     news_title              - 新聞標題
     news_summary            - 新聞摘要
     news_url                - 新聞連結
     news_source             - 新聞來源（The Fly, 鉅亨網, Minkabu）
     rating_date             - 評級發布日期（從新聞中提取）
     rating_time             - 評級發布時間（如果可提取）
     implied_fpe             - 隱含 FPE（計算：to_price / consensus_forward_eps）
     created_at              - 資料創建時間
     ```

2. **創建 `collectInstitutionalRatings()` 函數（P5 Daily 新增）**：
   - 使用 `P5_INSTITUTIONAL_RATINGS` CSE（鎖定 Tier 2 網站：The Fly、鉅亨網、Minkabu）
   - 針對不同市場（US/TW/JP）使用不同的搜尋查詢格式（多語支持）
   - 解析新聞標題提取結構化資料（重用現有的 `parseNewsTitleForRating()` 邏輯）
   - 保存到 `INSTITUTIONAL_RATINGS_DAILY` 表格

3. **整合到 `P5_Daily_Execute()` 流程**：
   - 在收集完一般新聞後，額外執行 `collectInstitutionalRatings()`
   - 確保每日收集機構評級資料

#### 1.3 P5 Weekly 讀取獨立資料庫並進行股價反應驗證

**實施步驟**：
1. **創建 `getInstitutionalRatingsFromDatabase()` 函數**：
   - 讀取 `INSTITUTIONAL_RATINGS_DAILY` 表格
   - 根據 `ticker` 和 `date` 篩選記錄
   - 支援時間範圍查詢（例如：最近 6 個月）
   - 返回結構化的評級資料陣列

2. **擴展 `getPriceReaction()` 函數**：
   - 支援多時間維度的股價反應驗證：
     - **短期**（幾天到一週內）：驗證評級發布後 1-7 天的股價變化
     - **中期**（一週到三週）：驗證評級發布後 7-21 天的股價變化
     - **長期**（三週以上）：驗證評級發布後 21+ 天的股價變化
   - 從 `MARKET_OHLCV_DAILY` 讀取對應時間範圍的價格數據
   - 計算累積漲跌幅、成交量變化等指標

3. **升級 `analyzeSmartSentiment()` 函數**：
   - 整合多時間維度的股價反應驗證結果
   - 根據不同時間維度的股價反應，判斷機構放話的真實意圖
   - 生成更精確的 `warnings`（例如：「短期誘多但中期跟進」）

4. **修改 `getHistoricalRatings()` 函數**：
   - 優先從 `INSTITUTIONAL_RATINGS_DAILY` 讀取（如果數據存在）
   - 如果數據不存在或不足，再使用 CSE 備援（保持向後兼容）

5. **修改 `collectMarketSentimentIndicators()` 函數**：
   - 調用 `getInstitutionalRatingsFromDatabase()` 而不是直接搜尋
   - 計算「多數機構的預測共識」（用於預先判斷市場氣氛）

#### 1.4 優點

- ✅ **符合分工機制**：Daily 收集，Weekly 分析
- ✅ **避免重複工作**：減少 CSE 搜尋次數，節省配額
- ✅ **獨立資料庫**：機構評級資料獨立存儲，不與一般新聞混淆
- ✅ **結構化資料**：便於後續股價反應驗證和多時間維度分析
- ✅ **定位明確**：明確區分「事後驗證指標」與「預先判斷資料」
- ✅ **向後兼容**：保留 CSE 備援機制，確保系統穩定性

---

### 方案 2：新聞管線數據品質測試

#### 2.1 時效性測試

**測試目標**：確認新聞是否為「當天最新」，考慮各地區時差

**測試方法**：
1. **時間戳驗證**：
   - 從新聞標題/摘要中提取發布時間
   - 對比新聞發布時間與當前時間（考慮時差）
   - **美股**：EST/EDT（UTC-5/-4）
   - **台股**：CST（UTC+8）
   - **日股**：JST（UTC+9）

2. **測試函數**：
   ```javascript
   function testNewsTimeliness(newsArray, market) {
     const timezoneMap = {
       "US": "America/New_York",
       "TW": "Asia/Taipei",
       "JP": "Asia/Tokyo"
     };
     
     // 檢查每條新聞的時間戳
     // 確認是否在「當天」範圍內
     // 考慮時差後的「當天」定義
   }
   ```

3. **測試指標**：
   - 當天新聞比例（應 > 80%）
   - 過期新聞比例（> 3 天的新聞應 < 5%）
   - 時間戳提取成功率（應 > 90%）

#### 2.2 範圍精準性測試

**測試目標**：確認新聞是否正確是財經資料，沒有混入其他類型內容

**測試方法**：
1. **分類驗證**：
   - 使用 AI 模型（GEMINI_FLASH）自動分類新聞
   - 確認 `category` 分類是否正確
   - 檢查是否有明顯的非財經內容

2. **關鍵字過濾（多語支持）**：
   - **財經關鍵字白名單（多語）**：
     - 英文：`stock`, `market`, `trading`, `earnings`, `rating`, `target price`, `upgrade`, `downgrade`
     - 中文：`股票`, `市場`, `交易`, `財報`, `評級`, `目標價`, `調升`, `調降`
     - 日文：`株式`, `市場`, `取引`, `決算`, `レーティング`, `目標株価`, `引上げ`, `引下げ`
   - **非財經關鍵字黑名單（多語）**：
     - 英文：`celebrity`, `sports`, `movie`, `entertainment`（非財經相關）
     - 中文：`娛樂`, `體育`, `電影`, `明星`（非財經相關）
     - 日文：`芸能`, `スポーツ`, `映画`, `エンタメ`（非財經相關）
   - 計算新聞標題/摘要中關鍵字匹配度（多語）

3. **測試函數**：
   ```javascript
   function testNewsRelevance(newsArray) {
     const financeKeywords = {
       "en": ["stock", "market", "trading", "earnings", ...],
       "zh": ["股票", "市場", "交易", "財報", ...],
       "ja": ["株式", "市場", "取引", "決算", ...]
     };
     const nonFinanceKeywords = {
       "en": ["celebrity", "sports", "movie", ...],
       "zh": ["娛樂", "體育", "電影", ...],
       "ja": ["芸能", "スポーツ", "映画", ...]
     };
     
     // 根據新聞語言選擇對應的關鍵字列表
     // 計算每條新聞的財經相關度
     // 標記可疑的非財經內容
   }
   ```

4. **測試指標**：
   - 財經相關新聞比例（應 > 95%）
   - 誤分類新聞比例（應 < 3%）

#### 2.3 雜訊過濾測試（針對白名單網站客製化優化）

**測試目標**：確認新聞沒有混入廣告或社論等雜訊

**測試方法**：
1. **URL 驗證（白名單網站特定）**：
   - **The Fly (thefly.com)**：
     - 有效模式：`/story/[ticker]-target-...`、`/news/[ticker]-upgrade...`
     - 無效模式：首頁、分類頁、廣告頁
   - **鉅亨網 (anue.com.tw)**：
     - 有效模式：`/news/id/[數字]`、`/amp/news/[標題]`
     - 無效模式：`/tag/`、`/category/`、廣告頁
   - **Minkabu (minkabu.jp)**：
     - 有效模式：`/stock/[代碼]/news`、`/stock/[代碼]/rating`
     - 無效模式：首頁、搜尋結果頁、廣告頁
   - 過濾可疑的 URL 模式（例如：包含 `ad`、`sponsored`、`advertisement`、`tag`、`category`）

2. **內容特徵檢測（多語支持）**：
   - **廣告特徵檢測（多語）**：
     - 英文：`sponsored`, `advertisement`, `promoted`, `click here`, `sign up now`
     - 中文：`贊助`, `廣告`, `立即註冊`, `立即下載`
     - 日文：`広告`, `スポンサー`, `今すぐ登録`
   - **社論特徵檢測（多語）**：
     - 英文：明顯的觀點性文字、缺少事實陳述
     - 中文：明顯的觀點性文字、缺少事實陳述
     - 日文：明顯的觀點性文字、缺少事實陳述
   - 使用 AI 模型（GEMINI_FLASH）檢測內容類型（多語支持）

3. **來源白名單驗證**：
   - 確認新聞來源是否在 Tier 2 白名單內（The Fly、鉅亨網、Minkabu 等）
   - 標記未知來源的新聞
   - **注意**：由於已經有 CSE 白名單限制，雜訊會相對好做

4. **白名單網站特定雜訊過濾規則**：
   - **The Fly**：過濾「Market Movers」等非評級新聞
   - **鉅亨網**：過濾「投資教室」、「理財專欄」等非即時新聞
   - **Minkabu**：過濾「コラム」（專欄）類別的非評級新聞

5. **測試函數**：
   ```javascript
   function testNewsQuality(newsArray) {
     // URL 驗證（針對每個白名單網站客製化）
     // 內容特徵檢測（多語支持）
     // 來源白名單驗證
     // 白名單網站特定雜訊過濾
     // 返回雜訊比例
   }
   ```

6. **測試指標**：
   - 雜訊比例（應 < 5%，由於有白名單限制，預期會更低）
   - 白名單來源比例（應 = 100%，因為 CSE 已限制）
   - URL 有效性（應 > 95%）

#### 2.4 可驗證性測試

**測試目標**：確認新聞內容可以被驗證

**測試方法**：
1. **URL 可訪問性**：
   - 測試每條新聞的 URL 是否可以訪問
   - 確認 URL 沒有失效（404、403 等）

2. **內容一致性**：
   - 對比新聞標題/摘要與實際網頁內容
   - 確認 CSE 返回的摘要是否準確反映原文

3. **來源可信度**：
   - 確認新聞來源是否為可信的財經媒體
   - 檢查是否有來源標記（author、publish date 等）

4. **測試函數**：
   ```javascript
   function testNewsVerifiability(newsArray) {
     // URL 可訪問性測試
     // 內容一致性測試（抽樣）
     // 來源可信度檢查
   }
   ```

5. **測試指標**：
   - URL 可訪問率（應 > 95%）
   - 內容一致性（抽樣測試，應 > 90%）

---

## 📊 測試實施計劃

### Phase 1：數據品質測試（優先級高）

**目標**：先確認現有新聞管線的數據品質

1. **創建測試函數**：
   - `testNewsTimeliness()` - 時效性測試
   - `testNewsRelevance()` - 範圍精準性測試
   - `testNewsQuality()` - 雜訊過濾測試
   - `testNewsVerifiability()` - 可驗證性測試

2. **執行測試**：
   - 針對最近 7 天的 `NEWS_ATOMS_DAILY` 數據執行測試
   - 生成測試報告（包含各項指標和問題清單）

3. **根據測試結果調整**：
   - 如果發現問題，先修復新聞收集邏輯
   - 確保數據品質達標後，再進行整合

### Phase 2：機構評級新聞整合（優先級中）

**目標**：將機構評級新聞收集整合到 P5 Daily

1. **實施方案 1.1**：擴展 P5 Daily 的新聞收集
2. **實施方案 1.2**：修改 P5 Weekly 讀取邏輯
3. **測試整合後的功能**：
   - 確認 P5 Daily 能正確收集機構評級新聞
   - 確認 P5 Weekly 能正確讀取並解析機構評級新聞

### Phase 3：持續監控（優先級低）

**目標**：建立持續的數據品質監控機制

1. **定期執行測試**：
   - 每週自動執行數據品質測試
   - 記錄測試結果到日誌

2. **告警機制**：
   - 如果數據品質指標低於閾值，發送告警
   - 自動標記可疑新聞

---

## ✅ 已確認事項

1. **獨立資料庫**：
   - ✅ 創建獨立的 `INSTITUTIONAL_RATINGS_DAILY` 表格
   - ✅ 不放在 `NEWS_ATOMS_DAILY` 的 `category` 欄位中
   - ✅ 結構化欄位（rating_firm, rating_action, target_price 等）

2. **定位與用途**：
   - ✅ 「帶風向面」的資料，用於事後驗證指標
   - ✅ 與後續股價變化比對（多時間維度：短期幾天到一週、中期一週到三週、長期三週以上）
   - ✅ 驗證機構放話背後的真正意圖
   - ✅ 預先判斷僅可用多數機構的預測共識（表示市場氣氛）

3. **雜訊過濾**：
   - ✅ 針對白名單網站客製化優化（The Fly、鉅亨網、Minkabu）
   - ✅ 多語支持（英文、中文、日文）

## ❓ 待確認問題

1. **時間維度定義**：
   - 短期的「幾天到一週內」具體是幾天？（例如：1-7 天？）
   - 中期的「一週到三週」是否為 7-21 天？
   - 長期的「三週以上」是否為 21+ 天？

2. **測試閾值**：
   - 時效性測試的「當天」定義（考慮時差後，允許幾小時的誤差？例如：±6 小時？）
   - 各項測試指標的合格閾值（例如：當天新聞比例 > 80%？）

3. **實施順序**：
   - 是否先完成數據品質測試，再進行整合？
   - 還是同時進行？

---

## 📝 後續行動

**已確認事項**：
1. ✅ 方案 1（機構評級新聞整合到獨立資料庫）- **已確認**
2. ✅ 方案 2（數據品質測試，針對白名單網站客製化，多語支持）- **已確認**
3. ✅ 獨立資料庫設計和定位 - **已確認**

**等待用戶確認以下事項後再開始實施**：
1. ❓ 時間維度定義的具體天數
2. ❓ 測試閾值（時效性「當天」定義、各項指標合格標準）
3. ❓ 實施順序（先測試後整合，還是同時進行）

**定案後的行動**：
1. 實作數據品質測試函數
2. 執行現有數據的品質測試
3. 根據測試結果調整
4. 實施機構評級新聞整合
5. 測試整合後的功能

---

**文檔日期**：2026-01-18  
**版本**：V8.9（草案）  
**狀態**：⏸️ 等待用戶確認
