# 系統核心設計原則 V8.0

## 📋 文檔說明

本文檔定義系統的最高等級設計原則，這些原則決定系統的靈魂和定位。

**版本**：V8.0  
**創建日期**：2025-01-14  
**重要性**：⭐⭐⭐⭐⭐ **最高等級原則**

---

## 🎯 最高等級原則 1：機構級預測視角（P3 核心靈魂）

### 原則定義

**P3 技術分析模組的本質不是「技術分析」，而是「機構級預測」**

### 核心理念

1. **視角定位**：
   - ✅ **以機構主力、大型對沖基金、高盛、摩根等大機構的視角來分析**
   - ✅ **不是散戶視角，不是一般分析系統的視角**
   - ✅ **要「成為主力的大腦」，解釋為什麼主力會做這些操作**

2. **目標定位**：
   - ✅ **目標是「預測未來」，而不是套用公式**
   - ✅ **不是一般程式用公式就能得到的「技術分析」（RSI、MACD、均線等）**
   - ✅ **要預測主力的真正意圖以及未來會做的操作**
   - ✅ **預測未來的市場變化**

3. **分析邏輯**：
   - ✅ **「量大於價」**：量才是資金足跡，短期的價有時只是表象
   - ✅ **解釋主力行為**：為什麼主力跟大型機構會做出這些事情？
   - ✅ **判斷真正意圖**：藉此判斷他們的真正意圖
   - ✅ **預測未來操作**：預測未來會做的操作與市場變化

4. **執行策略**：
   - ✅ **跟著主力來順風獲利**，而非只是單純程式就能做的技術分析
   - ✅ **這就是為什麼系統要用 AI 模型的原因**

### 與 P2.5 的關聯

- ✅ P2.5 已經蒐集到機構等級的數據（13F、內部人交易、Dark Pool、Options Flow）
- ✅ P3 必須使用這些機構級數據，以機構的視角來分析和預測
- ✅ 不是「分析主力畫出來的線」，而是「把自己當成是主力去解釋和預測」

### AI 模型的必要性

- ✅ **不能用程式公式替代**：因為需要複雜的推理、因果邏輯連結、意圖判斷
- ✅ **需要深度理解**：理解市場行為背後的動機和邏輯
- ✅ **需要預測能力**：預測未來的操作和市場變化
- ✅ **這就是為什麼 P3 必須使用 AI 模型（而非程式公式）**

### 實作要求

1. **Prompt 設計**：
   - ✅ 必須以機構主力的視角來設計
   - ✅ 強調「預測未來」，而非「技術分析」
   - ✅ 強調「解釋行為意圖」，而非「套用技術指標」
   - ✅ **明確禁止輸出「根據 RSI、MACD、均線、支撐壓力、黃金分割」等程式就能算的結論**
   - ✅ **明確說明技術指標已由程式計算好，直接使用，不要重新計算**

2. **數據使用**：
   - ✅ 必須整合 P2.5 的機構級數據（Smart_Money_Score、Institutional_Holdings_Score、Dark_Pool_Activity、Options_Flow_Sentiment）
   - ✅ 結合成交量、價格、籌碼面數據來分析主力行為
   - ✅ **技術指標（RSI、MACD、ATR、MA 等）已由 P5 Daily 程式計算好，直接從 `MARKET_INDICATORS_DAILY` 讀取**
   - ✅ **不要讓 AI 重新計算技術指標（浪費算力且容易偏差）**

3. **輸出要求**：
   - ✅ 不僅僅是「Cat 分類」和「Buy/Stop 價格」
   - ✅ 必須包含「主力行為解釋」、「意圖判斷」、「未來預測」
   - ✅ **禁止輸出「根據黃金支撐、根據均線糾結、根據 RSI、根據 MACD」等程式就能算的結論**

---

## 🎯 最高等級原則 2：P2 同業比較與相對位置原則

### 原則定義

**P2 財務指標分析的重點不是指標的絕對數值，而是跟同業比較**

### 核心理念

1. **為什麼同業比較比絕對數值重要**：
   - ✅ 每個產業、每個板塊都有自己獨特的毛利率、成本結構、週期性特徵等
   - ✅ 絕對數值（例如 ROE ≥ 15%、FCF margin ≥ 15%）不能正確反映公司在該產業中的競爭力
   - ✅ **重點應該是相對位置，而非絕對數值**

2. **P2 的核心任務**：
   - ✅ **判斷公司在同業中的相對位置**（前段、中段、還是後段？）
   - ✅ **判斷在同一板塊裡，它是結構性優勢者，還是結構性弱者？**
   - ✅ **判斷財務特徵是否「不像這個板塊的正常公司」？**

3. **Gate 檢查標準**：
   - ✅ **Gate 檢查應基於同業比較結果，而非絕對數值**
   - ✅ 如果目標公司多數指標在**前段**，且無重大異質性風險 → **PASS**
   - ✅ 如果目標公司多數指標在**中段**，但核心指標（現金流、債務）良好 → **PARTIAL**
   - ✅ 如果目標公司多數指標在**後段**，或存在重大異質性風險 → **FAIL**

4. **同業數據收集**：
   - ✅ **同業數據必須從相同白名單數據源抓取**（確保比較基準一致，偏移可以被抵消）
   - ✅ 目標公司是台股 → 同業也從 P2_TAIWAN CSE 抓取
   - ✅ 目標公司是美股 → 同業也從 INSTITUTIONAL_DATA CSE（SEC EDGAR）抓取
   - ✅ 目標公司是日股 → 同業也從 P2_JAPAN CSE 抓取

### 實作要求

1. **Prompt 設計**：
   - ✅ 必須強調「重點不是絕對數值，而是相對位置」
   - ✅ 必須要求執行完整的同業比較分析
   - ✅ 必須要求計算相對位置（前段/中段/後段）
   - ✅ 必須要求判斷結構性優勢/弱勢
   - ✅ 必須要求判斷異質性風險

2. **數據收集**：
   - ✅ 必須收集 3-5 家同業公司的財務數據
   - ✅ 同業數據必須從相同白名單數據源抓取
   - ✅ 確保數據時間段一致
   - ✅ **同業分類**：必須分開龍頭/中大型/小型新創來比較，絕對不能跨分類比較
   - ✅ **同業定義**：不是「同板塊」，而是「相同細分產業」，必須由 AI 交叉判定

3. **輸出要求**：
   - ✅ **Stage 1（AI）**：必須輸出同業公司清單（包含規模分類和選擇理由）
   - ✅ **Stage 1（AI）**：必須同時提取目標公司和同業公司的財務指標
   - ✅ **Stage 2（程式）**：必須輸出相對位置分析（每個指標的前段/中段/後段）
   - ✅ **Stage 2（程式）**：必須輸出結構性優勢判斷（結構性優勢者/結構性弱者）
   - ✅ **Stage 2（程式）**：必須輸出異質性風險判斷
   - ✅ 必須確認同業數據來源

### 雙 FPE 制度 ⭐⭐⭐ **V6.0 原始設計恢復（已修正）**

**防止市場情緒誤判：使用雙 FPE 制度區分公司財測與市場共識**

1. **FPE_A（基於公司財測/來期業績推導的 Forward P/E）**：
   - ✅ **定義**：用「公司財報指引中自己給的財測/來期業績」去推 forward EPS → forward P/E
   - ✅ **推導方式**：FPE_A = 當前股價 / 公司財測/來期業績的 Forward EPS
   - ✅ **特性**：偏公司端/可驗證，來自公司官方財測
   - ⚠️ **限制**：FPE_A 公布時就已經股價反應，沒有未來增幅的效用
   - ⚠️ **在 P2 中的定位**：FPE 在 P2 的安全性分析權重不高
   - ✅ **數據來源**：財報狗（美股/台股）、buffet code（日股）的財報搜尋結果（提取財測/來期業績）

2. **FPE_B（市場分析師共識的 Forward P/E）**：
   - ✅ **定義**：市場上分析師的大致共識（分析師預估的 Forward P/E）
   - ✅ **特性**：不準確數據，偏向市場氣氛，來源無法驗證，可能人為操縱
   - ✅ **用途**：判斷市場溫度計（普遍樂觀/中性/悲觀）
   - ✅ **重要特性**：真正對股價有推動力的是後來不斷更新的 FPE_B
   - ⚠️ **限制**：外來資訊僅做為參考與輔助，我們的系統才是真正能全方位算出最接近未來 FPE 的工具
   - ✅ **使用方式**：
     * 必須要跟同業的數據做比較
     * 判斷出是整個板塊市場情緒都是樂觀/中性/悲觀，還是只有該公司被市場特別的樂觀/中性/悲觀
     * 其結論作為 FPE_A 的輔助資料或驗證資料（是否與公司官方相符/背離）使用
   - ✅ **數據來源**（可選方案，需評估）：
     * Yahoo Finance Analysis 頁面（爬蟲，非 CSE）
     * 財報狗網站（P2_US_TAIWAN CSE）- 財報狗的 Forward P/E 實際上是分析師預估
     * 需要評估哪個更合適

3. **FPE 在系統中的定位**：
   - ⚠️ **FPE 在 P2 的安全性分析權重不高**
   - ✅ **FPE 在股價漲幅潛力面卻是非常重要的因素**
   - ✅ **FPE 更像是 P3 的因子**：P3 判斷現在股價是否便宜/合理/昂貴的因子之一
   - ✅ **數據繼承**：FPE A/B 都要繼承給 P3 作為綜合判斷調整 cat 使用
   - ⚠️ **禁止使用 FPE 單一項來決定**：FPE A/B 僅是眾多決策因子的一環

### 實作要求

1. **Prompt 設計**：
   - ✅ 必須明確說明 FPE_A 和 FPE_B 的定義、特性、用途
   - ✅ 必須說明 FPE_A 作為安全性判斷唯一依據
   - ✅ 必須說明 FPE_B 需要與同業比較，作為 FPE_A 的輔助/驗證資料

2. **數據收集**：
   - ✅ FPE_A 從財報狗/buffet code 獲取（財報數據的一部分）
   - ⚠️ FPE_B 的數據來源待定案（不能用 CSE 搜尋，不能用單一數據來源）

3. **輸出要求**：
   - ✅ 必須輸出 FPE_A 和 FPE_B（如果可用）
   - ✅ 必須說明 FPE_B 與同業的比較結果
   - ✅ 必須說明 FPE_B 與 FPE_A 是否相符/背離

---

## 🎯 最高等級原則 3：數據繼承原則

- P0-P3 一路做下來繼承的結論，必須作為持倉依據使用（P4 輸出）

---

## 🎯 最高等級原則 4：Daily/Weekly 職責分工

### Daily 定位
- 數據與新聞蒐集，不做任何策略制定，僅有提醒功能
- 將能夠由程式公式處理的部分都由程式計算，AI 算力大幅下降

### Weekly 定位
- AI 模型最吃重，負責策略制定
- 採取 batch 方式降低成本

---

## 🎯 最高等級原則 5：數據生命週期

- 按照資料特性判斷失去時效性後，封存進另外新建檔案後刪除

---

## 🎯 最高等級原則 6：白名單數據源原則

### 原則定義

**所有系統數據都要由白名單去拿，不能讓 AI 模型自己去找，以免偏差**

### 核心理念

1. **數據收集控制**：
   - ✅ **所有數據類的資料一律不由 AI 模型自己搜尋，全部由程式從白名單數據源獲取**
   - ✅ **程式控制所有數據收集流程**（CSE 搜尋、API 調用、表格讀取）
   - ✅ **AI 模型只負責分析已提供的數據，不負責搜尋數據**

2. **白名單數據源**：
   - ✅ **P2 財務數據**：使用白名單 CSE（P2_TAIWAN、INSTITUTIONAL_DATA、P2_JAPAN）
   - ✅ **P5 Daily OHLCV 數據**：使用 stooq.com（通過 Cloud Function 代理）、TWSE/TPEX
   - ✅ **P5 Daily 新聞**：使用白名單 CSE（P5_NEWS）
   - ✅ **P3 技術數據**：優先從 `MARKET_INDICATORS_DAILY`、`MARKET_OHLCV_DAILY` 讀取，不足才從 stooq.com 補充

3. **數據繼承**：
   - ✅ **P3 讀取歷史 OHLCV 數據**：優先從 `MARKET_OHLCV_DAILY` 表格讀取（已持倉個股可以使用留存的資料）
   - ✅ **如果數據不足，自動從 stooq.com 補充**（通過 Cloud Function 代理，使用白名單）
   - ✅ **P2 財務指標**：已由 P2 收集並分析完成，P3 直接繼承使用，不需要重複搜尋與計算

4. **Prompt 要求**：
   - ✅ **所有 Prompt 必須明確說明「所有數據類的資料一律不由 AI 模型自己搜尋，全部由程式從白名單數據源獲取」**
   - ✅ **明確說明數據來源**（白名單 CSE、白名單數據源）
   - ✅ **明確禁止讓 AI 模型自己去找數據**

### 實作要求

1. **數據收集函數**：
   - ✅ 所有數據收集函數必須使用白名單數據源
   - ✅ 不允許 AI 模型直接搜尋數據
   - ✅ P3 必須調用 `getHistoricalOHLCV` 函數讀取歷史 OHLCV 數據

2. **Prompt 設計**：
   - ✅ P2 Prompt 必須說明財務數據已由程式從白名單 CSE 收集
   - ✅ P3 Prompt 必須說明歷史 OHLCV 數據已由程式從白名單數據源收集
   - ✅ 所有 Prompt 必須明確禁止讓 AI 模型自己去找數據

3. **數據流檢查**：
   - ✅ 確認所有數據收集都遵循白名單原則
   - ✅ 確認所有 Prompt 都包含數據來源說明
   - ✅ 確認沒有讓 AI 模型自己搜尋數據的情況

---

## 🎯 最高等級原則 7：學習機制

- 使用 AI 模型（雙模型）進行複雜推理
- 系統只提供歷史快照（前三個月），避免單次偏移被完全繼承

---

## 📋 原則實施檢查清單

### P2 Prompt 對齊檢查（最高優先級）⭐⭐⭐⭐⭐

- [ ] **同業比較檢查**：Prompt 是否強調「重點不是絕對數值，而是相對位置」？
- [ ] **同業定義檢查**：Prompt 是否說明同業不是「同板塊」，而是「相同細分產業」？
- [ ] **同業分類檢查**：Prompt 是否要求分開龍頭/中大型/小型新創來比較，禁止跨分類比較？
- [ ] **兩階段流程檢查**：Prompt 是否明確說明兩階段流程（AI 識別同業 → 程式計算相對位置）？
- [ ] **Stage 1 任務檢查**：Prompt 是否要求 AI 只執行 Stage 1（識別同業清單），不需要計算相對位置？
- [ ] **同業指標提取檢查**：Prompt 是否要求同時提取目標公司和同業公司的財務指標？
- [ ] **Gate 檢查**：Prompt 是否說明 Gate 檢查基於同業比較結果，而非絕對數值？
- [ ] **數據來源檢查**：Prompt 是否要求同業數據從相同白名單數據源抓取？
- [ ] **輸出檢查**：Prompt 是否要求輸出同業公司清單（包含規模分類和選擇理由）？

### P3 Prompt 對齊檢查（最高優先級）

- [ ] **視角檢查**：Prompt 是否以機構主力視角設計？（高盛、摩根、大型對沖基金等）
- [ ] **目標檢查**：Prompt 是否強調「預測未來」而非「技術分析」？
- [ ] **邏輯檢查**：Prompt 是否強調「量大於價」和「解釋主力行為」？
- [ ] **禁止檢查**：Prompt 是否明確禁止輸出「根據 RSI、MACD、均線、支撐壓力」等程式就能算的結論？
- [ ] **數據檢查**：Prompt 是否說明技術指標已由程式計算好，直接使用？
- [ ] **數據檢查**：Prompt 是否整合使用 P2.5 的機構級數據？
- [ ] **輸出檢查**：Prompt 是否要求輸出「主力行為解釋」、「意圖判斷」、「未來預測」？

### 系統架構檢查

- [ ] P3 是否正確使用 P2.5 的 Smart_Money_Score 和機構級數據？
- [ ] P3 的輸出是否包含行為解釋和意圖判斷？
- [ ] P3 的 AI 模型配置是否符合機構級預測的需求？

---

## ✅ 原則確認

**確認日期**：2025-01-14  
**確認者**：系統架構團隊  
**狀態**：✅ 最高等級原則已確認，必須在所有實施中嚴格遵循

---

**重要提醒**：此原則為系統的靈魂所在，在進行 Prompt 對齊時必須嚴格遵循。
