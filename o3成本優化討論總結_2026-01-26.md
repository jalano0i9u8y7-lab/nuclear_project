# o3 成本優化討論總結：省「隱形思考」tokens 三招

**討論日期**：2026-01-26  
**狀態**：已定案並寫入 SSOT 與工程備忘錄  
**核心原則**：完全不犧牲品質的前提下省成本

---

## 一、背景與目標

### 問題

- o3 的 **reasoning（隱形思考）全部計入 output tokens** 費用
- P1-2 到 P5、D1-4 都是**重複 prompt 呼叫 100 次**（每檔個股/每則新聞）
- Output（reasoning tokens）成本爆炸，但 input 也很貴（prompt 超長）

### 目標

「不降品質、不降思考深度」下，怎麼省 reasoning tokens？

**答案**：走「工程設計」，讓 o3 每次思考時：
- 需要探索的分支更少
- 重複推理更少
- 上下文更乾淨

---

## 二、三招組合拳（A + B + C）

### 招式 A：Prompt Caching（降 input 成本）

**原理**：
- 把「長且每檔重複」的內容放在**固定前綴**（system / developer message）
- 變動的只放：delta pack、ticker 事實、新聞片段 id
- OpenAI 對 o3 支援 prompt caching（>1024 tokens 以 128 token 為單位自動 cache，cached input 約 50% 折扣）

**可 Cache 內容**：
- SSOT / Phase rules
- 評分框架
- 輸出 schema
- 硬約束條文

**變動內容**（per-request）：
- Delta pack
- Ticker 事實
- 新聞片段 id
- 當次 snapshot

**關鍵要點**：
- 固定前綴須**完全一致**（同一 batch/run 內不可變動），才能多檔吃到 cache
- **Scout/Deep Auditor 的 context 不可省**（省掉 = 降品質），但固定規則仍可 cache

**品質影響**：無（同一內容，只改結構）

---

### 招式 B：Batch API（降整單成本）

**原理**：
- OpenAI Batch API 提供 **50% 折扣**（input + output，含 reasoning tokens）
- 非同步執行（24h 內完成）

**已用於**：
- P2-2 Scout（o3 batch）
- P2.5（o3 batch）
- P3（o3 batch）
- WB-2 Scout（o3 batch）

**品質影響**：無（同一模型、同一 prompt，僅非同步）

---

### 招式 C：程式前置裁剪（降 o3 reasoning 體積）

**原理**：
- **不是**用程式取代分析
- **而是**用程式砍掉「o3 在腦中重跑規則引擎」的負擔
- 讓 o3 的推理**變短、變聚焦**（少很多「檢查邊界、執行規則」的分支），但**不減分析深度**

**邊界（關鍵）**：
- ✅ **可移走**：確定性檢查 + 已寫死規則（純公式運算 + 格式檢查）
- ❌ **不可移走**：需判斷、需語義理解的項目

---

## 三、可程式前置的清單（C 的範圍）

### ✅ 可程式前置（完全不影響品質）

| 項目 | 說明 |
|------|------|
| **Schema / 範圍檢查** | JSON 欄位/型態、0-100、權重總和、position_cap ≤ max_allowed |
| **NaN/Inf/除零** | 數學邊界檢查 |
| **Hard Caps** | CFO < 0 → cap 59；runway < 4 → cap 55（SSOT 已有）；結果寫 audit_log |
| **P2 Stage 2 相對位置** | 程式從**權威網站**抓同業數據（AI 只給「應該比誰」的判斷）→ 程式算排名/百分位 |
| **Evidence_id 格式檢查** | 檢查引用的 id 是否在 DB/snapshot 中（格式存在性檢查） |
| **Kill switch / defcon 觸發** | `defcon=1` / `emergencyExit=TRUE` → 程式直接執行，不需 o3 推理 |
| **規則優先權（已寫死）** | 例如「風控 > 市場氣候」→ 程式先裁掉違反項，o3 只處理「無法形式化」的衝突 |

### ❌ 不可程式前置（會降品質）

| 項目 | 為何不可？ |
|------|-----------|
| **同業分類是否正確** | 判定「龍頭 vs 中大型 vs 新創」需 AI 推理（規模、市占、業務成熟度），不是公式 |
| **引用邏輯是否合理** | 「這個引用合不合理/會不會跨期」需**語義理解**，程式抓不出來 |
| **是否假突破 / identity drift / escalation** | 全是判斷，不是公式 |
| **Scout/Deep Auditor 的 prompt 與 context** | 省掉 = 降品質；Scout 需要完整 context（原始資料 + Analyst 輸出）才能補強視角 |

---

## 四、用戶的關鍵糾正

### 糾正 1：P1-5 每檔個股、D1-4 每則新聞都是重複 100 次

- P1-2 以下一直到 P5 WB-1/WB-2 都是要跑**每檔個股**的工作
- P5 D1-4 分析**每則新聞**或建立**每檔個股**的索引
- 這些一定要吃到 **cache**（招式 A 最重要）

### 糾正 2：審查者 prompt 不能省

- Scout/Deep Auditor 的定位是「從分析者沒想到的視角補強」，不是抓錯
- 省掉 Scout 的 context = 降低品質 → **絕對不可以**

### 糾正 3：同業數據流程

- ❌ **錯誤說法**：「AI 給同業數據」
- ✅ **正確流程**：
  - **AI 只負責**：判斷「這檔是龍頭/中大型/新創」+「同業應該包含哪 3-5 家」
  - **權威網站負責**：提供同業財報數據（甚至直接提供同業清單，準確度比 AI 高）
  - **程式負責**：Stage 2 從權威網站抓取數據 → 計算相對位置/排名

### 糾正 4：引用不跨期程式抓不出來

- 「這筆引用是否跨期」需要理解語義（這個 evidence 是哪一期的？當前分析的時間範圍是？引用邏輯合不合理？）
- 程式只能檢查 `evidence_id` 是否存在於 DB（格式檢查）
- 但「這個引用合不合理/會不會跨期」→ 只能靠 AI 或人工審查

---

## 五、實作要點（C 的前提）

### 執行順序

在**呼叫 o3 前**跑完所有「可程式化」檢查：
1. Schema / 範圍檢查
2. Hard Caps
3. Kill switch / defcon 觸發
4. P2 Stage 2 相對位置計算
5. Evidence_id 格式檢查
6. 規則優先權（已寫死部分）

### Prompt 調整

改為「下列檢查已由系統完成，請基於已通過的輸入做分析」

**不要**在 prompt 裡塞一整份「請你先檢查 schema/範圍/引用」讓 o3 重跑

### 品質紅線

- Scout/Deep Auditor 需要完整 context
- 固定規則可 cache，但變動 context 不能省
- 程式只做「純公式運算 + 格式存在性檢查 + 已寫死規則執行」，其餘全留給 AI

---

## 六、總結

### 三招對應關係

| 招式 | 省的是 | 品質影響 | 優先順序 |
|------|--------|----------|----------|
| **A. Prompt Caching** | Input（固定前綴約 50% 折扣） | 無 | 高（P1-5 每檔重複，效益最大） |
| **B. Batch API** | 整單（input + output 含 reasoning 約 50% 折扣） | 無 | 高（已定案，立刻有效） |
| **C. 程式前置裁剪** | Reasoning 體積（o3 少跑規則引擎分支） | 無（前提：只移確定性檢查） | 中（需確保邊界，部分已實現） |

### 強制原則

- **省成本的方法必須建立在完全不影響品質的大前提下**
- **任何會影響輸出品質的省成本方式絕對不可照做**
- 程式只做「純公式運算 + 格式存在性檢查 + 已寫死規則執行」，其餘全留給 AI

### 已寫入文件

- **SSOT**：`V8.0架構定案文檔_SSOT.md` → M0 Batch API 章節補充「省 o3 成本關鍵」與「省 o3 隱形思考 tokens 三招」
- **工程備忘錄**：`GAS妥協清算與Python重建工程備忘錄_待定案.md` → 新增「四、o3 成本優化」專節 + 更新「六、工程師搬遷必查表」

---

**結論**：三招並用（A + B + C），邊界嚴守，完全不犧牲品質。
