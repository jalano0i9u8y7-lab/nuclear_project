# 宏觀數據修正確認清單

## ⚠️ 重要：Google Apps Script 需要重新部署

**問題**：日誌顯示還是從 Stooq 開始，但程式碼已經修正為直接使用 Yahoo Finance JSON API。

**可能原因**：
1. Google Apps Script 還沒有重新載入新的程式碼（需要重新部署或刷新）
2. 可能有緩存問題

## ✅ 確認修正的項目

### 1. `collectCommodityPrices()` - ✅ 已修正
- **修正前**：先從 Stooq 開始，失敗後才用 Yahoo Finance
- **修正後**：**直接使用 Yahoo Finance JSON API，不再嘗試 Stooq**
- **日誌格式**：`收集 WTI原油 (CL=F) 價格`（不是 `(CL.F)`）

### 2. `collectBondYields()` - ✅ 已修正
- **修正前**：先從 Stooq 開始（10YUSY.B, 3MUSY.B）
- **修正後**：**直接使用 Yahoo Finance JSON API（^TNX, ^IRX），不再嘗試 Stooq**

### 3. `collectMarketIndices()` - ✅ 已修正
- **修正前**：先從 Stooq 開始（VI.F）
- **修正後**：**直接使用 Yahoo Finance JSON API（^VIX），不再嘗試 Stooq**

### 4. `collectCurrencyRates()` - ✅ 已修正（部分）
- **美元指數**：不使用 Stooq（`useStooq: false`）
- **其他匯率**：仍使用 Stooq（因為 FX 目前正常，`useStooq: true`）

### 5. 數據驗證 - ✅ 已實現
- 價格合理性檢查
- 變動幅度檢查（日變動不應超過 50%）
- 數據污染檢測（防止多個 ticker 回傳相同價格）

## 🔍 檢查方法

### 1. 確認程式碼已更新
檢查 `src/24_P5_DAILY_MACRO.js` 的 `collectCommodityPrices()` 函數：
```javascript
// 應該是：
Logger.log(`P5 Daily：收集 ${item.name} (${item.yahooTicker}) 價格`);
const data = getYahooFinanceQuote(item.yahooTicker);

// 不應該是：
Logger.log(`P5 Daily：收集 ${item.name} (${item.stooqTicker}) 價格`);
let data = fetchMacroDataFromStooq(...);
```

### 2. 確認日誌輸出
**正確的日誌應該顯示**：
- `P5 Daily：收集 WTI原油 (CL=F) 價格` ✅
- `P5 Daily：從 Yahoo Finance JSON API 獲取 CL=F（首次）` ✅
- **不應該有**：`P5 Daily：從 stooq.com 獲取 CL.F (CL.F) 宏觀數據（通過代理）` ❌

### 3. 確認數據來源
**正確的數據來源**：
- 商品：`YAHOO_FINANCE_JSON` 或 `YAHOO_FINANCE_HTML`（如果 JSON API 失敗）
- **不應該是**：`STOOQ`（除非是 FX 匯率）

## 🛠️ 解決步驟

### 步驟 1：重新部署 Google Apps Script

1. 在 Google Apps Script 編輯器中，點擊「**部署**」→「**新增部署**」
2. 或點擊「**部署**」→「**管理部署**」→「**編輯**」現有部署

### 步驟 2：確認檔案載入順序

在 Google Apps Script 專案中，確認檔案載入順序：
1. `02_M0_CONFIG.js`
2. `03_M0_CORE.js`
3. `24_P5_DAILY_MACRO.js`（**必須在 24_P5_DAILY.js 之後**）
4. `24_P5_DAILY.js`

### 步驟 3：清除快取

在 Google Apps Script 編輯器中：
1. 點擊「**執行**」→「**清除執行狀態**」
2. 重新執行測試函數

### 步驟 4：驗證修正

重新執行 P5 Daily，檢查日誌：
- ✅ **應該看到**：`從 Yahoo Finance JSON API 獲取 CL=F（首次）`
- ❌ **不應該看到**：`從 stooq.com 獲取 CL.F (CL.F) 宏觀數據`

如果日誌顯示還是從 Stooq 開始，可能是：
1. 檔案還沒有上傳到 Google Apps Script
2. Google Apps Script 需要重新部署
3. 有其他檔案還在使用舊的邏輯
