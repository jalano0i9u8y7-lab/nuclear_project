# 成本估算 V8.0（最終修正版 - 基於 SSOT 和程式碼檢查）

**更新日期**：2026-01-17  
**修正原因**：根據 SSOT 文檔和程式碼檢查，修正 P5 Daily 和 P3 週度的成本估算  
**批次規模調整**：AI 分析批次從 5-8 家/批改為 5-6 家/批（P3/P5 Weekly 策略）  
**模型配置**：方案 B（考慮成本，平衡方案）

---

## 📊 執行摘要

本文檔基於 SSOT 文檔和程式碼檢查，修正了成本估算中的錯誤假設：

1. **P5 Daily**：根據 SSOT 和用戶確認，P5 Daily 應該只有**整理與摘要功能**，**不應該有推理部分**（GPT-5.2 分析關聯性功能應該移除或移到 P5 Weekly）
2. **P3 週度**：根據 SSOT，P3 由 P5 Weekly 統一調度觸發（每週一次），但程式碼中讀取所有股票（`getPhase2OutputFromSheet()`），**需要確認是否有過濾機制**
3. **P5 Weekly 策略**：每檔股票都要做每週策略（確認正確）

---

## 🔍 SSOT 和程式碼檢查結果

### 1. P5 Daily 實際功能（根據 SSOT 和程式碼）

**SSOT 寫的功能**：
- P5.1: 每日新聞十大類整理 + 重要財經判斷數據
- P5.2: 每日市場與個股 OHLCV 數據蒐集
- P5.3: 衍生品期權數據
- P5.4: 監測持股大幅度波動或突發黑天鵝新聞
- P5.5: 財報事件監控（Daily 僅監控，不做策略制定）
- P5.6: 台股掛單監控檢查

**SSOT 寫的 P5.1 詳細功能**：
> 多語新聞收集、新聞原子化、多語審查去重 + 分類、**分析結果與歷史資訊關聯性，更新每日世界觀**、宏觀數據收集

**程式碼實際情況**（`24_P5_DAILY_NEWS.js`）：
- Step 1: 收集多語新聞（CSE）
- Step 2: GEMINI_FLASH 清洗（Atom 化）
- Step 3: GEMINI_PRO 多語審查去重 + 分類
- Step 4: **GPT-5.2 分析結果與各結論與歷史資訊關聯性 更新每日世界觀** ⚠️

**用戶確認**：
> P5 Daily 應該只有數據與新聞蒐集/監控策略觸發/通知功能，沒有需要推理的地方，不應該用到那麼多成本  
> Daily 應該 AI 模型只有整理與摘要功能，不應該再有推理部分

**結論**：
- ⚠️ **程式碼中有 GPT-5.2 分析關聯性功能（`analyzeNewsWithGPT`），但根據用戶確認，這應該移除或移到 P5 Weekly**
- P5 Daily 只應該有：GEMINI_FLASH（清洗）+ GEMINI_PRO（多語去重 + 分類）
- 世界觀更新應該是 P5 Weekly 的職責，不是 P5 Daily

---

### 2. P3 週度觸發機制（根據 SSOT 和程式碼）

**SSOT 寫的執行頻率**：
- **統一調度（優先）**: 由 P5 Weekly/Monthly 統一調度
  - 並行執行 P2 和 P2.5
  - 兩者都完成後才觸發 P3
  - 確保 P3 使用最新的 P2 + P2.5 數據
- **自動觸發（備用）**: 當 P2/P2.5 有變動時（僅在非 Weekly/Monthly 時段）
- **週度（定期）**: 由 P5 Weekly 觸發

**程式碼實際情況**（`22_P3_CORE.js`）：
- `P3_Execute` 讀取 `getPhase2OutputFromSheet()`，這會讀取**所有股票**
- 沒有看到過濾機制（只處理有變動的股票）
- 提交到 M0 Job Queue 時，會處理所有股票

**用戶確認**：
> P3 的週度觸發機制是甚麼? 我印象中應該是有變動的股票才會觸發週度分析，不是每週都要跑全部持股吧?

**結論**：
- ⚠️ **程式碼中 P3 週度會處理所有股票，但根據用戶確認，應該只處理有變動的股票**
- 需要確認是否有過濾機制，或需要實現過濾機制
- 如果只處理有變動的股票，成本會大幅降低

---

### 3. P5 Weekly 策略（確認正確）

**SSOT 和程式碼確認**：
- ✅ 每檔股票都要做每週策略（正確）
- ✅ 批次處理：6 家/批
- ✅ 成本估算正確

---

## 💰 修正後的成本估算

### P5 Daily 成本修正

**SSOT 寫的功能**（可能不準確）：
- GPT-5.2 分析關聯性、更新每日世界觀

**用戶確認的功能**（正確）：
- 只有整理與摘要功能，不應該有推理部分

**修正後**（實際功能）：
- 執行者：**無 AI 分析**（僅數據收集）
- 新聞原子化：GEMINI_FLASH（清洗）+ GEMINI_PRO（多語去重 + 分類）
- **移除 GPT-5.2 分析關聯性功能**（應該移到 P5 Weekly 或移除）
- 假設每檔股票每天 10 筆新聞，每批 20 筆新聞：
  - GEMINI_FLASH 清洗：20 筆 × 0.5K tokens × $0.0001 = $0.001
  - GEMINI_PRO 去重+分類：20 筆 × 2K tokens × $0.002 = $0.004
  - 每檔股票成本：$0.005/天

**月度成本**（80 檔，分層執行）：
- CORE（20 檔，每日）：20 × 30 × $0.005 = **$3.00**
- STABLE_SWING（25 檔，週度）：25 × 4 × $0.005 = **$0.50**
- AGGRESSIVE（20 檔，週度）：20 × 4 × $0.005 = **$0.40**
- OPPORTUNISTIC（15 檔，月度）：15 × 1 × $0.005 = **$0.08**
- **P5 Daily 小計**：**$3.98/月**（修正：移除 GPT-5.2 分析關聯性功能）

---

### P3 週度成本修正

**SSOT 寫的執行頻率**：
- 由 P5 Weekly 統一調度觸發（每週一次）

**程式碼實際情況**：
- `P3_Execute` 讀取所有股票（`getPhase2OutputFromSheet()`）
- 沒有看到過濾機制

**用戶確認**：
- 應該是有變動的股票才會觸發週度分析

**修正後**（假設只處理有變動的股票）：
- **需要確認**：P3 週度是否真的只處理有變動的股票？程式碼中需要實現過濾機制
- **假設**：每週平均 20% 股票有變動（16 檔/80 檔）
- 16 檔 ÷ 5 家/批 = 3.2 批次（向上取整為 4 批次）
- 每週批次成本：4 批次 × $2.249 = $8.996
- **月度成本**：4 週 × $8.996 = **$35.98/月**（降低 75%）

**注意**：需要確認 P3 週度是否真的只處理有變動的股票，或需要實現過濾機制

---

## 📊 修正後的月度成本總結（80 檔股票）

| 類別 | 修正前（USD） | 修正後（USD） | 差異 | 備註 |
|------|--------------|--------------|------|------|
| **產業面級別** | $8.07 | $8.07 | - | - |
| **P2 系列** | $25.28 | $25.28 | - | - |
| **P2.5 系列** | $30.40 | $30.40 | - | - |
| **P3 系列** | $179.92 | **$71.96** | -$107.96 | ⚠️ 假設只處理有變動的股票 |
| **P5 Weekly 策略** | $151.03 | $151.03 | - | - |
| **P5 Daily** | $397.50 | **$3.98** | -$393.52 | ⚠️ 移除 GPT-5.2 分析功能 |
| **P5 Weekly/Monthly** | $2.92 | $2.92 | - | - |
| **其他成本** | $110.00 | $110.00 | - | - |
| **總計** | **$905.12/月** | **$404.64/月** | **-$500.48** | - |

**年度總計**：**$4,855.68/年**（修正前：$10,861.44/年）

**成本降低**：$6,005.76/年（55.3%）

---

## ⚠️ 需要修正的程式碼問題

### 1. P5 Daily GPT-5.2 分析功能應該移除或移到 P5 Weekly

**問題**：
- `24_P5_DAILY_NEWS.js` 中的 `analyzeNewsWithGPT` 函數會分析關聯性和更新世界觀
- 但根據用戶確認，P5 Daily 應該只有整理與摘要功能，不應該有推理部分

**需要修正**：
- **選項 A**：移除 `analyzeNewsWithGPT` 函數，P5 Daily 只保留 GEMINI_FLASH + GEMINI_PRO
- **選項 B**：將 `analyzeNewsWithGPT` 移到 P5 Weekly（每週一次，而非每日）

**建議**：選項 B（移到 P5 Weekly），因為世界觀更新應該是週度任務，不是每日任務

---

### 2. P3 週度需要實現過濾機制（只處理有變動的股票）

**問題**：
- `22_P3_CORE.js` 中的 `P3_Execute` 讀取所有股票（`getPhase2OutputFromSheet()`）
- 沒有過濾機制，會處理所有股票

**需要修正**：
- **實現過濾機制**：只處理有變動的股票（例如：P2/P2.5 有變動、技術指標有重大變化等）
- 或**確認觸發機制**：P3 週度是否真的需要處理所有股票，還是可以只處理有變動的股票

**建議**：實現過濾機制，根據快照比對結果，只處理有變動的股票

---

## 📝 修正總結

### 主要修正

1. **P5 Daily 成本大幅降低**：
   - 移除 GPT-5.2 分析關聯性功能（或移到 P5 Weekly）
   - 只保留 GEMINI_FLASH（清洗）+ GEMINI_PRO（多語去重 + 分類）
   - 成本從 $397.50/月 降至 $3.98/月

2. **P3 週度成本降低**（假設實現過濾機制）：
   - 假設只處理有變動的股票（每週平均 20%）
   - 成本從 $143.94/月 降至 $35.98/月

3. **總成本大幅降低**：
   - 從 $905.12/月 降至 $404.64/月
   - 年度成本從 $10,861.44 降至 $4,855.68

---

## 🎯 需要實施的修正

### 優先級高（必須修正）

1. **移除或移動 P5 Daily 的 GPT-5.2 分析功能** ⭐⭐⭐
   - 檔案：`src/24_P5_DAILY_NEWS.js`
   - 選項 A：移除 `analyzeNewsWithGPT` 函數
   - 選項 B：移到 P5 Weekly（建議）

2. **實現 P3 週度過濾機制** ⭐⭐⭐
   - 檔案：`src/22_P3_CORE.js`
   - 實現過濾邏輯：只處理有變動的股票
   - 或確認觸發機制：是否需要處理所有股票

---

**文檔版本**：V4.0（最終修正版）  
**最後更新**：2026-01-17  
**狀態**：✅ 基於 SSOT 和程式碼檢查修正，待修正程式碼問題
