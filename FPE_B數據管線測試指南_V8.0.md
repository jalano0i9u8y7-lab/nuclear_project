# FPE_B 數據管線測試指南 V8.0

**測試日期**：2026-01-16  
**目的**：驗證 FPE_B 數據收集功能是否暢通

---

## 📋 測試腳本說明

已建立測試腳本：`src/TEST_FPE_B_PIPELINE.js`

### 可用測試函數

1. **`testFPE_B_Quick()`** - 快速測試（3 個測試案例）
   - 測試美股（AAPL）、台股（2330）、日股（7203）
   - 適合快速驗證基本功能

2. **`testFPE_B_Full()`** - 完整測試（9 個測試案例）
   - 測試更多公司，涵蓋不同市場
   - 適合全面驗證功能

3. **`testFPE_B_Single(ticker, market)`** - 單個公司測試
   - 測試指定的單個公司
   - 例如：`testFPE_B_Single("AAPL", "US")`

4. **`testFPE_B_Integration()`** - 整合測試
   - 測試 FPE_B 整合到 P2 數據收集流程
   - 驗證整個數據流是否完整

5. **`testYahooFinanceParsing()`** - 解析邏輯測試
   - 直接測試 Yahoo Finance 解析函數
   - 驗證解析邏輯是否正確

---

## 🧪 執行測試步驟

### 步驟 1：在 Google Apps Script 編輯器中打開

1. 打開 Google Apps Script 編輯器
2. 找到 `TEST_FPE_B_PIPELINE.js` 檔案

### 步驟 2：執行快速測試

1. 選擇函數：`testFPE_B_Quick`
2. 點擊「執行」
3. 查看日誌輸出

**預期結果**：
- 每個測試案例應該顯示：
  - ✅ 成功：FPE_B = XX.XX
  - 或 ❌ 失敗：無法獲取 FPE_B（可能沒有分析師覆蓋）

### 步驟 3：檢查測試結果

**成功指標**：
- ✅ 能夠成功獲取 FPE_B 數值
- ✅ 數值在合理範圍內（通常 5-50）
- ✅ 不同市場都能正常運作

**失敗情況**：
- ❌ 無法獲取股價
- ❌ 無法解析 EPS
- ❌ HTTP 錯誤（403, 404, 429 等）
- ❌ 解析邏輯錯誤

---

## 📊 測試案例

### 快速測試案例

| Ticker | Market | 公司名稱 | 預期結果 |
|--------|--------|---------|---------|
| AAPL | US | 蘋果 | 應該有 FPE_B |
| 2330 | TW | 台積電 | 應該有 FPE_B |
| 7203 | JP | 豐田 | 應該有 FPE_B |

### 完整測試案例

| Ticker | Market | 公司名稱 |
|--------|--------|---------|
| AAPL | US | 蘋果 |
| MSFT | US | 微軟 |
| NVDA | US | 輝達 |
| 2330 | TW | 台積電 |
| 2317 | TW | 鴻海 |
| 2454 | TW | 聯發科 |
| 7203 | JP | 豐田 |
| 6758 | JP | 索尼 |
| 8035 | JP | 東京電子 |

---

## 🔍 測試檢查項目

### 1. 數據收集功能

- ✅ 能夠成功調用 `collectFPE_B_ForCompany()`
- ✅ 能夠成功構建 Yahoo Finance ticker（AAPL, 2330.TW, 7203.T）
- ✅ 能夠成功獲取 HTML 內容

### 2. 解析功能

- ✅ 能夠成功解析分析師共識 EPS
- ✅ 能夠成功獲取當前股價
- ✅ 能夠正確計算 FPE_B = Price / EPS

### 3. 錯誤處理

- ✅ 如果無法獲取數據，正確返回 `null`
- ✅ 錯誤不會中斷整個流程
- ✅ 錯誤訊息清晰明確

### 4. 整合功能

- ✅ FPE_B 能夠正確添加到財務數據對象中
- ✅ 數據流完整（從收集到輸出）

---

## ⚠️ 注意事項

### 1. 請求頻率限制

- Yahoo Finance 可能會限制自動化請求
- 測試腳本中已添加 2 秒延遲，避免請求過於頻繁
- 如果遇到 429 錯誤（Rate Limit），需要增加延遲時間

### 2. HTML 結構變動

- Yahoo Finance 的 HTML 結構可能會變動
- 如果解析失敗，可能需要更新解析邏輯
- 測試腳本使用多種解析方法，提高成功率

### 3. 分析師覆蓋

- 部分小公司可能沒有分析師覆蓋
- 這種情況下，FPE_B 會返回 `null`，這是正常情況
- 不應影響其他數據收集

---

## 📋 測試結果記錄

### 測試結果格式

```javascript
{
  success: true/false,
  ticker: "AAPL",
  market: "US",
  fpe_b: 25.5,  // 或 null
  elapsed: "3.45",  // 秒
  error: "錯誤訊息"  // 如果有錯誤
}
```

### 記錄測試結果

建議記錄以下資訊：
- 測試日期和時間
- 測試函數名稱
- 成功/失敗數量
- 每個測試案例的詳細結果
- 遇到的錯誤（如果有）

---

## 🔄 後續步驟

### 如果測試成功

1. ✅ 確認 FPE_B 數據管線暢通
2. ✅ 可以開始實際使用
3. ⚠️ 建議定期測試，確保穩定性

### 如果測試失敗

1. ⚠️ 檢查錯誤訊息
2. ⚠️ 確認 Yahoo Finance 是否可訪問
3. ⚠️ 檢查解析邏輯是否需要更新
4. ⚠️ 考慮實作備用方案（Finviz、鉅亨網等）

---

## 📝 測試日誌範例

```
================================================================================
🧪 測試 FPE_B 數據收集：AAPL (US)
================================================================================
P2 開始收集 FPE_B：ticker=AAPL, market=US, yahooTicker=AAPL
P2 FPE_B：開始抓取 Yahoo Finance（爬蟲方法，非 CSE），URL=https://finance.yahoo.com/quote/AAPL/analysis
P2 FPE_B：成功獲取分析師共識預估 EPS = 6.50（多個分析師的平均值）
P2 FPE_B：成功獲取股價 = 175.50
P2 FPE_B 計算完成：AAPL = 27.00 (Price: 175.50, EPS: 6.50)
✅ 成功：FPE_B = 27.00
⏱️  耗時：3.45 秒
```

---

**下一步**：在 Google Apps Script 編輯器中執行 `testFPE_B_Quick()` 開始測試。
