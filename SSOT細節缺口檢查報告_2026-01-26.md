# SSOT 細節缺口檢查報告（非 Prompt 之遺漏風險）

**日期**：2026-01-26  
**目的**：檢查**除 Prompt 外**，舊程式碼中哪些細節在 SSOT 僅有重點整理、**細節丟失較多**，可能造成改寫（如遷移 Python）時遺漏；並建議在 SSOT 中**補強或集中標註**，對齊最新設計。

---

## 一、檢查方法

- 對照 **GAS 程式碼**（`gas_archive/src/`）與 **SSOT** 現有章節。
- 若 SSOT 僅有「功能名稱、原則、檔案名」等級描述，而**實作細節**（欄位名、公式、閾值、狀態機、觸發條件、錯誤處理、表結構）僅存在於程式碼，則標記為**缺口**。
- 建議：將缺口**在 SSOT 中以專節或附錄補強**，或明確寫入「細節見《工程備忘錄》/ 某清單」，並在 SSOT 中引用，避免改寫時只依 SSOT 而漏掉實作。

---

## 二、缺口清單（按類別）

### 2.1 表結構與欄位（Schema）

| 項目 | SSOT 現狀 | 細節所在 | 遺漏風險 | 建議 |
|------|-----------|----------|----------|------|
| Phase 快照表欄位 | SSOT 多處提到「寫入 Px__SNAPSHOT」或「Phase2_Output」 | `01_SHEETS_STRUCTURE.js` 內各 SCHEMA（如 P0__SNAPSHOT_SCHEMA、Phase2_Output 欄位列表） | 改寫時不知道必填欄位、型別、鍵名 | 在 SSOT「資料存儲」或附錄中增加「各 Phase 快照／對外輸出表最小欄位清單」；或明確寫「完整 schema 見 01_SHEETS_STRUCTURE.js / 工程備忘錄 DB 設計」 |
| P6 表 | P6_INTRADAY_LOG、P6_EMERGENCY_EXIT_LOG、P6_INTRADAY_ALERTS_DAILY、retention_flag | 同上 + P6 清除鎖與保留規則 | 保留/清除條件與欄位對應遺漏 | SSOT 已部分寫入；建議補「P6 各表欄位與 retention_flag 對應」及「清除鎖觸發條件」 |
| 新聞/機構評級表 | NEWS_ATOMS_DAILY、STOCK_NEWS_INDEX_DAILY、INSTITUTIONAL_RATINGS_DAILY、多維度標籤 | 01_SHEETS_STRUCTURE 與 Daily 實作 | 標籤維度、索引鍵、欄位名遺漏 | 在 SSOT「P5 Daily」下列出「Daily 輸出表與關鍵欄位」或附錄連結 |
| 學習系統表 | P5__STRATEGY_SNAPSHOT、P5__OUTCOME_SNAPSHOT、P5__LEARNING_STATE、claims_json 結構 | 24_P5_WEEKLY_MEMORY_MANAGER 與 V8.13 說明 | claims 結構、scorecard 鍵名、attribution 類型遺漏 | SSOT 已有高層描述；建議補「Claims / Scorecard / Attribution 欄位與枚舉」一節或附錄 |
| DEFCON / 緊急撤退 | DEFCON_STATUS、P6_EMERGENCY_EXIT_LOG、trigger_type 等 | 01_SHEETS_STRUCTURE、28_P6_* | 觸發類型枚舉、寫入時機遺漏 | 在 SSOT「P6」或「風控」中列「DEFCON 與緊急撤退表欄位及 trigger_type 枚舉」 |

### 2.2 公式、閾值、機械規則

| 項目 | SSOT 現狀 | 細節所在 | 遺漏風險 | 建議 |
|------|-----------|----------|----------|------|
| P4 U/Cat/Tier 計算 | 原則與優先級（P0.7 > P0.5 > P2 > P3） | 10_P4_CALCULATOR.js（getCurrentUV8_15、applyPortfolioCorrelationLock、applyTimeWindowPenalty 等） | 具體公式、閾值（如板塊曝險 30–40%、Runway<4 cap）遺漏 | 在 SSOT「P4」中增加「關鍵閾值與公式一覽」或附錄（數字可引用單一來源） |
| P3 週線/日線聚合 | 50 週、60 日、[WEEKLY_CHART]/[DAILY_CHART] | 22_P3_DATA_COLLECTOR、formatTechnicalDataWithWeeklyDailyBlocks | 聚合方式、欄位名、區塊格式遺漏 | SSOT 已有描述；建議補「週線/日線輸入輸出欄位與區塊標記」 |
| P6 異常門檻 | 暴跌 ≥6%、急殺 ≥2%、暴漲 ≥6%、量比 ≥2.5 等 | 28_P6_INTRADAY_MONITOR、雙向監控設計 | 數值與 ATR 倍數遺漏 | 在 SSOT「P6」中列「異常偵測門檻一覽（%、ATR、量比）」 |
| P6 移動停利 | 最近 3 日高點回落 -4%、跌破 MA10 | 28_P6_TRAILING_STOP.js | 市場別差異（台/美/日）遺漏 | SSOT 已有；建議補「各市場閾值（若不同）」 |
| 相對強度 RS | RS = Stock % Change - Index % Change | 22_P3_DATA_COLLECTOR 或相關 | 計算時窗、指數對應遺漏 | 在 SSOT「P3」中註明 RS 定義與數據來源 |
| 拋物線清倉 | Price vs MA20 deviation > 95th percentile、Volume spike | 24_P5_WEEKLY_FINAL_OUTPUT 或決策架構 | 百分位計算方式、窗口遺漏 | 在 SSOT「P5 Weekly」或「V8.19」中列「PARABOLIC_EXHAUSTION 觸發公式」 |

### 2.3 狀態機、觸發條件、執行順序

| 項目 | SSOT 現狀 | 細節所在 | 遺漏風險 | 建議 |
|------|-----------|----------|----------|------|
| M0 任務路由 | task_prompt 來自 p0_prompt / p1_step1_prompt / … | 03_M0_CORE.js 一長串 if currentPayload.*_prompt | 所有 payload 鍵名與優先順序遺漏 | 在 SSOT「M0」中列「Payload 鍵名與 task_prompt 對應表」或「執行者 Prompt 來源優先序」 |
| Batch 與觸發式審查 | P3 審 15–25%、何時送審查者 | 03_M0_CORE、22_P3_CORE | 觸發條件（如 confidence 低、reviewReasons）遺漏 | 在 SSOT「M0」或「P3」中列「觸發審查條件與比例」 |
| P5 Weekly 步驟順序 | 雙層 P5-B → P5-A、escalation 計算、merge | 24_P5_WEEKLY_CORE、24_P5_WEEKLY_DUAL_LAYER | 呼叫順序、依賴關係遺漏 | SSOT 已有流程；建議補「P5 Weekly 步驟與依賴清單（含函數名）」 |
| P6 清除鎖 | 本週策略產出完成後清除上週、保留兩週 | 26_TRIGGER_SETUP、P6_ClearOldData、清除鎖 | 解鎖條件、誰寫入「策略產出完成」遺漏 | 在 SSOT「P6 數據保留」中寫明「清除鎖由誰設置、何時解鎖」 |
| 重入與觸發器 | 6 分鐘斷頭台、可重入設計、Trigger 命名 | 26_TRIGGER_SETUP、GAS 時代設計 | 目標架構禁止，但過渡邏輯若未記錄會誤複製 | 已在 SSOT/工程備忘錄寫「禁止」；建議保留「GAS 時代觸發清單與對應函數」一表供遷移對照 |

### 2.4 錯誤處理、Fallback、邊界

| 項目 | SSOT 現狀 | 細節所在 | 遺漏風險 | 建議 |
|------|-----------|----------|----------|------|
| 數據源 Fallback | GOOGLEFINANCE → Stooq / CSE 等 | 22_P3_DATA_COLLECTOR、24_P5_DAILY 等 fetch*Safe | 回退順序、超時、null 處理遺漏 | 在 SSOT「數據源」或工程備忘錄中列「各數據類 Fallback 順序與錯誤處理原則」 |
| Batch API 失敗 | 部分失敗、重試、降級為同步 | 03_M0_CORE 或 Batch 封裝 | 重試次數、降級條件遺漏 | 在 SSOT「Batch API」中列「失敗處理與降級」 |
| 除以零 / Infinity / NaN | P4 風控檢查 | 10_P4_CALCULATOR | 檢查點與覆寫行為遺漏 | SSOT 已提；建議補「P4 數學邊界檢查清單」 |
| 財報提取驗證 | INCOMPLETE_EXTRACTION、validateFinancialReportExtraction | 20_P1_FINANCIAL_REPORTS.js | 檢查項與標記值遺漏 | 在 SSOT「P1 財報」中列「提取驗證條件與狀態枚舉」 |

### 2.5 配置與常數（不屬業務邏輯但影響行為）

| 項目 | SSOT 現狀 | 細節所在 | 遺漏風險 | 建議 |
|------|-----------|----------|----------|------|
| 模型與任務對應 | TASK_TO_EXECUTOR、getAuditor | 02_M0_CONFIG.js | 每個 Phase 的執行者/審查者型號遺漏 | SSOT 已有「模型配置表」；建議確保與 02_M0_CONFIG 對齊並列「任務 ID 與檔案對照」 |
| CSE / 白名單 ID | 財報狗、buffet code、P5_INSTITUTIONAL_RATINGS 等 | 各 Phase 的 CSE 常數 | 改寫時用錯 CSE 或漏白名單 | 在 SSOT 或附錄列「CSE / 白名單 ID 與用途」 |
| P6 觸發間隔 | 20 分鐘、5 分鐘（選擇權）、清除每日午夜 | 26_TRIGGER_SETUP | 間隔與函數名對應遺漏 | 在 SSOT「P6」中列「觸發器配置一覽」 |

---

## 三、建議的 SSOT 補強方式

1. **集中附錄**：新增「**實作細節對照**」或「**遷移必查清單**」附錄，列出：
   - 各 Phase 對外輸出表**最小欄位清單**（或引用 01_SHEETS_STRUCTURE / DB schema 文檔）
   - **關鍵閾值與公式**（P4、P6、P3 RS、拋物線清倉等）一表
   - **M0 Payload 鍵名與 task_prompt 來源**一表
   - **觸發條件**（審查觸發、P6 清除鎖、Batch 失敗處理）一表
2. **章節內補段**：在現有「P4」「P6」「M0」「P5 Daily」「學習系統」等章節中，各加一小段「**關鍵實作要點**」或「**遷移時必對照**」，列出上述缺口對應的檔案名與函數名/常數名。
3. **與工程備忘錄分工**：SSOT 保留「架構與原則」；具體 DB schema、API 清單、測試與告警實作仍寫工程備忘錄；但在 SSOT 中**明確寫**「細節見《GAS 妥協清算與 Python 重建工程備忘錄》第 X 節 / 某清單」，避免改寫時只翻 SSOT 而漏翻備忘錄。

---

## 四、小結

- **除 Prompt 外**，SSOT 與舊程式碼之間存在多處**細節缺口**：表結構與欄位、公式與閾值、狀態機與觸發條件、錯誤處理與 Fallback、配置與常數。
- 建議在 SSOT 中**補強或集中標註**（附錄、章節內「關鍵實作要點」、對工程備忘錄的引用），並與**最新設計對齊**（含 P6 清除鎖、Daily D3/D4、Layer 1/2/3、衍生品監控清單等），以降低改寫時的遺漏風險。
