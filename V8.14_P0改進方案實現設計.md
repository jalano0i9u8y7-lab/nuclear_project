# V8.14 P0 æ”¹é€²æ–¹æ¡ˆå¯¦ç¾è¨­è¨ˆ

**æ—¥æœŸ**ï¼š2026-01-19  
**ç‰ˆæœ¬**ï¼šV8.14  
**ç‹€æ…‹**ï¼šğŸ“‹ **è¨­è¨ˆå®Œæˆï¼ˆå¾…å®šæ¡ˆï¼‰**

---

## ğŸ“‹ è¨­è¨ˆæ¦‚è¿°

### **è¨­è¨ˆç”¨æ„**
> å› ç‚ºæˆ‘å€‘ç³»çµ±æ˜¯å–®ç·šå¼è¨­è¨ˆï¼Œæ‰€ä»¥æºé ­å¦‚æœä¸ç²¾æº–æˆ–æœ‰éŒ¯èª¤ï¼Œå¾Œé¢æ¯å€‹éšæ®µéƒ½æœƒå¹¾ä½•æŒ‡æ•¸æ”¾å¤§ã€‚æ‰€ä»¥æ‰åˆåšäº†ä¸€å€‹é˜²å‘†çš„æ©Ÿåˆ¶ã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼šç¢ºä¿ P0 åˆ†æåŸºæ–¼æœ€æ–°ã€æœ€æº–ç¢ºçš„è³‡æ–™ï¼Œé¿å…æºé ­éŒ¯èª¤å°è‡´å¾ŒçºŒéšæ®µå¹¾ä½•æŒ‡æ•¸æ”¾å¤§ã€‚

---

## ğŸ—‚ï¸ è³‡æ–™çµæ§‹è¨­è¨ˆ

### **æ“´å…… `P0__SNAPSHOT` è¡¨æ ¼**

**ç•¶å‰ Schema**ï¼ˆ`src/01_SHEETS_STRUCTURE.js`ï¼‰ï¼š
```javascript
const P0_SNAPSHOT_SCHEMA = {
  sheetName: "P0__SNAPSHOT",
  headers: [
    "snapshot_id",
    "created_at",
    "trigger",
    "p0_output_json",
    "institutional_data_json",
    "changes_json",
    "version"
  ]
};
```

**æ“´å……å¾Œ Schema**ï¼ˆV8.14ï¼‰ï¼š
```javascript
const P0_SNAPSHOT_SCHEMA = {
  sheetName: "P0__SNAPSHOT",
  headers: [
    "snapshot_id",
    "created_at",
    "trigger",
    "p0_output_json",
    "institutional_data_json",
    "changes_json",
    "version",
    // â­ V8.14 æ–°å¢ï¼šæ™‚æ•ˆæ€§é˜²å‘†æ©Ÿåˆ¶
    "initial_analysis_json",  // OPUS ç¬¬ä¸€æ¬¡å®Œæ•´åˆ†æçµæœï¼ˆJSONï¼‰
    "validation_questions_json",  // é—œéµé©—è­‰å•é¡Œåˆ—è¡¨ï¼ˆJSONï¼‰
    "validation_status",  // PENDING / IN_PROGRESS / COMPLETED / SKIPPED
    "gemini_validation_results_json",  // Gemini æå–çš„é©—è­‰çµæœï¼ˆJSONï¼‰
    "final_analysis_json"  // OPUS é‡æ–°åˆ†æçµæœï¼ˆJSONï¼ŒåŒ…å«å½±éŸ¿æ¨™è¨»ï¼‰
  ]
};
```

### **è³‡æ–™æ ¼å¼å®šç¾©**

#### **`validation_questions_json` æ ¼å¼**
```json
[
  {
    "question_id": "Q001",
    "question_text": "å•é¡Œå…§å®¹",
    "data_source_url": "è³‡æ–™ä¾†æºç¶²å€ï¼ˆå¯é¸ï¼‰",
    "data_source_site": "è³‡æ–™ä¾†æºç¶²ç«™ï¼ˆå¯é¸ï¼‰",
    "data_source_keywords": "é—œéµå­—ï¼ˆå¯é¸ï¼‰",
    "expected_document_title": "é æœŸæ–‡ä»¶æ¨™é¡Œï¼ˆå¯é¸ï¼‰",
    "google_drive_folder_id": "Google Drive è³‡æ–™å¤¾ IDï¼ˆç”±ç³»çµ±å¡«å…¥ï¼‰",
    "status": "PENDING / PDF_UPLOADED / PROCESSING / COMPLETED / SKIPPED"
  }
]
```

#### **`gemini_validation_results_json` æ ¼å¼**
```json
[
  {
    "question_id": "Q001",
    "question_text": "å•é¡Œå…§å®¹",
    "google_drive_file_id": "Google Drive æª”æ¡ˆ ID",
    "gemini_file_uri": "Gemini File API URIï¼ˆè™•ç†å®Œæˆå¾Œåˆªé™¤ï¼‰",
    "passages": [
      {
        "page_number": 15,
        "content": "å®Œæ•´çš„åŸæ–‡æ®µè½ï¼ˆç›´æ¥å¾æ–‡ä»¶ä¸­è¤‡è£½ï¼Œæœªæ”¹å¯«ï¼‰",
        "context_before": "å‰æ–‡ï¼ˆå¦‚æœéœ€è¦ç†è§£è©²æ®µè½ï¼Œå¿…é ˆåŒ…å«çš„å‰æ–‡ï¼‰",
        "context_after": "å¾Œæ–‡ï¼ˆå¦‚æœéœ€è¦ç†è§£è©²æ®µè½ï¼Œå¿…é ˆåŒ…å«çš„å¾Œæ–‡ï¼‰"
      }
    ],
    "data_source": "è³‡æ–™ä¾†æºï¼ˆç¶²å€ã€ç¶²ç«™ã€é—œéµå­—ï¼‰",
    "processing_status": "COMPLETED / FAILED",
    "processed_at": "2026-01-19T12:00:00Z"
  }
]
```

**âš ï¸ æ³¨æ„**ï¼š
- `passages` æ˜¯ Gemini æ“·å–çš„**åŸæ–‡æ®µè½**ï¼Œä¸æ˜¯æ‘˜è¦æˆ–åˆ†æ
- æ¯å€‹æ®µè½åŒ…å« `content`ï¼ˆä¸»è¦å…§å®¹ï¼‰ã€`context_before`ï¼ˆå‰æ–‡ï¼‰ã€`context_after`ï¼ˆå¾Œæ–‡ï¼‰
- OPUS æœƒæ ¹æ“šé€™äº›åŸæ–‡æ®µè½ã€Œè‡ªå•è‡ªç­”ã€

#### **`final_analysis_json` æ ¼å¼**
```json
{
  "revised_analysis": {
    // OPUS é‡æ–°åˆ†æå¾Œçš„å®Œæ•´çµæœï¼ˆæ ¼å¼åŒç¬¬ä¸€æ¬¡åˆ†æï¼‰
    "themes": [ /* ... */ ],
    "subthemes": [ /* ... */ ],
    "confidence_level": 0.9
  },
  "validation_impact": [
    {
      "question_id": "Q001",
      "impact_type": "SUPPORT / NEUTRAL / CORRECTION",
      "impact_description": "å½±éŸ¿èªªæ˜ï¼ˆä¾‹å¦‚ï¼šé©—è­‰çµæœæ”¯æŒåŸåˆ†æï¼Œè‰¯ç‡æ•¸æ“šç¬¦åˆé æœŸï¼‰",
      "data_source": "è³‡æ–™ä¾†æº",
      "page_references": [15, 23, 45]
    }
  ],
  "final_judgment": "æœ€çµ‚åˆ¤æ±ºï¼šåŸºæ–¼ä½ å…§å»ºçš„æ·±å±¤é‚è¼¯ï¼Œçµåˆå›è¦†çš„ã€Œåˆæ ¼è­‰æ“šã€ï¼Œå®Œæ•´è©•ä¼°è©²ç”¢æ¥­çš„æ½›åŠ›æ˜¯å¦ç¬¦åˆè¦æ±‚ä¸¦çµ¦å‡ºæœ€çµ‚åˆ†æçµè«–ã€‚"
}
```

---

## ğŸ“ OPUS Prompt ä¿®æ”¹

### **ä¿®æ”¹ä½ç½®**
- æª”æ¡ˆï¼š`src/09_P0_INDUSTRY_ENGINEERING.js`
- å‡½æ•¸ï¼š`buildP0Prompt(userInput, context)`
- ä¿®æ”¹æ–¹å¼ï¼šåœ¨ prompt **æœ€å¾Œ**åŠ ä¸Šã€Œæ™‚æ•ˆæ€§é˜²å‘†ã€æ®µè½

### **æ–°å¢å…§å®¹**

**æ¸¬è©¦æ¨¡å¼å’Œæ­£å¼æ¨¡å¼éƒ½éœ€è¦åŠ ä¸Š**ï¼š

```
---

## â­ æ¨¡å‹å…§å»ºçŸ¥è­˜æ™‚æ•ˆæ€§é˜²å‘†

è«‹åˆ†æä½ ç¯©é¸å‡ºçš„æ½›åŠ›ç”¢æ¥­ã€‚é‡å°æ¯ä¸€å€‹ç”¢æ¥­ï¼Œèª å¯¦åœ°åˆ—å‡ºä½ ã€Œå› ç‚ºè¨“ç·´æ•¸æ“šæˆªæ­¢è€Œç„¡æ³•ç¢ºå®šçš„ 2025-2026 æœ€æ–°å‹•æ…‹ã€ï¼ˆä¾‹å¦‚ï¼šå…·é«”çš„è‰¯ç‡æ•¸æ“šã€æœ€æ–°é€šéé©—è­‰çš„ä¾›æ‡‰å•†åå–®ã€å‰›ç™¼å¸ƒçš„æ³•è¦ç´°ç¯€ï¼‰ã€‚

ä¸¦é‡å°ä¸Šè¿°ç›²é»ï¼Œæå‡ºã€Œç”±æ–¼ä½ å…§å»ºçŸ¥è­˜æ™‚æ•ˆæˆ–å»£åº¦ä¸è¶³è€Œå¿…é ˆæŸ¥æ ¸çš„é—œéµå•é¡Œã€ã€‚

**è¦æ±‚**ï¼š
- é€™äº›å•é¡Œå¿…é ˆæ˜¯èƒ½é€éæŸ¥è©¢ã€Œå­¸è¡“è«–æ–‡ã€ã€ã€Œé ‚ç´šæŠ•è¡Œç ”å ± (IB Reports)ã€æˆ–ã€Œç”¢æ¥­æ™ºåº«ç™½çš®æ›¸ã€ä¾†å›ç­”çš„ç¡¬æ•¸æ“š
- ä½ å¿…é ˆä¸»å‹•æä¾›æ¯å€‹å•é¡Œçš„ç¡¬æ•¸æ“šå ±å‘Šæ‡‰è©²è¦å»å“ªè£¡ä¸‹è¼‰æˆ–æœå°‹ï¼ˆçµ¦ç¶²å€ã€ç¶²ç«™ã€æˆ–æ˜¯é—œéµå­—èˆ‡æº–ç¢ºç™½åå–®ï¼‰
- è³‡æ–™ä¾†æºå¿…é ˆèƒ½å¤ æº–ç¢ºä¸‹è¼‰åˆ°èƒ½è§£æ±ºä½ çš„æå•çš„æ–‡ä»¶æª”æ¡ˆ
- Gemini æœƒæŒ‰ç…§ä½ æä¾›çš„è³‡æ–™ä¾†æºåˆ†ææ–‡ä»¶å…§å®¹ï¼Œä¸¦æ“·å–ç›¸é—œçš„ä¸Šä¸‹æ–‡çµ¦ä½ çœ‹ï¼Œè®“ä½ è‡ªå·±è§£æ±ºè‡ªå·±çš„æå•

**å¯©æŸ¥æ¨™æº–**ï¼š
- **ä¾†æºæ¬Šå¨æ€§**ï¼šè³‡æ–™æ˜¯å¦ä¾†è‡ª Tier 1 æ©Ÿæ§‹ï¼ˆå¦‚ Goldman, McKinsey, IEEE, Nature, æ”¿åºœå–®ä½ï¼‰ï¼Ÿé‡é›å ±å‘Šä¸€å¾‹ä¸æ¡ä¿¡
- **æ™‚æ•ˆæ€§**ï¼šè³‡æ–™æ˜¯å¦ç‚ºè¿‘ 12 å€‹æœˆå…§ç™¼å¸ƒï¼Ÿéæ™‚è³‡æ–™ä¸æ¡ä¿¡
- **å¼•ç”¨ç²¾ç¢ºåº¦**ï¼šå›ç­”ä¸­æ˜¯å¦æä¾›äº†å…·é«”çš„é æ•¸ (Page Number) èˆ‡åŸæ–‡å¼•è¿°ï¼Ÿè‹¥å«ç³Šå…¶è¾­ï¼Œè¦–ç‚ºå¹»è¦º

**æœ€çµ‚åˆ¤æ±º**ï¼š
åŸºæ–¼ä½ å…§å»ºçš„æ·±å±¤é‚è¼¯ï¼Œçµåˆå›è¦†çš„ã€Œåˆæ ¼è­‰æ“šã€ï¼Œå®Œæ•´è©•ä¼°è©²ç”¢æ¥­çš„æ½›åŠ›æ˜¯å¦ç¬¦åˆè¦æ±‚ä¸¦çµ¦å‡ºæœ€çµ‚åˆ†æçµè«–ã€‚è‹¥è­‰æ“šé¡¯ç¤ºå¸‚å ´éç†±æˆ–æŠ€è¡“å¡é—œï¼Œè«‹æœæ–·å¦æ±ºã€‚

**è¼¸å‡ºæ ¼å¼**ï¼ˆåœ¨åŸæœ‰ JSON æ ¼å¼ä¸­æ–°å¢ `validation_questions` æ¬„ä½ï¼‰ï¼š
{
  "themes": [
    {
      // ... åŸæœ‰æ¬„ä½ ...
      "validation_questions": [
        {
          "question_id": "Q001",
          "question_text": "å•é¡Œå…§å®¹",
          "data_source_url": "è³‡æ–™ä¾†æºç¶²å€ï¼ˆå¯é¸ï¼‰",
          "data_source_site": "è³‡æ–™ä¾†æºç¶²ç«™ï¼ˆå¯é¸ï¼‰",
          "data_source_keywords": "é—œéµå­—ï¼ˆå¯é¸ï¼‰",
          "expected_document_title": "é æœŸæ–‡ä»¶æ¨™é¡Œï¼ˆå¯é¸ï¼‰"
        }
      ]
    }
  ],
  "subthemes": [
    {
      // ... åŸæœ‰æ¬„ä½ ...
      "validation_questions": [ /* æ ¼å¼åŒ themes */ ]
    }
  ]
}
```

---

## ğŸ”§ Gemini File API å¯¦ä½œ

### **å‡½æ•¸ 1ï¼š`uploadFileToGemini(driveFileId)`**

**åŠŸèƒ½**ï¼šå°‡ Google Drive ä¸­çš„ PDF ä¸Šå‚³åˆ° Gemini File API

**å¯¦ä½œè¦é»**ï¼š
1. ä½¿ç”¨ `multipart/related` æ‰‹å‹•çµ„è£ Payloadï¼ˆä¸ä½¿ç”¨ GAS è‡ªå‹•å°è£ï¼‰
2. API Key æ”¾åœ¨ Header (`x-goog-api-key`)
3. è¿”å› `file_uri` ä¾›å¾ŒçºŒä½¿ç”¨

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * ä¸Šå‚³ Google Drive æª”æ¡ˆåˆ° Gemini File API
 * @param {string} driveFileId - Google Drive æª”æ¡ˆ ID
 * @return {string} fileUri - Gemini File API è¿”å›çš„ URI
 */
function uploadFileToGemini(driveFileId) {
  const apiKey = getAPIKey("GOOGLE");
  const file = DriveApp.getFileById(driveFileId);
  const blob = file.getBlob();
  const fileName = file.getName();
  
  // æ‰‹å‹•çµ„è£ multipart/related Payload
  const boundary = "----WebKitFormBoundary" + Utilities.getUuid();
  const metadata = JSON.stringify({ file: { display_name: fileName } });
  
  // çµ„è£ multipart/related body
  let body = "";
  body += `--${boundary}\r\n`;
  body += `Content-Type: application/json\r\n\r\n`;
  body += `${metadata}\r\n`;
  body += `--${boundary}\r\n`;
  body += `Content-Type: application/pdf\r\n\r\n`;
  body += Utilities.newBlob(blob.getBytes()).getDataAsString();
  body += `\r\n--${boundary}--\r\n`;
  
  // ä¸Šå‚³åˆ° Gemini
  const uploadUrl = "https://generativelanguage.googleapis.com/upload/v1beta/files";
  const response = UrlFetchApp.fetch(uploadUrl, {
    method: "POST",
    headers: {
      "x-goog-api-key": apiKey,
      "Content-Type": `multipart/related; boundary=${boundary}`
    },
    payload: body,
    muteHttpExceptions: true
  });
  
  if (response.getResponseCode() !== 200) {
    throw new Error(`Gemini File API ä¸Šå‚³å¤±æ•—ï¼š${response.getContentText()}`);
  }
  
  const result = JSON.parse(response.getContentText());
  return result.file.uri;
}
```

### **å‡½æ•¸ 2ï¼š`extractContextFromGeminiFile(fileUri, questions)`**

**åŠŸèƒ½**ï¼šä½¿ç”¨ Gemini Flash 3.0 å¾ PDF ä¸­æå–ç›¸é—œåŸæ–‡æ®µè½

**å¯¦ä½œè¦é»**ï¼š
1. ä½¿ç”¨ Gemini Flash 3.0 (`gemini-3-flash-preview`)
2. **Gemini åªè² è²¬é–±è®€ PDF ä¸¦æ“·å–ç›¸é—œåŸæ–‡æ®µè½ï¼Œä¸å›ç­”å•é¡Œã€ä¸æä¾›æ‘˜è¦**
3. å¿…é ˆåŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡ï¼Œä¸èƒ½å¿½ç•¥æœƒå½±éŸ¿åˆ¤æ–·çš„æ®µè½
4. å¯èƒ½æ¥å—å¤šæ®µè½
5. å¿…é ˆåŒ…å«é æ•¸

**âš ï¸ é‡è¦**ï¼šGemini çš„è§’è‰²æ˜¯ã€Œæ–‡ä»¶é–±è®€å™¨ã€ï¼Œåªè² è²¬æ“·å–åŸæ–‡æ®µè½ã€‚OPUS æœƒæ ¹æ“šé€™äº›åŸæ–‡æ®µè½ã€Œè‡ªå•è‡ªç­”ã€ã€‚

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * å¾ Gemini File ä¸­æå–é©—è­‰å•é¡Œçš„ç›¸é—œåŸæ–‡æ®µè½
 * @param {string} fileUri - Gemini File API URI
 * @param {Array} questions - é©—è­‰å•é¡Œåˆ—è¡¨
 * @return {Array} æå–çš„åŸæ–‡æ®µè½çµæœ
 */
function extractContextFromGeminiFile(fileUri, questions) {
  const apiKey = getAPIKey("GOOGLE");
  const model = "gemini-3-flash-preview";
  
  const prompt = `ä½ æ˜¯ä¸€å€‹æ–‡ä»¶é–±è®€å™¨ï¼Œè² è²¬å¾ PDF æ–‡ä»¶ä¸­æ“·å–èˆ‡ç‰¹å®šå•é¡Œç›¸é—œçš„åŸæ–‡æ®µè½ã€‚

**ä½ çš„ä»»å‹™**ï¼š
1. é–±è®€é€™ä»½ PDF æ–‡ä»¶
2. é‡å°ä»¥ä¸‹æ¯å€‹å•é¡Œï¼Œæ‰¾å‡ºæ–‡ä»¶ä¸­èˆ‡è©²å•é¡Œç›¸é—œçš„åŸæ–‡æ®µè½
3. **åªæ“·å–åŸæ–‡æ®µè½ï¼Œä¸è¦å›ç­”å•é¡Œï¼Œä¸è¦æä¾›æ‘˜è¦ï¼Œä¸è¦é€²è¡Œä»»ä½•åˆ†ææˆ–è§£é‡‹**

**å•é¡Œåˆ—è¡¨**ï¼š
${questions.map((q, i) => `${i + 1}. [${q.question_id}] ${q.question_text}`).join('\n')}

**æ“·å–è¦å‰‡**ï¼š
1. **åªæ“·å–åŸæ–‡æ®µè½**ï¼šç›´æ¥è¤‡è£½æ–‡ä»¶ä¸­èˆ‡å•é¡Œç›¸é—œçš„æ–‡å­—ï¼Œä¸è¦æ”¹å¯«ã€ä¸è¦ç¸½çµ
2. **åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡**ï¼šå¦‚æœæŸå€‹æ®µè½æ˜¯ç­”æ¡ˆçš„é—œéµï¼Œä½†éœ€è¦å‰å¾Œæ–‡æ‰èƒ½ç†è§£ï¼Œå¿…é ˆä¸€ä½µæ“·å–å‰å¾Œæ–‡ï¼Œä¸èƒ½å¿½ç•¥æœƒå½±éŸ¿åˆ¤æ–·çš„æ®µè½
3. **å¯èƒ½å¤šæ®µè½**ï¼šä¸€å€‹å•é¡Œå¯èƒ½å°æ‡‰å¤šå€‹æ®µè½ï¼Œå…¨éƒ¨éƒ½è¦æ“·å–
4. **æ¨™è¨»é æ•¸**ï¼šæ¯å€‹æ®µè½å¿…é ˆæ¨™è¨»å…¶æ‰€åœ¨çš„é æ•¸ï¼ˆPage Numberï¼‰
5. **ä¿æŒåŸæ–‡é †åº**ï¼šå¦‚æœæœ‰å¤šå€‹æ®µè½ï¼ŒæŒ‰ç…§åœ¨æ–‡ä»¶ä¸­å‡ºç¾çš„é †åºæ’åˆ—

**è¼¸å‡ºæ ¼å¼ï¼ˆJSONï¼‰**ï¼š
{
  "extracted_passages": [
    {
      "question_id": "Q001",
      "question_text": "å•é¡Œå…§å®¹",
      "passages": [
        {
          "page_number": 15,
          "content": "å®Œæ•´çš„åŸæ–‡æ®µè½ï¼ˆåŒ…å«å¿…è¦çš„ä¸Šä¸‹æ–‡ï¼‰ï¼Œç›´æ¥å¾æ–‡ä»¶ä¸­è¤‡è£½ï¼Œä¸è¦æ”¹å¯«",
          "context_before": "å‰æ–‡ï¼ˆå¦‚æœéœ€è¦ç†è§£è©²æ®µè½ï¼Œå¿…é ˆåŒ…å«çš„å‰æ–‡ï¼‰",
          "context_after": "å¾Œæ–‡ï¼ˆå¦‚æœéœ€è¦ç†è§£è©²æ®µè½ï¼Œå¿…é ˆåŒ…å«çš„å¾Œæ–‡ï¼‰"
        },
        {
          "page_number": 23,
          "content": "å¦ä¸€å€‹ç›¸é—œçš„åŸæ–‡æ®µè½",
          "context_before": "å‰æ–‡",
          "context_after": "å¾Œæ–‡"
        }
      ]
    }
  ]
}

**æ³¨æ„**ï¼š
- ä¸è¦è©¦åœ–å›ç­”å•é¡Œæˆ–æä¾›æ‘˜è¦
- ä¸è¦é€²è¡Œä»»ä½•åˆ†æã€è§£é‡‹æˆ–æ¨ç†
- åªè² è²¬æ‰¾åˆ°ä¸¦è¤‡è£½ç›¸é—œçš„åŸæ–‡æ®µè½
- ç¢ºä¿åŒ…å«è¶³å¤ çš„ä¸Šä¸‹æ–‡ï¼Œè®“è®€è€…èƒ½å¤ ç†è§£é€™äº›æ®µè½çš„å®Œæ•´å«ç¾©
`;
  
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
  
  const requestBody = {
    contents: [{
      parts: [
        { text: prompt },
        { file_data: { mime_type: "application/pdf", file_uri: fileUri } }
      ]
    }]
  };
  
  const response = UrlFetchApp.fetch(apiUrl, {
    method: "POST",
    headers: {
      "x-goog-api-key": apiKey,
      "Content-Type": "application/json"
    },
    payload: JSON.stringify(requestBody),
    muteHttpExceptions: true
  });
  
  if (response.getResponseCode() !== 200) {
    throw new Error(`Gemini æå–å¤±æ•—ï¼š${response.getContentText()}`);
  }
  
  const result = JSON.parse(response.getContentText());
  const content = result.candidates[0].content.parts[0].text;
  
  // è§£æ JSONï¼ˆå¯èƒ½éœ€è¦è™•ç† markdown ä»£ç¢¼å¡Šï¼‰
  let jsonMatch = content.match(/\{[\s\S]*\}/);
  if (jsonMatch) {
    return JSON.parse(jsonMatch[0]);
  }
  
  throw new Error("ç„¡æ³•è§£æ Gemini è¼¸å‡º");
}
```

### **å‡½æ•¸ 3ï¼š`deleteGeminiFile(fileUri)`**

**åŠŸèƒ½**ï¼šæ‰‹å‹•åˆªé™¤ Gemini File API ä¸­çš„æª”æ¡ˆï¼ˆé‡‹æ”¾é…é¡ï¼‰

**å¯¦ä½œè¦é»**ï¼š
1. å¾ `file_uri` ä¸­æå– `file_id`
2. èª¿ç”¨ DELETE API
3. éŒ¯èª¤è™•ç†ï¼ˆè¨˜éŒ„ä½†ä¸ä¸­æ–·æµç¨‹ï¼‰

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * åˆªé™¤ Gemini File API ä¸­çš„æª”æ¡ˆ
 * @param {string} fileUri - Gemini File API URI
 */
function deleteGeminiFile(fileUri) {
  try {
    const apiKey = getAPIKey("GOOGLE");
    // å¾ URI æå– file IDï¼ˆæ ¼å¼ï¼šhttps://generativelanguage.googleapis.com/v1beta/files/{file_id}ï¼‰
    const fileId = fileUri.split('/').pop();
    
    const deleteUrl = `https://generativelanguage.googleapis.com/v1beta/files/${fileId}`;
    
    const response = UrlFetchApp.fetch(deleteUrl, {
      method: "DELETE",
      headers: {
        "x-goog-api-key": apiKey
      },
      muteHttpExceptions: true
    });
    
    if (response.getResponseCode() !== 200) {
      Logger.log(`âš ï¸ Gemini æª”æ¡ˆåˆªé™¤å¤±æ•—ï¼š${response.getContentText()}`);
    } else {
      Logger.log(`âœ… Gemini æª”æ¡ˆå·²åˆªé™¤ï¼š${fileId}`);
    }
  } catch (error) {
    Logger.log(`âš ï¸ Gemini æª”æ¡ˆåˆªé™¤ç•°å¸¸ï¼š${error.message}`);
  }
}
```

---

## ğŸ”„ æµç¨‹æ•´åˆ

### **ä¿®æ”¹ 1ï¼š`P0_ProcessM0Result()`**

**æ–°å¢é‚è¼¯**ï¼ˆåœ¨ç¾æœ‰é‚è¼¯ä¹‹å¾Œï¼‰ï¼š
```javascript
// â­ V8.14 æ–°å¢ï¼šä¿å­˜ OPUS ç¬¬ä¸€æ¬¡åˆ†æçµæœå’Œé©—è­‰å•é¡Œ
const executorOutput = m0Result.executor_output || {};
const validationQuestions = extractValidationQuestions(executorOutput);

if (validationQuestions && validationQuestions.length > 0) {
  // æœ‰é©—è­‰å•é¡Œï¼Œä¿å­˜åˆ°å¿«ç…§ä¸¦ç­‰å¾…äººå·¥ä¸‹è¼‰ PDF
  saveP0InitialAnalysis(snapshotId, executorOutput, validationQuestions);
  Logger.log(`P0 V8.14ï¼šå·²ä¿å­˜ ${validationQuestions.length} å€‹é©—è­‰å•é¡Œï¼Œç­‰å¾…äººå·¥ä¸‹è¼‰ PDF`);
  
  // è¿”å›ç‹€æ…‹ï¼Œæç¤ºéœ€è¦äººå·¥ä¸‹è¼‰ PDF
  return {
    status: "REQUIRES_VALIDATION",
    snapshot_id: snapshotId,
    validation_questions: validationQuestions,
    message: "è«‹ä¸‹è¼‰ PDF ä¸¦æ”¾å…¥ Google Driveï¼Œç„¶å¾Œè§¸ç™¼é©—è­‰æµç¨‹"
  };
} else {
  // æ²’æœ‰é©—è­‰å•é¡Œï¼Œç›´æ¥é€²å…¥ GPT å¯©æŸ¥éšæ®µ
  Logger.log(`P0 V8.14ï¼šæ²’æœ‰é©—è­‰å•é¡Œï¼Œç›´æ¥é€²å…¥ GPT å¯©æŸ¥éšæ®µ`);
  // ç¹¼çºŒåŸæœ‰æµç¨‹...
}
```

### **æ–°å¢å‡½æ•¸ 2ï¼š`extractValidationQuestions(executorOutput)`**

**åŠŸèƒ½**ï¼šå¾ OPUS è¼¸å‡ºä¸­æå–é©—è­‰å•é¡Œ

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * å¾ OPUS è¼¸å‡ºä¸­æå–é©—è­‰å•é¡Œ
 * @param {Object} executorOutput - OPUS åŸ·è¡Œè€…è¼¸å‡º
 * @return {Array} é©—è­‰å•é¡Œåˆ—è¡¨
 */
function extractValidationQuestions(executorOutput) {
  const questions = [];
  
  // å¾ themes ä¸­æå–
  if (executorOutput.themes && Array.isArray(executorOutput.themes)) {
    executorOutput.themes.forEach((theme, themeIndex) => {
      if (theme.validation_questions && Array.isArray(theme.validation_questions)) {
        theme.validation_questions.forEach((q, qIndex) => {
          questions.push({
            question_id: `T${themeIndex + 1}_Q${qIndex + 1}`,
            theme_id: theme.theme_id || `THEME_${themeIndex + 1}`,
            question_text: q.question_text,
            data_source_url: q.data_source_url,
            data_source_site: q.data_source_site,
            data_source_keywords: q.data_source_keywords,
            expected_document_title: q.expected_document_title,
            status: "PENDING"
          });
        });
      }
    });
  }
  
  // å¾ subthemes ä¸­æå–ï¼ˆé¡ä¼¼é‚è¼¯ï¼‰
  // ...
  
  return questions;
}
```

### **æ–°å¢å‡½æ•¸ 3ï¼š`saveP0InitialAnalysis(snapshotId, executorOutput, validationQuestions)`**

**åŠŸèƒ½**ï¼šä¿å­˜ OPUS ç¬¬ä¸€æ¬¡åˆ†æçµæœåˆ° `P0__SNAPSHOT`

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * ä¿å­˜ OPUS ç¬¬ä¸€æ¬¡åˆ†æçµæœ
 * @param {string} snapshotId - å¿«ç…§ ID
 * @param {Object} executorOutput - OPUS åŸ·è¡Œè€…è¼¸å‡º
 * @param {Array} validationQuestions - é©—è­‰å•é¡Œåˆ—è¡¨
 */
function saveP0InitialAnalysis(snapshotId, executorOutput, validationQuestions) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("P0__SNAPSHOT");
  
  if (!sheet) {
    throw new Error("P0__SNAPSHOT è¡¨æ ¼ä¸å­˜åœ¨");
  }
  
  // æ‰¾åˆ°å°æ‡‰çš„å¿«ç…§è¡Œ
  const dataRange = sheet.getDataRange();
  const rows = dataRange.getValues();
  const headers = rows[0];
  const snapshotIdCol = headers.indexOf("snapshot_id");
  
  let targetRow = -1;
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][snapshotIdCol] === snapshotId) {
      targetRow = i + 1;  // 1-based
      break;
    }
  }
  
  if (targetRow === -1) {
    throw new Error(`æ‰¾ä¸åˆ°å¿«ç…§ï¼š${snapshotId}`);
  }
  
  // æ›´æ–°æ¬„ä½
  const initialAnalysisCol = headers.indexOf("initial_analysis_json");
  const validationQuestionsCol = headers.indexOf("validation_questions_json");
  const validationStatusCol = headers.indexOf("validation_status");
  
  if (initialAnalysisCol !== -1) {
    sheet.getRange(targetRow, initialAnalysisCol + 1).setValue(JSON.stringify(executorOutput));
  }
  if (validationQuestionsCol !== -1) {
    sheet.getRange(targetRow, validationQuestionsCol + 1).setValue(JSON.stringify(validationQuestions));
  }
  if (validationStatusCol !== -1) {
    sheet.getRange(targetRow, validationStatusCol + 1).setValue("PENDING");
  }
  
  Logger.log(`P0 V8.14ï¼šå·²ä¿å­˜ç¬¬ä¸€æ¬¡åˆ†æçµæœå’Œ ${validationQuestions.length} å€‹é©—è­‰å•é¡Œ`);
}
```

### **æ–°å¢å‡½æ•¸ 4ï¼š`P0_TriggerGeminiValidation(jobId, googleDriveFolderId)`**

**åŠŸèƒ½**ï¼šè§¸ç™¼ Gemini Flash é©—è­‰æµç¨‹ï¼ˆç”± UI æ‰‹å‹•è§¸ç™¼ï¼‰

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * è§¸ç™¼ Gemini Flash é©—è­‰æµç¨‹
 * @param {string} jobId - P0 Job ID
 * @param {string} googleDriveFolderId - Google Drive è³‡æ–™å¤¾ ID
 * @return {Object} è™•ç†çµæœ
 */
function P0_TriggerGeminiValidation(jobId, googleDriveFolderId) {
  try {
    Logger.log(`P0 V8.14ï¼šé–‹å§‹é©—è­‰æµç¨‹ï¼ŒjobId=${jobId}, folderId=${googleDriveFolderId}`);
    
    // 1. è®€å–å¿«ç…§å’Œé©—è­‰å•é¡Œ
    const snapshot = getP0SnapshotByJobId(jobId);
    if (!snapshot) {
      throw new Error(`æ‰¾ä¸åˆ°å¿«ç…§ï¼šjobId=${jobId}`);
    }
    
    const validationQuestions = JSON.parse(snapshot.validation_questions_json || "[]");
    if (validationQuestions.length === 0) {
      Logger.log(`P0 V8.14ï¼šæ²’æœ‰é©—è­‰å•é¡Œï¼Œè·³éé©—è­‰æµç¨‹`);
      return { status: "SKIPPED", message: "æ²’æœ‰é©—è­‰å•é¡Œ" };
    }
    
    // 2. æƒæ Google Drive è³‡æ–™å¤¾ä¸­çš„ PDF
    const folder = DriveApp.getFolderById(googleDriveFolderId);
    const pdfFiles = folder.getFilesByType(MimeType.PDF);
    
    const validationResults = [];
    
    // 3. å°æ¯å€‹ PDF é€²è¡Œè™•ç†
    while (pdfFiles.hasNext()) {
      const pdfFile = pdfFiles.next();
      const pdfFileId = pdfFile.getId();
      const pdfFileName = pdfFile.getName();
      
      Logger.log(`P0 V8.14ï¼šè™•ç† PDFï¼š${pdfFileName}`);
      
      try {
        // 3.1 ä¸Šå‚³åˆ° Gemini
        const fileUri = uploadFileToGemini(pdfFileId);
        Logger.log(`P0 V8.14ï¼šPDF å·²ä¸Šå‚³åˆ° Geminiï¼š${fileUri}`);
        
        // 3.2 æå–ç›¸é—œä¸Šä¸‹æ–‡
        const extractedContext = extractContextFromGeminiFile(fileUri, validationQuestions);
        
        // 3.3 è¨˜éŒ„çµæœ
        // âš ï¸ æ³¨æ„ï¼šextractedContext.extracted_passages æ˜¯ Gemini æ“·å–çš„åŸæ–‡æ®µè½
        if (extractedContext.extracted_passages && Array.isArray(extractedContext.extracted_passages)) {
          extractedContext.extracted_passages.forEach(passage => {
            validationResults.push({
              question_id: passage.question_id,
              question_text: passage.question_text,
              google_drive_file_id: pdfFileId,
              gemini_file_uri: fileUri,
              passages: passage.passages || [],  // åŸæ–‡æ®µè½åˆ—è¡¨ï¼ˆåŒ…å«é æ•¸ã€å…§å®¹ã€å‰å¾Œæ–‡ï¼‰
              data_source: `${pdfFileName} (${googleDriveFolderId})`,
              processing_status: "COMPLETED",
              processed_at: new Date().toISOString()
            });
          });
        }
        
        // 3.4 åˆªé™¤ Gemini æª”æ¡ˆï¼ˆé‡‹æ”¾é…é¡ï¼‰
        deleteGeminiFile(fileUri);
        
      } catch (error) {
        Logger.log(`P0 V8.14ï¼šè™•ç† PDF å¤±æ•—ï¼ˆ${pdfFileName}ï¼‰ï¼š${error.message}`);
        // ç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹ PDF
      }
    }
    
    // 4. æ›´æ–°å¿«ç…§
    updateP0ValidationResults(snapshot.snapshot_id, validationResults);
    
    // 5. è§¸ç™¼ OPUS é‡æ–°åˆ†æ
    triggerP0Reanalysis(snapshot.snapshot_id);
    
    return {
      status: "COMPLETED",
      processed_files: validationResults.length,
      message: "é©—è­‰æµç¨‹å®Œæˆï¼Œå·²è§¸ç™¼ OPUS é‡æ–°åˆ†æ"
    };
    
  } catch (error) {
    Logger.log(`P0 V8.14ï¼šé©—è­‰æµç¨‹å¤±æ•—ï¼š${error.message}`);
    throw error;
  }
}
```

### **æ–°å¢å‡½æ•¸ 5ï¼š`triggerP0Reanalysis(snapshotId)`**

**åŠŸèƒ½**ï¼šè§¸ç™¼ OPUS é‡æ–°åˆ†æ

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * è§¸ç™¼ OPUS é‡æ–°åˆ†æ
 * @param {string} snapshotId - å¿«ç…§ ID
 */
function triggerP0Reanalysis(snapshotId) {
  try {
    // 1. è®€å–å¿«ç…§
    const snapshot = getP0Snapshot(snapshotId);
    const initialAnalysis = JSON.parse(snapshot.initial_analysis_json);
    const validationResults = JSON.parse(snapshot.gemini_validation_results_json || "[]");
    
    // 2. æ§‹å»ºé‡æ–°åˆ†æçš„ Prompt
    const reanalysisPrompt = buildP0ReanalysisPrompt(initialAnalysis, validationResults);
    
    // 3. æäº¤åˆ° M0 Job Queue
    const m0InputPayload = {
      phase: "P0",
      trigger: "VALIDATION_COMPLETED",
      snapshot_id: snapshotId,
      initial_analysis: initialAnalysis,
      validation_results: validationResults,
      p0_reanalysis_prompt: reanalysisPrompt
    };
    
    const requestedFlow = [
      "EXECUTOR",  // OPUS é‡æ–°åˆ†æ
      "AUDITOR"    // GPT å¯©æŸ¥
    ];
    
    const jobId = submitToM0JobQueue("P0", requestedFlow, m0InputPayload);
    Logger.log(`P0 V8.14ï¼šå·²æäº¤é‡æ–°åˆ†æä»»å‹™ï¼ŒjobId=${jobId}`);
    
    return jobId;
    
  } catch (error) {
    Logger.log(`P0 V8.14ï¼šè§¸ç™¼é‡æ–°åˆ†æå¤±æ•—ï¼š${error.message}`);
    throw error;
  }
}
```

### **æ–°å¢å‡½æ•¸ 6ï¼š`buildP0ReanalysisPrompt(initialAnalysis, validationResults)`**

**åŠŸèƒ½**ï¼šæ§‹å»º OPUS é‡æ–°åˆ†æçš„ Prompt

**âš ï¸ é‡è¦**ï¼šé€™å€‹ Prompt å¿…é ˆåš´æ ¼é™åˆ¶ OPUS çš„è¡Œç‚ºï¼Œé¿å… OPUS é‡æ–°åšä¸€æ¬¡å¾é ­çš„ç”¢æ¥­åˆ†æã€‚OPUS é€™æ¬¡çš„ä»»å‹™æ˜¯ã€Œé©—è­‰ã€è€Œéã€Œé‡æ–°åˆ†æã€ã€‚

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * æ§‹å»º OPUS é‡æ–°åˆ†æçš„ Promptï¼ˆåš´æ ¼é™åˆ¶ç‰ˆæœ¬ï¼‰
 * @param {Object} initialAnalysis - OPUS ç¬¬ä¸€æ¬¡åˆ†æçµæœ
 * @param {Array} validationResults - Gemini é©—è­‰çµæœï¼ˆåŸæ–‡æ®µè½ï¼‰
 * @return {string} Prompt å…§å®¹
 */
function buildP0ReanalysisPrompt(initialAnalysis, validationResults) {
  const validationResultsText = validationResults.map(result => {
    const passages = result.passages || [];
    return `
**å•é¡Œ ${result.question_id}**ï¼š${result.question_text}
- **è³‡æ–™ä¾†æº**ï¼š${result.data_source}
- **ç›¸é—œåŸæ–‡æ®µè½**ï¼ˆå¾æ–‡ä»¶ä¸­æ“·å–çš„å®Œæ•´æ®µè½ï¼‰ï¼š
${passages.map(p => `
  **ç¬¬ ${p.page_number} é **ï¼š
  ${p.context_before ? `[å‰æ–‡] ${p.context_before}\n` : ''}
  ${p.content}
  ${p.context_after ? `\n[å¾Œæ–‡] ${p.context_after}` : ''}
`).join('\n\n')}
`;
  }).join('\n\n');
  
  return `
## âš ï¸ é‡è¦ï¼šé€™ä¸æ˜¯é‡æ–°åˆ†æä»»å‹™

**ä½ çš„è§’è‰²**ï¼šä½ æ˜¯ä¸€å€‹ã€Œé©—è­‰è€…ã€ï¼Œä¸æ˜¯ã€Œåˆ†æè€…ã€ã€‚

**ä½ çš„ä»»å‹™**ï¼šé‡å°ä½ ç¬¬ä¸€æ¬¡åˆ†æä¸­å› å…§å»ºçŸ¥è­˜æ™‚æ•ˆæ€§ä¸è¶³ä½†çµ•å°éœ€è¦é©—è­‰çš„é—œéµå•é¡Œï¼Œä½¿ç”¨æœ€æ–°æ‰¾åˆ°çš„ç›¸é—œæ–‡ä»¶åŸæ–‡æ®µè½ï¼ŒåŠ å¼·é©—è­‰ä½ åŸåˆ†æè«–é»æ˜¯å¦æˆç«‹æˆ–æœ‰è®ŠåŒ–ã€‚

**âŒ ç¦æ­¢è¡Œç‚º**ï¼š
1. **ç¦æ­¢é‡æ–°åšç”¢æ¥­åˆ†æ**ï¼šä¸è¦å¾é ­åˆ†æç”¢æ¥­ã€ä¸è¦é‡æ–°ç¯©é¸ themes/subthemesã€ä¸è¦é‡æ–°è©•ä¼°ç”¢æ¥­çµæ§‹
2. **ç¦æ­¢å¤§å¹…åº¦æ¨ç¿»ç¬¬ä¸€æ¬¡åˆ†æ**ï¼šé™¤éæœ€æ–°è³‡æ–™é¡¯ç¤ºå·²ç¶“èˆ‡åŸä¾†çš„åˆ†ææ˜é¡¯èƒŒé›¢ï¼Œå¦å‰‡ä¸èƒ½å¤§å¹…åº¦æ¨ç¿»ç¬¬ä¸€æ¬¡åˆ†æçš„çµè«–
3. **ç¦æ­¢é‡æ–°å›ç­”æºé ­å•é¡Œ**ï¼šä¸è¦é‡æ–°å›ç­”ã€Œç”¢æ¥­æ˜¯å¦å¿…ç„¶å­˜åœ¨ã€ã€ã€Œçµæ§‹æ€§å®šåƒ¹æ¬Šä¾†æºã€ç­‰æºé ­å•é¡Œ

**âœ… å…è¨±è¡Œç‚º**ï¼š
1. **é©—è­‰ç‰¹å®šå•é¡Œ**ï¼šé‡å°ä½ æå‡ºçš„é©—è­‰å•é¡Œï¼Œæ ¹æ“šæœ€æ–°æ–‡ä»¶çš„åŸæ–‡æ®µè½ï¼Œè‡ªå•è‡ªç­”
2. **å¾®èª¿è«–é»**ï¼šå¦‚æœæœ€æ–°è³‡æ–™èˆ‡åŸåˆ†ææœ‰ç´°å¾®å·®ç•°ï¼Œå¯ä»¥å¾®èª¿è«–é»
3. **åŠ å¼·è«–è­‰**ï¼šå¦‚æœæœ€æ–°è³‡æ–™æ”¯æŒåŸåˆ†æï¼Œå¯ä»¥åŠ å¼·è«–è­‰
4. **ä¿®æ­£æ˜é¡¯éŒ¯èª¤**ï¼šå¦‚æœæœ€æ–°è³‡æ–™æ˜é¡¯èƒŒé›¢åŸåˆ†æï¼Œå¯ä»¥ä¿®æ­£ç›¸é—œçµè«–

---

## ä½ çš„ç¬¬ä¸€æ¬¡åˆ†æï¼ˆåˆ†æ Aï¼‰

${JSON.stringify(initialAnalysis, null, 2)}

---

## æŸ¥è­‰çµæœï¼ˆè³‡æ–™ Bï¼‰

ä»¥ä¸‹æ˜¯æˆ‘å€‘å¾ä½ æŒ‡å®šçš„è³‡æ–™ä¾†æºä¸­æå–çš„**åŸæ–‡æ®µè½**ï¼ˆGemini åªè² è²¬é–±è®€å’Œæ“·å–ï¼Œä¸é€²è¡Œåˆ†æï¼‰ï¼š

${validationResultsText}

---

## ä½ çš„é©—è­‰ä»»å‹™

**æ­¥é©Ÿ 1ï¼šé–±è®€åŸæ–‡æ®µè½**
- ä»”ç´°é–±è®€ä¸Šè¿°æ¯å€‹å•é¡Œå°æ‡‰çš„åŸæ–‡æ®µè½
- ç†è§£é€™äº›æ®µè½çš„å®Œæ•´å«ç¾©ï¼ˆåŒ…å«å‰å¾Œæ–‡ï¼‰

**æ­¥é©Ÿ 2ï¼šè‡ªå•è‡ªç­”**
- é‡å°æ¯å€‹é©—è­‰å•é¡Œï¼Œæ ¹æ“šä½ è®€åˆ°çš„åŸæ–‡æ®µè½ï¼Œè‡ªå•è‡ªç­”
- æ¨™æ˜é€™äº›åŸæ–‡æ®µè½å°ä½ åŸåˆ†æçš„å½±éŸ¿ï¼ˆæ”¯æŒ/ä¸­ç«‹/ä¿®æ­£ï¼‰

**æ­¥é©Ÿ 3ï¼šè©•ä¼°å½±éŸ¿**
- è©•ä¼°æ–°è³‡æ–™å°ä½ åŸä¾†æ±ºç­–çš„å½±éŸ¿æ˜¯ã€Œæ”¯æŒã€ã€ã€Œä¸­ç«‹ã€é‚„æ˜¯ã€Œä¿®æ­£ã€ï¼Ÿ
- **é™¤éæœ€æ–°è³‡æ–™æ˜é¡¯èƒŒé›¢åŸåˆ†æï¼Œå¦å‰‡ä¸èƒ½å¤§å¹…åº¦æ¨ç¿»ç¬¬ä¸€æ¬¡åˆ†æçš„çµè«–**

**æ­¥é©Ÿ 4ï¼šç”Ÿæˆè¼¸å‡º**
- ä¿ç•™ç¬¬ä¸€æ¬¡åˆ†æçš„æ‰€æœ‰ themes/subthemes å’Œçµè«–
- åªåœ¨éœ€è¦å¾®èª¿çš„åœ°æ–¹é€²è¡Œå¾®èª¿
- æ¨™è¨»é©—è­‰çµæœå°æ¯å€‹è«–é»çš„å½±éŸ¿

---

## è¼¸å‡ºæ ¼å¼

{
  "revised_analysis": {
    // âš ï¸ æ³¨æ„ï¼šå¿…é ˆä¿ç•™ç¬¬ä¸€æ¬¡åˆ†æçš„æ‰€æœ‰çµæ§‹ï¼Œåªåœ¨éœ€è¦çš„åœ°æ–¹å¾®èª¿
    // æ ¼å¼èˆ‡ç¬¬ä¸€æ¬¡åˆ†æå®Œå…¨ç›¸åŒ
    "themes": [
      {
        // ... ç¬¬ä¸€æ¬¡åˆ†æçš„ theme çµæ§‹ ...
        // å¦‚æœæœ‰å¾®èª¿ï¼Œåœ¨ "notes" æ¬„ä½èªªæ˜å¾®èª¿åŸå› 
        "validation_notes": "æ ¹æ“šæœ€æ–°è³‡æ–™ï¼ˆç¬¬ X é ï¼‰ï¼Œè‰¯ç‡æ•¸æ“šç¬¦åˆé æœŸï¼Œæ”¯æŒåŸåˆ†æ"
      }
    ],
    "subthemes": [ /* æ ¼å¼åŒ themes */ ],
    "confidence_level": 0.9  // æ ¹æ“šé©—è­‰çµæœèª¿æ•´ä¿¡å¿ƒåº¦
  },
  "validation_impact": [
    {
      "question_id": "Q001",
      "question_text": "å•é¡Œå…§å®¹",
      "impact_type": "SUPPORT / NEUTRAL / CORRECTION",
      "impact_description": "æ ¹æ“šåŸæ–‡æ®µè½ï¼ˆç¬¬ X é ï¼‰çš„å…§å®¹ï¼Œ...ï¼ˆèªªæ˜å½±éŸ¿ï¼‰",
      "data_source": "è³‡æ–™ä¾†æº",
      "page_references": [15, 23, 45],
      "original_passages_summary": "ç›¸é—œåŸæ–‡æ®µè½æ‘˜è¦ï¼ˆç”¨æ–¼å¯©æŸ¥ï¼‰"
    }
  ],
  "summary": "é©—è­‰ç¸½çµï¼šæœ¬æ¬¡é©—è­‰é‡å° X å€‹é—œéµå•é¡Œï¼Œæ‰¾åˆ° Y å€‹ç›¸é—œæ–‡ä»¶æ®µè½ã€‚å…¶ä¸­ Z å€‹å•é¡Œçš„é©—è­‰çµæœæ”¯æŒåŸåˆ†æï¼ŒW å€‹å•é¡Œéœ€è¦å¾®èª¿è«–é»ã€‚æ•´é«”è€Œè¨€ï¼ŒåŸåˆ†æçš„çµè«–ä»ç„¶æˆç«‹/éœ€è¦ä¿®æ­£ï¼ˆèªªæ˜åŸå› ï¼‰ã€‚"
}
`;
}
```

### **ä¿®æ”¹å‡½æ•¸ 7ï¼š`P0_ProcessM0ReanalysisResult(jobId, m0Result)`**

**åŠŸèƒ½**ï¼šè™•ç† OPUS é‡æ–°åˆ†æçš„çµæœ

**å¯¦ä½œç¯„ä¾‹**ï¼š
```javascript
/**
 * è™•ç† OPUS é‡æ–°åˆ†æçš„çµæœ
 * @param {string} jobId - Job ID
 * @param {Object} m0Result - M0 åŸ·è¡Œçµæœ
 */
function P0_ProcessM0ReanalysisResult(jobId, m0Result) {
  try {
    const executorOutput = m0Result.executor_output || {};
    const auditorOutput = m0Result.auditor_output || {};
    
    // å¾ input_payload ä¸­ç²å– snapshot_id
    const inputPayload = JSON.parse(m0Result.input_payload || "{}");
    const snapshotId = inputPayload.snapshot_id;
    
    if (!snapshotId) {
      throw new Error("æ‰¾ä¸åˆ° snapshot_id");
    }
    
    // æ›´æ–°å¿«ç…§
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("P0__SNAPSHOT");
    const dataRange = sheet.getDataRange();
    const rows = dataRange.getValues();
    const headers = rows[0];
    const snapshotIdCol = headers.indexOf("snapshot_id");
    
    let targetRow = -1;
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][snapshotIdCol] === snapshotId) {
        targetRow = i + 1;
        break;
      }
    }
    
    if (targetRow === -1) {
      throw new Error(`æ‰¾ä¸åˆ°å¿«ç…§ï¼š${snapshotId}`);
    }
    
    // æ›´æ–° final_analysis_json å’Œ validation_status
    const finalAnalysisCol = headers.indexOf("final_analysis_json");
    const validationStatusCol = headers.indexOf("validation_status");
    
    if (finalAnalysisCol !== -1) {
      sheet.getRange(targetRow, finalAnalysisCol + 1).setValue(JSON.stringify(executorOutput));
    }
    if (validationStatusCol !== -1) {
      sheet.getRange(targetRow, validationStatusCol + 1).setValue("COMPLETED");
    }
    
    // ä½¿ç”¨é‡æ–°åˆ†æçµæœç”Ÿæˆ P0 è¼¸å‡ºï¼ˆåŸæœ‰é‚è¼¯ï¼‰
    const p0Output = generateP0Output(executorOutput, auditorOutput);
    
    // ä¿å­˜å¿«ç…§ï¼ˆä½¿ç”¨é‡æ–°åˆ†æçµæœï¼‰
    saveP0Snapshot({
      snapshot_id: snapshotId,
      trigger: "VALIDATION_COMPLETED",
      p0_output_json: JSON.stringify(p0Output),
      final_analysis_json: JSON.stringify(executorOutput),
      validation_status: "COMPLETED"
    });
    
    Logger.log(`P0 V8.14ï¼šé‡æ–°åˆ†æå®Œæˆï¼Œå·²æ›´æ–°å¿«ç…§ ${snapshotId}`);
    
    return p0Output;
    
  } catch (error) {
    Logger.log(`P0 V8.14ï¼šè™•ç†é‡æ–°åˆ†æçµæœå¤±æ•—ï¼š${error.message}`);
    throw error;
  }
}
```

---

## ğŸ¯ éŒ¯èª¤è™•ç†ç­–ç•¥

### **PDF ä¸‹è¼‰å¤±æ•—**
- **è™•ç†æ–¹å¼**ï¼šå¿½ç•¥è©²é©—è­‰å•é¡Œï¼Œä½¿ç”¨åŸåˆ†æé€å…¥å¯©æŸ¥éšæ®µ
- **å¯¦ä½œ**ï¼šåœ¨ `P0_TriggerGeminiValidation()` ä¸­ï¼Œå¦‚æœæ‰¾ä¸åˆ° PDFï¼Œå°‡å°æ‡‰å•é¡Œçš„ `status` è¨­ç‚º `SKIPPED`
- **å½±éŸ¿**ï¼šè©²å•é¡Œä¸æœƒè¢«é©—è­‰ï¼Œä½†ä¸æœƒé˜»æ–·æµç¨‹

### **Gemini File API ä¸Šå‚³å¤±æ•—**
- **è™•ç†æ–¹å¼**ï¼šè¨˜éŒ„éŒ¯èª¤ï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹ PDF
- **å¯¦ä½œ**ï¼šåœ¨ `uploadFileToGemini()` ä¸­ä½¿ç”¨ try-catchï¼Œå¤±æ•—æ™‚è¨˜éŒ„ä½†ä¸ä¸­æ–·

### **Gemini æå–å¤±æ•—**
- **è™•ç†æ–¹å¼**ï¼šè¨˜éŒ„éŒ¯èª¤ï¼Œè©²å•é¡Œæ¨™è¨˜ç‚º `FAILED`ï¼Œä½†ä¸å½±éŸ¿å…¶ä»–å•é¡Œ
- **å¯¦ä½œ**ï¼šåœ¨ `extractContextFromGeminiFile()` ä¸­ä½¿ç”¨ try-catch

### **OPUS é‡æ–°åˆ†æå¤±æ•—**
- **è™•ç†æ–¹å¼**ï¼šé™ç´šä½¿ç”¨ç¬¬ä¸€æ¬¡åˆ†æçµæœï¼Œé€²å…¥ GPT å¯©æŸ¥éšæ®µ
- **å¯¦ä½œ**ï¼šåœ¨ `triggerP0Reanalysis()` ä¸­ï¼Œå¦‚æœå¤±æ•—ï¼Œå°‡ `validation_status` è¨­ç‚º `FAILED`ï¼Œä½†ä»ä½¿ç”¨ç¬¬ä¸€æ¬¡åˆ†æçµæœ

---

## ğŸ“‹ å¯¦æ–½æª¢æŸ¥æ¸…å–®

### **éšæ®µä¸€ï¼šåŸºç¤è¨­æ–½**
- [ ] æ“´å…… `P0__SNAPSHOT` Schemaï¼ˆæ–°å¢ 5 å€‹æ¬„ä½ï¼‰
- [ ] æ›´æ–° `01_SHEETS_STRUCTURE.js` ä¸­çš„ `P0_SNAPSHOT_SCHEMA`
- [ ] å¯¦ä½œ `uploadFileToGemini()`
- [ ] å¯¦ä½œ `extractContextFromGeminiFile()`
- [ ] å¯¦ä½œ `deleteGeminiFile()`

### **éšæ®µäºŒï¼šPrompt ä¿®æ”¹**
- [ ] ä¿®æ”¹ `buildP0Prompt()`ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰
- [ ] ä¿®æ”¹ `buildP0Prompt()`ï¼ˆæ­£å¼æ¨¡å¼ï¼‰
- [ ] æ–°å¢ `buildP0ReanalysisPrompt()`

### **éšæ®µä¸‰ï¼šæµç¨‹æ•´åˆ**
- [ ] ä¿®æ”¹ `P0_ProcessM0Result()`ï¼ˆä¿å­˜ç¬¬ä¸€æ¬¡åˆ†æï¼‰
- [ ] æ–°å¢ `extractValidationQuestions()`
- [ ] æ–°å¢ `saveP0InitialAnalysis()`
- [ ] æ–°å¢ `P0_TriggerGeminiValidation()`
- [ ] æ–°å¢ `triggerP0Reanalysis()`
- [ ] æ–°å¢ `P0_ProcessM0ReanalysisResult()`

### **éšæ®µå››ï¼šUI æ•´åˆï¼ˆå¾…å¾ŒçºŒï¼‰**
- [ ] UI å°è©±è¦–çª—ï¼ˆæ¨™è¨˜ç‚ºã€Œç³»çµ±æ¸¬è©¦å®Œæˆå¾Œçš„å¾…è™•ç†å·¥ä½œã€ï¼‰
- [ ] æ‰‹å‹•è§¸ç™¼ Gemini Flash å·¥ä½œçš„ UI æŒ‰éˆ•

---

## âš ï¸ æ³¨æ„äº‹é …

1. **API å¤±æ†¶å•é¡Œ**ï¼šå¿…é ˆä¿ç•™ OPUS ç¬¬ä¸€æ¬¡åˆ†æçš„å®Œæ•´æ–‡å­—ï¼Œåœ¨é‡æ–°åˆ†ææ™‚ä¸€ä½µæä¾›
2. **æª”æ¡ˆç”Ÿå‘½é€±æœŸ**ï¼šè™•ç†å®Œæˆå¾Œå¿…é ˆæ‰‹å‹•åˆªé™¤ Gemini æª”æ¡ˆï¼Œé¿å…é…é¡ä½”ç”¨
3. **éŒ¯èª¤è™•ç†**ï¼šPDF ä¸‹è¼‰å¤±æ•—æ™‚ï¼Œå¿½ç•¥æå•ï¼Œä½¿ç”¨åŸåˆ†æé€å…¥å¯©æŸ¥éšæ®µ
4. **ä¸é™å®šå•é¡Œæ•¸ç›®**ï¼šOPUS å¯ä»¥æå‡º 0 å€‹æˆ–å¤šå€‹é©—è­‰å•é¡Œï¼Œæ²’æœ‰ä¹Ÿæ²’é—œä¿‚

---

## ğŸ“ æ›´æ–°è¨˜éŒ„

- **V8.14ï¼ˆ2026-01-19ï¼‰**ï¼š
  - âœ… æŠ€è¡“ç¢ºèªå®Œæˆ
  - âœ… è¨­è¨ˆç¢ºèªå®Œæˆ
  - âœ… å¯¦ç¾è¨­è¨ˆå®Œæˆï¼ˆæœ¬æ–‡æª”ï¼‰
  - â³ å¾…å®šæ¡ˆå¾Œé–‹å§‹å¯¦ç¾

---

**æ­¤æ–‡æª”å®Œæˆ P0 æ”¹é€²æ–¹æ¡ˆçš„è©³ç´°å¯¦ç¾è¨­è¨ˆï¼Œç­‰å¾…ç”¨æˆ¶èªªã€Œå®šæ¡ˆã€å¾Œæ‰é–‹å§‹å¯¦ç¾å’Œæ›´æ–° SSOT æ–‡æª”ã€‚**
