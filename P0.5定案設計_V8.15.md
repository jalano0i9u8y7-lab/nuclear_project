# P0.5 定案設計（V8.15）

**日期**：2026-01-19  
**版本**：V8.15  
**狀態**：✅ **定案完成（待實現）**

---

## 📋 設計定案確認

### ✅ 核心哲學

> **「與其試圖用財務模型猜產業，不如直接觀察上中下游彼此的真實行為是否一致。」**

> **「我們做財務分析跟產業分析，做的再怎麼透徹，再怎麼詳細，也永遠比不上那個產業的人。所以直接觀察上中下游的連動關係，可以更準確地抓出這個產業現在處於甚麼樣的位置。」**

### ✅ 關鍵確認事項

1. **執行頻率**：
   - ✅ **Mode 2 是整個產業鏈的監控，不是單一公司**
   - ✅ **台股月度、美日股季度**
   - ✅ **台股月營收可以提前預判全球產業循環**（台股是上游，上游一轉全球會跟）
   - ✅ **這是 P0.5 + P5 Weekly 的優勢系統化**

2. **數據來源**：
   - ✅ **從 P2 收集的最新當月(台股)當季(美日股)所有營收數據**
   - ✅ **P2 的台股營收要月度更新，美日股維持季度**
   - ✅ **以權威網站為主**

3. **輸出格式**：
   - ✅ **4 區結構：meta / signals / diagnosis / handoff**
   - ✅ **signals：8 個核心信號，統一格式**
   - ✅ **diagnosis：受限輸出，固定框架**
   - ✅ **handoff：給後續模組用的接口欄位**

4. **與 P0.7 的關係**：
   - ✅ **P0.5 → P0.7：提供 `p0_7_evidence_pack`（證據包）**
   - ✅ **P0.7 → P0.5：回寫 `p0_7_time_window_constraints`（時間窗口約束）**
   - ✅ **P0.5 只做偵測與推演，不做時間定位裁決**（禁止輸出 Early/Mid/Late 結論）

---

## 🎯 完整設計規格

### 一、雙模式設計

#### **Mode 1: Baseline Builder（第一次跑）**

**觸發條件**：
- 系統第一次跑
- 尚未建立公司池（P1 尚未完成）
- 沒有歷史資料可比對

**功能**：
- 建立「這個產業在此時此刻的供應鏈結構與狀態基準」
- 只做三件事：
  1. 根據 P0 結論，畫出產業鏈結構（上/中/下/互補/替代）
  2. 標註「理論上應該怎麼動」（基於產業常識）
  3. 產出一份 `P0_5_BASELINE_STATE`

**執行頻率**：季度（與 P0 同步）

**輸出格式**：`industry_chain_map_json`（保留現有格式）

**🚫 此階段沒有監控、沒有異常、沒有判斷轉折**

---

#### **Mode 2: Chain Dynamics Monitor（後續監控）**

**觸發條件**：
- P1 已建立公司池
- 已至少有 1 期（1 季或 1 月）的歷史狀態
- 月度/季度更新時

**功能**：
- 監控上中下游行為一致性
- 識別異常狀態與轉折風險
- 提供證據包給下游模組

**執行頻率**：
- **台股：月度**（月營收可提前預判全球循環）
- **美日股：季度**

**輸出格式**：`chain_dynamics_monitor_json`（新增，4 區結構）

---

### 二、三階段推理流程（Mode 2 專用）

#### **Step 1: 產業生態識別**（Mandatory，必須先完成）

**Prompt 必須要求 AI 先回答**：

1. **該產業的核心驅動是什麼？**
   - CapEx？
   - R&D？
   - 政策？
   - 庫存？
   - 訂單能見度？

2. **財報數據相對於真實需求的「時間延遲」大約多久？**
   - 短期（1-3 個月）
   - 中期（3-6 個月）
   - 長期（6-12 個月）
   - 超長期（12 個月以上）

3. **哪一段（上/中/下游）最早反映真實變化？**
   - 上游（CapEx、訂單先行）
   - 中游（出貨、產能反映）
   - 下游（終端需求）

**輸出**：`industry_ecology_profile`（AI 針對該產業生態自動產出）

**⚠️ 此步驟的輸出是「分析方法的前提」，不是結論。**

---

#### **Step 2: 上中下游行為抽象**（標準化輸入）

**程式只提供結構化資料給 AI，不做判斷、不貼標籤**：

**數據來源**：
- **從 P1 讀取公司池**：
  - 讀取 `Phase1_Company_Pool` 表格
  - 按 `Supply_Chain_Position`（Upstream/Midstream/Downstream）分類
  - 取得每個公司的 ticker 和基本資訊

- **從 P2 讀取財務數據**：
  - ✅ **從 P2 收集的最新當月(台股)當季(美日股)所有營收數據**
  - ✅ **P2 的台股營收要月度更新，美日股維持季度**
  - 讀取 `Phase2_Output` 表格
  - 提取相關指標：
    - **上游**：CapEx 趨勢（台股月營收 + 季報 CapEx proxy）、擴產計劃、交期變化、接單敘事
    - **中游**：營收趨勢、出貨/產能、庫存變化、毛利變化、產能利用率
    - **下游**：拉貨節奏（pull-in/push-out）、庫存/渠道措辭、終端需求能見度、訂單能見度

**輸出格式**（程式提供）：
```json
{
  "upstream_signals": {
    "companies": ["TSMC", "ASML"],
    "revenue_trend": [{"ticker": "TSMC", "value": 0.15, "direction": "UP"}],
    "capex_trend": [{"ticker": "TSMC", "value": 0.20, "direction": "UP"}],
    "narratives": ["擴產積極", "交期延長"]
  },
  "midstream_signals": {
    "companies": ["NVDA", "AMD"],
    "revenue_trend": [{"ticker": "NVDA", "value": 0.80, "direction": "UP"}],
    "inventory_changes": [{"ticker": "NVDA", "value": 0.05, "direction": "FLAT"}],
    "narratives": ["出貨暢旺", "庫存健康"]
  },
  "downstream_signals": {
    "companies": ["AAPL", "MSFT"],
    "revenue_trend": [{"ticker": "AAPL", "value": 0.10, "direction": "UP"}],
    "order_visibility": [{"ticker": "AAPL", "value": "STRONG"}],
    "narratives": ["拉貨積極", "需求強勁"]
  }
}
```

---

#### **Step 3: 一致性與異常推演**（AI 責任）

**Prompt 明確要求 AI**：

1. **依據 Step 1 定義的產業生態**，自行建立最合理的判斷模型

2. **解釋目前上中下游行為是否**：
   - **高度一致**：所有段都在同一個方向（擴張/收縮/穩定）
   - **正常延遲**：上下游有時間差，但符合產業特性
   - **結構性背離**：上下游明顯不同步，可能代表轉折
   - **非典型但可解釋**：看似異常但有其原因（例如世代交替）

3. **若出現背離，必須提出**：
   - 至少 2-3 種可能解釋
   - 並標示「需要進一步監控」或「已具轉折風險」

4. **生成 8 個核心信號**（signals）：
   - 每個信號都必須附上證據（source, tickers, metric, notes）
   - 信號值必須可追溯、可驗證

5. **診斷當前鏈狀態**（diagnosis）：
   - 只允許引用 signals，不得引入外部敘事
   - 必須在固定框架內輸出（7 種狀態之一）

**⚠️ 禁止事項**：
- ❌ 不寫死情境清單（Case A/B/C）
- ❌ 不寫死產業生態清單（製造/軟體/能源）
- ❌ 不宣告「已到 Late」或「轉折點在 X 月後」（這是 P0.7 的職責）

---

### 三、輸出格式（4 區結構）

#### **A. meta：版本與範圍（可追溯、可升級）**

```json
{
  "meta": {
    "version": "0.1",
    "as_of": "2026-02-10",
    "cadence": "MONTHLY" | "QUARTERLY",
    "industry_id": "AI_SERVERS",
    "universe_scope": {
      "us": true,
      "tw": true,
      "jp": true
    },
    "coverage_level": "TW_MONTHLY_US_QUARTERLY"
  }
}
```

**說明**：
- `version`：輸出格式版本號（可升級）
- `as_of`：數據截止日期
- `cadence`：本次監控頻率（台股 MONTHLY，美日股 QUARTERLY）
- `industry_id`：P0 的產業 ID
- `universe_scope`：涵蓋市場
- `coverage_level`：關鍵：資料可得性分級

---

#### **B. signals：只放「可計算/可比」的觀測結果（不要推理）**

**統一格式**：
```json
{
  "signal_id": "S1",
  "signal_name": "demand_pull_downstream",
  "value": 75,
  "direction": "UP" | "DOWN" | "FLAT" | "DIVERGE",
  "strength": 0-100,
  "window": "1M" | "3M" | "6M",
  "evidence": {
    "source": "P2_Output",
    "tickers": ["AAPL", "MSFT"],
    "metric": "Revenue_YoY",
    "notes": "下游需求拉動（出貨/營收動能）",
    "available": true | false  // 如果沒有數據就標 available=false
  }
}
```

**8 個核心信號**：

1. **`demand_pull_downstream`**：下游需求拉動（出貨/營收動能）
   - 數據來源：下游公司營收 YoY、出貨數據
   - 證據：tickers、Revenue_YoY、narratives

2. **`capacity_build_upstream`**：上游擴產/CapEx 動能（台股月營收 + 季報 CapEx proxy）
   - 數據來源：上游公司 CapEx、台股月營收
   - 證據：tickers、CapEx_Trend、台股月營收變化

3. **`inventory_pressure_midstream`**：中游庫存/交期壓力
   - 數據來源：中游公司庫存變化、營收動能 vs 出貨/訂單說法
   - 證據：tickers、Inventory_Changes、交期變化

4. **`pricing_power_node`**：瓶頸節點是否仍有訂價權
   - 數據來源：缺貨/供需緊語義證據 + 毛利趨勢 proxy
   - 證據：tickers、毛利率變化、供需敘事

5. **`order_visibility`**：訂單能見度（RPO/合約負債/Backlog proxy，有就用，沒有就標 available=false）
   - 數據來源：RPO、Deferred Revenue、Backlog
   - 證據：tickers、RPO/Backlog 數據（如果有）

6. **`substitution_pressure`**：替代/被替代壓力（是否有替代節點加速）
   - 數據來源：替代節點營收變化、技術替代敘事
   - 證據：tickers、替代節點營收、技術突破新聞

7. **`capex_mismatch_divergence`**：上游 vs 下游不同步異常偵測（⭐ 王牌）
   - 數據來源：上游 CapEx 趨勢 vs 下游需求趨勢
   - 證據：上游 CapEx、下游營收、時間差分析

8. **`credit_stress_chain`**：產業鏈信用壓力（應收帳款天數/現金流緊縮 proxy，有就用）
   - 數據來源：應收帳款天數、現金流變化
   - 證據：tickers、AR_Days、CFO 變化（如果有）

**⚠️ 重點**：P0.5 的「偵測」要靠 signals，不要在這一層就下結論說會崩/會噴，避免越權。

---

#### **C. diagnosis：允許 AI 智慧，但要「受限輸出」**

**固定框架**：
```json
{
  "diagnosis": {
    "current_chain_state": "ACCELERATING" | "HEALTHY_EXPANSION" | "LATE_TIGHTENING" | "INVENTORY_BUILD" | "DEMAND_SOFTENING" | "MIXED_SIGNALS" | "UNKNOWN",
    "state_confidence": "HIGH" | "MEDIUM" | "LOW",
    "state_rationale": "<= 120字（只允許引用 signals，不得引入外部敘事）",
    "industry_ecology_profile": "AI 針對該產業生態自動產出（如：長周期資本密集型 / 平台型 / 政策驅動型）",
    "anomalies": [
      {
        "pattern_id": "ANOMALY_001",
        "description": "上游CapEx放緩但中游仍擴張",
        "likely_explanations": [
          "新一代產品正在準備（世代交替）",
          "預期未來缺料，提前備庫存",
          "長約產業反應延遲"
        ],
        "what_to_watch_next": [
          "下季上游CapEx是否持續放緩",
          "中游庫存是否開始累積",
          "訂單能見度是否下降"
        ]
      }
    ]
  }
}
```

**說明**：
- `current_chain_state`：7 種固定狀態之一（不允許自定義）
- `state_rationale`：必須只引用 signals，不得引入外部敘事（限制 120 字）
- `industry_ecology_profile`：AI 自動產出，描述該產業特性
- `anomalies`：每個異常必須有 pattern_id、description、likely_explanations（最多 3 條）、what_to_watch_next（最多 3 條）

**⚠️ 禁止事項**：
- ❌ 不宣告「已到 Late」或「轉折點在 X 月後」（這是 P0.7 的職責）
- ❌ 不進行長期前瞻敘事（這是 P0 的職責）
- ❌ 不判斷產業是否值得投資（這是 P0 的職責）

---

#### **D. handoff：給後續模組用的「接口欄位」（最重要）**

```json
{
  "handoff": {
    "p0_7_evidence_pack": {
      "demand_trend": {"direction": "UP" | "DOWN" | "FLAT", "strength": 0-100},
      "capex_trend": {"direction": "UP" | "DOWN" | "FLAT", "strength": 0-100},
      "inventory_proxy": {"direction": "BUILD" | "DRAW" | "FLAT", "strength": 0-100},
      "pricing_tightness": {"direction": "TIGHT" | "LOOSENING" | "STABLE", "strength": 0-100},
      "divergence_flags": ["UPSTREAM_DOWNSTREAM_MISMATCH", "INVENTORY_ACCUMULATION", ...],
      "notes": "短（不推論、只給證據）"
    },
    "p1_inputs": {
      "nodes_to_prioritize": ["UPSTREAM_001", "MIDSTREAM_001"],
      "nodes_to_watch_victims": ["DOWNSTREAM_001"],
      "risk_flags": ["STRUCTURAL_WEAKENING", "SUBSTITUTION_ACCELERATING"]
    },
    "p2_inputs": {
      "capex_verification_priority": ["TSMC", "ASML"],
      "rpo_tracking_priority": ["NVDA", "AMD"],
      "executability_focus": "CapEx是否真的在動、RPO是否上升"
    },
    "p5_weekly_flags": {
      "LATE_CYCLE_RISK": true | false,
      "DIVERGENCE_ALERT": true | false,
      "INVENTORY_BUILD_WARNING": true | false,
      "PRICING_LOOSENING": true | false,
      "SUBSTITUTION_ACCELERATING": true | false
    }
  }
}
```

**說明**：
- `p0_7_evidence_pack`：給 P0.7 的證據包（不推論、只給證據）
- `p1_inputs`：給 P1 的節點優先級和風險標記
- `p2_inputs`：給 P2 的驗證重點
- `p5_weekly_flags`：給 P5 Weekly 的風控旗標

**⚠️ 重點**：handoff 必須可程式化，不要讓下游模組自己理解散文。

---

### 四、與 P0.7 的雙向接口

#### **P0.5 → P0.7：提供 Cycle Evidence Pack**

**P0.5 每次輸出要帶固定欄位**：`p0_7_evidence_pack`

```json
{
  "p0_7_evidence_pack": {
    "demand_trend": {"direction": "UP", "strength": 75},
    "capex_trend": {"direction": "UP", "strength": 80},
    "inventory_proxy": {"direction": "DRAW", "strength": 60},
    "pricing_tightness": {"direction": "TIGHT", "strength": 85},
    "divergence_flags": ["UPSTREAM_DOWNSTREAM_MISMATCH"],
    "notes": "上游CapEx放緩但下游需求仍強（不推論、只給證據）"
  }
}
```

**P0.7 拿到這包後，才去做**：
- 週期位置（Early/Mid/Late）
- delay（擴產延遲、驗證延遲）
- turning point risk

---

#### **P0.7 → P0.5：回寫 Time Window Constraints**

**P0.7 產出後，回寫到 P0.5 快照**：`p0_7_time_window_constraints`

```json
{
  "p0_7_time_window_constraints": {
    "cycle_position": "Late",
    "turning_point_risk": "HIGH",
    "dominant_loops": ["R_LOOP_DEMAND", "B_LOOP_SUPPLY"],
    "key_delays": [
      {"name": "capacity coming online", "expected_months": 6},
      {"name": "pricing peak", "expected_months": 3}
    ],
    "watch_list": ["capacity coming online", "pricing peak", "inventory reversal"]
  }
}
```

**P0.5 下一輪會更聰明**：
- 如果 P0.7 說 Late + 高轉折風險
- → P0.5 下一輪監控會更聚焦在「庫存反轉」「訂價鬆動」「上游營收/CapEx轉折」

**實現方式**：
- 在 `P0_5_Execute()` 中讀取上次 P0.7 快照的 `time_window_constraints`
- 傳入 Prompt，讓 AI 根據此約束調整監控重點

---

### 五、執行頻率與數據來源

#### **執行頻率**

- **Mode 1（Baseline Builder）**：
  - 季度（與 P0 同步，不變）

- **Mode 2（Chain Dynamics Monitor）**：
  - ✅ **台股：月度**（月營收可提前預判全球循環）
    - ⭐ **執行時間點：每月 12 號**（台股規定每月 10 日前必須公布上月營收，12 號執行確保資料完整，預留財報狗的更新時間）
  - ✅ **美日股：季度**（季度財報後執行）
  - ✅ **這是整個產業鏈的監控，不是單一公司**
  - ✅ **第一次執行：等 P1 建立公司池後才開始監控**

**實現方式**：
- 新增 `determineCadence()` 函數（根據市場判斷 cadence）
- 新增 `shouldExecuteMode2()` 函數（檢查執行時機：台股每月15號、美日股季度財報後）
- 在 `P0_5_Execute()` 中判斷 Mode：
  - 檢查 P1 公司池是否存在
  - 如果不存在 → Mode 1
  - 如果存在 → Mode 2（根據市場和時間點決定是否執行）

---

#### **數據來源**（⭐ 已確認）

- **從 P1 讀取公司池**：
  - 讀取 `Phase1_Company_Pool` 表格
  - 按 `Supply_Chain_Position`（Upstream/Midstream/Downstream）分類

- **從 P2 讀取財務數據**：
  - ✅ **從 P2 收集的最新當月(台股)當季(美日股)所有營收數據**
  - ✅ **P2 的台股營收要月度更新，美日股維持季度**
  - ✅ **以權威網站為主**
  - 讀取 `Phase2_Output` 表格
  - 提取相關指標：
    - 上游：CapEx、台股月營收、擴產計劃
    - 中游：營收、出貨、庫存、毛利
    - 下游：營收、拉貨節奏、訂單能見度

**⚠️ 注意**：不是根據單一公司有沒有給財報，而是整個產業鏈的數據。

---

### 六、表格結構更新

#### **更新 `P0_5_SNAPSHOT_SCHEMA`**

**新增欄位**：
- `chain_dynamics_monitor_json`：Mode 2 的監控輸出（4 區結構）
- `p0_7_time_window_constraints_json`：P0.7 回寫的時間窗口約束

**保留欄位**：
- `industry_chain_map_json`：Mode 1 的產業鏈地圖（保留）

---

## 📝 實現項目清單

### 高優先級（必須實現）

1. ⭐ **雙模式設計**
   - [ ] 在 `P0_5_Execute()` 中判斷 Mode（檢查 P1 公司池是否存在）
   - [ ] Mode 1：保留現有 Baseline Builder 功能
   - [ ] Mode 2：新增 Chain Dynamics Monitor 功能

2. ⭐ **三階段推理流程**
   - [ ] 更新 Prompt，要求 AI 先完成 Step 1（產業生態識別）
   - [ ] 新增 `collectChainBehaviorData()` 函數（從 P1/P2 讀取數據）
   - [ ] 新增 `buildChainDynamicsPrompt()` 函數（Mode 2 專用 Prompt）

3. ⭐ **數據收集機制**
   - [ ] 新增 `classifyCompaniesByChainPosition()` 函數
   - [ ] 新增 `extractChainBehaviorIndicators()` 函數
   - [ ] 從 P1 讀取公司池（按上中下游分類）
   - [ ] 從 P2 讀取財務數據（✅ 台股月度、美日股季度）

4. ⭐ **輸出格式實現**
   - [ ] 更新 `P0_5_SNAPSHOT_SCHEMA`，新增 `chain_dynamics_monitor_json` 欄位
   - [ ] 更新 `P0_5_SNAPSHOT_SCHEMA`，新增 `p0_7_time_window_constraints_json` 欄位
   - [ ] 實現 4 區結構輸出：meta / signals / diagnosis / handoff
   - [ ] 實現 8 個核心信號的生成邏輯

5. ⭐ **執行頻率邏輯**
   - [ ] 新增 `determineCadence()` 函數（台股 MONTHLY，美日股 QUARTERLY）
   - [ ] Mode 2 第一次執行：等 P1 建立公司池後才開始

6. ⭐ **與 P0.7 的雙向接口**
   - [ ] 實現 `p0_7_evidence_pack` 生成邏輯
   - [ ] 實現讀取 P0.7 快照的 `time_window_constraints`
   - [ ] 在 Prompt 中整合 `p0_7_time_window_constraints`

7. ⭐ **P2 台股月度更新**
   - [ ] 確認 P2 的台股營收是否已實現月度更新
   - [ ] 如果沒有，需要先實現 P2 台股月度更新功能

---

## 🎯 設計原則總結

### 核心哲學

> **「與其試圖用財務模型猜產業，不如直接觀察上中下游彼此的真實行為是否一致。」**

### 關鍵原則

1. **不寫死情境與產業生態**
   - 讓 AI 根據產業生態自行建模
   - 禁止 if-then 情境硬編碼
   - 固定輸出框架，但允許 AI 自動生成情境假說

2. **雙模式設計**
   - Mode 1：第一次跑，只畫地圖
   - Mode 2：後續監控，觀察行為一致性

3. **三階段推理**
   - Step 1：產業生態識別（必須先完成）
   - Step 2：行為抽象（程式提供數據）
   - Step 3：一致性推演（AI 責任）

4. **執行頻率**
   - 台股月度、美日股季度（系統化台股優勢）

5. **職權邊界**
   - P0.5 不下投資結論
   - P0.5 不做時間定位裁決（禁止輸出 Early/Mid/Late）
   - 只提供狀態訊號給下游模組

6. **輸出格式**
   - 4 區結構：meta / signals / diagnosis / handoff
   - 必須可追溯、可程式化
   - 不要寫散文，要結構化

---

## ✅ 定案確認

**所有設計已定案，等待實現。**

**下一步**：
1. 確認此定案設計是否符合需求
2. 開始實現上述 7 項高優先級項目

---

**此文檔完成 P0.5 定案設計，等待用戶確認後開始實現。**
