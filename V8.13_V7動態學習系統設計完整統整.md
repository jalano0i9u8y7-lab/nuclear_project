# V8.13 V7動態學習系統設計完整統整

**日期**：2026-01-19  
**來源**：V7設計（Closed-loop Brain）  
**狀態**：✅ 完整統整到V8.0 SSOT

---

## ⚠️ 重要說明

這是V7時就已經詳細定案的動態學習系統設計，但在後續討論中逐漸遺漏，沒有記進SSOT。現在完整統整，確保所有細節都被記錄，以後不准再發生類似沒有備份沒有統整隨意省略或遺漏的現象。

---

## 📋 V7設計核心架構：Closed-loop Brain（閉環控制大腦）

### 核心目標

最大化長期期望值（EV），並在風險環境下避免回撤致死。系統具備閉環控制：每次策略輸出都必須被未來市場驗證，並回饋到下一輪策略生成的「參數空間校準」。

---

## A. 數據–策略–結果追蹤鏈（Data → Strategy → Outcome Trace）

### 設計目標

系統每次輸出策略時寫入 STRATEGY_SNAPSHOT，包含當下資料摘要與「可驗證命題（Claims）」；對應觀察窗結束後寫入 OUTCOME_SNAPSHOT，形成可回放的追蹤鏈。

### 數據結構

#### STRATEGY_SNAPSHOT（策略快照）

**表格名稱**：`P5__STRATEGY_SNAPSHOT`

**欄位結構**：
- `snapshot_id` - 快照ID（唯一標識）
- `created_at` - 創建時間
- `period_type` - 時間週期類型（WEEK/MONTH/QUARTER）
- `period_id` - 時間週期ID（如 WEEK_2026-W03）
- `data_summary_json` - 當下資料摘要（JSON格式）
  - 包含：使用的數據來源、數據時間範圍、關鍵數據點
- `claims_json` - 可驗證命題（JSON格式，**核心**）
  - 每個Claim包含：
    - `claim_id` - 命題ID
    - `claim_type` - 命題類型（DIRECTION/PRICE_TARGET/TIMING/MAGNITUDE等）
    - `claim_content` - 命題內容（結構化描述）
    - `verification_window` - 驗證時間窗口（天數）
    - `verification_condition` - 驗證條件（如何判斷是否正確）
- `strategy_output_json` - 策略輸出（JSON格式）
  - 包含：個股策略、權重調整、風險評估等
- `data_sources_json` - 數據來源記錄（JSON格式，V8.13已實現）
- `version` - 版本號

#### OUTCOME_SNAPSHOT（結果快照）

**表格名稱**：`P5__OUTCOME_SNAPSHOT`

**欄位結構**：
- `outcome_id` - 結果ID（唯一標識）
- `strategy_snapshot_id` - 對應的策略快照ID（外鍵）
- `created_at` - 創建時間（觀察窗結束後）
- `period_type` - 時間週期類型（WEEK/MONTH/QUARTER）
- `period_id` - 時間週期ID
- `market_data_json` - 市場真實反應數據（JSON格式）
  - 包含：實際價格變化、成交量、技術指標變化等
- `claims_verification_json` - 可驗證命題驗證結果（JSON格式，**核心**）
  - 每個Claim的驗證結果：
    - `claim_id` - 對應的命題ID
    - `verified` - 是否驗證通過（true/false）
    - `verification_result` - 驗證結果詳情
    - `deviation` - 偏差（如果未完全符合）
- `scorecard_json` - 四項Scorecard（JSON格式，見B節）
- `attribution_json` - 錯誤歸因結果（JSON格式，見C節）
- `version` - 版本號

### 實施要求

1. **策略輸出時**：必須同時創建STRATEGY_SNAPSHOT，包含所有可驗證命題（Claims）
2. **觀察窗結束後**：必須創建OUTCOME_SNAPSHOT，對照市場真實反應
3. **追蹤鏈完整性**：每個STRATEGY_SNAPSHOT都必須有對應的OUTCOME_SNAPSHOT
4. **Claims結構化**：只有被結構化成Claim的策略敘述才評分（避免亂評分導致亂調參數）

---

## B. 策略比對機制（Weekly / Monthly / Quarterly）

### 設計目標

採用「時移比對」：用 T+Δ 的市場真實數據比對 T 時點策略，產出四項 Scorecard。

### 四項Scorecard（必須實現）

#### 1. 方向準度（Directional Accuracy）

- **定義**：預測方向（看多/看空）是否正確
- **計算方式**：
  - 正確預測數 / 總預測數
  - 範圍：0.0-1.0
- **閾值**：
  - 優秀：≥ 0.70
  - 良好：0.60-0.69
  - 需改進：< 0.60

#### 2. 時機偏差（Timing Bias，日）

- **定義**：預測時機是否準確（預測的轉折點與實際轉折點的時間差）
- **計算方式**：
  - 平均時機偏差（天數）
  - 正值表示預測過早，負值表示預測過晚
- **閾值**：
  - 優秀：±3天內
  - 良好：±7天內
  - 需改進：> ±7天

#### 3. 幅度偏差（Magnitude Bias，%）

- **定義**：預測幅度是否準確（預測的價格變化幅度與實際價格變化幅度的偏差）
- **計算方式**：
  - 平均幅度偏差（百分比）
  - 正值表示預測過高，負值表示預測過低
- **閾值**：
  - 優秀：±5%內
  - 良好：±10%內
  - 需改進：> ±10%

#### 4. 最大回撤（Max Drawdown，%）

- **定義**：策略執行期間的最大回撤幅度
- **計算方式**：
  - 從策略執行開始到觀察窗結束期間的最大回撤
- **閾值**：
  - 優秀：< 5%
  - 良好：5-10%
  - 需改進：> 10%

### 頻率分工

- **Weekly**：比對上一週的策略與本週的市場真實反應
- **Monthly**：比對上一月的策略與本月的市場真實反應，統整全月學習經驗
- **Quarterly**：比對上一季的策略與本季的市場真實反應，統整全季學習經驗

### 實施要求

1. **必須計算四項Scorecard**：不能只計算方向準度，必須包含時機偏差、幅度偏差、最大回撤
2. **保存到OUTCOME_SNAPSHOT**：所有Scorecard結果必須保存到`scorecard_json`欄位
3. **用於參數校準**：Scorecard低於閾值時，觸發錯誤歸因（見C節）

---

## C. 錯誤歸因（Attribution Engine）

### 設計目標

當 Scorecard 低於門檻時，AI 必須選擇單一主因（可選次因），並附上 Evidence pointers。

### 錯誤類型（必須實現）

#### Type A：數據源污染（Data Source Contamination）

- **定義**：使用的數據來源有問題（錯誤數據、過時數據、數據缺失等）
- **證據要求**：必須指出具體的數據來源和問題
- **示例**：
  - "新聞數據過時（3天前的新聞被當成當日新聞）"
  - "技術指標計算錯誤（MA計算基於錯誤的收盤價）"
  - "宏觀數據缺失（VIX數據在策略制定時缺失）"

#### Type B：邏輯幻覺（Logic Hallucination）

- **定義**：AI邏輯推理錯誤（錯誤的因果關係、過度解讀、忽略關鍵因素等）
- **證據要求**：必須指出具體的邏輯錯誤點
- **示例**：
  - "過度解讀單一新聞事件（將單一新聞當成系統性風險）"
  - "忽略關鍵技術指標（忽略明顯的技術破位信號）"
  - "錯誤的因果關係（將相關性當成因果關係）"

#### Type C：執行滑價（Execution Slippage）

- **定義**：策略執行時的滑價問題（無法按預期價格執行、執行延遲等）
- **證據要求**：必須指出具體的執行問題
- **示例**：
  - "目標價位無法執行（流動性不足）"
  - "執行延遲（策略制定後3天才執行）"

#### Type D：黑天鵝（Black Swan）

- **定義**：無法預測的極端事件（市場崩盤、突發政策、重大意外等）
- **證據要求**：必須指出具體的黑天鵝事件
- **示例**：
  - "突發政策變化（監管政策突然改變）"
  - "市場崩盤（系統性風險爆發）"

### 實施要求

1. **必須選擇單一主因**：不能同時選擇多個主因，必須明確指出最主要的原因
2. **可選次因**：可以選擇1-2個次要原因作為補充
3. **必須附Evidence pointers**：每個歸因都必須有具體的證據指向（數據來源、時間點、具體問題等）
4. **缺證據時標記不確定**：若缺證據只能標記`UNCERTAIN_CAUSE`，不得驅動回寫
5. **保存到OUTCOME_SNAPSHOT**：所有歸因結果必須保存到`attribution_json`欄位

---

## D. 回寫（Write-back）只允許參數校準（禁止改邏輯）

### 設計目標

所有學習結果只能回寫到 LEARNING_STATE（JSON），禁止回寫或修改任何 Phase 策略邏輯與 if-then 決策。

### LEARNING_STATE（學習狀態）

**表格名稱**：`P5__LEARNING_STATE`

**欄位結構**：
- `state_id` - 狀態ID（唯一標識）
- `created_at` - 創建時間
- `updated_at` - 最後更新時間
- `learning_state_json` - 學習狀態（JSON格式，**核心**）
  - 包含以下子結構：

#### 1. 權重呼吸（Breathing Weights）

**定義**：根據學習結果動態調整各因素權重

**結構**：
```json
{
  "breathing_weights": {
    "fundamental": 0.25,  // 基本面權重（範圍：0.0-1.0）
    "chips": 0.20,        // 籌碼面權重
    "tech": 0.25,         // 技術面權重
    "macro": 0.20,        // 宏觀面權重
    "sentiment": 0.10     // 情緒面權重
  }
}
```

**調整規則**：
- 每週最多 ±0.05（避免劇烈波動）
- 每月才允許重新平衡到新穩態
- 總和必須等於1.0

#### 2. 關鍵閾值縮放（Threshold Scaling）

**定義**：根據學習結果調整關鍵閾值

**結構**：
```json
{
  "threshold_scaling": {
    "entry_confirmation_atr_multiple": 1.5,  // 進場確認ATR倍數（預設1.5）
    "lock_profit_atr_multiple": 2.0,        // 鎖利ATR倍數（預設2.0）
    "narrative_downgrade_strength": 0.3,    // 敘事降權強度（預設0.3）
    "risk_off_trigger_vix": 25.0,          // Risk-Off觸發VIX閾值（預設25.0）
    "max_position_size": 0.15               // 單一持股最大權重（預設0.15）
  }
}
```

**調整規則**：
- 每次調整幅度不超過±10%
- 必須有明確的學習依據（Scorecard低於閾值 + 錯誤歸因）

### 禁止事項（嚴格執行）

1. **禁止修改策略邏輯**：不能修改任何Phase的策略邏輯（如P3的技術分析邏輯、P5 Weekly的決策邏輯等）
2. **禁止修改if-then決策**：不能修改任何if-then決策規則
3. **禁止修改程式邏輯**：程式端只讀取參數並計算，不做判斷
4. **唯一可回寫檔**：LEARNING_STATE.json（其他地方禁止寫參數）

### 實施要求

1. **回寫頻率限制**：
   - 權重每週最多 ±0.05
   - 每月才允許重新平衡到新穩態
2. **回寫觸發條件**：
   - Scorecard低於閾值
   - 錯誤歸因完成（有明確證據）
   - 不能因為缺證據就回寫（必須標記UNCERTAIN_CAUSE）
3. **回寫記錄**：每次回寫都必須記錄到`P5__LEARNING_LOG`，包含：
   - 回寫前的狀態
   - 回寫後的狀態
   - 回寫依據（Scorecard、錯誤歸因、證據）

---

## E. 情境記憶（Scenario Memory / PTSD）

### 設計目標

系統將每次策略時的環境特徵寫入 SCENARIO_MEMORY（簽章統計）。當某簽章在歷史上顯示高死亡率，系統輸出 Safety Lock 建議。

### SCENARIO_MEMORY（情境記憶）

**表格名稱**：`P5__SCENARIO_MEMORY`

**欄位結構**：
- `scenario_id` - 情境ID（唯一標識）
- `created_at` - 創建時間
- `updated_at` - 最後更新時間
- `scenario_signature_json` - 情境簽章（JSON格式，**核心**）
  - 包含環境特徵：
    - `vix_level` - VIX水平（範圍：LOW/MEDIUM/HIGH/EXTREME）
    - `market_regime` - 市場狀態（BULL/BEAR/SIDEWAYS/UNCERTAIN）
    - `sector_rotation` - 板塊輪動（JSON格式，包含各板塊表現）
    - `macro_indicators` - 宏觀指標（JSON格式，包含關鍵宏觀數據）
    - `news_sentiment` - 新聞情緒（POSITIVE/NEUTRAL/NEGATIVE）
    - `technical_signals` - 技術信號（JSON格式，包含關鍵技術指標）
- `historical_occurrences_json` - 歷史出現次數（JSON格式）
  - 包含：
    - `total_count` - 總出現次數
    - `success_count` - 成功次數（策略正確）
    - `failure_count` - 失敗次數（策略錯誤）
    - `mortality_rate` - 死亡率（failure_count / total_count）
- `safety_lock_recommendations_json` - Safety Lock建議（JSON格式）
  - 當死亡率 > 0.5時，系統輸出建議：
    - `max_position_size` - 最大倉位建議（降低）
    - `verification_threshold` - 驗證門檻建議（提高）
    - `risk_off_trigger` - Risk-Off觸發建議（提前）

### Safety Lock機制

**設計原則**：
1. **不得硬鎖執行**：Safety Lock只能給Weekly限制建議，不能硬鎖執行
2. **可由Weekly Override**：Weekly可以覆蓋Safety Lock建議，但必須留下理由
3. **納入下一輪比對**：如果Weekly覆蓋了Safety Lock建議，必須將此決策納入下一輪比對（如果結果不好，會記錄到學習系統）

**實施要求**：
1. **情境簽章提取**：每次策略輸出時，必須提取環境特徵並生成情境簽章
2. **歷史比對**：比對歷史情境簽章，計算死亡率
3. **Safety Lock輸出**：當死亡率 > 0.5時，輸出Safety Lock建議
4. **記錄到STRATEGY_SNAPSHOT**：Safety Lock建議必須記錄到策略快照中

---

## F. 工程限制清單（5條）

### ⚠️ 這5條是能讓你少debug 70%的條款（務必寫進SSOT）

#### 1. 唯一可回寫檔：LEARNING_STATE.json（其他地方禁止寫參數）

- **嚴格執行**：所有參數調整只能寫入`P5__LEARNING_STATE`表格
- **禁止事項**：禁止在其他任何地方（程式碼、配置文件、其他表格）寫入參數
- **檢查機制**：每次更新參數時，必須檢查是否只更新了LEARNING_STATE

#### 2. 回寫頻率限制：權重每週最多 ±0.05；每月才允許重新平衡到新穩態

- **權重調整限制**：每週權重調整幅度不得超過±0.05
- **重新平衡限制**：每月才允許重新平衡到新穩態（可以超過±0.05）
- **實施檢查**：每次回寫時，必須檢查調整幅度是否符合限制

#### 3. Safety Lock不得硬鎖執行：只能給Weekly限制建議

- **設計原則**：Safety Lock只能給建議，不能硬鎖執行
- **實施要求**：程式端不能因為Safety Lock就強制阻止執行，只能提供建議
- **Override機制**：Weekly可以覆蓋Safety Lock建議，但必須留下理由

#### 4. 歸因無證據不得回寫：先標UNCERTAIN_CAUSE

- **嚴格執行**：如果錯誤歸因沒有明確證據，必須標記`UNCERTAIN_CAUSE`
- **禁止事項**：不能因為沒有證據就跳過歸因，也不能因為沒有證據就回寫
- **實施檢查**：每次歸因時，必須檢查是否有明確證據

#### 5. Claims才評分：沒有被結構化成Claim的策略敘述不評分（避免亂評分導致亂調參數）

- **設計原則**：只有被結構化成Claim的策略敘述才評分
- **實施要求**：
  - 策略輸出時，必須將所有可驗證的預測結構化成Claims
  - 只有Claims才會被評分，其他敘述不評分
  - 避免因為非結構化的敘述而亂評分，導致亂調參數

---

## 📊 實施狀態對照表

| 功能模組 | V7設計 | V8.13現有實現 | 狀態 | 備註 |
|---------|--------|--------------|------|------|
| **A. 數據-策略-結果追蹤鏈** |
| STRATEGY_SNAPSHOT | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增表格和函數 |
| OUTCOME_SNAPSHOT | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增表格和函數 |
| Claims結構化 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要修改策略輸出函數 |
| **B. 策略比對機制** |
| 方向準度 | ✅ 已設計 | ✅ 部分實現 | ✅ 已實現 | `compareStrategyWithReality()`已有基本實現 |
| 時機偏差 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要補充計算邏輯 |
| 幅度偏差 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要補充計算邏輯 |
| 最大回撤 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要補充計算邏輯 |
| **C. 錯誤歸因** |
| Attribution Engine | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增函數 |
| Type A/B/C/D分類 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增函數 |
| Evidence pointers | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增函數 |
| **D. 參數校準** |
| LEARNING_STATE | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增表格 |
| 權重呼吸 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增函數 |
| 閾值縮放 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增函數 |
| **E. 情境記憶** |
| SCENARIO_MEMORY | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增表格和函數 |
| Safety Lock | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增函數 |
| **F. 工程限制** |
| 唯一可回寫檔 | ✅ 已設計 | ⚠️ 部分遵守 | ⚠️ 需強化 | 需要檢查所有參數寫入點 |
| 回寫頻率限制 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增檢查機制 |
| Safety Lock不硬鎖 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要確保設計原則 |
| 歸因無證據標記 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要新增檢查機制 |
| Claims才評分 | ✅ 已設計 | ❌ 未實現 | ⏳ 待實現 | 需要修改評分邏輯 |

---

## 🚀 下一步實施計劃

### 優先級1（核心功能）

1. **實現STRATEGY_SNAPSHOT和OUTCOME_SNAPSHOT**
   - 新增表格Schema
   - 實現創建函數
   - 實現Claims結構化函數

2. **完善策略比對機制（四項Scorecard）**
   - 補充時機偏差計算
   - 補充幅度偏差計算
   - 補充最大回撤計算

3. **實現錯誤歸因引擎**
   - 實現Attribution Engine函數
   - 實現Type A/B/C/D分類
   - 實現Evidence pointers提取

### 優先級2（參數校準）

4. **實現LEARNING_STATE**
   - 新增表格Schema
   - 實現權重呼吸函數
   - 實現閾值縮放函數
   - 實現回寫頻率限制檢查

### 優先級3（情境記憶）

5. **實現SCENARIO_MEMORY和Safety Lock**
   - 新增表格Schema
   - 實現情境簽章提取函數
   - 實現Safety Lock建議函數

---

## ⚠️ 防遺漏機制

### 更新SSOT的標準流程

**每次更新SSOT前必須執行**：

1. **讀取V7設計文檔**（本文件）
   - 確認所有V7設計都被記錄
   - 標記缺失的項目

2. **對照檢查**
   - 確認每個V7設計都在SSOT中
   - 標記已實現/待實現狀態

3. **執行更新**
   - 保留所有V7設計（絕對不能刪除或忽略）
   - 只能補充或修正
   - 標記來源版本（V7設計）

4. **更新後驗證**
   - 再次對照V7設計文檔
   - 確認所有設計都保留

**詳細說明**：請參考 `V8.0架構定案文檔_SSOT.md` 的「⚠️ 防遺漏機制」章節

---

**此文檔為V7設計的完整記錄，必須完整保留，不得遺漏任何細節。**
