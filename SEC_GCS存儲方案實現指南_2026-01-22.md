# SEC GCS å­˜å„²æ–¹æ¡ˆå¯¦ç¾æŒ‡å—

**ç‰ˆæœ¬**ï¼šV8.17.1  
**æ—¥æœŸ**ï¼š2026-01-22  
**ç‹€æ…‹**ï¼šâœ… å·²å¾ä¸»ç¨‹å¼ç¢¼é‚„åŸ

---

## ğŸ“‹ æ¦‚è¿°

GCSï¼ˆGoogle Cloud Storageï¼‰å­˜å„²æ–¹æ¡ˆç”¨æ–¼å°‡ SEC è²¡å ±æª”æ¡ˆå­˜å„²åˆ° Google Cloud Storageï¼Œä»¥ä¾¿å¾ŒçºŒ Flash æå–åŠŸèƒ½ä½¿ç”¨ã€‚æœ¬æ–‡æª”èªªæ˜ GCS å­˜å„²çš„å¯¦ç¾æ–¹å¼å’Œé…ç½®æ­¥é©Ÿã€‚

---

## ğŸ—ï¸ ä¸€ã€æ¶æ§‹è¨­è¨ˆ

### æ•¸æ“šæµ

```
SEC ç¶²ç«™
  â†“
Cloud Run ä»£ç†ï¼ˆ/store ç«¯é»ï¼‰
  â†“
GCS Bucketï¼ˆsec-financial-reportsï¼‰
  â†“
Flash æå–åŠŸèƒ½ï¼ˆå¾ GCS è®€å–ï¼‰
```

### å­˜å„²è·¯å¾‘çµæ§‹

```
gs://sec-financial-reports/
  â””â”€â”€ sec/
      â””â”€â”€ {cik}/
          â””â”€â”€ {accession_no_dashes}/
              â””â”€â”€ {filename}
```

**ç¯„ä¾‹**ï¼š
```
gs://sec-financial-reports/sec/320193/000032019324000001/aapl-20240930.htm
```

---

## ğŸ”§ äºŒã€GCS Bucket è¨­ç½®

### 1. å‰µå»º GCS Bucket

**Bucket åç¨±**ï¼š`sec-financial-reports`ï¼ˆæˆ–è‡ªå®šç¾©ï¼‰

**è¨­ç½®æ­¥é©Ÿ**ï¼š
1. æ‰“é–‹ Google Cloud Console
2. å°èˆªåˆ° Cloud Storage
3. å‰µå»ºæ–° Bucket
4. è¨­ç½® Bucket åç¨±ï¼š`sec-financial-reports`
5. é¸æ“‡å€åŸŸï¼š`asia-east1`ï¼ˆèˆ‡ Cloud Run ç›¸åŒå€åŸŸï¼‰

### 2. è¨­ç½®å…¬é–‹æ¬Šé™ï¼ˆå¯é¸ï¼‰

**èªªæ˜**ï¼šå¦‚æœ Bucket è¨­ç½®ç‚ºå…¬é–‹ï¼Œå¯ä»¥ç›´æ¥é€šéå…¬é–‹ URL è¨ªå•æª”æ¡ˆï¼Œç„¡éœ€é€šé Cloud Run ä»£ç†ã€‚

**è¨­ç½®æ­¥é©Ÿ**ï¼š
1. åœ¨ Bucket è¨­ç½®ä¸­ï¼Œé»æ“Šã€Œæ¬Šé™ã€æ¨™ç±¤
2. æ·»åŠ ã€Œæ‰€æœ‰ä½¿ç”¨è€…ã€è§’è‰²
3. æˆäºˆã€ŒStorage Object Viewerã€æ¬Šé™

**âš ï¸ æ³¨æ„**ï¼šå…¬é–‹ Bucket æœƒè®“æ‰€æœ‰æª”æ¡ˆå¯å…¬é–‹è¨ªå•ï¼Œè«‹æ ¹æ“šå®‰å…¨éœ€æ±‚æ±ºå®šæ˜¯å¦å…¬é–‹ã€‚

### 3. Cloud Run æœå‹™å¸³è™Ÿæ¬Šé™

**èªªæ˜**ï¼šCloud Run æœå‹™éœ€è¦å¯«å…¥ GCS çš„æ¬Šé™ã€‚

**è¨­ç½®æ­¥é©Ÿ**ï¼š
1. åœ¨ Cloud Run æœå‹™è¨­ç½®ä¸­ï¼Œæ‰¾åˆ°ã€Œæœå‹™å¸³è™Ÿã€
2. é¸æ“‡å…·æœ‰ `Storage Object Admin` è§’è‰²çš„æœå‹™å¸³è™Ÿ
3. æˆ–å‰µå»ºæ–°çš„æœå‹™å¸³è™Ÿä¸¦æˆäºˆç›¸æ‡‰æ¬Šé™

---

## ğŸ’» ä¸‰ã€ä¸»ç¨‹å¼å¯¦ç¾

### 1. å­˜å„²åˆ° GCS

**å‡½æ•¸**ï¼š`fetchSECArchivesToGCS_()`

**ä½ç½®**ï¼š`src/20_P1_FINANCIAL_REPORTS.js`

**å¯¦ç¾æ–¹å¼**ï¼š
```javascript
function fetchSECArchivesToGCS_(url, cik, accessionNoDashes, filename, type = "html") {
  const properties = PropertiesService.getScriptProperties();
  const cloudRunUrl = properties.getProperty("CLOUD_FUNCTION_SEC_URL");
  
  if (!cloudRunUrl) {
    Logger.log("P1 è²¡å ±ï¼šCloud Run ä»£ç† URL æœªè¨­ç½®ï¼Œç„¡æ³•ä½¿ç”¨ GCS å­˜å„²");
    return null;
  }
  
  try {
    Utilities.sleep(SEC_SLEEP_MS);
    
    // é€šé Cloud Run ä»£ç†å­˜å„²åˆ° GCS
    const response = UrlFetchApp.fetch(`${cloudRunUrl}/store`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      payload: JSON.stringify({
        url: url,
        cik: cik,
        accession_no_dashes: accessionNoDashes,
        filename: filename,
        type: type
      }),
      muteHttpExceptions: true,
      timeout: 60000
    });
    
    const code = response.getResponseCode();
    if (code !== 200) {
      const errorText = response.getContentText().substring(0, 500);
      Logger.log(`P1 è²¡å ±ï¼šGCS å­˜å„²å¤±æ•—ï¼ˆHTTP ${code}ï¼‰ï¼ŒURL=${url}`);
      Logger.log(`P1 è²¡å ±ï¼šéŒ¯èª¤å…§å®¹å‰ 500 å­—ç¬¦ï¼š${errorText}`);
      return null;
    }
    
    const result = JSON.parse(response.getContentText());
    Logger.log(`P1 è²¡å ±ï¼šæˆåŠŸå­˜å„²åˆ° GCSï¼Œè·¯å¾‘=${result.gs_path}`);
    return result;  // { gs_path, public_url, path }
  } catch (error) {
    Logger.log(`P1 è²¡å ±ï¼šGCS å­˜å„²å¤±æ•—ï¼š${error.message}`);
    return null;
  }
}
```

**è¿”å›å€¼**ï¼š
```javascript
{
  gs_path: "gs://sec-financial-reports/sec/320193/000032019324000001/aapl-20240930.htm",
  public_url: "https://storage.googleapis.com/sec-financial-reports/sec/320193/000032019324000001/aapl-20240930.htm",
  path: "sec/320193/000032019324000001/aapl-20240930.htm"
}
```

### 2. å¾ GCS è®€å–

**å‡½æ•¸**ï¼š`readFileFromGCSPublicUrl()`

**ä½ç½®**ï¼š`src/20_P1_FINANCIAL_REPORTS.js`

**å¯¦ç¾æ–¹å¼**ï¼ˆä¸‰ç¨®æ–¹æ³•ï¼ŒæŒ‰å„ªå…ˆç´šï¼‰ï¼š

#### æ–¹æ³• 1ï¼šå¾å…¬é–‹ URL è®€å–ï¼ˆå¦‚æœ Bucket æ˜¯å…¬é–‹çš„ï¼‰

```javascript
try {
  const response = UrlFetchApp.fetch(publicUrl, {
    method: "GET",
    timeout: 30000,
    muteHttpExceptions: true
  });
  
  if (response.getResponseCode() === 200) {
    const content = response.getContentText();
    Logger.log(`P1 è²¡å ±ï¼šæˆåŠŸå¾ GCS å…¬é–‹ URL è®€å–æ–‡ä»¶ï¼Œé•·åº¦=${content.length} å­—ç¬¦`);
    return content;
  }
} catch (error) {
  // å¤±æ•—æ™‚å˜—è©¦æ–¹æ³• 2
}
```

#### æ–¹æ³• 2ï¼šé€šé Cloud Run ä»£ç†å¾ GCS è®€å–ï¼ˆæ¨è–¦ï¼‰

```javascript
const cloudRunUrl = properties.getProperty("CLOUD_FUNCTION_SEC_URL");
if (cloudRunUrl && gcsPath) {
  const proxyUrl = `${cloudRunUrl}/read-gcs?gcs_path=${encodeURIComponent(gcsPath)}`;
  const response = UrlFetchApp.fetch(proxyUrl, {
    method: "GET",
    timeout: 60000,
    muteHttpExceptions: true
  });
  
  if (response.getResponseCode() === 200) {
    const content = response.getContentText();
    Logger.log(`P1 è²¡å ±ï¼šé€šé Cloud Run ä»£ç†æˆåŠŸå¾ GCS è®€å–æ–‡ä»¶ï¼Œé•·åº¦=${content.length} å­—ç¬¦`);
    return content;
  }
}
```

#### æ–¹æ³• 3ï¼šå›é€€åˆ°å¾ SEC é‡æ–°ä¸‹è¼‰ï¼ˆæœ€å¾Œæ‰‹æ®µï¼‰

```javascript
// å¦‚æœ GCS è®€å–å¤±æ•—ï¼Œå¾ SEC é‡æ–°ä¸‹è¼‰
const secUrl = `https://www.sec.gov/Archives/edgar/data/${cik}/${accessionNoDashes}/${filename}`;
const proxyUrl = `${cloudRunUrl}/?url=${encodeURIComponent(secUrl)}&type=html`;
// ...
```

---

## ğŸ”— å››ã€èˆ‡ Flash æå–åŠŸèƒ½çš„æ•´åˆ

### Flash æå–æµç¨‹

1. **P1 Step1**ï¼šä¸‹è¼‰è²¡å ±ä¸¦å­˜å„²åˆ° GCS
   ```javascript
   const gcsResult = fetchSECArchivesToGCS_(url, cik, accessionNoDashes, filename, "html");
   // è¿”å›ï¼š{ gs_path, public_url, path }
   ```

2. **Flash æå–**ï¼šå¾ GCS è®€å–æª”æ¡ˆ
   ```javascript
   const fileUri = gcsResult.gs_path;  // gs://sec-financial-reports/sec/...
   const content = readFileFromGCSPublicUrl(gcsResult.public_url, fileUri);
   ```

3. **Gemini æå–**ï¼šé€šé Cloud Run ä»£ç†æå–
   ```javascript
   const extractUrl = `${cloudRunUrl}/gemini-extract`;
   const response = UrlFetchApp.fetch(extractUrl, {
     method: "POST",
     payload: JSON.stringify({
       file_uri: fileUri,  // gs:// æ ¼å¼
       ticker: ticker,
       market: market,
       filing_period: filingPeriod
     })
   });
   ```

---

## âš™ï¸ äº”ã€ç’°å¢ƒè®Šæ•¸è¨­ç½®

### Cloud Run æœå‹™ç’°å¢ƒè®Šæ•¸

åœ¨éƒ¨ç½² Cloud Run æœå‹™æ™‚ï¼Œéœ€è¦è¨­ç½®ä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼š

```bash
GCS_BUCKET_NAME="sec-financial-reports"
SEC_USER_AGENT="HSIUNG (jalano0i9u8y7@gmail.com)"
SEC_SLEEP_MS=200
```

**è¨­ç½®æ–¹å¼**ï¼ˆåœ¨ `deploy_cloud_shell.sh` ä¸­ï¼‰ï¼š
```bash
gcloud run deploy sec-cloud-run-proxy \
  --set-env-vars SEC_USER_AGENT="HSIUNG (jalano0i9u8y7@gmail.com)",SEC_SLEEP_MS=200,GCS_BUCKET_NAME="sec-financial-reports"
```

---

## ğŸ“ å…­ã€ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1ï¼šä¸‹è¼‰ä¸¦å­˜å„²è²¡å ±

```javascript
// åœ¨ P1 Step1 ä¸­
const cik = "320193";
const accessionNoDashes = "000032019324000001";
const filename = "aapl-20240930.htm";
const secUrl = `https://www.sec.gov/Archives/edgar/data/${cik}/${accessionNoDashes}/${filename}`;

// å­˜å„²åˆ° GCS
const gcsResult = fetchSECArchivesToGCS_(secUrl, cik, accessionNoDashes, filename, "html");

if (gcsResult) {
  Logger.log(`âœ… æˆåŠŸå­˜å„²åˆ° GCSï¼š${gcsResult.gs_path}`);
  Logger.log(`å…¬é–‹ URLï¼š${gcsResult.public_url}`);
} else {
  Logger.log("âŒ GCS å­˜å„²å¤±æ•—");
}
```

### ç¯„ä¾‹ 2ï¼šå¾ GCS è®€å–æª”æ¡ˆ

```javascript
const publicUrl = "https://storage.googleapis.com/sec-financial-reports/sec/320193/000032019324000001/aapl-20240930.htm";
const gcsPath = "gs://sec-financial-reports/sec/320193/000032019324000001/aapl-20240930.htm";

const content = readFileFromGCSPublicUrl(publicUrl, gcsPath);

if (content) {
  Logger.log(`âœ… æˆåŠŸè®€å–æª”æ¡ˆï¼Œé•·åº¦=${content.length} å­—ç¬¦`);
} else {
  Logger.log("âŒ è®€å–å¤±æ•—");
}
```

---

## âš ï¸ ä¸ƒã€å¸¸è¦‹å•é¡Œ

### å•é¡Œ 1ï¼šGCS å­˜å„²å¤±æ•—ï¼ˆHTTP 403ï¼‰

**åŸå› **ï¼š
- Cloud Run æœå‹™å¸³è™Ÿæ²’æœ‰å¯«å…¥ GCS çš„æ¬Šé™

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥ Cloud Run æœå‹™å¸³è™Ÿ
2. æˆäºˆ `Storage Object Admin` è§’è‰²

### å•é¡Œ 2ï¼šç„¡æ³•å¾ GCS è®€å–ï¼ˆHTTP 403ï¼‰

**åŸå› **ï¼š
- Bucket ä¸æ˜¯å…¬é–‹çš„ï¼Œä¸” Cloud Run ä»£ç†æ²’æœ‰è®€å–æ¬Šé™

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æ–¹æ³• 1ï¼šè¨­ç½® Bucket å…¬é–‹æ¬Šé™
2. æ–¹æ³• 2ï¼šç¢ºä¿ Cloud Run æœå‹™å¸³è™Ÿæœ‰ `Storage Object Viewer` æ¬Šé™

### å•é¡Œ 3ï¼šæª”æ¡ˆè·¯å¾‘éŒ¯èª¤

**åŸå› **ï¼š
- GCS è·¯å¾‘æ ¼å¼ä¸æ­£ç¢º

**æ­£ç¢ºæ ¼å¼**ï¼š
```
gs://bucket-name/sec/{cik}/{accession_no_dashes}/{filename}
```

**æª¢æŸ¥æ–¹å¼**ï¼š
- ç¢ºèª `gs_path` ä»¥ `gs://` é–‹é ­
- ç¢ºèªè·¯å¾‘ä¸­åŒ…å« `sec/` å‰ç¶´

---

## ğŸ“š å…«ã€ç›¸é—œæª”æ¡ˆ

- **å¯¦ç¾å‡½æ•¸**ï¼š`src/20_P1_FINANCIAL_REPORTS.js`
  - `fetchSECArchivesToGCS_()`
  - `readFileFromGCSPublicUrl()`
- **Cloud Run éƒ¨ç½²**ï¼š`sec-cloud-run-proxy/deploy_cloud_shell.sh`
- **ä»£ç†è¨­ç½®**ï¼š`SEC_CloudRunä»£ç†GASè¨­ç½®æ­¥é©Ÿ_2026-01-22.md`

---

## âœ… ä¹ã€æª¢æŸ¥æ¸…å–®

### GCS Bucket è¨­ç½®
- [ ] Bucket å·²å‰µå»ºï¼ˆåç¨±ï¼š`sec-financial-reports`ï¼‰
- [ ] Bucket å€åŸŸè¨­ç½®ç‚º `asia-east1`
- [ ] Cloud Run æœå‹™å¸³è™Ÿæœ‰å¯«å…¥æ¬Šé™
- [ ] ï¼ˆå¯é¸ï¼‰Bucket å…¬é–‹æ¬Šé™å·²è¨­ç½®

### Cloud Run ç’°å¢ƒè®Šæ•¸
- [ ] `GCS_BUCKET_NAME` å·²è¨­ç½®
- [ ] `SEC_USER_AGENT` å·²è¨­ç½®
- [ ] `SEC_SLEEP_MS` å·²è¨­ç½®

### GAS é…ç½®
- [ ] `CLOUD_FUNCTION_SEC_URL` å·²è¨­ç½®ï¼ˆé€šé `setupSECProxy()`ï¼‰
- [ ] æ¸¬è©¦å­˜å„²åŠŸèƒ½ï¼šåŸ·è¡Œ P1 Step1 æ¸¬è©¦
- [ ] æ¸¬è©¦è®€å–åŠŸèƒ½ï¼šåŸ·è¡Œ Flash æå–æ¸¬è©¦

---

**å»ºç«‹æ™‚é–“**ï¼š2026-01-28  
**é‚„åŸä¾†æº**ï¼šä¸»ç¨‹å¼ç¢¼ï¼ˆ`src/20_P1_FINANCIAL_REPORTS.js`ï¼‰
