# V8.13 系統測試架構重點摘要

**日期**：2026-01-19  
**狀態**：📋 討論階段 → 準備執行

---

## 🎯 測試總體目標

確保系統在**真實市場環境**（噪音、假消息、數據衝突、極端事件）下，仍能：
1. ✅ **不被騙** - 不因假消息/情緒操縱而誤判
2. ✅ **不亂下結論** - 承認不確定性，不強行編故事
3. ✅ **嚴守分工** - Daily/Weekly/P6 各司其職，不越權
4. ✅ **高EV行為** - 主升段不被洗、崩盤不硬扛

---

## 📋 六大測試階段重點摘要

### 1. 數據源管線測試 (Data Pipeline Integrity)

**目標**：確保血管暢通，數據清洗機制運作正常

#### 1A. 資料連通性與穩定性測試
- ✅ 所有API（Google/Yahoo/Stooq）連線與備援切換
- ✅ 缺值/#N/A/延遲時的正確fallback和標記
- ✅ 新聞管線多語抓取、去重、分類、標記（Hard/Semi/Narrative）
- **驗收標準**：資料乾淨、誠實、有狀態（不談AI判斷，只談資料品質）

#### 1B. 數據語意正確性測試
- ✅ US10Y是殖利率不是價格
- ✅ ETF proxy被標記為PROXY
- ✅ 新聞中的數字是否被正確標為「未驗證」
- **驗收標準**：避免數據本身對但「語意錯」

---

### 2. Prompt靈魂測試 (Prompt Engineering & Indexing)

**目標**：確保大腦（AI）認知正確，優化Token效率

#### 2A. 局部Prompt單元測試
- ✅ 每個AI節點（Daily新聞分類、Weekly策略輸出等）單獨測試
- ✅ 固定input重複跑10次，檢查output結構一致、不亂編、不越權
- **驗收標準**：AI的單元測試通過

#### 2B. 長Prompt壓力測試（⭐ 關鍵）
- ✅ 塞入大量新聞、多個板塊、多檔股票
- ✅ 檢查是否開始hallucination、忽略重要資料、結論漂移
- ✅ **優化重點**：新聞+個股索引、Daily戰略摘要（500字當日重點）
- **驗收標準**：Weekly在資料量爆炸時仍能守住邏輯

#### 2C. Prompt邊界與禁區測試
- ✅ Daily有沒有開始下結論？
- ✅ P6有沒有被誘導去「判斷趨勢」？
- ✅ Weekly有沒有回寫P0-P2？
- **驗收標準**：守住SSOT的權力分立

---

### 3. 歷史動態學習系統測試 (Memory & Evolution)

**目標**：驗證系統能從歷史學習，但避免過度擬合

#### 3A. Input覆蓋測試
- ✅ 所有歷史資料（P0/P2/P5）是否正確引入
- ✅ 有被整理、摘要、更新世界觀
- **驗收標準**：歷史資料完整性

#### 3B. Output回饋測試（⚠️ 必須加限制）
- ✅ **學習結果只能影響**：權重、風險註記、信心區間
- ✅ **不得自動改變**：核心決策邏輯
- ✅ **驗收標準**：學習=校準，不是進化
- ⚠️ **零容忍**：在回測中無敵但在未來崩潰的系統

---

### 4. 全管線暢通測試 (End-to-End Integration)

**目標**：確保P0→P5自動化鏈路無斷點

- ✅ 時序相依性測試（P0財報未更新時，P5是否能運作？）
- ✅ 中間某一節失敗時，是否能降級運行、保留關鍵輸出
- ✅ 成本與執行速度審計
- **驗收標準**：災難復原能力

---

### 5. 工作階段壓力測試 (Adversarial Stress Test) ⭐ 核心關卡

**目標**：驗證系統在極端環境下仍能維持正確判斷

#### 5A. 資訊清洗壓力測試（Flash Filter）
- **F-01**：多語垃圾廣告 vs 真財經新聞（垃圾誤放率≤1%，真新聞保留率≥95%）
- **F-02**：重複/變形去重（10家媒體轉述→1-2則，保留最完整版本）
- **F-03**：釣魚式標題（情緒誇張但內容空洞，CONFIDENCE_FLAG降低）

#### 5B. Daily新聞鑑識壓力測試（Data Integrity Gate）
- **D-01**：假重大利多+市場無反應（必須標記NARRATIVE/SEMI，MARKET_CONFIRMATION=NONE，不得越權下策略）
- **D-02**：真重大消息+市場強反應（對照組，必須標記HARD，MARKET_CONFIRMATION=STRONG）
- **D-03**：舊數據冒充新數據（時效性陷阱，DATA_RECENCY=STALE）
- **D-04**：Proxy-only情境（明確標記「數字未驗證」，不驗證精確數字）
- **D-05**：數據互相矛盾（標記CONFIDENCE_FLAG=LOW，不裁決誰對誰錯）

#### 5C. Weekly世界觀/策略壓力測試（AI核心）
- **W-01**：敘事轟炸但市場平靜（MARKET_CONFIRMATION弱→敘事降權，RISK_REGIME不被劫持）
- **W-02**：市場先動、新聞後補（以市場/板塊共振為主，承認原因未明）
- **W-03**：假利多+市場不信 vs 真利空+市場共振（清楚分級權重，策略以真利空為主軸）
- **W-04**：板塊崩 vs 單股事故（正確分類SECTOR/SYSTEMIC vs IDIO）
- **W-05**：趨勢轉折年份（逐週調整RISK_REGIME，不是一天翻臉）

#### 5D. P6盤中感測/反射壓力測試
- **P6-02**：真急殺（多資產同步，事件向量正確，若授權反射開關ON→執行反射）
- **P6-03**：假跌破/插針（雙確認機制，只做標記不動作）

#### 5E. 分工越權壓力測試（權力分立守門員）
- **A-01**：Daily越權測試（誘導下策略，必須拒絕）
- **A-02**：程式越權測試（非法規格必須被拒絕）

#### 5F. 故障/降級運行壓力測試
- **R-01**：新聞管線全掛（Weekly仍能用硬數據更新世界觀，承認新聞缺失）
- **R-02**：硬數據缺一半（輸出UNCERTAINTY上升，不做高自信激進指令）

#### 5G. 「賺錢能力」導向壓力測試（EV行為）
- **EV-01**：瘋狗浪高波動延伸（防止太早下車，不因短期噪音頻繁轉Risk-Off）
- **EV-02**：崩盤非垂直（邊跌小拉再崩，認得系統性風險未解除，不反覆抄底）

#### 5H. AI失敗模式測試（⭐ 新增核心關卡）
- ✅ 資料矛盾、新聞大量互相衝突、市場極端事件、明顯無法判斷的情況
- **驗收標準**：AI不會編故事、強行下結論、不承認不確定性
- **零容忍**：這一關沒過，系統不能上線

---

### 6. 歷史回朔模擬 (Historical Backtesting)

**目標**：行為一致性驗證（⚠️ 非績效驗證）

#### 6A. 行為一致性模擬
- ✅ 牛市：是否過度防守？
- ✅ 熊市：是否快速降權？
- ✅ 震盪市：是否過度交易？

#### 6B. 敘事反應測試
- ✅ 新聞騙局年份（例如2021-2022），系統是否被敘事牽著走？

#### 6C. 績效僅作為參考
- ✅ 用來看有沒有明顯低於指數太多
- ⚠️ **不能用來調參數**（否則會為了回測而毀掉未來）

#### 盲測方法
- **方法A**：代碼匿名化（"NVDA"→"Stock_A"，"2020"→"Year_X"）
- **方法B**：邏輯一致性（不追求模擬報酬率，追求「該跑時有跑」）

---

## 🎯 第一階段工作重點（數據源測試）

### 優先順序
1. **1A. 資料連通性測試** - 確保所有API可抓、有fallback
2. **1B. 數據語意正確性測試** - 確保數據被正確理解
3. **新聞管線測試** - Flash清洗、去重、分類、標記

### 測試項目清單
- [ ] Google/Yahoo/Stooq API連線測試
- [ ] 40+ ETF/Index硬數據錨點每日寫入測試
- [ ] 新聞管線多語抓取測試
- [ ] Flash清洗測試（垃圾廣告過濾）
- [ ] 去重機制測試（重複/變形新聞）
- [ ] 分類標記測試（Hard/Semi/Narrative）
- [ ] 數據語意驗證（US10Y、ETF proxy標記等）

---

## ⚠️ 關鍵原則

1. **零容忍項目**：
   - ❌ Daily越權下策略
   - ❌ AI編故事、強行下結論
   - ❌ 假消息被當真（市場無反應但AI興奮）
   - ❌ 數據衝突時選邊站

2. **優化重點**：
   - ✅ 新聞+個股索引（避免100次重複搜尋）
   - ✅ Daily戰略摘要（500字當日重點，節省70% Weekly Token）
   - ✅ 程式計算波動度（非AI摘要，避免細節損失）

3. **測試哲學**：
   - ✅ 行為一致性 > 績效數字
   - ✅ 邏輯正確性 > 回測報酬率
   - ✅ 未來生存率 > 過去完美度

---

## 📝 下一步行動

**準備開始第一階段：數據源測試**

1. 先執行 **1A. 資料連通性測試**
2. 再執行 **1B. 數據語意正確性測試**
3. 最後執行 **新聞管線完整測試**

**確認無誤後，開始執行第一數據流測試工作。**
