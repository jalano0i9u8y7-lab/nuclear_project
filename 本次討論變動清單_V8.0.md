# 本次討論變動清單 V8.0

**討論日期**：2026-01-17  
**決策**：採用方案 B（考慮成本，平衡方案）  
**狀態**：✅ 變動清單確認完成

---

## ✅ 已確認的主要變動

### 1. 批次規模優化
**變動內容**：
- 從原本的 5-8 家/批，改為更保守的批次規模
- **常態批次數**：**6 家/批**
- **P3/P5 Weekly 策略**：**5-6 家/批**（接近 200K 限制，必須保守）
- **P2/P2.5**：可考慮 7 家（token 較低）
- **絕對不要**：P3/P5 用 8 家

**需要實施**：
- 在批次處理邏輯中加入批次規模配置
- 根據階段和 token 需求動態調整批次規模
- 實現批次規模驗證機制（防止超過限制）

---

### 2. 批次 Prompt 優化
**變動內容**：
- 實現 Hard Isolation Rules（強制隔離規則）
- 加入 Evidence Map（證據地圖，防止混線）
- 加入 Cross-Batch Notes（跨批次備註，限制在隔離區）
- 要求 Batch QA Checklist（批次 QA 自檢表）
- 每家公司輸出上限：900–1300 tokens（硬上限）

**需要實施**：
- 更新 P2/P2.5/P3/P5 Weekly 策略的批次 Prompt
- 實現批次隔離驗證機制
- 實現輸出格式驗證

---

### 3. P0/P1 增加 Gemini 3.0 Pro 原始文件去雜訊功能
**變動內容**：
- **P0**：使用 Gemini 3.0 Pro 處理原始文件（產業報告、工程白皮書、法規原文等）→ 輸出事實型資料包 → 交給 Opus 4.5 做推理
- **P1**：少量使用 Gemini 3.0 Pro 處理長文件（10-K、年報章節、外部研究報告）→ 輸出事實條列 → 交給 Sonnet 4.5 做推理

**需要實施**：
- 實現 Gemini 3.0 Pro 原始文件去雜訊功能
- 在 P0/P1 流程中加入此步驟（條件觸發）
- 定義去雜訊的輸出格式（事實條列 + 引用標記）

---

## ⚠️ 其他需要確認/變動的地方

### 4. AI 分析批次規模配置調整（必須）
**當前狀態**：
- `24_P5_WEEKLY_STOCK_STRATEGY.js` 中 `BATCH_SIZE: 10` ❌（AI 分析批次）
- 其他 AI 分析批次處理邏輯需要檢查

**需要調整**：
- **P5 Weekly 策略批次**：從 10 家/批改為 **5-6 家/批** ⭐
- **P3 批次**：需要確認並設定為 **5-6 家/批**
- **P2/P2.5 批次**：可設為 **6-7 家/批**
- 在批次處理邏輯中加入動態批次規模配置（根據階段和 token 需求）
- 實現批次規模驗證機制（防止超過 200K 限制）

**注意**：
- `24_P5_DAILY.js` 中的 `batchSize = 10` 是**資料收集批次**（非 AI 分析），不需要調整
- 只調整 **AI 分析批次**的規模

**狀態**：⚠️ 必須變動

---

### 5. maxTokens 配置升級（必須）
**當前狀態**：所有模型配置為 `maxTokens: 8192` ❌  
**需要升級**：
```javascript
const M0_MODEL_CONFIG = {
  OPUS: {
    maxTokens: 200000,  // ⭐ 升級到 200K
    maxOutputTokens: 8000
  },
  SONNET: {
    maxTokens: 200000,  // ⭐ 升級到 200K
    maxOutputTokens: 8000
  },
  GPT: {
    maxTokens: 400000,  // ⭐ 升級到 400K（確認支援）
    maxOutputTokens: 8000
  },
  O3: {
    maxTokens: 200000,  // ⭐ 升級到 200K
    maxOutputTokens: 8000
  },
  GEMINI_PRO: {
    maxTokens: 1000000,  // ⭐ 升級到 1M（用於原始文件去雜訊）
    maxOutputTokens: 64000
  }
};
```

**狀態**：⚠️ 必須變動

---

### 6. P5_DAILY 審查者配置（需要確認）
**當前配置**：
```javascript
if (taskType === "P5_DAILY") {
  return "GEMINI_PRO";  // ⭐ Gemini Pro 審查（多語去重）
}
```

**問題**：
- P5_DAILY 執行者是 GPT（OpenAI）
- 根據「不同公司模型」原則，GPT 執行 → 應該用 Claude 審查
- 但 P5_DAILY 的特殊性（多語去重）可能需要 Gemini 的能力

**需要確認**：
- P5_DAILY 的多語去重是否必須使用 Gemini 審查？
- 如果必須，是否作為例外保留？
- 或者改用 Claude 審查，多語去重由執行者（GPT）處理？

**狀態**：⚠️ 需要確認

---

### 7. TASK_TO_EXECUTOR 配置檢查（需要新增）
**當前配置**：
```javascript
const TASK_TO_EXECUTOR = {
  "P0": "OPUS",  // ✅ 方案 B：正確
  "P0_7": "O3",  // ✅ 方案 B：正確
  "P1": "SONNET",  // ✅ 方案 B：正確
  "P2_QUARTERLY": "SONNET",  // ✅ 方案 B：正確
  "P2_MONTHLY": "SONNET",  // ✅ 方案 B：正確
  "P3": "SONNET",  // ✅ 方案 B：正確
  "P5_DAILY": "GPT",  // ✅ 方案 B：正確
  "P5_WEEKLY": "SONNET",  // ✅ 方案 B：正確
  "P5_MONTHLY": "SONNET",  // ✅ 方案 B：正確
  "P5_QUARTERLY": "SONNET"  // ✅ 方案 B：正確
};
```

**需要新增**：
- **P5_WEEKLY_STRATEGY**：`"SONNET"`（方案 B）

**狀態**：⚠️ 需要新增 P5_WEEKLY_STRATEGY

---

### 8. getAuditor 函數更新（需要調整）
**當前配置**：
```javascript
function getAuditor(taskType) {
  // P5 Daily：多語去重
  if (taskType === "P5_DAILY") {
    return "GEMINI_PRO";  // ⚠️ 需要確認是否符合不同公司原則
  }
  
  // P0.7：避免同家盲點
  if (taskType === "P0_7") {
    return "OPUS";  // ✅ 正確（o3 執行，Opus 審查）
  }
  
  // 其他全部：邏輯審查
  return "GPT";  // ✅ 正確（Claude 執行，GPT 審查）
}
```

**方案 B 推薦配置**：
```javascript
function getAuditor(taskType) {
  // P0.7：避免同家盲點
  if (taskType === "P0_7") {
    return "OPUS";  // ✅ o3（OpenAI）執行，Opus（Anthropic）審查
  }
  
  // P5 Daily：多語去重（特殊場景，需要確認）
  if (taskType === "P5_DAILY") {
    // ⚠️ 需要確認：是否保留 GEMINI_PRO 或改用 Claude？
    // 如果多語去重必須用 Gemini，則保留；否則改用 Claude
    return "GEMINI_PRO";  // 或改為 "SONNET"/"OPUS"
  }
  
  // 其他全部：GPT-5.2 審查（與 Claude 執行者不同公司）
  return "GPT";
}
```

**狀態**：⚠️ 需要確認 P5_DAILY 的審查者

---

### 9. GPT-5.2 新增功能（後續優化）
**變動內容**：
- **Delta Memory Compiler**：每週/每月用一次 GPT-5.2，把多期快照壓縮成 delta memory
- **Schema Compiler**：一次讀完 5–8 家資料包，檢查是否符合輸入 schema
- **Batch QA Gate**：全局一致性審計（可整合到現有審查流程）

**狀態**：📋 後續優化項目（不影響當前方案 B 實施）

---

### 10. 成本價格更新（可選）
**變動內容**：
- 根據用戶提供的價格表，更新 `costPer1KTokens` 配置
- GPT-5.2：Input 1.75, Output 14.0（當前配置為 0.030，需要更新）
- 其他模型的價格也需要確認

**狀態**：📋 可選優化項目

---

## 📊 變動清單總結

| 變動項目 | 優先級 | 狀態 | 備註 |
|---------|--------|------|------|
| **1. 批次規模優化** | 🔴 高 | ✅ 已確認 | 必須實施 |
| **2. 批次 Prompt 優化** | 🔴 高 | ✅ 已確認 | 必須實施 |
| **3. Gemini 原始文件去雜訊** | 🔴 高 | ✅ 已確認 | 必須實施 |
| **4. AI 分析批次規模配置調整** | 🔴 高 | ⚠️ 必須變動 | 立即實施（程式碼層面） |
| **5. maxTokens 配置升級** | 🔴 高 | ⚠️ 必須變動 | 立即實施 |
| **6. P5_DAILY 審查者確認** | 🟡 中 | ⚠️ 需要確認 | 需要決策 |
| **7. TASK_TO_EXECUTOR 新增** | 🟡 中 | ⚠️ 必須變動 | 新增 P5_WEEKLY_STRATEGY |
| **8. getAuditor 函數調整** | 🟡 中 | ⚠️ 需確認 | 待 P5_DAILY 確認後調整 |
| **9. GPT-5.2 新增功能** | 🟢 低 | 📋 後續優化 | 不影響當前實施 |
| **10. 成本價格更新** | 🟢 低 | 📋 可選 | 不影響功能 |

---

## 🎯 立即行動項目

### 必須立即實施（優先級高）

1. **升級 maxTokens 配置** ⭐⭐⭐
   - 所有模型從 8192 升級到實際 context window
   - 影響所有 AI 調用

2. **調整 AI 分析批次規模配置** ⭐⭐⭐
   - `24_P5_WEEKLY_STOCK_STRATEGY.js` 中 `BATCH_SIZE: 10` → 改為 **5-6 家/批**
   - 檢查並調整 P2/P2.5/P3 的 AI 分析批次規模
   - 實現批次規模配置邏輯（根據階段和 token 需求動態調整）
   - 實現批次規模驗證機制（防止超過 200K 限制）

3. **更新批次 Prompt** ⭐⭐⭐
   - 實現 Hard Isolation Rules
   - 加入 Evidence Map 和 Batch QA Checklist
   - 更新 P2/P2.5/P3/P5 Weekly 策略的批次 Prompt

4. **實現 Gemini 原始文件去雜訊功能** ⭐⭐
   - P0/P1 流程中加入此步驟
   - 定義輸出格式（事實條列 + 引用標記）

### 需要確認後實施（優先級中）

5. **確認 P5_DAILY 審查者配置** ⭐⭐
   - 是否保留 GEMINI_PRO？
   - 或改用 Claude 審查？

6. **新增 P5_WEEKLY_STRATEGY 到 TASK_TO_EXECUTOR** ⭐
   - 在 `TASK_TO_EXECUTOR` 中新增 `"P5_WEEKLY_STRATEGY": "SONNET"`
   - 確保與其他配置一致

### 後續優化（優先級低）

7. **實現 GPT-5.2 新增功能**
   - Delta Memory Compiler
   - Schema Compiler
   - Batch QA Gate（可整合到現有審查流程）

8. **更新成本價格配置**
   - 根據實際價格表更新

---

## ❓ 待確認事項

### 1. P5_DAILY 審查者配置

**問題**：
- P5_DAILY 執行者是 GPT（OpenAI）
- 當前審查者是 GEMINI_PRO（Google）
- 根據「不同公司模型」原則，GPT 執行 → 應該用 Claude 審查

**選項 A**：保留 GEMINI_PRO（作為例外）
- 理由：多語去重需要 Gemini 的特殊能力
- 缺點：違反「不同公司模型」原則

**選項 B**：改用 Claude（SONNET 或 OPUS）
- 理由：符合「不同公司模型」原則
- 缺點：可能影響多語去重效果

**建議**：需要根據實際測試結果決定

---

## 📝 備註

1. **方案 B 與當前配置大致相同**：
   - TASK_TO_EXECUTOR 配置基本一致（只需新增 P5_WEEKLY_STRATEGY）
   - getAuditor 配置基本一致（只需確認 P5_DAILY）
   - 主要變動在於批次規模優化和 Prompt 優化

2. **批次規模和 Prompt 優化是核心變動**：
   - 這兩個變動對系統穩定性和批次隔離至關重要
   - 必須優先實施

3. **Gemini 原始文件去雜訊是新增功能**：
   - 不影響現有流程
   - 但可以提升 P0/P1 的資料處理效率

4. **maxTokens 升級是基礎設施變動**：
   - 影響所有 AI 調用
   - 必須立即實施

---

**文檔版本**：V1.0  
**最後更新**：2026-01-17  
**狀態**：✅ 變動清單確認完成
