# 系統數據流與結論流完整性檢查 V8.0

## 📋 執行摘要

本文檔系統性地檢查所有數據收集點和結論輸出點，確保：
1. **所有蒐集的數據都有提供給正確的模組使用**（避免數據蒐集了卻沒用）
2. **所有分析出的結論都有提供給最後決策使用**（避免分析了卻沒用到）
3. **其他可能的接口斷層**

**文檔版本**：V1.0  
**創建日期**：2025-01-14  
**狀態**：完整性檢查文檔

---

## 🔍 檢查方法

### 1. 數據收集點追蹤
- 列出所有數據收集點（P5 Daily 收集的數據）
- 追蹤每個數據的使用者
- 標記未使用或使用不明確的數據

### 2. 結論輸出點追蹤
- 列出所有分析輸出（P0-P5 的輸出）
- 追蹤每個結論的使用者
- 標記未使用或使用不明確的結論

### 3. 接口斷層檢查
- 檢查數據流是否完整
- 檢查結論流是否完整
- 檢查是否有循環依賴
- 檢查是否有數據重複收集但未使用

---

## 📊 數據收集點追蹤（P5 Daily 收集的數據）

### 1. MARKET_OHLCV_DAILY（OHLCV 數據）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily (`collectOHLCVData`) |
| **存儲位置** | `MARKET_OHLCV_DAILY` 表格 |
| **使用模組** | ✅ P3、P4、P5 Weekly/Monthly/Quarterly |
| **使用場景** | - P3 技術分析（分析新股票或重跑更新時必須使用）<br>- P4 資金配置（分析新股票或重跑更新時必須使用）<br>- P5 Daily 技術指標計算（基於 OHLCV）<br>- P5 Weekly/Monthly/Quarterly 分析（按照各模組設計的任務和世界觀時間維度取用所需資料） |
| **狀態** | ✅ **已確認所有使用場景** |
| **白名單原則** | ✅ **已確認** - 所有數據都由程式從白名單數據源獲取（stooq.com、TWSE、TPEX），不讓 AI 模型自己去找 |

**檢查結果**：
- ✅ P5 Daily 技術指標計算：使用 OHLCV 數據（通過 `calculateTechnicalIndicators`）
- ✅ P3 技術分析：**已確認** - P3 在分析新股票或重跑更新時必須使用此表格的數據
  - ✅ **已實現**：P3 的 `collectTechnicalDataFromExternalSources` 函數調用 `getHistoricalOHLCV` 讀取歷史 OHLCV 數據
  - ✅ **優先讀取表格**：優先從 `MARKET_OHLCV_DAILY` 表格讀取（已持倉個股可以使用留存的資料）
  - ✅ **自動補充**：如果數據不足，自動從 stooq.com 補充（通過 Cloud Function 代理，使用白名單）
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料
- ✅ P4：**已確認** - P4 在分析新股票或重跑更新時必須使用最新數據

---

### 2. MARKET_INDICATORS_DAILY（技術指標）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily (`calculateTechnicalIndicators`) |
| **存儲位置** | `MARKET_INDICATORS_DAILY` 表格 |
| **使用模組** | ✅ P3、P4、P5 Weekly/Monthly/Quarterly |
| **使用場景** | - P3 技術分析（分析新股票或重跑更新時必須使用）<br>- P4 資金配置（分析新股票或重跑更新時必須使用）<br>- P5 Weekly/Monthly/Quarterly 分析（按照各模組設計的任務和世界觀時間維度取用所需資料） |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P3 技術分析：**已確認** - P3 在分析新股票或重跑更新時必須使用此表格的數據
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料
- ✅ P4：**已確認** - P4 在分析新股票或重跑更新時必須使用最新數據

---

### 3. SECTOR_ETF_DAILY（板塊 ETF 數據）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily (`collectSectorETFData`) |
| **存儲位置** | `SECTOR_ETF_DAILY` 表格 |
| **使用模組** | ✅ P5 Weekly/Monthly/Quarterly |
| **使用場景** | - P5 Weekly 板塊分析<br>- P5 Monthly/Quarterly 板塊趨勢分析<br>- 按照各模組設計的任務和世界觀時間維度取用所需資料 |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（板塊分析、板塊趨勢分析）

---

### 4. DERIVATIVES_DAILY（衍生品數據）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily (`collectDerivativesData`) |
| **存儲位置** | `DERIVATIVES_DAILY` 表格 |
| **使用模組** | ✅ P5 Weekly/Monthly/Quarterly |
| **使用場景** | - P5 Weekly 衍生品策略調整（`derivatives_strategy_adjustment`）<br>- P5 Monthly/Quarterly 衍生品分析<br>- 按照各模組設計的任務和世界觀時間維度取用所需資料 |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P5 Weekly：**已確認** - 使用此數據進行衍生品策略調整（`derivatives_strategy_adjustment`）
- ✅ P5 Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（衍生品分析）

---

### 5. SMART_MONEY_DAILY（機構級籌碼面數據）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily（13F、內部人交易、Dark Pool） |
| **存儲位置** | `SMART_MONEY_DAILY` 表格 |
| **使用模組** | ✅ P2.5、P3、P4、P5 Weekly/Monthly/Quarterly |
| **使用場景** | - P2.5 機構級籌碼分析（可以使用此數據，也可以自己收集，兩者互補）<br>- P3-P5 所有分析與決策系統使用 Smart_Money_Score 作為重要判讀因子<br>- P5 Weekly/Monthly/Quarterly 機構級分析（按照各模組設計的任務和世界觀時間維度取用所需資料） |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P2.5：**已確認** - P2.5 可以使用此數據，也可以自己收集（兩者互補）
- ✅ P3-P5：**已確認** - 所有 P3-P5 的分析與決策系統都應使用 Smart_Money_Score 作為重要判讀因子
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（機構級分析）

**⚠️ Sonnet 審查發現的問題**：
- ⚠️ **P5.3 數據收集的致命斷鏈**：P5 Daily 每日收集機構級籌碼數據，但 P2.5 只在月度/季度執行時才使用，中間有 29 天的數據完全無人使用（約 97% 的數據浪費）
- **解決方案**：調整 P5.3 收集頻率（每週收集內部人交易、每月收集 13F 持倉、每日僅保留 VIX/期權數據）+ 增加 P5 Weekly 使用

---

### 6. MACRO_DATA_DAILY（宏觀數據）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily (`collectMacroData`) |
| **存儲位置** | `MACRO_DATA_DAILY` 表格 |
| **使用模組** | ✅ P5 Daily 新聞分析 |
| **使用場景** | - P5 Daily 新聞分析（提供宏觀數據上下文）<br>- P5 Weekly/Monthly/Quarterly 宏觀分析 |
| **狀態** | ✅ **已確認：P5 Daily 新聞分析使用此數據（`macro_context_json`）** |

**檢查結果**：
- ✅ P5 Daily 新聞分析：已確認使用（通過 `macro_context_json` 欄位）
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（宏觀分析）

---

### 7. NEWS_ATOMS_DAILY（新聞原子化數據）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily (`collectNewsAtoms`) |
| **存儲位置** | `NEWS_ATOMS_DAILY` 表格 |
| **使用模組** | ✅ P5 Daily 世界觀更新、P5 Weekly/Monthly/Quarterly |
| **使用場景** | - P5 Daily 世界觀更新（生成 `WORLDVIEW_DAILY`）<br>- P5 Weekly/Monthly/Quarterly 新聞分析 |
| **狀態** | ✅ **已確認：P5 Daily 世界觀更新使用此數據** |

**檢查結果**：
- ✅ P5 Daily 世界觀更新：已確認使用（通過 `related_news_atoms_json` 欄位）
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（新聞分析）

**⚠️ Sonnet 審查發現的問題**：
- ⚠️ **P5.1 新聞原子化的無限膨脹風險**：每日新聞原子化產生大量原子條目（估計 100-500 條/日），沒有刪除機制，1 年後 = 36,500 - 182,500 條記錄，數據庫查詢速度急劇下降
- **解決方案**：實現新聞原子數據生命週期管理（高重要性保留 90 天、中重要性保留 30 天、低重要性保留 7 天、已整合到 Weekly 世界觀的壓縮歸檔）

---

### 8. WORLDVIEW_DAILY（世界觀更新）

| 項目 | 說明 |
|------|------|
| **收集來源** | P5 Daily 新聞分析（由 `NEWS_ATOMS_DAILY` 生成） |
| **存儲位置** | `WORLDVIEW_DAILY` 表格 |
| **使用模組** | ✅ P5 Weekly/Monthly/Quarterly |
| **使用場景** | - P5 Weekly 世界觀整合（統整每日世界觀更新）<br>- P5 Monthly/Quarterly 世界觀分析<br>- 按照各模組設計的任務和世界觀時間維度取用所需資料 |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P5 Weekly：**已確認** - 世界觀整合（統整每日世界觀更新）
- ✅ P5 Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（世界觀分析）

---

## 📊 其他重要數據點追蹤

### 9. HUMAN_SIGNAL（使用者信號輸入）

| 項目 | 說明 |
|------|------|
| **收集來源** | UI 使用者輸入（分析文章、新聞等資訊） |
| **存儲位置** | `HUMAN_SIGNAL` 表格 |
| **使用模組** | ⚠️ **待確認** |
| **使用場景** | - P5 Weekly/Monthly/Quarterly 分析（融入使用者提供的資訊）<br>- 作為資訊來源因子（影響分析判斷） |
| **狀態** | ⚠️ **需要確認使用場景** |

**檢查結果**：
- ✅ P5 Weekly：**已確認** - 將當週 HUMAN_SIGNAL 資訊融入世界觀+策略制定
- ✅ P5 Monthly：**已確認** - 承接四週 Weekly 結論做連貫分析，不納入新資訊，並串聯前三個月的結論做連接分析趨勢變化與偏移（月度視角，中線）
- ✅ P5 Quarterly：**已確認** - 承接三個月的 Monthly 結論做連貫分析，不納入新資訊，並串聯前兩季的結論做連接分析趨勢變化與偏移（季度視角，長線）

---

### 10. P5__CALENDAR（財經事件行事曆）

| 項目 | 說明 |
|------|------|
| **收集來源** | 數據導入（2026 全球財經事件和行業領袖財報日曆） |
| **存儲位置** | `P5__CALENDAR` 表格 |
| **使用模組** | ✅ P5 Daily、P5 Weekly |
| **使用場景** | - P5 Daily 檢查預估日期並更新<br>- P5 Weekly 根據行事曆特別列出兩週內的各事件特別應變措施，並納入綜合策略判斷<br>- P5 Monthly/Quarterly 不需要使用 |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P5 Daily：**已確認** - 檢查並更新預估日期（`P5_Calendar_CheckEstimatedDates`）
- ✅ P5 Weekly：**已確認** - 每週產生策略時，根據行事曆特別列出兩週內的各事件特別應變措施，並納入綜合策略判斷
- ✅ P5 Monthly/Quarterly：**已確認** - 不需要使用行事曆

**⚠️ Sonnet 審查發現的問題**：
- ⚠️ **P5.5 財報事件通知的重複問題**：P5.5 Daily 每日檢查財報日曆，在 14/7/3/1 日前發出通知，同一個財報發 4 次通知（用戶可能覺得太吵）
- **解決方案**：分級通知（T-14 初步預警、T-7 風險評估、T-3 最終操作決策、T-1 最後檢查）+ 通知去重（如果 T-7 已通知且無變化 → T-3 不重複通知，例外：如果籌碼面或風險評分有重大變化 → 發送更新通知）

---

### 11. PHASE_REVIEW（階段審查）

| 項目 | 說明 |
|------|------|
| **收集來源** | UI 使用者審查和確認 |
| **存儲位置** | `PHASE_REVIEW` 表格 |
| **使用模組** | ✅ P0-P4 |
| **使用場景** | - P0-P4 每個 Phase 完成後，使用者審查結果並確認是否 OK<br>- 使用者可以提出意見和調整參數（例如：P0 決定分析幾個產業面、P1 決定公司選擇比例等）<br>- 確認 OK 後才往下走下一 Phase |
| **狀態** | ✅ **已確認需要此功能** |

**檢查結果**：
- ✅ P0-P4：**已確認** - 需要使用 PHASE_REVIEW 來控制執行流程（確認 OK 後才繼續）

---

### 12. TAIWAN_ORDER_MONITOR（台股掛單監控）

| 項目 | 說明 |
|------|------|
| **收集來源** | P3/P4 輸出（Buy1/Buy2/Buy3、Stop2/Stop3） |
| **存儲位置** | `TAIWAN_ORDER_MONITOR` 表格 |
| **使用模組** | ✅ P5 Daily |
| **使用場景** | - P5 Daily 在收集台股 OHLCV 時，由程式比對（不需 AI）台股預計掛單價位清單<br>- 有觸發到的話就自動通知使用者（未來會用 GAS 中原生的 Line bot） |
| **狀態** | ✅ **已確認使用場景** |

**檢查結果**：
- ✅ P3/P4：**已確認** - 將 Buy1/Buy2/Buy3、Stop2/Stop3 寫入 TAIWAN_ORDER_MONITOR
- ✅ P5 Daily：**已確認** - 在收集台股 OHLCV 時，由程式比對（不需 AI）台股預計掛單價位清單，觸發時自動通知使用者

---

## 📈 結論輸出點追蹤（P0-P5 的分析輸出）

### 1. P0 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P0__SNAPSHOT`（`p0_output_json`） |
| **包含內容** | themes、subthemes、key_nodes、industry_chain、capital_flow |
| **使用模組** | ✅ P0.7、P1 |
| **狀態** | ✅ **已確認：P0.7 和 P1 使用 P0 快照** |

**檢查結果**：
- ✅ P0.7：使用 P0 快照（`p0_snapshot_id` 欄位）
- ✅ P1：使用 P0 快照（`p0_snapshot_id` 欄位）

---

### 2. P0.5 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P0_5__SNAPSHOT`（`p0_5_output_json`） |
| **包含內容** | industry_chain_map、supply_chain_risk |
| **使用模組** | ✅ P0、P1、P2 |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P0：**已確認** - P0 本身使用（產業鏈地圖和供應鏈風險分析）
- ✅ P1：**已確認** - P1 在選公司時使用（產業鏈地圖和供應鏈風險分析作為選公司的重要判讀因子）
- ✅ P2：**已確認** - P2 在財務安全性分析時使用（供應鏈風險分析作為財務安全性 Gate 檢查的重要判讀因子）

**⚠️ Sonnet 審查發現的問題**：
- ⚠️ **P0.5 供應鏈分析的時效性錯配**：P0.5 季度執行（3 個月一次），但供應鏈風險監控、上下游影響分析需要更及時的反應，3 個月內發生的供應鏈事件無法及時反應
- **解決方案**：將 P0.5 拆分為兩個模組：
  - 靜態部分（季度執行）：產業鏈地圖繪製、供應商財務追蹤
  - 動態部分（移至 P5 Daily）：供應鏈風險監控（每日）、上下游影響分析（事件觸發）

---

### 3. P0.7 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P0_7__SNAPSHOT`（`p0_7_output_json`） |
| **包含內容** | narrative_states、loop_dominances、time_positions、leveraged_roles |
| **使用模組** | ✅ P1 |
| **狀態** | ✅ **已確認：P1 使用 P0.7 快照** |

**檢查結果**：
- ✅ P1：使用 P0.7 快照（`p0_7_snapshot_id` 欄位）
- ✅ P1 輸出表格（`Phase1_Master_Candidates`、`Phase1_Tracking_Pool`）：包含 `P0.7_Time_Position`、`P0.7_Leveraged_Role_Type` 欄位

---

### 4. P1 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P1__SNAPSHOT` + `Phase1_Master_Candidates` + `Phase1_Tracking_Pool` + `Phase1_Rejection_Pool` |
| **包含內容** | Master_Candidates、Tracking_Pool、Rejection_Pool |
| **使用模組** | ✅ P2 |
| **狀態** | ✅ **已確認：P2 使用 P1 輸出** |

**檢查結果**：
- ✅ P2：使用 P1 輸出（`Phase1_Master_Candidates` 表格或 P1 快照）
- ✅ P2 輸出表格（`Phase2_Output`）：繼承 P1 的欄位（`Theme_Track`、`Theme_ID`、`Subtheme_ID`、`Primary_Technology_or_Node`、`Company_Code`、`Company_Name`、`Market`、`Moat_Type`、`Rerate_State`、`Role_in_Theme`、`P0.7_Time_Position`、`P0.7_Leveraged_Role_Type`）

---

### 5. P2 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P2__SNAPSHOT`（`tier_assignments_json`）+ `Phase2_Output` |
| **包含內容** | tier_assignments（CORE/STABLE_SWING/AGGRESSIVE/OPPORTUNISTIC）、Gate_Result、財務指標 |
| **使用模組** | ✅ P3、P4、P5 Weekly/Monthly/Quarterly |
| **狀態** | ✅ **已確認：P3、P4 使用 P2 快照** |

**檢查結果**：
- ✅ P3：使用 P2 輸出（`Phase2_Output` 表格）
- ✅ P4：使用 P2 快照（`p2_snapshot_id` 欄位，讀取 `tier_assignments`）
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（基本面分析參考）

**⚠️ Sonnet 審查發現的問題**：
- ⚠️ **P2/P2.5/P3 觸發鏈的競態條件**：P2（基本面）和 P2.5（籌碼面）可能不同步完成，P3 依賴兩者的輸出，沒有明確的同步機制，可能導致 P3 執行兩次或使用「舊的」Smart_Money_Score
- **解決方案**：實現統一調度器（在 P5 Weekly/Monthly 中，並行執行 P2 和 P2.5，兩者都完成後才觸發 P3）

---

### 6. P2.5 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P2_5__SNAPSHOT` + `Phase2.5_Output` |
| **包含內容** | Smart_Money_Score、Institutional_Holdings_Score、Insider_Trading_Signal、Options_Flow_Sentiment、Dark_Pool_Activity |
| **使用模組** | ✅ P3、P4、P5 Weekly/Monthly/Quarterly |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P3：**已確認** - 使用 Smart_Money_Score 作為技術分析的重要判讀因子
- ✅ P4：**已確認** - 使用 Smart_Money_Score 作為資金配置決策的重要判讀因子
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 使用 Smart_Money_Score 作為市場分析和策略調整的重要判讀因子

---

### 7. P3 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P3__SNAPSHOT`（`technical_results_json`） |
| **包含內容** | technical_results（Cat 分類、Buy1/Buy2/Buy3、Stop2/Stop3） |
| **使用模組** | ✅ P4、P5 Weekly/Monthly/Quarterly |
| **狀態** | ✅ **已確認：P4 使用 P3 快照** |

**檢查結果**：
- ✅ P4：使用 P3 快照（`p3_snapshot_id` 欄位，讀取 `technical_results`）
- ✅ P5 Weekly/Monthly/Quarterly：**已確認** - 按照各模組設計的任務和世界觀時間維度取用所需資料（技術分析參考）

---

### 8. P4 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P4__SNAPSHOT`（`allocations_json`）+ `HOLDINGS`（可能） |
| **包含內容** | allocations（資金配置結果）、summary |
| **使用模組** | ✅ P5 Daily（`getHoldingsTickers`）、P5 Weekly/Monthly/Quarterly |
| **狀態** | ✅ **已確認：P5 Daily 使用 P4 輸出** |

**檢查結果**：
- ✅ P5 Daily：使用 P4 輸出（通過 `getHoldingsTickers` 函數，讀取 `HOLDINGS` 表格或 `P4__SNAPSHOT`）
- ✅ P5 Weekly：**已確認** - 使用 P4 快照（`p4_snapshot_id` 欄位），主要使用方式：
  - 讀取 P4 最新快照（W_ideal 和 W_now）
  - 對比 W_now vs 實際持倉
  - 生成調整建議（買入建議、賣出建議、權重調整）
  - 制定掛單策略
- ✅ P5 Monthly/Quarterly：**已確認** - 使用 P4 快照，按照各模組設計的任務和世界觀時間維度取用所需資料（資金配置參考、持倉表現評估）
- ✅ 次要使用者：DEFCON 系統（如果 DEFCON 升級 → P4 重算 → 觸發減倉）、泡沫監控（如果 U 下調 → P4 重算 → 觸發減倉）

---

### 9. P5 Weekly 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P5__WEEKLY_SNAPSHOT` + `P5__WEEKLY_STOCK_STRATEGIES` + `P5__WEEKLY_STRATEGY_TRACKING` |
| **包含內容** | market_analysis、causality_chain、risk_events、derivatives_strategy_adjustment、belief_update、u_adjustment、action_list、trigger_decisions |
| **使用模組** | ✅ P4、P5 Monthly、P5 Quarterly |
| **使用場景** | - P5 Monthly 統整四週 Weekly 結論<br>- P5 Quarterly 季度回顧<br>- P4 U 調整（讀取 `u_adjustment` 來調整利用率）<br>- P4 觸發（讀取 `trigger_decisions` 來觸發重新計算） |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P5 Monthly：**已確認** - 使用 P5 Weekly 快照，統整四週 Weekly 結論
- ✅ P5 Quarterly：**已確認** - 使用 P5 Weekly 快照，季度回顧
- ✅ P4 U 調整：**已確認** - P4 讀取 P5 Weekly 的 `u_adjustment` 來調整 U（利用率）
- ✅ P4 觸發：**已確認** - P4 讀取 P5 Weekly 的 `trigger_decisions` 來觸發重新計算

---

### 10. P5 Monthly 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P5__MONTHLY_SNAPSHOT` |
| **包含內容** | monthly_trend_analysis、portfolio_performance、strategy_adjustments、institutional_insights |
| **使用模組** | ✅ P5 Quarterly |
| **使用場景** | - P5 Quarterly 月度總結（統整月度結論） |
| **狀態** | ✅ **已確認所有使用場景** |

**檢查結果**：
- ✅ P5 Quarterly：**已確認** - 使用 P5 Monthly 快照，月度總結

---

### 11. P5 Quarterly 輸出

| 項目 | 說明 |
|------|------|
| **輸出內容** | `P5__QUARTERLY_SNAPSHOT` |
| **包含內容** | quarterly_review、strategy_review、next_quarter_outlook、institutional_insights |
| **使用模組** | ✅ 觸發機制（P0、P1、P2、P2.5、P3） |
| **使用場景** | - 觸發 P0 + P1 重跑（產業面大幅度偏離檢測）<br>- 觸發 P2 重跑（公司基本面問題檢測）<br>- 觸發 P2.5 + P3 重跑（機構籌碼面/技術面大幅度偏離檢測） |
| **狀態** | ✅ **已確認所有使用場景和觸發機制** |

**檢查結果**：
- ✅ **已確認** - P5 Weekly/Monthly/Quarterly 的輸出都有觸發機制：
  - **產業面大幅度偏離**（政策轉彎、產業轉彎、瓶頸技術被突破取代等）→ 觸發 **P0 + P1** 往下跑更新
  - **公司基本面出現問題**（財務指標異常等）→ 觸發 **P2** 往下跑更新
  - **機構籌碼面/技術面大幅度偏離**（大股東轉讓持股、暗池大量交易、期權明顯偏多/空等）→ 觸發 **P2.5 + P3** 往下跑更新

**注意**：此觸發機制不僅限於 P5 Quarterly，P5 Weekly 和 P5 Monthly 也應該具備偏離檢測和觸發機制。

---

## ✅ 已確認的接口連接（所有問題已解決）

### 1. P5 Daily 數據使用 ✅

**狀態**：✅ **已確認所有使用場景**

**使用場景**：
- ✅ P3 技術分析：在分析新股票或重跑更新時必須使用 `MARKET_OHLCV_DAILY` 和 `MARKET_INDICATORS_DAILY`
- ✅ P4 資金配置：在分析新股票或重跑更新時必須使用最新數據
- ✅ P5 Weekly/Monthly/Quarterly：按照各模組設計的任務和世界觀時間維度取用所需資料

---

### 2. P2.5 輸出使用 ✅

**狀態**：✅ **已確認所有使用場景**

**使用場景**：
- ✅ P3 技術分析：使用 Smart_Money_Score 作為重要判讀因子
- ✅ P4 資金配置：使用 Smart_Money_Score 作為重要判讀因子
- ✅ P5 Weekly/Monthly/Quarterly：使用 Smart_Money_Score 作為市場分析和策略調整的重要判讀因子

---

### 3. P0.5 輸出使用 ✅

**狀態**：✅ **已確認所有使用場景**

**使用場景**：
- ✅ P0：P0 本身使用（產業鏈地圖和供應鏈風險分析）
- ✅ P1：在選公司時使用（產業鏈地圖和供應鏈風險分析作為選公司的重要判讀因子）
- ✅ P2：在財務安全性分析時使用（供應鏈風險分析作為財務安全性 Gate 檢查的重要判讀因子）

---

### 4. P5 Weekly 輸出使用 ✅

**狀態**：✅ **已確認所有使用場景**

**使用場景**：
- ✅ P4 U 調整：P4 讀取 P5 Weekly 的 `u_adjustment` 來調整 U（利用率）
- ✅ P4 觸發：P4 讀取 P5 Weekly 的 `trigger_decisions` 來觸發重新計算
- ✅ P5 Monthly：使用 P5 Weekly 快照，統整四週 Weekly 結論
- ✅ P5 Quarterly：使用 P5 Weekly 快照，季度回顧

---

### 5. P5 Monthly/Quarterly 輸出使用 ✅

**狀態**：✅ **已確認所有使用場景和觸發機制**

**使用場景**：
- ✅ P5 Quarterly：使用 P5 Monthly 快照，月度總結

**觸發機制**（P5 周/月/季更新時發現大幅度偏離）：
- ✅ **產業面大幅度偏離**（政策轉彎、產業轉彎、瓶頸技術被突破取代等）→ 觸發 **P0 + P1** 往下跑更新
- ✅ **公司基本面出現問題**（財務指標異常等）→ 觸發 **P2** 往下跑更新
- ✅ **機構籌碼面/技術面大幅度偏離**（大股東轉讓持股、暗池大量交易、期權明顯偏多/空等）→ 觸發 **P2.5 + P3** 往下跑更新

---

## ✅ 已確認的數據流和結論流

### 1. P0 → P0.7 → P1 → P2 → P3 → P4 主流程

**數據流**：
- ✅ P0 → P0.7（通過 `p0_snapshot_id`）
- ✅ P0 → P1（通過 `p0_snapshot_id`）
- ✅ P0.7 → P1（通過 `p0_7_snapshot_id`）
- ✅ P1 → P2（通過 `Phase1_Master_Candidates` 表格或 P1 快照）
- ✅ P2 → P3（通過 `Phase2_Output` 表格）
- ✅ P2 → P4（通過 `p2_snapshot_id`）
- ✅ P3 → P4（通過 `p3_snapshot_id`）

**結論流**：
- ✅ P0 的 themes/subthemes → P1 使用
- ✅ P0.7 的 Time_Position/Leveraged_Role_Type → P1 使用（並傳遞到 P2）
- ✅ P1 的 Master_Candidates → P2 使用
- ✅ P2 的 tier_assignments → P4 使用
- ✅ P3 的 technical_results（Cat、Buy1/Buy2/Buy3、Stop2/Stop3）→ P4 使用

---

### 2. P4 → P5 Daily

**數據流**：
- ✅ P4 → P5 Daily（通過 `getHoldingsTickers` 函數，讀取 `HOLDINGS` 表格或 `P4__SNAPSHOT`）

**結論流**：
- ✅ P4 的 allocations → P5 Daily 使用（決定要收集哪些股票的數據）

---

### 3. P5 Daily → P5 Daily 世界觀更新

**數據流**：
- ✅ P5 Daily 的 `NEWS_ATOMS_DAILY` → P5 Daily 世界觀更新（生成 `WORLDVIEW_DAILY`）
- ✅ P5 Daily 的 `MACRO_DATA_DAILY` → P5 Daily 新聞分析（提供宏觀數據上下文）

---

### 4. P5 Daily → P3/P4（新股票或重跑更新）

**數據流**：
- ✅ P5 Daily 的 `MARKET_OHLCV_DAILY` → P3 技術分析（分析新股票或重跑更新時必須使用）
- ✅ P5 Daily 的 `MARKET_INDICATORS_DAILY` → P3 技術分析（分析新股票或重跑更新時必須使用）
- ✅ P5 Daily 的所有數據 → P4 資金配置（分析新股票或重跑更新時必須使用最新數據）

---

### 5. P2.5 → P3/P4/P5（Smart_Money_Score）

**結論流**：
- ✅ P2.5 的 Smart_Money_Score → P3 技術分析（作為重要判讀因子）
- ✅ P2.5 的 Smart_Money_Score → P4 資金配置（作為重要判讀因子）
- ✅ P2.5 的 Smart_Money_Score → P5 Weekly/Monthly/Quarterly（作為市場分析和策略調整的重要判讀因子）

---

### 6. P0.5 → P1/P2（產業鏈和供應鏈分析）

**結論流**：
- ✅ P0.5 的產業鏈地圖和供應鏈風險分析 → P1 選公司（作為重要判讀因子）
- ✅ P0.5 的供應鏈風險分析 → P2 財務安全性分析（作為 Gate 檢查的重要判讀因子）

---

### 7. P5 Weekly → P4（U 調整和觸發）

**結論流**：
- ✅ P5 Weekly 的 `u_adjustment` → P4 U 調整（調整利用率）
- ✅ P5 Weekly 的 `trigger_decisions` → P4 觸發（觸發重新計算）

---

### 8. P5 Weekly/Monthly/Quarterly → 觸發機制

**觸發流**：
- ✅ **P5 Weekly/Monthly/Quarterly 檢測到產業面大幅度偏離**（政策轉彎、產業轉彎、瓶頸技術被突破取代等）→ 觸發 **P0 + P1** 往下跑更新
- ✅ **P5 Weekly/Monthly/Quarterly 檢測到公司基本面出現問題**（財務指標異常等）→ 觸發 **P2** 往下跑更新
- ✅ **P5 Weekly/Monthly/Quarterly 檢測到機構籌碼面/技術面大幅度偏離**（大股東轉讓持股、暗池大量交易、期權明顯偏多/空等）→ 觸發 **P2.5 + P3** 往下跑更新

**注意**：此觸發機制不僅限於 P5 Quarterly，P5 Weekly 和 P5 Monthly 也應該具備偏離檢測和觸發機制。

---

## 📝 後續實現建議

### 優先級 1（必須實現）

1. **實現 P3 使用 P5 Daily 收集的數據**
   - 修改 P3 代碼，在分析新股票或重跑更新時從 `MARKET_OHLCV_DAILY` 和 `MARKET_INDICATORS_DAILY` 讀取數據
   - 確保 P3 優先使用 P5 Daily 收集的數據，外部數據源作為備用

2. **實現 P4 使用最新數據**
   - 修改 P4 代碼，在分析新股票或重跑更新時使用最新數據（從 P5 Daily 收集的數據讀取）

3. **實現 P4 讀取 P5 Weekly 的輸出**
   - 修改 P4 代碼，讀取 P5 Weekly 的 `u_adjustment` 來調整 U（利用率）
   - 修改 P4 代碼，讀取 P5 Weekly 的 `trigger_decisions` 來觸發重新計算

4. **實現 P2.5 輸出在 P3-P5 中的使用**
   - 修改 P3 代碼，使用 Smart_Money_Score 作為技術分析的重要判讀因子
   - 修改 P4 代碼，使用 Smart_Money_Score 作為資金配置決策的重要判讀因子
   - 修改 P5 Weekly/Monthly/Quarterly 代碼，使用 Smart_Money_Score 作為市場分析和策略調整的重要判讀因子

5. **實現 P0.5 輸出在 P1-P2 中的使用**
   - 修改 P1 代碼，在選公司時使用產業鏈地圖和供應鏈風險分析
   - 修改 P2 代碼，在財務安全性分析時使用供應鏈風險分析作為 Gate 檢查的重要判讀因子

6. **實現 P5 周/月/季 觸發機制**
   - 實現 P5 Weekly/Monthly/Quarterly 的偏離檢測邏輯
   - 實現觸發機制：
     - 產業面大幅度偏離 → 觸發 P0 + P1 重跑
     - 公司基本面問題 → 觸發 P2 重跑
     - 機構籌碼面/技術面大幅度偏離 → 觸發 P2.5 + P3 重跑

7. **實現 HUMAN_SIGNAL 的使用**
   - 修改 P5 Weekly/Monthly/Quarterly 代碼，讀取 HUMAN_SIGNAL 並融入分析
   - 確保使用者提供的資訊能夠影響分析判斷（作為資訊來源因子）

8. **實現 P5__CALENDAR 的使用**
   - 修改 P5 Weekly/Monthly/Quarterly 代碼，使用財經事件和財報日期作為參考
   - 確保 P5 Daily 檢查並更新預估日期的功能正常運作
   - 在 P5 相關功能中參考歷史數據、市場反應和監控建議

9. **實現 PHASE_REVIEW 的使用**
   - 修改 P0-P4 執行流程，在每個 Phase 完成後等待使用者審查和確認
   - 確保使用者可以提出意見和調整參數（例如：P0 決定分析幾個產業面、P1 決定公司選擇比例等）
   - 確認 OK 後才繼續執行下一 Phase

10. **實現 TAIWAN_ORDER_MONITOR 的使用**
    - 修改 P3/P4 輸出，將 Buy1/Buy2/Buy3、Stop2/Stop3 寫入 TAIWAN_ORDER_MONITOR
    - 修改 P5 Daily 代碼，檢查 TAIWAN_ORDER_MONITOR 並在觸發時發送通知
    - 實現通知機制（Email/手機通知）

---

### 優先級 2（建議實現）

7. **優化 P5 Weekly/Monthly/Quarterly 數據讀取**
   - 確保 P5 Weekly/Monthly/Quarterly 按照各模組設計的任務和世界觀時間維度正確取用所需資料
   - 實現數據讀取的統一接口，避免重複代碼

---

### 優先級 3（可選）

8. **優化數據流**
   - 考慮是否有數據重複收集但未使用
   - 考慮是否有數據可以合併或簡化
   - 實現數據緩存機制，避免重複讀取

---

---

---

## ⚠️ 其他發現的接口斷層

### 6. HUMAN_SIGNAL 使用不明確

**問題**：HUMAN_SIGNAL（使用者信號輸入）的使用場景不明確。

**影響**：
- P5 Weekly/Monthly/Quarterly **是否讀取 HUMAN_SIGNAL 並融入分析？**
- 如果沒有使用場景，使用者輸入的資訊無法影響系統判斷

**建議**：
1. 確認 P5 Weekly/Monthly/Quarterly 是否讀取 HUMAN_SIGNAL
2. 如果沒有，需要補充此功能

---

### 7. P5__CALENDAR 使用不明確

**問題**：P5__CALENDAR（財經事件行事曆）的使用場景不完全明確。

**影響**：
- P5 Weekly/Monthly/Quarterly **是否使用財經事件和財報日期作為參考？**
- 如果沒有使用場景，導入的財經事件數據無法發揮作用

**建議**：
1. 確認 P5 Weekly/Monthly/Quarterly 是否使用 P5__CALENDAR
2. 如果沒有，需要補充此功能

---

### 8. PHASE_REVIEW 使用不明確

**問題**：PHASE_REVIEW（階段審查）的使用場景不明確。

**影響**：
- P0-P4 **是否使用 PHASE_REVIEW 來控制執行流程？**
- 如果沒有，階段審查功能無法發揮作用

**建議**：
1. 確認 P0-P4 是否使用 PHASE_REVIEW 來控制執行流程
2. 如果沒有，需要補充此功能

---

### 9. TAIWAN_ORDER_MONITOR 使用不明確

**問題**：TAIWAN_ORDER_MONITOR（台股掛單監控）的使用場景不明確。

**影響**：
- P5 Daily **是否檢查 TAIWAN_ORDER_MONITOR 並在觸發時發送通知？**
- 如果沒有，掛單監控功能無法發揮作用

**建議**：
1. 確認 P5 Daily 是否檢查 TAIWAN_ORDER_MONITOR 並在觸發時發送通知
2. 如果沒有，需要補充此功能

---

## ✅ 檢查完成總結

### 主要問題已解決（經用戶確認）

經過用戶確認，主要接口斷層問題都已明確：

1. ✅ **P5 Daily 數據使用**：已確認所有使用場景
   - P3 在分析新股票或重跑更新時必須使用
   - P4 在分析新股票或重跑更新時必須使用最新數據
   - P5 Weekly/Monthly/Quarterly 按照各模組設計的任務和世界觀時間維度取用所需資料

2. ✅ **P2.5 輸出使用**：已確認 Smart_Money_Score 應在所有 P3-P5 中使用
   - P3、P4、P5 Weekly/Monthly/Quarterly 都應使用 Smart_Money_Score 作為重要判讀因子

3. ✅ **P0.5 輸出使用**：已確認應在 P1-P2 中使用
   - P1 在選公司時使用產業鏈地圖和供應鏈風險分析
   - P2 在財務安全性分析時使用供應鏈風險分析作為 Gate 檢查的重要判讀因子

4. ✅ **P5 Weekly 輸出使用**：已確認
   - P4 讀取 P5 Weekly 的 `u_adjustment` 來調整 U
   - P4 讀取 P5 Weekly 的 `trigger_decisions` 來觸發重新計算
   - P5 Monthly/Quarterly 使用 P5 Weekly 快照

5. ✅ **P5 Monthly/Quarterly 觸發機制**：已確認觸發機制
   - **產業面大幅度偏離**（政策轉彎、產業轉彎、瓶頸技術被突破取代等）→ 觸發 **P0 + P1** 往下跑更新
   - **公司基本面出現問題**（財務指標異常等）→ 觸發 **P2** 往下跑更新
   - **機構籌碼面/技術面大幅度偏離**（大股東轉讓持股、暗池大量交易、期權明顯偏多/空等）→ 觸發 **P2.5 + P3** 往下跑更新

### 已確認問題（全部解決）

所有待確認問題都已得到用戶確認：

1. ✅ **HUMAN_SIGNAL 使用**：已確認
   - P5 Weekly：將當週資訊融入世界觀+策略制定
   - P5 Monthly：承接四週 Weekly 結論做連貫分析，不納入新資訊，串聯前三個月結論
   - P5 Quarterly：承接三個月 Monthly 結論做連貫分析，不納入新資訊，串聯前兩季結論

2. ✅ **P5__CALENDAR 使用**：已確認
   - P5 Weekly：每週產生策略時，根據行事曆特別列出兩週內的各事件特別應變措施，並納入綜合策略判斷
   - P5 Monthly/Quarterly：不需要使用

3. ✅ **PHASE_REVIEW 使用**：已確認需要此功能
   - P0-P4 每個 Phase 完成後，使用者審查結果並確認是否 OK，確認 OK 後才繼續

4. ✅ **TAIWAN_ORDER_MONITOR 使用**：已確認
   - P5 Daily 在收集台股 OHLCV 時，由程式比對（不需 AI）台股預計掛單價位清單，觸發時自動通知使用者（未來用 Line bot）

### 後續工作

所有確認的使用場景和觸發機制需要在代碼中實現，詳見「後續實現建議」章節。

---

---

## 🚨 Sonnet 審查報告發現的新問題

根據 Sonnet 對 V8.0 架構的審查報告，發現了以下**額外的接口斷層和架構問題**：

### 1. P5.3 數據收集的致命斷鏈 ⭐⭐⭐⭐⭐

**問題描述**：
- P5.3 每日收集機構級籌碼數據（13F、內部人交易、Dark Pool）→ 存入 `SMART_MONEY_DAILY`
- 但 P2.5 只在月度/季度執行時才使用這些數據
- **中間有 29 天的數據完全無人使用**（約 97% 的數據浪費）

**影響**：
- 每日收集 API 調用成本浪費
- 存儲空間浪費
- 約 97% 的數據從未被分析

**解決方案**：
- **方案 A（推薦）**：調整 P5.3 收集頻率
  - 每週收集：內部人交易（SEC Form 4 更新頻率為週）
  - 每月收集：13F 持倉（SEC 13F 更新頻率為季度，但中間可能有修正）
  - 每日收集：僅保留 VIX、期權數據（這些才需要每日）
- **方案 B**：增加 P5 Weekly 使用
  - 在 P5 Weekly 中增加對籌碼數據的使用（本週籌碼面異常檢測、結合籌碼面調整 DEFCON、籌碼面影響個股策略）

**✅ 用戶決策**：採用方案 A + 方案 B 組合

---

### 2. P5.1 新聞原子化的無限膨脹風險 ⭐⭐⭐⭐

**問題描述**：
- 每日新聞原子化產生大量原子條目（估計 100-500 條/日）
- **沒有刪除機制**
- 1 年後 = 36,500 - 182,500 條記錄
- 數據庫查詢速度急劇下降

**影響**：
- 存儲成本指數增長
- 查詢性能線性下降
- P5 Weekly 統整時負擔過重

**解決方案**：
- 實現新聞原子數據生命週期管理：
  - 高重要性新聞：保留 90 天
  - 中重要性新聞：保留 30 天
  - 低重要性新聞：保留 7 天
  - 已整合到 Weekly 世界觀：壓縮歸檔
- 執行時機：
  - 每日：標記過期數據
  - 每週：刪除低重要性過期數據
  - 每月：歸檔中高重要性數據

**✅ 用戶決策**：採納建議，實現新聞原子數據生命週期管理

**補充說明**：之前有討論過，蒐集的資料或是歷史世界觀快照若按照資料特性判斷失去時效性，就封存進另外新建檔案後刪除

---

### 3. P0.5 供應鏈分析的時效性錯配 ⭐⭐⭐⭐

**問題描述**：
- P0.5 季度執行（3 個月一次）
- 但供應鏈風險監控、上下游影響分析需要更及時的反應
- 3 個月內發生的供應鏈事件無法及時反應

**影響**：
- 錯失重要風險預警（例如：ASML 突然宣布訂單大減 30% → 影響 TSM → 但 P0.5 要等到 4 月才能檢測）

**解決方案**：
- 將 P0.5 拆分為兩個模組：
  - **靜態部分（季度執行）**：產業鏈地圖繪製、供應商財務追蹤
  - **動態部分（事件觸發）**：供應鏈風險監控（事件觸發，而非每日）、上下游影響分析（事件觸發）

**✅ 用戶決策**：**不同意每日監控**，認為太頻繁。重大供應鏈消息 Daily 的新聞和月度的營收蒐集通常已經涵蓋，只要多加相關消息的觸發機制即可。

**修正後的方案**：
- 保持 P0.5 季度執行（產業鏈地圖繪製、供應商財務追蹤）
- 在 P5 Daily 新聞分析中，增加供應鏈相關消息的觸發機制：
  - 監控對象：持倉公司的上下游（從 P0.5 地圖讀取）
  - 觸發條件：上下游公司重大新聞、供應鏈中斷新聞（Daily 新聞分析中檢測）
  - 執行動作：觸發通知或標記需要關注
- 月度營收蒐集時，也會涵蓋供應鏈相關信息

**建議**：不需要拆分模組，只需在 P5 Daily 新聞分析中增加供應鏈相關消息的觸發檢測邏輯

---

### 4. P5 Quarterly 重跑 P0-P4 的觸發混亂 ⭐⭐⭐

**問題描述**：
- P5 Quarterly 觸發 P0-P4 重跑 → 產生新的 Master_Candidates
- 但現有持倉可能不在新清單中
- **沒有明確的整合邏輯**

**影響**：
- 現有持倉與新清單衝突時，無法明確處理（立即清倉？標記為待觀察？繼續持有？）

**解決方案**：
- 實現 P5 Quarterly 持倉整合邏輯：
  - **Step 1：分類現有持倉**
    - A_仍在新清單：繼續持有，重新跑 P2-P4
    - B_不在新清單但 P2 基本面 OK：標記為 'Phase_Out'，逐步減倉
    - C_不在新清單且 P2 基本面弱：立即清倉
  - **Step 2：Phase_Out 策略**
    - 定義：不再加碼，但不立即清倉
    - 處理：P3 Stop Loss 設嚴格（例如 -5%），P4 權重逐週遞減（例如 -10%/週），Weekly 如技術面破位 → 立即清倉
    - 期限：最多保留 4 週
  - **Step 3：輸出**
    - 新增清單、Phase_Out 清單、繼續持有清單

**✅ 用戶決策**：接受建議，並且由 Weekly 全盤納入最終要給使用者的策略清單之中

---

### 5. P2/P2.5/P3 觸發鏈的競態條件 ⭐⭐⭐

**問題描述**：
- P2（基本面）和 P2.5（籌碼面）可能不同步完成
- P3 依賴兩者的輸出
- **沒有明確的同步機制**

**影響**：
- P3 可能執行兩次（浪費資源，且可能產生不一致）
- 或 P3 使用「舊的」Smart_Money_Score

**解決方案 A（推薦）**：統一調度器
- 在 P5 Weekly/Monthly 中，並行執行 P2 和 P2.5，兩者都完成後才觸發 P3

**解決方案 B**：依賴標記
- 在 P3_TRIGGER 中，檢查 P2 和 P2.5 的最新快照時間，兩者時間戳都 > 上次 P3 執行時間才執行

**✅ 用戶決策**：採用方案 A（統一調度器）

---

### 6. P5.5 財報事件通知的重複問題 ⭐⭐⭐

**問題描述**：
- P5.5 Daily 每日檢查財報日曆，在 14/7/3/1 日前發出通知
- **同一個財報發 4 次通知**（用戶可能覺得太吵）

**解決方案**：
- **重新定義 Daily 和 Weekly 的職責分工**：
  - **Weekly**：負責檢查財報日曆，制定兩週內的重大事件對應策略（例如：if A then B 策略）
  - **Daily**：不每日檢查日曆，僅負責監控 Weekly 制定的策略條件（例如：監控 A 是否發生），如果發生了就馬上通知使用者要做 B 的通知
  - **Daily 明確定義**：不做任何策略制定，僅有提醒功能（因為有些策略必須隨著市場動態而調整，無法用事先掛單，這就是由 daily 來提醒）

**✅ 用戶決策**：Daily 不用每日檢查日曆。兩週內的重大事件都是由 Weekly 負責對應策略。Weekly 如果制定了本週的某天 if A then B 策略，則有沒有發生 A 就是由 Daily 負責監控，發生了就馬上通知使用者要做 B 的通知。簡單來說，Daily 明確定義不做任何策略制定，僅有提醒功能而已。

---

### 7. P4 Calculator 的「幽靈輸出」問題 ⭐⭐

**問題描述**：
- P4 計算出 W_ideal 和 W_now
- **但沒有明確說明誰使用這些輸出**

**影響**：
- 如果 P5 Weekly 不使用 → P4 計算白做
- 如果只是給用戶看 → 為什麼需要每週計算？

**解決方案**：
- 明確 P4 輸出的使用鏈：
  - **主要使用者**：P5 Weekly_final
  - **使用方式**：
    - 讀取 P4 最新快照
    - 對比 W_now vs 實際持倉
    - 生成調整建議（買入建議、賣出建議、權重調整）
  - **次要使用者**：DEFCON 系統、泡沫監控

**✅ 用戶決策**：P4 Calculator 的結果就是第一次持倉跟後面動態持倉調整的依據。既然是 P0-P3 一路做下來繼承的結論，當然要採用為持倉依據。不然做那麼多 P0-P3 幹嘛？

**說明**：P4 輸出是 P0-P3 一路繼承下來的結論，必須作為持倉依據使用。

---

## ⚠️ Sonnet 審查報告的優化建議

### 建議 1: P5.2 技術指標計算的冗餘

**問題**：P5.2 每日計算技術指標（MA, MACD, RSI），但只有 P5 Weekly 和 P3 使用

**優化**：
- 分級計算：
  - 每日：僅計算 P5 Daily 必需的指標（例如收盤價相對 MA）
  - 每週：P5 Weekly 觸發時，批量計算完整指標
- 節省資源：減少計算量約 80%，減少存儲

**✅ 用戶決策**：Daily 的技術分析可以不做，或是僅用程式公式做簡易技術分析（不用 AI 模型），降低後續 Weekly 的計算負擔。之前討論過是後者（僅用程式公式做簡易技術分析）。

**說明**：Daily 已經被定位為數據與新聞蒐集，將能夠由程式公式處理的部分都由程式計算，所需 AI 算力大幅下降幾乎用不太到。

---

### 建議 2: P0.7 系統動力學的執行必要性

**疑問**：P0.7 每季度執行，輸出敘事狀態、循環主導、時間定位、槓桿角色，但這些輸出被誰使用？

**建議**：
1. 明確 P0.7 輸出如何影響 P1 選股
2. 如果影響較小 → 考慮降低頻率（半年一次）
3. 如果影響大 → 需要在 P1 中明確標註「依賴 P0.7 結論」

**✅ 用戶決策**：P0.7 當然是做給 P1 用的。數據一路繼承的設計原則嘛。

**說明**：P0.7 的輸出已被 P1 使用（Time_Position、Leveraged_Role_Type），這是數據一路繼承的設計原則，每季度執行是合理的。

---

### 建議 3: P5 Monthly 學習機制的實現細節

**問題**：P5 Monthly 回顧 Weekly 策略與實際偏移度，但如何量化「偏移度」？如何「學習」？

**需要補充的實現細節**：
- 數據收集：每週記錄預測 vs 實際的差異
- 偏差量化：方向偏差、幅度偏差、時機偏差
- 學習調整：權重調整、閾值調整、模式識別
- 實現方式：簡單版（規則引擎 + 人工調參）或進階版（機器學習模型）

**✅ 用戶決策**：學習的部分應該要用 AI 模型，因為涉及複雜推理跟因果邏輯連結。既然是 AI 模型處理（而且系統還是雙模型），那應該只負責給歷史快照，不用自己決定權重等等的細節。但問題就是怕 AI 模型每次的思考無法一致，難以追朔。所以這就是為什麼要採取前三個月而非前一個月的原因，讓一次的偏移不會被完全繼承並擴大。

**說明**：
- 使用 AI 模型（雙模型：executor + auditor）進行學習分析
- 系統只負責提供歷史快照（前三個月的 Weekly 策略和實際結果）
- AI 模型負責複雜推理和因果邏輯連結，決定權重調整等細節
- 採用前三個月而非前一個月，避免單次偏移被完全繼承並擴大

---

### 建議 4: 數據存儲層級的明確定義

**問題**：當前架構只說明「Google Sheets」，但未明確表格清單、Schema、數據保留期限、數據清理策略

**建議**：創建獨立文檔 `V8.0_數據模型定義.md`

**✅ 用戶決策**：之前有討論過，蒐集的資料或是歷史世界觀快照若按照資料特性判斷失去時效性，就封存進另外新建檔案後刪除。

**說明**：數據清理策略已確定，需要按照資料特性判斷失去時效性後，封存進另外新建檔案後刪除。

---

### 建議 5: AI 模型成本的動態監控

**問題**：當前架構說明了 AI 模型配置，但未說明如何監控實際成本？如果超預算怎麼辦？

**建議**：
- 每日記錄：模型、調用次數、Token 消耗、成本
- 預警機制：每日預警（超過日預算 80%）、每週預警（超過周預算 → 降級使用）、每月預警（超過月預算 → 暫停非必要模組）
- 成本優化策略：緩存、批處理、降級

**✅ 用戶決策**：Daily 已經被定位為數據與新聞蒐集，將能夠由程式公式處理的部分都由程式計算，所需 AI 算力大幅下降幾乎用不太到。AI 模型最吃重的就是 Weekly，但採取 batch 的方式來降低成本。至於 P0-P3 都是月度以上執行頻率，成本影響平均不大。

**說明**：
- Daily：AI 算力大幅下降，幾乎用不太到（僅用程式公式做簡易技術分析）
- Weekly：AI 模型最吃重，但採取 batch 方式降低成本
- P0-P3：月度以上執行頻率，成本影響平均不大

---

## 📋 Sonnet 審查報告修正清單

### 立即修正（Critical）

| # | 問題 | 優先級 | 預計工時 | 負責模組 |
|---|------|--------|---------|---------|
| 1 | P5.3 籌碼數據收集頻率調整 | ⭐⭐⭐⭐⭐ | 4h | `24_P5_DAILY_DERIVATIVES.js` |
| 2 | P5.1 新聞原子生命週期管理 | ⭐⭐⭐⭐ | 6h | `24_P5_DAILY_NEWS.js` |
| 3 | P0.5 供應鏈監控移至 P5 Daily | ⭐⭐⭐⭐ | 8h | `08_P0_5_*.js` + `24_P5_DAILY_*.js` |
| 4 | P5 Quarterly 持倉整合邏輯 | ⭐⭐⭐ | 6h | `24_P5_QUARTERLY.js` |
| 5 | P2/P2.5/P3 統一調度器 | ⭐⭐⭐ | 4h | `24_P5_WEEKLY_CORE.js` |

### 次要修正（Important）

| # | 問題 | 優先級 | 預計工時 |
|---|------|--------|---------|
| 6 | P5.5 財報通知去重 | ⭐⭐⭐ | 3h |
| 7 | P4 輸出使用鏈明確化 | ⭐⭐ | 2h（文檔） |
| 8 | P5.2 技術指標分級計算 | ⭐⭐ | 4h |
| 9 | P0.7 使用者明確化 | ⭐⭐ | 1h（文檔） |
| 10 | P5 Monthly 學習機制細化 | ⭐⭐ | 8h |

### 文檔補充（Documentation）

| # | 任務 | 優先級 | 預計工時 |
|---|------|--------|---------|
| 11 | 創建數據模型定義文檔 | ⭐⭐⭐ | 6h |
| 12 | 完善數據流向圖 | ⭐⭐⭐ | 4h |
| 13 | AI 成本監控方案 | ⭐⭐ | 3h |

---

---

## 📊 完整性檢查總結

### ✅ 已確認的數據流和結論流（無斷層）

1. **P0 → P0.7 → P1 → P2 → P3 → P4 主流程**：完整
2. **P4 → P5 Daily**：完整
3. **P5 Daily → P3/P4（新股票或重跑更新）**：完整
4. **P2.5 → P3/P4/P5（Smart_Money_Score）**：完整
5. **P0.5 → P1/P2（產業鏈和供應鏈分析）**：完整
6. **P5 Weekly → P4（U 調整和觸發）**：完整
7. **P5 Weekly/Monthly/Quarterly → 觸發機制**：完整
8. **HUMAN_SIGNAL → P5 Weekly/Monthly/Quarterly**：完整
9. **P5__CALENDAR → P5 Weekly**：完整
10. **PHASE_REVIEW → P0-P4**：完整
11. **TAIWAN_ORDER_MONITOR → P5 Daily**：完整

### ⚠️ Sonnet 審查報告發現的新問題（已確認修正方案）

1. **P5.3 數據收集的致命斷鏈** ⭐⭐⭐⭐⭐（最高優先級）
   - 問題：P5 Daily 每日收集機構級籌碼數據，但 P2.5 只在月度/季度執行時才使用，約 97% 的數據浪費
   - 狀態：✅ **已確認修正方案** - 採用方案 A + 方案 B 組合（調整收集頻率 + Weekly 使用）

2. **P5.1 新聞原子化的無限膨脹風險** ⭐⭐⭐⭐
   - 問題：沒有刪除機制，1 年後可能產生 36,500 - 182,500 條記錄
   - 狀態：✅ **已確認修正方案** - 實現新聞原子數據生命週期管理，按照資料特性判斷失去時效性後封存刪除

3. **P0.5 供應鏈分析的時效性錯配** ⭐⭐⭐⭐
   - 問題：季度執行無法及時反應 3 個月內發生的供應鏈事件
   - 狀態：✅ **已確認修正方案** - 不同意每日監控，在 P5 Daily 新聞分析中增加供應鏈相關消息的觸發機制

4. **P5 Quarterly 重跑 P0-P4 的觸發混亂** ⭐⭐⭐
   - 問題：現有持倉與新清單衝突時，沒有明確的整合邏輯
   - 狀態：✅ **已確認修正方案** - 實現持倉整合邏輯，由 Weekly 全盤納入最終策略清單

5. **P2/P2.5/P3 觸發鏈的競態條件** ⭐⭐⭐
   - 問題：P2 和 P2.5 可能不同步完成，P3 可能執行兩次或使用舊數據
   - 狀態：✅ **已確認修正方案** - 採用統一調度器（並行執行 P2 和 P2.5，兩者都完成後才觸發 P3）

6. **P5.5 財報事件通知的重複問題** ⭐⭐⭐
   - 問題：同一個財報發 4 次通知（T-14, T-7, T-3, T-1）
   - 狀態：✅ **已確認修正方案** - 重新定義 Daily 和 Weekly 職責分工（Weekly 制定策略，Daily 僅監控提醒）

7. **P4 Calculator 的「幽靈輸出」問題** ⭐⭐
   - 問題：P4 輸出（W_ideal 和 W_now）的使用鏈已確認，但需要明確具體使用方式
   - 狀態：✅ **已確認** - P4 輸出是 P0-P3 一路繼承的結論，必須作為持倉依據使用

### 📋 修正優先級（已確認所有方案）

**立即修正（Critical）**：
1. ✅ P5.3 數據收集頻率調整（4h）- **方案：A + B 組合**
2. ✅ P5.1 新聞原子生命週期管理（6h）- **方案：實現生命週期管理，按時效性封存刪除**
3. ✅ P0.5 供應鏈監控觸發機制（4h）- **方案：在 Daily 新聞分析中增加觸發機制（非每日監控）**
4. ✅ P5 Quarterly 持倉整合邏輯（6h）- **方案：實現整合邏輯，由 Weekly 納入策略清單**
5. ✅ P2/P2.5/P3 統一調度器（4h）- **方案：採用統一調度器**

**次要修正（Important）**：
6. ✅ P5.5 財報通知機制重構（3h）- **方案：重新定義 Daily/Weekly 職責分工**
7. ✅ P4 輸出使用鏈明確化（2h 文檔）- **已確認：P4 輸出是持倉依據**
8. ✅ P5.2 技術指標分級計算（4h）- **方案：Daily 僅用程式公式做簡易技術分析**
9. ✅ P0.7 使用者明確化（1h 文檔）- **已確認：P0.7 做給 P1 用，數據繼承原則**
10. ✅ P5 Monthly 學習機制細化（8h）- **方案：使用 AI 模型（雙模型），提供前三個月歷史快照**

**優化建議（已確認）**：
11. ✅ 數據存儲層級定義 - **方案：按資料特性判斷失去時效性後封存刪除**
12. ✅ AI 成本監控 - **已確認：Daily 幾乎不用 AI，Weekly 用 batch，P0-P3 月度以上頻率**

---

---

## ✅ 用戶決策總結

### 核心設計原則確認

0. **機構級預測視角（P3 核心靈魂）** ⭐⭐⭐⭐⭐ **最高等級原則**
   - P3 技術分析模組的本質不是「技術分析」，而是「機構級預測」
   - 以機構主力、大型對沖基金、高盛、摩根等大機構的視角來分析
   - 目標是「預測未來」，而不是套用公式（RSI、MACD、均線等）
   - 要「成為主力的大腦」，解釋為什麼主力會做這些操作
   - 「量大於價」：量才是資金足跡，短期的價有時只是表象
   - 必須使用 P2.5 的機構級數據，以機構的視角來分析和預測
   - 詳細原則：請參考 `系統核心設計原則_V8.0.md`

1. **數據繼承原則**：P0-P3 一路做下來繼承的結論，必須作為持倉依據使用（P4 輸出）
2. **Daily 定位**：數據與新聞蒐集，不做任何策略制定，僅有提醒功能。將能夠由程式公式處理的部分都由程式計算，AI 算力大幅下降
3. **Weekly 定位**：AI 模型最吃重，負責策略制定，採取 batch 方式降低成本
4. **數據生命週期**：按照資料特性判斷失去時效性後，封存進另外新建檔案後刪除
5. **學習機制**：使用 AI 模型（雙模型）進行複雜推理，系統只提供歷史快照（前三個月），避免單次偏移被完全繼承

### 所有問題的修正方案已確認

所有 Sonnet 審查報告發現的問題都已得到用戶確認的修正方案，可以開始實施。

---

---

## 📋 用戶決策審查結果

**審查日期**：2025-01-14  
**審查結果**：✅ **所有用戶回復邏輯正確，可以採納**

### 審查總結

1. ✅ **邏輯一致性**：所有回復都符合系統設計原則（數據繼承、職責分工等）
2. ✅ **成本優化**：明確了 Daily 幾乎不用 AI，Weekly 用 batch，符合成本控制目標
3. ✅ **職責清晰**：Daily 和 Weekly 的職責分工非常明確
4. ✅ **實用性**：決策更符合實際需求（例如：供應鏈監控用觸發機制而非每日掃描）

### ⚠️ 需要注意的地方

1. **P5.2 技術指標**：需要確認現有實現是否已經符合「僅用程式公式，不用 AI 模型」的決策
   - 如果不符合，需要在實施時修改代碼

### 詳細審查報告

詳細的審查報告請參考：`用戶決策審查報告_V8.0.md`

---

**文檔版本**：V4.1（已整合用戶決策審查結果）  
**最後更新**：2025-01-14  
**狀態**：✅ 完整性檢查完成，所有問題的修正方案已確認，用戶決策已審查，可以開始實施
