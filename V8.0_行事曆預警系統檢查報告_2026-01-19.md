# V8.0 行事曆預警系統檢查報告

## 檢查日期
2026-01-19

## 檢查範圍
三大行事曆預警系統：
1. **重大財經事件預警系統**（P5__CALENDAR）
2. **板塊龍頭財報預警系統**（EARNINGS_CALENDAR）
3. **持股財報預警系統**（HOLDINGS EARNINGS）

---

## 一、重大財經事件預警系統（P5__CALENDAR）

### 1.1 監控時間設定

**檔案**：`src/18_P5_CALENDAR_MANAGER.js`

**配置**（`P5_CALENDAR_CONFIG`）：
```javascript
alert_windows: {
  WEEKLY_SCAN: 14,      // 每週掃描下兩週事件
  STRONG_ALERT: 7,      // 前7天強化分析（類似財報）
  MODERATE_ALERT: 14,   // 前14天中度提醒
  LIGHT_ALERT: 30       // 前30天輕度提醒
}
```

**監控時間點**：
- ✅ **開始監控**：事件前 30 天（LIGHT_ALERT）
- ✅ **中度提醒**：事件前 14 天（MODERATE_ALERT）
- ✅ **強化分析**：事件前 7 天（STRONG_ALERT）
- ✅ **每週掃描**：P5 Weekly 執行時掃描下兩週事件

**監控結束時間**：
- ⚠️ **未明確設定**：`P5_CALENDAR_SCHEMA` 有 `post_window` 欄位，但未在配置中明確使用
- ⚠️ **建議**：應根據 `post_window` 欄位設定監控結束時間（通常為事件後 7-14 天）

### 1.2 歷史經驗融合

**現有實現**：
- ✅ **歷史數據年數**：`historical_years: 5`（前5年歷史數據）
- ✅ **歷史數據讀取**：`getHistoricalEventData(event)` 函數存在
- ✅ **影響預測**：`predictEventImpact(event, historicalData)` 函數存在
- ⚠️ **歷史數據來源**：目前從 `P5__CALENDAR` 表格讀取，但**未包含詳細的歷史市場反應數據**

**缺失功能**：
- ❌ **歷史市場反應數據表**：沒有專門的表格存儲前後一週的歷史表現
- ❌ **歷史經驗 JSON 欄位**：`P5__CALENDAR_SCHEMA` 有 `prior_dimensions_json`，但未包含歷史市場反應的詳細數據
- ❌ **歷史經驗自動提取**：無法從歷史數據中自動提取統計規律（上漲機率、平均漲幅等）

### 1.3 事前監控與策略生成

**現有實現**：
- ✅ **每週掃描**：`P5_Calendar_ScanNextTwoWeeks()` 在 P5 Weekly 執行時調用
- ✅ **強化分析**：`P5_Calendar_IntensiveAnalysis(eventId)` 在前7天執行
- ✅ **納入策略生成**：`getP5WeeklyCalendar()` 在 `24_P5_WEEKLY_DATA.js` 中調用，並傳入 P5 Weekly 策略生成

**現有實現**（已確認）：
- ✅ **歷史經驗權重**：在 `buildP5_BUserPayloadForBatch` 和 `buildP5_AUserPayloadForBatch` 中，歷史經驗被明確標記為「最重要考量因素」
- ✅ **監控建議整合**：歷史經驗中的「追蹤建議」和「風險警示」已整合到策略生成 Prompt，並要求 AI 在 reasoning 中明確說明影響
- ✅ **自動傳遞**：`getP5WeeklyCalendar()` 會自動讀取 `P5__CALENDAR` 表格的歷史經驗數據，並傳遞給 P5 Weekly 策略生成

**使用方式**：
- 在 P5 Weekly 執行時，`getP5WeeklyCalendar()` 會自動獲取未來兩週的事件及其歷史經驗
- 歷史經驗會作為獨立章節傳遞給 AI 模型，並要求 AI 優先考慮
- 如果事件在 7 天內（STRONG_ALERT），AI 必須根據歷史表現調整策略參數

### 1.4 事後學習機制

**現有實現**：
- ✅ **學習配置**：`learning_config` 存在
  ```javascript
  learning_config: {
    weight_adjustment_window: 90,  // 事件後90天內調整權重
    min_events_for_learning: 3,    // 至少3次事件才進行學習
    confidence_threshold: 0.7      // 信心度閾值
  }
  ```
- ⚠️ **學習函數**：`getHistoricalEventData()` 和 `predictEventImpact()` 存在，但**未找到事後比對實際市場反應的函數**

**現有實現**（已確認）：
- ✅ **事後比對函數**：`P5_Calendar_LearningCorrection(eventId, actualOutcome)` 存在
- ✅ **學習更新機制**：`calculatePredictionAccuracy`、`adjustWeight`、`adjustConfidence`、`updateLearningHistory` 函數存在
- ✅ **學習日誌**：`learning_history_json` 欄位存在，`updateLearningHistory` 函數會寫入學習結果（保留最近 10 次記錄）

**使用方式**：
- 在事件發生後（例如：事件後 7 天），調用 `P5_Calendar_LearningCorrection(eventId, actualOutcome)` 進行學習修正
- `actualOutcome` 應包含 `impact`（POSITIVE/NEGATIVE/NEUTRAL）和 `magnitude`（影響幅度）
- 系統會自動計算預測準確度，調整權重和信心度，並更新學習歷史

---

## 二、板塊龍頭財報預警系統（EARNINGS_CALENDAR）

### 2.1 監控時間設定

**檔案**：`src/27_EARNINGS_REVENUE_MANAGER.js`

**配置**（`EARNINGS_REVENUE_CONFIG`）：
```javascript
trigger_days: [14, 7, 3, 1],  // 財報前 14/7/3/1 天
scan_horizon_days: 30,         // 掃描範圍30天
```

**監控時間點**：
- ✅ **開始監控**：財報前 14 天（第一次觸發）
- ✅ **強化提醒**：財報前 7 天（第二次觸發）
- ✅ **最後提醒**：財報前 3 天和 1 天（第三、四次觸發）
- ✅ **掃描範圍**：未來 30 天內的財報

**監控結束時間**：
- ⚠️ **未明確設定**：只設定觸發時間，未設定監控結束時間
- ⚠️ **建議**：應設定財報後 3-7 天為監控結束時間（用於事後學習）

### 2.2 歷史經驗融合

**現有實現**：
- ❌ **無歷史經驗功能**：`EARNINGS_REVENUE_MANAGER.js` 中未找到歷史經驗相關功能
- ❌ **無歷史數據表**：沒有專門的表格存儲財報歷史市場反應

**缺失功能**：
- ❌ **歷史財報反應數據**：無法存儲和讀取歷史財報的市場反應
- ❌ **歷史經驗統計**：無法計算歷史財報的 beat/miss 機率、平均漲跌幅等

### 2.3 事前監控與策略生成

**現有實現**：
- ✅ **自動觸發**：`scanEarningsAndRevenueDates()` 每日掃描並觸發分析
- ✅ **觸發分析**：`triggerEarningsAnalysis(trigger)` 函數存在
- ⚠️ **策略生成整合**：未明確確認是否整合到 P5 Weekly 策略生成

**缺失功能**：
- ⚠️ **歷史經驗權重**：未將歷史財報反應作為策略生成的重要考量
- ⚠️ **監控建議整合**：未將財報監控建議整合到策略生成 Prompt

### 2.4 事後學習機制

**現有實現**：
- ❌ **無事後學習功能**：未找到比對財報預測與實際市場反應的函數
- ❌ **無學習更新機制**：未找到根據比對結果更新歷史經驗的函數

**缺失功能**：
- ❌ **事後比對函數**：沒有函數比對財報預測與實際市場反應
- ❌ **學習更新機制**：沒有函數根據比對結果更新歷史經驗

---

## 三、持股財報預警系統（HOLDINGS EARNINGS）

### 3.1 監控時間設定

**現有實現**：
- ⚠️ **與 EARNINGS_CALENDAR 共用**：持股財報使用相同的 `EARNINGS_CALENDAR` 表格
- ⚠️ **無獨立配置**：沒有獨立的監控時間設定

**缺失功能**：
- ⚠️ **獨立監控配置**：持股財報可能需要更緊密的監控（例如：前 10/5/2/1 天）

### 3.2 歷史經驗融合

**現有實現**：
- ❌ **無歷史經驗功能**：與 EARNINGS_CALENDAR 相同，無歷史經驗功能

### 3.3 事前監控與策略生成

**現有實現**：
- ⚠️ **與 EARNINGS_CALENDAR 共用**：使用相同的觸發機制

### 3.4 事後學習機制

**現有實現**：
- ❌ **無事後學習功能**：與 EARNINGS_CALENDAR 相同

---

## 四、總結與建議

### 4.1 已實現功能

✅ **監控時間設定**：
- 重大財經事件：前 30/14/7 天分級提醒
- 財報事件：前 14/7/3/1 天觸發分析

✅ **事前監控**：
- 每週掃描下兩週事件
- 前 7 天強化分析
- 自動觸發機制

✅ **策略生成整合**：
- 行事曆數據傳入 P5 Weekly 策略生成

### 4.2 缺失功能（需實現）

❌ **歷史經驗數據存儲**：
- 需要創建 `P5__CALENDAR_HISTORY` 表格存儲詳細歷史市場反應
- 需要擴展 `P5__CALENDAR_SCHEMA` 添加歷史經驗 JSON 欄位

❌ **歷史經驗融合到策略生成**：
- 需要將歷史經驗作為「最重要考量因素」明確納入 P5 Weekly 策略生成 Prompt
- 需要將監控建議和風險警示整合到策略生成

❌ **事後學習機制**：
- 需要實現 `compareEventPredictionWithReality(eventId, prediction, actualMarketReaction)` 函數
- 需要實現 `updateEventLearningHistory(eventId, comparisonResult)` 函數
- 需要實現 `adjustEventWeightAndConfidence(eventId, learningResult)` 函數

❌ **監控結束時間**：
- 需要根據 `post_window` 欄位設定監控結束時間
- 需要實現事件後監控（用於事後學習）

❌ **異常通知機制**：
- 需要實現異常檢測（例如：實際市場反應與歷史經驗偏差過大）
- 需要實現通知機制（例如：寫入 `EARNINGS_NOTIFICATIONS` 表格）

---

## 五、實現建議

### 5.1 擴展 P5__CALENDAR_SCHEMA

**新增欄位**：
```javascript
"historical_performance_json",      // 歷史市場反應數據（JSON）
"monitoring_suggestions_json",      // 監控建議（JSON）
"risk_warnings_json",               // 風險警示（JSON）
"tracking_recommendations_json",     // 追蹤建議（JSON）
"post_window_monitoring_end"         // 監控結束日期
```

### 5.2 創建 P5__CALENDAR_HISTORY 表格

**Schema**：
```javascript
{
  sheetName: "P5__CALENDAR_HISTORY",
  headers: [
    "history_id",
    "event_id",
    "event_name",
    "year",
    "window_type",              // PRE_WINDOW / EVENT_DAY / POST_WINDOW
    "date_range_start",
    "date_range_end",
    "ticker_performance_json",  // {NVDA: +8.2%, TSLA: +6.5%, ...}
    "index_performance_json",   // {name: "納斯達克", change_pct: +3.1%}
    "statistics_json",          // {上漲機率: 70%, 平均漲幅: +4.2%}
    "created_at"
  ]
}
```

### 5.3 實現事後學習機制

**新增函數**：
- `compareEventPredictionWithReality(eventId, prediction, actualMarketReaction)` - 比對預測與實際
- `updateEventLearningHistory(eventId, comparisonResult)` - 更新學習歷史
- `adjustEventWeightAndConfidence(eventId, learningResult)` - 調整權重和信心度
- `detectEventAnomaly(eventId, actualReaction, historicalAverage)` - 檢測異常
- `notifyEventAnomaly(eventId, anomaly)` - 通知異常

### 5.4 整合到 P5 Weekly 策略生成

**修改位置**：`src/24_P5_WEEKLY_DUAL_LAYER.js`

**修改內容**：
- 在 `buildP5_BSystemBlocks()` 中明確強調歷史經驗的重要性
- 在 `buildP5_BUserPayloadForBatch()` 中包含詳細的歷史經驗數據
- 在 Prompt 中明確說明：「事件永遠是短期最大影響力因素，歷史經驗是最重要考量」

---

## 六、用戶提供的數據格式分析

### 6.1 數據結構

用戶提供的數據包含：
1. **事件基本信息**：名稱、日期、地點、核心焦點
2. **歷史市場表現**：
   - 前期表現（前 7-10 天）
   - 當天表現
   - 展後/會後表現（後 3-5 天）
   - 5 年歷史數據
   - 統計規律（上漲機率、平均漲幅等）
3. **追蹤建議**：
   - 監控標的
   - 技術面指標
   - 籌碼面指標
   - 消息面指標
4. **風險警示**：
   - 異常情況
   - 疊加事件風險
   - 地緣政治風險

### 6.2 導入格式設計

**建議格式**：Markdown（用戶已提供）

**解析邏輯**：
1. 解析事件標題和日期
2. 解析歷史市場表現（按年份和窗口類型分類）
3. 解析統計規律
4. 解析追蹤建議和風險警示
5. 轉換為標準 JSON 格式
6. 寫入 `P5__CALENDAR` 和 `P5__CALENDAR_HISTORY` 表格

---

## 七、下一步行動

1. ✅ **實現增強版導入工具**（`src/00_CALENDAR_ENHANCED_IMPORTER.js`）- 已完成
2. ⏳ **擴展 P5__CALENDAR_SCHEMA** - 待實現
3. ⏳ **創建 P5__CALENDAR_HISTORY 表格** - 待實現
4. ⏳ **實現事後學習機制** - 待實現
5. ⏳ **整合歷史經驗到策略生成** - 待實現
6. ⏳ **實現異常通知機制** - 待實現
