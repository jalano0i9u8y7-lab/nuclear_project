# P5 數據收集修正總結 V8.0

## 🔴 問題診斷

根據日誌分析，發現三個主要問題：

### 1. 宏觀數據問題
- **Stooq 返回 "CSV 數據不足"**：商品期貨（CL.F, GC.F, SI.F, HG.F, BRENT.F）、VIX（VI.F）、國債（10YUSY.B, 3MUSY.B）、美元指數（DX-Y.NYB）都無法從 Stooq 獲取
- **Yahoo Finance HTML 解析錯誤**：所有商品都解析到相同的價格（95149.85），這是 BTC 的價格，說明 HTML scraping 解析到錯誤的數據

### 2. 衍生品數據收集問題
- CSE 搜尋沒有返回結果（成功 0 筆）
- 缺少詳細的錯誤日誌，無法診斷問題

### 3. 數據驗證缺失
- 沒有價格合理性檢查（例如：WTI 原油 95149.85 明顯不合理）
- 沒有變動幅度檢查（-58% 的日變動不合理）
- 沒有數據污染檢測（多個 ticker 回傳相同價格）

---

## ✅ 修正內容

### 1. 宏觀數據重構

#### 1.1 改用 Yahoo Finance JSON API
- **移除 HTML scraping**，改用官方 JSON API：`https://query1.finance.yahoo.com/v7/finance/quote?symbols=CL=F`
- **優勢**：
  - 穩定且準確（不會解析到錯誤的數據）
  - 直接返回 JSON，無需解析 HTML
  - 避免數據污染（BTC 價格污染問題）

#### 1.2 Stooq 白名單化
- **保留 Stooq 僅用於**：EURUSD, GBPUSD, USDJPY, USDCHF, USDCNY（匯率，目前正常）
- **移除 Stooq 用於**：
  - 商品期貨（CL.F, GC.F, SI.F, HG.F, BRENT.F）
  - 波動率（VI.F）
  - 利率（10YUSY.B, 3MUSY.B）
  - 美元指數（DX-Y.NYB）

#### 1.3 Yahoo Finance Ticker 修正
- **Brent原油**：`BRENT=F` → `BZ=F` ✅
- **美元指數**：`DX-Y.NYB=X` → `DX-Y.NYB` ✅
- **人民幣**：`USDCNY=X` → `CNY=X` ✅

### 2. 數據驗證機制

#### 2.1 價格合理性檢查
```javascript
const reasonableRanges = {
  "CL=F": [20, 200],        // WTI原油
  "BZ=F": [20, 200],        // Brent原油
  "GC=F": [1000, 5000],     // 黃金（美元/盎司）
  "SI=F": [10, 100],        // 白銀（美元/盎司）
  "HG=F": [2, 10],          // 銅（美元/磅）
  "^VIX": [5, 100],         // VIX
  "^TNX": [0, 20],          // 10年期美債利率（%）
  "^IRX": [0, 10],          // 3個月美債利率（%）
  "DX-Y.NYB": [70, 120],    // 美元指數
  // ... 匯率範圍
};
```

#### 2.2 變動幅度檢查
- **日變動不應超過 50%**（超出視為解析錯誤）

#### 2.3 數據污染檢測
- **防止多個 ticker 回傳相同價格**（例如：95149.85）
- 追蹤已獲取的價格，如果多個 ticker 回傳相同價格，判定為數據污染

### 3. 衍生品 CSE 修正

#### 3.1 添加詳細錯誤日誌
- 檢查 `executeCSESearch` 函數是否存在
- 檢查 CSE CX ID 是否配置
- 檢查 CSE 搜尋結果的每個欄位（`output`, `search_results`, `error`）
- 記錄完整的錯誤堆疊和搜尋結果

#### 3.2 錯誤訊息改進
- 明確指出可能的原因（例如：CSE 後台配置問題）
- 提供解決建議（例如：確認 Google CSE 後台白名單配置）

---

## 📋 CSE 後台配置清單

### CSE 配置說明

#### ⚠️ V8.0 修正：不需要新增 P5_MACRO CSE

**P5_MACRO 使用現有的 P5_WORLD CSE**：
- **CSE 名稱**：`P5_WORLD`
- **CX ID 變數名**：`GOOGLE_CSE_CX_P5_WORLD`
- **CX ID**：`519d1500d22b24e31` ✅
- **已包含網域**：`fred.stlouisfed.org` ✅

**Yahoo Finance JSON API**：
- 不需要 CSE（直接 API 調用：`query1.finance.yahoo.com/v7/finance/quote`）
- 不需要在 CSE 後台新增網域

#### P5_DERIVATIVES_US CSE（美股衍生品）
**已確認配置無誤** ✅
- 白名單網域：`theocc.com`, `cboe.com`

#### P5_DERIVATIVES_TAIWAN CSE（台股衍生品）
**已確認配置無誤** ✅
- 白名單網域：`taifex.com.tw`

#### P5_DERIVATIVES_JAPAN CSE（日股衍生品）
**已確認配置無誤** ✅
- 白名單網域：`jpx.co.jp`

---

## 🔧 程式碼變更摘要

### 修改的檔案

1. **`src/24_P5_DAILY_MACRO.js`**
   - 新增 `getYahooFinanceQuoteJSON()`：使用 Yahoo Finance JSON API
   - 保留 `getYahooFinanceQuoteHTML()`：作為備用方案
   - 新增 `validateMacroData()`：數據驗證
   - 新增 `checkDataContamination()`：數據污染檢測
   - 重構 `collectCommodityPrices()`：改用 Yahoo Finance JSON API
   - 重構 `collectCurrencyRates()`：只保留 FX 使用 Stooq
   - 重構 `collectBondYields()`：改用 Yahoo Finance JSON API
   - 重構 `collectMarketIndices()`：改用 Yahoo Finance JSON API

2. **`src/24_P5_DAILY_DERIVATIVES.js`**
   - 改進錯誤處理和日誌記錄
   - 添加 CSE 配置檢查
   - 添加詳細的錯誤訊息

3. **`src/02_M0_CONFIG.js`**
   - 新增 `P5_MACRO` CSE 配置

---

## 📝 使用說明

### 1. 確認 CSE 配置

**P5_WORLD CSE**（用於宏觀數據）：
- CX ID：`519d1500d22b24e31` ✅
- 已包含 `fred.stlouisfed.org` ✅
- 設定到 `PropertiesService`：`GOOGLE_CSE_CX_P5_WORLD`

**衍生品 CSE**（已確認配置無誤）：
- `P5_DERIVATIVES_US`：`theocc.com`, `cboe.com` ✅
- `P5_DERIVATIVES_TAIWAN`：`taifex.com.tw` ✅
- `P5_DERIVATIVES_JAPAN`：`jpx.co.jp` ✅

**注意**：Yahoo Finance JSON API 不需要 CSE（直接 API 調用）

### 3. 測試

重新執行 P5 Daily，檢查：
- ✅ 宏觀數據是否正確獲取（價格合理）
- ✅ 衍生品數據是否開始有結果
- ✅ 日誌中是否有數據驗證警告

---

## ⚠️ 注意事項

1. **Yahoo Finance JSON API 限制**
   - 可能需要適當的 User-Agent
   - 如果遇到 Rate Limit，可以嘗試 `query2.finance.yahoo.com`（備用端點）

2. **數據驗證範圍**
   - 價格合理性範圍是根據歷史數據設定的，如果市場出現極端情況，可能需要調整

3. **Stooq 保留**
   - FX（匯率）仍然使用 Stooq，因為目前正常
   - 如果未來 FX 也出現問題，可以完全切換到 Yahoo Finance JSON API

---

## 🎯 預期效果

修正後應該能夠：
1. ✅ 正確獲取所有宏觀數據（價格合理，無數據污染）
2. ✅ 衍生品 CSE 搜尋有明確的錯誤訊息（如果配置有問題）
3. ✅ 自動檢測並拒絕不合理的數據（價格、變動幅度、污染）
