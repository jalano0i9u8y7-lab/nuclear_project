# 代碼修改防護規則

## ⚠️ 重要原則

**任何修改都必須遵循以下原則，避免破壞已有功能：**

### 1. 向後兼容性（Backward Compatibility）

- ✅ **必須**：新代碼必須支持舊格式的數據
- ✅ **必須**：修改函數時，保留對舊參數格式的支持
- ❌ **禁止**：直接移除或改變現有函數的參數格式
- ❌ **禁止**：假設所有數據都是新格式

**範例**：
```javascript
// ✅ 正確：支持新舊格式
let executorOutput = finalOutput.executor_output || finalOutput.output || finalOutput || {};

// ❌ 錯誤：只支持新格式
let executorOutput = finalOutput.executor_output;  // 如果沒有 executor_output 就會失敗
```

### 2. 防禦性編程（Defensive Programming）

- ✅ **必須**：檢查變數是否存在再使用
- ✅ **必須**：提供默認值（fallback）
- ✅ **必須**：處理邊界情況（null, undefined, 空對象）
- ❌ **禁止**：假設數據一定存在或格式正確

**範例**：
```javascript
// ✅ 正確：防禦性檢查
if (m0Result && m0Result.output && Object.keys(m0Result.output).length > 0) {
  // 處理結果
}

// ❌ 錯誤：假設數據存在
if (m0Result.output) {  // 如果 output 是空對象 {}，這個檢查會通過但實際沒有數據
  // 處理結果
}
```

### 3. 測試覆蓋（Test Coverage）

- ✅ **必須**：修改後測試所有相關功能
- ✅ **必須**：測試新舊格式的兼容性
- ✅ **必須**：測試邊界情況
- ❌ **禁止**：只測試新功能，忽略已有功能

### 4. 修改前檢查（Pre-Modification Checklist）

在修改任何代碼前，必須：

1. ✅ **檢查影響範圍**：哪些函數/模組會受到影響？
2. ✅ **檢查數據格式**：新舊格式是否兼容？
3. ✅ **檢查調用點**：所有調用此函數的地方是否需要更新？
4. ✅ **檢查測試**：是否有現有測試需要更新？
5. ✅ **檢查文檔**：是否需要更新文檔？

### 5. 修改後驗證（Post-Modification Verification）

修改完成後，必須：

1. ✅ **運行現有測試**：確保沒有破壞已有功能
2. ✅ **測試新功能**：確保新功能正常工作
3. ✅ **測試邊界情況**：null, undefined, 空對象等
4. ✅ **檢查日誌**：確保沒有異常錯誤

### 6. 回滾計劃（Rollback Plan）

- ✅ **必須**：每次修改前，確保可以快速回滾
- ✅ **必須**：使用版本控制（Git）記錄所有修改
- ✅ **必須**：重要修改前先備份

---

## 📋 具體規則

### M0 結果處理

**規則**：所有 Phase 的結果處理函數必須支持以下格式：

```javascript
// 新格式（V8.17.4+）
{
  executor_output: {...},
  auditor_output: {...},
  input_payload: "..."
}

// 舊格式（V8.17.4 之前）
{
  output: {...},
  executor: {...},
  auditor: {...}
}

// 更舊格式（直接是結果）
{
  company_pool: [...],
  themes: [...],
  ...
}
```

**實現**：
```javascript
// ✅ 正確：支持所有格式
let executorOutput = finalOutput.executor_output || 
                     finalOutput.output || 
                     finalOutput.executor || 
                     finalOutput || 
                     m0Result.executor_output || 
                     m0Result.output || 
                     {};

// 如果 executorOutput 為空，嘗試使用 finalOutput 本身
if (!executorOutput || (typeof executorOutput === 'object' && Object.keys(executorOutput).length === 0)) {
  if (finalOutput && (finalOutput.company_pool || finalOutput.themes)) {
    executorOutput = finalOutput;  // 舊格式：直接是結果
  }
}
```

### 快照保存

**規則**：所有快照保存函數必須檢查重複，避免重複保存。

**實現**：
```javascript
// ✅ 正確：檢查重複
if (snapshotData.job_id && sheet.getLastRow() > 1) {
  // 檢查是否已存在相同 job_id 的快照
  // 如果存在，跳過保存並返回現有快照
}
```

### 結果讀取

**規則**：所有結果讀取函數必須處理多種格式和邊界情況。

**實現**：
```javascript
// ✅ 正確：處理多種情況
const output = rows[i][outputCol];
let parsedOutput;
if (typeof output === 'string') {
  try {
    parsedOutput = JSON.parse(output);
    // 處理雙重字符串化
    if (typeof parsedOutput === 'string') {
      parsedOutput = JSON.parse(parsedOutput);
    }
  } catch (e) {
    parsedOutput = output;  // 解析失敗，使用原始值
  }
} else {
  parsedOutput = output;
}

// 檢查是否為空
if (!parsedOutput || (typeof parsedOutput === 'object' && Object.keys(parsedOutput).length === 0)) {
  Logger.log(`警告：parsedOutput 為空`);
}
```

---

## 🚫 禁止事項

1. ❌ **禁止**：直接修改核心函數的參數格式，不考慮向後兼容
2. ❌ **禁止**：假設所有數據都是最新格式
3. ❌ **禁止**：移除對舊格式的支持，除非明確標記為已棄用
4. ❌ **禁止**：只測試新功能，忽略已有功能的回歸測試
5. ❌ **禁止**：在沒有充分測試的情況下部署到 GAS

---

## ✅ 修改流程

1. **修改前**：
   - 檢查影響範圍
   - 檢查數據格式兼容性
   - 備份相關代碼

2. **修改中**：
   - 保持向後兼容
   - 添加防禦性檢查
   - 添加詳細日誌

3. **修改後**：
   - 測試所有相關功能
   - 測試新舊格式兼容性
   - 檢查日誌是否有異常
   - 確認沒有破壞已有功能

---

**創建日期**：2026-01-25  
**目的**：防止修改破壞已有功能，確保系統穩定性
