# V8.0 變動實施總結

**實施日期**：2026-01-17  
**決策**：採用方案 B（考慮成本，平衡方案）  
**狀態**：✅ 核心變動已完成

---

## ✅ 已實施的變動

### 1. maxTokens 配置升級 ⭐⭐⭐

**檔案**：`src/02_M0_CONFIG.js

**變動內容**：
- **GPT-5.2**：8192 → **400,000**（400K context window）
- **Claude Opus 4.5**：8192 → **200,000**（200K context window）
- **Claude Sonnet 4.5**：8192 → **200,000**（200K context window）
- **o3**：8192 → **200,000**（200K context window）
- **Gemini 3.0 Pro**：8192 → **1,000,000**（1M context window，用於原始文件去雜訊）
- **Gemini 2.5 Flash**：8192 → **128,000**（128K context window）
- **Gemini Search**：8192 → **200,000**（200K context window）

**狀態**：✅ 已完成

---

### 2. 成本價格更新 ⭐⭐⭐

**檔案**：`src/02_M0_CONFIG.js`

**變動內容**：
- 所有模型更新為分開的 Input/Output 價格（基於用戶提供的價格表）
- **GPT-5.2**：Input $1.75, Output $14.0
- **Claude Sonnet 4.5**：Input $3.0, Output $15.0
- **Claude Opus 4.5**：Input $5.0, Output $25.0
- **o3**：Input $2.0, Output $8.0
- **Gemini 3.0 Pro**：Input $2.0 (≤200K) / $4.0 (>200K), Output $12.0 (≤200K) / $18.0 (>200K)
- **Gemini 2.5 Flash**：Input $0.1, Output $0.4

**成本計算函數更新**：
- `estimateCost()` 函數已更新，支援分開的 Input/Output 價格
- 支援 Gemini 3.0 Pro 超過 200K 時使用不同價格

**狀態**：✅ 已完成

---

### 3. getAuditor 函數優化 ⭐⭐

**檔案**：`src/02_M0_CONFIG.js`

**變動內容**：
- 善用 GPT-5.2 的 400K context window
- P3 和 P5 Weekly 策略批次處理時，審查者使用 GPT-5.2（可處理完整上下文 + 全局 QA）
- 保留 P5_DAILY 使用 GEMINI_PRO（多語去重特殊需求）

**狀態**：✅ 已完成

---

### 4. P5 Weekly 策略批次規模調整 ⭐⭐

**檔案**：`src/24_P5_WEEKLY_STOCK_STRATEGY.js`

**變動內容**：
- `BATCH_SIZE: 10` → **`BATCH_SIZE: 6`**（常態批次數：6 家/批）
- 符合 P5 Weekly 策略 ~177K tokens 的需求

**狀態**：✅ 已完成

---

## 📋 待實施的變動（後續優化）

### 5. 批次 Prompt 優化

**需要實施**：
- 實現 Hard Isolation Rules（強制隔離規則）
- 加入 Evidence Map（證據地圖，防止混線）
- 加入 Cross-Batch Notes（跨批次備註，限制在隔離區）
- 要求 Batch QA Checklist（批次 QA 自檢表）

**檔案**：
- `src/21_P2_FUNDAMENTAL_ANALYSIS.js`（P2 批次 Prompt）
- `src/21_P2_5_PROMPT.js`（P2.5 批次 Prompt）
- `src/22_P3_AI_ANALYSIS.js`（P3 批次 Prompt）
- `src/24_P5_WEEKLY_STOCK_STRATEGY.js`（P5 Weekly 策略批次 Prompt）

**狀態**：📋 待實施

---

### 6. Gemini 原始文件去雜訊功能

**需要實施**：
- 實現 Gemini 3.0 Pro 原始文件去雜訊功能
- 在 P0/P1 流程中加入此步驟（條件觸發）
- 定義去雜訊的輸出格式（事實條列 + 引用標記）

**檔案**：
- 需要新增：`src/XX_P0_TEXT_CONDENSER.js`（或整合到 P0 流程中）
- 需要新增：`src/XX_P1_TEXT_CONDENSER.js`（或整合到 P1 流程中）

**狀態**：📋 待實施

---

### 7. 批次規模動態調整邏輯

**需要實施**：
- 根據階段和 token 需求動態調整批次規模
- 實現批次規模驗證機制（防止超過 200K 限制）
- P2/P2.5：6-7 家/批
- P3：5-6 家/批（根據實際 token 使用量）
- P5 Weekly 策略：5-6 家/批（根據實際 token 使用量）

**檔案**：
- 需要新增批次規模配置邏輯（可在 `02_M0_CONFIG.js` 或各 Phase 檔案中）

**狀態**：📋 待實施

---

## 📊 成本估算更新

**基於新批次規模（5-6 家/批）和新價格表**：

| 規模 | 月度成本（USD） | 年度成本（USD） |
|------|----------------|----------------|
| **50 檔股票** | ~$565 | ~$6,780 |
| **80 檔股票** | **$905** | **$10,861** |
| **100 檔股票** | ~$1,105 | ~$13,260 |

**主要成本來源**：
1. P5 Daily：$397.50/月（39.3%）
2. P3 系列：$179.92/月（17.8%）
3. P5 Weekly 策略：$151.03/月（14.9%）

---

## 🎯 下一步行動

### 立即行動（已完成 ✅）

1. ✅ **升級 maxTokens 配置**
2. ✅ **更新成本價格配置**
3. ✅ **優化 getAuditor 函數**
4. ✅ **調整 P5 Weekly 策略批次規模**

### 後續優化（待實施 📋）

1. **批次 Prompt 優化**（優先級高）
2. **Gemini 原始文件去雜訊功能**（優先級高）
3. **批次規模動態調整邏輯**（優先級中）

---

**文檔版本**：V1.0  
**最後更新**：2026-01-17  
**狀態**：✅ 核心變動已完成，待實施批次 Prompt 優化和 Gemini 去雜訊功能
