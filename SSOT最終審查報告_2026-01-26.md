# SSOT 最終審查報告（2026-01-26）

**狀態**：已定案並寫入 SSOT V8.36 與工程備忘錄  
**對應 SSOT**：`V8.0架構定案文檔_SSOT.md`  
**對應工程備忘錄**：`GAS妥協清算與Python重建工程備忘錄_待定案.md`（「架構提前納入檢查」專節）

---

## 一、四個「你一定要提前納入架構」的點

### 1) Hermes 4：必存 `<think>` 到 reasoning_trace（影響 DB schema）

**SSOT 要求**：凡使用 Hermes 4 / Hermes 4 405B 的模組，一律開 `include_reasoning: true`，Parser 把 `<think>` 內容抽出存 `reasoning_trace`，其餘才存 `final_answer` 給下游。

**影響**：
- snapshots（或任何 AI output 表）須有 `reasoning_trace` 欄位（可存冷資料 R2，但索引須能追到）
- M0 Adapter 須有「think 抽取器」與「禁止 OpenRouter 過濾 think」的保護

**若沒做**：花錢買白箱，結果白箱被丟掉；Debug / 風控追溯能力直接少一半。

**結論**：SSOT 硬規則，非加分項。已寫入 SSOT V8.36 資料存儲專節與工程備忘錄。

---

### 2) Weekly 目標架構為 WB-1 / WB-2 / W-A（非 P5-A/P5-B）

**SSOT 要求**：WB-1（宏觀 → 個股）→ 觸發劇變則 W-A 審查/重建 → escalation 則 W-A 審查 + 重跑 P1–P4（不含 P0）→ WB-2 出單；**每一筆 order 須引用 worldview_version 與 identity_context**。

**影響**：
- 資料模型須支援 `worldview_version`、`identity_context`
- Order DSL 須帶此兩欄位（否則 WB-2 下游違規）
- Weekly pipeline 須支援「條件式重跑範圍」（escalation → P1–P4）
- 須用**任務圖/狀態機**寫法，不得硬寫死 P5 流水線

**結論**：一開始就要用任務圖/狀態機，否則後續重構。已寫入 SSOT V8.36 與工程備忘錄。

---

### 3) P6 資料保留/清除規則（比原本想像更精細）

**SSOT 要求**：
- **清除對象**：只清 P6 的一般監測數據，**不包含**已寫入「共用 OHLCV 表」的資料
- **清除時機**：本週策略產出完成後，清除上週一般數據；**至少保留兩週**
- **觸發異常**（急漲急跌、緊急撤退、財報觸發、目標價觸及等）→ 須標記「需保留」，供 Daily/Weekly 讀取整合

**影響**：
- P6 表須區分「一般監測」vs「異常需保留」（至少 flag）
- 清除動作**不得**用 cron 亂刪；須「Weekly 完成 → 解鎖 → 才允許清除」的**清除鎖**

**結論**：P6 不只 alert 表；還有 retention policy 與交接協議。已寫入 SSOT 與工程備忘錄。

---

### 4) DSFP 為全域規則，產物須能被下游引用

**SSOT 要求**：
- 任何金融商品判斷不得依賴歷史標籤，須依賴當前狀態
- Daily 只標記、Weekly 身份裁決（WB-1 為 DSFP 執行層）
- ≥3 項顯著變化 → IDENTITY_DRIFT = TRUE

**影響**：
- `world_state_snapshot`、`asset_identity_map`、`narrative_map` 等 WB-1 產物須能存（熱索引 + 冷內容）
- WB-2 下單時須讀這些身份裁決，並寫進每筆 order 的 `identity_context`
- **DB 須有「worldview / identity」類型的 snapshot 分支**，否則後續一定重構

**結論**：已寫入 SSOT V8.36 與工程備忘錄。

---

## 二、可能問題與修正建議

### 問題 A：最小表結構缺少 reasoning_trace

**現狀**：SSOT 要求 Hermes 4 白箱思考必存，但最小表結構可能未納入。

**修正**：snapshots / ai_outputs / strategy_executions 須含：
- `final_answer`（熱：摘要/短）
- `reasoning_trace`（冷：R2 或 TEXT，索引須能追到）
- `storage_key`（冷檔案指標）
- `model_name` + `include_reasoning`（可稽核）

**已寫入**：SSOT V8.36 資料存儲專節；工程備忘錄「架構提前納入檢查」與 Hermes 4 實作指南。

---

### 問題 B：P6 清除邏輯不能只靠通用清理

**現狀**：SSOT 要求「以 weekly 產出為基準」的週期保留，通用「30 天搬 R2」會違反業務規則。

**修正**：P6 retention 須為**業務規則**：**Weekly 完成 → 才觸發刪除上週一般數據**；須有清除鎖，不得用 cron 亂刪。

**已寫入**：SSOT P6 數據保留規則；工程備忘錄「架構提前納入檢查」專節與工程師搬遷必查表。

---

## 三、採納判斷總表

| 項目 | 採納 | 已寫入 |
|------|------|--------|
| 1) Hermes 4 reasoning_trace | ✅ 採納 | SSOT V8.36、工程備忘錄 |
| 2) Weekly WB-1/WB-2/W-A | ✅ 採納 | SSOT、工程備忘錄 |
| 3) P6 資料保留/清除 | ✅ 採納 | SSOT、工程備忘錄 |
| 4) DSFP worldview 快照 | ✅ 採納 | SSOT V8.36、工程備忘錄 |
| 問題 A：reasoning_trace 表結構 | ✅ 採納 | SSOT V8.36、工程備忘錄 |
| 問題 B：P6 清除業務規則 | ✅ 採納 | SSOT、工程備忘錄 |

---

## 四、實作檢查清單（工程師搬遷必查）

詳見《GAS 妥協清算與 Python 重建工程備忘錄》「六、工程師搬遷必查表」中的「架構提前納入檢查」四項。
