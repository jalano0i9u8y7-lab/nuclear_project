# clasp 認證修復指南 - 2026-01-24

## 🔑 認證狀態

根據剛才的測試，clasp 顯示 "You seem to already be logged in"，但 `clasp pull` 可能仍然失敗。

## 📋 修復步驟

### 方法 1：重新登入（推薦）

1. **執行登入命令**：
   ```bash
   cd c:\Users\Hsiung\nuclear_project
   clasp login
   ```

2. **在瀏覽器中完成授權**：
   - clasp 會顯示一個 URL（例如：`https://accounts.google.com/o/oauth2/v2/auth?...`）
   - 複製這個 URL 並在瀏覽器中打開
   - 選擇你的 Google 帳號並授權
   - 完成後回到終端，clasp 會自動完成認證

3. **驗證認證**：
   ```bash
   clasp pull
   ```
   如果成功，會顯示下載的檔案列表

### 方法 2：清除並重新登入

如果方法 1 失敗，嘗試清除現有認證：

1. **清除認證**：
   ```bash
   # Windows: 刪除認證檔案
   del %USERPROFILE%\.clasprc.json
   # 或
   Remove-Item $env:USERPROFILE\.clasprc.json
   ```

2. **重新登入**：
   ```bash
   clasp login
   ```

3. **完成瀏覽器授權**（同方法 1 步驟 2）

### 方法 3：檢查網路設定

如果認證仍然失敗，可能是網路問題：

1. **檢查代理設定**：
   - 確認沒有使用需要認證的代理
   - 確認防火牆沒有阻擋 localhost 連接

2. **檢查 hosts 檔案**：
   - 確認 `127.0.0.1` 沒有被重定向
   - 檢查 `C:\Windows\System32\drivers\etc\hosts` 檔案

3. **使用 VPN**（如果需要）：
   - 某些地區可能需要 VPN 才能訪問 Google OAuth

## 🧪 測試認證

認證完成後，測試以下命令：

```bash
# 測試 pull（下載）
clasp pull

# 測試 push（上傳）
clasp push --force
```

## ⚠️ 常見問題

### 問題 1：`ECONNREFUSED 127.0.0.1:9`

**原因**：OAuth 回調端口被佔用或無法訪問

**解決方案**：
1. 檢查是否有其他程序佔用端口
2. 嘗試重新啟動終端
3. 清除認證後重新登入

### 問題 2：瀏覽器授權後終端沒有反應

**原因**：OAuth 回調沒有正確返回

**解決方案**：
1. 檢查瀏覽器是否顯示 "授權成功"
2. 複製瀏覽器中的授權碼（如果有）
3. 重新執行 `clasp login`

### 問題 3：認證成功但 pull/push 失敗

**原因**：可能是權限問題或 Script ID 錯誤

**解決方案**：
1. 檢查 `.clasp.json` 中的 `scriptId` 是否正確
2. 確認 Google 帳號有該 Script 的編輯權限
3. 在 GAS 編輯器中確認 Script ID

## 📝 手動備份方案（如果 clasp 仍然失敗）

如果 clasp 認證持續失敗，可以手動備份：

1. **在 GAS 編輯器中**：
   - 打開 Apps Script 專案
   - 選擇 "檔案" → "下載" → "下載為 ZIP"
   - 解壓縮到 `backup_gas_手動_2026-01-24` 目錄

2. **手動上傳更新**：
   - 在 GAS 編輯器中逐個檔案更新
   - 或使用 GAS 編輯器的版本控制功能

## ✅ 認證成功後的下一步

1. **驗證備份**：
   ```bash
   clasp pull
   # 確認下載的檔案與本地一致
   ```

2. **更新到 GAS**：
   ```bash
   clasp push --force
   ```

3. **繼續測試**：
   - 從 P1 Step1 開始測試
   - 確認所有功能正常

---

**建立日期**：2026-01-24  
**狀態**：待用戶完成瀏覽器授權
