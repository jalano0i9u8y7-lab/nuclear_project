# P2 測試準備檢查清單

## ✅ 已完成項目

1. **CSE 數據線暢通** ✅
   - 所有 CSE 已測試通過
   - P2_TAIWAN、P2_JAPAN、INSTITUTIONAL_DATA 都正常運作
   - API Key 已正確設置

2. **輕測試配置已修正** ✅
   - 已移除所有 `test_mode` 和 `missing_data_policy`
   - P2 測試會正式蒐集數據

## 📋 測試前檢查

### 1. 確認 P1 結果存在

P2 測試需要 P1 的結果作為輸入。請確認：

- [ ] 已執行 P1 測試
- [ ] P1 快照已保存（`P1__SNAPSHOT` 表格）
- [ ] P1 輸出包含候選公司列表

**檢查方式**：
```javascript
// 在 Google Apps Script 編輯器中執行
const p1Snapshot = getLatestP1Snapshot();
Logger.log("P1 快照 ID: " + (p1Snapshot ? p1Snapshot.snapshot_id : "不存在"));
```

### 2. 確認 CSE Keys 已設置

雖然已測試通過，但請確認：

- [ ] `GOOGLE_CSE_API_KEY` 已設置
- [ ] `GOOGLE_CSE_CX_P2_TAIWAN` 已設置
- [ ] `GOOGLE_CSE_CX_P2_JAPAN` 已設置
- [ ] `GOOGLE_CSE_CX_INSTITUTIONAL` 已設置

**檢查方式**：
```javascript
// 執行驗證
verifyCSEKeys();
```

### 3. 確認 P2 執行函數可用

- [ ] `P2_Monthly_Execute()` 函數存在
- [ ] `P2_ProcessM0Result()` 函數存在

## 🚀 執行 P2 測試

### 方法 1：使用輕測試系統（推薦）

在 Google Apps Script 編輯器中執行：

```javascript
testP2()
```

或使用 UI 側邊欄的「🧪 測試 P2（基本面）」按鍵。

### 方法 2：直接執行 P2

```javascript
const p1Snapshot = getLatestP1Snapshot();
if (!p1Snapshot) {
  throw new Error("請先執行 P1 測試");
}

const p2Result = P2_Monthly_Execute({
  trigger: "LIGHT_TEST",
  p1_snapshot_id: p1Snapshot.snapshot_id
  // ⚠️ 注意：不設置 test_mode 和 missing_data_policy，所有數據都正式蒐集
});
```

## 📊 測試重點

### 1. 數據收集

P2 會從以下 CSE 收集財務數據：

- **台股**：使用 `P2_TAIWAN` CSE（mops.twse.com.tw, twse.com.tw, tpex.org.tw）
- **美股**：使用 `INSTITUTIONAL_DATA` CSE（sec.gov）
- **日股**：使用 `P2_JAPAN` CSE（jpx.co.jp, tdnet.info, edinet-fsa.go.jp, kabutan.jp）

**檢查點**：
- [ ] 財務數據是否成功收集（不應為 null）
- [ ] 數據來源是否符合白名單
- [ ] 同業比較數據是否收集

### 2. AI 回應格式

**EXECUTOR 輸出應包含**：
- [ ] `gate_result`: "PASS" | "WATCH" | "FAIL"（不能是 "UNKNOWN"）
- [ ] `tier`: "CORE" | "STABLE_SWING" | "AGGRESSIVE" | "OPPORTUNISTIC" | "NOT_ASSIGNED"
- [ ] `financial_data`: 財務指標數據（不應為 null）
- [ ] `peer_comparison`: 同業比較結果

**AUDITOR 輸出應包含**：
- [ ] 審查 `gate_result` 是否合理
- [ ] 審查 `tier` 是否正確（如果 `gate_result` 為 "FAIL"，`tier` 必須是 "NOT_ASSIGNED"）
- [ ] 審查財務數據是否完整

### 3. 規則遵循

**重要規則**：
- [ ] 如果 `gate_result` 為 "FAIL" 或 "UNKNOWN"，`tier` 必須是 "NOT_ASSIGNED"
- [ ] `gate_result` 只能是 "PASS"、"WATCH"、"FAIL"（不能是 "UNKNOWN"）
- [ ] 財務數據缺失時，`gate_result` 應設置為 "FAIL"

## 📝 測試結果記錄

測試完成後，請記錄：

1. **執行狀態**
   - 是否成功完成
   - 執行時間
   - 是否有錯誤

2. **數據收集結果**
   - 成功收集的股票數量
   - 數據缺失的股票數量
   - 數據來源統計

3. **AI 回應檢查**
   - EXECUTOR 輸出欄位完整性
   - AUDITOR 輸出欄位完整性
   - 規則遵循情況

4. **問題記錄**
   - 任何不符合預期的情況
   - Prompt 需要修正的地方

## 🔍 測試後檢查

### 檢查 P2 快照

```javascript
const p2Snapshot = getLatestP2Snapshot();
Logger.log("P2 快照 ID: " + (p2Snapshot ? p2Snapshot.snapshot_id : "不存在"));
Logger.log("Tier 分配: " + JSON.stringify(p2Snapshot.tier_assignments || {}));
```

### 檢查 Phase2_Output 表格

確認所有候選公司都有對應的輸出記錄。

## ⚠️ 已知問題（已修正）

1. ✅ **數據缺失問題**：已移除 `test_mode` 和 `missing_data_policy`，現在會正式蒐集數據
2. ✅ **Gate_Result 格式問題**：需要在 Prompt 中明確要求只能是 PASS/WATCH/FAIL
3. ✅ **Tier 分配規則問題**：需要在 Prompt 中明確要求 FAIL 時必須設置為 NOT_ASSIGNED

## 🎯 預期結果

如果所有配置正確，P2 測試應該：

1. ✅ 成功從 CSE 收集財務數據
2. ✅ EXECUTOR 正確分析並輸出 Gate_Result 和 Tier
3. ✅ AUDITOR 正確審查並確認結果
4. ✅ 所有候選公司都有完整的分析結果
5. ✅ 快照正確保存

---

**更新日期**: 2026-01-16  
**版本**: V8.0
