# V8.15 P3-P6 更新補充（SSOT 待整合）

## 📋 說明

本文檔包含 V8.15 對 P3-P6 的更新建議，需要整合到 SSOT 中，標註為 **⏳ 待實現**。

詳細內容請參考：`P3-P6更新建議報告_V8.15.md`

---

## 📊 一、P3 更新（技術面分析）

### **✅ V8.15 已實現：風控覆蓋層（risk_overlay_level）**

**實現狀態**：✅ **已完成**（2026-01-24）

**實現位置**：
- `src/22_P3_CORE.js` - `calculateRiskOverlayLevel()` 函數（第 1229-1268 行）
- `src/22_P3_CORE.js` - `generateP3Output()` 函數（第 1280-1340 行）

#### **新增概念**：
- **保留 Cat（純技術）**：Cat1-Cat5 保持純技術面分類，不混入基本面
- **新增 `risk_overlay_level`**：0/1/2/3（風控覆蓋層級）
  - 0：無風控覆蓋（正常）
  - 1：輕度保守（降低 Buy1/2 權重）
  - 2：中度保守（降低 Cat2/3 權重，提高 Buy3 權重）
  - 3：重度保守（禁止 Cat3，只允許 Cat1/2/4-A/4-B）

#### **計算邏輯**：
- 由 P0.5 `p5_weekly_flags` + P0.7 決定 `risk_overlay_level`
- 最後才映射到「掛單更保守/停利更快/追蹤停利更緊」

#### **實施要求**：
- ✅ P3 輸出新增 `risk_overlay_level` 欄位
- ✅ P3 根據以下條件計算 `risk_overlay_level`：
  - `P0.7=Late` 或 `turning_point_risk=HIGH` → `risk_overlay_level = 3`（禁止 Cat3）
  - `DIVERGENCE_ALERT = true` 或 `INVENTORY_BUILD_WARNING = true` → `risk_overlay_level = 2`（Cat2/3 降檔）
  - `LATE_CYCLE_RISK = true` → `risk_overlay_level = 1`（輕度保守）

#### **Time_Window_Penalty 整合**：
- ⏳ 讀取 `Time_Window_Penalty_JSON.p3_impact`，調整 Buy 價格和 Stop 設定（待實現）

---

## 📊 二、P4 更新（資金配置計算器）

### **⏳ V8.15 待實現：Tier 映射規則（Position_Role → Tier）**

#### **映射表（固定規則）**：

1. **先用 `Position_Role` 決定預設 Tier**：
   - `MOMENTUM_COMPOUNDER` → `CORE`
   - `EARLY_DIAMOND` → `AGGRESSIVE`（建立底倉）
   - `FRONTIER_OPTIONALITY` → `OPPORTUNISTIC`（嚴格上限）
     - 必須同時標記：`OPTIONALITY_ONLY=true` + `max_position_cap`
   - `SAFE_BUT_STAGNANT` → `DEFENSIVE`（或降級到 `OPPORTUNISTIC`）
     - 原則：不能佔用攻擊資本（避免「死錢」）
   - `HOT_BUT_FRAGILE` → `REJECT` / `WATCHLIST`（或只允許極小型短線倉）
     - 禁止進 `CORE`
   - `REJECT/WATCHLIST` → `REJECT`

2. **再由 P0.7 + P0.5 flags 做「降級/限額」**：
   - `MOMENTUM_COMPOUNDER` → `CORE`
     - 但若 `P0.7.turning_point_risk=HIGH` 或 `P0.5.p5_weekly_flags` 有 `LATE_CYCLE_RISK` / `DIVERGENCE_ALERT`：
       - `CORE` → `STABLE_SWING`（降風險、縮倉上限）
   - `EARLY_DIAMOND` → `AGGRESSIVE`
     - 若 `P0.7=Late`：`AGGRESSIVE` → `OPPORTUNISTIC`（只留觀察倉/小倉）

### **⏳ V8.15 待實現：Cat 權重矩陣調整規則**

#### **兩層修正**：

**(A) 角色倍率（`Position_Role` → Cat 風格）**：
- `MOMENTUM_COMPOUNDER`：允許 Cat2/Cat3 權重 ×1.2（更敢追趨勢/主升）
- `EARLY_DIAMOND`：偏 Cat1/Cat2 ×1.2（底部佈局、避免高位）
- `FRONTIER_OPTIONALITY`：Cat3 權重 ×0.5、只允許 Cat1/2（避免把高波動當主升段）
- `SAFE_BUT_STAGNANT`：Cat4A/現金權重 ×1.2（偏防守）
- `HOT_BUT_FRAGILE`：Cat2/3 全部 ×0.5（除非有強催化里程碑）

**(B) 風控降檔（P0.7/P0.5 flags → 強制保守）**：
- 若 `P0.7=Late` 或 `turning_point_risk=HIGH`：直接禁止 Cat3（不管你多看多）
- 若 `DIVERGENCE_ALERT` 或 `INVENTORY_BUILD_WARNING`：
  - Cat2/3 整體降 1 檔（例如 Cat3 當 Cat2 處理）
  - 並提高 Sell/停損嚴格度

### **⏳ V8.15 待實現：U（利用率）優先級排序**

#### **排序（由高到低）**：
1. **系統級風險上限（P0.7）**：它是「週期/轉折」的總閘門
   - 例：P0.7 說 Late + High turning point → 全系統 U 上限先被壓到 X（例如 50%）
2. **產業級鏈條狀態（P0.5 Mode2 flags）**：它是「該產業現在的供需/庫存/背離」
   - 例：只壓該產業的 U 或該產業所有股票的加碼權重
3. **個股級角色與財務三軸（P2）**：決定同一個 U 上限下「誰吃到更多份額」
4. **技術狀態（P3 Cat）**：決定「進出場節奏/掛單位置」

### **⏳ V8.15 待實現：FRONTIER Runway 硬門檴處理**

#### **兩段式處理**：
1. **`Runway < 4` 且 `Safety=X`**：
   - 禁止加碼 + 進入退出程序（Exit Plan）
   - 允許「極小觀察倉」只有在：`milestones_to_verify` 明確且落在 1–2 季內（否則就是純賭）
2. **`Runway < 4` 但 `Safety=B`**：
   - 可保留小倉觀察，但上限降到 `OPPORTUNISTIC` cap（例如 0.5%–1%）

### **⏳ V8.15 待實現：Time_Window_Penalty 整合**

#### **P4 Impact**：
- 讀取 `Time_Window_Penalty_JSON.p4_impact`：
  - 減少加碼頻率
  - Buy2/Buy3 的資金配比要更少
  - Sell1/Sell2 提前（在 P5 Weekly 處理）
  - 追蹤停利更緊（在 P5 Weekly 處理）

---

## 📊 三、P5 Weekly 更新（策略制定）

### **⏳ V8.15 待實現：雙層 AI 架構（P5-B / P5-A）**

#### **Layer 1：P5-B（Weekly State Evaluator）**：
- 每檔都跑（低成本）
- 模型：Claude Sonnet 4.5
- 輸出：`state_vector`、`parameter_adjustment_vector`、`escalation_score`

#### **Layer 2：P5-A（Weekly Deep Re-evaluation）**：
- 僅升級少數（10-20%）
- 觸發 Gate：`escalation_score > 0.6`、`trend_integrity < 0.4`、`distribution_risk > 0.7`、`chain_dynamics_signal === "DIVERGENCE"`
- 模型：Claude Sonnet 4.5 或 Opus（極少數）

### **✅ V8.15 已實現：Strategy Skeleton + AI Parameter Layer**

**實現狀態**：✅ **已完成**

**實現位置**：
- `src/24_P5_WEEKLY_STRATEGY_SKELETON.js` - 完整模組

#### **Strategy Skeleton（策略骨架）**：
- ✅ 由程式生成，AI 不得修改結構
- ✅ 包含 `buy_ladder`、`sell_ladder`、`risk_frame`
- ✅ `generateStrategySkeleton()` 函數已實現

#### **AI 只輸出「參數調整向量」**：
- ✅ `parameter_adjustment_vector`：`buy_bias`、`sell_bias`、`ladder_spacing_adjustment`、`trailing_stop_tightness`、`max_position_cap_override`
- ✅ 實際掛單價格 = 程式套公式算出（`applyParameterAdjustmentVector()` 函數已實現）

### **✅ V8.15 已實現：Weekly Snapshot 必須納入的資料**

**實現狀態**：✅ **已完成**

**實現位置**：
- `src/24_P5_WEEKLY_STOCK_STRATEGY.js` - `integrateStockFactors()` 函數

#### **必須納入（缺一不可）**：
- ✅ P0–P2 Snapshot（只讀）
- ✅ P3 上一版結論（結構、偏多偏空）
- ✅ Chain Dynamics Monitor JSON（若該產業啟用）- 通過 `p0_5_data.chain_monitor` 整合
- ✅ Daily 新聞索引（摘要，不是全文）- 通過 `stock_news_index` 整合
- ⏳ Dynamic Learning System：`STRATEGY_SNAPSHOT`、`OUTCOME_SNAPSHOT`、`LEARNING_STATE`（待確認整合狀態）
- ✅ 重大財經行事曆：FOMC / CPI / 非農、板塊龍頭財報 - 通過 `calendar_events` 整合
- ✅ 上週策略執行結果：是否成交、持股變化、平均成本 - 通過 `previous_strategy_result` 整合

### **✅ V8.15 已實現：Sector ETF Flow 與 Mag 7 分析**

**實現狀態**：✅ **已完成**

**實現位置**：
- `src/24_P5_WEEKLY_STOCK_STRATEGY.js` - `integrateStockFactors()` 函數（第 181-182 行）

#### **P5-B Input 明確新增**：
- ✅ `macro_flow_context`：
  - `sector_etf_flow`：`sector`、`weekly_flow_usd`、`trend`、`source`
  - `mag7_relative_strength`：`vs_sp500`、`trend`
- ⏳ P5-B Prompt 補一句：在判斷 `momentum_shift` 時，Sector ETF Flow 與 Mag7 相對強弱為高優先權因子（待確認 Prompt 更新）

### **⚠️ V8.15 部分實現：P2.5 異常 → Escalation Gate 硬觸發**

**實現狀態**：⚠️ **部分實現**（數據提取已完成，硬觸發邏輯待確認）

**實現位置**：
- `src/24_P5_WEEKLY_STOCK_STRATEGY.js` - `integrateStockFactors()` 函數（第 127-138 行）
- `src/24_P5_WEEKLY_DELTA_PACK.js` - `extractP2_5Alerts()` 函數（第 376-399 行）

#### **已實現部分**：
- ✅ P2.5 異常數據提取（`insider_selling_alert`、`abnormal_13f_distribution`）
- ✅ 整合到 P5 Weekly 數據流程

#### **Escalation Gate 修改（硬觸發）**：
- ⏳ 明確的硬觸發 P5-A 邏輯（可能整合在其他流程中，待確認）
- ⏳ `forced_escalation` 輸出標記（待確認）

#### **輸出標記**：
- ⏳ `forced_escalation`：`trigger`、`type`、`confidence`、`note`（待確認）

### **⏳ V8.15 待實現：最終產出（對齊 IB 批次下單）**

#### **P5 Weekly 最終輸出（給交易系統）**：
```json
{
  "weekly_trade_actions": [
    {
      "ticker": "NVDA",
      "cancel_previous_orders": true,
      "new_orders": [
        {"type": "BUY", "price": 123.4, "qty": 100},
        {"type": "SELL", "price": 145.6, "qty": 100}
      ],
      "strategy_version": "W2026-03"
    }
  ]
}
```

---

## 📊 四、P6 更新（盤中監控）

### **⏳ V8.15 待實現：緊急退出條件更新**

#### **新增緊急退出條件**：
1. **FRONTIER Runway 檢查**：
   - 如果 `Track_Type` = FRONTIER 且 `Runway_Quarters` < 4 → 緊急減倉或清倉
2. **驗證里程碑未達成**：
   - 如果關鍵里程碑未達成 → 緊急減倉或清倉
3. **產業鏈背離訊號**：
   - 如果 `DIVERGENCE_ALERT` = true → 更保守，提高 Stop 嚴格度

---

---

## 📊 五、P2 Milestones 自動對帳機制

### **✅ V8.15 已實現：P2 Milestones 自動對帳機制**

**實現狀態**：✅ **已完成**

**實現位置**：
- `src/24_P5_WEEKLY_MILESTONE_VERIFICATION.js` - 完整模組
- `src/24_P5_WEEKLY_STRATEGY_SKELETON.js` - `performMilestoneCheck()` 函數（第 284-362 行）

**實現內容**：
- ✅ `verifyP2Milestones()` - 驗證 P2 Milestones
- ✅ `checkSingleMilestone()` - 檢查單個里程碑
- ✅ `performMilestoneCheck()` - 執行 Milestone Check（比對 Milestones 與週度新聞）
- ✅ 整合到 P5 Weekly 數據收集流程

---

**報告完成日期**：2026-01-19  
**最後更新**：2026-01-24  
**版本**：V8.15  
**狀態**：✅ **部分已實現，部分待實現**（見各項目標記）
