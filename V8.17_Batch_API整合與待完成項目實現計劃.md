# V8.17 Batch API æ•´åˆèˆ‡å¾…å®Œæˆé …ç›®å¯¦ç¾è¨ˆåŠƒ

## ğŸ“‹ ä»»å‹™æ¸…å–®

### âœ… å·²å®Œæˆ
1. âœ… SSOT æ–‡æª”æ›´æ–°ï¼ˆBatch API è¨­è¨ˆè¦ç¯„ï¼‰
2. âœ… æ¨¡å‹é…ç½®æ›´æ–°ï¼ˆBatch åƒ¹æ ¼ï¼‰
3. âœ… çµ±ä¸€ Batch æŠ½è±¡å±¤ï¼ˆBatchRunnerï¼‰
4. âœ… Provider Adapterï¼ˆAnthropicã€OpenAIï¼‰
5. âœ… P3 Batch API æ•´åˆç¤ºä¾‹
6. âœ… M0__BATCH_JOBS è¡¨æ ¼å®šç¾©
7. âœ… é€šç”¨ Batch æ•´åˆæ¨¡çµ„ï¼ˆ`04_M0_BATCH_INTEGRATION.js`ï¼‰

### â³ å¾…å®Œæˆ

#### 1. æ‰€æœ‰ Phase çš„ Batch API æ•´åˆ

##### 1.1 P1 Step1ï¼ˆè‚¡ç¥¨æ± ç”Ÿæˆï¼‰
- **æª”æ¡ˆ**: `src/20_P1_COMPANY_POOL.js`
- **ä¿®æ”¹ä½ç½®**: `P1_Execute()` å‡½æ•¸ä¸­çš„ Step 1 æäº¤é‚è¼¯ï¼ˆç´„ç¬¬ 176 è¡Œï¼‰
- **å¯¦ç¾æ–¹å¼**: 
  - åˆ¤æ–·æ˜¯å¦é©ç”¨ Batchï¼ˆ`shouldUseBatch("P1_STEP1")`ï¼‰
  - å¦‚æœé©ç”¨ï¼Œä½¿ç”¨ `executeBatchJob()` æäº¤ Batch
  - å¦‚æœä¸é©ç”¨ï¼Œä¿æŒåŸæœ‰é‚è¼¯
- **æ³¨æ„**: P1 Step1 ä½¿ç”¨ Gemini Flashï¼Œéœ€è¦ç¢ºèª Gemini æ˜¯å¦æ”¯æ´ Batch APIï¼ˆå¦‚æœä¸æ”¯æ´ï¼Œä¿æŒåŒæ­¥ APIï¼‰

##### 1.2 P1 Step2ï¼ˆçµæ§‹åˆ†ç´šï¼‰
- **æª”æ¡ˆ**: `src/20_P1_V8_14.js`
- **ä¿®æ”¹ä½ç½®**: `P1_ExecuteStep2()` å‡½æ•¸ï¼ˆç´„ç¬¬ 222 è¡Œï¼‰
- **å¯¦ç¾æ–¹å¼**: é¡ä¼¼ P1 Step1ï¼Œä½†éœ€è¦è™•ç†å¯©æŸ¥è€…ï¼ˆGPT-5.2ï¼‰
- **æ³¨æ„**: å¯©æŸ¥è€…ä¸é©ç”¨ Batchï¼ˆæ•¸é‡å°‘ï¼Œéœ€è¦å³æ™‚æ€§ï¼‰

##### 1.3 P2 Monthly/Quarterly
- **æª”æ¡ˆ**: `src/21_P2_FUNDAMENTAL_ANALYSIS.js`
- **ä¿®æ”¹ä½ç½®**: `P2_Execute()` å‡½æ•¸ä¸­çš„æ‰¹æ¬¡è™•ç†é‚è¼¯ï¼ˆç´„ç¬¬ 258 è¡Œï¼‰
- **å¯¦ç¾æ–¹å¼**: 
  - å°‡ç¾æœ‰çš„ `submitToM0JobQueue` æ”¹ç‚º `executeBatchJob`
  - æ”¶é›†æ‰€æœ‰æ‰¹æ¬¡å¾Œçµ±ä¸€æäº¤ Batch
  - å¯©æŸ¥è€…ä¿æŒåŒæ­¥ APIï¼ˆæ•¸é‡å°‘ï¼‰

##### 1.4 P2.5 Monthly/Quarterly
- **æª”æ¡ˆ**: `src/21_P2_5_SMART_MONEY.js`
- **ä¿®æ”¹ä½ç½®**: ä¸»åŸ·è¡Œå‡½æ•¸
- **å¯¦ç¾æ–¹å¼**: é¡ä¼¼ P2

##### 1.5 P5-B Weeklyï¼ˆæ˜ŸæœŸå…­æ—©ä¸Šè§¸ç™¼ï¼‰
- **æª”æ¡ˆ**: `src/24_P5_WEEKLY_DUAL_LAYER.js`
- **ä¿®æ”¹ä½ç½®**: `P5_B_Execute()` å‡½æ•¸ï¼ˆç´„ç¬¬ 235 è¡Œï¼‰
- **å¯¦ç¾æ–¹å¼**: 
  - å°‡ç¾æœ‰çš„æ‰¹æ¬¡è™•ç†æ”¹ç‚º Batch API
  - æ˜ŸæœŸå…­æ—©ä¸Šè§¸ç™¼ï¼ŒBatch åœ¨å‘¨æ—¥æ™šä¸Šå‰å®Œæˆ
  - ä½¿ç”¨ Validator é©—è­‰ï¼ˆå·²å¯¦ç¾ï¼‰

##### 1.6 P5-A Weeklyï¼ˆæ˜ŸæœŸå…­æ—©ä¸Šè§¸ç™¼ï¼‰
- **æª”æ¡ˆ**: `src/24_P5_WEEKLY_DUAL_LAYER.js`
- **ä¿®æ”¹ä½ç½®**: `P5_A_Execute()` å‡½æ•¸ï¼ˆç´„ç¬¬ 422 è¡Œï¼‰
- **å¯¦ç¾æ–¹å¼**: é¡ä¼¼ P5-Bï¼Œä½†ä½¿ç”¨ Opus æ¨¡å‹

##### 1.7 P5 Monthly/Quarterly
- **æª”æ¡ˆ**: `src/24_P5_MONTHLY.js`ã€`src/24_P5_QUARTERLY.js`
- **ä¿®æ”¹ä½ç½®**: ä¸»åŸ·è¡Œå‡½æ•¸
- **å¯¦ç¾æ–¹å¼**: é¡ä¼¼ P5-B

##### 1.8 P0.5 Mode-2ï¼ˆChain Dynamics Monitorï¼‰
- **æª”æ¡ˆ**: `src/08_P0_5_INDUSTRY_CHAIN.js`ï¼ˆæˆ–å°æ‡‰æ–‡ä»¶ï¼‰
- **ä¿®æ”¹ä½ç½®**: Mode-2 åŸ·è¡Œå‡½æ•¸
- **å¯¦ç¾æ–¹å¼**: å„ç”¢æ¥­ç¨ç«‹ï¼Œé©ç”¨ Batch

#### 2. æ‰€æœ‰ Phase å¯©æŸ¥è€…çœ‹åˆ°åŸå§‹è³‡æ–™

##### 2.1 ä¿®æ”¹å¯©æŸ¥è€… Prompt æ§‹å»ºå‡½æ•¸
éœ€è¦ä¿®æ”¹ä»¥ä¸‹ Phase çš„å¯©æŸ¥è€… Prompt æ§‹å»ºå‡½æ•¸ï¼š

- **P1 Step2**: `buildP1Step2AuditorPrompt()`ï¼ˆåœ¨ `src/03_M0_CORE.js` ç´„ç¬¬ 1003 è¡Œï¼‰
- **P2**: å¯©æŸ¥è€… Prompt æ§‹å»ºå‡½æ•¸ï¼ˆåœ¨ `src/21_P2_FUNDAMENTAL_ANALYSIS.js`ï¼‰
- **P2.5**: å¯©æŸ¥è€… Prompt æ§‹å»ºå‡½æ•¸ï¼ˆåœ¨ `src/21_P2_5_SMART_MONEY.js`ï¼‰
- **P3**: `buildP3AuditorPrompt()`ï¼ˆåœ¨ `src/22_P3_TRIGGERED_REVIEW.js`ï¼‰
- **P5-A**: å¯©æŸ¥è€… Prompt æ§‹å»ºå‡½æ•¸ï¼ˆåœ¨ `src/24_P5_WEEKLY_DUAL_LAYER.js`ï¼‰

##### 2.2 åŸå§‹è³‡æ–™æå–è¦å‰‡
æ¯å€‹ Phase çš„å¯©æŸ¥è€… Prompt å¿…é ˆåŒ…å«ï¼š

1. **å¯è¿½æº¯çš„é—œéµåŸå§‹è³‡æ–™ç‰‡æ®µ**ï¼š
   - P1/P2: `evidence_json`ï¼ˆå·²å¯¦ç¾ï¼‰
   - è²¡å ±æ®µè½ï¼šæœ€å¤šæ¯æ®µ 1â€“2 å¥ + page/period/source
   - P3: æŠ€è¡“æŒ‡æ¨™èˆ‡è¨ˆç®—è¼¸å…¥ï¼ˆå…¨éƒ¨æ˜¯ç¨‹å¼ç®—çš„æ•¸å€¼ï¼‰
   - P5: æ–°èç´¢å¼•ï¼ˆcluster æ¨™é¡Œã€æ¨™ç±¤ã€åš´é‡åº¦ã€é—œè¯è‚¡ç¥¨ã€æ™‚é–“æˆ³ï¼‰

2. **å¯é©—è­‰çš„æ•¸å€¼**ï¼š
   - æ‰€æœ‰è¨ˆç®—è¼¸å…¥çš„åŸå§‹æ•¸å€¼
   - å¿«ç…§ diffï¼šä¸Šé€± vs æœ¬é€±çš„å·®ç•°è¡¨

3. **çµ•å°ä¸è¦çµ¦çš„æ±è¥¿**ï¼š
   - å…¨é‡æ–°èå…¨æ–‡
   - å…¨é‡æ­·å²ç­–ç•¥å…¨æ–‡
   - å¤šæª”è‚¡ç¥¨æ··åœ¨ä¸€èµ·çš„é•·ä¸Šä¸‹æ–‡ï¼ˆé™¤éåš P5-A ä¸–ç•Œè§€çµ±æ•´ï¼‰

#### 3. Delta Pack è¨­è¨ˆèˆ‡å¯¦ç¾

##### 3.1 Delta Pack å®šç¾©
**è®Šå‹•æ‘˜è¦ï¼ˆDelta Packï¼‰**ï¼šåªåŒ…å«ã€Œå¿…è¦çš„è®Šå‹•ã€ï¼Œè€Œéå®Œæ•´è³‡æ–™ã€‚

**é–¾å€¼å®šç¾©**ï¼š
- **å¸‚å ´å±¤ç´šè®Šå‹•**ï¼š
  - Sector ETF Flow è®ŠåŒ– > 5%
  - Regime è½‰æ›
  - é‡å¤§å®è§€äº‹ä»¶ï¼ˆFOMCã€CPIã€éè¾²ï¼‰
  
- **æ¿å¡Šå±¤ç´šè®Šå‹•**ï¼š
  - æ¿å¡Šè³‡é‡‘æµè®ŠåŒ– > 10%
  - æ¿å¡Šé¾é ­è²¡å ±
  - æ¿å¡Šæ–°èç´¢å¼•åš´é‡åº¦è®ŠåŒ–
  
- **å€‹è‚¡å±¤ç´šè®Šå‹•**ï¼š
  - åƒ¹æ ¼è®ŠåŒ– > 8%
  - æŠ€è¡“æŒ‡æ¨™è®ŠåŒ– > 15%
  - æ–°èç´¢å¼•æ–°å¢é«˜åš´é‡åº¦äº‹ä»¶
  - P2.5 è­¦å ±
  - P0.7 è½‰æŠ˜é¢¨éšªè®ŠåŒ–

##### 3.2 å¯¦ç¾ä½ç½®
- **æª”æ¡ˆ**: `src/24_P5_WEEKLY_DATA.js` æˆ– `src/24_P5_WEEKLY_DATA_OPTIMIZED.js`
- **å‡½æ•¸**: `buildDeltaPack()` æˆ–é¡ä¼¼å‡½æ•¸
- **èª¿ç”¨ä½ç½®**: `P5_B_Execute()` å’Œ `P5_A_Execute()` ä¸­æ§‹å»º Prompt å‰

##### 3.3 å¯¦ç¾é‚è¼¯
```javascript
function buildDeltaPack(ticker, currentData, previousSnapshot, thresholds) {
  const delta = {
    market_level: {
      sector_flow_change: calculateSectorFlowChange(currentData, previousSnapshot),
      regime_change: detectRegimeChange(currentData, previousSnapshot),
      macro_events: extractMacroEvents(currentData)
    },
    sector_level: {
      sector_flow_change: calculateSectorFlowChange(currentData, previousSnapshot),
      sector_earnings: extractSectorEarnings(currentData),
      sector_news_severity_change: calculateNewsSeverityChange(currentData, previousSnapshot)
    },
    stock_level: {
      price_change: calculatePriceChange(currentData, previousSnapshot),
      technical_indicator_changes: calculateTechnicalIndicatorChanges(currentData, previousSnapshot),
      news_events: extractHighSeverityNews(currentData),
      p2_5_alerts: extractP2_5Alerts(currentData),
      p0_7_risk_change: detectP0_7RiskChange(currentData, previousSnapshot)
    },
    change_reason_index: generateChangeReasonIndex(delta),
    auto_generated_flags: generateAutoFlags(delta, thresholds)
  };
  
  return delta;
}
```

#### 4. æª¢æŸ¥æ‰€æœ‰æœªå¯¦ç¾éƒ¨åˆ†

##### 4.1 SSOT å¾…å®Œæˆé …ç›®æª¢æŸ¥
æª¢æŸ¥ `V8.0æ¶æ§‹å®šæ¡ˆæ–‡æª”_SSOT.md` ä¸­æ‰€æœ‰æ¨™è¨˜ç‚ºã€Œâ³ å¾…å¯¦ç¾ã€æˆ–ã€Œå¾…å®Œæˆã€çš„é …ç›®ã€‚

##### 4.2 ç¨‹å¼ç¢¼ TODO æª¢æŸ¥
ä½¿ç”¨ grep æœå°‹æ‰€æœ‰ `TODO`ã€`FIXME`ã€`å¾…å¯¦ç¾` ç­‰æ¨™è¨˜ã€‚

##### 4.3 å‡½æ•¸å¯¦ç¾æª¢æŸ¥
æª¢æŸ¥æ‰€æœ‰åœ¨ SSOT ä¸­å®šç¾©ä½†æœªå¯¦ç¾çš„å‡½æ•¸ã€‚

## ğŸš€ å¯¦ç¾é †åºå»ºè­°

### ç¬¬ä¸€éšæ®µï¼šBatch API æ•´åˆï¼ˆå„ªå…ˆï¼‰
1. P5-B Weeklyï¼ˆæœ€é‡è¦ï¼Œæ˜ŸæœŸå…­è§¸ç™¼ï¼‰
2. P5-A Weeklyï¼ˆæ˜ŸæœŸå…­è§¸ç™¼ï¼‰
3. P3ï¼ˆå·²éƒ¨åˆ†å¯¦ç¾ï¼Œéœ€è¦å®Œå–„ï¼‰
4. P2/P2.5 Monthly/Quarterly
5. P1 Step1/Step2
6. P5 Monthly/Quarterly
7. P0.5 Mode-2

### ç¬¬äºŒéšæ®µï¼šå¯©æŸ¥è€…åŸå§‹è³‡æ–™
1. P3ï¼ˆå·²éƒ¨åˆ†å¯¦ç¾ï¼‰
2. P2
3. P2.5
4. P1 Step2
5. P5-A

### ç¬¬ä¸‰éšæ®µï¼šDelta Pack
1. å¯¦ç¾ `buildDeltaPack()` å‡½æ•¸
2. æ•´åˆåˆ° P5-B å’Œ P5-A
3. æ¸¬è©¦å’Œå„ªåŒ–

### ç¬¬å››éšæ®µï¼šå…¨é¢æª¢æŸ¥
1. SSOT å¾…å®Œæˆé …ç›®æª¢æŸ¥
2. ç¨‹å¼ç¢¼ TODO æª¢æŸ¥
3. å‡½æ•¸å¯¦ç¾æª¢æŸ¥
4. æ•´åˆæ¸¬è©¦

## ğŸ“ æ³¨æ„äº‹é …

1. **Gemini Batch API**: éœ€è¦ç¢ºèª Gemini æ˜¯å¦æ”¯æ´ Batch APIï¼Œå¦‚æœä¸æ”¯æ´ï¼ŒP1 Step1/Step2 ä¿æŒåŒæ­¥ API
2. **å¯©æŸ¥è€…ä¸é©ç”¨ Batch**: å¯©æŸ¥è€…æ•¸é‡å°‘ï¼Œéœ€è¦å³æ™‚æ€§ï¼Œä¿æŒåŒæ­¥ API
3. **æ˜ŸæœŸå…­è§¸ç™¼æ™‚é–“**: P5-B å’Œ P5-A éœ€è¦åœ¨æ˜ŸæœŸå…­æ—©ä¸Šè§¸ç™¼ï¼Œç¢ºä¿ Batch åœ¨å‘¨æ—¥æ™šä¸Šå‰å®Œæˆ
4. **Delta Pack é–¾å€¼**: éœ€è¦æ ¹æ“šå¯¦éš›é‹è¡Œæƒ…æ³èª¿æ•´é–¾å€¼ï¼Œé¿å…éºæ¼é‡è¦è®Šå‹•
5. **æ¸¬è©¦**: æ¯å€‹ Phase çš„ Batch æ•´åˆå®Œæˆå¾Œï¼Œéœ€è¦é€²è¡Œæ¸¬è©¦ç¢ºä¿åŠŸèƒ½æ­£å¸¸
