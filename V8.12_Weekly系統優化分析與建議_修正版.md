# V8.12 Weekly系統優化分析與建議（修正版）

**日期**：2026-01-19  
**目標**：找出「Weekly需要重複執行100次」的工作，避免每分析一個股票都要重新搜尋/過濾

---

## 🎯 核心原則

### ✅ 已優化過的數據不需要再摘要

1. **技術指標**：
   - Daily已經用OHLCV計算完成
   - Weekly直接引用（只有5天，不需要Gemini摘要，會失真）

2. **宏觀數據**：
   - 用**程式計算**（不用AI摘要）：
     - 五天內各數據的價量波動度
     - 價量符合/背離度
     - 與上一週數據比對（前後兩週的波動度變化）
   - 把計算結果直接給Weekly

3. **Daily已經做過的工作**：
   - 清洗、去重、摘要、分類、檢錯
   - **等於已經優化過**，不需要再做摘要

---

## 🔍 需要避免的「重複工作100次」問題

**核心問題**：類似個股新聞索引，如果沒有優化，100檔股票就要重複搜尋/過濾100次

---

## 💡 真正的優化方向

### 優化1：板塊/產業新聞索引 ⭐⭐⭐ **高優先級**

**問題分析**：
- Weekly分析每檔股票時，可能需要搜尋該股票所屬板塊/產業的新聞
- 如果沒有索引，100檔股票就要重複搜尋100次（即使有些股票屬於同一板塊）

**優化方案**：
- **Daily責任**：建立「板塊/產業新聞索引」（類似個股索引）
- **使用Gemini Flash**：從新聞中提取板塊/產業標籤
  - 基於多維度標籤的 `event_type` 和 `impact_scope`
  - 從 `Phase2_Output` 或 `Phase1_Master_Candidates` 中讀取股票的板塊/產業歸屬
- **聚合方式**：
  - 按板塊聚合（科技、金融、能源等）
  - 按產業聚合（半導體、AI、電動車等）
  - 統計每週討論度變化、情緒分布

**表格設計**：`SECTOR_NEWS_INDEX_DAILY` 或 `SECTOR_NEWS_INDEX_WEEKLY`
- 欄位：`date` (或 `week_start_date`), `sector_or_industry`, `news_count`, `bullish_count`, `bearish_count`, `neutral_count`, `sentiment_summary_json`, `key_events_json`, `news_ids_json`, `created_at`

**優化效果**：
- Weekly不用重新搜尋板塊/產業相關新聞
- 直接讀索引，快速了解所屬板塊/產業熱點
- **避免重複搜尋100次**

---

### 優化2：事件索引（按ticker聚合）⭐⭐ **中優先級**

**問題分析**：
- 從代碼 `calculateEventFactor()` 看到，Weekly需要從事件列表中過濾出與該股票相關的事件
- 如果沒有索引，100檔股票就要重複過濾100次

**優化方案**：
- **Daily責任**：建立「事件索引」（類似個股新聞索引）
- **聚合方式**：
  - 從 `24_P5_WEEKLY_EVENTS.js` 收集的事件中，提取每個事件的 `tickers` 列表
  - 建立反向索引：`ticker` → `[event1, event2, ...]`
  - 統計每個ticker相關的事件數量和類型

**表格設計**：`EVENTS_INDEX_WEEKLY`
- 欄位：`week_start_date`, `ticker`, `event_count`, `upcoming_events_json`, `event_types_json`, `alert_levels_json`, `created_at`

**優化效果**：
- Weekly不用重新過濾事件列表
- 直接讀索引，快速了解該股票相關事件
- **避免重複過濾100次**

---

### 優化3：宏觀數據週度波動度計算（程式計算，不用AI）

**問題分析**：
- Weekly需要了解本週宏觀數據的波動度和變化趨勢
- 不需要AI摘要（會忽略細節），需要**程式計算**的硬數據

**優化方案**：
- **Daily責任**：在週五，用程式計算本週宏觀數據的波動度
- **計算內容**：
  1. **五天內各數據的價量波動度**：
     - 價格波動度（標準差、最大振幅）
     - 成交量波動度
     - 價量相關性係數
  2. **價量符合/背離度**：
     - 價量是否符合（價格上漲但成交量下降 = 背離）
     - 背離強度指標
  3. **與上一週數據比對**：
     - 前後兩週的波動度變化（本週 vs 上週）
     - 波動度變化百分比
     - 趨勢是否改變（加速/減速）

**表格設計**：`MACRO_DATA_WEEKLY_METRICS`
- 欄位：`week_start_date`, `week_end_date`, `data_type`, `symbol`, `price_volatility`, `volume_volatility`, `price_volume_correlation`, `divergence_score`, `prev_week_volatility`, `volatility_change_pct`, `trend_change`, `created_at`

**優化效果**：
- Weekly不用重新計算宏觀數據波動度
- 直接讀取計算好的硬數據
- **提供清晰的數值指標，不依賴AI摘要**

---

### 優化4：技術指標週度波動度計算（程式計算，不用AI）

**問題分析**：
- Weekly可能需要了解本週技術指標的變化趨勢
- Daily已經計算了技術指標，但Weekly可能需要「趨勢變化」的硬數據

**優化方案**：
- **Daily責任**：在週五，用程式計算本週技術指標的波動度（基於Daily已計算的技術指標）
- **計算內容**：
  1. **五天內各技術指標的變化**：
     - RSI變化範圍（最高、最低、變化幅度）
     - MACD變化（是否背離）
     - 均線變化（是否突破/跌破）
     - 成交量變化趨勢
  2. **與上一週比對**：
     - 前後兩週的技術指標變化對比

**表格設計**：`TECHNICAL_INDICATORS_WEEKLY_METRICS`
- 欄位：`ticker`, `week_start_date`, `week_end_date`, `rsi_change_range`, `macd_divergence`, `ma_crossovers_json`, `volume_trend`, `prev_week_comparison_json`, `created_at`

**優化效果**：
- Weekly不用重新計算技術指標趨勢
- 直接讀取計算好的硬數據

---

## 📊 優化優先級排序（修正後）

### 🔴 最高優先級（立即實施）

1. **板塊/產業新聞索引**（優化1）
   - **原因**：避免Weekly重複搜尋板塊/產業新聞100次
   - **實施難度**：中等（類似個股索引實現方式）
   - **優化效果**：大幅降低搜尋負擔

### 🟡 中優先級（後續實施）

2. **事件索引**（優化2）
   - **原因**：避免Weekly重複過濾事件列表100次
   - **實施難度**：簡單（從現有事件數據中提取ticker索引）
   - **優化效果**：降低過濾負擔

3. **宏觀數據週度波動度計算**（優化3）
   - **原因**：提供硬數據給Weekly，不用AI摘要
   - **實施難度**：中等（需要程式計算邏輯）
   - **優化效果**：提供清晰的數值指標

4. **技術指標週度波動度計算**（優化4）
   - **原因**：提供技術指標變化趨勢的硬數據
   - **實施難度**：簡單（基於Daily已計算的技術指標）
   - **優化效果**：提供清晰的數值指標

---

## 🎯 實施原則（修正後）

### ✅ 必須遵守的原則

1. **不做AI摘要**：
   - 5天的數據不需要AI摘要（會失真、忽略細節）
   - 使用**程式計算**提供硬數據（波動度、背離度、比對結果）

2. **避免重複工作**：
   - 重點是避免「每分析一個股票都要重複做」的工作
   - 類似個股新聞索引的模式：建立反向索引，一次聚合，多次使用

3. **不違背職權分工**：
   - Daily只做「索引」和「程式計算」，不做「分析」和「結論」
   - Weekly負責「分析」和「決策」

---

## 📋 建議實施順序

### Phase 1：板塊/產業新聞索引（最高優先級）

**實施步驟**：
1. 新增表格：`SECTOR_NEWS_INDEX_DAILY`（或 `SECTOR_NEWS_INDEX_WEEKLY`）
2. 在Daily新聞處理流程中，提取板塊/產業標籤
3. 從 `Phase2_Output` 讀取股票的板塊/產業歸屬
4. 建立反向索引：板塊/產業 → 相關新聞列表
5. 統計情緒分布和討論度

### Phase 2：事件索引 + 宏觀數據波動度計算（中優先級）

**事件索引**：
1. 新增表格：`EVENTS_INDEX_WEEKLY`
2. 從事件列表中提取每個事件的 `tickers`
3. 建立反向索引：ticker → 相關事件列表

**宏觀數據波動度**：
1. 新增表格：`MACRO_DATA_WEEKLY_METRICS`
2. 在週五，用程式計算本週宏觀數據的波動度
3. 計算價量相關性和背離度
4. 與上一週數據比對

---

## 🔄 Weekly使用方式改變

### 優化前（當前）：
```
Weekly分析每個股票時：
1. 讀取技術指標（5天，Daily已計算）✅ 直接引用
2. 讀取宏觀數據（5天）⚠️ 可能需要重新計算波動度
3. 從新聞中搜尋該股票相關新聞 ✅ 已優化（個股索引）
4. 從新聞中搜尋該股票所屬板塊/產業相關新聞 ❌ 重複搜尋100次
5. 從事件列表中過濾該股票相關事件 ❌ 重複過濾100次
...
```

### 優化後（建議）：
```
Weekly分析每個股票時：
1. 讀取技術指標（5天，Daily已計算）✅ 直接引用
2. 讀取宏觀數據週度波動度（程式計算的硬數據）✅ 直接引用
3. 讀取個股新聞索引 ✅ 直接引用
4. 讀取板塊/產業新聞索引 ✅ 直接引用（避免重複搜尋）
5. 讀取事件索引 ✅ 直接引用（避免重複過濾）
...
```

---

## 💰 優化效果預估

### 避免重複工作：
- **板塊/產業新聞搜尋**：從100次重複搜尋 → 1次讀索引（約減少99%工作量）
- **事件過濾**：從100次重複過濾 → 1次讀索引（約減少99%工作量）

### 提供硬數據而非AI摘要：
- **宏觀數據波動度**：程式計算的數值指標，不依賴AI摘要
- **技術指標波動度**：程式計算的數值指標，不依賴AI摘要

---

## ⚠️ 注意事項

1. **板塊/產業索引的數據來源**：
   - 需要從 `Phase2_Output` 或 `Phase1_Master_Candidates` 讀取股票的板塊/產業歸屬
   - 如果股票沒有明確的板塊/產業歸屬，可能需要從新聞中推斷

2. **波動度計算的邏輯**：
   - 需要定義清晰的計算公式（標準差、最大振幅、相關性係數等）
   - 需要保留上一週的數據用於比對

3. **索引格式必須方便Weekly讀取**：
   - 類似新聞索引，格式設計要方便Weekly AI讀取和使用
   - 避免過於複雜的JSON結構

---

**狀態**：✅ **修正完成**  
**下一步**：等待用戶確認後開始實施 Phase 1（板塊/產業新聞索引）
