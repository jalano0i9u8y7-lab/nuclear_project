# 白名單原則檢查與修正總結 V8.0

## 📋 檢查原則

**大原則**：所有系統數據都要由白名單去拿，不能讓 AI 模型自己去找，以免偏差

---

## ✅ 已修正的部分

### 1. P3 歷史 OHLCV 數據獲取 ✅

**修正內容**：
- ✅ 在 `collectTechnicalDataFromExternalSources` 函數中添加讀取歷史 OHLCV 數據的功能
- ✅ 調用 `getHistoricalOHLCV` 函數（優先從表格讀取，不足才從 stooq.com 補充）
- ✅ 將歷史 OHLCV 數據傳遞給 AI 模型

**實現位置**：
- `src/22_P3_DATA_COLLECTOR.js` 的 `collectTechnicalDataFromExternalSources` 函數

---

### 2. P3 Prompt 數據來源說明 ✅

**修正內容**：
- ✅ 在 Prompt 中明確說明「所有數據類的資料一律不由 AI 模型自己搜尋，全部由程式從白名單數據源獲取」
- ✅ 明確說明歷史 OHLCV 數據已由程式從白名單數據源（stooq.com、TWSE、TPEX）收集
- ✅ 明確說明 P2 財務指標已繼承，不需要重複搜尋與計算
- ✅ 加入完整的機構級預測視角原則

**實現位置**：
- `src/22_P3_AI_ANALYSIS.js` 的 `buildP3Prompt` 函數

---

### 3. P2 Prompt 數據來源說明 ✅

**修正內容**：
- ✅ 在 Prompt 中明確說明「所有數據類的資料一律不由 AI 模型自己搜尋，全部由程式從白名單數據源獲取」
- ✅ 明確說明財務數據已由程式從白名單 CSE 收集
- ✅ 明確說明禁止讓 AI 模型自己去找數據

**實現位置**：
- `src/21_P2_FUNDAMENTAL_ANALYSIS.js` 的 `buildP2Prompt` 函數

---

## ✅ 已確認遵循白名單原則的部分

### 1. P5 Daily 數據收集

- ✅ **OHLCV 數據**：使用 stooq.com（通過 Cloud Function 代理）、TWSE/TPEX
- ✅ **技術指標計算**：使用程式公式計算（RSI、MACD、ATR、MA）
- ✅ **新聞收集**：使用白名單 CSE（P5_NEWS）
- ✅ **宏觀數據**：使用 stooq.com（通過 Cloud Function 代理）

### 2. P2 財務數據收集

- ✅ **使用白名單 CSE**：
  - `P2_TAIWAN`：TWSE、TPEX、公開資訊觀測站
  - `INSTITUTIONAL_DATA`：SEC EDGAR
  - `P2_JAPAN`：JPX、TDnet、EDINET、kabutan.jp
- ✅ **程式控制搜尋**：使用 `executeCSESearch`，不是讓 AI 自己找

### 3. P3 技術數據收集

- ✅ **技術指標**：優先從 `MARKET_INDICATORS_DAILY` 表格讀取（由 P5 Daily 收集）
- ✅ **歷史 OHLCV**：優先從 `MARKET_OHLCV_DAILY` 表格讀取，不足才從 stooq.com 補充
- ✅ **不讓 AI 自己找**：`fetchTechnicalIndicatorsFromExternalSource` 目前返回 null

---

## ⚠️ 需要確認的部分

### GEMINI_SEARCH（事實查證）

**當前狀態**：
- ⚠️ 使用 `CSE_SEARCH_UNRESTRICTED`（無白名單限制的 CSE 搜尋）
- ⚠️ 用於自我質疑機制

**需要確認**：
- 是否符合白名單原則？
- 是否應該限制為白名單 CSE？

---

## 📋 修正總結

### ✅ 已完成的修正

1. **P3 讀取歷史 OHLCV 數據** ✅
   - 已實現調用 `getHistoricalOHLCV` 函數
   - 優先從表格讀取，不足才從 stooq.com 補充
   - 將歷史 OHLCV 數據傳遞給 AI 模型

2. **P3 Prompt 數據來源說明** ✅
   - 已明確說明「所有數據類的資料一律不由 AI 模型自己搜尋」
   - 已說明歷史 OHLCV 數據來源
   - 已加入完整的機構級預測視角原則

3. **P2 Prompt 數據來源說明** ✅
   - 已明確說明「所有數據類的資料一律不由 AI 模型自己搜尋」
   - 已說明財務數據來源（白名單 CSE）

### ⚠️ 待確認

1. **GEMINI_SEARCH 是否符合白名單原則** ⚠️
   - 需要確認 `CSE_SEARCH_UNRESTRICTED` 的使用是否符合原則

---

## 🎯 總結

### ✅ 已修正

1. **P3 讀取歷史 OHLCV 數據**：已實現 ✅
2. **P3 Prompt 數據來源說明**：已補充 ✅
3. **P2 Prompt 數據來源說明**：已補充 ✅

### ✅ 已確認遵循原則

1. **P5 Daily 數據收集**：使用白名單數據源 ✅
2. **P2 財務數據收集**：使用白名單 CSE ✅
3. **P3 技術數據收集**：使用白名單數據源 ✅

### ⚠️ 待確認

1. **GEMINI_SEARCH**：需要確認是否符合白名單原則 ⚠️

---

**文檔版本**：V1.0  
**最後更新**：2025-01-14  
**狀態**：✅ 主要修正已完成，1 項待確認
