# 🧪 V8.0 完整系統測試指南

**版本**: V8.0  
**日期**: 2025-01-15  
**測試腳本**: `src/TEST_FULL_SYSTEM_V8.js`

---

## 📋 測試目標

1. **P0-P4 完整流程測試**
   - P0：讓AI選一個產業
   - P0.5：產業鏈地圖與供應鏈情報網分析
   - P0.7：系統動力學分析
   - P1：選出該產業五個公司
   - P2：基本面分析
   - P2.5：機構級籌碼分析
   - P3：技術面分析（整合P2.5輸出）
   - P4：資金分配計算（純程式計算）

2. **AI流程驗證**
   - 驗證AI模型是否有做到完整的分析-提問-審查-統整融合動作
   - 檢查M0__CROSSCHECK_LOG中的執行者（EXECUTOR）和審查者（AUDITOR）記錄
   - 檢查是否有提問機制（audit_questions）
   - 檢查P3是否整合了P2.5的Smart_Money_Score

3. **程式計算驗證**
   - 驗證固定計算由程式處理，智慧思考由AI完成
   - 檢查P4是否為純程式計算（無AI調用）
   - 驗證P4的計算結果是否合理

4. **表格輸出驗證**
   - 檢查所有快照表格是否有數據
   - 檢查Phase1_Master_Candidates表格是否有公司記錄
   - 檢查Phase2_Output表格是否有輸出

5. **P5功能測試**
   - 測試P5.4（警報檢測）
   - 測試P5.9（泡沫監控系統）
   - 測試P5 Daily和P5 Weekly函數可訪問性

---

## 🚀 執行步驟

### 步驟 1：準備工作

1. **確認所有檔案已上傳到 GAS**
   ```bash
   # 在專案根目錄執行
   clasp push
   ```

2. **確認API Keys已配置**
   - 在 GAS 編輯器中：專案設定 > 指令碼內容
   - 設置以下 Properties：
     - `API_KEY_OPENAI` = 您的 OpenAI API Key
     - `API_KEY_ANTHROPIC` = 您的 Anthropic API Key
     - `API_KEY_GEMINI` = 您的 Google Gemini API Key

3. **初始化表格**
   - 在 GAS 編輯器中執行：`initializeAllSheets()`
   - 確認所有表格已創建

### 步驟 2：執行完整測試

在 GAS 編輯器中：

1. **選擇函數**：`testFullSystemV8`
2. **點擊執行**（▶️ 按鈕）
3. **查看執行記錄**：View > Execution log

### 步驟 3：查看測試結果

測試完成後，檢查：

1. **執行記錄**：查看每個步驟的執行狀態
2. **快照表格**：檢查各個Phase的快照是否已保存
3. **Master_Candidates表格**：檢查是否選出了5個公司
4. **M0__CROSSCHECK_LOG**：檢查AI流程記錄
5. **M0__RESULT**：檢查M0執行結果

---

## 📊 測試結果解讀

### 成功標準

#### 最低要求（可上線）
- ✅ 所有Phase（P0-P4）都能正常執行
- ✅ 至少選出1個產業和1個公司
- ✅ P4計算完成，有配置結果
- ✅ 所有快照表格都有數據
- ✅ 無嚴重錯誤

#### 完整驗證（理想狀態）
- ✅ P0選出1個產業
- ✅ P0.5和P0.7分析完成
- ✅ P1選出5個公司
- ✅ P2-P4全部完成
- ✅ AI流程驗證通過（分析-提問-審查-統整融合）
- ✅ 程式計算驗證通過（P4純程式計算）
- ✅ 表格輸出完整

### 預期輸出

#### 測試總結格式
```
📊 測試總結
============================================================
總測試步驟：12
通過：10 ✓
失敗：0 ✗
跳過：2 ⚠
通過率：83.3%
總耗時：XXX 秒

📸 快照ID：
  p0: P0_2025Q1_XXXXXXXX
  p0_7: P0_7_2025Q1_XXXXXXXX
  p1: P1_2025Q1_XXXXXXXX
  p2: P2_2025_Q1
  p2_5: P2_5_20250115_XXXXXX
  p3: P3_2025_WXX_XXXXXXXX
  p4: P4_2025_WXX

🤖 AI流程驗證：
  分析完成：✓
  提問機制：✓
  審查完成：✓
  統整融合：✓

🔧 計算驗證：
  P4計算完成：✓
  純程式計算：✓
```

---

## 🔍 驗證重點

### 1. AI流程驗證

檢查 `M0__CROSSCHECK_LOG` 表格：

- **執行者記錄**：應該有 `step = "EXECUTOR"` 的記錄
- **審查者記錄**：應該有 `step = "AUDITOR"` 的記錄
- **提問機制**：檢查 `note` 欄位是否包含 "audit_questions" 或 "問題"
- **模型使用**：檢查 `used_models` 是否包含預期的模型（例如：OPUS、O3、SONNET、GPT）

### 2. P2.5與P3整合驗證

檢查 `P3__SNAPSHOT` 表格：

- 讀取 `technical_results_json` 欄位
- 檢查每個股票的結果中是否有 `smart_money_adjustment` 字段
- 驗證 `smart_money_adjustment` 包含：
  - `smart_money_score`
  - `original_cat`
  - `adjusted_cat`
  - `price_adjustment_pct`

### 3. P4純程式計算驗證

檢查 `M0__JOB_QUEUE` 表格：

- **不應該有** `project_id = "P4"` 的記錄（P4是純程式計算，不通過M0）
- 檢查 `P4__SNAPSHOT` 表格：
  - 應該有 `allocations_json`（配置結果）
  - 應該有 `summary_json`（總計）
  - 應該有 `changes_json`（變動偵測）

### 4. 表格輸出驗證

檢查以下表格是否有數據：

- ✅ `P0__SNAPSHOT` - P0快照
- ✅ `P0_7__SNAPSHOT` - P0.7快照
- ✅ `P1__SNAPSHOT` - P1快照
- ✅ `Phase1_Master_Candidates` - 正式候選池（應該有5個公司）
- ✅ `P2__SNAPSHOT` - P2快照
- ✅ `P2_5__SNAPSHOT` - P2.5快照（如果執行成功）
- ✅ `P3__SNAPSHOT` - P3快照
- ✅ `P4__SNAPSHOT` - P4快照
- ✅ `Phase2_Output` - P2輸出表格

---

## ⚙️ 測試配置

在 `TEST_FULL_SYSTEM_V8.js` 中可以調整以下配置：

```javascript
const TEST_CONFIG = {
  test_mode: true,                    // 測試模式
  skip_confirmation: true,             // 跳過執行前確認
  industry_focus: null,               // 產業選擇（null=由AI選擇）
  max_companies: 5,                   // 公司數量限制
  wait_for_m0: true,                  // 是否等待M0執行完成
  m0_timeout: 10 * 60 * 1000,        // M0執行超時時間（10分鐘）
};
```

### 配置說明

- **skip_confirmation**: 設為 `true` 可跳過執行前確認，加快測試速度
- **industry_focus**: 可指定產業（例如："AI半導體"、"新能源車"），設為 `null` 則由AI選擇
- **max_companies**: 限制P1選出的公司數量（測試用）
- **wait_for_m0**: 設為 `true` 會等待M0執行完成，設為 `false` 只提交任務
- **m0_timeout**: M0執行超時時間，超過此時間會繼續執行下一步

---

## 🐛 常見問題

### 問題 1：P0執行失敗

**錯誤**：`P0 執行失敗：M0__JOB_QUEUE 表格不存在`

**解決方案**：
1. 先執行 `initializeAllSheets()` 初始化表格
2. 確認 `M0__JOB_QUEUE` 表格已創建

### 問題 2：M0執行超時

**錯誤**：`等待 P0 M0 執行完成：超時`

**解決方案**：
1. 檢查API Keys是否正確配置
2. 檢查網路連接
3. 增加 `m0_timeout` 時間
4. 或設置 `wait_for_m0: false`，手動執行 `M0_Execute()`

### 問題 3：P2.5執行失敗

**錯誤**：`P2.5 執行失敗：沒有籌碼面數據`

**解決方案**：
- 這是正常的（測試模式可能沒有實際的籌碼面數據）
- 測試會繼續執行，P3會在不整合Smart_Money_Score的情況下執行

### 問題 4：P4計算失敗

**錯誤**：`P4 計算失敗：缺少必要的快照數據`

**解決方案**：
1. 確認P2和P3快照已成功保存
2. 檢查 `P2__SNAPSHOT` 和 `P3__SNAPSHOT` 表格是否有數據

---

## 📝 測試記錄模板

測試完成後，請記錄：

```
## 測試記錄

**測試時間**：2025-01-15 XX:XX:XX
**測試版本**：V8.0
**測試人員**：XXX

### 執行結果

- P0：✅ 通過 / ❌ 失敗
- P0.5：✅ 通過 / ❌ 失敗
- P0.7：✅ 通過 / ❌ 失敗
- P1：✅ 通過 / ❌ 失敗（選出 X 個公司）
- P2：✅ 通過 / ❌ 失敗
- P2.5：✅ 通過 / ⚠️ 跳過 / ❌ 失敗
- P3：✅ 通過 / ❌ 失敗（Smart_Money_Score整合：是/否）
- P4：✅ 通過 / ❌ 失敗（配置 X 檔股票）

### AI流程驗證

- 分析完成：✅ / ❌
- 提問機制：✅ / ❌
- 審查完成：✅ / ❌
- 統整融合：✅ / ❌

### 計算驗證

- P4計算完成：✅ / ❌
- 純程式計算：✅ / ❌

### 表格輸出

- P0快照：✅ / ❌
- P0.7快照：✅ / ❌
- P1快照：✅ / ❌
- Master_Candidates：✅ / ❌（X 筆記錄）
- P2快照：✅ / ❌
- P2.5快照：✅ / ⚠️ / ❌
- P3快照：✅ / ❌
- P4快照：✅ / ❌

### 發現的問題

1. [問題描述]
2. [問題描述]

### 修復狀態

- [ ] 問題1已修復
- [ ] 問題2已修復
```

---

## 🎯 下一步

測試通過後：

1. **修復發現的問題**（如果有）
2. **進行實際數據測試**（使用真實的產業和公司）
3. **測試P5功能**（P5 Daily、P5 Weekly、觸發器設置）
4. **準備上線**

---

## 📚 相關文檔

- `V8.0架構定案文檔_SSOT.md` - V8.0 架構 SSOT
- `V7.1到V8.0架構審查報告.md` - 變更詳情
- `P0.5與P0.6統整分析報告.md` - P0.5/P0.6 統整分析

---

**準備就緒！開始測試吧！** 🎉
