# V8.0 數據流對接完整性檢查清單（V8.6 更新）

## 📋 檢查原則

**核心原則**：所有數據收集和分析都必須對接到：
1. ✅ **後續程序接口**（AI 模型或程式分析）
2. ✅ **決策系統**（P3/P4/P5 決策流程）
3. ✅ **歷史動態學習系統**（保留歷史數據用於後續學習）

**沒有對接的數據 = 白做**

---

## 🔍 V8.6 新增：機構言行一致性分析器對接檢查

### 1. 數據收集層（✅ 已完成）

**文件**：`src/24_P5_WEEKLY_SENTIMENT.js`

- [x] `getInstitutionalSentimentFromYahoo()` - 收集機構評級數據
- [x] `getHistoricalRatings()` - 歷史評級挖掘機（Finviz/Yahoo HTML JSON）
- [x] `analyzeSmartSentiment()` - 機構言行一致性分析（結合價格反應）
- [x] `getPriceReaction()` - 價格反應驗證（從 MARKET_OHLCV_DAILY 讀取）

**輸出格式**：
```javascript
{
  sentiment_score: +5,
  sentiment_label: "STRONG_BULL" | "BULLISH" | "NEUTRAL" | "BEARISH" | "STRONG_BEAR",
  warnings: "2026-01-15 Goldman 誘多出貨嫌疑（Upgrade 但股價下跌 -2.5%）",
  actions: [...],
  consensus_forward_eps: 5.0,
  consensus_forward_pe: 30.0
}
```

### 2. 數據整合層（✅ 已完成）

**文件**：`src/24_P5_WEEKLY_SENTIMENT.js`

- [x] `collectMarketSentimentIndicators()` 已更新
  - [x] 收集 `institutional_sentiment` 欄位
  - [x] 每個 ticker 包含：`sentiment_label`、`warnings`、`actions_count`、`latest_actions`

**整合位置**：
- `collectWeeklyMarketData()` → `market_sentiment_indicators` → `weeklyMarketData.market_sentiment_indicators`

### 3. AI 模型接口層（✅ 已完成）

**文件**：`src/24_P5_WEEKLY_PROMPT.js`

- [x] Prompt 中已包含 `market_sentiment_indicators` 數據
- [x] 已新增「機構言行一致性分析」說明段
- [x] 已說明 `warnings`（誘多/誘空）的戰略意義
- [x] 已強調優先使用 `warnings` 而非 `sentiment_label`

**Prompt 位置**：`buildP5WeeklyPrompt()` → `market_sentiment_indicators` 欄位

**AI 模型會看到**：
```javascript
weeklyMarketData.market_sentiment_indicators = {
  fpe_b: { ... },
  institutional_sentiment: {
    "AAPL": {
      sentiment_label: "BULLISH",
      warnings: "...",
      actions_count: 10,
      latest_actions: [...]
    }
  }
}
```

### 4. AI 輸出層（✅ 已完成）

**文件**：`src/24_P5_WEEKLY_PROMPT.js`

**AI 模型輸出格式**（應該包含）：
- `weekly_worldview.market_regime` - 應參考機構評級
- `risk_assessment.systemic_risk` - 應參考 `warnings`
- `stock_strategies[].recommendations` - 應參考機構評級的 `warnings` 和 `sentiment_label`

**確認點**：
- [x] AI 模型輸出會保存到 `P5__WEEKLY_SNAPSHOT` 表格
- [x] `P5_Weekly_Execute()` 會處理 AI 輸出並保存快照

### 5. 決策系統接口層（⚠️ 需要確認）

**問題**：P5 Weekly 的 `trigger_decisions` 和 `u_adjustment` 是否會使用機構評級數據？

**檢查點**：

#### 5.1 P5 Weekly → P3 觸發
- [ ] `trigger_decisions.p3_trigger` 是否會參考機構評級的 `warnings`？
- [ ] 是否有機制根據 `warnings`（誘多/誘空）觸發 P3 重新分析？

#### 5.2 P5 Weekly → P4 觸發
- [x] `trigger_decisions.p4_trigger` - 已有機制（U 調整時觸發）
- [ ] `u_adjustment` 是否會參考機構評級的 `sentiment_label` 或 `warnings`？

**文件**：`src/24_P5_WEEKLY_CORE.js`
- `executeP5WeeklyTriggerDecisions()` - 執行觸發決策
- `applyUAdjustment()` - 應用 U 調整（應該參考機構評級）

#### 5.3 P5 Weekly → P4.6 觸發
- [ ] 當機構評級顯示「誘多出貨」（`warnings` 包含誘多）時，是否會建議觸發 P4.6？

### 6. 歷史動態學習系統（✅ 已完成）

**文件**：`src/24_P5_WEEKLY_LEARNING.js`

- [x] `saveP5WeeklyLearningLog()` 已更新
- [x] `systematicLearning.institutional_sentiment_data` 會記錄所有機構評級數據
- [x] 數據保存到 `P5__LEARNING_LOG` 表格

**歷史數據記錄**：
- ✅ `systematicLearning.institutional_sentiment_data` - 所有 ticker 的機構評級
- ✅ `systematicLearning.strategy_performance` - 策略對照結果
- ✅ 用於後續權重調整和策略優化

**確認點**：
- [x] `P5_Weekly_Execute()` 會調用 `saveP5WeeklyLearningLog()`
- [x] Learning Log 會記錄機構評級數據

---

## 🔍 完整數據流檢查（P0-P6 全系統）

### P0-P1 數據收集

#### P0：產業鏈分析
- [x] 數據收集 → P1 候選池
- [x] 輸出保存 → `P0__SNAPSHOT` / `Phase0_Output`
- [x] 歷史記錄 → ✅（快照系統）

#### P1：公司池
- [x] 數據收集 → P2 財務分析
- [x] 輸出保存 → `P1__SNAPSHOT` / `Phase1_Master_Candidates`
- [x] 歷史記錄 → ✅（快照系統）

### P2-P2.5 數據收集與分析

#### P2：財務指標分析
- [x] 數據收集 → P2.5 / P3
- [x] 輸出保存 → `P2__SNAPSHOT` / `Phase2_Output`
- [x] 歷史記錄 → ✅（快照系統）
- [x] FPE_A / FPE_B → P3 AI 分析

#### P2.5：機構籌碼面分析
- [x] 數據收集 → P3 / P5 Weekly
- [x] 輸出保存 → `P2_5__SNAPSHOT` / `Phase2.5_Output`
- [x] 歷史記錄 → ✅（快照系統）
- [x] Smart Money Score → P3 AI 分析

### P3：技術分析（機構級預測）

- [x] 數據來源 → P2 / P2.5 / P5 Daily OHLCV
- [x] AI 分析 → 輸出技術分析結果
- [x] 輸出保存 → `P3__SNAPSHOT`
- [x] 歷史記錄 → ✅（快照系統）
- [x] Cat 分類 → P4 資金配置

### P4：資金配置

- [x] 數據來源 → P2 / P3 快照
- [x] 程式計算 → 輸出配置結果
- [x] 輸出保存 → `P4__SNAPSHOT`
- [x] 歷史記錄 → ✅（快照系統）
- [x] 配置結果 → P5 Weekly 參考 / P6 掛單監控

### P5：市場分析

#### P5 Daily
- [x] OHLCV 數據 → `MARKET_OHLCV_DAILY` → P3 / P6
- [x] 技術指標 → `MARKET_INDICATORS_DAILY` → P3 / P6
- [x] 衍生品數據 → `DERIVATIVES_DAILY` → P5 Weekly
- [x] 宏觀數據 → `MACRO_DAILY` → P5 Weekly
- [x] 歷史記錄 → ✅（日度表格）

#### P5 Weekly
- [x] 市場綜述 → AI 分析 → `P5__WEEKLY_SNAPSHOT`
- [x] 市場情緒指標（FPE_B） → AI Prompt → AI 輸出
- [x] **機構言行一致性分析（V8.6 新增）** → AI Prompt → AI 輸出 ✅
- [x] U 調整 → P4 觸發
- [x] 觸發決策 → P3 / P4 觸發
- [x] 學習日誌 → `P5__LEARNING_LOG` ✅

**V8.6 新增檢查點**：
- [x] `institutional_sentiment` 數據 → `collectMarketSentimentIndicators()`
- [x] `institutional_sentiment` 數據 → P5 Weekly Prompt
- [x] AI 輸出 → `P5__WEEKLY_SNAPSHOT`
- [x] AI 輸出 → `P5__LEARNING_LOG`（`systematicLearning.institutional_sentiment_data`）
- [ ] ⚠️ **待確認**：AI 輸出中的 `trigger_decisions` 是否會使用機構評級數據？
- [ ] ⚠️ **待確認**：AI 輸出中的 `u_adjustment` 是否會參考機構評級？

### P6：盤中監測

- [x] 數據來源 → P5 Daily OHLCV（實時）
- [x] 監測結果 → 事件表（Append-only）
- [x] 歷史記錄 → ✅（事件表）
- [x] 觸發決策 → P4.6 緊急撤退

---

## ⚠️ V8.6 待確認項目

### 1. P5 Weekly AI 輸出 → 決策系統對接

**問題**：AI 模型輸出的 `trigger_decisions` 和 `u_adjustment` 是否會明確使用機構評級數據？

**建議檢查**：
- [ ] `24_P5_WEEKLY_PROMPT.js` 的 Prompt 是否明確要求 AI 在輸出 `trigger_decisions` 時參考機構評級的 `warnings`？
- [ ] `24_P5_WEEKLY_PROMPT.js` 的 Prompt 是否明確要求 AI 在輸出 `u_adjustment` 時參考機構評級的 `sentiment_label`？

**如果沒有，需要更新 Prompt**：
```
## 觸發決策（Trigger Decisions）

**機構評級警告（Institutional Sentiment Warnings）** ⭐ V8.6 新增：
${JSON.stringify(weeklyMarketData.market_sentiment_indicators?.institutional_sentiment || {}, null, 2)}

**重要**：
- ⭐⭐⭐ **當 `warnings` 包含「誘多出貨」時，建議觸發 P3 重新分析該標的**
- ⭐⭐⭐ **當 `warnings` 包含「誘空吃貨」時，建議觸發 P3 重新分析該標的（可能是進場機會）**
- ⭐⭐⭐ **當多個標的出現「誘多出貨」警告時，建議調整 U（降低利用率）**
```

### 2. 歷史數據查詢接口

**問題**：是否有機制讓 P5 Weekly 在分析時查詢歷史機構評級數據？

**建議**：
- [ ] 創建 `getHistoricalInstitutionalSentiment(ticker, weeks)` 函數
- [ ] 讓 AI Prompt 包含過去 4-8 週的機構評級趨勢

---

## ✅ 已完成對接項目

1. ✅ 機構評級數據收集 → `collectMarketSentimentIndicators()`
2. ✅ 機構評級數據 → P5 Weekly Prompt（AI 模型可看到）
3. ✅ 機構評級數據 → P5 Weekly Learning Log（歷史記錄）
4. ✅ 價格反應驗證 → `getPriceReaction()`（從 MARKET_OHLCV_DAILY 讀取）

---

## ✅ V8.9 新增：新聞品質測試系統

### 測試項目 ✅ **已完成**

**文件**：`src/24_P5_NEWS_QUALITY_TEST.js`

- [x] `testNewsTimeliness()` - 時效性測試（±6 小時）
- [x] `testNewsRelevance()` - 範圍精準性測試（涵蓋十大分類）
- [x] `testNewsNoiseFiltering()` - 雜訊過濾測試（針對白名單網站客製化，無非正式新聞）
- [x] `testNewsVerifiability()` - 可驗證性測試（URL 可訪問、內容一致性、來源可信）
- [x] `testNewsQuality()` - 綜合測試函數
- [x] `testAllP5NewsQuality()` - 批量測試所有 P5 新聞（一般新聞 + 機構評級新聞）

### 測試整合 ✅ **已完成**

- [x] `testP5NewsQuality()` - 整合到 `29_DATAFLOW_TEST.js`
- [x] UI 選單測試按鈕 - 整合到 `25_UI_SIDEBAR.html`
- [x] 適用於所有 P5 新聞管線（一般新聞 + 機構評級新聞）

---

## ✅ 所有對接項目已完成

1. ✅ **P5 Weekly AI 輸出 → trigger_decisions**（Prompt 已更新，明確要求 AI 使用機構評級）
2. ✅ **P5 Weekly AI 輸出 → u_adjustment**（Prompt 已更新，明確要求 AI 使用機構評級）
3. ✅ **歷史機構評級查詢接口**（`getInstitutionalRatingsFromDatabase()` 已實作）
4. ✅ **可信度評分計算和學習系統整合**（`INSTITUTIONAL_RATINGS_LEARNING_LOG` 已實作）
5. ✅ **新聞品質測試系統**（適用於所有 P5 新聞管線）

---

## 📝 後續行動

1. ✅ **已完成**：更新 `24_P5_WEEKLY_PROMPT.js`，確保 AI 模型在輸出 `trigger_decisions` 和 `u_adjustment` 時明確參考機構評級數據
2. ✅ **已完成**：創建歷史機構評級查詢接口（`getInstitutionalRatingsFromDatabase()`）
3. ⏳ **待測試**：執行 P5 Weekly 完整流程，確認所有數據流都正確對接

---

**檢查日期**：2026-01-18  
**版本**：V8.9（V8.6 基礎上新增 CSE 新聞碎片重構法 + 機構評級獨立資料庫 + 新聞品質測試）  
**狀態**：✅ **全部完成**（包含 V8.9 HTTP 503 封鎖時的 CSE 備援機制 + 機構評級獨立資料庫和歷史動態學習 + 新聞品質測試系統）

---

## 🔍 V8.9 新增：CSE 新聞碎片重構法（HTTP 503 封鎖備援）

### 問題背景
- Yahoo Finance 和 Finviz 已封鎖 GAS IP（HTTP 503 / 429）
- 直接抓取方式無法使用

### 解決方案：V8.9 CSE 新聞碎片重構法
- ✅ 當直接抓取失敗（HTTP 503/429）時，自動切換到 CSE 備援
- ✅ 鎖定 Tier 2 快訊聚合網站：
  - **美股**：The Fly (thefly.com) - 格式最標準
  - **台股**：鉅亨網 (anue.com.tw) - 外資報告編譯最快
  - **日股**：Minkabu (minkabu.jp) - 評級更新最快
- ✅ 從標準化新聞標題重構歷史評級事件（Who/When/What）

### 實作內容
- [x] 新增 CSE 配置 `P5_INSTITUTIONAL_RATINGS`（鎖定 Tier 2 網站）
- [x] `fetchFinvizHistory()` 失敗時自動切換到 CSE
- [x] `fetchYahooHistoryFromJSON()` 失敗時自動切換到 CSE
- [x] `fetchInstitutionalRatingsFromCSE()` - CSE 新聞碎片重構主函數
- [x] 新聞標題解析器（提取機構、動作、目標價、日期）
- [x] 支援美股/台股/日股的不同標題格式

### 數據流對接（✅ 完整）
- ✅ CSE 備援 → `getHistoricalRatings()` → `analyzeSmartSentiment()`（價格反應驗證）
- ✅ CSE 備援 → `collectMarketSentimentIndicators()` → P5 Weekly Prompt
- ✅ CSE 備援 → P5 Weekly Learning Log（歷史記錄）

### 注意事項
- ⚠️ **需要配置 CSE**：`GOOGLE_CSE_CX_P5_INSTITUTIONAL_RATINGS`（需要在 PropertiesService 中設置）
- ⚠️ **CSE 白名單**：需要在 Google CSE 後台設定為只搜尋 Tier 2 網站（The Fly、鉅亨網、Minkabu）
- ⚠️ **解析準確度**：新聞標題解析的準確度依賴標題格式的標準化程度（The Fly 格式最標準，成功率約 95%）

---

## 🔍 V8.9 新增：機構評級獨立資料庫與歷史動態學習（重要更新）

### 1. 獨立資料庫設計 ✅ **已完成**

**文件**：`src/01_SHEETS_STRUCTURE.js`

- [x] 創建 `INSTITUTIONAL_RATINGS_DAILY` 表格（獨立於 `NEWS_ATOMS_DAILY`）
- [x] 創建 `INSTITUTIONAL_RATINGS_LEARNING_LOG` 表格（多時間維度可信度評分）

**定位**：
- ⚠️ 「帶風向面」的資料，用於事後驗證指標（非預先判斷）
- ✅ 獨立於原來的十大分類之外
- ✅ 與後續股價變化比對（多時間維度：短期 1-5 天、中期 7-15 天、長期 16-30 天）

### 2. 數據收集層 ✅ **已完成**

**文件**：`src/24_P5_DAILY_INSTITUTIONAL_RATINGS.js`（新增）

- [x] `collectInstitutionalRatings()` - P5 Daily 收集函數
- [x] 使用專屬 CSE `P5_INSTITUTIONAL_RATINGS`（白名單：The Fly, StreetInsider, Benzinga, TipRanks, 鉅亨網, 經濟日報, 工商時報, Minkabu, Kabutan, Traders Web）
- [x] 只收錄有持股的歷史評級（從 `Phase1_Master_Candidates` 或 `Phase2_Output` 讀取）
- [x] 只追蹤各市場五大龍頭機構（美股 5 家、台股 5 家、日股 5 家）
- [x] 機構名稱標準化（建立對照表）
- [x] 評級動作標準化（建立多語對照表）

### 3. 數據整合層 ✅ **已完成**

**文件**：`src/24_P5_WEEKLY_SENTIMENT.js`

- [x] `getInstitutionalRatingsFromDatabase()` - 從 `INSTITUTIONAL_RATINGS_DAILY` 讀取
- [x] `getPriceReaction()` - 擴展支援多時間維度（短期 1-5 天、中期 7-15 天、長期 16-30 天）
- [x] `getPriceReactionInRange()` - 新增函數支援特定時間範圍查詢
- [x] `analyzeSmartSentiment()` - 升級版機構言行一致性分析（整合多時間維度驗證結果）
- [x] `collectMarketSentimentIndicators()` - 整合機構評級資料（優先從資料庫讀取）
  - [x] 整合到 `fpe_b` 和 `institutional_sentiment` 欄位

### 4. AI 模型接口層 ✅ **已完成**

**文件**：`src/24_P5_WEEKLY_PROMPT.js`

- [x] Prompt 中已包含 `market_sentiment_indicators` 數據
- [x] 已說明 `warnings`（誘多/誘空）的戰略意義
- [x] **已更新**：明確要求 AI 在輸出 `u_adjustment` 和 `trigger_decisions` 時參考機構評級資料（包含 `warnings`、`sentiment_label`、`institutional_credibility_reference`）
- [x] **已更新**：說明多時間維度價格反應驗證和機構可信度評分

### 5. 決策系統接口層 ✅ **已完成**

**文件**：`src/24_P5_WEEKLY_CORE.js` + `src/24_P5_WEEKLY_PROMPT.js`

- [x] `executeP5WeeklyTriggerDecisions()` - Prompt 已明確要求 AI 在輸出 `trigger_decisions` 時參考機構評級的 `warnings`
- [x] `applyUAdjustment()` - Prompt 已明確要求 AI 在輸出 `u_adjustment` 時參考機構評級的 `sentiment_label` 和 `warnings`
- [x] AI 模型會根據 Prompt 指示使用機構評級資料進行決策

### 6. 歷史動態學習系統 ✅ **已完成**

**文件**：`src/24_P5_WEEKLY_LEARNING.js` + `src/24_P5_INSTITUTIONAL_RATINGS_LEARNING.js`（新增）

- [x] `saveP5WeeklyLearningLog()` - 新增 `institutional_ratings_credibility` 欄位
- [x] `getInstitutionalCredibilitySummary()` - 獲取機構可信度摘要（新增）
- [x] `updateInstitutionalRatingsCredibility()` - 更新單筆評級可信度（新增）
- [x] `updateInstitutionalRatingsCredibilityBatch()` - 批量更新可信度（新增，P5 Daily 調用）
- [x] 記錄各大機構在不同時間維度的可信度評分
- [x] 格式：`{ "GOLDMAN_SACHS": { "short_term": 0.6, "mid_term": 0.8, "long_term": 0.75, "final": 0.72 }, ... }`

**可信度評分更新機制**：
- [x] 短期可信度：評級發布後 5 天更新
- [x] 中期可信度：評級發布後 15 天更新
- [x] 長期可信度：評級發布後 30 天更新
- [x] 最終可信度：所有時間維度完成後更新（加權平均：短期 30%、中期 40%、長期 30%）

**去重邏輯**：
- [x] 同一個機構對同一檔股票，一個月內只看最新的一條動作
- [x] 如果同一個機構在一個月內發布兩次評級，使用「最新覆蓋舊的」邏輯

### 7. 數據流對接完整性確認 ✅

**用戶明確要求**：這些辛辛苦苦的資料與分析，都要進入：
1. ✅ **Weekly 的決策系統因子之中**
2. ✅ **歷史動態學習系統之中**

**對接檢查清單**：
- [x] 機構評級資料收集 → `INSTITUTIONAL_RATINGS_DAILY`（P5 Daily 執行）
- [x] 機構評級資料 → `collectMarketSentimentIndicators()` → P5 Weekly Prompt（優先從資料庫讀取）
- [x] 多數機構的預測共識 → `fpe_b` → P5 Weekly Prompt
- [x] 股價反應驗證 → `INSTITUTIONAL_RATINGS_LEARNING_LOG` → 可信度評分（P5 Daily 批量更新）
- [x] 可信度評分 → `P5__LEARNING_LOG` → 歷史動態學習系統（`institutional_ratings_credibility` 欄位）
- [x] P5 Weekly 決策系統使用機構評級資料（`u_adjustment`、`trigger_decisions` 參考 `warnings` 和 `sentiment_label`）
- [x] ⭐ V8.9 新增：新聞品質測試系統 → 適用於所有 P5 新聞管線（`testAllP5NewsQuality()`）
