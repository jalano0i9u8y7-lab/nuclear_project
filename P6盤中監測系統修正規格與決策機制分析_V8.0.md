# P6 盤中監測系統修正規格與決策機制分析

> **版本**：V8.0  
> **日期**：2025-01-17  
> **修正內容**：選擇權監控範圍、P4.6 職權搬移、緊急撤退決策機制

---

## ✅ 一、修正內容

### 1.1 選擇權個股監控範圍修正

#### ❌ 原設計（錯誤）
- 從 `DERIVATIVES_DAILY` 表格識別所有有期權數據的個股
- 監控所有選擇權個股

#### ✅ 修正後（正確）
- **監控對象**：僅監控「已經持有的」選擇權對應標的個股
- **識別方式**：
  - 讀取持倉列表（從 P4 快照或 HOLDINGS 表格）
  - 檢查該個股是否有對應的選擇權持倉
  - 如果有選擇權持倉，標記為「選擇權個股」
- **監控頻率**：每 5 分鐘（僅盤中時段）
- **監控時段**：
  - **台股選擇權**：09:00 - 13:30（僅盤中）
  - **美股選擇權**：22:30 - 05:00（冬令）/ 21:30 - 04:00（夏令，僅盤中）
  - **日股選擇權**：08:00 - 14:00（僅盤中）
  - **不監控盤前/盤後**：選擇權無法盤前盤後交易

---

### 1.2 P4.6 職權搬移到 P6

#### ❌ 原設計（職權不清）
- P4.6 負責緊急撤退協議
- P6 偵測異常後調用 P4.6

#### ✅ 修正後（正確職權分工）

**P6 的新職責**：
- **盤中監測**（原有功能）
- **盤中緊急撤退協議**（從 P4.6 搬移）
- **緊急撤退執行與記錄**（從 P4.6 搬移）

**P4.6 的調整**：
- **保留**：日結後的緊急撤退評估（作為戰略層面）
- **移除**：盤中即時撤退執行（搬移到 P6）

**理由**：
- **P6**：負責盤中即時監控與反應（戰術層面）
- **P4.6**：負責日結後的戰略評估（戰略層面）
- **職權清晰**：盤中 = P6，日結 = P4.6

---

## 🤔 二、緊急撤退決策機制深度分析

### 2.1 核心問題

**盤中緊急事件觸動緊急撤退機制時：**
- **選項 A**：程式寫死馬上賣出的資金比例（Rule-Based）
- **選項 B**：AI 模型根據當時情形和所有已知數據做出緊急策略

**哪個做法比較好？**

---

### 2.2 分析框架

#### A. 時間維度分析

| 維度 | Rule-Based | AI 決策 |
|------|-----------|---------|
| **響應時間** | < 1 秒 | 10-30 秒（至少） |
| **數據需求** | 無需完整數據 | 需要完整上下文 |
| **穩定性** | 100% 可預測 | 依賴模型狀態 |

**結論**：盤中緊急事件是「分鐘級甚至秒級」，AI 響應時間不適合。

---

#### B. 數據質量分析

#### 盤中數據特性
- **GOOGLEFINANCE 延遲**：15-20 分鐘
- **成交量尚未定型**：可能只是瞬間異常
- **新聞未確認**：真相不明
- **極端跳點**：容易被污染

#### Rule-Based 的優勢
- ✅ **不依賴數據完整性**：即使數據延遲/污染，規則依然可執行
- ✅ **可預期最壞情境**：事前定義好所有情況的對應動作

#### AI 決策的劣勢
- ❌ **需要完整上下文**：盤中數據不完整，AI 判斷可能錯誤
- ❌ **極端行情下失效**：歷史相似性急劇下降，模型假設失效
- ❌ **不可預期**：無法事前審計最壞情境

**結論**：盤中數據本身就是「污染態」，不適合讓 AI 做關鍵決策。

---

#### C. 決策目標分析

#### 盤中緊急動作的目標

> **「降低 Delta、縮小尾部風險」**

**不是**：
- ❌ 最佳化收益
- ❌ 聰明地判斷
- ❌ 預測未來

**而是**：
- ✅ **活下來**
- ✅ **降低風險暴露**
- ✅ **保護資本**

#### Rule-Based 符合目標
- ✅ **降低風險暴露**：寫死的減倉比例，可事前驗證
- ✅ **保護資本**：不依賴複雜推理，直接執行防禦動作

#### AI 決策不符合目標
- ❌ **增加不確定性**：AI 判斷可能有誤，反而增加風險
- ❌ **違反「前端摘要錯，後面再怎麼推理都沒救」原則**

**結論**：盤中緊急動作的目標是「生存」而非「最佳化」，Rule-Based 更適合。

---

### 2.3 GPT 建議的核心設計

#### 🧱 三層式盤中緊急撤退機制

---

#### **Layer 1：硬寫死的即時防禦（必須存在，無 AI）**

**觸發條件（寫死）**：
- 單日跌幅 ≥ X%（例如 6%）
- 20 分鐘內急殺 ≥ Y%（例如 2%）
- 主要指數暴跌 ≥ Z%（例如 4%）
- 持倉組合整體跌幅 ≥ W%（例如 5%）

**動作（寫死）**：
- 減碼固定比例（例如非核心倉 30-50%）
- 觸發既有停損單（P3 已有）
- 標記為「防禦模式」

**⚠️ 這一層完全不准 AI 參與**

**理由**：
- 時間緊迫：需要立即反應
- 數據不完整：盤中數據可能延遲/污染
- 目標明確：降低風險，不是最佳化收益

---

#### **Layer 2：AI =「盤後/延後裁決者」**

**時機**：
- ✅ 市場收盤
- ✅ 數據定型
- ✅ 新聞確認
- ✅ 波動率穩定

**AI 的工作**：
- 事件定性（黑天鵝 / 系統性 / 個股）
- 判斷是否過度反應
- 隔天策略（回補 / 繼續減碼 / 凍結）

**整合點**：
- P5 Weekly：AI 深度分析盤中事件
- P3：技術結構是否改變
- P5 Daily：更新世界觀

**👉 這一層你原本的 P5 Weekly / P3 就已經很適合了**

---

#### **Layer 3：人類 Override（保留）**

**時機**：
- Layer 1 執行後
- 收到 LINE 通知後

**人類權限**：
- ✅ 確認或取消撤退計劃
- ✅ 調整減倉比例
- ✅ 手動執行或暫停

**理由**：
- 對高資金量非常重要
- 人類可以綜合更多資訊（新聞、直覺等）
- 保留最終控制權

---

### 2.4 折衷方案（如果一定要 AI 參與）

**唯一可接受的折衷**：

> **AI 不是決策者，而是「風險分級器」**

#### 設計方式

1. **程式先執行寫死減碼**（Layer 1）
2. **AI 只回答一個問題**：
   > 這是 Level 1 / Level 2 / Level 3 事件？

#### 風險分級定義

- **Level 1（輕微）**：
  - 單檔異常，非系統性
  - 減倉比例：20-30%
  
- **Level 2（中等）**：
  - 多檔異常或主要指數暴跌
  - 減倉比例：30-50%
  
- **Level 3（嚴重）**：
  - 系統性崩盤或黑天鵝
  - 減倉比例：50-70%

#### AI 不做的事

- ❌ AI 決定賣多少
- ❌ AI 決定現在該不該賣
- ❌ AI 做即時交易決策

**只做**：
- ✅ 事件分級（盤後或延後執行）
- ✅ 用於調整後續策略（P5 Weekly）

---

## 🎯 三、最終建議

### 3.1 建議採用：**Layer 1 寫死 + Layer 2 AI 盤後**

**理由**：

1. **符合系統定位**：
   - 中長期投資系統
   - 不追求盤中交易
   - 目標是「生存」而非「最佳化」

2. **技術可行性**：
   - 盤中數據延遲/污染
   - AI 響應時間不適合
   - Rule-Based 可事前驗證

3. **符合現有架構**：
   - P5 Weekly 已有 AI 分析
   - P3 已有技術分析
   - 不增加系統複雜度

---

### 3.2 具體設計方案

#### A. 盤中即時防禦（Layer 1，寫死）

**觸發條件與對應動作**：

| 觸發條件 | 對應動作 | 減倉比例 |
|---------|---------|---------|
| **單檔持倉暴跌 > 6%** | 減倉該檔股票 | 50% |
| **持倉組合整體跌幅 > 5%** | 整體減倉 | 30% |
| **主要指數暴跌 > 4%** | 整體減倉 | 25% |
| **20 分鐘內急殺 > 2%** | 減倉急殺股票 | 40% |
| **3 檔以上同時爆量（> 3 倍）** | 減倉爆量股票 | 40% |
| **DEFCON 升級至 DEFCON_1** | 整體減倉 | 60% |
| **DEFCON 升級至 DEFCON_2** | 整體減倉 | 40% |

**執行邏輯**：
1. 偵測到觸發條件
2. 立即執行寫死的減倉動作（不等待 AI）
3. 記錄到 `P6_EMERGENCY_EXIT_LOG`
4. 發送 LINE 通知（Critical 級別）
5. 等待用戶確認（或自動執行，根據配置）

---

#### B. 盤後 AI 分析（Layer 2，整合到現有流程）

**時機**：
- P5 Daily 執行時（收盤後）
- P5 Weekly 執行時（週末）

**AI 的工作**：

1. **事件定性**（P5 Weekly）：
   - 黑天鵝事件？
   - 系統性風險？
   - 個股特定事件？

2. **判斷是否過度反應**（P5 Weekly）：
   - 減倉是否過度？
   - 是否需要回補？

3. **調整策略**（P5 Weekly）：
   - 是否需要調整持倉？
   - 是否需要調整買賣點（P3）？

**整合方式**：
- P6 盤中異常記錄 → `P6_INTRADAY_SUMMARY`
- P5 Weekly 讀取 → 作為策略制定的輸入數據
- AI 分析 → 生成調整建議

---

#### C. 人類 Override（Layer 3）

**時機**：
- 收到 LINE 通知後
- 查看 `P6_EMERGENCY_EXIT_LOG` 後

**人類權限**：
- 確認或取消撤退計劃
- 調整減倉比例
- 手動執行或暫停

**實現方式**：
- UI 側邊欄顯示最新撤退計劃
- 提供確認/取消按鈕
- 或直接修改 `execution_status` 欄位

---

## 🔺 四、盤中「暴漲」監控設計

### 4.1 為什麼也要監控暴漲？

#### 核心原因

> **暴漲 ≠ 可以睡覺  
> 暴漲 = 需要注意隔天的風險**

#### 理由

1. **盤中暴漲 = 風險形態改變**
   - 事件觸發（消息、法規、併購、政策）
   - Gamma 瞬間放大
   - IV 急升
   - 次日回吐風險極高

2. **系統假設被破壞**
   - P3 的買賣點可能失效
   - 需要重新評估技術結構

3. **不動作 ≠ 保守**
   - 不降風險 = 賭運氣
   - 需要風控管理

---

### 4.2 暴漲監控設計（% + ATR 綜合）

#### 觸發條件（必須同時成立）

**條件 A｜絕對漲幅（事件感測）**
```
盤中漲幅 ≥ +6%
```

**條件 B｜相對波動（結構破壞）**
```
| 當前價格 - 前收 | ≥ 1.8 × ATR(14)
```

**條件 C（可選）｜量能確認**
```
成交量 ≥ 2.5 × 20 日平均量
```

---

#### 觸發後的寫死動作（不交易，只做風控）

**系統狀態標記**：
```javascript
INTRADAY_STATE = "OVEREXTENDED_UP"
```

**自動執行的行為**：
- ❌ **禁止任何追價型新掛單**
- ❌ **禁止新增部位**
- ✅ **允許既有停利掛單被動成交**
- ✅ **核心倉完全不動**
- ✅ **標記為「盤後強制檢查」**

**通知（LINE Bot）**：
```
⚠️【盤中異常上噴】
NVDA +7.4%｜2.1×ATR｜Vol 3.0×
狀態：OVEREXTENDED_UP
動作：凍結追價，盤後強制檢查
```

---

#### 盤後 AI 分析

**AI 的工作**（P5 Weekly）：
- 判斷這次上噴是「重估」還是「情緒」
- 是否需要移動 Sell / Buy 區間（P3）
- 是否改變核心倉假設

---

### 4.3 暴跌監控設計（對稱設計）

#### 觸發條件

**條件 A｜絕對跌幅**
```
盤中跌幅 ≤ -5%
```

**條件 B｜相對波動**
```
| 當前價格 - 前收 | ≥ 1.6 × ATR(14)
```
> ⚠️ 跌的 ATR 門檻比漲低（1.6 vs 1.8），因為下跌通常更快

**條件 C｜量能**
```
成交量 ≥ 2.0 × 20 日平均量
```

---

#### 觸發後的寫死動作

**系統狀態標記**：
```javascript
INTRADAY_STATE = "OVEREXTENDED_DOWN"
```

**自動執行的行為**：
- ✅ **啟用既有停損掛單**（P3 已有）
- ❌ **不市價砍倉**
- ❌ **不重新計算策略**
- ✅ **僅「標記 + 通知」**

---

## 📊 五、最終設計方案總結

### 5.1 盤中監控邏輯（雙向）

| 事件類型 | 觸發條件 | 寫死動作 | AI 參與 |
|---------|---------|---------|---------|
| **暴跌** | 跌幅 ≥ 6% 或 急殺 ≥ 2% | 減倉固定比例 | ❌ 不參與 |
| **暴漲** | 漲幅 ≥ 6% 且 ≥ 1.8×ATR | 凍結追價，標記狀態 | ❌ 不參與 |
| **爆量** | 成交量 ≥ 2.5 倍 | 標記異常，通知 | ❌ 不參與 |

---

### 5.2 緊急撤退執行流程

```
P6 偵測異常 
→ Layer 1：立即執行寫死減倉（無 AI）
→ 記錄到 P6_EMERGENCY_EXIT_LOG
→ LINE 通知（Critical）
→ Layer 3：等待用戶確認
→ Layer 2：盤後 AI 分析（P5 Weekly）
```

---

### 5.3 AI 出現的時機

**盤中**：
- ❌ 不做決策
- ❌ 不做即時判斷
- ✅ 僅作為風險分級器（可選，但非必需）

**盤後**：
- ✅ P5 Daily：事件定性
- ✅ P5 Weekly：策略調整建議
- ✅ P3：技術結構重新評估

---

## 🎯 六、設計哲學總結

### 6.1 核心原則

> **盤中監控 = 感測器  
> 寫死規則 = 安全氣囊  
> AI = 事後醫生**

---

### 6.2 為什麼這樣設計？

1. **符合中長期投資定位**：
   - 不追求盤中交易
   - 目標是「生存」而非「最佳化」

2. **技術可行性**：
   - 盤中數據延遲/污染
   - AI 響應時間不適合
   - Rule-Based 可事前驗證

3. **符合現有架構**：
   - 不增加系統複雜度
   - 利用現有的 P5 Weekly AI 分析

4. **風險控制**：
   - 可預期最壞情境
   - 可事前審計
   - 不依賴模型穩定性

---

### 6.3 一句話定錨

> **盤中 = 防災演習 → SOP  
> 盤後 = 調整戰略 → AI**

任何把 AI 拉進盤中即時裁決的系統，**在資金變大後，失敗只是時間問題，不是能力問題。**

---

## 📋 七、具體實施建議

### 7.1 P6 緊急撤退功能（從 P4.6 搬移）

#### 新函數：`P6_EmergencyExit_Intraday()`

**功能**：
- 盤中緊急撤退協議（從 P4.6 搬移）
- 執行寫死的減倉動作
- 記錄撤退計劃到 `P6_EMERGENCY_EXIT_LOG`

**輸入參數**：
- `trigger_type`：觸發類型
- `trigger_details`：觸發詳情
- `current_positions`：當前持倉（從 P4 讀取）

**輸出**：
- 撤退計劃（JSON）
- 記錄到表格

---

### 7.2 保留 P4.6 的功能

#### 調整後：`P4_6_EmergencyExit_Strategic()`

**功能**：
- 日結後的戰略評估
- 基於完整數據的分析
- 生成長期調整建議

**用途**：
- P5 Weekly 觸發
- 基於日結數據做深度分析
- AI 可以參與（因為數據完整、時間充裕）

---

### 7.3 數據結構調整

#### P6_EMERGENCY_EXIT_LOG 表格（新增）

| 欄位 | 說明 |
|------|------|
| **exit_id** | 撤退 ID |
| **timestamp** | 觸發時間 |
| **date** | 日期 |
| **trigger_type** | 觸發類型 |
| **trigger_details** | 觸發詳情（JSON） |
| **reduction_pct** | 減倉比例（寫死） |
| **stocks_to_sell** | 要賣出的股票列表（JSON） |
| **sell_quantities** | 每檔股票的賣出數量（JSON） |
| **execution_status** | 執行狀態（PENDING / EXECUTED / CANCELLED） |
| **human_override** | 人類調整（JSON，如果有） |
| **p5_weekly_analysis** | P5 Weekly AI 分析結果（JSON，盤後填入） |

---

## ✅ 八、最終結論

### 8.1 緊急撤退決策機制

**結論**：✅ **採用 Layer 1 寫死 + Layer 2 AI 盤後**

**理由**：
1. 盤中緊急事件需要立即反應，AI 響應時間不適合
2. 盤中數據延遲/污染，不適合 AI 做關鍵決策
3. 盤中動作目標是「生存」，Rule-Based 更適合
4. AI 在盤後分析更有效（數據完整、時間充裕）

---

### 8.2 職權分工

**P6**：
- 盤中監測
- 盤中緊急撤退協議（從 P4.6 搬移）
- 盤中緊急撤退執行（從 P4.6 搬移）

**P4.6**：
- 日結後的戰略評估（保留）
- 長期調整建議（保留）

---

### 8.3 盤中監控範圍

**監控對象**：
- ✅ 持倉股票
- ✅ 選擇權個股（僅已持有的）
- ✅ 主要指數
- ✅ 板塊 ETF
- ✅ 追蹤池股票

**監控方向**：
- ✅ 暴跌監控（風險控制）
- ✅ 暴漲監控（風險管理）

---

**生成時間**：2025-01-17  
**狀態**：待實施  
**建議**：採用 Layer 1 寫死 + Layer 2 AI 盤後的設計
