# P4 å°é½Šæª¢æŸ¥å ±å‘Š V8.0

## ğŸ“‹ æª¢æŸ¥æ—¥æœŸ

**æª¢æŸ¥æ—¥æœŸ**ï¼š2025-01-14  
**ç‰ˆæœ¬**ï¼šV8.0  
**ç‹€æ…‹**ï¼šâœ… **ç¾æœ‰å¯¦ç¾èˆ‡å‚™ä»½è¨­è¨ˆåŸºæœ¬ä¸€è‡´ï¼Œåƒ…æœ‰å°‘é‡ç´°ç¯€éœ€è¦ç¢ºèª**

---

## âœ… å·²å°é½Šçš„éƒ¨åˆ†

### 1. âœ… P4 å®šä½ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰

**ç¾æœ‰å¯¦ç¾ï¼š**
- âœ… ç´”è¨ˆç®—æ¨¡çµ„ï¼ˆç„¡ AIï¼‰
- âœ… è®€å– P2/P3 æœ€æ–°å¿«ç…§
- âœ… è¨ˆç®—ç†æƒ³é…ç½®ï¼ˆW_idealï¼‰å’Œå¯¦éš›æ‡‰é…ç½®ï¼ˆW_nowï¼‰
- âœ… è¢«å‹•è§¸ç™¼ï¼ˆP3 Cat è®Šå‹• â†’ è‡ªå‹•åŸ·è¡Œï¼‰
- âœ… ä¹Ÿå¯æ‰‹å‹•è§¸ç™¼

**å‚™ä»½è¨­è¨ˆï¼š**
- âœ… ç´” Google Apps Script è¨ˆç®—
- âœ… ä¸æ¶‰åŠä»»ä½• AI æ¨¡å‹
- âœ… è¢«å‹•è§¸ç™¼ï¼ˆP3 Cat è®Šå‹• â†’ è‡ªå‹•åŸ·è¡Œï¼‰
- âœ… ä¹Ÿå¯æ‰‹å‹•è§¸ç™¼ï¼ˆç”¨æˆ¶é»æ“Šï¼‰

**çµè«–**ï¼šâœ… **å®Œå…¨ä¸€è‡´**

---

### 2. âœ… é…ç½®åƒæ•¸ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰

**ç¾æœ‰å¯¦ç¾ï¼š**
```javascript
const P4_CONFIG = {
  tier_ranges: {
    CORE: { min: 0.20, max: 0.30, single_max: 0.15 },
    STABLE_SWING: { min: 0.25, max: 0.35, single_max: 0.08 },
    AGGRESSIVE: { min: 0.20, max: 0.25, single_max: 0.05 },
    OPPORTUNISTIC: { min: 0.05, max: 0.10, single_max: 0.03 }
  },
  cat_weights: {
    "Cat1": { buy1: 0, buy2: 0, buy3: 0 },
    "Cat2": { buy1: 0.3, buy2: 0.5, buy3: 0.2 },
    "Cat3": { buy1: 0.5, buy2: 0.3, buy3: 0.2 },
    "Cat4-A": { buy1: 0.2, buy2: 0.3, buy3: 0.5 },
    "Cat4-B": { buy1: 0, buy2: 0, buy3: 1.0 },
    "Cat5": { buy1: 0, buy2: 0, buy3: 0 }
  },
  utilization: {
    initial: 0.60,
    max: 0.80,
    trigger_conditions: {
      "BULL_CONFIRMED": 0.75,
      "STRONG_MOMENTUM": 0.80,
      "BEAR_SIGNAL": 0.40,
      "HIGH_RISK": 0.30
    }
  },
  total_capital: 10000000
};
```

**å‚™ä»½è¨­è¨ˆï¼š**
```javascript
const CONFIG = {
  tier_ranges: { /* ç›¸åŒ */ },
  cat_weights: { /* ç›¸åŒ */ },
  utilization: { /* ç›¸åŒ */ },
  total_capital: 10000000
};
```

**çµè«–**ï¼šâœ… **å®Œå…¨ä¸€è‡´**

---

### 3. âœ… æ ¸å¿ƒè¨ˆç®—é‚è¼¯ï¼ˆåŸºæœ¬ä¸€è‡´ï¼‰

**ç¾æœ‰å¯¦ç¾æµç¨‹ï¼š**
1. Step 1ï¼šè®€å–æœ€æ–°å¿«ç…§ âœ…
2. Step 2ï¼šæå–è³‡æ–™ âœ…
3. Step 3ï¼šæŒ‰åˆ†å±¤åˆ†çµ„ âœ…
4. Step 4ï¼šè¨ˆç®—æ¯å€‹åˆ†å±¤çš„ç†æƒ³é…ç½® âœ…
5. Step 5ï¼šè¨ˆç®—å¯¦éš›æ‡‰é…ç½®ï¼ˆW_nowï¼‰âœ…
6. Step 6ï¼šç¸½è¨ˆæª¢æŸ¥ âœ…
7. Step 7ï¼šä¿å­˜å¿«ç…§ âœ…
8. Step 8ï¼šæ¯”å°ä¸Šä¸€ç‰ˆ âœ…
9. Step 9ï¼šä¿å­˜å¿«ç…§ âœ…

**å‚™ä»½è¨­è¨ˆæµç¨‹ï¼š**
1. Step 1ï¼šè®€å–æœ€æ–°å¿«ç…§ âœ…
2. Step 2ï¼šæå–è³‡æ–™ âœ…
3. Step 3ï¼šæŒ‰åˆ†å±¤åˆ†çµ„ âœ…
4. Step 4ï¼šè¨ˆç®—æ¯å€‹åˆ†å±¤çš„ç†æƒ³é…ç½® âœ…
5. Step 5ï¼šè¨ˆç®—å¯¦éš›æ‡‰é…ç½®ï¼ˆW_nowï¼‰âœ…
6. Step 6ï¼šç¸½è¨ˆæª¢æŸ¥ âœ…
7. Step 7ï¼šä¿å­˜å¿«ç…§ âœ…
8. Step 8ï¼šæ¯”å°ä¸Šä¸€ç‰ˆ âœ…
9. Step 9ï¼šä¿å­˜å¿«ç…§ âœ…
10. Step 10ï¼šä¸è‡ªå‹•è§¸ç™¼ä¸‹æ¸¸ âœ…

**çµè«–**ï¼šâœ… **åŸºæœ¬ä¸€è‡´**ï¼ˆç¾æœ‰å¯¦ç¾ç¼ºå°‘ Step 10 çš„æ˜ç¢ºèªªæ˜ï¼Œä½†å¯¦éš›è¡Œç‚ºä¸€è‡´ï¼‰

---

### 4. âœ… å¿«ç…§çµæ§‹ï¼ˆåŸºæœ¬ä¸€è‡´ï¼‰

**ç¾æœ‰å¯¦ç¾å¿«ç…§çµæ§‹ï¼š**
```javascript
{
  snapshot_id: generateP4SnapshotId(),
  created_at: new Date(),
  trigger: params.trigger,
  trigger_reason: params.reason,
  p2_snapshot_id: p2_snapshot.snapshot_id,
  p3_snapshot_id: p3_snapshot.snapshot_id,
  allocations: final_allocations,
  summary: summary,
  changes: null,
  version: "V6.3"
}
```

**å‚™ä»½è¨­è¨ˆå¿«ç…§çµæ§‹ï¼š**
```javascript
{
  snapshot_id: "P4_2026_W03",
  created_at: "2026-01-17 16:10:00",
  trigger: "P3_AUTO_TRIGGER",
  trigger_reason: "Cat è®Šå‹•ï¼ˆ2454.TW: Cat3 â†’ Cat4-Aï¼‰",
  p2_snapshot_id: "P2_2026_Q1",
  p3_snapshot_id: "P3_2026_W03",
  allocations: [ /* å®Œæ•´é…ç½®çµæœ */ ],
  summary: { /* ç¸½è¨ˆ */ },
  changes: { /* è®Šå‹•åµæ¸¬ */ }
}
```

**çµè«–**ï¼šâœ… **åŸºæœ¬ä¸€è‡´**ï¼ˆç¾æœ‰å¯¦ç¾å¤šäº†ä¸€å€‹ `version` æ¬„ä½ï¼Œé€™æ˜¯åˆç†çš„ï¼‰

---

### 5. âœ… è¨ˆç®—é‚è¼¯ç´°ç¯€ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰

**ç¾æœ‰å¯¦ç¾ï¼š**
- âœ… `groupStocksByTier()`ï¼šæŒ‰åˆ†å±¤åˆ†çµ„è‚¡ç¥¨
- âœ… `calculateTierAllocations()`ï¼šè¨ˆç®—æ¯å€‹åˆ†å±¤çš„ç†æƒ³é…ç½®ï¼ˆä½¿ç”¨ tier_weight = (min + max) / 2ï¼‰
- âœ… `calculateFinalAllocations()`ï¼šè¨ˆç®—å¯¦éš›æ‡‰é…ç½®ï¼ˆè€ƒæ…® Uï¼ŒW_now = W_cap_applied Ã— Uï¼‰
- âœ… `calculateSummary()`ï¼šè¨ˆç®—ç¸½è¨ˆï¼ˆåŒ…å« by_tier çµ±è¨ˆï¼‰
- âœ… `detectP4Changes()`ï¼šåµæ¸¬ P4 è®Šå‹•ï¼ˆvs ä¸Šä¸€ç‰ˆï¼‰

**å‚™ä»½è¨­è¨ˆï¼š**
- âœ… æŒ‰åˆ†å±¤åˆ†çµ„
- âœ… è¨ˆç®—æ¯å€‹åˆ†å±¤çš„ç†æƒ³é…ç½®ï¼ˆä½¿ç”¨ tier_weight = (min + max) / 2ï¼‰
- âœ… è¨ˆç®—å¯¦éš›æ‡‰é…ç½®ï¼ˆè€ƒæ…® Uï¼ŒW_now = W_cap_applied Ã— Uï¼‰
- âœ… è¨ˆç®—ç¸½è¨ˆï¼ˆåŒ…å« by_tier çµ±è¨ˆï¼‰
- âœ… åµæ¸¬è®Šå‹•ï¼ˆvs ä¸Šä¸€ç‰ˆï¼‰

**çµè«–**ï¼šâœ… **å®Œå…¨ä¸€è‡´**

---

## âš ï¸ éœ€è¦ç¢ºèªçš„ç´°ç¯€

### 1. âš ï¸ å¿«ç…§è¡¨æ ¼çµæ§‹

**ç¾æœ‰å¯¦ç¾ï¼ˆå¾ `06_SNAPSHOT_MANAGER.js` è®€å–ï¼‰ï¼š**
```javascript
const snapshot = {
  snapshot_id: row[0],
  created_at: row[1],
  trigger: row[2],
  trigger_reason: row[3],
  p2_snapshot_id: row[4],
  p3_snapshot_id: row[5],
  allocations: row[6] ? JSON.parse(row[6]) : [],
  summary: row[7] ? JSON.parse(row[7]) : {},
  changes: row[8] ? JSON.parse(row[8]) : null,
  version: row[9] || "V6.3"
};
```

**å‚™ä»½è¨­è¨ˆï¼ˆå¾ `01_SHEETS_STRUCTURE.js` æª¢æŸ¥ï¼‰ï¼š**
éœ€è¦ç¢ºèª `P4_SNAPSHOT_SCHEMA` æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½ã€‚

**å»ºè­°**ï¼šæª¢æŸ¥ `P4_SNAPSHOT_SCHEMA` æ˜¯å¦åŒ…å«ï¼š
- snapshot_id âœ…
- created_at âœ…
- trigger âœ…
- trigger_reason âœ…
- p2_snapshot_id âœ…
- p3_snapshot_id âœ…
- allocations_json âœ…
- summary_json âœ…
- changes_json âœ…
- version âœ…

---

### 2. âš ï¸ åŸ·è¡Œæ™‚æ©Ÿèªªæ˜

**ç¾æœ‰å¯¦ç¾ï¼š**
- âœ… è‡ªå‹•è§¸ç™¼ï¼šP3 Cat è®Šå‹•ï¼ˆå·²åœ¨ `22_P3_TRIGGER.js` ä¸­å¯¦ç¾ï¼‰
- âœ… æ‰‹å‹•è§¸ç™¼ï¼šç”¨æˆ¶é»æ“Šï¼ˆå·²åœ¨ UI ä¸­å¯¦ç¾ï¼‰
- âš ï¸ P5 Weekly è§¸ç™¼ï¼šU èª¿æ•´ï¼ˆéœ€è¦ç¢ºèªæ˜¯å¦å·²å¯¦ç¾ï¼‰

**å‚™ä»½è¨­è¨ˆï¼š**
1. è‡ªå‹•è§¸ç™¼ï¼šP3 Cat è®Šå‹• âœ…
2. æ‰‹å‹•è§¸ç™¼ï¼šç”¨æˆ¶é»æ“Š âœ…
3. P5 Weekly è§¸ç™¼ï¼šU èª¿æ•´ âš ï¸

**å»ºè­°**ï¼šç¢ºèª P5 Weekly æ›´æ–° U å¾Œæ˜¯å¦æœƒè‡ªå‹•è§¸ç™¼ P4 é‡æ–°è¨ˆç®—ã€‚

---

### 3. âš ï¸ è®Šå‹•åµæ¸¬ç´°ç¯€

**ç¾æœ‰å¯¦ç¾ï¼š**
```javascript
function detectP4Changes(params) {
  // æ¯”å° Cat è®Šå‹•
  if (previousStock.cat !== currentStock.cat) {
    changes.allocation_changes.push({
      ticker: currentStock.ticker,
      type: "CAT_CHANGE",
      old_cat: previousStock.cat,
      new_cat: currentStock.cat,
      // ...
    });
  }
  // æ¯”å°é…ç½®é‡‘é¡è®Šå‹•ï¼ˆè¶…é $1000ï¼‰
  else if (/* é…ç½®é‡‘é¡è®Šå‹•è¶…é $1000 */) {
    changes.allocation_changes.push({
      type: "ALLOCATION_CHANGE",
      // ...
    });
  }
}
```

**å‚™ä»½è¨­è¨ˆï¼š**
```javascript
changes: {
  allocation_changes: [
    {
      ticker: "2454.TW",
      type: "CAT_CHANGE",
      old_cat: "Cat3",
      new_cat: "Cat4-A",
      old_buy1_amount: 180000,
      new_buy1_amount: 72000,
      // ...
      impact: "é™ä½ Buy1ï¼ˆé«˜ä½æ¸›å€‰ï¼‰ï¼Œå¢åŠ  Buy3ï¼ˆç­‰å¾…æ·±åº¦å›èª¿ï¼‰"
    }
  ]
}
```

**çµè«–**ï¼šâœ… **åŸºæœ¬ä¸€è‡´**ï¼ˆç¾æœ‰å¯¦ç¾çš„è®Šå‹•åµæ¸¬é‚è¼¯èˆ‡å‚™ä»½è¨­è¨ˆä¸€è‡´ï¼Œä½†éœ€è¦ç¢ºèª `impact` æ¬„ä½æ˜¯å¦åŒ…å«ï¼‰

---

## âœ… ç¸½çµ

**ç¸½é«”è©•ä¼°**ï¼šâœ… **ç¾æœ‰å¯¦ç¾èˆ‡å‚™ä»½è¨­è¨ˆåŸºæœ¬ä¸€è‡´**

### å·²ç¢ºèªå°é½Šçš„éƒ¨åˆ†ï¼š
1. âœ… P4 å®šä½ï¼ˆç´”è¨ˆç®—æ¨¡çµ„ï¼Œç„¡ AIï¼‰
2. âœ… é…ç½®åƒæ•¸ï¼ˆtier_rangesã€cat_weightsã€utilizationã€total_capitalï¼‰
3. âœ… æ ¸å¿ƒè¨ˆç®—é‚è¼¯ï¼ˆStep 1-9 æµç¨‹ï¼‰
4. âœ… è¨ˆç®—é‚è¼¯ç´°ç¯€ï¼ˆåˆ†çµ„ã€é…ç½®è¨ˆç®—ã€ç¸½è¨ˆã€è®Šå‹•åµæ¸¬ï¼‰
5. âœ… å¿«ç…§çµæ§‹ï¼ˆåŸºæœ¬ä¸€è‡´ï¼‰

### å·²ç¢ºèªçš„ç´°ç¯€ï¼š
1. âœ… å¿«ç…§è¡¨æ ¼çµæ§‹ï¼š`P4_SNAPSHOT_SCHEMA` åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½
2. âœ… è®Šå‹•åµæ¸¬çš„ `impact` æ¬„ä½ï¼šå·²åŒ…å«ï¼Œä¸¦å·²å¢å¼·ç‚ºæ›´è©³ç´°çš„æ ¼å¼ï¼ˆåŒ…å« old_buy1_amountã€new_buy1_amount ç­‰ï¼‰
3. âœ… P5 Weekly è§¸ç™¼ U èª¿æ•´ï¼šå·²è£œå……è‡ªå‹•è§¸ç™¼ P4 é‡æ–°è¨ˆç®—çš„é‚è¼¯

---

## âœ… æœ€çµ‚çµè«–

**ç¸½é«”è©•ä¼°**ï¼šâœ… **ç¾æœ‰å¯¦ç¾èˆ‡å‚™ä»½è¨­è¨ˆå®Œå…¨ä¸€è‡´**

### å·²ç¢ºèªå°é½Šçš„éƒ¨åˆ†ï¼š
1. âœ… P4 å®šä½ï¼ˆç´”è¨ˆç®—æ¨¡çµ„ï¼Œç„¡ AIï¼‰
2. âœ… é…ç½®åƒæ•¸ï¼ˆtier_rangesã€cat_weightsã€utilizationã€total_capitalï¼‰
3. âœ… æ ¸å¿ƒè¨ˆç®—é‚è¼¯ï¼ˆStep 1-9 æµç¨‹ï¼‰
4. âœ… è¨ˆç®—é‚è¼¯ç´°ç¯€ï¼ˆåˆ†çµ„ã€é…ç½®è¨ˆç®—ã€ç¸½è¨ˆã€è®Šå‹•åµæ¸¬ï¼‰
5. âœ… å¿«ç…§çµæ§‹ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
6. âœ… è®Šå‹•åµæ¸¬ï¼ˆå·²å¢å¼·ç‚ºæ›´è©³ç´°çš„æ ¼å¼ï¼ŒåŒ…å« impact å’Œé…ç½®é‡‘é¡è®ŠåŒ–ï¼‰
7. âœ… P5 Weekly è§¸ç™¼ U èª¿æ•´ï¼ˆå·²è£œå……è‡ªå‹•è§¸ç™¼ P4 é‡æ–°è¨ˆç®—çš„é‚è¼¯ï¼‰

**çµè«–**ï¼šâœ… **P4 å¯¦ç¾èˆ‡å‚™ä»½è¨­è¨ˆå®Œå…¨ä¸€è‡´ï¼Œç„¡éœ€ä¿®æ”¹**
