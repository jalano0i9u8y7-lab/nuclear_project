# 檢查報告比對：原設計（SSOT／相關文件／舊程式碼）與實作狀態

**日期**：2026-02-03  
**目的**：對照檢查報告所列問題，比對 SSOT、相關文件與 gas_archive／Python 程式碼，區分「已實現／部分實現／架構已規範但未實作／缺口」，並建議是否採用報告建議；**未經您確認前不修改 SSOT**。

---

## C4. Hermes 4 思考過程未強制保存 ⭐⭐⭐

### 檢查報告說法
- 沒有程式碼強制檢查 `include_reasoning`
- 沒有 Parser 提取 `<think>` 內容
- 沒有 DB Schema 存 `reasoning_trace`

### 原設計（SSOT）對照
- **V8.36 架構已規範**（約 349、359–360 行）：
  - ai_outputs / strategy_executions 須含 `final_answer`、`reasoning_trace`、`storage_key`、`model_name` + `include_reasoning`
  - M0 Adapter 須有「think 抽取器」（Parser）與「禁止 OpenRouter 過濾 think」的保護
  - 實作要求：API 端強制 `include_reasoning: true`；程式端 Parser 將 `<think>` 存入 `reasoning_trace`，其餘存 `final_answer`
  - 詳細實作見《GAS 妥協清算與 Python 重建工程備忘錄》

### 實作狀態對照
- **gas_archive**：grep 未發現 `include_reasoning`、`reasoning_trace`、`<think>` 的 M0 層處理；`01_SHEETS_STRUCTURE.js` 有 `"reasoning"` 欄位（約 1040 行）但無法確認是否為 reasoning_trace 用途。**結論：GAS 端未實現強制保存思考過程。**
- **Python**：`src/nuclear/llm/hermes_reasoning_parser.py` **已實現**：
  - `parse_hermes_response(raw_content)`：用正則提取 `<think>...</think>` → `reasoning_trace`，其餘 → `final_answer`
  - 註解對齊 SSOT（Parser 提取 think、禁止過濾）
  - **尚未**：M0 層強制 `include_reasoning` 檢查、DB 寫入 `reasoning_trace`（需 DB schema 與寫入邏輯）

### 差異摘要
| 項目 | SSOT／架構 | GAS | Python |
|------|------------|-----|--------|
| Parser 提取 <think> | ✅ 已規範 | ❌ 無 | ✅ 已實現（hermes_reasoning_parser.py） |
| 強制 include_reasoning 檢查 | ✅ 已規範 | ❌ 無 | ❌ 未見 |
| DB reasoning_trace 寫入 | ✅ 已規範 | ❌ 未確認 | ❌ 未見（需 schema） |

### 建議
- **採用報告建議**：C4 問題成立；架構已寫明，執行層在 GAS 未做、Python 僅有 Parser。
- **建議 SSOT 補強**（若您同意）：在「資料存儲（目標架構）」或 M0 專節明確寫「Python 實作時：M0 呼叫 Hermes 4 須強制帶 `include_reasoning: true` 並在寫入前檢查；Parser 輸出須寫入 `reasoning_trace`（含冷熱儲存策略）」；並在工程備忘錄或遷移清單列「DB schema：ai_outputs / strategy_executions 必含 reasoning_trace、storage_key」。
- **不建議**：刪除或弱化現有 V8.36 規範。

---

## C5. P2-1 與 P2-2 的介面不完整 ⭐⭐

### 檢查報告說法
- P2_1_FACT_MODEL 的 Schema 沒有定義
- P2-2 如何讀取 P2-1 的輸出？
- 中間表欄位與 Phase2_Output 的對應關係？

### 原設計（SSOT）對照
- **約 684、953–968 行**：
  - P2 拆為 P2-1（事實建模）與 P2-2（因果推演）
  - P2-1 產出寫入**中間表** `P2_1_FACT_MODEL`；不對外暴露 Phase2_Output
  - P2-2 讀取 P2-1 並寫入對外 **Phase2_Output**；P3 及下游一律讀 Phase2_Output
  - 「實現注意」：Phase2_Output Schema 與下游介面不變；P2-1 僅為內部中間表

### 實作狀態對照
- **gas_archive**：grep 結果顯示僅有 **Phase2_Output** 的讀寫（`21_P2_FUNDAMENTAL_ANALYSIS.js` 等）；**未見 P2_1_FACT_MODEL** 或獨立 P2-1/P2-2 拆表。即 GAS 時代 P2 為單一階段寫 Phase2_Output，**未實作 P2-1／P2-2 拆層與中間表**。
- **SSOT 與缺口報告**：`SSOT細節缺口檢查報告_2026-01-26.md` 已指出「Phase 快照表欄位」細節在 `01_SHEETS_STRUCTURE.js`，建議 SSOT 補「各 Phase 快照／對外輸出表最小欄位清單」；**未單獨列出 P2_1_FACT_MODEL**。

### 差異摘要
| 項目 | SSOT | GAS | 缺口 |
|------|------|-----|------|
| P2-1 → P2_1_FACT_MODEL | ✅ 有規定 | ❌ 無此表 | 中間表 Schema 未在 SSOT 定義 |
| P2-2 讀 P2-1 再寫 Phase2_Output | ✅ 有規定 | ❌ 未拆層 | 介面與欄位對應未寫明 |
| Phase2_Output 對外 | ✅ 有 | ✅ 有 | 見 01_SHEETS_STRUCTURE |

### 建議
- **採用報告建議**：C5 屬實；SSOT 已定分工，但 **P2_1_FACT_MODEL 的 Schema、P2-2 讀取方式、欄位對應** 未在 SSOT 或附錄定義。
- **建議 SSOT 補強**（若您同意）：在「P2 工作拆分」下新增一小節「P2_1_FACT_MODEL 與 P2-2 介面」：① P2_1_FACT_MODEL 最小欄位清單（或寫「見工程備忘錄／DB 設計，須含 P2-1 產出之事實欄位」）；② P2-2 讀取來源為 P2_1_FACT_MODEL；③ Phase2_Output 與下游介面不變。可一併引用「實作細節對照」附錄或 01_SHEETS_STRUCTURE／工程備忘錄。

---

## C6. WB-1 個股 escalation 觸發後的資料流斷鏈 ⭐⭐

### 檢查報告說法
- P1–P4 更新完成後，資料寫到哪裡？
- WB-2 如何知道這是「重度更新」路徑？
- 如何區分「輕度」與「重度」個股？

### 原設計（SSOT）對照
- **約 2027–2030、350、475–478 行**：
  - 流程：WB-1 個股 → escalation 觸發 → W-A 個股審查 → 該股 P1–P4 更新 → **WB-2**（在已確定世界觀下，對兩類個股產出策略與掛單）
  - WB-2 輸入已寫：「兩類個股（**輕度**：未觸發 escalation；**重度**：已觸發 + W-A 審查報告 + P1–P4 更新）+ Delta Pack、Learning、記憶包…」
  - 重度路徑：Prompt 須強調該股異常、附 W-A 審查報告、要求產出新策略與舊策略緊急調整結論
  - Weekly pipeline 須支援「條件式重跑範圍」（escalation → P1–P4），用**任務圖/狀態機**寫法

### 實作狀態對照
- **gas_archive**：有 `calculateEscalationScore()`、`forced_escalation` 輸出標記（約 2114–2115 行）；P5-A 觸發條件含 escalation。**未見**「P1–P4 更新完成後寫入何表／何版快照」及「WB-2 讀取重度路徑」的明確資料流與標記欄位。
- **SSOT**：流程與兩類輸入（輕度/重度）有寫，但**未集中寫**「P1–P4 更新產出寫入哪個 snapshot／表」「WB-2 依何欄位或標記判斷為重度路徑」。

### 差異摘要
| 項目 | SSOT | 缺口 |
|------|------|------|
| 輕度/重度定義 | ✅ 有（未觸發 vs 已觸發+W-A+P1–P4） | — |
| P1–P4 更新後寫入位置 | ⚠️ 僅「該股 P1–P4 更新」 | 寫入何表／何版快照未明 |
| WB-2 如何得知重度 | ⚠️ 依「兩類個股」輸入描述 | 標記欄位／資料源未集中列出 |

### 建議
- **採用報告建議**：C6 屬實；需補「WB-1 → W-A → P1–P4 → WB-2」的**資料流與標記機制**。
- **建議 SSOT 補強**（若您同意）：在「Weekly 流程與產出」或「WB-2」專節新增：① P1–P4 更新完成後寫入**版本化快照**（例如該股 P1__SNAPSHOT／P2／P3／P4 當次 run 之 snapshot_id 或等效）；② WB-2 輸入須含「escalation 標記」或「ticker 是否走重度路徑」及「W-A 審查報告、P1–P4 更新結果之引用」；③ 輕度/重度區分欄位或介面（例如 `escalation_path: true/false` 或 `tier: light/heavy`）寫明。

---

## S1. P0.5 Mode 2 的「台股月度營收」數據來源不明 ⭐⭐

### 檢查報告說法
- 白名單數據源清單中沒有「台股月營收」
- P2 使用財報狗（季報為主），月營收去哪裡抓？

### 原設計（SSOT）對照
- **約 516–519、541、550 行**：
  - P0.5 Mode 2：**台股月度（每月 12 號）**；台股規定每月 10 日前必須公布上月營收，12 號執行確保資料完整
  - 輸入：P2 財務數據（**台股月度營收、美日股季度營收**，從權威網站收集）
  - 信號之一：`capacity_build_upstream`（**台股月營收 + 季報 CapEx proxy**）

### 實作狀態對照
- **SSOT**：已寫「台股月度營收」為 P0.5 Mode 2 輸入及信號來源，但**未寫**「台股月營收」之白名單數據源（例如 MOPS、公開資訊觀測站、或財報狗是否有月營收欄位）。
- **原則 2.1**：P2 財務數據統一財報狗／buffet code；財報狗以季報為主，**月營收是否同一來源或另列來源未在 SSOT 明寫**。

### 差異摘要
| 項目 | SSOT | 缺口 |
|------|------|------|
| 台股月營收需求 | ✅ 有（P0.5 Mode 2） | — |
| 白名單數據源 | ❌ 未列台股月營收來源 | 需補來源（MOPS／公開資訊觀測站／或財報狗月營收） |

### 建議
- **採用報告建議**：S1 屬實；需確認並在 SSOT 或 Daily 蒐集清單／白名單中**明確列出台股月營收數據源**（若財報狗有則註明；若用 MOPS／公開資訊觀測站則列入白名單與實作對照）。
- **建議 SSOT 補強**（若您同意）：在「P0.5 Mode 2」或「數據源／白名單」中新增一句：「台股月度營收：來源為 [具體來源，如公開資訊觀測站或財報狗月營收欄位]，白名單編號／API 見《Daily 蒐集清單與白名單》或工程備忘錄。」

---

## S2. Daily D-3 個股統整與 P6 盤中數據的時間對齊問題 ⭐⭐

### 檢查報告說法
- D-3 何時執行？P6 每 20 分鐘一次，D-3 要用哪一次數據？
- 若用收盤價，為何不直接從「P5.2」拿？建議釐清方案 A（收盤）vs 方案 B（收盤 + P6 異常）

### 原設計（SSOT）對照
- **約 1175 行**：D-3 輸入含「**P6 給的**個股現貨 OHLCV（當天）」與「D2 當日個股新聞索引」「D3 自蒐衍生品與歷史事件集」。
- **約 274、995、1625 行**：P3 與 Daily OHLCV 來自 `MARKET_OHLCV_DAILY`、`MARKET_INDICATORS_DAILY`；Daily OHLCV 蒐集寫入該表。
- **約 1787–1788、1803–1805、1813 行**：P5 Daily **收盤後**執行；讀取 P6 標記為「需保留」的數據，整合到日更資料。

### 實作狀態對照
- **SSOT 未集中寫**：① D-3 執行時點（是否收盤後 30 分鐘）；② 「P6 給的 OHLCV」是指「收盤後從 MARKET_OHLCV_DAILY 取當日收盤」還是「P6 盤中某次快照」；③ 若為收盤價，則與「Daily OHLCV 蒐集」寫入之表一致，僅需在 SSOT 寫清「D-3 當日 OHLCV 來自 Daily OHLCV 蒐集（收盤後寫入），與 P6 標記需保留之異常事件一併作為 D-3 輸入」。

### 差異摘要
| 項目 | SSOT | 缺口 |
|------|------|------|
| D-3 執行時點 | ⚠️ 未明寫 | 收盤後？延遲幾分鐘？ |
| 「P6 給的 OHLCV」語意 | ⚠️ 易解讀為盤中 | 實際若為收盤價則與 Daily OHLCV 蒐集重疊，需統一說法 |
| P6 對 D-3 的輸入 | ✅ 有「需保留」整合 | 可明確為「異常事件＋標記」，OHLCV 用收盤 |

### 建議
- **採用報告建議**：S2 屬實；建議 SSOT **釐清 D-3 與 P6 的數據流**。
- **建議 SSOT 補強**（若您同意）：採用**方案 B** 並寫明：① D-3 執行時點：收盤後（例如 30 分鐘內，依 Daily 流程）；② 當日個股 OHLCV：來自 **Daily OHLCV 蒐集**（收盤後寫入 `MARKET_OHLCV_DAILY`），**非** P6 盤中即時價；③ P6 對 D-3 的輸入：僅 **P6 標記為「需保留」的盤中異常事件**（可寫入 `P6_INTRADAY_ALERTS_DAILY` 或等效），供 D-3 統整「當天最新 + 前三天」時一併引用。並將「P6 給的個股現貨 OHLCV（當天）」改為「當日個股 OHLCV（來自 Daily OHLCV 蒐集之收盤數據）；P6 提供當日盤中異常事件（需保留者）」，避免混淆。

---

## S3. Learning State 的「防重複」機制不完整 ⭐⭐

### 檢查報告說法
- 防重複「可選：調整歷史表、validateLearningStateAdjustment、每月 1 號重置」，未說「必須選哪一個」

### 原設計（SSOT）對照
- **約 1520 行**：「**防重複**：如何判斷『本週是否已調整過』— 依 Learning State **版本或時間戳**（依週）；**同一週補跑時同一週只調整一次**（例如用 week_id 或相同時間窗只寫入一次）。**可選**：調整歷史表、validateLearningStateAdjustment、每月 1 號重置。」

### 差異摘要
- SSOT 已規定「依版本或時間戳／week_id／同一週只寫入一次」，但**具體機制**列為「可選」，未強制其一。

### 建議
- **採用報告建議**：S3 屬實；建議將防重複從「可選」改為「**必須**」並指定實作方式之一。
- **建議 SSOT 補強**（若您同意）：改寫為「防重複**必須**實作：可採用下列之一（或等效）：① 調整歷史表＋寫入前檢查本週是否已有調整記錄；② validateLearningStateAdjustment（本週僅允許一次寫入）；③ 每月 1 號重置 week_id／時間窗。未實作防重複者不得上線。」

---

## S4. P4 Portfolio Correlation Lock 的「板塊定義」不一致 ⭐⭐

### 檢查報告說法
- 「細分產業」定義來自哪裡？P1 輸出 Subtheme_ID，P0 輸出 themes/subthemes，兩者是否一致？

### 原設計（SSOT）對照
- **約 1128–1132 行**：Portfolio Correlation Lock 數據來源為「從 `Phase1_Company_Pool` 讀取 **Subtheme_ID**（細分產業）」。
- **約 525 行**：P0.5 輸入含 P0 的輸出（themes, subthemes, key_nodes）；P2 與 P1 的產業邏輯來自 P0/P1。
- P1 產出有 Subtheme_ID（見 450 行 DSFP 等）；P0 產出 themes/subthemes（約 525、959）。

### 實作狀態對照
- **SSOT 未集中寫**：P0 subthemes 與 P1 Subtheme_ID 的**對應關係**（是否同一套 ID）、P4 讀取之 Subtheme_ID 是否來自 P0 的 subthemes 且與 P1 一致；若 P0 改 subtheme_id 是否會導致 P1 歷史斷鏈。

### 建議
- **採用報告建議**：S4 屬實；需確保**板塊定義單一來源與 ID 穩定**。
- **建議 SSOT 補強**（若您同意）：在「P4」或「資料流」中新增：① 板塊（細分產業）定義**單一來源**為 P0 產出之 subthemes（subtheme_id）；P1 之 Subtheme_ID 必須與 P0 subtheme_id 一致；P4 讀取之 Subtheme_ID 來自 Phase1_Company_Pool，該欄位應與 P0/P1 一致。② 若 P0 季度更新導致 subtheme_id 變更，須有**遷移或對照表**，避免 P1 歷史與 P4 鎖定邏輯斷鏈。

---

## S5. WB-1 DSFP「關鍵資產清單」範圍模糊 ⭐⭐

### 檢查報告說法
- 「至少：美元、美債、VIX、油、金、銅、主要股指/板塊」—「至少」無上限；「主要股指/板塊」未列舉

### 原設計（SSOT）對照
- **約 137、449 行**：WB-1 對**關鍵資產**（**至少**：美元、美債、VIX、油、金、銅、主要股指/板塊）做 DSFP-5 判斷。

### 建議
- **採用報告建議**：S5 屬實；建議**明確列出清單或上限**，避免成本與覆蓋率失控。
- **建議 SSOT 補強**（若您同意）：在「WB-1」或「DSFP 身份裁決」專節新增「關鍵資產清單（V1）」：列舉必含資產（如美元指數、10Y 美債、VIX、油、金、銅、SPX、NDX、必要時 1–2 檔板塊 ETF），並註明「總數上限建議 ≤ N 項，其餘見工程備忘錄或配置表」。

---

## M1. P3 相對強度抗跌測試的「指數選擇」邏輯缺失 ⭐

### 原設計（SSOT）對照
- **缺口報告**（SSOT細節缺口檢查報告）：已列「相對強度 RS：計算時窗、**指數對應**遺漏」；建議在 SSOT「P3」註明 RS 定義與數據來源。
- SSOT 內 P3 有「相對強度抗跌測試」（V8.18），但**未寫** Index 用哪一個（SPX/NDX/板塊 ETF／加權／櫃買）。

### 建議
- **採用報告建議**：M1 屬實；補充**指數選擇邏輯**（依市場／板塊）。
- **建議 SSOT 補強**（若您同意）：在「P3」或「相對強度」處新增：美股預設 SPX 或 NDX（或依板塊選對應 ETF）、台股加權/櫃買、日股東證等；或寫「見工程備忘錄 P3 RS 指數對照表」。

---

## M2. P2 Milestone 驗證時間窗口的「觸發條件」不清晰 ⭐

### 原設計（SSOT）對照
- **約 82–84、2134 行**：`generateMilestoneVerificationWindow` 產出 earliest_check、optimal_check、latest_check；`verifyP2Milestones()`、`integrateMilestoneVerification()` 已在 P5 Weekly Core 整合。
- **SSOT** 未集中寫：誰在何時**觸發**驗證（例如 Weekly 執行時依 optimal_check 觸發、過了 latest_check 未達成算失敗）。

### 建議
- **採用報告建議**：M2 屬實；補充**自動觸發邏輯**與逾時處理。
- **建議 SSOT 補強**（若您同意）：在「P2 Milestone」或「P5 Weekly」中寫明：驗證由 P5 Weekly 執行時觸發（依 optimal_check 為宜）；過了 latest_check 仍未達成視為未達成／失敗；earliest_check 前不觸發。

---

## M3. D-1B 論壇管線的「論壇白名單」未定義 ⭐

### 原設計（SSOT）對照
- **約 1207 行**：「論壇白名單與搜尋策略**由實作時定**（建議：每語系 2～4 個知名論壇，避免過度擴張）。」

### 建議
- **採用報告建議**：M3 屬實；建議在 SSOT 或附錄列出**論壇白名單 V1**（可參考報告範例：Reddit、StockTwits、PTT、5ch、Yahoo ファイナンス等），並註明「實作時可依此擴充，須白名單制」。
- **建議 SSOT 補強**（若您同意）：新增「D-1B 論壇白名單（V1）」小節或附錄，列舉中/英/日論壇清單與搜尋/過濾原則（如每日上限、回文數門檻）。

---

## O1. Delta Pack 可能遺漏突變信號 ⭐（優化）

### 原設計（SSOT）對照
- V8.19 M2：Delta Pack **關鍵訊號始終包含**（CRITICAL_SIGNALS 含 vix、market_regime、defcon_level 等），未變動也標 UNCHANGED。
- 報告擔憂：**累積變動**（如 VIX 連日小漲）可能未達單次閾值而漏進 Delta Pack。

### 建議
- **可選採用**：若希望強化突變檢測，可在 SSOT 或工程備忘錄註明「Delta Pack 可選：累積 N 日變動超過閾值亦納入」；非必須。

---

## O2. P2-2 產業邏輯卡版本管理 ⭐（優化）

### 建議
- **可選採用**：在 SSOT 註明「P0 季度更新時產業邏輯卡版本須可追溯，P2-2 讀取時應帶版本或時間範圍，避免月度執行用到過舊邏輯」；可放在「P2 工作拆分」或工程備忘錄。

---

## O3. Hermes 4 reasoning_trace 冷熱儲存策略 ⭐（優化）

### 原設計（SSOT）對照
- V8.36 已寫 reasoning_trace 可存冷儲存（R2）或 TEXT，索引須能追到。
- 報告建議分層儲存以省成本。

### 建議
- **可選採用**：維持 SSOT 現有「可存 R2 或 TEXT」；冷熱比例與成本估算寫入**工程備忘錄**即可，不必改 SSOT 主文。

---

## 總結表：是否建議採用報告並補強 SSOT

| 項目 | 問題是否成立 | 建議 |
|------|--------------|------|
| C4 Hermes 4 思考過程 | ✅ 成立（GAS 未做；Python 有 Parser、缺強制檢查與 DB） | 採用；SSOT 可補「Python 實作時強制 include_reasoning 與 reasoning_trace 寫入」 |
| C5 P2_1 與 P2-2 介面 | ✅ 成立（P2_1_FACT_MODEL Schema 未定義；GAS 未拆層） | 採用；SSOT 補 P2_1_FACT_MODEL 與 P2-2 介面小節 |
| C6 WB-1 escalation 資料流 | ✅ 成立（寫入位置與 WB-2 重度標記未集中） | 採用；SSOT 補資料流與標記機制 |
| S1 台股月營收來源 | ✅ 成立（白名單未列） | 採用；SSOT 或白名單清單補台股月營收來源 |
| S2 D-3 與 P6 時間對齊 | ✅ 成立（執行時點與「P6 給的」語意不明） | 採用；SSOT 採方案 B 並寫清 D-3 用收盤＋P6 異常 |
| S3 Learning 防重複 | ✅ 成立（可選→必須） | 採用；SSOT 改為必須實作防重複 |
| S4 板塊定義一致性 | ✅ 成立（P0/P1/P4 ID 鏈路未集中寫） | 採用；SSOT 補單一來源與 ID 穩定 |
| S5 WB-1 關鍵資產清單 | ✅ 成立（範圍模糊） | 採用；SSOT 補關鍵資產清單（含上限） |
| M1 P3 RS 指數選擇 | ✅ 成立 | 採用；SSOT 補指數選擇邏輯 |
| M2 Milestone 觸發 | ✅ 成立 | 採用；SSOT 補觸發邏輯與逾時 |
| M3 論壇白名單 | ✅ 成立 | 採用；SSOT 或附錄補論壇白名單 V1 |
| O1–O3 優化 | 建議性質 | 可選；O1/O2 可補一句；O3 放工程備忘錄即可 |

---

**說明**：本比對報告僅供您確認；**未對 SSOT 做任何修改**。若您同意某幾項「建議 SSOT 補強」，再依項逐條修改 SSOT 即可。
