{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "P3_Output",
    "description": "P3 技術分析輸出格式",
    "type": "object",
    "required": [
        "ticker",
        "analysis_date",
        "weekly_structure",
        "daily_structure",
        "category",
        "signals"
    ],
    "properties": {
        "ticker": {
            "type": "string"
        },
        "analysis_date": {
            "type": "string",
            "format": "date"
        },
        "weekly_structure": {
            "type": "object",
            "required": [
                "trend_state",
                "structure_type"
            ],
            "properties": {
                "trend_state": {
                    "enum": [
                        "UPTREND",
                        "DOWNTREND",
                        "RANGE",
                        "TRANSITION"
                    ]
                },
                "structure_type": {
                    "enum": [
                        "ACCUMULATION",
                        "DISTRIBUTION",
                        "BREAKOUT",
                        "BREAKDOWN",
                        "LATE_STAGE",
                        "NEUTRAL"
                    ]
                },
                "key_levels": {
                    "type": "object",
                    "properties": {
                        "support": {
                            "type": "number"
                        },
                        "resistance": {
                            "type": "number"
                        },
                        "ma20w": {
                            "type": "number"
                        },
                        "ma50w": {
                            "type": "number"
                        }
                    }
                },
                "volume_profile": {
                    "enum": [
                        "HEALTHY",
                        "DIVERGENT",
                        "CLIMACTIC",
                        "DRY"
                    ]
                }
            }
        },
        "daily_structure": {
            "type": "object",
            "properties": {
                "trigger_type": {
                    "enum": [
                        "BREAKOUT",
                        "PULLBACK",
                        "REVERSAL",
                        "CONTINUATION",
                        "NONE"
                    ]
                },
                "entry_zone": {
                    "type": "object",
                    "properties": {
                        "low": {
                            "type": "number"
                        },
                        "high": {
                            "type": "number"
                        }
                    }
                },
                "stop_loss": {
                    "type": "number"
                },
                "target_1": {
                    "type": "number"
                },
                "target_2": {
                    "type": "number"
                }
            }
        },
        "category": {
            "type": "object",
            "required": [
                "cat",
                "confidence"
            ],
            "properties": {
                "cat": {
                    "enum": [
                        "MOMENTUM_BUY",
                        "PULLBACK_BUY",
                        "BREAKOUT_WATCH",
                        "HOLD",
                        "REDUCE",
                        "EXIT",
                        "AVOID",
                        "TRAP_ALERT"
                    ]
                },
                "confidence": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1
                },
                "rationale": {
                    "type": "string",
                    "maxLength": 200
                }
            }
        },
        "signals": {
            "type": "object",
            "properties": {
                "rs_vs_index": {
                    "type": "number",
                    "description": "相對強度"
                },
                "rs_interpretation": {
                    "enum": [
                        "OUTPERFORMING",
                        "INLINE",
                        "UNDERPERFORMING"
                    ]
                },
                "trap_risk": {
                    "enum": [
                        "NONE",
                        "LOW",
                        "MEDIUM",
                        "HIGH"
                    ]
                },
                "trap_type": {
                    "enum": [
                        "BULL_TRAP",
                        "BEAR_TRAP",
                        "NONE"
                    ]
                },
                "distortion_risk": {
                    "enum": [
                        "NONE",
                        "LOW",
                        "MED",
                        "HIGH"
                    ]
                }
            }
        },
        "derivative_overlay": {
            "type": "object",
            "properties": {
                "oi_signal": {
                    "type": "string"
                },
                "gamma_state": {
                    "enum": [
                        "POSITIVE",
                        "NEGATIVE",
                        "NEAR_FLIP"
                    ]
                },
                "iv_rank": {
                    "type": "number"
                },
                "dealer_positioning": {
                    "enum": [
                        "LONG_GAMMA",
                        "SHORT_GAMMA",
                        "NEUTRAL"
                    ]
                }
            }
        },
        "re_entry": {
            "type": "object",
            "properties": {
                "eligible": {
                    "type": "boolean"
                },
                "re_entry_price": {
                    "type": "number"
                },
                "conditions": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                }
            }
        },
        "verification_points": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "signal": {
                        "type": "string"
                    },
                    "time_window": {
                        "type": "string"
                    },
                    "falsification_condition": {
                        "type": "string"
                    }
                }
            },
            "maxItems": 3
        },
        "evidence_ids": {
            "type": "array",
            "items": {
                "type": "string"
            }
        }
    }
}