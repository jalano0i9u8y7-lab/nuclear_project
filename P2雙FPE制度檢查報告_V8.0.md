# P2 雙 FPE 制度檢查報告 V8.0

**檢查日期**：2026-01-16  
**目的**：檢查目前 SSOT 和程式碼設計是否符合 V6.0 原始設計的雙 FPE 制度

---

## 📋 V6.0 原始設計（用戶說明）

### 雙 FPE 制度

#### FPE_A（公司官方財報公布的 FPE）
- **定義**：由公司官方財報公布的 FPE
- **特性**：**確切數據**
- **用途**：**作為安全性判斷唯一依據**

#### FPE_B（市場分析師共識）
- **定義**：市場上分析師的大致共識
- **特性**：**不準確數據**，偏向市場氣氛
- **用途**：**判斷市場溫度計**（普遍樂觀/中性/悲觀）
- **使用方式**：
  1. **必須要跟同業的數據做比較**
  2. **判斷出是整個板塊市場情緒都是樂觀/中性/悲觀，還是只有該公司被市場特別的樂觀/中性/悲觀**
  3. **其結論作為 FPE_A 的輔助資料或驗證資料**（是否與公司官方相符/背離）使用

---

## 🔍 目前設計檢查

### 1. 程式碼中的 FPE_A 和 FPE_B

**位置**：`src/21_P2_FUNDAMENTAL_ANALYSIS.js`

**發現**：
- ✅ **欄位存在**：程式碼中有 `fpe_a` 和 `fpe_b` 欄位（第 654-655 行）
- ✅ **輸出格式包含**：輸出格式中包含 `"fpe_a": 25.0, "fpe_b": 28.0`（第 1324-1325 行）
- ✅ **Schema 包含**：`Phase2_Output` Schema 中包含 `"FPE_A"` 和 `"FPE_B"` 欄位

**問題**：
- ❌ **沒有使用邏輯說明**：程式碼中沒有關於 FPE_A 和 FPE_B 如何使用、如何收集的說明
- ❌ **沒有數據收集邏輯**：沒有實際的數據收集函數

---

### 2. P2 Prompt 中的 FPE_A 和 FPE_B

**位置**：`src/21_P2_FUNDAMENTAL_ANALYSIS.js` 的 `buildP2Prompt()` 函數

**發現**：
- ⚠️ **只有欄位名稱**：Prompt 中只提到 `FPE_A` 和 `FPE_B` 是必須填寫的欄位（第 1412-1413 行）
- ❌ **沒有定義說明**：沒有說明 FPE_A 和 FPE_B 的定義、特性、用途
- ❌ **沒有使用邏輯**：沒有說明如何使用 FPE_A 和 FPE_B
- ❌ **沒有同業比較要求**：沒有說明 FPE_B 需要與同業比較
- ❌ **沒有輔助/驗證邏輯**：沒有說明 FPE_B 作為 FPE_A 的輔助資料或驗證資料

**結論**：❌ **Prompt 中缺少雙 FPE 制度的完整說明**

---

### 3. SSOT 文檔中的 FPE_A 和 FPE_B

**檢查範圍**：
- `V8.0架構定案文檔_SSOT.md`
- `系統核心設計原則_V8.0.md`
- `P2財務數據策略審查報告.md`

**發現**：
- ❌ **沒有雙 FPE 制度的說明**：SSOT 文檔中沒有關於 FPE_A 和 FPE_B 的定義和使用方式
- ❌ **沒有安全性判斷邏輯**：沒有說明 FPE_A 作為安全性判斷唯一依據
- ❌ **沒有市場溫度計邏輯**：沒有說明 FPE_B 作為市場溫度計，需要與同業比較

**結論**：❌ **SSOT 文檔中缺少雙 FPE 制度的說明**

---

## ⚠️ 發現的問題

### 問題 1：設計遺失

**V6.0 原始設計**：
- ✅ 明確的雙 FPE 制度定義
- ✅ FPE_A 作為安全性判斷唯一依據
- ✅ FPE_B 作為市場溫度計，需要與同業比較
- ✅ FPE_B 作為 FPE_A 的輔助/驗證資料

**目前設計**：
- ❌ 只有欄位名稱，沒有定義和使用邏輯
- ❌ 沒有數據收集邏輯
- ❌ 沒有在 Prompt 中說明
- ❌ 沒有在 SSOT 文檔中記錄

**結論**：⚠️ **V6.0 的雙 FPE 制度設計在 V6.3 後確實遺失了**

---

### 問題 2：數據收集缺失

**FPE_A 數據收集**：
- ⚠️ **應該從財報狗/buffet code 獲取**（因為是財報數據）
- ⚠️ **需要確認**：財報狗/buffet code 是否包含 FPE_A 數據

**FPE_B 數據收集**：
- ⚠️ **不能用 CSE 搜尋**（用戶明確說明）
- ⚠️ **不能用單一數據來源**（需要多方資料蒐集比對）
- ⚠️ **需要確認**：如何獲取分析師共識數據

---

## ✅ 建議的修正方案

### 1. 更新 SSOT 文檔

**在 `V8.0架構定案文檔_SSOT.md` 的 P2 模組說明中加入**：

```markdown
#### 雙 FPE 制度 ⭐ V6.0 原始設計恢復

**FPE_A（公司官方財報公布的 FPE）**：
- **定義**：由公司官方財報公布的 FPE
- **特性**：確切數據
- **用途**：作為安全性判斷唯一依據
- **數據來源**：財報狗（美股/台股）、buffet code（日股）

**FPE_B（市場分析師共識）**：
- **定義**：市場上分析師的大致共識
- **特性**：不準確數據，偏向市場氣氛
- **用途**：判斷市場溫度計（普遍樂觀/中性/悲觀）
- **使用方式**：
  1. 必須要跟同業的數據做比較
  2. 判斷出是整個板塊市場情緒都是樂觀/中性/悲觀，還是只有該公司被市場特別的樂觀/中性/悲觀
  3. 其結論作為 FPE_A 的輔助資料或驗證資料（是否與公司官方相符/背離）使用
- **數據來源**：不能用 CSE 搜尋，不能用單一數據來源（需要多方資料蒐集比對）
```

---

### 2. 更新 P2 Prompt

**在 `buildP2Prompt()` 函數中加入雙 FPE 制度說明**：

```markdown
## ⭐⭐⭐ P2-6 雙 FPE 制度（V6.0 原始設計）

### FPE_A（公司官方財報公布的 FPE）

**定義**：由公司官方財報公布的 FPE

**特性**：
- ✅ **確切數據**：來自官方財報，是嚴格數據
- ✅ **作為安全性判斷唯一依據**：Gate 檢查和分層決策應基於 FPE_A

**數據來源**：
- 美股和台股：從財報狗網站獲取
- 日股：從 buffet code 網站獲取

**提取要求**：
- 必須從提供的財務數據中提取 FPE_A
- 如果數據中沒有，標註為 null

---

### FPE_B（市場分析師共識）

**定義**：市場上分析師的大致共識

**特性**：
- ⚠️ **不準確數據**：各分析師預期差異很大
- ⚠️ **偏向市場氣氛**：反映市場對該公司的普遍看法

**用途**：**判斷市場溫度計**
- 判斷市場對該公司是普遍樂觀/中性/悲觀
- 必須要跟同業的數據做比較
- 判斷出是整個板塊市場情緒都是樂觀/中性/悲觀，還是只有該公司被市場特別的樂觀/中性/悲觀

**使用方式**：
1. **與同業比較**：
   - 收集同業公司的 FPE_B 數據
   - 比較目標公司與同業的 FPE_B
   - 判斷是整個板塊的情緒，還是只有該公司被特別看待

2. **作為 FPE_A 的輔助/驗證資料**：
   - 比較 FPE_B 與 FPE_A 是否相符/背離
   - 如果 FPE_B 與 FPE_A 背離，需要分析原因
   - 輔助判斷 FPE_A 的合理性

**數據來源**：
- ⚠️ **不能用 CSE 搜尋**（不符合數據定位）
- ⚠️ **不能用單一數據來源**（需要多方資料蒐集比對）
- ⚠️ **需要確認**：如何獲取分析師共識數據（待定案）

**提取要求**：
- 如果無法獲取，標註為 null
- 不應影響 Gate 檢查和分層決策（FPE_A 才是唯一依據）
```

---

### 3. 實現數據收集邏輯

**FPE_A 數據收集**：
- 在 `collectFinancialDataFromExternalSources()` 中，從財報狗/buffet code 搜尋結果中提取 FPE_A
- 確認財報狗/buffet code 是否包含 FPE_A 數據

**FPE_B 數據收集**：
- ⚠️ **待定案**：需要確認如何獲取分析師共識數據
- ⚠️ **不能用 CSE 搜尋**：需要其他方式獲取

---

## 📋 檢查結論

### 目前狀態

1. ✅ **欄位存在**：程式碼和 Schema 中都有 FPE_A 和 FPE_B 欄位
2. ❌ **設計遺失**：V6.0 的雙 FPE 制度設計在 V6.3 後確實遺失了
3. ❌ **Prompt 缺少**：Prompt 中沒有雙 FPE 制度的說明
4. ❌ **SSOT 缺少**：SSOT 文檔中沒有雙 FPE 制度的記錄
5. ❌ **數據收集缺失**：沒有實際的數據收集邏輯

### 需要修正的項目

1. ⚠️ **更新 SSOT 文檔**：在 `V8.0架構定案文檔_SSOT.md` 中加入雙 FPE 制度說明
2. ⚠️ **更新 P2 Prompt**：在 `buildP2Prompt()` 中加入雙 FPE 制度說明
3. ⚠️ **實現 FPE_A 數據收集**：確認財報狗/buffet code 是否包含 FPE_A，實現提取邏輯
4. ⚠️ **確認 FPE_B 數據來源**：需要確認如何獲取分析師共識數據（不能用 CSE 搜尋）

---

**下一步**：請確認是否需要我立即更新 SSOT 文檔和 P2 Prompt，加入雙 FPE 制度的完整說明。

---

## ✅ 後續更新（2026-01-16）

### 已完成

1. ✅ **更新 SSOT 文檔**：已在 `V8.0架構定案文檔_SSOT.md` 中加入雙 FPE 制度說明
2. ✅ **更新 P2 Prompt**：已在 `buildP2Prompt()` 中加入雙 FPE 制度說明
3. ✅ **實作 FPE_B 數據收集**：已實作 Yahoo Finance Analysis Scraper
   - 函數：`collectFPE_B_ForCompany()`
   - 函數：`getFPE_B_FromYahooFinance()`
   - 函數：`parseYahooAnalysisPage()`
   - 函數：`getCurrentPriceFromYahoo()`
4. ✅ **整合到 P2 模組**：已在 `collectFinancialDataFromExternalSources()` 中整合

### 待確認

1. ⚠️ **FPE_A 數據確認**：需要確認財報狗/buffet code 是否包含 FPE_A 數據
2. ⚠️ **FPE_B 解析測試**：需要測試 Yahoo Finance 解析邏輯是否正確
3. ⚠️ **備用方案**：視需要實作 Finviz（美股）、鉅亨網（台股）、Minkabu（日股）

詳細實作內容請參考：`FPE_B實作總結_V8.0.md`
