# V8.13 系統測試架構重點摘要（修正版）

**日期**：2026-01-19  
**狀態**：📋 討論階段 → 準備執行  
**最後更新**：根據用戶修正意見更新

---

## 🎯 測試總體目標

確保系統在**真實市場環境**（噪音、假消息、數據衝突、極端事件）下，仍能：
1. ✅ **不被騙** - 不因假消息/情緒操縱而誤判
2. ✅ **不亂下結論** - 承認不確定性，不強行編故事
3. ✅ **嚴守分工** - Daily/Weekly/P6 各司其職，不越權
4. ✅ **高EV行為** - 主升段不被洗、崩盤不硬扛
5. ✅ **能賺錢** - 牛市賺錢、熊市不賠、轉折抓得準（買在最低最安全、賣在最高最危險）

---

## 📋 六大測試階段重點摘要

### 1. 數據源管線測試 (Data Pipeline Integrity)

**目標**：確保血管暢通，數據清洗機制運作正常

#### ✅ 已完成部分
- **P0 數據源測試**：✅ 已完成
- **P1 數據源測試**：✅ 已完成
- **P2 數據源測試**：✅ 已完成
- **P3 數據源測試**：⏭️ 跳過（需要測試範例個股OHLCV和衍生品）
- **P5 數據分面**：✅ 幾乎成功

#### 🔄 當前進度：P5 三大新聞管線測試

**剩餘工作重點**：
1. **一般當日新聞管線測試**（`24_P5_DAILY_NEWS.js`）
   - ✅ 時效性（`is_today_news`判斷）
   - ✅ 正確性（數據驗證機制）
   - ✅ 準確度（分類標籤正確）
   - ✅ 雜訊過濾（Flash清洗）
   - ✅ 多語去重（Gemini Pro去重）
   - ✅ 分類正確（多維度標籤系統）
   - ✅ 索引正確（個股新聞索引建立）
   - ✅ 資料庫頁面正確（`NEWS_ATOMS_DAILY`表格）
   - ✅ 程式計算部分正確（波動度、驗證標記等）
   - ✅ **確認有確實引用給Weekly決策系統和動態學習系統**

2. **機構評級新聞管線測試**（`24_P5_DAILY_INSTITUTIONAL_RATINGS.js`）
   - ✅ 時效性、正確性、準確度
   - ✅ 雜訊過濾、多語去重
   - ✅ 分類正確（機構名稱標準化、評級動作標準化）
   - ✅ 索引正確（按機構分開存儲）
   - ✅ 資料庫頁面正確（`INSTITUTIONAL_RATINGS_DAILY`表格）
   - ✅ **確認有確實引用給Weekly決策系統和動態學習系統**

3. **第三個新聞管線測試**（待確認具體是哪一個）
   - [ ] 待用戶確認

---

### 2. Prompt靈魂測試 (Prompt Engineering & Indexing)

**目標**：確保大腦（AI）認知正確，優化Token效率

#### 2A. 局部Prompt單元測試
- ✅ 每個AI節點（Daily新聞分類、Weekly策略輸出等）單獨測試
- ✅ 固定input重複跑10次，檢查output結構一致、不亂編、不越權

#### 2B. 長Prompt壓力測試（⭐ 關鍵）
- ✅ 塞入大量新聞、多個板塊、多檔股票
- ✅ 檢查是否開始hallucination、忽略重要資料、結論漂移
- ✅ **已優化**：新聞+個股索引（避免100次重複搜尋）✅ 已完成
- ⚠️ **Daily戰略摘要**：❌ 不做（會越權到Weekly職權）

#### 2C. Prompt邊界與禁區測試
- ✅ Daily有沒有開始下結論？
- ✅ P6有沒有被誘導去「判斷趨勢」？
- ✅ Weekly有沒有回寫P0-P2？

---

### 3. 歷史動態學習系統測試 (Memory & Evolution)

**目標**：驗證系統能從歷史學習，但避免過度擬合

#### 3A. Input覆蓋測試
- ✅ 所有歷史資料（P0/P2/P5）是否正確引入
- ✅ 有被整理、摘要、更新世界觀

#### 3B. Output回饋測試（⚠️ 必須加限制）
- ✅ **學習結果只能影響**：權重、風險註記、信心區間
- ✅ **不得自動改變**：核心決策邏輯
- ⚠️ **零容忍**：在回測中無敵但在未來崩潰的系統

---

### 4. 全管線暢通測試 (End-to-End Integration)

**目標**：確保P0→P5自動化鏈路無斷點

- ✅ 時序相依性測試（P0財報未更新時，P5是否能運作？）
- ✅ 中間某一節失敗時，是否能降級運行、保留關鍵輸出
- ✅ 成本與執行速度審計

---

### 5. 工作階段壓力測試 (Adversarial Stress Test) ⭐ 核心關卡

**目標**：驗證系統在極端環境下仍能維持正確判斷

#### 5A-5H. 各種壓力測試
- 詳細內容見原始測試架構（保持不變）

---

### 6. 歷史回朔模擬 (Historical Backtesting) ⭐ 修正重點

**目標**：行為一致性驗證 + **績效驗證**（⭐ 用戶修正）

#### 6A. 行為一致性模擬
- ✅ 牛市：是否過度防守？
- ✅ 熊市：是否快速降權？
- ✅ 震盪市：是否過度交易？

#### 6B. 敘事反應測試
- ✅ 新聞騙局年份（例如2021-2022），系統是否被敘事牽著走？

#### 6C. ⭐ 績效驗證（用戶修正重點）
- ✅ **必須驗證績效**：
  - 牛市能否賺錢
  - 熊市能否不賠錢
  - 轉折能否抓得準（買在最低最安全、賣在最高最危險）
- ✅ 用來看有沒有明顯低於指數太多
- ⚠️ **不能用來調參數**（否則會為了回測而毀掉未來）

#### 盲測方法
- **方法A**：代碼匿名化（"NVDA"→"Stock_A"，"2020"→"Year_X"）
- **方法B**：邏輯一致性（不追求模擬報酬率，追求「該跑時有跑」）

---

## 📊 Weekly數據源測試（新增重點）

### Weekly決策系統兩大部分測試

#### 1. 宏觀世界觀的連貫分析與動態學習
**數據來源**：
- 宏觀數據（`MACRO_DATA_DAILY`）
- 新聞（`NEWS_ATOMS_DAILY`）
- 歷史學習日誌（`P5__LEARNING_LOG`）

**測試重點**：
- ✅ 是否完整讀取所有宏觀數據
- ✅ 是否正確整合新聞到世界觀分析
- ✅ 動態學習機制是否正常運作
- ✅ 世界觀是否隨時間增進深度理解
- ✅ 是否結合策略調整

#### 2. 持股池中個股每週決策產出系統
**數據來源**（已索引化，避免100次重複工作）：
- 個股新聞索引（`STOCK_NEWS_INDEX_DAILY`）✅ 已完成
- 板塊/產業新聞索引（`SECTOR_NEWS_INDEX_DAILY`）✅ 已完成
- 事件索引（`EVENTS_INDEX_WEEKLY`）✅ 已完成
- 宏觀數據週度波動度（`MACRO_DATA_WEEKLY_METRICS`）✅ 已完成
- 技術指標週度波動度（`TECHNICAL_INDICATORS_WEEKLY_METRICS`）✅ 已完成

**測試重點**：
- ✅ 是否優先讀取索引數據（避免重複搜尋100次）
- ✅ 批次處理時prompt和tokens是否在合理範圍內
- ✅ 是否正確整合到每個個股的策略生成中
- ✅ 是否有正確引用給動態學習系統

---

## ⚠️ 關鍵原則

1. **零容忍項目**：
   - ❌ Daily越權下策略
   - ❌ AI編故事、強行下結論
   - ❌ 假消息被當真（市場無反應但AI興奮）
   - ❌ 數據衝突時選邊站

2. **已完成的優化**（不用重複）：
   - ✅ 新聞+個股索引（避免100次重複搜尋）- 已完成
   - ❌ Daily戰略摘要 - 不做（會越權）
   - ✅ 程式計算波動度（非AI摘要）- 已完成

3. **測試哲學**：
   - ✅ 行為一致性 > 績效數字（但績效也要驗證）
   - ✅ 邏輯正確性 > 回測報酬率
   - ✅ 未來生存率 > 過去完美度
   - ✅ **能賺錢才是目標**（牛市賺錢、熊市不賠、轉折抓得準）

---

## ❓ 需要用戶確認的問題

### 問題1：三大新聞管線
目前確認了兩個：
1. **一般當日新聞管線**（`24_P5_DAILY_NEWS.js`）
2. **機構評級新聞管線**（`24_P5_DAILY_INSTITUTIONAL_RATINGS.js`）

**第三個新聞管線是什麼？** 還是「三大新聞管線」指的是這兩個加上其他功能？

### 問題2：Weekly數據源完整性
Weekly決策系統的兩大部分（宏觀世界觀 + 個股決策）是否與現有代碼設計一致？需要檢查：
- `24_P5_WEEKLY_WORLDVIEW.js` - 宏觀世界觀分析
- `24_P5_WEEKLY_STOCK_STRATEGY.js` - 個股策略生成
- `24_P5_WEEKLY_CORE.js` - 主執行函數

是否還有其他數據來源需要測試？

### 問題3：動態學習系統的數據引用
需要確認：
- Daily的新聞數據是否確實被Weekly的動態學習系統引用？
- 機構評級的歷史學習機制是否正確整合？
- 是否有遺漏的數據源沒有進入學習系統？

---

## 📝 下一步行動

**等待用戶確認上述問題後，開始執行：**

1. **P5 三大新聞管線完整測試**
   - 一般當日新聞管線
   - 機構評級新聞管線
   - （待確認第三個）

2. **Weekly數據源測試**
   - 宏觀世界觀數據完整性
   - 個股決策索引數據完整性
   - 動態學習系統數據引用確認

**確認無誤後，開始執行測試工作。**
