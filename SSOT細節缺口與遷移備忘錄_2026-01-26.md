# SSOT 細節缺口與遷移備忘錄（2026-01-26）

**目的**：將目前抓到的 SSOT 細節缺口**詳細記載成備忘錄**，對齊**目前最新設計**（D3/D4、Layer 1/2/3、P2.5 月度、Daily 蒐集清單、宏觀分類 V2.0、衍生品監控清單等），供寫 Python 時對照。

**⚠️ 重要**：本備忘錄為**檢查清單與索引**；**正式寫程式時仍須將舊程式碼（gas_archive/src/）再對照一次**。缺口太多、邊界條件與枚舉值散落各檔，僅依備忘錄無法涵蓋每一行細節；實作前應打開對應 .js 檔逐函數/逐區塊確認，避免遺漏。

---

## 一、對齊最新設計的總則

- **P2.5**：主題為大型機構級深層數據分析；主要負責**月度**更新頻率等級的大方向機構級數據蒐集與框架分析；日度蒐集與週度分析由 P5 Daily / P5 Weekly 負責。
- **Daily**：D3 為個股「紀錄官」（D2 新聞索引 + P6 個股 OHLCV + D3 自蒐個股衍生品與歷史事件 → 個股當日快照 + 與前幾天連結）；D4 為宏觀「編年史官」（D1 宏觀新聞 + 宏觀現貨 + 宏觀衍生品 → 各宏觀子世界敘事快照 + 總金融世界觀快照）；宏觀分類為 10–12 類（見《Daily每日蒐集清單與白名單_SSOT級_2026-01-26.md》）。
- **三層架構**：Layer 1 Collector 只抓 Raw、不用 AI；Layer 2 Calculator 程式算 Computed + Flags；Layer 3 Interpreter 僅 AI 讀 flags + 少量 Raw。
- **Daily 最高目標**：建立「可被 Weekly 解讀的時間連續世界模型」；沒有連續性就沒有預測。
- **數據來源**：**所有蒐集來源必須來自白名單**；GAS 用 CSE 限制搜尋，Python 可選專用 API / 白名單爬蟲（見同目錄「Python 數據來源選項」）。

---

## 二、表結構與欄位（Schema）缺口

| 項目 | 細節所在（舊碼） | 對齊最新設計要點 | 遷移時必對照 |
|------|------------------|------------------|--------------|
| Phase 快照／對外輸出表 | `01_SHEETS_STRUCTURE.js` 內各 SCHEMA（P0__SNAPSHOT、Phase2_Output、P3__SNAPSHOT 等） | 各 Phase 對外暴露欄位須與 SSOT「Phase 產出」一致；WB-2 order 須帶 worldview_version、identity_context；Hermes 4 輸出須含 reasoning_trace、final_answer | 打開 01_SHEETS_STRUCTURE.js 逐表抄錄必填欄位、型別、鍵名；或從 DB 設計文檔對齊 |
| P6 表 | P6_INTRADAY_LOG、P6_EMERGENCY_EXIT_LOG、P6_INTRADAY_ALERTS_DAILY、retention_flag | 清除對象僅 P6 產出之一般監測數據；清除時機為本週策略產出完成後；至少保留兩週；清除鎖由 Weekly 完成寫入後解鎖 | 28_P6_*、26_TRIGGER_SETUP、01_SHEETS_STRUCTURE |
| 新聞／機構評級表 | NEWS_ATOMS_DAILY、STOCK_NEWS_INDEX_DAILY、INSTITUTIONAL_RATINGS_DAILY、多維度標籤 | D1/D2 產出；標籤維度（事件屬性、影響層級、情緒極性、Related_Tickers）須與 SSOT 一致 | 24_P5_DAILY_NEWS、01_SHEETS_STRUCTURE |
| 學習系統表 | P5__STRATEGY_SNAPSHOT、P5__OUTCOME_SNAPSHOT、P5__LEARNING_STATE、claims_json | Claims 結構（claim_id、claim_type、verification_window、verification_condition）；Scorecard 四項；Attribution Type A/B/C/D | 24_P5_WEEKLY_MEMORY_MANAGER、V8.13 說明 |
| DEFCON／緊急撤退 | DEFCON_STATUS、P6_EMERGENCY_EXIT_LOG、trigger_type | trigger_type 枚舉（SINGLE_STOCK_DROP、PORTFOLIO_DROP、INDEX_DROP、FLASH_CRASH、MULTI_VOLUME、DEFCON 等）；寫入時機與 Layer 1 即時防禦一致 | 01_SHEETS_STRUCTURE、28_P6_EMERGENCY_EXIT、28_P6_DEFCON_ADJUSTER |
| Daily 輸出表（D3/D4） | 個股當日快照、各宏觀子世界快照、總世界觀快照 | D3 輸出：每檔個股當日快照 + 與前幾天連結；D4 輸出：10–12 類敘事快照 + Narrative_Snapshot_Day_T 串接 T-1 | 討論整理待定案；實作時對照 24_P5_DAILY_* 與新設計 |

---

## 三、公式、閾值、機械規則缺口

| 項目 | 細節所在（舊碼） | 對齊最新設計要點 | 遷移時必對照 |
|------|------------------|------------------|--------------|
| P4 U/Cat/Tier | 10_P4_CALCULATOR.js（getCurrentUV8_15、applyPortfolioCorrelationLock、applyTimeWindowPenalty、applyFrontierRunwayGate 等） | 板塊曝險 30–40%；Runway<4 且 Safety=X → cap；P0.7 > P0.5 > P2 > P3 優先級；Market Climate Override | 10_P4_CALCULATOR.js 內所有閾值與公式 |
| P3 週線/日線 | 22_P3_DATA_COLLECTOR（aggregateDailyToWeekly、calculateWeeklyIndicators）、formatTechnicalDataWithWeeklyDailyBlocks | 50 週、60 日；[WEEKLY_CHART]/[DAILY_CHART] 區塊格式；週線 MA20/50/200、RSI(14)、MACD(12,26,9) | 22_P3_DATA_COLLECTOR、22_P3_AI_ANALYSIS |
| P6 異常門檻 | 28_P6_INTRADAY_MONITOR、雙向監控設計 | 暴跌 %/ATR、暴漲 %/ATR、量比；急殺 20 分鐘；各市場差異（台/美/日）若有則寫入 SSOT | 28_P6_INTRADAY_MONITOR |
| P6 移動停利 | 28_P6_TRAILING_STOP.js | 最近 3 日高點回落 -4%、跌破 MA10；市場別閾值（若不同） | 28_P6_TRAILING_STOP |
| 相對強度 RS | 22_P3_DATA_COLLECTOR 或相關 | RS = Stock % Change - Index % Change；指數對應、時窗 | P3 章節與 22_P3_* |
| 拋物線清倉 | 24_P5_WEEKLY_FINAL_OUTPUT 或決策架構 | Price vs MA20 deviation > 95th percentile、Volume spike；百分位計算方式、窗口 | 24_P5_WEEKLY_*、V8.19 |
| Layer 2 觸發器 | 討論 A–G 類 Computed + Flags | *_RISK_HIGH、REGIME_SHIFT、DEALER_DOMINANT、GAMMA_SQUEEZE_RISK 等由程式算，不經 AI | 討論整理 + 各 Collector/Calculator 實作 |

---

## 四、狀態機、觸發條件、執行順序缺口

| 項目 | 細節所在（舊碼） | 對齊最新設計要點 | 遷移時必對照 |
|------|------------------|------------------|--------------|
| M0 Payload → task_prompt | 03_M0_CORE.js 一長串 if currentPayload.p0_prompt / p1_step1_prompt / … | 所有 payload 鍵名與優先順序；p0_prompt、p0_5_prompt、p0_7_prompt、p1_prompt、p1_step1_prompt、p1_step2_prompt、p2_prompt、p2_5_prompt、p3_prompt、p5_b_prompt、p5_a_prompt 等 | 03_M0_CORE.js 開頭 task_prompt 賦值區塊 |
| Batch 與觸發式審查 | 03_M0_CORE、22_P3_CORE | P3 審查 15–25%；觸發條件（confidence 低、reviewReasons 等） | 03_M0_CORE、22_P3_CORE、22_P3_TRIGGERED_REVIEW |
| P5 Weekly 步驟與依賴 | 24_P5_WEEKLY_CORE、24_P5_WEEKLY_DUAL_LAYER | collectP5WeeklyAllData → P5-B → escalation → P5-A → merge → 硬約束覆寫 → 產出 | 24_P5_WEEKLY_CORE 主流程、函數呼叫順序 |
| P6 清除鎖 | 26_TRIGGER_SETUP、P6_ClearOldData | 解鎖條件：本週策略產出完成（誰寫入「策略產出完成」、何時解鎖） | SSOT P6 數據保留 + 26_TRIGGER_SETUP |
| GAS 時代觸發清單 | 26_TRIGGER_SETUP | 僅供遷移對照；目標架構禁止「時間觸發串接」為核心，改為任務隊列 | 26_TRIGGER_SETUP 內所有 config 與 function_name |

---

## 五、錯誤處理、Fallback、邊界缺口

| 項目 | 細節所在（舊碼） | 對齊最新設計要點 | 遷移時必對照 |
|------|------------------|------------------|--------------|
| 數據源 Fallback | 22_P3_DATA_COLLECTOR、24_P5_DAILY 等 fetch*Safe、GOOGLEFINANCE → Stooq / CSE | 回退順序、超時、null 處理；主來源 yfinance/官方 API，GOOGLEFINANCE 僅 P6 或備援 | 各 collect* 與 fetch* 函數 |
| Batch API 失敗 | 03_M0_CORE 或 Batch 封裝 | 部分失敗、重試次數、降級為同步條件 | M0 與 Batch 章節 |
| P4 數學邊界 | 10_P4_CALCULATOR | 除以零、Infinity/NaN、變數名稱對接 | 10_P4_CALCULATOR 內檢查點 |
| 財報提取驗證 | 20_P1_FINANCIAL_REPORTS（validateFinancialReportExtraction、INCOMPLETE_EXTRACTION） | 檢查項與狀態枚舉 | 20_P1_FINANCIAL_REPORTS |

---

## 六、配置與常數缺口

| 項目 | 細節所在（舊碼） | 對齊最新設計要點 | 遷移時必對照 |
|------|------------------|------------------|--------------|
| 模型與任務對應 | 02_M0_CONFIG.js（TASK_TO_EXECUTOR、getAuditor） | 每個 Phase 的執行者/審查者型號；任務 ID 與檔案對照 | 02_M0_CONFIG.js |
| CSE／白名單 ID | 各 Phase 的 CSE 常數（P2_US_TAIWAN、P2_JAPAN、P5_NEWS、P5_INSTITUTIONAL_RATINGS 等） | Python 可改用專用 API 或白名單域名；清單見《Daily每日蒐集清單與白名單_SSOT級_2026-01-26.md》 | 各 Phase 常數定義、01_SHEETS_STRUCTURE 註解 |
| P6 觸發間隔 | 26_TRIGGER_SETUP（20 分鐘、5 分鐘選擇權、清除每日午夜） | 觸發器配置一覽與函數名對應 | 26_TRIGGER_SETUP |

---

## 七、使用方式

1. **寫 Python 前**：依本備忘錄第二～六節，找到該模組對應的「細節所在」與「遷移時必對照」檔案，在備忘錄上打勾或註記。
2. **實作時**：**務必再打開 gas_archive/src/ 對應 .js 檔**，逐函數/逐區塊對照（表結構、閾值、枚舉、fallback 順序、寫入時機），不應僅依本備忘錄省略重讀。
3. **發現新缺口**：若舊碼有邏輯未列於本備忘錄或 SSOT，判斷是否為應保留的業務規則 → 若是，補入本備忘錄或 SSOT 並實作；若為 GAS 妥協則不複製。
4. **與最新設計衝突時**：以 SSOT 與《P2.5與Daily_Weekly微調討論整理_待定案.md》（定案後寫入 SSOT）為準；本備忘錄與舊碼僅為對照來源，不覆寫架構決策。
