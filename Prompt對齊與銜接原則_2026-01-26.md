# Prompt 對齊與銜接原則（2026-01-26）

**目的**：確保所有 Prompt **承襲舊版 GAS 內容**，並依**憲法與最新概念與架構**做對齊修改；**不遺漏、不省略既有功能**（除非與新修改牴觸）；以**最新內容增強**，符合**憲法與核心概念**；修改時特別注意**前後銜接**與**該工作最高目標與產出內容的精準**。

---

## 一、總原則

1. **承襲舊版 GAS**：所有 Prompt 正文以 GAS 內 `build*Prompt` / `build*Auditor*` 的**完整字串**為基底，不憑 SSOT 摘要重寫而丟失原文。
2. **對齊憲法與架構**：在保留原文基礎上，依**憲法六條**、**DSFP**、**角色校準器**、**未來對齊三問**、**各階段 Prompt 補強參考**做**增強與修改**，使每條 Prompt 不抵觸最高原則。
3. **不遺漏既有功能**：既有任務描述、輸出欄位、禁止項、區塊結構（如審查者原始資料區塊、批次分隔規則）**一律保留**；僅在與憲法或新架構**明確牴觸**時才刪減，並在 SSOT 或註解中記錄刪減理由。
4. **以最新內容增強**：若有 SSOT 或工程備忘錄中的**補強版**（如 P2 Runway=風險不是死刑、P4 讓數學負責殘酷、P3 週線/日線分區、P5 基準權重與 MISSION_CONSTRAINTS、o3「下列檢查已由系統完成」等），應**整合進**對應 Prompt，而不是只保留舊文。
5. **前後銜接正確**：同一 Phase 內多個 Prompt（如 P1 Step1 / Step2、P2 單檔/批次、P5-B/P5-A）之間，**輸入輸出、術語、區塊順序**須一致；與上游（數據欄位、快照結構）和下游（審查者、Validator）的**介面**須對齊。
6. **符合最高目標與產出精準**：每個 Phase 的 Prompt 須對齊該 Phase 的**最高目標**（例如 P0 未來可驗證、P2 同業比較與相對位置、P3 機構級預測、Daily 史官不決策、Weekly 策略引用 worldview_version）；產出格式、必填欄位、驗證時間窗口須**精準可驗證**。

---

## 二、憲法與核心概念（Prompt 不得抵觸）

- **憲法六條**：未來可驗證、未來優先、市場視角高於真相、因果鏈完整性、反敘事義務、角色即主力。
- **DSFP**：GLOBAL_SYSTEM_BLOCK_DSFP_V1 及各 Phase 加強塊；禁止依歷史標籤判斷，須依當前狀態；Daily 只標記、Weekly 身份裁決。
- **史官鐵律**：Daily D-3/D-4 不得改寫歷史，只追加 delta/link/tag/branch，保留舊 evidence。
- **程式算 vs AI 判讀**：比率、分位數、斜率、觸發器、風險等級由程式算；AI 不口算/腦補；Prompt 中可寫「下列檢查已由系統完成，請基於已通過的輸入做分析」。
- **Hermes 4**：凡用 Hermes 4 的模組須開啟 `include_reasoning`，`<think>` 存入 `reasoning_trace`。

---

## 三、前後銜接檢查要點

| 檢查項 | 說明 |
|--------|------|
| **上游數據** | Prompt 中引用的欄位（如 financial_data、master_candidates、weekly_indicators、snapshot_diff）須與 Collector/快照**實際輸出**一致；若有更名或新增欄位，Prompt 與審查者 Prompt 須同步更新。 |
| **批次規則** | P2/P3/P2.5 的批次 Header、`<<<COMPANY: TICKER>>>`、替換符與分隔規則須與 M0 呼叫方式一致；審查者若收「單檔」則 Prompt 不得假設收到整批。 |
| **審查者原始資料** | buildAuditorPromptWithQuestions / buildP1Step2AuditorPrompt / buildP3AuditorPrompt 等內「原始資料區塊」的 key（如 financial_data、p2_evidence、p2_5_data）須與執行者輸出及 M0 傳入的 originalData 結構一致。 |
| **同一 Phase 多步驟** | P1 Step1 產出 company_pool → Step2 輸入；P2-1 產出 P2_1_FACT_MODEL → P2-2 讀取；P5-B 產出 escalation → P5-A 輸入；各步 Prompt 的輸入輸出欄位與術語須一致。 |
| **硬約束與軟引導** | P5 Weekly 的 Layer 1 硬約束（系統級/產業級/個股級/數學邊界）須與 `enforceHardConstraints` / `applyHardConstraints` 的邏輯一致；Prompt 中基準權重與允許偏差範圍須與程式覆寫規則相容。 |
| **學習與記憶** | learning_feedback、memory_pack、MISSION_CONSTRAINTS 的結構與鍵名須與 getLearningFeedback()、buildWeeklyMemoryPack()、getLatestLearningState() 的輸出一致。 |

---

## 四、最高目標與產出精準檢查要點

| Phase | 最高目標（簡述） | 產出精準要點 |
|-------|------------------|--------------|
| P0 | 未來可驗證、必然位置表 | themes/subthemes、validation_questions、未來對齊三問 |
| P0.5 | 產業鏈地圖/動態、不預測時間 | INVESTABLE_CHOKEPOINT、STRUCTURE_ROLE、四區輸出 |
| P0.7 | 系統動力學、槓桿點、全系統補丁 | 五項強制輸出、時間序位置、錯位檢查 |
| P1 Step1 | 股票池、只選 INVESTABLE_CHOKEPOINT | company_pool、不獵殺舊技術龍頭 |
| P1 Step2 | 結構分級、Tier S/A/B/X | PRIMARY_TRUTH_METRICS、FORBIDDEN_METRICS |
| P1 財報 | 只提取原文、不分析 | P1/P2/P3 三欄位、page_number、filing_period |
| P2 | 同業比較、相對位置、雙 FPE | Phase2_Output、Milestones to Verify、Runway 非死刑 |
| P2.5 | 機構級籌碼、無異常 NO SIGNAL | Smart_Money_Score、PIN_RISK、DEALER_HEDGING_DOMINANT 等 flags |
| P3 | 機構級預測、週線優先、Bull Trap 否決 | [WEEKLY_CHART]/[DAILY_CHART]、DISTORTION_RISK、re_entry 等 |
| P4 | 風控數學、U/Cat/Tier、不替 AI 決策 | 權重總和、position_cap、Market Climate Override |
| P5-B/P5-A | 硬約束內決策、基準權重、Learning 注入 | parameter_adjustment_vector、state_vector、Order DSL |
| Daily D-3/D-4 | 史官、不決策、時間連續 | 只輸出事件叢/敘事快照、IDENTITY_SHIFT_SIGNALS 僅 signal |
| 審查者 | 驗證執行者、用原始資料裁決 | 必含原始資料區塊、回答執行者問題或事實查證 |

---

## 五、修改流程建議

1. **抽出**：從 GAS 對應 .js 複製每個 `build*Prompt` / `build*Auditor*` 的**完整字串**到 Python 專案（或集中管理的 prompts 目錄）。
2. **對齊**：依本文件第一、二節加入或調整「角色校準器、憲法/DSFP 區塊、未來對齊三問、程式已完成檢查說明」等，並依各階段 Prompt 補強參考與最新 SSOT 補丁做**增強**。
3. **銜接**：依第三節逐項檢查上游數據、批次規則、審查者原始資料、同 Phase 多步驟、硬約束與學習記憶的結構一致性。
4. **精準**：依第四節確認該 Phase 最高目標與產出欄位/格式/驗證窗口無漏、無矛盾。
5. **記錄**：若有刪減（僅限與憲法或新架構牴觸處），在註解或 SSOT 中註明理由；所有修改處建議保留「對應 SSOT 章節」或「對應 GAS 檔名與函數名」以便追溯。

完成以上流程後，Prompt即**承襲舊版 GAS、對齊憲法與架構、不遺漏既有功能、以最新內容增強、前後銜接正確、符合最高目標與產出精準**。
