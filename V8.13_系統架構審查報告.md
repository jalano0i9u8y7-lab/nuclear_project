# V8.13 系統架構審查報告

**日期**：2026-01-19  
**審查範圍**：Weekly決策系統架構 + 動態學習系統數據引用  
**狀態**：📋 審查完成，待用戶確認

---

## 📋 審查結果摘要

### ✅ 1. 三大新聞管線確認

根據用戶澄清，三大新聞管線為：

1. **第一大：一般當日新聞的宏觀數據（A-F大類）**
   - 檔案：`24_P5_DAILY_NEWS.js`
   - 數據表：`NEWS_ATOMS_DAILY`（宏觀相關新聞）
   - 用途：更新宏觀世界觀

2. **第二大：一般當日新聞的個股相關數據**
   - 檔案：`24_P5_DAILY_NEWS.js` + `24_P5_DAILY_WEEKLY_OPTIMIZATION.js`
   - 數據表：`NEWS_ATOMS_DAILY`（個股相關新聞）+ `STOCK_NEWS_INDEX_DAILY`（個股新聞索引）
   - ✅ **已確認完成**：個股新聞索引已建立（V8.12）

3. **第三大：機構評級新聞管線**
   - 檔案：`24_P5_DAILY_INSTITUTIONAL_RATINGS.js`
   - 數據表：`INSTITUTIONAL_RATINGS_DAILY`
   - 用途：機構評級歷史動態學習

---

## 🔍 2. Weekly決策系統架構審查

### 2.1 系統架構（根據SSOT和代碼）

**主執行函數**：`24_P5_WEEKLY_CORE.js` → `P5_Weekly_Execute()`

**執行流程**：
1. ✅ **Step 1**: 檢查執行前確認
2. ✅ **Step 2**: 檢查決策權限（DEFCON評估，結合籌碼面）
3. ✅ **Step 3**: P2/P2.5/P3統一調度器
4. ✅ **Step 4**: 收集籌碼面數據
5. ✅ **Step 5**: 收集所有數據（`collectP5WeeklyAllData()`）
6. ✅ **Step 6**: 宏觀世界觀分析（`analyzeWeeklyWorldview()`）
7. ✅ **Step 7**: 事件監控與觸發（`scanUpcomingEventsAndTrigger()`）
8. ✅ **Step 8**: 計算完整技術指標
9. ✅ **Step 9**: 分批生成個股策略（`generateStockStrategiesInBatches()`）
   - ⭐ V8.12：已整合優化索引數據（個股新聞、板塊新聞、事件、波動度）
10. ✅ **Step 10**: 構建整合Prompt
11. ✅ **Step 11**: 提交到M0 Job Queue

### 2.2 數據來源完整性檢查

#### ✅ 宏觀世界觀分析（`24_P5_WEEKLY_WORLDVIEW.js`）
**數據來源**：
- ✅ 宏觀數據（`MACRO_DATA_DAILY`）
- ✅ 新聞（`NEWS_ATOMS_DAILY`）- **第一大新聞管線**
- ✅ 歷史學習日誌（`P5__LEARNING_LOG`）
- ✅ 籌碼面數據（`SMART_MONEY_WEEKLY`）

**功能**：
- ✅ 分析宏觀世界觀
- ✅ 更新市場Regime
- ✅ 整合歷史學習經驗

#### ✅ 個股決策系統（`24_P5_WEEKLY_STOCK_STRATEGY.js`）
**數據來源**（已索引化）：
- ✅ 個股新聞索引（`STOCK_NEWS_INDEX_DAILY`）- **第二大新聞管線**
- ✅ 板塊/產業新聞索引（`SECTOR_NEWS_INDEX_DAILY`）
- ✅ 事件索引（`EVENTS_INDEX_WEEKLY`）
- ✅ 宏觀數據週度波動度（`MACRO_DATA_WEEKLY_METRICS`）
- ✅ 技術指標週度波動度（`TECHNICAL_INDICATORS_WEEKLY_METRICS`）
- ✅ 機構評級數據（`INSTITUTIONAL_RATINGS_DAILY`）- **第三大新聞管線**
- ✅ P0-P4快照數據
- ✅ 技術指標、衍生品、籌碼面數據

**功能**：
- ✅ 整合所有因子（worldview、event、technical、fundamental、institutional、smart_money）
- ✅ AI動態權重決定
- ✅ 生成個股策略

### 2.3 ⚠️ 發現的問題

#### 問題1：動態學習系統的數據引用完整性

**現有實現**（`24_P5_WEEKLY_LEARNING.js`）：
- ✅ `trackStockStrategies()` - 追蹤個股策略（保存到`P5__WEEKLY_STOCK_STRATEGIES`）
- ✅ `analyzeDeviationWithAI()` - AI分析偏移度（預測vs實際）
- ✅ `collectHistoricalLearningLog()` - 收集歷史學習日誌

**⚠️ 缺失的部分**：
1. **策略比對機制**：
   - ❓ 是否有機制將「Weekly產出的策略」與「後來市場的真實反應」進行比對？
   - ❓ 是否有機制計算「準確度、相關性」等指標？
   - ❓ 是否有機制保存「前一週的策略比對紀錄」？

2. **數據引用完整性**：
   - ❓ 所有進Weekly決策系統的數據（宏觀數據、新聞、技術指標等）是否都有進入動態學習系統？
   - ❓ 最後的產出策略是否都有與市場真實反應比對？

3. **頻率分工**：
   - ✅ Weekly負責：前一週的策略比對（應在每週執行時比對上一週的策略）
   - ✅ Monthly負責：前一月的策略比對（應在每月執行時比對上一月的策略）
   - ✅ Quarterly負責：前一季的策略比對（應在每季執行時比對上一季的策略）
   - ❓ 目前代碼中是否有明確的頻率分工？

---

## 📊 3. 動態學習系統數據引用審查

### 3.1 現有實現檢查

**檔案**：`24_P5_WEEKLY_LEARNING.js`

**已實現功能**：
1. ✅ `trackStockStrategies()` - 保存個股策略到`P5__WEEKLY_STOCK_STRATEGIES`
2. ✅ `analyzeDeviationWithAI()` - AI分析偏移度
3. ✅ `collectHistoricalLearningLog()` - 收集歷史學習日誌

**數據表**：
- ✅ `P5__WEEKLY_STOCK_STRATEGIES` - 個股策略追蹤表
- ✅ `P5__LEARNING_LOG` - 學習日誌表

### 3.2 ⚠️ 需要確認的問題

#### 問題1：策略比對機制
**用戶要求**：
> 所有進Weekly決策系統的數據與分析，以及最後的產出策略，都必須要跟後來市場的真實反應一起進入動態學習系統，去比對準確度、相關性等

**現有實現**：
- ✅ 有保存策略（`trackStockStrategies()`）
- ✅ 有AI分析偏移度（`analyzeDeviationWithAI()`）
- ❓ **但缺少**：自動比對「策略預測」與「市場真實反應」的機制
- ❓ **缺少**：計算「準確度、相關性」等指標的機制
- ❓ **缺少**：保存「前一週/月/季的策略比對紀錄」的機制

#### 問題2：數據引用完整性
**用戶要求**：
> Daily的新聞數據摘要被Weekly的動態學習系統引用

**現有實現**：
- ✅ Weekly有讀取新聞數據（通過索引）
- ✅ Weekly有讀取宏觀數據
- ❓ **但缺少**：明確的機制將「所有進Weekly的數據」都記錄到學習系統
- ❓ **缺少**：明確的機制將「策略產出時使用的數據」與「後續市場反應」進行關聯

#### 問題3：頻率分工
**用戶要求**：
> 做出前一週/月/季的策略比對紀錄（由Weekly/Monthly/Quarterly按頻率各自負責）

**現有實現**：
- ✅ Weekly有學習機制（`24_P5_WEEKLY_LEARNING.js`）
- ✅ Monthly有學習機制（SSOT提到`24_P5_MONTHLY.js` + `24_P5_WEEKLY_LEARNING.js`）
- ✅ Quarterly有學習機制（SSOT提到）
- ❓ **但缺少**：明確的頻率分工邏輯（Weekly比對上一週、Monthly比對上一月、Quarterly比對上一季）

---

## ❓ 需要用戶確認的問題

### 問題1：策略比對機制的實現方式
**現狀**：
- 有保存策略（`P5__WEEKLY_STOCK_STRATEGIES`）
- 有AI分析偏移度（`analyzeDeviationWithAI()`）

**需要確認**：
1. 是否需要在Weekly執行時，自動比對「上一週的策略」與「本週的市場真實反應」？
2. 比對的指標應該包括哪些？（準確度、相關性、方向偏差、幅度偏差、時機偏差？）
3. 比對結果應該保存到哪裡？（`P5__LEARNING_LOG`？新的表格？）

### 問題2：數據引用完整性
**現狀**：
- Weekly有讀取各種數據（宏觀、新聞、技術指標等）
- 有保存策略到`P5__WEEKLY_STOCK_STRATEGIES`

**需要確認**：
1. 是否需要記錄「策略產出時使用的所有數據來源」？
2. 是否需要將「使用的數據」與「後續市場反應」進行關聯分析？
3. 是否需要建立「數據-策略-結果」的完整追蹤鏈？

### 問題3：頻率分工的具體實現
**現狀**：
- Weekly、Monthly、Quarterly都有學習機制

**需要確認**：
1. Weekly是否應該在執行時比對「上一週的策略」與「本週的市場反應」？
2. Monthly是否應該在執行時比對「上一月的策略」與「本月的市場反應」？
3. Quarterly是否應該在執行時比對「上一季的策略」與「本季的市場反應」？
4. 比對的邏輯是否應該統一（使用相同的函數），只是時間範圍不同？

### 問題4：三大新聞管線的數據引用
**現狀**：
- 第一大（宏觀新聞）：用於宏觀世界觀分析 ✅
- 第二大（個股新聞）：用於個股策略生成 ✅
- 第三大（機構評級）：用於機構評級歷史動態學習 ✅

**需要確認**：
1. 三大新聞管線的數據是否都已經進入動態學習系統？
2. 是否需要建立「新聞-策略-結果」的追蹤鏈？

---

## 📝 建議的實現方案（待用戶確認）

### 方案1：策略比對機制
1. **在Weekly執行時**：
   - 讀取上一週的策略（從`P5__WEEKLY_STOCK_STRATEGIES`）
   - 讀取本週的市場真實反應（從`MARKET_OHLCV_DAILY`等）
   - 計算比對指標（準確度、相關性、偏差等）
   - 保存比對結果到`P5__LEARNING_LOG`

2. **在Monthly執行時**：
   - 讀取上一月的策略
   - 讀取本月的市場真實反應
   - 計算比對指標
   - 保存比對結果

3. **在Quarterly執行時**：
   - 讀取上一季的策略
   - 讀取本季的市場真實反應
   - 計算比對指標
   - 保存比對結果

### 方案2：數據引用完整性
1. **記錄策略產出時的數據來源**：
   - 在保存策略時，同時記錄使用的數據來源（宏觀數據、新聞、技術指標等）
   - 建立「數據-策略」的關聯表

2. **建立「數據-策略-結果」追蹤鏈**：
   - 記錄策略使用的數據
   - 記錄策略產出
   - 記錄市場真實反應
   - 進行關聯分析

### 方案3：頻率分工
1. **統一比對函數**：
   - 建立通用的比對函數（`compareStrategyWithMarketReaction()`）
   - 接受時間範圍參數（週/月/季）

2. **各頻率調用**：
   - Weekly調用：比對上一週
   - Monthly調用：比對上一月
   - Quarterly調用：比對上一季

---

## ✅ 確認事項

請用戶確認：
1. ✅ 三大新聞管線的理解是否正確？
2. ✅ Weekly決策系統架構是否正確？
3. ❓ 動態學習系統的數據引用是否需要補充實現？
4. ❓ 策略比對機制是否需要補充實現？
5. ❓ 頻率分工是否需要明確實現？

**確認無誤後，開始實施補充實現。**
