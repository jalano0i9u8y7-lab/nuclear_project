# V8.12 Weekly系統優化分析與建議

**日期**：2026-01-19  
**目標**：找出「Weekly需要重複執行100次」的工作，避免每分析一個股票都要重新搜尋/過濾

**⚠️ 此版本已過時，請參考 `V8.12_Weekly系統優化分析與建議_修正版.md`**

---

## 🔍 Weekly當前數據處理負擔分析

### 當前Weekly需要處理的數據：

從 `24_P5_WEEKLY_STOCK_STRATEGY.js` 和 `24_P5_WEEKLY_CORE.js` 分析，Weekly在分析每個股票時需要：

1. **技術指標數據**：
   - 需要讀取 `MARKET_INDICATORS_DAILY`（可能需要讀7天的數據）
   - 需要讀取 `MARKET_OHLCV_DAILY`（讀240天用於計算完整技術指標）
   - 在 `calculateFullTechnicalIndicatorsWeekly()` 中為每個股票重新計算技術指標

2. **宏觀數據**：
   - 需要讀取7天的 `MACRO_DATA_DAILY` 數據
   - 需要分析宏觀數據趨勢

3. **新聞數據**：
   - ✅ **V8.12已優化**：有了個股新聞索引（`STOCK_NEWS_INDEX_DAILY`），不用重新搜尋

4. **機構評級**：
   - ✅ **V8.12已優化**：有了個股索引統計

5. **籌碼面數據**：
   - 需要讀取 `DERIVATIVES_DAILY`、`SMART_MONEY_WEEKLY` 等
   - 需要為每個股票整合籌碼面因子

6. **板塊/產業數據**：
   - 需要讀取 `SECTOR_ETF_DAILY`
   - 需要分析板塊輪動和產業熱點

---

## 💡 優化建議（類似新聞+個股索引模式）

### 優化1：技術指標週度摘要 ⭐⭐⭐ **高優先級**

**問題**：
- Weekly需要為每個股票讀取240天OHLCV數據並重新計算技術指標
- 即使Daily已經計算了技術指標，Weekly還是要重新計算（因為需要完整計算MACD等）
- 如果Weekly只關注「本週變化趨勢」，不需要重新讀所有原始數據

**優化方案**：
- **Daily責任**：在計算技術指標後，額外產生「週度技術趨勢摘要」
- **使用Gemini Flash**：對本週（過去7天）的技術指標變化做摘要分析
- **輸出內容**：
  - 技術指標趨勢方向（RSI、MACD、均線等是上升/下降/震盪）
  - 關鍵變化點（是否突破、是否背離等）
  - 簡短摘要（1-2句話總結本週技術面變化）

**表格設計**：`TECHNICAL_INDICATORS_WEEKLY_SUMMARY`
- 欄位：`ticker`, `week_start_date`, `week_end_date`, `rsi_trend`, `macd_trend`, `ma_trend`, `key_events_json`, `summary`, `created_at`

**優化效果**：
- Weekly不用讀240天原始數據，只需要讀一週的摘要
- 大幅降低Weekly的數據處理負擔

---

### 優化2：宏觀數據週度摘要 ⭐⭐ **中優先級**

**問題**：
- Weekly需要讀取7天的宏觀數據並分析趨勢
- 每個Weekly執行都要重新讀取和分析

**優化方案**：
- **Daily責任**：每週最後一天（例如週五），由Daily產生「本週宏觀數據摘要」
- **使用Gemini Flash**：對本週（過去7天）的宏觀數據變化做摘要
- **輸出內容**：
  - 宏觀數據趨勢摘要（油價、匯率、利率、VIX等變化方向）
  - 關鍵事件時間線（本週重要宏觀事件）
  - 市場結構變化（Risk-on/Risk-off信號）

**表格設計**：`MACRO_DATA_WEEKLY_SUMMARY`
- 欄位：`week_start_date`, `week_end_date`, `commodities_summary_json`, `currencies_summary_json`, `bonds_summary_json`, `indices_summary_json`, `key_events_timeline_json`, `risk_on_off_signal`, `created_at`

**優化效果**：
- Weekly不用讀7天的原始宏觀數據，只需要讀一週摘要
- 降低Weekly數據處理負擔

---

### 優化3：板塊/產業熱點索引 ⭐⭐⭐ **高優先級**

**問題**：
- Weekly需要分析板塊輪動和產業熱點
- 可能需要在新聞中搜尋特定產業/板塊相關的新聞
- 類似個股新聞索引，但按板塊/產業聚合

**優化方案**：
- **Daily責任**：建立「板塊/產業新聞索引」（類似個股索引）
- **使用Gemini Flash**：從新聞中提取板塊/產業標籤（基於多維度標籤的 `event_type` 和 `impact_scope`）
- **聚合方式**：
  - 按板塊聚合（科技、金融、能源等）
  - 按產業聚合（半導體、AI、電動車等）
  - 統計每週討論度變化（類似個股索引）

**表格設計**：`SECTOR_NEWS_INDEX_WEEKLY`
- 欄位：`week_start_date`, `week_end_date`, `sector_or_industry`, `news_count`, `sentiment_summary_json`, `key_events_json`, `news_ids_json`, `created_at`

**優化效果**：
- Weekly不用重新搜尋板塊/產業相關新聞，直接讀索引
- 快速識別本週熱點板塊/產業
- 類似個股索引，大幅降低搜尋負擔

---

### 優化4：技術面週度變化摘要 ⭐⭐ **中優先級**

**問題**：
- Weekly需要分析每個股票的技術面變化
- 需要讀取多天的技術指標數據並判斷趨勢

**優化方案**：
- **Daily責任**：在每日計算技術指標時，額外標記「變化方向」
- **週度聚合**：每週最後一天，聚合本週技術指標變化趨勢
- **輸出內容**：
  - RSI變化趨勢（上升/下降/震盪）
  - MACD變化趨勢
  - 均線變化（是否突破、是否跌破）
  - 成交量變化趨勢

**表格設計**：`TECHNICAL_TREND_WEEKLY_SUMMARY`
- 欄位：`ticker`, `week_start_date`, `week_end_date`, `rsi_change`, `macd_change`, `ma_trend_json`, `volume_trend`, `summary`, `created_at`

**優化效果**：
- Weekly不用重新分析技術指標趨勢，直接讀摘要
- 降低Weekly技術面分析負擔

---

### 優化5：籌碼面週度索引 ⭐ **低優先級**（已有SMART_MONEY_WEEKLY）

**問題**：
- Weekly需要整合籌碼面數據
- 需要從多個表格（DERIVATIVES_DAILY、SMART_MONEY_WEEKLY等）讀取數據

**現狀**：
- 已經有 `SMART_MONEY_WEEKLY` 表格
- 籌碼面數據已經按週聚合

**優化建議**：
- 保持現狀即可，因為已經有週度聚合
- 可以考慮增加「籌碼面週度變化摘要」（類似技術指標摘要）

---

### 優化6：市場寬度週度摘要 ⭐⭐ **中優先級**

**問題**：
- Weekly需要分析市場寬度（Advance/Decline、New High/Low等）
- 可能需要讀取多天的市場寬度數據

**優化方案**：
- **Daily責任**：收集市場寬度數據後，產生週度摘要
- **輸出內容**：
  - 本週市場寬度變化趨勢
  - 市場結構變化（集中型上漲 vs 全面上漲）
  - 關鍵轉折點

**表格設計**：`MARKET_BREADTH_WEEKLY_SUMMARY`
- 欄位：`week_start_date`, `week_end_date`, `advance_decline_trend_json`, `new_high_low_trend_json`, `market_structure_change`, `summary`, `created_at`

---

## 📊 優化優先級排序

### 🔴 最高優先級（立即實施）

1. **技術指標週度摘要**（優化1）
   - **原因**：Weekly需要讀240天數據並重新計算，負擔最重
   - **實施難度**：中等（需要新增表格和Daily聚合邏輯）
   - **優化效果**：大幅降低技術指標數據處理負擔

2. **板塊/產業熱點索引**（優化3）
   - **原因**：類似個股新聞索引，可以避免Weekly重新搜尋
   - **實施難度**：中等（類似個股索引實現方式）
   - **優化效果**：快速識別熱點板塊/產業，避免重複搜尋

### 🟡 中優先級（後續實施）

3. **宏觀數據週度摘要**（優化2）
   - **原因**：Weekly需要讀7天數據，有一定負擔
   - **實施難度**：簡單（只需在Daily最後一天聚合）
   - **優化效果**：降低宏觀數據分析負擔

4. **市場寬度週度摘要**（優化6）
   - **原因**：輔助Weekly Regime分析
   - **實施難度**：簡單
   - **優化效果**：輔助市場結構分析

5. **技術面週度變化摘要**（優化4）
   - **原因**：與優化1類似，但更細化
   - **實施難度**：中等
   - **優化效果**：進一步降低技術面分析負擔

---

## 🎯 實施原則

### ✅ 必須遵守的原則

1. **不違背職權分工**：
   - Daily只做「摘要」和「索引」，不做「分析」和「結論」
   - Weekly負責「分析」和「決策」
   - Daily的摘要應該只包含「事實性描述」，不包含「投資建議」

2. **確保數據不被污染**：
   - Daily摘要必須基於原始數據（不修改、不扭曲）
   - 摘要應該保留「可追溯性」（能追溯到原始數據）

3. **不做前層邏輯分析**：
   - Daily摘要不應該做「市場方向判斷」
   - Daily摘要不應該做「投資意義分析」
   - Daily摘要只做「數據整理」和「趨勢識別」

### ✅ 實施方式

1. **使用Gemini Flash**：
   - 用於生成摘要（成本低、速度快）
   - 類似新聞索引的實現方式

2. **類似新聞索引模式**：
   - 建立「反向索引」或「聚合表」
   - 讓Weekly可以快速讀取，不用重新搜尋

---

## 📋 建議實施順序

### Phase 1：技術指標週度摘要 + 板塊/產業熱點索引（最高優先級）

**技術指標週度摘要**：
- 新增表格：`TECHNICAL_INDICATORS_WEEKLY_SUMMARY`
- 在Daily最後一天（週五）觸發聚合
- 使用Gemini Flash生成摘要

**板塊/產業熱點索引**：
- 新增表格：`SECTOR_NEWS_INDEX_WEEKLY`
- 從新聞的多維度標籤中提取板塊/產業信息
- 按板塊/產業聚合新聞

### Phase 2：宏觀數據週度摘要 + 市場寬度週度摘要（中優先級）

**宏觀數據週度摘要**：
- 新增表格：`MACRO_DATA_WEEKLY_SUMMARY`
- 在Daily最後一天（週五）觸發聚合

**市場寬度週度摘要**：
- 新增表格：`MARKET_BREADTH_WEEKLY_SUMMARY`
- 聚合本週市場寬度數據

---

## 🔄 Weekly使用方式改變

### 優化前（當前）：
```
Weekly分析每個股票時：
1. 讀取240天OHLCV數據
2. 重新計算技術指標
3. 讀取7天宏觀數據並分析
4. 從新聞中搜尋該股票相關新聞
5. 從新聞中搜尋該股票所屬板塊/產業相關新聞
...
```

### 優化後（建議）：
```
Weekly分析每個股票時：
1. 讀取技術指標週度摘要（1行數據，已包含本週趨勢）
2. 讀取宏觀數據週度摘要（1行數據，已包含本週趨勢）
3. 讀取個股新聞索引（1行數據，快速定位相關新聞）
4. 讀取板塊/產業熱點索引（快速了解所屬板塊/產業熱點）
...
```

---

## 💰 優化效果預估

### 數據量減少：
- **技術指標數據**：從240天 × 多個指標 → 1行摘要（約減少99%數據量）
- **宏觀數據**：從7天 × 多個數據點 → 1行摘要（約減少90%數據量）
- **新聞搜尋**：從搜尋全部新聞 → 直接讀索引（約減少95%搜尋時間）

### Prompt長度減少：
- **預估減少**：約50-70%的數據處理內容
- **預估減少**：約30-40%的Prompt總長度

### AI算力節省：
- **大幅減少**：Weekly不需要重新計算技術指標
- **大幅減少**：Weekly不需要重新搜尋新聞
- **預估節省**：約40-60%的數據處理時間

---

## ⚠️ 注意事項

1. **Daily必須在週五產生週度摘要**：
   - 週度摘要應該在每週最後一天（週五）產生
   - 確保Weekly執行時有最新的週度摘要

2. **摘要必須保留可追溯性**：
   - 摘要中應該包含原始數據的ID或日期範圍
   - 方便Weekly需要時可以回溯原始數據

3. **摘要格式必須方便Weekly讀取**：
   - 類似新聞索引，格式設計要方便Weekly AI讀取和使用
   - 避免過於複雜的JSON結構

---

**狀態**：⏳ **待定案**  
**下一步**：等待用戶確認後開始實施
