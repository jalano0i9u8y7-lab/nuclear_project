# V8.0 實現計劃

> **版本**：V8.0  
> **定案日期**：2026-01-17  
> **狀態**：開始實現階段

---

## 📋 實現優先級

### 第一階段：GOOGLEFINANCE 數據源整合（高優先級）

#### 1.1 P5.1 宏觀數據整合 GOOGLEFINANCE
- [ ] 更新 `24_P5_DAILY_MACRO.js` 中的 `getMacroFromGoogleFinance` 函數
  - [ ] 使用 `fetchGoogleFinanceSafe` 函數（從 `26_TEST_GOOGLEFINANCE.js`）
  - [ ] 更新對照表（使用正確的 GOOGLEFINANCE 代碼）
  - [ ] 匯率：`CURRENCY:XXXYYY`
  - [ ] 國債利率：`INDEXCBOE:XXX`（注意除以 10）
  - [ ] 商品期貨：使用 ETF 代理（`USO`, `GLD`, `SLV` 等）
  - [ ] VIX：`INDEXCBOE:VIX`
- [ ] 測試宏觀數據收集功能
- [ ] 移除或標記為備用的原有數據源

#### 1.2 P5.2 OHLCV 數據整合 GOOGLEFINANCE
- [ ] 創建 `24_P5_DAILY_OHLCV_GOOGLEFINANCE.js` 檔案
  - [ ] 實現 `fetchGoogleFinanceOHLCV` 函數
  - [ ] 使用 `fetchGoogleFinanceSafe` 和 `fetchGoogleFinanceHistorySafe`
  - [ ] 支援美股、台股、日股格式
- [ ] 更新 `24_P5_DAILY_OHLCV_CORE.js` 優先使用 GOOGLEFINANCE
- [ ] 測試 OHLCV 數據收集功能

---

### 第二階段：P6 盤中監測系統實現（高優先級）

#### 2.1 P6 數據表格結構
- [ ] 在 `01_SHEETS_STRUCTURE.js` 中新增表格 Schema：
  - [ ] `P6_INTRADAY_LOG` - 盤中監測日誌
  - [ ] `P6_EMERGENCY_EXIT_LOG` - 緊急撤退記錄
  - [ ] `P6_INTRADAY_ALERTS_DAILY` - 盤中異常警報（需保留的數據）
- [ ] 實現表格初始化函數

#### 2.2 P6 核心模組實現
- [ ] `28_P6_DATA_COLLECTOR.js` - GOOGLEFINANCE 數據收集
  - [ ] 實現 `collectIntradayData` 函數
  - [ ] 支援持倉股票、選擇權個股、主要指數、板塊 ETF、追蹤池股票
- [ ] `28_P6_SHADOW_MECHANISM.js` - 殘影機制
  - [ ] 實現價格點記錄
  - [ ] 實現 20 分鐘價格變化計算
- [ ] `28_P6_INTRADAY_MONITOR.js` - 核心監測邏輯
  - [ ] 盤中異常偵測（暴跌、暴漲、爆量）
  - [ ] 整合殘影機制
  - [ ] 整合財報事件監控（從 P5.5 搬移）
  - [ ] 整合目標價監控（台股，從 P5.6 搬移）
- [ ] `28_P6_EMERGENCY_EXIT.js` - 緊急撤退協議（從 P4.6 搬移）
  - [ ] Layer 1：寫死的即時防禦（無 AI）
  - [ ] 觸發條件與對應動作
  - [ ] 減倉比例固定
- [ ] `28_P6_DEFCON_ADJUSTER.js` - DEFCON 盤中調整
  - [ ] Rule-Based 調整邏輯
- [ ] `28_P6_LOGGER.js` - 日誌記錄與數據保留
  - [ ] 記錄異常事件
  - [ ] 數據保留規則（一般隔天清除，異常保留到 Daily）
  - [ ] 標記「需保留」的數據

#### 2.3 P6 Time-driven Trigger 設定
- [ ] 實現 `setupP6Triggers` 函數
- [ ] 一般監測：每 20 分鐘
- [ ] 選擇權個股：每 5 分鐘（僅盤中時段）
- [ ] 市場開盤時間判斷（台股、日股、美股）

#### 2.4 P6 數據整合到 P5 Daily/Weekly
- [ ] 在 P5 Daily 中實現讀取 P6 異常數據
- [ ] 整合到 `MARKET_OHLCV_DAILY` 或 `P6_INTRADAY_ALERTS_DAILY`
- [ ] 在 P5 Weekly 中整合 P6 異常記錄到世界觀分析

---

### 第三階段：清理與廢棄檔案（中優先級）

- [ ] 標記 `12_P4_6_EMERGENCY_EXIT.js` 為廢棄（功能已移至 P6）
- [ ] 標記 `17_TAIWAN_ORDER_MONITOR.js` 為廢棄（功能已移至 P6）
- [ ] 更新相關引用

---

## 📝 實現注意事項

1. **GOOGLEFINANCE 非同步延遲**：
   - 必須使用 `fetchGoogleFinanceSafe` 和 `fetchGoogleFinanceHistorySafe`
   - 等待機制：最多 20 次重試（單值）/ 40 次重試（歷史數據）

2. **P6 設計原則**：
   - 平常正常監控根本用不到 AI 模型（Rule-Based 即可）
   - 只有緊急事件的情況才需要決策（盤中 Rule-Based，盤後 AI）

3. **數據保留規則**：
   - 一般正常情況：隔天清除
   - 異常情況：保留到 P5 Daily 日更資料

4. **職權分工**：
   - P6：盤中監測（Rule-Based，無 AI）
   - P5 Daily：數據收集與整理（收盤後執行）
   - P5 Weekly：盤後 AI 分析緊急事件

---

## ✅ 完成標準

每個模組實現完成後必須：
1. 通過基本功能測試
2. 符合 SSOT V8.0 設計規格
3. 錯誤處理完善
4. 日誌記錄完整
5. 上傳到 GAS 並驗證

---

**開始實現日期**：2026-01-17  
**預計完成日期**：待定
