/**
 * ğŸ“Š P5 Weekly: Prompt æ§‹å»ºæ¨¡çµ„
 * 
 * è² è²¬æ§‹å»ºæ‰€æœ‰ P5 Weekly ç›¸é—œçš„ AI Promptï¼š
 * - å®è§€ä¸–ç•Œè§€åˆ†æ Prompt
 * - å€‹è‚¡ç­–ç•¥åˆ†æ Promptï¼ˆå¸¶ Batch æ”¯æŒï¼‰
 * - æ•´åˆ Prompt
 * 
 * @version SSOT V7.1
 * @date 2025-01-12
 */

// ==========================================
// å®è§€ä¸–ç•Œè§€åˆ†æ Prompt
// ==========================================

/**
 * æ§‹å»ºå®è§€ä¸–ç•Œè§€åˆ†æ Prompt
 * 
 * @param {Object} data - æ•¸æ“š
 * @param {Object} data.macroData - å®è§€æ•¸æ“š
 * @param {Array} data.worldviewHistory - æ­·å²ä¸–ç•Œè§€æ›´æ–°
 * @param {Array} data.learningLogHistory - æ­·å²å­¸ç¿’æ—¥èªŒ
 * @param {Object} data.weeklyMarketData - æœ¬é€±å¸‚å ´æ•¸æ“š
 * @returns {string} prompt - AI Prompt
 */
function buildWorldviewPrompt(data) {
  const {
    macroData = {},
    worldviewHistory = [],
    learningLogHistory = [],
    weeklyMarketData = {},
    smartMoneyReport = {},  // â­ V8.0 æ–°å¢ï¼šç±Œç¢¼é¢é€±å ±
    sectorETFFlows = {},    // â­ V8.0 æ–°å¢ï¼šSector ETF Flow
    rotationSignal = {},     // â­ V8.0 æ–°å¢ï¼šRotation Signal
    mag7Analysis = {}        // â­ V8.0 æ–°å¢ï¼šMag 7 é›†é«”è¡¨ç¾åˆ†æ
  } = data;
  
  return `
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å®è§€ç¶“æ¿Ÿåˆ†æå¸«ï¼Œè² è²¬é€²è¡Œ Nuclear Project çš„ P5 Weekly å®è§€ä¸–ç•Œè§€åˆ†æã€‚

## ä»»å‹™ç›®æ¨™

åŸºæ–¼æœ¬é€±æ‰€æœ‰å¸‚å ´æ•¸æ“šã€å®è§€æ•¸æ“šã€æ–°èå’Œæ­·å²ä¸–ç•Œè§€ï¼Œé€²è¡Œå…¨é¢çš„å®è§€ä¸–ç•Œè§€åˆ†æï¼š
1. **æ•´åˆæœ¬é€±æ‰€æœ‰æ–°èå¿«ç…§å’Œå¸‚å ´æ•¸æ“š**ï¼šåˆ†ææœ¬é€±çš„å®è§€ä¸–ç•Œè²¡ç¶“è§€
2. **èˆ‡æ­·å²ä¸–ç•Œè§€å°ç…§**ï¼šèˆ‡å‰ä¸€å€‹æœˆï¼ˆ4 é€±ï¼‰çš„ä¸–ç•Œè§€åšé€£æ¥èˆ‡å°ç…§
3. **å­¸ç¿’ä¸–ç•Œè§€çš„è®ŠåŒ–**ï¼šè­˜åˆ¥ä¸–ç•Œè§€çš„æ¼”è®Šè¶¨å‹¢
4. **åˆ†æä¸–ç•Œè§€èˆ‡å¸‚å ´åæ‡‰çš„é€£çµ**ï¼šåˆ¤æ–·ä¸–ç•Œè§€èˆ‡ç¾å¯¦å¸‚å ´åæ‡‰æ˜¯ç›¸ç¬¦ã€ç„¡é—œé‚„æ˜¯èƒŒé›¢

## æœ¬é€±å®è§€æ•¸æ“š

${JSON.stringify(macroData, null, 2)}

## æœ¬é€±å¸‚å ´æ•¸æ“šæ‘˜è¦

${JSON.stringify(weeklyMarketData, null, 2)}

## æ­·å²ä¸–ç•Œè§€æ›´æ–°ï¼ˆæœ€è¿‘ 4 é€±ï¼‰

${JSON.stringify(worldviewHistory.slice(0, 4), null, 2)}

## æ­·å²å­¸ç¿’æ—¥èªŒï¼ˆæœ€è¿‘ 4 é€±ï¼‰

${JSON.stringify(learningLogHistory.slice(0, 4), null, 2)}

## ç±Œç¢¼é¢é€±å ± â­ V8.0 æ–°å¢

${JSON.stringify(smartMoneyReport, null, 2)}

**é‡è¦**ï¼šç±Œç¢¼é¢ä¿¡è™Ÿï¼ˆBULLISH/NEUTRAL/BEARISHï¼‰æ‡‰å½±éŸ¿æ•´é«”å¸‚å ´åˆ¤æ–·ã€‚

## Sector ETF Flow åˆ†æ â­ V8.0 æ–°å¢

**Sector ETF Flow æ•¸æ“š**ï¼š
${JSON.stringify(sectorETFFlows, null, 2)}

**è³‡é‡‘è¼ªå‹•ä¿¡è™Ÿï¼ˆRotation Signalï¼‰**ï¼š
${JSON.stringify(rotationSignal, null, 2)}

**é‡è¦**ï¼š
- è³‡é‡‘æµå…¥æ¿å¡Šï¼ˆto_sectorsï¼‰è¡¨ç¤ºå¸‚å ´è³‡é‡‘åå¥½
- è³‡é‡‘æµå‡ºæ¿å¡Šï¼ˆfrom_sectorsï¼‰è¡¨ç¤ºå¸‚å ´è³‡é‡‘æ’¤é›¢
- Regimeï¼ˆRISK_ON/RISK_OFF/ROTATION/CRISISï¼‰æ‡‰æ•´åˆåˆ°å¸‚å ´ Regime åˆ¤æ–·ä¸­

## Mag 7 é›†é«”è¡¨ç¾åˆ†æ â­ V8.0 æ–°å¢

**Mag 7 æˆå“¡**ï¼šAAPL, MSFT, GOOGL, AMZN, NVDA, META, TSLA

**Mag 7 é›†é«”è¡¨ç¾æ•¸æ“š**ï¼š
${JSON.stringify(mag7Analysis, null, 2)}

**è©•åˆ†é«”ç³»**ï¼š
- æ¯æª”è²¡å ±è©•åˆ†ï¼š+2ï¼ˆBeat + æŒ‡å¼•ä¸Šèª¿ï¼‰ã€+1ï¼ˆBeat + æŒå¹³ï¼‰ã€0ï¼ˆç¬¦åˆï¼‰ã€-1ï¼ˆMiss + æŒå¹³ï¼‰ã€-2ï¼ˆMiss + ä¸‹èª¿ï¼‰
- ç¸½åˆ†ç¯„åœï¼š-14 to +14

**Regime æ˜ å°„è¦å‰‡**ï¼š
- **+10 to +14**ï¼šBULL_STRONG â†’ U_macro 0.80ï¼ŒDEFCON 5
- **+5 to +9**ï¼šBULL_WEAK â†’ U_macro 0.70ï¼ŒDEFCON 5
- **-4 to +4**ï¼šNEUTRAL â†’ U_macro 0.60ï¼ŒDEFCON 4
- **-9 to -5**ï¼šBEAR_WEAK â†’ U_macro 0.50ï¼ŒDEFCON 3
- **-14 to -10**ï¼šBEAR_STRONG â†’ U_macro 0.30ï¼ŒDEFCON 1

**é‡è¦**ï¼š
- â­â­â­ **Mag 7 é›†é«”è¡¨ç¾æ˜¯å¸‚å ´ Regime åˆ¤æ–·çš„é‡è¦æŒ‡æ¨™**ï¼Œå¿…é ˆæ•´åˆåˆ° market_regime åˆ¤æ–·ä¸­
- â­â­â­ **Mag 7 ç¸½åˆ†æ‡‰å½±éŸ¿ u_macro_recommendation çš„å»ºè­°å€¼**
- â­â­â­ **å¦‚æœ Mag 7 ç¸½åˆ† <= -10ï¼Œæ‡‰æé«˜ risk_assessment.systemic_risk ç­‰ç´šï¼Œä¸¦å»ºè­°å•Ÿå‹• DEFCON 1**
- åœ¨è²¡å ±å­£çµæŸå¾Œï¼ˆ4-6 é€±ï¼‰ç¶œåˆè©•ä¼°ï¼Œä½†æ¯é€±éƒ½æ‡‰æ›´æ–°æœ€æ–°è²¡å ±çµæœ

## å¸‚å ´æƒ…ç·’æŒ‡æ¨™ â­ V8.0 æ–°å¢

**å¸‚å ´æƒ…ç·’æŒ‡æ¨™æ•¸æ“š**ï¼š
${JSON.stringify(weeklyMarketData.market_sentiment_indicators || {}, null, 2)}

**ç¾æœ‰å¸‚å ´æƒ…ç·’æŒ‡æ¨™**ï¼ˆå¾å®è§€æ•¸æ“šå’Œè¡ç”Ÿå“æ•¸æ“šä¸­ï¼‰ï¼š
- **VIX**ï¼ˆææ…ŒæŒ‡æ•¸ï¼‰ï¼š${macroData.indices?.VIX?.value || 'N/A'} - åæ˜ å¸‚å ´ææ…Œç¨‹åº¦
- **Put/Call Ratio**ï¼ˆçœ‹è·Œ/çœ‹æ¼²æ¯”ç‡ï¼‰ï¼š${weeklyMarketData.derivatives_summary?.avg_put_call_ratio || 'N/A'} - åæ˜ æœŸæ¬Šå¸‚å ´æƒ…ç·’
- **Skew**ï¼ˆååº¦æŒ‡æ•¸ï¼‰ï¼š${weeklyMarketData.derivatives_summary?.skew || 'N/A'} - åæ˜ å°¾éƒ¨é¢¨éšª

**æ–°å¢å¸‚å ´æƒ…ç·’æŒ‡æ¨™**ï¼š
- **FPE_B**ï¼ˆåˆ†æå¸«å…±è­˜ Forward P/Eï¼‰ï¼š
  - åæ˜ å¸‚å ´å°å€‹è‚¡çš„æ™®éçœ‹æ³•ï¼ˆæ¨‚è§€/ä¸­æ€§/æ‚²è§€ï¼‰
  - FPE_B å€¼è¶Šé«˜ï¼Œè¡¨ç¤ºå¸‚å ´å°è©²è‚¡ç¥¨çš„ä¼°å€¼é æœŸè¶Šé«˜ï¼ˆå¯èƒ½éåº¦æ¨‚è§€ï¼‰
  - FPE_B å€¼è¶Šä½ï¼Œè¡¨ç¤ºå¸‚å ´å°è©²è‚¡ç¥¨çš„ä¼°å€¼é æœŸè¶Šä½ï¼ˆå¯èƒ½éåº¦æ‚²è§€ï¼‰
  - âš ï¸ **é‡è¦**ï¼šFPE_B èˆ‡ FPE_A çš„èƒŒé›¢å¯èƒ½åæ˜ å¸‚å ´æƒ…ç·’èˆ‡å…¬å¸å®˜æ–¹é æœŸçš„å·®ç•°
  - âš ï¸ **é‡è¦**ï¼šFPE_B çš„è®ŠåŒ–è¶¨å‹¢åæ˜ å¸‚å ´æƒ…ç·’è®ŠåŒ–

- **æ©Ÿæ§‹è¨€è¡Œä¸€è‡´æ€§åˆ†æï¼ˆInstitutional Sentimentï¼‰** â­ V8.6 æ–°å¢ï¼š
  - **æ•¸æ“šä¾†æº**ï¼šYahoo Finance / Finviz çš„æ©Ÿæ§‹è©•ç´šæ­·å²ï¼ˆUpgrades & Downgradesï¼‰
  - **æ ¸å¿ƒé‚è¼¯**ï¼šçµåˆã€Œåˆ†æå¸«èªªçš„è©±ã€èˆ‡ã€Œå¸‚å ´å¯¦éš›åæ‡‰ï¼ˆKç·š/é‡èƒ½ï¼‰ã€ä¾†åˆ¤æ–·æ˜¯çœŸè¨Šè™Ÿé‚„æ˜¯å‡å‹•ä½œ
  - **sentiment_label** è§£è®€ï¼š
    - **STRONG_BULL / BULLISH**ï¼šæ©Ÿæ§‹å‡ç´š + è‚¡åƒ¹å¤§æ¼² + çˆ†é‡ = çœŸåˆ©å¤šï¼ˆTrue Breakoutï¼‰ï¼Œå¯é †å‹¢æ“ä½œ
    - **NEUTRAL**ï¼šæ©Ÿæ§‹å‹•ä½œèˆ‡å¸‚å ´åæ‡‰ä¸ä¸€è‡´ï¼Œæˆ–ç„¡æ˜é¡¯è¶¨å‹¢
    - **BEARISH / STRONG_BEAR**ï¼šæ©Ÿæ§‹é™ç´š + è‚¡åƒ¹é‡æŒ« + çˆ†é‡ = çœŸåˆ©ç©ºï¼Œæ‡‰é¿é–‹
  - **warnings** è§£è®€ï¼ˆâš ï¸ é—œéµï¼‰ï¼š
    - **èª˜å¤šå‡ºè²¨ï¼ˆBull Trapï¼‰**ï¼šæ©Ÿæ§‹ Upgrade ä½†è‚¡åƒ¹ä¸æ¼²/ä¸‹è·Œ â†’ ä¸»åŠ›åœ¨å‡ºè²¨ï¼Œæº–å‚™ P4.6 æ’¤é€€
    - **èª˜ç©ºåƒè²¨ï¼ˆBear Trapï¼‰**ï¼šæ©Ÿæ§‹ Downgrade ä½†è‚¡åƒ¹ä¸è·Œ/ä¸Šæ¼² â†’ ä¸»åŠ›åœ¨åƒè²¨ï¼ŒP3 æº–å‚™é€²å ´
  - **æˆ°ç•¥æ„ç¾©**ï¼š
    - âš ï¸ **é€™äº›æ˜¯ã€Œå¤§çœ¾çœ‹å¾—åˆ°çš„é¢¨å‘ã€ï¼Œä¸æ˜¯ä»˜è²»é ‚ç´šæƒ…å ±**
    - âš ï¸ **é‡é»æ˜¯ã€Œåå‘è§£è®€ã€èˆ‡ã€Œå…±è­˜æª¢é©—ã€**ï¼šå¦‚æœç™¼ç¾ã€Œé«˜ç››å–Šå¤š + è‚¡åƒ¹å¤§è·Œã€ï¼Œé€™æ¯”ä»»ä½•æŠ€è¡“æŒ‡æ¨™éƒ½æ›´æº–ç¢ºåœ°å‘Šè¨´æˆ‘å€‘ï¼šä¸»åŠ›åœ¨è·‘äº†
    - âš ï¸ **ä¸è¦åªçœ‹åˆ†æå¸«èªªä»€éº¼ï¼Œè¦çœ‹å¸‚å ´å°ä»–çš„è©±æœ‰ä»€éº¼åæ‡‰**

**é‡è¦**ï¼š
- â­â­â­ **æ‰€æœ‰å¸‚å ´æƒ…ç·’æŒ‡æ¨™ï¼ˆVIXã€Put/Call Ratioã€Skewã€FPE_Bã€æ©Ÿæ§‹è©•ç´šï¼‰æ‡‰ç¶œåˆåˆ¤æ–·å¸‚å ´ Regime**
- â­â­â­ **å¸‚å ´æƒ…ç·’æŒ‡æ¨™çš„æ¥µç«¯å€¼æ‡‰å½±éŸ¿ risk_assessment.systemic_risk ç­‰ç´š**
- â­â­â­ **æ©Ÿæ§‹è©•ç´šçš„ warningsï¼ˆèª˜å¤š/èª˜ç©ºï¼‰æ‡‰å„ªå…ˆæ–¼ sentiment_label æœ¬èº«ï¼Œå› ç‚ºå®ƒåæ˜ äº†ã€Œè¨€è¡Œä¸ä¸€è‡´ã€çš„ç•°å¸¸è¨Šè™Ÿ**
- â­ V8.9 æ–°å¢ï¼š**å¤šæ™‚é–“ç¶­åº¦åƒ¹æ ¼åæ‡‰é©—è­‰**ï¼ˆçŸ­æœŸ 1-5 å¤©ã€ä¸­æœŸ 7-15 å¤©ã€é•·æœŸ 16-30 å¤©ï¼‰
  - çŸ­æœŸèª˜å¤šä½†ä¸­æœŸè·Ÿé€² â†’ å¯èƒ½æ˜¯çŸ­æœŸé¨™ç·šï¼Œä½†ä¸­é•·æœŸè¶¨å‹¢æˆç«‹
  - çŸ­æœŸèª˜ç©ºä½†ä¸­æœŸè·Ÿé€² â†’ å¯èƒ½æ˜¯çŸ­æœŸæ´—ç›¤ï¼Œä½†ä¸­é•·æœŸè¶¨å‹¢æˆç«‹
- â­ V8.9 æ–°å¢ï¼š**æ©Ÿæ§‹å¯ä¿¡åº¦è©•åˆ†**ï¼ˆinstitutional_ratings_credibilityï¼‰
  - ä¸åŒæ©Ÿæ§‹åœ¨ä¸åŒæ™‚é–“ç¶­åº¦çš„å¯ä¿¡åº¦ä¸åŒ
  - å¯ä¿¡åº¦é«˜çš„æ©Ÿæ§‹è©•ç´šæ‡‰çµ¦äºˆæ›´é«˜æ¬Šé‡
  - å¯ä¿¡åº¦ä½çš„æ©Ÿæ§‹è©•ç´šæ‡‰è¬¹æ…åƒè€ƒ
- â­â­â­ **å¸‚å ´æƒ…ç·’æŒ‡æ¨™æ‡‰æ•´åˆåˆ° market_regime å’Œ u_macro_recommendation çš„åˆ¤æ–·ä¸­**
- FPE_B åæ˜ å€‹è‚¡å±¤é¢çš„å¸‚å ´æƒ…ç·’
- ç•¶å¤šå€‹æŒ‡æ¨™æŒ‡å‘ç›¸åŒæ–¹å‘æ™‚ï¼ˆä¾‹å¦‚ï¼šVIX é«˜ã€Put/Call Ratio é«˜ï¼‰ï¼Œå¸‚å ´æƒ…ç·’ä¿¡è™Ÿæ›´å¼·

## è¼¸å‡ºæ ¼å¼ï¼ˆå¿…é ˆæ˜¯ JSONï¼‰

{
  "weekly_worldview": {
    "overall_status": "BULL/BEAR/TRANSITION",
    "key_themes": ["ä¸»é¡Œ1", "ä¸»é¡Œ2"],
    "market_regime": "BULL_STRONG/BULL_WEAK/RANGE/BEAR_WEAK/BEAR_STRONG/TRANSITION",
    "regime_confidence": 0.0-1.0,
    "macro_trends": {
      "commodities": "åˆ†æ",
      "currencies": "åˆ†æ",
      "bonds": "åˆ†æ",
      "indices": "åˆ†æ"
    }
  },
  "regime_transition": {
    "stay_probability": 0.0-1.0,
    "transition_to": "BULL_STRONG/BULL_WEAK/RANGE/BEAR_WEAK/BEAR_STRONG",
    "transition_probability": 0.0-1.0,
    "transition_reason": "è½‰æ›ç†ç”±"
  },
  "u_macro_recommendation": {
    "value": 0.0-1.0,
    "reason": "U èª¿æ•´ç†ç”±ï¼ˆåŸºæ–¼ Regimeã€Sector Rotationã€å¸‚å ´å¯¬åº¦ã€Mag 7 é›†é«”è¡¨ç¾ç­‰ï¼‰",
    "previous_value": 0.0-1.0,
    "mag7_influence": "Mag 7 é›†é«”è¡¨ç¾å° U èª¿æ•´çš„å½±éŸ¿èªªæ˜"
  },
  "risk_assessment": {
    "systemic_risk": "LOW/MEDIUM/HIGH/CRITICAL",
    "primary_risk": "ä¸»è¦é¢¨éšªæè¿°",
    "hedging_needed": true/false,
    "risk_factors": ["é¢¨éšªå› å­1", "é¢¨éšªå› å­2"]
  },
  "worldview_evolution": {
    "changes_from_last_week": "è®ŠåŒ–æè¿°",
    "changes_from_last_month": "è®ŠåŒ–æè¿°",
    "trend_direction": "UPWARD/DOWNWARD/STABLE"
  },
  "market_alignment": {
    "alignment_status": "ALIGNED/MISALIGNED/NEUTRAL",
    "alignment_analysis": "åˆ†ææè¿°",
    "divergence_factors": ["å› å­1", "å› å­2"]
  },
  "key_conclusions": [
    {
      "conclusion": "çµè«–æè¿°",
      "confidence": 0.0-1.0,
      "supporting_evidence": ["è­‰æ“š1", "è­‰æ“š2"]
    }
  ]
}
`;
}

// ==========================================
// å€‹è‚¡ç­–ç•¥åˆ†æ Promptï¼ˆBatch ç‰ˆæœ¬ï¼‰
// ==========================================

/**
 * æ§‹å»ºå€‹è‚¡ç­–ç•¥åˆ†æ Promptï¼ˆå·²åœ¨ 24_P5_WEEKLY_STOCK_STRATEGY.js ä¸­å¯¦ç¾ï¼‰
 * 
 * æ­¤å‡½æ•¸ä¿ç•™ä½œç‚ºå‚™ç”¨æˆ–æ“´å±•
 */
function buildStockStrategyPrompt(batch, context) {
  // é€™å€‹å‡½æ•¸å·²ç¶“åœ¨ 24_P5_WEEKLY_STOCK_STRATEGY.js çš„ buildStockStrategyBatchPrompt ä¸­å¯¦ç¾
  // é€™è£¡ä¿ç•™ä½œç‚ºå‚™ç”¨æˆ–æ“´å±•
  return buildStockStrategyBatchPrompt(batch, context);
}

// ==========================================
// æ•´åˆ Promptï¼ˆç”¨æ–¼æœ€çµ‚ AI åˆ†æï¼‰
// ==========================================

/**
 * æ§‹å»º P5 Weekly æ•´åˆ Promptï¼ˆç”¨æ–¼æœ€çµ‚ AI åˆ†æï¼‰
 * 
 * @param {Object} data - æ•¸æ“š
 * @param {Object} data.worldview - ä¸–ç•Œè§€åˆ†æçµæœ
 * @param {Object} data.events - äº‹ä»¶åˆ†æçµæœ
 * @param {Object} data.stockStrategies - å€‹è‚¡ç­–ç•¥çµæœ
 * @param {Object} data.allData - æ‰€æœ‰æ”¶é›†çš„æ•¸æ“š
 * @returns {string} prompt - AI Prompt
 */
function buildP5WeeklyIntegratedPrompt(data) {
  const {
    worldview = {},
    events = {},
    stockStrategies = {},
    allData = {},
    memoryPack = null  // â­ V8.13æ–°å¢ï¼šMemory Packï¼ˆæ­·å²å­¸ç¿’ç¶“é©—ï¼‰
  } = data;
  
  // â­ V8.13æ–°å¢ï¼šæ ¼å¼åŒ–Memory Packç‚ºPromptæ ¼å¼
  const memoryPackSection = memoryPack ? formatMemoryPackForPrompt(memoryPack) : "";
  
  return `
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å¸‚å ´åˆ†æå¸«ï¼Œè² è²¬é€²è¡Œ Nuclear Project çš„ P5 Weekly å¸‚å ´ç¶œè¿°ã€‚

## ä»»å‹™ç›®æ¨™

åŸºæ–¼ä»¥ä¸‹æ‰€æœ‰åˆ†æçµæœï¼Œé€²è¡Œå…¨é¢çš„å¸‚å ´åˆ†æä¸¦ç”Ÿæˆæœ€çµ‚ç­–ç•¥ï¼š
1. **å¸‚å ´ç¶œè¿°**ï¼šæ•´é«”å¸‚å ´ç‹€æ…‹ã€è¶¨å‹¢ã€é—œéµäº‹ä»¶
2. **å› æœéˆåˆ†æ**ï¼šè­˜åˆ¥å¸‚å ´è®Šå‹•çš„å› æœé—œä¿‚
3. **é¢¨éšªäº‹ä»¶è­˜åˆ¥**ï¼šè­˜åˆ¥æ½›åœ¨é¢¨éšªäº‹ä»¶
4. **è¡ç”Ÿå“ç­–ç•¥èª¿æ•´**ï¼šæ ¹æ“šå¸‚å ´ç‹€æ…‹èª¿æ•´è¡ç”Ÿå“ç­–ç•¥
5. **ä¿¡å¿µæ›´æ–°**ï¼šæ›´æ–°å°å¸‚å ´çš„ä¿¡å¿µå’Œé æœŸ
6. **U èª¿æ•´**ï¼šå»ºè­° Uï¼ˆåˆ©ç”¨ç‡ï¼‰èª¿æ•´
7. **è¡Œå‹•æ¸…å–®**ï¼šç”Ÿæˆå…·é«”çš„è¡Œå‹•å»ºè­°
8. **è§¸ç™¼æ±ºç­–**ï¼šæ±ºå®šæ˜¯å¦è§¸ç™¼å…¶ä»– Phase

## å®è§€ä¸–ç•Œè§€åˆ†æçµæœ

${JSON.stringify(worldview, null, 2)}

## äº‹ä»¶ç›£æ§èˆ‡åˆ†æçµæœ

${JSON.stringify(events, null, 2)}

## å¸‚å ´æƒ…ç·’æŒ‡æ¨™ï¼ˆâ­ V8.6 é‡è¦ï¼šåŒ…å«æ©Ÿæ§‹è¨€è¡Œä¸€è‡´æ€§åˆ†ææ•¸æ“šï¼‰

${JSON.stringify(allData.weekly_market_data?.market_sentiment_indicators || {}, null, 2)}

**é‡è¦**ï¼š
- â­â­â­ **æ©Ÿæ§‹è©•ç´šçš„ warningsï¼ˆèª˜å¤š/èª˜ç©ºï¼‰æ‡‰å„ªå…ˆè€ƒæ…®**ï¼Œå› ç‚ºå®ƒåæ˜ äº†ã€Œè¨€è¡Œä¸ä¸€è‡´ã€çš„ç•°å¸¸è¨Šè™Ÿ
- â­â­â­ **ç•¶å¤šå€‹æ¨™çš„å‡ºç¾ã€Œèª˜å¤šå‡ºè²¨ã€è­¦å‘Šæ™‚ï¼Œå»ºè­°é™ä½ U æˆ–è§¸ç™¼ P4 é‡æ–°è¨ˆç®—é…ç½®**
- â­â­â­ **ç•¶æ¨™çš„å‡ºç¾ã€Œèª˜ç©ºåƒè²¨ã€è­¦å‘Šä¸”å¸‚å ´æƒ…ç·’ç©©å®šæ™‚ï¼Œå¯èƒ½æ˜¯é€²å ´æ©Ÿæœƒï¼Œå»ºè­°è§¸ç™¼ P3 é‡æ–°åˆ†æ**

## å€‹è‚¡ç­–ç•¥åˆ†æçµæœï¼ˆ${Object.keys(stockStrategies).length} æª”è‚¡ç¥¨ï¼‰

${JSON.stringify(stockStrategies, null, 2)}

## âœ… Weekly Output Upgrade: Broker-Executable Order Plan (IBKR-ready) â­ V8.17.3 æ–°å¢

**âš ï¸ é‡è¦ï¼šæ¯æª”è‚¡ç¥¨çš„ç­–ç•¥çµæœå¿…é ˆåŒ…å« \`order_plan\` é™£åˆ—ï¼Œé€™æ˜¯å¯ç›´æ¥çµ¦åˆ¸å•†åŸ·è¡Œçš„æ›å–®ç­–ç•¥ä»£ç¢¼ã€‚**

### Order Plan è¼¸å‡ºè¦æ±‚

æ¯æª”è‚¡ç¥¨çš„ \`order_plan\` é™£åˆ—å¿…é ˆåŒ…å«æ‰€æœ‰æ›å–®æŒ‡ä»¤ï¼Œé€™äº›æŒ‡ä»¤å¿…é ˆæ˜¯ IBKRï¼ˆInteractive Brokersï¼‰æ”¯æ´çš„é€²éšæ›å–®é¡å‹ï¼Œå¯ä»¥ç›´æ¥æ‰¹æ¬¡ä¸‹å–®ã€‚

### è¨‚å–®é¡å‹é¸æ“‡è¦å‰‡ï¼ˆä¸è¦å¯«æ­»ï¼Œæ ¹æ“šçµæ§‹é¸æ“‡ï¼‰

**STOP_LIMITï¼ˆçªç ´è²·é€²ï¼‰**ï¼š
- âœ… **åªé©ç”¨æ–¼**ï¼šCat2/Cat3ï¼ˆå•Ÿå‹•æœŸ/ä¸»å‡æ®µï¼‰ä¸” risk_overlay_level ä¸æ˜¯ HIGH
- âœ… **æˆ–**ï¼šæœ¬é€±æœ‰æ˜ç¢ºå‚¬åŒ–åŠ‘ + æ˜ç¢ºå£“åŠ›ä½ + risk_overlay_level ä¸æ˜¯ HIGH
- âŒ **ç¦æ­¢ä½¿ç”¨**ï¼šå¦‚æœ P0.7 æ˜¯ Late æˆ– turning_point_risk æ˜¯ HIGHï¼ˆæœƒè®Šæˆå‡çªç ´è¿½é«˜ï¼‰
- âŒ **ç¦æ­¢ä½¿ç”¨**ï¼šå¦‚æœ p5_weekly_flags åŒ…å« DIVERGENCE_ALERT æˆ– LATE_CYCLE_RISK

### â­ å·¥ç¨‹å¸«ä¿®å¾©ï¼šç¡¬ç´„æŸï¼ˆHard Constraintsï¼‰å€å¡Š

**âš ï¸ é‡è¦ï¼šä»¥ä¸‹è¦å‰‡ä¸èƒ½è®“ AI è¨è«–ï¼Œé€™æ˜¯å‘½ä»¤ï¼ˆMUSTï¼‰**

1. **P0.7 LATE_CYCLE ç¡¬ç´„æŸ**ï¼š
   - IF \`p0_7_snapshot.time_position === "LATE"\` OR \`p0_7_snapshot.turning_point_risk === "HIGH"\`
   - THEN \`parameter_adjustment_vector.buy_aggressiveness\` MUST be < 0.5
   - THEN \`parameter_adjustment_vector.max_position_cap_override\` MUST be reduced by 30-50%
   - **é€™ä¸èƒ½è®“ AI è¨è«–ï¼Œé€™æ˜¯å‘½ä»¤**

2. **P2.5 vs P3 æ™‚é–“å·®å„ªå…ˆç´š**ï¼š
   - **åœ¨é€²å ´æ™‚æ©Ÿä¸Šï¼ŒP3 (ç•¶ä¸‹è¡Œç‚º) > P2.5 (éå»è¡Œç‚º)**
   - IF \`p2_5_data.smart_money_score\` is HIGH BUT \`p3_data.cat\` is Cat4-B/Cat5 (å‡ºè²¨/è¶¨å‹¢ç ´å£)
   - THEN **å¿…é ˆå¦æ±ºé€²å ´**ï¼ˆæ©Ÿæ§‹ä¸Šä¸€å­£è²·ï¼Œä¸ä»£è¡¨ä»–å€‘ç¾åœ¨é‚„åœ¨è²·ï¼‰
   - **å¿…é ˆåœ¨ \`reasoning\` ä¸­æ˜ç¢ºèªªæ˜ï¼šP3 ç•¶ä¸‹è¡Œç‚ºå„ªå…ˆæ–¼ P2.5 éå»è¡Œç‚º**

3. **æ›å–®ç­–ç•¥éåº¦æ“¬åˆä¿®æ­£**ï¼š
   - **ä¸è¦çµ¦å‡ºç²¾ç¢ºåƒ¹æ ¼ï¼ˆä¾‹å¦‚ï¼šBuy Limit @ 102.5ï¼‰**
   - **å¿…é ˆçµ¦å‡º Buy Zone (è²·å…¥å€é–“)**ï¼Œä¾‹å¦‚ï¼š\`buy_zone: { lower: 102.0, upper: 103.0 }\`
   - **ç¨‹å¼ç«¯æœƒè‡ªå‹•æ›åœ¨å€é–“ä¸Šç·£**ï¼ˆé¿å…è¸ç©ºï¼‰
   - **å¦‚æœ AI è¼¸å‡ºç²¾ç¢ºåƒ¹æ ¼ï¼Œç¨‹å¼æœƒè‡ªå‹•è½‰æ›ç‚ºå€é–“ï¼ˆÂ±0.5%ï¼‰**

**LIMITï¼ˆæ‹‰å›è²·é€²ï¼‰**ï¼š
- âœ… **é€šç”¨ã€æœ€å®‰å…¨**ï¼šé©ç”¨æ–¼ Cat3 å›è¸©ã€Cat4-Aã€Cat4-Bã€ä¸ç¢ºå®š Regime
- âœ… **å¤šæ•¸è‚¡ç¥¨éƒ½æ‡‰è©²ä»¥é€™å€‹ç‚ºä¸»**ï¼ˆå°¤å…¶ 100 æª”æ‰¹æ¬¡ï¼‰

**BRACKETï¼ˆå€é–“æ“ä½œï¼‰**ï¼š
- âœ… **é©ç”¨æ–¼**ï¼šæ³¢æ®µå€‰ã€å™´å‡ºå€‰
- âœ… **å°ã€Œä¸ç›¯ç›¤ã€å¾ˆé‡è¦**ï¼šè²·é€²å¾Œè‡ªå‹•åœæåœåˆ©
- âš ï¸ **æ ¸å¿ƒå€‰é™åˆ¶**ï¼šæ ¸å¿ƒå€‰ï¼ˆè‡³å°‘ 50%ï¼‰é€šå¸¸ä¸è¦ bracket çš„ take-profitï¼ˆé¿å…å¤ªæ—©è³£å…‰ï¼‰

**OCOï¼ˆäº’æ–¥è¨‚å–®ï¼‰**ï¼š
- âš ï¸ **é—œéµè¦æ±‚**ï¼šå¦‚æœåŒæ™‚æä¾› Breakout Buyï¼ˆSTOP_LIMITï¼‰èˆ‡ Pullback Buyï¼ˆLIMITï¼‰ï¼Œ**å¿…é ˆç”¨ OCO ç¶å®š**ï¼Œé¿å…å…©é‚Šéƒ½æˆäº¤é€ æˆè¶…å€‰

### è¨‚å–®ä¿é®®æœŸç®¡ç†ï¼ˆOrder Freshness / GTDï¼‰â­ V8.18 æ–°å¢

**âš ï¸ é‡è¦ï¼šä¸æ˜¯æ‰€æœ‰æ›å–®éƒ½èƒ½ GTCï¼Œåªæœ‰ã€Œç­‰å¾…å‹ã€å¯ä»¥ã€‚å‹•èƒ½å‹è¨‚å–®å¿…é ˆè¨­å®šæœ‰æ•ˆæœŸï¼Œé¿å…ã€ŒéæœŸç‰›å¥¶ã€å•é¡Œã€‚**

**æ ¸å¿ƒåŸå‰‡**ï¼š
- æŠ€è¡“åˆ†æä¸æ˜¯åªæœ‰åƒ¹æ ¼ï¼Œ**æ™‚é–“å°±æ˜¯å‹•èƒ½çš„å¦ä¸€å€‹ç¶­åº¦**
- ä¸€å€‹ã€Œç£¨äº† 4 å¤©æ‰çªç ´ã€çš„çªç ´ï¼Œ**å’Œç•¶å¤©çªç ´å®Œå…¨ä¸æ˜¯åŒä¸€ä»¶äº‹**
- éæœŸçš„æ›å–®å°±åƒéæœŸçš„ç‰›å¥¶ï¼Œå–äº†æœƒæ‹‰è‚šå­

**Time in Force è¦å‰‡ï¼ˆæ ¹æ“š Setup é¡å‹ï¼‰**ï¼š

| Setup é¡å‹                  | Order Type            | Time in Force                     | ç†ç”±                                 |
| ------------------------- | --------------------- | --------------------------------- | ------------------------------------ |
| Momentum / Breakout       | Buy Stop / Stop Limit | **DAY æˆ– GTD = +1~2 trading days** | å‹•èƒ½å–®å¿…é ˆå¿«é€Ÿï¼Œå¦‚æœé€±äºŒæ”¶ç›¤å‰æ²’æ”»éå»ï¼Œé€™ç­†å–®è‡ªå‹•ä½œå»¢ã€‚æˆ‘å€‘ä¸æƒ³è¦ã€Œæ‹–æ³¥å¸¶æ°´ã€çš„çªç ´ã€‚ |
| Pullback / Mean Reversion | Buy Limit             | **GTC æˆ– æœ¬é€±äº”**                     | æ¥åˆ€å¯ä»¥ç­‰ï¼Œä½†è¿½åƒ¹ä¸èƒ½ç­‰ã€‚æ‹‰å›è²·é€²æ˜¯ç­‰å¾…å‹ç­–ç•¥ï¼Œå¯ä»¥è¨­å®šè¼ƒé•·æœ‰æ•ˆæœŸã€‚ |
| Re-entry / Trap Play      | Buy Stop / Limit      | **DAY**                           | é‡æ–°å…¥å ´å–®å¿…é ˆå¿«é€Ÿï¼Œé¿å…éŒ¯éæœ€ä½³æ™‚æ©Ÿã€‚ |

**å…·é«”è¦å‰‡**ï¼š

1. **Momentum / Breakout è¨‚å–®ï¼ˆSTOP_LIMITï¼‰**ï¼š
   - âœ… **å¿…é ˆè¨­å®š**ï¼š\\\`time_in_force = "DAY"\\\` æˆ– \\\`time_in_force = "GTD"\\\`ï¼ˆåˆ°æœŸæ—¥ = æœ¬é€±äºŒæˆ–é€±ä¸‰æ”¶ç›¤ï¼‰
   - âœ… **ç†ç”±**ï¼šå¦‚æœé€±äºŒæ”¶ç›¤å‰æ²’æ”»éå»ï¼Œé€™ç­†å–®è‡ªå‹•ä½œå»¢ã€‚æˆ‘å€‘ä¸æƒ³è¦ã€Œæ‹–æ³¥å¸¶æ°´ã€çš„çªç ´ã€‚
   - âŒ **ç¦æ­¢ä½¿ç”¨ GTC**ï¼šå‹•èƒ½å‹è¨‚å–®ä¸èƒ½ç„¡é™æœŸæ›å–®

2. **Pullback / Mean Reversion è¨‚å–®ï¼ˆLIMITï¼‰**ï¼š
   - âœ… **å¯ä»¥è¨­å®š**ï¼š\\\`time_in_force = "GTC"\\\` æˆ– \\\`time_in_force = "GTD"\\\`ï¼ˆåˆ°æœŸæ—¥ = æœ¬é€±äº”ï¼‰
   - âœ… **ç†ç”±**ï¼šæ¥åˆ€å¯ä»¥ç­‰ï¼Œä½†è¿½åƒ¹ä¸èƒ½ç­‰ã€‚æ‹‰å›è²·é€²æ˜¯ç­‰å¾…å‹ç­–ç•¥ï¼Œå¯ä»¥è¨­å®šè¼ƒé•·æœ‰æ•ˆæœŸã€‚
   - âš ï¸ **å»ºè­°**ï¼šå¦‚æœæœ¬é€±äº”å‰æ²’è§¸ç™¼ï¼Œå¯ä»¥è€ƒæ…®ä¸‹é€±é‡æ–°è©•ä¼°

3. **Re-entry / Trap Play è¨‚å–®**ï¼š
   - âœ… **å¿…é ˆè¨­å®š**ï¼š\\\`time_in_force = "DAY"\\\`
   - âœ… **ç†ç”±**ï¼šé‡æ–°å…¥å ´å–®å¿…é ˆå¿«é€Ÿï¼Œé¿å…éŒ¯éæœ€ä½³æ™‚æ©Ÿã€‚

**è¼¸å‡ºè¦æ±‚**ï¼š
- åœ¨ \\\`order_plan\\\` çš„æ¯å€‹è¨‚å–®ä¸­ï¼Œå¿…é ˆæ˜ç¢ºè¨­å®š \\\`time_in_force\\\`
- å¿…é ˆåœ¨ \`strategy_script\` ä¸­èªªæ˜ç‚ºä»€éº¼é¸æ“‡é€™å€‹æœ‰æ•ˆæœŸï¼š
  - ä¾‹å¦‚ï¼šã€ŒBuy Stop Limit @ 110ï¼Œæœ‰æ•ˆæœŸè‡³æœ¬é€±äºŒæ”¶ç›¤ï¼ˆå‹•èƒ½å–®ï¼Œä¸æ‹–æ³¥å¸¶æ°´ï¼‰ã€
  - ä¾‹å¦‚ï¼šã€ŒBuy Limit @ 100ï¼Œæœ‰æ•ˆæœŸ GTCï¼ˆæ‹‰å›è²·é€²ï¼Œå¯ä»¥ç­‰å¾…ï¼‰ã€

### è²¡å ±å‰å¼·åˆ¶æ¸…å€‰ï¼ˆEarnings Ejectionï¼‰â­ V8.18 æ–°å¢

**âš ï¸ ç¡¬è¦å‰‡ï¼šé€±åº¦æ³¢æ®µ + ä¸è™•ç†è²¡å ±é¢¨éšª = åœ¨è³­å‘½**

**æ ¸å¿ƒåŸå‰‡**ï¼š
- è²¡å ±æ˜¯è³­åšã€‚å†å¥½çš„æŠ€è¡“é¢ï¼Œè²¡å ±ä¸€å¥è©±å°±èƒ½è·Œ 20%
- å¦‚æœæŒå€‰å‰›å¥½åœ¨æœ¬é€±å…¬ä½ˆè²¡å ±ï¼Œè€Œæˆ‘å€‘æ¡å–ã€Œå°„å¾Œä¸ç†ã€çš„æ›å–®æ¨¡å¼ï¼Œé€™æ˜¯åœ¨è³­é‹æ°£
- ä¸è¦è®“è¾›è‹¦è³ºä¾†çš„æ³¢æ®µåˆ©æ½¤ï¼Œæ¯€åœ¨ä¸€æ¬¡è²¡å ±ä¸Š

**ç¡¬è¦å‰‡ï¼ˆå¿…é ˆåš´æ ¼éµå®ˆï¼‰**ï¼š
- âœ… **æª¢æŸ¥æœªä¾† 7 å¤©å…§æ˜¯å¦æœ‰è²¡å ±å…¬ä½ˆ**ï¼ˆå¾ EARNINGS_CALENDAR æˆ– HOLDINGS_EARNINGS_CALENDAR è®€å–ï¼‰
- âœ… **å¦‚æœæœ‰è²¡å ±åœ¨æœªä¾† 7 å¤©å…§**ï¼š
  - âŒ **ç¦æ­¢é–‹æ–°å€‰**ï¼ˆé™¤éæ˜¯è³­è²¡å ±çš„ç‰¹æ®Šç­–ç•¥ï¼Œä½†é€šå¸¸ä¸å»ºè­°ï¼‰
  - âœ… **ç¾æœ‰æŒå€‰å¿…é ˆæ¸›å€‰**ï¼šæ¸›å€‰ 50% æˆ–è¨­å¯¬é¬†åœæï¼ˆæ ¹æ“š Cat é¡å‹æ±ºå®šï¼‰
  - âœ… **é˜²ç¦¦ç­–ç•¥é¸é …**ï¼š
    * **é¸é … 1**ï¼šæ¸›å€‰ 50%ï¼Œé–ä½ç²åˆ©
    * **é¸é … 2**ï¼šè¨­å¯¬é¬†åœæï¼ˆä¾‹å¦‚ï¼šå¾ -5% æ”¾å¯¬åˆ° -8% æˆ– -10%ï¼‰
    * **é¸é … 3**ï¼šå®Œå…¨æ¸…å€‰ï¼ˆè‹¥å·²æœ‰ç²åˆ©ä¸” Cat ä¸æ˜¯å¼·å‹¢çµæ§‹ï¼‰

**è¼¸å‡ºè¦æ±‚**ï¼š
- åœ¨æ¯æª”è‚¡ç¥¨çš„ \\\`strategy_script\\\` ä¸­ï¼Œå¦‚æœæœªä¾† 7 å¤©å…§æœ‰è²¡å ±ï¼Œå¿…é ˆæ˜ç¢ºèªªæ˜ï¼š
  - ä¾‹å¦‚ï¼šã€Œæœªä¾† 7 å¤©å…§æœ‰è²¡å ±ï¼ˆ2026-01-30ï¼‰ï¼Œç¦æ­¢é–‹æ–°å€‰ï¼Œç¾æœ‰æŒå€‰æ¸›å€‰ 50% é–ä½ç²åˆ©ã€
- åœ¨ \\\`order_plan\\\` ä¸­ï¼Œå¦‚æœæœªä¾† 7 å¤©å…§æœ‰è²¡å ±ï¼š
  - æ–°å€‰è¨‚å–®å¿…é ˆæ¨™è¨˜ç‚º \\\`earnings_ejection_applied: true\\\`ï¼Œä¸¦è¨­ç½® \\\`action: "CANCEL"\\\` æˆ– \\\`action: "REDUCE"\\\`
  - ç¾æœ‰æŒå€‰çš„è¨‚å–®å¿…é ˆèª¿æ•´ï¼ˆæ¸›å€‰æˆ–è¨­å¯¬é¬†åœæï¼‰

**ç‰¹æ®Šæƒ…æ³**ï¼š
- âš ï¸ **å¦‚æœ Cat = Cat3ï¼ˆä¸»å‡æ®µï¼‰ä¸”çµæ§‹éå¸¸å¼·å‹**ï¼šå¯ä»¥è€ƒæ…®åªæ¸›å€‰ 30%ï¼Œè€Œä¸æ˜¯ 50%
- âš ï¸ **å¦‚æœ Cat = Cat4-Bï¼ˆæ·±åº¦å›èª¿ï¼‰æˆ– Cat5ï¼ˆè¶¨å‹¢ç ´å£ï¼‰**ï¼šå»ºè­°å®Œå…¨æ¸…å€‰ï¼Œä¸è¦å†’éšª

### ICDZï¼ˆæ©Ÿæ§‹æˆæœ¬é˜²å®ˆå€ï¼‰ä½¿ç”¨è¦å‰‡ â­ V8.17.5 æ–°å¢

**âš ï¸ é‡è¦ï¼šICDZ æ˜¯åƒè€ƒéŒ¨é»ï¼Œä¸æ˜¯çµ•å°è¦å‰‡**

**ICDZ å®šç¾©**ï¼š
- ICDZï¼ˆInstitutional Cost Defense Zoneï¼‰æ˜¯ã€Œæ©Ÿæ§‹æˆæœ¬é˜²å®ˆå€ã€ï¼Œä»£è¡¨æ©Ÿæ§‹æœ€å¯èƒ½é˜²å®ˆçš„åƒ¹æ ¼å€é–“
- ç”± P3 åŸºæ–¼éå» 8-12 é€±çš„åƒ¹æ ¼å’Œæˆäº¤é‡çµæ§‹ä¼°ç®—å¾—å‡º
- æ˜¯ä¸€å€‹åƒ¹æ ¼å€é–“ï¼ˆ\`lower_bound\` å’Œ \`upper_bound\`ï¼‰ï¼Œä¸æ˜¯ç²¾ç¢ºåƒ¹æ ¼

**ICDZ ä½¿ç”¨æ¢ä»¶**ï¼š
- âœ… **å¿…é ˆæ»¿è¶³**ï¼š\`institutional_cost_defense_zone.applicable = true\`
- âœ… **å¿…é ˆæ»¿è¶³**ï¼š\`institutional_cost_defense_zone.confidence\` æ˜¯ HIGH æˆ– MEDIUM
- âŒ **ç¦æ­¢ä½¿ç”¨**ï¼šå¦‚æœ \`applicable = false\` æˆ– \`confidence = LOW\`

**ICDZ ä½¿ç”¨è¦å‰‡**ï¼š
1. **Pullback Buyï¼ˆLIMIT è¨‚å–®ï¼‰**ï¼š
   - âœ… **å„ªå…ˆè¨­ç½®åœ¨ ICDZ ä¸Šç·£**ï¼ˆ\`upper_bound\`ï¼‰ï¼Œå°¤å…¶æ˜¯ Cat3 å›è¸©ã€Cat4-Aã€Cat4-B ç­–ç•¥
   - âœ… **é€™ä»£è¡¨æ©Ÿæ§‹é¡˜æ„è­·ç›¤çš„åƒ¹ä½ï¼Œè²·åœ¨å°çš„åœ°æ–¹çš„æ©Ÿç‡æ›´é«˜**

2. **Breakout Buyï¼ˆSTOP_LIMIT è¨‚å–®ï¼‰**ï¼š
   - âš ï¸ **è¬¹æ…ä½¿ç”¨ ICDZ**ï¼šå¦‚æœçªç ´çµæ§‹å¼·å‹ä¸”å·²ç¢ºèªï¼Œå¯ä»¥å¿½ç•¥ ICDZ
   - âš ï¸ **é¿å…åœ¨ ICDZ ä¸Šæ–¹éé è¨­ç½®**ï¼šé™¤éçªç ´çµæ§‹éå¸¸å¼·å‹

3. **é¢¨éšªç®¡ç†**ï¼š
   - âœ… **å¦‚æœåƒ¹æ ¼è·Œç ´ ICDZ ä¸‹ç·£**ï¼ˆ\`lower_bound\`ï¼‰â†’ é€™æ˜¯ P5 escalation çš„åˆç†è§¸ç™¼æ¢ä»¶
   - âœ… **ICDZ å¤±æ•ˆä¿¡è™Ÿ**ï¼šå¦‚æœåƒ¹æ ¼è·Œç ´ ICDZ ä¸”æˆäº¤é‡æ”¾å¤§ï¼Œè¡¨ç¤ºæ©Ÿæ§‹æ”¾æ£„é˜²å®ˆï¼Œæ‡‰è€ƒæ…®æ¸›å€‰æˆ–æ­¢æ

4. **ICDZ èˆ‡å…¶ä»–å› ç´ çš„æ¬Šé‡**ï¼š
   - âš ï¸ **ICDZ æ˜¯åƒè€ƒéŒ¨é»ï¼Œä¸æ˜¯çµ•å°è¦å‰‡**
   - âœ… **åƒ¹æ ¼è¡Œç‚ºï¼ˆPrice Actionï¼‰å’Œé¢¨éšªè¦†è“‹å±¤ç´šï¼ˆrisk_overlay_levelï¼‰ä»ç„¶ä¸»å°æœ€çµ‚æ±ºç­–**
   - âœ… **ICDZ æ¬Šé‡å»ºè­°**ï¼š
     * å¦‚æœ \`confidence = HIGH\`ï¼šICDZ æ¬Šé‡ = 0.4ï¼ˆ40%ï¼‰
     * å¦‚æœ \`confidence = MEDIUM\`ï¼šICDZ æ¬Šé‡ = 0.2ï¼ˆ20%ï¼‰
     * å¦‚æœ \`confidence = LOW\` æˆ– \`applicable = false\`ï¼šICDZ æ¬Šé‡ = 0ï¼ˆä¸ä½¿ç”¨ï¼‰

5. **ICDZ èˆ‡ Cat é¡å‹çš„é—œä¿‚**ï¼š
   - âœ… **å¼·çƒˆå»ºè­°ä½¿ç”¨ ICDZ**ï¼šCat Aï¼ˆæ©Ÿæ§‹å¸ç±ŒæœŸï¼‰ã€Cat Bï¼ˆå¥åº·å›æª”ï¼‰ã€Cat Cï¼ˆé‡æ–°å®šéŒ¨å¾Œçš„äºŒæ¬¡èµ·æ¼²ï¼‰
   - âš ï¸ **è¬¹æ…ä½¿ç”¨ ICDZ**ï¼šCat 5ï¼ˆé«˜æ³¢å‹•ä¿®å¾©æœŸï¼‰ã€Cat 6ï¼ˆé•·æœŸç›¤æ•´/ä½æµå‹•æ€§ï¼‰
   - âŒ **ç¦æ­¢ä½¿ç”¨ ICDZ**ï¼šCat 1ï¼ˆæ‹‹ç‰©ç·šå™´å‡ºï¼‰ã€Cat 2ï¼ˆäº‹ä»¶å‹è·³ç©ºï¼‰ã€Cat 3ï¼ˆé«˜ IV/é¸æ“‡æ¬Šä¸»å°ï¼‰ã€Cat 4ï¼ˆçµæ§‹æ€§å‡ºè²¨æœŸï¼‰

**è¼¸å‡ºè¦æ±‚**ï¼š
- åœ¨ \`order_plan\` çš„æ¯å€‹è¨‚å–®ä¸­ï¼Œå¦‚æœä½¿ç”¨äº† ICDZï¼Œå¿…é ˆåœ¨ \`strategy_script\` ä¸­èªªæ˜ï¼š
  - ä¾‹å¦‚ï¼šã€ŒBuy Limit @ 110ï¼ˆICDZ ä¸Šç·£ï¼‰ï¼Œæ©Ÿæ§‹æˆæœ¬é˜²å®ˆå€ 105-110ï¼Œä¿¡å¿ƒåº¦ HIGHã€

### æ›å–®æ»‘åƒ¹å„ªåŒ–ï¼ˆAdaptive Algoï¼‰â­ V8.18 æ–°å¢

**âš ï¸ é‡è¦ï¼šé€™æ˜¯åŸ·è¡Œå„ªåŒ–å±¤ï¼Œä¸æ˜¯ç­–ç•¥é‚è¼¯å±¤**

**æ ¸å¿ƒåŸå‰‡**ï¼š
- Algo order è§£æ±ºçš„æ˜¯ï¼šæµå‹•æ€§ã€æ»‘åƒ¹ã€å¿«å¸‚è¸ç©º
- ä½†**ä¸æ”¹è®Šä½ å°ã€Œæ˜¯å¦è©²è²·ã€çš„åˆ¤æ–·**
- é€™æ˜¯ã€ŒåŸ·è¡Œæç¤ºã€ï¼Œä¸æ˜¯ã€Œå¿…é ˆæ¡ç”¨ã€

**Execution Preference é¸é …**ï¼š
- **ADAPTIVE**ï¼šé©æ‡‰æ€§æ¼”ç®—æ³•ï¼Œåœ¨å¿«å¸‚ä¸­è‡ªå‹•èª¿æ•´é™åƒ¹ç¯„åœ
- **SNAP_PRIMARY**ï¼šå¿«å¸‚æ™‚å„ªå…ˆä½¿ç”¨ä¸»å¸‚å ´åƒ¹æ ¼
- **LIMIT_ONLY**ï¼šåªä½¿ç”¨é™åƒ¹å–®ï¼Œä¸æ¡ç”¨æ¼”ç®—æ³•ï¼ˆæœ€ä¿å®ˆï¼‰

**ä½¿ç”¨å ´æ™¯**ï¼š
- **ADAPTIVE**ï¼šé©ç”¨æ–¼çªç ´å–®ï¼ˆSTOP_LIMITï¼‰ï¼Œç•¶å¸‚å ´å¿«é€Ÿç§»å‹•æ™‚ï¼Œè‡ªå‹•æ”¾å¯¬é™åƒ¹ç¯„åœï¼ˆä¾‹å¦‚ï¼šè§¸ç™¼åƒ¹ 110ï¼Œé™åƒ¹ 112ï¼‰
- **SNAP_PRIMARY**ï¼šé©ç”¨æ–¼å¿«å¸‚ä¸­çš„çªç ´å–®ï¼Œç¢ºä¿åœ¨æµå‹•æ€§å……è¶³æ™‚å„ªå…ˆæˆäº¤
- **LIMIT_ONLY**ï¼šé©ç”¨æ–¼æ‹‰å›è²·é€²ï¼ˆLIMITï¼‰ï¼Œä¸éœ€è¦æ¼”ç®—æ³•å„ªåŒ–

**è¼¸å‡ºè¦æ±‚**ï¼š
- åœ¨ \`order_plan\` çš„æ¯å€‹è¨‚å–®ä¸­ï¼Œå¯ä»¥æ·»åŠ  \`execution_preference\` æ¬„ä½ï¼š
  - ä¾‹å¦‚ï¼š\`"execution_preference": "ADAPTIVE"\`ï¼ˆçªç ´å–®ï¼‰
  - ä¾‹å¦‚ï¼š\`"execution_preference": "LIMIT_ONLY"\`ï¼ˆæ‹‰å›è²·é€²ï¼‰
- å¦‚æœæ²’æœ‰æŒ‡å®šï¼Œé è¨­ç‚º \`"LIMIT_ONLY"\`ï¼ˆæœ€ä¿å®ˆï¼‰

### æ‹‹ç‰©ç·šæ¸…å€‰ï¼ˆSelling into Strength / Parabolic Exhaustionï¼‰â­ V8.18 æ–°å¢

**âš ï¸ é«˜éšæ­¦å™¨ï¼Œå¿…é ˆåš´æ ¼é™åˆ¶ä½¿ç”¨æ¢ä»¶**

**æ ¸å¿ƒåŸå‰‡**ï¼š
- æ©Ÿæ§‹è¦åœ¨é«˜é»å‡ºè²¨ï¼Œéœ€è¦å¤§é‡çš„æµå‹•æ€§ï¼ˆæ•£æˆ¶çš„è²·ç›¤ï¼‰
- è‚¡åƒ¹æœ€é«˜é»é€šå¸¸ä¼´éš¨è‘—ã€Œæƒ…ç·’æ¥µåº¦äº¢å¥® + å‚ç›´å™´å‡ºï¼ˆParabolic Runï¼‰ã€
- å¦‚æœä½ ç­‰å®ƒè·Œç ´å‡ç·šæ‰è³£ï¼Œå¾€å¾€å·²ç¶“å›åäº† 20% åˆ©æ½¤
- é€™æ˜¯ã€Œä¸»å‹•æ”¶å‰²ã€ï¼Œä¸æ˜¯æ—¥å¸¸æ¨¡å¼

**è§¸ç™¼æ¢ä»¶ï¼ˆå¿…é ˆå…¨éƒ¨æˆç«‹ï¼‰**ï¼š
1. **Cat = Momentum / Late-stage**ï¼ˆä¸»å‡æ®µæˆ–æ™šæœŸéšæ®µï¼‰
2. **Price vs MA20 deviation > historical 95th percentile**ï¼ˆåƒ¹æ ¼åé›¢ MA20 è¶…éæ­·å² 95% åˆ†ä½æ•¸ï¼‰
3. **Volume spike + wide range candle**ï¼ˆæˆäº¤é‡æš´å¢ + å¯¬å¹… K ç·šï¼‰
4. **å¸‚å ´æƒ…ç·’æŒ‡æ¨™åæ¥µç«¯**ï¼ˆå¯ç”¨ proxyï¼Œä¾‹å¦‚ï¼šRSI > 80ã€MACD æ¥µåº¦èƒŒé›¢ç­‰ï¼‰

**è¡Œå‹•ï¼ˆéå…¨å‡ºï¼‰**ï¼š
- âœ… **Sell 30-50% into strength**ï¼ˆåœ¨å¼·å‹¢ä¸Šæ¼²æ™‚è³£å‡º 30-50%ï¼‰
- âœ… **å‰©é¤˜éƒ¨ä½äº¤çµ¦ trailing stop**ï¼ˆä¸è¦å…¨éƒ¨è³£å…‰ï¼Œä¿ç•™éƒ¨åˆ†éƒ¨ä½ç”¨ç§»å‹•åœåˆ©ï¼‰

**è¼¸å‡ºè¦æ±‚**ï¼š
- åœ¨æ¯æª”è‚¡ç¥¨çš„ \`order_plan\` ä¸­ï¼Œå¦‚æœè§¸ç™¼æ‹‹ç‰©ç·šæ¸…å€‰ï¼Œå¿…é ˆæ·»åŠ ï¼š
  - \`"exit_scenario": "PARABOLIC_EXHAUSTION"\`
  - \`"sell_percent": 0.30-0.50\`ï¼ˆè³£å‡ºæ¯”ä¾‹ï¼‰
  - \`"sell_reason": "Price vs MA20 deviation > 95th percentile, volume spike, parabolic run detected"\`
- åœ¨ \`strategy_script\` ä¸­å¿…é ˆæ˜ç¢ºèªªæ˜ï¼š
  - ä¾‹å¦‚ï¼šã€Œæª¢æ¸¬åˆ°æ‹‹ç‰©ç·šå™´å‡ºï¼ˆPrice vs MA20 åé›¢ +30%ï¼Œæˆäº¤é‡æš´å¢ï¼‰ï¼Œå»ºè­°è³£å‡º 40% é–ä½ç²åˆ©ï¼Œå‰©é¤˜éƒ¨ä½ç”¨ç§»å‹•åœåˆ©ã€

**ç‰¹æ®Šæƒ…æ³**ï¼š
- âš ï¸ **å¦‚æœçµæ§‹å°šæœªæˆç†Ÿï¼ˆEarly / Mid Cycleï¼‰**ï¼šä¸æ‡‰ä½¿ç”¨æ‹‹ç‰©ç·šæ¸…å€‰
- âš ï¸ **å¦‚æœå°šæœªå‡ºç¾æƒ…ç·’æ¥µç«¯åŒ–**ï¼šä¸æ‡‰ä½¿ç”¨æ‹‹ç‰©ç·šæ¸…å€‰
- âš ï¸ **å¦å‰‡ä½ æœƒæŠŠ NVDA åœ¨ 400ã€500 å°±è³£å…‰**ï¼ˆé€™æ˜¯éŒ¯èª¤çš„ï¼‰

## æ‰€æœ‰å¿«ç…§æ•¸æ“š

P0 å¿«ç…§ï¼ˆç”¢æ¥­å·¥ç¨‹å­¸ï¼‰ï¼š${allData.p0_snapshot ? "æœ‰æ•¸æ“š" : "ç„¡"}
P0.7 å¿«ç…§ï¼ˆç³»çµ±å‹•åŠ›å­¸ï¼‰ï¼š${allData.p0_7_snapshot ? "æœ‰æ•¸æ“š" : "ç„¡"}
P1 å¿«ç…§ï¼ˆå…¬å¸æ± ï¼‰ï¼š${allData.p1_snapshot ? "æœ‰æ•¸æ“š" : "ç„¡"}
P2 å¿«ç…§ï¼ˆåŸºæœ¬é¢ï¼‰ï¼š${allData.p2_snapshot ? "æœ‰æ•¸æ“š" : "ç„¡"}
P3 å¿«ç…§ï¼ˆæŠ€è¡“é¢ï¼‰ï¼š${allData.p3_snapshot ? "æœ‰æ•¸æ“š" : "ç„¡"}
P4 å¿«ç…§ï¼ˆè³‡é‡‘é…ç½®ï¼‰ï¼š${allData.p4_snapshot ? "æœ‰æ•¸æ“š" : "ç„¡"}
å‰ä¸€æ¬¡ P5 Weekly å¿«ç…§ï¼š${allData.previous_p5_weekly_snapshot ? "æœ‰æ•¸æ“š" : "ç„¡"}

${memoryPackSection}

## è¼¸å‡ºæ ¼å¼ï¼ˆå¿…é ˆæ˜¯ JSONï¼‰

{
  "market_analysis": {
    "overall_status": "BULL/BEAR/TRANSITION",
    "key_events": [],
    "trend_analysis": {},
    "market_regime": "BULL_STRONG/BULL_WEAK/BEAR_STRONG/BEAR_WEAK/TRANSITION"
  },
  "causality_chain": {
    "chains": [
      {
        "cause": "äº‹ä»¶/æ•¸æ“š",
        "effect": "å½±éŸ¿",
        "confidence": 0.0-1.0
      }
    ]
  },
  "risk_events": [
    {
      "event": "é¢¨éšªäº‹ä»¶æè¿°",
      "severity": "LOW/MEDIUM/HIGH/CRITICAL",
      "probability": 0.0-1.0,
      "impact": "å½±éŸ¿æè¿°"
    }
  ],
  "derivatives_strategy_adjustment": {
    "recommendations": [],
    "hedging_ratio": 0.0-1.0,
    "options_strategy": {}
  },
  "belief_update": {
    "updated_beliefs": [],
    "confidence_changes": {},
    "worldview_integration": "ä¸–ç•Œè§€æ•´åˆåˆ†æ"
  },
  "u_adjustment": {
    "recommended_u": 0.0-1.0,
    "reason": "èª¿æ•´ç†ç”±ï¼ˆâ­ V8.6 é‡è¦ï¼šå¿…é ˆåƒè€ƒæ©Ÿæ§‹è©•ç´šçš„ warnings å’Œ sentiment_labelã€‚å¦‚æœå¤šå€‹æ¨™çš„å‡ºç¾ã€Œèª˜å¤šå‡ºè²¨ã€è­¦å‘Šï¼Œå»ºè­°é™ä½ Uï¼›å¦‚æœå‡ºç¾ã€Œèª˜ç©ºåƒè²¨ã€è­¦å‘Šä¸”å¸‚å ´æƒ…ç·’ç©©å®šï¼Œå¯è€ƒæ…®ç¶­æŒæˆ–ç•¥æé«˜ Uï¼‰",
    "trigger_condition": "è§¸ç™¼æ¢ä»¶ï¼ˆä¾‹å¦‚ï¼šæ©Ÿæ§‹è©•ç´šé¡¯ç¤ºèª˜å¤šå‡ºè²¨è¨Šè™Ÿã€å¸‚å ´ Regime è½‰æ›ç­‰ï¼‰",
    "institutional_sentiment_influence": "æ©Ÿæ§‹è©•ç´šå°æœ¬æ¬¡ U èª¿æ•´çš„å½±éŸ¿èªªæ˜ï¼ˆå¦‚æœæœ‰ï¼‰"
  },
  "action_list": [
    {
      "action": "è¡Œå‹•æè¿°",
      "priority": "HIGH/MEDIUM/LOW",
      "target": "ç›®æ¨™æ¨™çš„/Phase",
      "institutional_sentiment_reference": "æ˜¯å¦åƒè€ƒäº†æ©Ÿæ§‹è©•ç´šæ•¸æ“šï¼ˆå¯é¸ï¼‰"
    }
  ],
  "trigger_decisions": [
    {
      "trigger_phase": "P3/P4/P4.6",
      "reason": "è§¸ç™¼ç†ç”±ï¼ˆâ­ V8.6/V8.9 é‡è¦ï¼šå¦‚æœæ©Ÿæ§‹è©•ç´šé¡¯ç¤ºã€Œèª˜å¤šå‡ºè²¨ã€è­¦å‘Šï¼Œå»ºè­°è§¸ç™¼ P3 é‡æ–°åˆ†æè©²æ¨™çš„ï¼›å¦‚æœå¤šå€‹æ¨™çš„å‡ºç¾èª˜å¤šè­¦å‘Šï¼Œå»ºè­°è§¸ç™¼ P4 é‡æ–°è¨ˆç®—é…ç½®æˆ– P4.6 ç·Šæ€¥æ’¤é€€ã€‚åƒè€ƒæ©Ÿæ§‹å¯ä¿¡åº¦è©•åˆ†ï¼Œå¯ä¿¡åº¦é«˜çš„æ©Ÿæ§‹è©•ç´šè­¦å‘Šæ‡‰çµ¦äºˆæ›´é«˜å„ªå…ˆç´šï¼‰",
      "parameters": {
        "tickers": ["æ¨™çš„ä»£ç¢¼ï¼ˆå¦‚æœæœ‰ï¼‰"],
        "institutional_sentiment_triggers": "æ©Ÿæ§‹è©•ç´šè§¸ç™¼èªªæ˜ï¼ˆä¾‹å¦‚ï¼š'AAPL å‡ºç¾èª˜å¤šå‡ºè²¨è­¦å‘Šï¼Œå»ºè­° P3 é‡æ–°åˆ†æ'ï¼‰",
        "institutional_credibility_reference": "åƒè€ƒçš„æ©Ÿæ§‹å¯ä¿¡åº¦è©•åˆ†ï¼ˆä¾‹å¦‚ï¼š'Goldman Sachs çŸ­æœŸå¯ä¿¡åº¦ 0.6ï¼Œä¸­æœŸå¯ä¿¡åº¦ 0.8ï¼Œæœ¬è©•ç´šå¯ä¿¡åº¦è¼ƒé«˜'ï¼‰"
      }
    }
  ],
  "stock_strategies_summary": {
    "total_stocks": ${Object.keys(stockStrategies).length},
    "increase_count": 0,
    "decrease_count": 0,
    "hold_count": 0,
    "exit_count": 0,
    "key_recommendations": []
  }
}
`;
}

/**
 * æ ¼å¼åŒ–Memory Packç‚ºPromptæ ¼å¼ â­ V8.13æ–°å¢
 * 
 * å°‡Memory Packï¼ˆä¸‰å±¤è¨˜æ†¶ï¼‰æ ¼å¼åŒ–ç‚ºå¯è®€çš„promptæ ¼å¼ï¼Œä¾›AIåƒè€ƒ
 * 
 * @param {Object} memoryPack - Memory Pack
 * @returns {string} formattedMemoryPack - æ ¼å¼åŒ–å¾Œçš„Memory Packï¼ˆç”¨æ–¼promptï¼‰
 */
function formatMemoryPackForPrompt(memoryPack) {
  if (!memoryPack) {
    return "";
  }
  
  let formatted = "\n## ğŸ“š æ­·å²å­¸ç¿’ç¶“é©—ï¼ˆMemory Packï¼‰\n\n";
  formatted += "**é‡è¦**ï¼šé€™äº›æ­·å²ç¶“é©—åƒ…ä¾›åƒè€ƒï¼ŒAIéœ€è¦æ ¹æ“šç•¶å‰æƒ…æ³åˆ¤æ–·å¦‚ä½•æ‡‰ç”¨ã€‚ä¸å¾—ç›´æ¥è¤‡è£½æ­·å²ç­–ç•¥ï¼Œå¿…é ˆæ ¹æ“šç•¶å‰å¸‚å ´ç‹€æ…‹èª¿æ•´ã€‚\n\n";
  
  // Layer 1: Principlesï¼ˆé•·æœŸåŸå‰‡ï¼‰
  formatted += "### Layer 1: é•·æœŸåŸå‰‡ï¼ˆPrinciplesï¼‰\n\n";
  if (memoryPack.layer_1_principles) {
    formatted += memoryPack.layer_1_principles + "\n\n";
  } else {
    formatted += "ç„¡ï¼ˆå°šæœªå»ºç«‹é•·æœŸåŸå‰‡ï¼‰\n\n";
  }
  
  // Layer 2: Short-term Memoryï¼ˆæœ€è¿‘4é€±ï¼‰
  formatted += "### Layer 2: çŸ­æœŸè¨˜æ†¶ï¼ˆæœ€è¿‘4é€±ï¼‰\n\n";
  if (memoryPack.layer_2_short_term && memoryPack.layer_2_short_term.length > 0) {
    for (const week of memoryPack.layer_2_short_term) {
      formatted += `**${week.period_id || 'æœªçŸ¥é€±æœŸ'}**ï¼š\n`;
      formatted += `- æ‘˜è¦ï¼š${week.executive_summary || 'ç„¡'}\n`;
      if (week.scorecard) {
        const accuracy = week.scorecard.accuracy !== undefined ? week.scorecard.accuracy : week.scorecard.directional_accuracy?.accuracy;
        const maxDrawdown = week.scorecard.max_drawdown || week.scorecard.max_drawdown_pct || 0;
        formatted += `- Scorecardï¼šæº–åº¦${((accuracy || 0) * 100).toFixed(1)}%ï¼ŒMDD ${maxDrawdown.toFixed(1)}%\n`;
      }
      if (week.top_lessons && week.top_lessons.length > 0) {
        formatted += `- æ•™è¨“ï¼š${week.top_lessons.join('; ')}\n`;
      }
      formatted += "\n";
    }
  } else {
    formatted += "ç„¡ï¼ˆå°šæœªæœ‰è¶³å¤ çš„æ­·å²æ•¸æ“šï¼‰\n\n";
  }
  
  // Layer 3: Contextual Recallï¼ˆç›¸ä¼¼æ­·å²æ¡ˆä¾‹ï¼‰
  formatted += "### Layer 3: ç›¸ä¼¼æ­·å²æ¡ˆä¾‹ï¼ˆContextual Recallï¼‰\n\n";
  if (memoryPack.layer_3_contextual_recall && memoryPack.layer_3_contextual_recall.length > 0) {
    for (const case_ of memoryPack.layer_3_contextual_recall) {
      formatted += `**æ¡ˆä¾‹ ${case_.snapshot_id || 'æœªçŸ¥'}**ï¼ˆæ¨™ç±¤ï¼š${(case_.tags || []).join(', ') || 'ç„¡'}ï¼‰ï¼š\n`;
      if (case_.executive_summary) {
        formatted += `- æ‘˜è¦ï¼š${case_.executive_summary}\n`;
      }
      if (case_.lesson && case_.lesson.length > 0) {
        formatted += `- æ•™è¨“ï¼š${Array.isArray(case_.lesson) ? case_.lesson.join('; ') : case_.lesson}\n`;
      }
      if (case_.result_summary) {
        formatted += `- çµæœï¼š${case_.result_summary}\n`;
      }
      if (case_.evidence_ids && case_.evidence_ids.length > 0) {
        formatted += `- è­‰æ“šIDï¼š${case_.evidence_ids.join(', ')}\n`;
      }
      formatted += "\n";
    }
  } else {
    formatted += "ç„¡ï¼ˆå°šæœªæ‰¾åˆ°ç›¸ä¼¼æ­·å²æ¡ˆä¾‹ï¼‰\n\n";
  }
  
  // ä½¿ç”¨æé†’
  formatted += "**ä½¿ç”¨æé†’**ï¼š\n";
  formatted += "- å¦‚æœæ­·å²æ¡ˆä¾‹é¡¯ç¤ºé«˜é¢¨éšªï¼ˆMDD>5%ï¼‰ï¼Œéœ€è¦æé«˜é¢¨éšªæ§åˆ¶\n";
  formatted += "- å¦‚æœæ­·å²æ¡ˆä¾‹é¡¯ç¤ºæˆåŠŸç¶“é©—ï¼Œå¯ä»¥åƒè€ƒä½†ä¸å¯ç›²ç›®è¤‡è£½\n";
  formatted += "- Principlesæ˜¯æ†²æ³•ç´šåŸå‰‡ï¼Œå¿…é ˆéµå®ˆï¼Œä½†å¯ä»¥æ ¹æ“šç•¶å‰æƒ…æ³éˆæ´»æ‡‰ç”¨\n\n";
  
  return formatted;
}

// ==========================================
// èˆŠç‰ˆ Promptï¼ˆå‘å¾Œå…¼å®¹ï¼‰
// ==========================================

/**
 * æ§‹å»º P5 Weekly AI Promptï¼ˆèˆŠç‰ˆï¼Œå‘å¾Œå…¼å®¹ï¼‰
 * 
 * @param {Object} weeklyData - æœ¬é€±å¸‚å ´æ•¸æ“š
 * @param {Object} p2Snapshot - P2 å¿«ç…§
 * @param {Object} p3Snapshot - P3 å¿«ç…§
 * @param {Object} p4Snapshot - P4 å¿«ç…§
 * @param {Object} previousP5WeeklySnapshot - ä¸Šä¸€é€± P5 Weekly å¿«ç…§
 * @returns {string} prompt - AI Prompt
 */
function buildP5WeeklyPrompt(weeklyData, p2Snapshot, p3Snapshot, p4Snapshot, previousP5WeeklySnapshot) {
  return `
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å¸‚å ´åˆ†æå¸«ï¼Œè² è²¬é€²è¡Œ Nuclear Project çš„ P5 Weekly å¸‚å ´ç¶œè¿°ã€‚

## ä»»å‹™ç›®æ¨™

åŸºæ–¼æœ¬é€±å¸‚å ´æ•¸æ“šå’Œ P2/P3/P4 å¿«ç…§ï¼Œé€²è¡Œå…¨é¢çš„å¸‚å ´åˆ†æï¼š
1. **å¸‚å ´ç¶œè¿°**ï¼šæ•´é«”å¸‚å ´ç‹€æ…‹ã€è¶¨å‹¢ã€é—œéµäº‹ä»¶
2. **å› æœéˆåˆ†æ**ï¼šè­˜åˆ¥å¸‚å ´è®Šå‹•çš„å› æœé—œä¿‚
3. **é¢¨éšªäº‹ä»¶è­˜åˆ¥**ï¼šè­˜åˆ¥æ½›åœ¨é¢¨éšªäº‹ä»¶
4. **è¡ç”Ÿå“ç­–ç•¥èª¿æ•´**ï¼šæ ¹æ“šå¸‚å ´ç‹€æ…‹èª¿æ•´è¡ç”Ÿå“ç­–ç•¥
5. **ä¿¡å¿µæ›´æ–°**ï¼šæ›´æ–°å°å¸‚å ´çš„ä¿¡å¿µå’Œé æœŸ
6. **U èª¿æ•´**ï¼šå»ºè­° Uï¼ˆåˆ©ç”¨ç‡ï¼‰èª¿æ•´
7. **è¡Œå‹•æ¸…å–®**ï¼šç”Ÿæˆå…·é«”çš„è¡Œå‹•å»ºè­°
8. **è§¸ç™¼æ±ºç­–**ï¼šæ±ºå®šæ˜¯å¦è§¸ç™¼å…¶ä»– Phase

## æœ¬é€±å¸‚å ´æ•¸æ“š

${JSON.stringify(weeklyData, null, 2)}

## P2/P3/P4 å¿«ç…§

P2 å¿«ç…§ï¼š${p2Snapshot ? JSON.stringify(p2Snapshot, null, 2) : "ç„¡"}
P3 å¿«ç…§ï¼š${p3Snapshot ? JSON.stringify(p3Snapshot, null, 2) : "ç„¡"}
P4 å¿«ç…§ï¼š${p4Snapshot ? JSON.stringify(p4Snapshot, null, 2) : "ç„¡"}

## ä¸Šä¸€é€± P5 Weekly å¿«ç…§

${previousP5WeeklySnapshot ? JSON.stringify(previousP5WeeklySnapshot, null, 2) : "ç„¡ï¼ˆé¦–æ¬¡åŸ·è¡Œï¼‰"}

## è¼¸å‡ºæ ¼å¼ï¼ˆå¿…é ˆæ˜¯ JSONï¼‰

{
  "market_analysis": {
    "overall_status": "BULL/BEAR/TRANSITION",
    "key_events": [],
    "trend_analysis": {},
    "market_regime": "BULL_STRONG/BULL_WEAK/BEAR_STRONG/BEAR_WEAK/TRANSITION"
  },
  "causality_chain": {
    "chains": [
      {
        "cause": "äº‹ä»¶/æ•¸æ“š",
        "effect": "å½±éŸ¿",
        "confidence": 0.0-1.0
      }
    ]
  },
  "risk_events": [
    {
      "event": "é¢¨éšªäº‹ä»¶æè¿°",
      "severity": "LOW/MEDIUM/HIGH/CRITICAL",
      "probability": 0.0-1.0,
      "impact": "å½±éŸ¿æè¿°"
    }
  ],
  "derivatives_strategy_adjustment": {
    "recommendations": [],
    "hedging_ratio": 0.0-1.0,
    "options_strategy": {}
  },
  "belief_update": {
    "updated_beliefs": [],
    "confidence_changes": {}
  },
  "u_adjustment": {
    "recommended_u": 0.0-1.0,
    "reason": "èª¿æ•´ç†ç”±ï¼ˆâ­ V8.6 é‡è¦ï¼šå¿…é ˆåƒè€ƒæ©Ÿæ§‹è©•ç´šçš„ warnings å’Œ sentiment_labelã€‚å¦‚æœå¤šå€‹æ¨™çš„å‡ºç¾ã€Œèª˜å¤šå‡ºè²¨ã€è­¦å‘Šï¼Œå»ºè­°é™ä½ Uï¼›å¦‚æœå‡ºç¾ã€Œèª˜ç©ºåƒè²¨ã€è­¦å‘Šä¸”å¸‚å ´æƒ…ç·’ç©©å®šï¼Œå¯è€ƒæ…®ç¶­æŒæˆ–ç•¥æé«˜ Uï¼‰",
    "trigger_condition": "è§¸ç™¼æ¢ä»¶ï¼ˆä¾‹å¦‚ï¼šæ©Ÿæ§‹è©•ç´šé¡¯ç¤ºèª˜å¤šå‡ºè²¨è¨Šè™Ÿã€å¸‚å ´ Regime è½‰æ›ç­‰ï¼‰",
    "institutional_sentiment_influence": "æ©Ÿæ§‹è©•ç´šå°æœ¬æ¬¡ U èª¿æ•´çš„å½±éŸ¿èªªæ˜ï¼ˆå¦‚æœæœ‰ï¼‰"
  },
  "action_list": [
    {
      "action": "è¡Œå‹•æè¿°",
      "priority": "HIGH/MEDIUM/LOW",
      "target": "ç›®æ¨™æ¨™çš„/Phase",
      "institutional_sentiment_reference": "æ˜¯å¦åƒè€ƒäº†æ©Ÿæ§‹è©•ç´šæ•¸æ“šï¼ˆå¯é¸ï¼‰"
    }
  ],
  "trigger_decisions": [
    {
      "trigger_phase": "P3/P4/P4.6",
      "reason": "è§¸ç™¼ç†ç”±ï¼ˆâ­ V8.6/V8.9 é‡è¦ï¼šå¦‚æœæ©Ÿæ§‹è©•ç´šé¡¯ç¤ºã€Œèª˜å¤šå‡ºè²¨ã€è­¦å‘Šï¼Œå»ºè­°è§¸ç™¼ P3 é‡æ–°åˆ†æè©²æ¨™çš„ï¼›å¦‚æœå¤šå€‹æ¨™çš„å‡ºç¾èª˜å¤šè­¦å‘Šï¼Œå»ºè­°è§¸ç™¼ P4 é‡æ–°è¨ˆç®—é…ç½®æˆ– P4.6 ç·Šæ€¥æ’¤é€€ã€‚åƒè€ƒæ©Ÿæ§‹å¯ä¿¡åº¦è©•åˆ†ï¼Œå¯ä¿¡åº¦é«˜çš„æ©Ÿæ§‹è©•ç´šè­¦å‘Šæ‡‰çµ¦äºˆæ›´é«˜å„ªå…ˆç´šï¼‰",
      "parameters": {
        "tickers": ["æ¨™çš„ä»£ç¢¼ï¼ˆå¦‚æœæœ‰ï¼‰"],
        "institutional_sentiment_triggers": "æ©Ÿæ§‹è©•ç´šè§¸ç™¼èªªæ˜ï¼ˆä¾‹å¦‚ï¼š'AAPL å‡ºç¾èª˜å¤šå‡ºè²¨è­¦å‘Šï¼Œå»ºè­° P3 é‡æ–°åˆ†æ'ï¼‰",
        "institutional_credibility_reference": "åƒè€ƒçš„æ©Ÿæ§‹å¯ä¿¡åº¦è©•åˆ†ï¼ˆä¾‹å¦‚ï¼š'Goldman Sachs çŸ­æœŸå¯ä¿¡åº¦ 0.6ï¼Œä¸­æœŸå¯ä¿¡åº¦ 0.8ï¼Œæœ¬è©•ç´šå¯ä¿¡åº¦è¼ƒé«˜'ï¼‰"
      }
    }
  ]
}
`;
}
