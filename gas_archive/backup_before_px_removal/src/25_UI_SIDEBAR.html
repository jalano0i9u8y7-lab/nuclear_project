<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Nuclear Project SSOT V7.1 æ§åˆ¶é¢æ¿</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #1a73e8;
    }
    
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #202124;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
      width: 100%;
      margin-bottom: 10px;
    }
    
    .btn:hover {
      background: #1557b0;
    }
    
    .btn:active {
      background: #0d47a1;
    }
    
    .btn-secondary {
      background: #5f6368;
    }
    
    .btn-secondary:hover {
      background: #3c4043;
    }
    
    .btn-danger {
      background: #ea4335;
    }
    
    .btn-danger:hover {
      background: #c5221f;
    }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 13px;
    }
    
    .status-info {
      background: #e8f0fe;
      color: #1967d2;
    }
    
    .status-success {
      background: #e6f4ea;
      color: #137333;
    }
    
    .status-warning {
      background: #fef7e0;
      color: #b06000;
    }
    
    .status-error {
      background: #fce8e6;
      color: #c5221f;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #5f6368;
    }
    
    input[type="text"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .strategy-item {
      border: 1px solid #dadce0;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 10px;
      background: #fafafa;
    }
    
    .strategy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .strategy-ticker {
      font-weight: 600;
      font-size: 16px;
      color: #202124;
    }
    
    .strategy-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-increase {
      background: #e6f4ea;
      color: #137333;
    }
    
    .badge-decrease {
      background: #fce8e6;
      color: #c5221f;
    }
    
    .badge-hold {
      background: #fef7e0;
      color: #b06000;
    }
    
    .strategy-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      width: auto;
      margin: 0;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #5f6368;
    }
    
    .loading.active {
      display: block;
    }
    
    .notification-item {
      padding: 10px;
      border-left: 4px solid #ea4335;
      background: #fce8e6;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    
    .notification-title {
      font-weight: 600;
      color: #c5221f;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Nuclear Project SSOT V7.1</h1>
    
    <!-- ä¸»é é¢ -->
    <div id="mainPage">
      <!-- ä¸€éµåŸ·è¡Œ -->
      <div class="section">
        <div class="section-title">ğŸš€ ä¸€éµåŸ·è¡Œå®Œæ•´æµç¨‹</div>
        <div id="executeStatus" class="status status-info" style="display: none;"></div>
        <button class="btn" onclick="executeFullPipeline()">åŸ·è¡Œå®Œæ•´æµç¨‹ï¼ˆP0 â†’ P4ï¼‰</button>
        <button class="btn btn-secondary" onclick="executeFromP2()">å¾ P2 é–‹å§‹åŸ·è¡Œï¼ˆä½¿ç”¨ç¾æœ‰ P1 è³‡æ–™ï¼‰</button>
        <button class="btn btn-secondary" onclick="showPage('strategyPage')">æŸ¥çœ‹æœ¬é€±ç­–ç•¥</button>
        <button class="btn btn-secondary" onclick="showPage('humanSignalPage')">è¼¸å…¥ Human Signal</button>
        <button class="btn btn-secondary" onclick="showPage('notificationsPage')">ç·Šæ€¥é€šçŸ¥</button>
      </div>
      
      <!-- ğŸ” æ•¸æ“šæµæ¸¬è©¦ç³»çµ± â­ V8.0 æ–°å¢ -->
      <div class="section">
        <div class="section-title">ğŸ” æ•¸æ“šæµæ¸¬è©¦ç³»çµ±ï¼ˆV8.0ï¼‰</div>
        <div id="dataflowTestStatus" class="status status-info" style="display: none;"></div>
        <div style="margin-bottom: 10px; font-size: 12px; color: #5f6368;">
          <strong>æ¸¬è©¦èªªæ˜ï¼š</strong>æ¸¬è©¦æ‰€æœ‰æ•¸æ“šæ”¶é›†æ˜¯å¦æ­£å¸¸ï¼ˆCSE ç™½åå–®æˆ–çˆ¬èŸ²ï¼‰ï¼Œæª¢æŸ¥è³‡æ–™æ­£ç¢ºæ€§å’Œç­†æ•¸åˆç†æ€§ã€‚
        </div>
        <button class="btn" onclick="runDataflowTest('ALL')">ğŸ” æ¸¬è©¦å…¨éƒ¨æ•¸æ“šæµ</button>
        <button class="btn btn-secondary" onclick="runDataflowTest('P2')">ğŸ” æ¸¬è©¦ P2 æ•¸æ“šæµ</button>
        <button class="btn btn-secondary" onclick="runDataflowTest('P2_5')">ğŸ” æ¸¬è©¦ P2.5 æ•¸æ“šæµ</button>
        <button class="btn btn-secondary" onclick="runDataflowTest('P3')">ğŸ” æ¸¬è©¦ P3 æ•¸æ“šæµ</button>
        <button class="btn btn-secondary" onclick="runDataflowTest('P5_DAILY')">ğŸ” æ¸¬è©¦ P5 Daily æ•¸æ“šæµ</button>
        <button class="btn btn-secondary" onclick="runDataflowTest('P5_WEEKLY')">ğŸ” æ¸¬è©¦ P5 Weekly æ•¸æ“šæµ</button>
        <button class="btn btn-secondary" onclick="testInstitutionalRatings()">â­ V8.9 æ¸¬è©¦æ©Ÿæ§‹è©•ç´šæ”¶é›†</button>
        <button class="btn btn-secondary" onclick="testNewsQuality()">â­ V8.9 æ¸¬è©¦æ–°èå“è³ª</button>
        <div id="dataflowTestResult" style="margin-top: 15px; display: none;"></div>
      </div>
      
      <!-- ğŸ§ª è¼•æ¸¬è©¦ç³»çµ± â­ V8.0 æ–°å¢ -->
      <div class="section">
        <div class="section-title">ğŸ§ª è¼•æ¸¬è©¦ç³»çµ±ï¼ˆV8.0ï¼‰</div>
        <div id="testStatus" class="status status-info" style="display: none;"></div>
        <div style="margin-bottom: 10px; font-size: 12px; color: #5f6368;">
          <strong>æ¸¬è©¦èªªæ˜ï¼š</strong>æ¯å€‹ Phase æ¸¬è©¦å®Œæˆå¾Œï¼Œå¯ç›´æ¥æ¸¬è©¦ä¸‹ä¸€å€‹ Phaseï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨å‰æ®µçµæœã€‚
        </div>
        <button class="btn" onclick="runLightTest('P0')">ğŸ§ª æ¸¬è©¦ P0ï¼ˆç”¢æ¥­å·¥ç¨‹å­¸ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P0_5')">ğŸ§ª æ¸¬è©¦ P0.5ï¼ˆç”¢æ¥­éˆåœ°åœ–ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P0_7')">ğŸ§ª æ¸¬è©¦ P0.7ï¼ˆç³»çµ±å‹•åŠ›å­¸ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P1')">ğŸ§ª æ¸¬è©¦ P1ï¼ˆå…¬å¸æ± ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P2')">ğŸ§ª æ¸¬è©¦ P2ï¼ˆåŸºæœ¬é¢ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P2_5')">ğŸ§ª æ¸¬è©¦ P2.5ï¼ˆç±Œç¢¼é¢ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P3')">ğŸ§ª æ¸¬è©¦ P3ï¼ˆæŠ€è¡“é¢ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P4')">ğŸ§ª æ¸¬è©¦ P4ï¼ˆè³‡é‡‘é…ç½®ï¼‰</button>
        <button class="btn btn-secondary" onclick="runLightTest('P5_DAILY')">ğŸ§ª æ¸¬è©¦ P5 Daily</button>
        <button class="btn btn-secondary" onclick="runLightTest('P5_WEEKLY')">ğŸ§ª æ¸¬è©¦ P5 Weekly</button>
        <div id="testResult" style="margin-top: 15px; display: none;"></div>
      </div>
      
      <!-- ç³»çµ±ç‹€æ…‹ -->
      <div class="section">
        <div class="section-title">ğŸ“Š ç³»çµ±ç‹€æ…‹</div>
        <div id="systemStatus">
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
    
    <!-- ç­–ç•¥é é¢ -->
    <div id="strategyPage" style="display: none;">
      <div class="section">
        <div class="section-title">ğŸ“‹ æœ¬é€±æ“ä½œç­–ç•¥</div>
        <button class="btn btn-secondary" onclick="showPage('mainPage')">â† è¿”å›</button>
        <div id="strategiesList">
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
    
    <!-- Human Signal é é¢ -->
    <div id="humanSignalPage" style="display: none;">
      <div class="section">
        <div class="section-title">ğŸ“ è¼¸å…¥ Human Signal</div>
        <button class="btn btn-secondary" onclick="showPage('mainPage')">â† è¿”å›</button>
        
        <form id="humanSignalForm" onsubmit="submitHumanSignal(event)">
          <div class="form-group">
            <label>é¡å‹</label>
            <select id="signalType" required>
              <option value="ARTICLE">æ–‡ç« </option>
              <option value="NEWS">æ–°è</option>
              <option value="ANALYSIS">åˆ†æ</option>
              <option value="OTHER">å…¶ä»–</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>æ¨™ç±¤ï¼ˆå¯å¤šé¸ï¼‰</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="tag_market" value="å¸‚å ´">
                <label for="tag_market">å¸‚å ´</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tag_stock" value="å€‹è‚¡">
                <label for="tag_stock">å€‹è‚¡</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tag_macro" value="å®è§€">
                <label for="tag_macro">å®è§€</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tag_industry" value="ç”¢æ¥­">
                <label for="tag_industry">ç”¢æ¥­</label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>å…§å®¹</label>
            <textarea id="signalContent" required placeholder="è²¼ä¸Šæˆ–è¼¸å…¥å…§å®¹..."></textarea>
          </div>
          
          <div class="form-group">
            <label>URLï¼ˆå¯é¸ï¼‰</label>
            <input type="url" id="signalURL" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label>ç›¸é—œè‚¡ç¥¨ä»£ç¢¼ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼Œå¯é¸ï¼‰</label>
            <input type="text" id="signalTickers" placeholder="AAPL, TSLA, 2330">
          </div>
          
          <div class="form-group">
            <label>é‡è¦æ€§</label>
            <select id="signalImportance">
              <option value="LOW">ä½</option>
              <option value="MEDIUM" selected>ä¸­</option>
              <option value="HIGH">é«˜</option>
              <option value="CRITICAL">ç·Šæ€¥</option>
            </select>
          </div>
          
          <button type="submit" class="btn">ğŸ“¤ æäº¤åˆ° P5 Daily</button>
        </form>
        
        <div id="humanSignalStatus" class="status" style="display: none;"></div>
      </div>
    </div>
    
    <!-- ç·Šæ€¥é€šçŸ¥é é¢ -->
    <div id="notificationsPage" style="display: none;">
      <div class="section">
        <div class="section-title">ğŸš¨ ç·Šæ€¥é€šçŸ¥</div>
        <button class="btn btn-secondary" onclick="showPage('mainPage')">â† è¿”å›</button>
        <div id="notificationsList">
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // é é¢åˆ‡æ›
    function showPage(pageId) {
      document.getElementById('mainPage').style.display = pageId === 'mainPage' ? 'block' : 'none';
      document.getElementById('strategyPage').style.display = pageId === 'strategyPage' ? 'block' : 'none';
      document.getElementById('humanSignalPage').style.display = pageId === 'humanSignalPage' ? 'block' : 'none';
      document.getElementById('notificationsPage').style.display = pageId === 'notificationsPage' ? 'block' : 'none';
      
      if (pageId === 'strategyPage') {
        loadStrategies();
      } else if (pageId === 'notificationsPage') {
        loadNotifications();
      } else if (pageId === 'mainPage') {
        loadSystemStatus();
      }
    }
    
    // è¼‰å…¥ç³»çµ±ç‹€æ…‹
    function loadSystemStatus() {
      google.script.run
        .withSuccessHandler(function(status) {
          const statusDiv = document.getElementById('systemStatus');
          let html = '<div class="status status-info">';
          html += `<div><strong>æœ€å¾ŒåŸ·è¡Œæ™‚é–“ï¼š</strong>${status.last_full_pipeline ? new Date(status.last_full_pipeline.timestamp).toLocaleString() : 'å°šæœªåŸ·è¡Œ'}</div>`;
          html += `<div><strong>DEFCON ç­‰ç´šï¼š</strong>${status.defcon || 5}</div>`;
          html += `<div><strong>å¾…è™•ç†ç­–ç•¥ï¼š</strong>${status.pending_strategies || 0} ç­†</div>`;
          html += `<div><strong>ç·Šæ€¥é€šçŸ¥ï¼š</strong>${status.emergency_notifications || 0} ç­†</div>`;
          // â­ V8.0 æ–°å¢
          if (status.p2_5_available) {
            html += `<div><strong>P2.5 ç±Œç¢¼åˆ†æï¼š</strong>âœ“ å¯ç”¨</div>`;
          }
          if (status.p5_4_alerts > 0) {
            html += `<div><strong>P5.4 è­¦å ±ï¼š</strong><span style="color: #ea4335;">${status.p5_4_alerts} ç­†</span></div>`;
          }
          if (status.p5_9_bubble_stage) {
            html += `<div><strong>P5.9 æ³¡æ²«éšæ®µï¼š</strong>${status.p5_9_bubble_stage}</div>`;
          }
          if (status.current_u !== null) {
            html += `<div><strong>ç•¶å‰ Uï¼ˆè³‡é‡‘æ°´ä½ï¼‰ï¼š</strong>${(status.current_u * 100).toFixed(0)}%</div>`;
          }
          html += '</div>';
          statusDiv.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          document.getElementById('systemStatus').innerHTML = '<div class="status status-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
        })
        .getSystemStatus();
    }
    
    // åŸ·è¡Œå®Œæ•´æµç¨‹
    function executeFullPipeline() {
      const statusDiv = document.getElementById('executeStatus');
      statusDiv.style.display = 'block';
      statusDiv.className = 'status status-info';
      statusDiv.textContent = 'åŸ·è¡Œä¸­ï¼Œè«‹ç¨å€™...ï¼ˆP0 â†’ P4ï¼‰';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.status === 'COMPLETED' || result.status === 'PARTIAL') {
            statusDiv.className = 'status status-success';
            let message = 'åŸ·è¡Œå®Œæˆï¼\n';
            for (const phase in result.phases) {
              const phaseResult = result.phases[phase];
              message += `${phase}: ${phaseResult.status}\n`;
            }
            statusDiv.textContent = message;
          } else {
            statusDiv.className = 'status status-error';
            statusDiv.textContent = 'åŸ·è¡Œå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤');
          }
        })
        .withFailureHandler(function(error) {
          statusDiv.className = 'status status-error';
          statusDiv.textContent = 'åŸ·è¡Œå¤±æ•—ï¼š' + error.message;
        })
        .UI_ExecuteFullPipeline({ skip_user_confirmation: true });
    }
    
    // å¾ P2 é–‹å§‹åŸ·è¡Œï¼ˆä½¿ç”¨ç¾æœ‰ P1 è³‡æ–™ï¼‰â­ V8.0 æ–°å¢
    function executeFromP2() {
      console.log('executeFromP2 å‡½æ•¸è¢«èª¿ç”¨');
      const statusDiv = document.getElementById('executeStatus');
      statusDiv.style.display = 'block';
      statusDiv.className = 'status status-info';
      statusDiv.textContent = 'åŸ·è¡Œä¸­ï¼Œè«‹ç¨å€™...ï¼ˆP2 â†’ P4ï¼Œä½¿ç”¨ç¾æœ‰ P1 è³‡æ–™ï¼‰';
      
      console.log('æº–å‚™èª¿ç”¨ UI_ExecuteFromP2');
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('UI_ExecuteFromP2 åŸ·è¡ŒæˆåŠŸï¼Œçµæœï¼š', result);
          if (result.status === 'COMPLETED' || result.status === 'PARTIAL') {
            statusDiv.className = 'status status-success';
            let message = 'åŸ·è¡Œå®Œæˆï¼\n';
            for (const phase in result.phases) {
              const phaseResult = result.phases[phase];
              message += `${phase}: ${phaseResult.status}\n`;
            }
            statusDiv.textContent = message;
          } else {
            statusDiv.className = 'status status-error';
            statusDiv.textContent = 'åŸ·è¡Œå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤');
          }
        })
        .withFailureHandler(function(error) {
          console.error('UI_ExecuteFromP2 åŸ·è¡Œå¤±æ•—ï¼š', error);
          statusDiv.className = 'status status-error';
          statusDiv.textContent = 'åŸ·è¡Œå¤±æ•—ï¼š' + error.message;
          alert('åŸ·è¡Œå¤±æ•—ï¼š' + error.message + '\nè«‹æŸ¥çœ‹ GAS æ—¥èªŒç²å–è©³ç´°è³‡è¨Šã€‚');
        })
        .UI_ExecuteFromP2({ skip_user_confirmation: true });
    }
    
    // è¼‰å…¥ç­–ç•¥åˆ—è¡¨
    function loadStrategies() {
      google.script.run
        .withSuccessHandler(function(strategies) {
          const listDiv = document.getElementById('strategiesList');
          if (strategies.length === 0) {
            listDiv.innerHTML = '<div class="status status-info">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ç­–ç•¥</div>';
            return;
          }
          
          let html = '';
          strategies.forEach(function(strategy) {
            const badgeClass = strategy.strategy === 'INCREASE' ? 'badge-increase' : 
                              strategy.strategy === 'DECREASE' ? 'badge-decrease' : 'badge-hold';
            html += '<div class="strategy-item">';
            html += `<div class="strategy-header">`;
            html += `<span class="strategy-ticker">${strategy.ticker}</span>`;
            html += `<span class="strategy-badge ${badgeClass}">${strategy.strategy}</span>`;
            html += `</div>`;
            html += `<div>æ“ä½œï¼š${strategy.action}</div>`;
            html += `<div>ç›®æ¨™é…ç½®ï¼š${strategy.target_allocation}%</div>`;
            html += `<div>ä¿¡å¿ƒåº¦ï¼š${(strategy.confidence * 100).toFixed(0)}%</div>`;
            html += `<div class="strategy-actions">`;
            html += `<button class="btn btn-small" onclick="confirmStrategy('${strategy.ticker}', '${strategy.date}')">âœ… ç¢ºèª</button>`;
            html += `<button class="btn btn-small btn-danger" onclick="rejectStrategy('${strategy.ticker}', '${strategy.date}')">âŒ æ‹’çµ•</button>`;
            html += `</div>`;
            html += `</div>`;
          });
          listDiv.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          document.getElementById('strategiesList').innerHTML = '<div class="status status-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
        })
        .UI_GetPendingStrategies();
    }
    
    // ç¢ºèªç­–ç•¥
    function confirmStrategy(ticker, date) {
      if (confirm(`ç¢ºèªåŸ·è¡Œç­–ç•¥ï¼š${ticker}ï¼Ÿ`)) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('ç­–ç•¥å·²ç¢ºèª');
              loadStrategies();
            } else {
              alert('ç¢ºèªå¤±æ•—ï¼š' + result.message);
            }
          })
          .withFailureHandler(function(error) {
            alert('ç¢ºèªå¤±æ•—ï¼š' + error.message);
          })
          .UI_ConfirmStrategy(ticker, date, {});
      }
    }
    
    // æ‹’çµ•ç­–ç•¥
    function rejectStrategy(ticker, date) {
      const reason = prompt(`æ‹’çµ•ç­–ç•¥ï¼š${ticker}ï¼Œè«‹è¼¸å…¥åŸå› ï¼š`);
      if (reason !== null) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('ç­–ç•¥å·²æ‹’çµ•');
              loadStrategies();
            } else {
              alert('æ‹’çµ•å¤±æ•—ï¼š' + result.message);
            }
          })
          .withFailureHandler(function(error) {
            alert('æ‹’çµ•å¤±æ•—ï¼š' + error.message);
          })
          .UI_RejectStrategy(ticker, date, reason);
      }
    }
    
    // æäº¤ Human Signal
    function submitHumanSignal(event) {
      event.preventDefault();
      
      const statusDiv = document.getElementById('humanSignalStatus');
      statusDiv.style.display = 'block';
      statusDiv.className = 'status status-info';
      statusDiv.textContent = 'æäº¤ä¸­...';
      
      const tags = [];
      if (document.getElementById('tag_market').checked) tags.push('å¸‚å ´');
      if (document.getElementById('tag_stock').checked) tags.push('å€‹è‚¡');
      if (document.getElementById('tag_macro').checked) tags.push('å®è§€');
      if (document.getElementById('tag_industry').checked) tags.push('ç”¢æ¥­');
      
      const tickers = document.getElementById('signalTickers').value
        .split(',')
        .map(t => t.trim())
        .filter(t => t.length > 0);
      
      const signalData = {
        type: document.getElementById('signalType').value,
        content: document.getElementById('signalContent').value,
        url: document.getElementById('signalURL').value,
        tags: tags,
        tickers: tickers,
        importance: document.getElementById('signalImportance').value,
        process_immediately: false
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            statusDiv.className = 'status status-success';
            statusDiv.textContent = 'æäº¤æˆåŠŸï¼ä¿¡è™Ÿ IDï¼š' + result.signal_id;
            document.getElementById('humanSignalForm').reset();
          } else {
            statusDiv.className = 'status status-error';
            statusDiv.textContent = 'æäº¤å¤±æ•—ï¼š' + result.message;
          }
        })
        .withFailureHandler(function(error) {
          statusDiv.className = 'status status-error';
          statusDiv.textContent = 'æäº¤å¤±æ•—ï¼š' + error.message;
        })
        .UI_SubmitHumanSignal(signalData);
    }
    
    // è¼‰å…¥ç·Šæ€¥é€šçŸ¥
    function loadNotifications() {
      google.script.run
        .withSuccessHandler(function(notifications) {
          const listDiv = document.getElementById('notificationsList');
          if (notifications.length === 0) {
            listDiv.innerHTML = '<div class="status status-success">ç›®å‰æ²’æœ‰ç·Šæ€¥é€šçŸ¥</div>';
            return;
          }
          
          let html = '';
          notifications.forEach(function(notification) {
            html += '<div class="notification-item">';
            html += `<div class="notification-title">${notification.title}</div>`;
            html += `<div>${notification.message}</div>`;
            html += `<div style="font-size: 12px; color: #5f6368; margin-top: 5px;">${notification.timestamp}</div>`;
            html += '</div>';
          });
          listDiv.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          document.getElementById('notificationsList').innerHTML = '<div class="status status-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
        })
        .UI_GetEmergencyNotifications();
    }
    
    // â­ V8.9 æ–°å¢ï¼šæ¸¬è©¦æ©Ÿæ§‹è©•ç´šæ”¶é›†
    function testInstitutionalRatings() {
      const statusDiv = document.getElementById('dataflowTestStatus');
      const resultDiv = document.getElementById('dataflowTestResult');
      
      statusDiv.style.display = 'block';
      statusDiv.className = 'status status-info';
      statusDiv.textContent = 'â­ V8.9 æ©Ÿæ§‹è©•ç´šæ”¶é›†æ¸¬è©¦åŸ·è¡Œä¸­ï¼Œè«‹ç¨å€™...';
      resultDiv.style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.className = result.success ? 'status status-success' : 'status status-warning';
          statusDiv.textContent = result.success ? 
            `â­ æ©Ÿæ§‹è©•ç´šæ”¶é›†å®Œæˆï¼ˆå…± ${result.count || 0} ç­†ï¼‰` : 
            `â­ æ©Ÿæ§‹è©•ç´šæ”¶é›†è­¦å‘Šï¼š${result.message || 'æœªçŸ¥éŒ¯èª¤'}`;
          
          resultDiv.style.display = 'block';
          let html = '<div class="status status-info" style="margin-top: 10px;">';
          html += `<div><strong>æ”¶é›†çµæœï¼š</strong>${result.success ? 'âœ… æˆåŠŸ' : 'âš ï¸ è­¦å‘Š'}</div>`;
          html += `<div><strong>æ”¶é›†ç­†æ•¸ï¼š</strong>${result.count || 0} ç­†</div>`;
          if (result.total_collected) {
            html += `<div><strong>åŸå§‹æ”¶é›†ï¼š</strong>${result.total_collected} ç­†</div>`;
            html += `<div><strong>å»é‡å¾Œï¼š</strong>${result.deduplicated || result.count} ç­†</div>`;
          }
          if (result.message) {
            html += `<div style="margin-top: 10px; color: #fbbc04;"><strong>èªªæ˜ï¼š</strong>${result.message}</div>`;
          }
          html += '</div>';
          resultDiv.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          statusDiv.className = 'status status-error';
          statusDiv.textContent = 'â­ æ©Ÿæ§‹è©•ç´šæ”¶é›†æ¸¬è©¦å¤±æ•—ï¼š' + error.message;
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div class="status status-error">éŒ¯èª¤ï¼š' + error.message + '</div>';
        })
        .collectInstitutionalRatings();
    }
    
    // â­ V8.9 æ–°å¢ï¼šæ¸¬è©¦æ–°èå“è³ª
    function testNewsQuality() {
      const statusDiv = document.getElementById('dataflowTestStatus');
      const resultDiv = document.getElementById('dataflowTestResult');
      
      statusDiv.style.display = 'block';
      statusDiv.className = 'status status-info';
      statusDiv.textContent = 'â­ V8.9 æ–°èå“è³ªæ¸¬è©¦åŸ·è¡Œä¸­ï¼Œè«‹ç¨å€™...';
      resultDiv.style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(result) {
          const statusColor = result.status === 'PASSED' ? 'status-success' : 
                              result.status === 'WARNING' ? 'status-warning' : 'status-error';
          const statusIcon = result.status === 'PASSED' ? 'âœ…' : 
                            result.status === 'WARNING' ? 'âš ï¸' : 'âŒ';
          
          statusDiv.className = 'status ' + statusColor;
          statusDiv.textContent = `â­ æ–°èå“è³ªæ¸¬è©¦${result.status === 'PASSED' ? 'é€šé' : result.status === 'WARNING' ? 'éƒ¨åˆ†é€šé' : 'å¤±æ•—'}ï¼ˆé€šéç‡ ${result.pass_rate || '0%'}ï¼‰`;
          
          resultDiv.style.display = 'block';
          let html = '<div class="status status-info" style="margin-top: 10px;">';
          html += `<div><strong>æ¸¬è©¦çµæœï¼š</strong>${statusIcon} ${result.status}</div>`;
          html += `<div><strong>ç¸½æ–°èæ•¸ï¼š</strong>${result.total_news || 0} ç­†</div>`;
          html += `<div><strong>é€šéï¼š</strong><span style="color: #34a853;">${result.total_passed || 0}</span></div>`;
          html += `<div><strong>å¤±æ•—ï¼š</strong><span style="color: #ea4335;">${result.total_failed || 0}</span></div>`;
          html += `<div><strong>è­¦å‘Šï¼š</strong><span style="color: #fbbc04;">${result.total_warnings || 0}</span></div>`;
          html += `<div><strong>é€šéç‡ï¼š</strong>${result.pass_rate || '0%'}</div>`;
          
          if (result.general_news) {
            html += '<div style="margin-top: 10px;"><strong>ä¸€èˆ¬æ–°èï¼š</strong></div>';
            html += `<div style="margin-left: 20px;">ç¸½æ•¸ï¼š${result.general_news.total}ï¼Œé€šéï¼š${result.general_news.passed}ï¼Œå¤±æ•—ï¼š${result.general_news.failed}</div>`;
          }
          
          if (result.institutional_ratings) {
            html += '<div style="margin-top: 10px;"><strong>æ©Ÿæ§‹è©•ç´šæ–°èï¼š</strong></div>';
            html += `<div style="margin-left: 20px;">ç¸½æ•¸ï¼š${result.institutional_ratings.total}ï¼Œé€šéï¼š${result.institutional_ratings.passed}ï¼Œå¤±æ•—ï¼š${result.institutional_ratings.failed}</div>`;
          }
          
          if (result.message) {
            html += `<div style="margin-top: 10px; color: #5f6368;"><strong>èªªæ˜ï¼š</strong>${result.message}</div>`;
          }
          
          html += '</div>';
          resultDiv.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          statusDiv.className = 'status status-error';
          statusDiv.textContent = 'â­ æ–°èå“è³ªæ¸¬è©¦å¤±æ•—ï¼š' + error.message;
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div class="status status-error">éŒ¯èª¤ï¼š' + error.message + '</div>';
        })
        .testP5NewsQuality();
    }
    
    // ğŸ” æ•¸æ“šæµæ¸¬è©¦ç³»çµ± â­ V8.0 æ–°å¢
    function runDataflowTest(testCategory) {
      const statusDiv = document.getElementById('dataflowTestStatus');
      const resultDiv = document.getElementById('dataflowTestResult');
      
      statusDiv.style.display = 'block';
      statusDiv.className = 'status status-info';
      statusDiv.textContent = `ğŸ” ${testCategory} æ•¸æ“šæµæ¸¬è©¦åŸ·è¡Œä¸­ï¼Œè«‹ç¨å€™...`;
      resultDiv.style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.className = result.status === 'COMPLETED' ? 'status status-success' : 
                                result.status === 'PARTIAL' ? 'status status-warning' : 'status status-error';
          statusDiv.textContent = `ğŸ” ${testCategory} æ•¸æ“šæµæ¸¬è©¦${result.status === 'COMPLETED' ? 'å®Œæˆ' : result.status === 'PARTIAL' ? 'éƒ¨åˆ†é€šé' : 'å¤±æ•—'}`;
          
          // é¡¯ç¤ºæ¸¬è©¦çµæœ
          resultDiv.style.display = 'block';
          let html = '<div class="status status-info" style="margin-top: 10px;">';
          html += `<div><strong>æ¸¬è©¦é¡åˆ¥ï¼š</strong>${testCategory}</div>`;
          html += `<div><strong>åŸ·è¡Œæ™‚é–“ï¼š</strong>${(result.duration / 1000).toFixed(2)} ç§’</div>`;
          
          if (result.summary) {
            html += '<div style="margin-top: 10px;"><strong>ğŸ“Š æ¸¬è©¦æ‘˜è¦ï¼š</strong></div>';
            html += '<div style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px;">';
            html += `<div>ç¸½æ•¸ï¼š${result.summary.total}</div>`;
            html += `<div style="color: #34a853;">âœ… é€šéï¼š${result.summary.passed}</div>`;
            html += `<div style="color: #ea4335;">âŒ å¤±æ•—ï¼š${result.summary.failed}</div>`;
            html += `<div style="color: #fbbc04;">âš ï¸ è­¦å‘Šï¼š${result.summary.warning}</div>`;
            html += '</div>';
          }
          
          if (result.results && result.results.length > 0) {
            html += '<div style="margin-top: 10px;"><strong>ğŸ“‹ è©³ç´°çµæœï¼š</strong></div>';
            html += '<div style="max-height: 400px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px;">';
            
            result.results.forEach(function(testResult) {
              const statusColor = testResult.status === 'PASSED' ? '#34a853' : 
                                 testResult.status === 'FAILED' ? '#ea4335' : '#fbbc04';
              const statusIcon = testResult.status === 'PASSED' ? 'âœ…' : 
                                testResult.status === 'FAILED' ? 'âŒ' : 'âš ï¸';
              
              html += `<div style="margin-bottom: 10px; padding: 8px; background: white; border-left: 3px solid ${statusColor}; border-radius: 4px;">`;
              html += `<div style="font-weight: 600;">${statusIcon} ${testResult.test_name}</div>`;
              html += `<div style="margin-top: 5px; color: #5f6368;">${testResult.message || testResult.error || ''}</div>`;
              
              if (testResult.result_count !== undefined) {
                html += `<div style="margin-top: 3px; font-size: 11px; color: #666;">æ•¸æ“šç­†æ•¸ï¼š${testResult.result_count}`;
                if (testResult.expected_min) {
                  html += ` (é æœŸ >= ${testResult.expected_min})`;
                }
                html += `</div>`;
              }
              
              if (testResult.ticker) {
                html += `<div style="margin-top: 3px; font-size: 11px; color: #666;">è‚¡ç¥¨ï¼š${testResult.ticker} (${testResult.market || ''})</div>`;
              }
              
              html += `</div>`;
            });
            
            html += '</div>';
          }
          
          html += '</div>';
          resultDiv.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          statusDiv.className = 'status status-error';
          statusDiv.textContent = `ğŸ” ${testCategory} æ•¸æ“šæµæ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = `<div class="status status-error">éŒ¯èª¤ï¼š${error.message}</div>`;
        })
        .DataflowTest_Execute({ test_category: testCategory });
    }
    
    // ğŸ§ª è¼•æ¸¬è©¦ç³»çµ± â­ V8.0 æ–°å¢
    function runLightTest(phase) {
      const statusDiv = document.getElementById('testStatus');
      const resultDiv = document.getElementById('testResult');
      
      statusDiv.style.display = 'block';
      statusDiv.className = 'status status-info';
      statusDiv.textContent = `ğŸ§ª ${phase} æ¸¬è©¦åŸ·è¡Œä¸­ï¼Œè«‹ç¨å€™...`;
      resultDiv.style.display = 'none';
      
      google.script.run
        .withSuccessHandler(function(result) {
          // â­ V8.0 ä¿®æ­£ï¼šè™•ç† SUBMITTED ç‹€æ…‹ï¼ˆéœ€è¦åŸ·è¡Œ M0ï¼‰
          if (result.status === 'SUBMITTED') {
            statusDiv.className = 'status status-warning';
            statusDiv.textContent = `ğŸ§ª ${phase} æ¸¬è©¦ï¼šä»»å‹™å·²æäº¤åˆ° M0ï¼Œè«‹åŸ·è¡Œ M0_Execute() å¾Œå†æŸ¥çœ‹çµæœ`;
            
            resultDiv.style.display = 'block';
            let html = '<div class="status status-warning" style="margin-top: 10px;">';
            html += `<div><strong>æ¸¬è©¦ Phaseï¼š</strong>${phase}</div>`;
            html += `<div><strong>ç‹€æ…‹ï¼š</strong>${result.status}</div>`;
            html += `<div><strong>Job IDï¼š</strong>${result.result.job_id || 'N/A'}</div>`;
            html += `<div style="margin-top: 10px;"><strong>âš ï¸ ä¸‹ä¸€æ­¥ï¼š</strong></div>`;
            html += `<div style="background: #fef7e0; padding: 10px; border-radius: 4px; margin-top: 5px;">`;
            html += `<div>è«‹åŸ·è¡Œ <code>M0_Execute()</code> ä¾†è™•ç† M0 Job Queueï¼Œç„¶å¾Œé‡æ–°åŸ·è¡Œæ¸¬è©¦æŸ¥çœ‹çµæœã€‚</div>`;
            html += `</div>`;
            html += `</div>`;
            resultDiv.innerHTML = html;
            return;
          }
          
          statusDiv.className = result.status === 'COMPLETED' ? 'status status-success' : 'status status-error';
          statusDiv.textContent = `ğŸ§ª ${phase} æ¸¬è©¦${result.status === 'COMPLETED' ? 'å®Œæˆ' : 'å¤±æ•—'}`;
          
          // é¡¯ç¤ºæ¸¬è©¦çµæœ
          resultDiv.style.display = 'block';
          let html = '<div class="status status-info" style="margin-top: 10px;">';
          html += `<div><strong>æ¸¬è©¦ Phaseï¼š</strong>${phase}</div>`;
          html += `<div><strong>åŸ·è¡Œæ™‚é–“ï¼š</strong>${(result.duration / 1000).toFixed(2)} ç§’</div>`;
          
          if (result.status === 'COMPLETED') {
            // â­ V8.0 æ–°å¢ï¼šæ˜ç¢ºé¡¯ç¤º AI å›æ‡‰æª¢æŸ¥æŒ‡å¼•
            var jobId = result.result?.job_id || result.job_id || 'ä½ çš„ job_id';
            html += '<div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">';
            html += '<strong>ğŸ“‹ AI å›æ‡‰æª¢æŸ¥æŒ‡å¼•ï¼ˆé‡è¦ï¼ï¼‰ï¼š</strong><br><br>';
            html += '<div style="font-size: 12px; line-height: 1.6;">';
            html += '<strong>æ­¥é©Ÿ 1ï¼š</strong>æ‰“é–‹ <code>M0__CROSSCHECK_LOG</code> è¡¨æ ¼<br>';
            html += '<strong>æ­¥é©Ÿ 2ï¼š</strong>ç¯©é¸ <code>job_id = "' + jobId + '"</code><br>';
            html += '<strong>æ­¥é©Ÿ 3ï¼š</strong>æ‰¾åˆ° <code>step = "EXECUTOR"</code> çš„è¨˜éŒ„<br>';
            html += '<strong>æ­¥é©Ÿ 4ï¼š</strong>è¤‡è£½ <code>output_snapshot</code> æ¬„ä½çš„<strong>å®Œæ•´å…§å®¹</strong>ï¼ˆé€™æ˜¯åŸ·è¡Œè€…çš„åŸå§‹å›æ‡‰ï¼‰<br>';
            html += '<strong>æ­¥é©Ÿ 5ï¼š</strong>æ‰¾åˆ° <code>step = "AUDITOR"</code> çš„è¨˜éŒ„<br>';
            html += '<strong>æ­¥é©Ÿ 6ï¼š</strong>è¤‡è£½ <code>output_snapshot</code> æ¬„ä½çš„<strong>å®Œæ•´å…§å®¹</strong>ï¼ˆé€™æ˜¯å¯©æŸ¥è€…çš„åŸå§‹å›æ‡‰ï¼‰<br>';
            html += '<strong>æ­¥é©Ÿ 7ï¼š</strong>è²¼ä¸Šçµ¦æˆ‘æª¢æŸ¥<br>';
            html += '</div>';
            html += '<div style="margin-top: 8px; font-size: 11px; color: #666;">';
            html += 'ğŸ’¡ æç¤ºï¼šé€™æ˜¯ AI çš„åŸå§‹å›æ‡‰ï¼Œç”¨æ–¼è©•ä¼° Prompt æœ‰æ•ˆç¨‹åº¦ã€‚è©³ç´°æŒ‡å¼•è«‹åƒè€ƒï¼š<code>è¼•æ¸¬è©¦AIå›æ‡‰æª¢æŸ¥æŒ‡å—_V8.0.md</code>';
            html += '</div>';
            html += '</div>';
            
            html += '<div style="margin-top: 10px;"><strong>âœ… AI å›æ‡‰æ¬„ä½æ‘˜è¦ï¼ˆå‰ 20 å€‹ï¼‰ï¼š</strong></div>';
            html += '<div style="max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px; font-family: monospace;">';
            
            if (result.ai_output_fields && result.ai_output_fields.length > 0) {
              var fieldCount = 0;
              result.ai_output_fields.forEach(function(field) {
                if (fieldCount < 20) {
                  html += `<div>${field.field}: ${typeof field.value === 'object' ? JSON.stringify(field.value).substring(0, 100) : String(field.value).substring(0, 100)}</div>`;
                  fieldCount++;
                }
              });
              if (result.ai_output_fields.length > 20) {
                html += `<div style="color: #666;">... é‚„æœ‰ ${result.ai_output_fields.length - 20} å€‹æ¬„ä½</div>`;
              }
            } else {
              html += '<div>ï¼ˆç„¡ AI å›æ‡‰æ¬„ä½ï¼Œå¯èƒ½æ˜¯ç´”è¨ˆç®—æ¨¡çµ„ï¼‰</div>';
            }
            
            html += '</div>';
            
            if (result.prompt_evaluation) {
              html += '<div style="margin-top: 10px;"><strong>ğŸ“Š Prompt æœ‰æ•ˆç¨‹åº¦è©•ä¼°ï¼š</strong></div>';
              html += '<div style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px;">';
              
              if (result.prompt_evaluation.completeness) {
                html += '<div><strong>å®Œæ•´æ€§ï¼š</strong></div>';
                for (const [key, value] of Object.entries(result.prompt_evaluation.completeness)) {
                  html += `<div>  - ${key}: ${value}</div>`;
                }
              }
              
              if (result.prompt_evaluation.issues && result.prompt_evaluation.issues.length > 0) {
                html += '<div style="margin-top: 10px;"><strong>âš ï¸ ç™¼ç¾çš„å•é¡Œï¼š</strong></div>';
                result.prompt_evaluation.issues.forEach(function(issue) {
                  const severityColor = issue.severity === 'CRITICAL' ? '#c5221f' : 
                                       issue.severity === 'HIGH' ? '#ea4335' : 
                                       issue.severity === 'MEDIUM' ? '#fbbc04' : '#34a853';
                  html += `<div style="color: ${severityColor};">  - [${issue.severity}] ${issue.ticker || ''} ${issue.issue || issue}</div>`;
                });
              } else {
                html += '<div style="color: #34a853;">âœ… æœªç™¼ç¾å•é¡Œ</div>';
              }
              
              // â­ V8.0 æ–°å¢ï¼šé¡¯ç¤ºä¸‰å€‹æ ¸å¿ƒè©•ä¼°é‡é»
              if (result.prompt_evaluation.core_assessment) {
            // â­ V8.0 æ–°å¢ï¼šé¡¯ç¤ºè‡ªå‹•è®€å– AI åŸå§‹å›æ‡‰çš„ç‹€æ…‹ï¼ˆåƒ…ç”¨æ–¼è³‡æ–™è®€å–ï¼Œæœ€çµ‚è©•ä¼°å¿…é ˆç”± AI åŠ©æ‰‹é€²è¡Œï¼‰
            if (result.prompt_evaluation && result.prompt_evaluation.ai_raw_responses) {
              const aiRes = result.prompt_evaluation.ai_raw_responses;
              const statusColor = (aiRes.executor_available && aiRes.auditor_available) ? '#34a853' : '#fbbc04';
              html += '<div style="margin-top: 10px; padding: 8px; background: #e8f0fe; border-left: 3px solid ' + statusColor + '; border-radius: 4px;">';
              html += '<strong>ğŸ“Š è³‡æ–™è®€å–ç‹€æ…‹ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ï¼š</strong><br>';
              html += '<span style="font-size: 12px;">';
              html += (aiRes.executor_available ? 'âœ… EXECUTOR å›æ‡‰å·²è®€å–' : 'âŒ EXECUTOR å›æ‡‰æœªæ‰¾åˆ°') + '<br>';
              html += (aiRes.auditor_available ? 'âœ… AUDITOR å›æ‡‰å·²è®€å–' : 'âŒ AUDITOR å›æ‡‰æœªæ‰¾åˆ°') + '<br>';
              if (aiRes.job_id) {
                html += 'Job ID: <code style="font-size: 11px;">' + aiRes.job_id + '</code><br>';
              }
              html += '<em style="color: #666; font-size: 11px;">âš ï¸ æ­¤è™•åƒ…é¡¯ç¤ºè³‡æ–™è®€å–ç‹€æ…‹ï¼Œæœ€çµ‚è©•ä¼°å¿…é ˆç”± AI åŠ©æ‰‹ï¼ˆæˆ‘ï¼‰é€²è¡Œ</em>';
              html += '</span></div>';
            }
            
            html += '<div style="margin-top: 15px; padding: 10px; background: #f0f4ff; border-left: 4px solid #4285f4; border-radius: 4px;">';
            html += '<strong>ğŸ” ä¸‰å€‹æ ¸å¿ƒè©•ä¼°é‡é»ï¼ˆåˆæ­¥æª¢æŸ¥ï¼Œæœ€çµ‚è©•ä¼°éœ€ç”± AI åŠ©æ‰‹é€²è¡Œï¼‰ï¼š</strong><br><br>';
                
                const ca = result.prompt_evaluation.core_assessment;
                
                // é‡é» 1
                if (ca.task_alignment) {
                  const ta = ca.task_alignment;
                  const taColor = ta.assessment === 'ALIGNED' ? '#34a853' : ta.assessment === 'PARTIAL' ? '#fbbc04' : '#ea4335';
                  html += `<div style="margin-bottom: 8px;"><strong style="color: ${taColor};">1. æ˜¯å¦ç¬¦åˆä¸»è¦ä»»å‹™èˆ‡è¨­è¨ˆç²¾ç¥ï¼š</strong> ${ta.assessment}</div>`;
                  html += `<div style="font-size: 11px; color: #666; margin-left: 20px;">${ta.description}</div>`;
                  if (ta.suggestions && ta.suggestions.length > 0) {
                    html += `<div style="font-size: 11px; color: #ea4335; margin-left: 20px; margin-top: 3px;">ğŸ’¡ å»ºè­°ï¼š${ta.suggestions.join('; ')}</div>`;
                  }
                }
                
                // é‡é» 2
                if (ca.emphasis_check) {
                  const ec = ca.emphasis_check;
                  const ecColor = ec.assessment === 'STRONG' ? '#34a853' : ec.assessment === 'MODERATE' ? '#fbbc04' : '#ea4335';
                  html += `<div style="margin-bottom: 8px; margin-top: 10px;"><strong style="color: ${ecColor};">2. æ˜¯å¦å¼·èª¿å‡ºé‡è¦–çš„éƒ¨åˆ†ï¼š</strong> ${ec.assessment}</div>`;
                  html += `<div style="font-size: 11px; color: #666; margin-left: 20px;">${ec.description}</div>`;
                  if (ec.suggestions && ec.suggestions.length > 0) {
                    html += `<div style="font-size: 11px; color: #ea4335; margin-left: 20px; margin-top: 3px;">ğŸ’¡ å»ºè­°ï¼š${ec.suggestions.join('; ')}</div>`;
                  }
                }
                
                // é‡é» 3
                if (ca.consistency) {
                  const cs = ca.consistency;
                  html += `<div style="margin-top: 10px;"><strong>3. å›ç­”åé›¢åº¦ï¼ˆä¸€è‡´æ€§ï¼‰ï¼š</strong> ${cs.assessment}</div>`;
                  html += `<div style="font-size: 11px; color: #666; margin-left: 20px;">${cs.description || cs.note || 'éœ€è¦å¤šæ¬¡åŸ·è¡Œæ‰èƒ½è©•ä¼°'}</div>`;
                }
                
                html += '</div>';
              }
              
              html += '</div>';
            }
            
            html += '<div style="margin-top: 15px; padding: 12px; background: #e8f0fe; border-left: 4px solid #1a73e8; border-radius: 4px;">';
            html += '<strong>ğŸ“‹ è«‹è¤‡è£½ä»¥ä¸‹å…§å®¹å›è¦†ï¼š</strong><br><br>';
            html += '<div style="font-size: 11px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; background: white; padding: 10px; border-radius: 4px;">';
            html += `Phase: ${phase}\n`;
            html += `Status: ${result.status}\n`;
            html += `Duration: ${(result.duration / 1000).toFixed(2)}s\n`;
            html += `Job ID: ${jobId}\n\n`;
            html += '=== AI å›æ‡‰æª¢æŸ¥ï¼ˆå¿…é ˆæä¾›ï¼‰===\n';
            html += 'è¡¨æ ¼ï¼šM0__CROSSCHECK_LOG\n';
            html += `ç¯©é¸ï¼šjob_id = "${jobId}"\n\n`;
            html += 'EXECUTOR å›æ‡‰ï¼š\n';
            html += '[è«‹è¤‡è£½ step="EXECUTOR" çš„ output_snapshot æ¬„ä½å®Œæ•´å…§å®¹]\n\n';
            html += 'AUDITOR å›æ‡‰ï¼š\n';
            html += '[è«‹è¤‡è£½ step="AUDITOR" çš„ output_snapshot æ¬„ä½å®Œæ•´å…§å®¹]\n\n';
            html += '=== AI è¼¸å‡ºæ¬„ä½æ‘˜è¦ ===\n';
            if (result.ai_output_fields && result.ai_output_fields.length > 0) {
              var fieldCount = 0;
              result.ai_output_fields.forEach(function(field) {
                if (fieldCount < 30) {
                  html += `  ${field.field}: ${JSON.stringify(field.value).substring(0, 200)}\n`;
                  fieldCount++;
                }
              });
              if (result.ai_output_fields.length > 30) {
                html += `  ... é‚„æœ‰ ${result.ai_output_fields.length - 30} å€‹æ¬„ä½\n`;
              }
            } else {
              html += '  (ç„¡ AI å›æ‡‰æ¬„ä½)\n';
            }
            html += '\n=== Prompt è©•ä¼° ===\n';
            html += JSON.stringify(result.prompt_evaluation, null, 2);
            html += '</div>';
            html += '</div>';
          } else {
            html += `<div style="color: #c5221f;"><strong>âŒ éŒ¯èª¤ï¼š</strong>${result.error || 'æœªçŸ¥éŒ¯èª¤'}</div>`;
            if (result.stack) {
              html += `<div style="font-size: 11px; font-family: monospace; margin-top: 5px;">${result.stack}</div>`;
            }
          }
          
          html += '</div>';
          resultDiv.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          statusDiv.className = 'status status-error';
          statusDiv.textContent = `ğŸ§ª ${phase} æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
          
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = '<div class="status status-error">éŒ¯èª¤ï¼š' + error.message + '</div>';
        })
        .LightTest_Execute({ phase: phase, use_previous_results: true });
    }
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.onload = function() {
      loadSystemStatus();
    };
  </script>
</body>
</html>
