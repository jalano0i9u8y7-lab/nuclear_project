# V8.17 補丁評估與實現報告

## 評估日期
2026-01-19

## 補丁評估結果

### ✅ 1. P1 Prompt 補丁（結構分級原則，不錯殺）

**評估結果**：✅ **值得採用**

**現狀分析**：
- 目前 P1 Step2 Prompt 中，Tier X 的定義是「結構性受害者」，但沒有明確禁止「資料不足 → Tier X」
- Prompt 中提到「必須使用 Flash 提取的資料」，但沒有明確說明「資料不足時應保留在 Tier B」

**補丁價值**：
- 避免錯殺有潛力的公司（如 Tesla 早期）
- 確保 AI 必須基於結構邏輯判斷，而非資料完整性
- 符合系統設計理念：結構優先，證據加權

**實現方案**：
- 在 `buildP1Step2Prompt()` 中添加「結構分級原則」補丁
- 明確禁止因「資料不足」、「公司較小」、「尚未獲利」而直接標記為 Tier X
- 所有公司初始預設為 Tier B（結構觀察名單）

---

### ✅ 2. P2 Prompt 補丁（Runway = 風險，不是死刑）

**評估結果**：✅ **值得採用**

**現狀分析**：
- 目前 P2 Prompt 中，Runway < 4 季 → Execution Risk = HIGH，Frontier Gate = FAIL（硬門檴）
- 這可能過於嚴格，錯殺有潛力的 Frontier 公司

**補丁價值**：
- 將 Runway 作為風險標記，而非死刑判決
- 允許 AI 保留想像力，但要把不確定性講清楚
- 生死交給後段（P4）處理

**實現方案**：
- 在 P2 Prompt 中修改 Runway 處理邏輯
- 將「Runway < 4 季 → FAIL」改為「Runway < 4 季 → 標記 [RISK: LOW_RUNWAY]」
- 允許評估「潛在續命因子」（VC/Strategic/Government 資金流入、收購/合作/政策扶持、非線性特性）

---

### ✅ 3. P4 風控補丁（讓數學負責殘酷，AI 保持創造力）

**評估結果**：✅ **值得採用**

**現狀分析**：
- 目前 P4 已經有 `applyFrontierRunwayGate()` 處理 Runway < 4 的情況
- 但補丁建議的是更細緻的風險上限機制（risk_cap_percent），可以讓 AI 保持創造力，同時用數學鎖死風險

**補丁價值**：
- AI 可以說：「這很危險，但值得賭」
- P4 回答：「好，但你最多只能賭 1–2%」
- 這樣系統才會不錯殺下一個 Tesla，也不會被下一個 WeWork 炸死

**實現方案**：
- 在 `calculateFinalAllocations()` 中添加 `risk_cap_percent` 計算
- 根據 FRONTIER Runway、Safety Grade、系統性風險（P0.5/P0.7）計算風險上限
- 應用上限：`final_position_amount = Math.min(calculated_position, portfolio_value * risk_cap_percent, max_position_cap_suggestion)`

---

### ✅ 4. P4 風險檢查（除以零風險、變數名稱對接、快照管理器、Batch/Standard 格式）

**評估結果**：✅ **需要檢查和修正**

**檢查結果**：

#### 4.1 變數名稱對接 ✅
- **現狀**：`runway_quarters` 已經正確使用
- **問題**：需要確認是否有 `parseFloat()` 處理（字串轉數字）
- **修正**：在讀取 `runway_quarters` 時添加 `parseFloat()` 或 `Number()` 轉換

#### 4.2 快照管理器 ✅
- **現狀**：使用 Sheet（`P2__SNAPSHOT`、`P3__SNAPSHOT` 等），不是 PropertiesService
- **結論**：✅ 正確，無需修正

#### 4.3 Batch/Standard 回傳格式 ⚠️
- **現狀**：`callOpenAI()` 和 `callGemini()` 只處理 Standard 格式
- **問題**：沒有明確區分 Batch 和 Standard 格式的處理邏輯
- **修正**：需要在 Adapter 中添加 `parseResponse(response, mode)` 函數，明確區分 Batch 和 Standard 格式

#### 4.4 Infinity 檢查 ⚠️
- **現狀**：`calculateFinalAllocations()` 中沒有檢查 `Infinity` 或 `NaN`
- **問題**：如果計算結果為 `Infinity` 或 `NaN`，會導致配置錯誤
- **修正**：在計算 `total_amount` 時添加 `isFinite()` 檢查

---

## 實現計劃

### 優先級 1：P1 Prompt 補丁
- 在 `buildP1Step2Prompt()` 中添加「結構分級原則」補丁

### 優先級 2：P2 Prompt 補丁
- 在 P2 Prompt 中修改 Runway 處理邏輯

### 優先級 3：P4 風控補丁
- 在 `calculateFinalAllocations()` 中添加 `risk_cap_percent` 計算

### 優先級 4：P4 風險檢查
- 添加 `parseFloat()` 處理 `runway_quarters`
- 添加 `Infinity` 和 `NaN` 檢查
- 檢查 Batch/Standard 回傳格式處理（如果需要）

---

## 實現狀態

- [ ] P1 Prompt 補丁
- [ ] P2 Prompt 補丁
- [ ] P4 風控補丁
- [ ] P4 風險檢查
