# P0.5 增強設計比對報告（V8.15）

**日期**：2026-01-19  
**版本**：V8.15  
**狀態**：📋 **比對完成（待定案）**

---

## 📋 現有設計（V8.14）摘要

### ✅ 已實現的功能

1. **Baseline Builder（第一次跑）**
   - 產業鏈節點拆解（上/中/下游）
   - 關鍵節點識別（Bottleneck、定價權、單點失效）
   - 強化 P0 選出產業的關鍵不可替代性
   - 風險識別（地緣政治、法規、供應鏈、技術）
   - 資金流與訂單流向（描述性）
   - 輸出格式：`industry_chain_map_json`

2. **職權邊界明確**
   - ✅ 只畫地圖，不下結論
   - ✅ 不判斷產業是否值得投資
   - ✅ 不進行長期前瞻敘事
   - ✅ 不判斷時機

3. **執行頻率**
   - 季度（與 P0 同步）

---

## 🎯 討論內容的核心要點

### 核心哲學轉變

**從「畫地圖」→「觀察上中下游行為是否一致」**

> 「我們做財務分析跟產業分析，做的再怎麼透徹，再怎麼詳細，也永遠比不上那個產業的人。所以直接觀察上中下游的連動關係，可以更準確地抓出這個產業現在處於甚麼樣的位置。」

### 關鍵設計原則

1. **不寫死情境與產業生態**
   - ❌ 不列固定情境（Case A/B/C）
   - ❌ 不列固定產業生態（製造/軟體/能源）
   - ✅ 讓 AI 根據產業生態自行建模

2. **雙模式設計**
   - **Mode 1: Baseline Builder**（第一次跑）
     - 尚未建立公司池（P1 尚未完成）
     - 只畫地圖，不做監控
     - 產出基準狀態
   - **Mode 2: Chain Dynamics Monitor**（後續）
     - P1 已建立公司池
     - 月度/季度監控上中下游行為一致性
     - 需要公司公布營收或財報

3. **三階段推理流程**
   - **Step 1: 產業生態識別**（Mandatory）
     - 該產業的核心驅動是什麼？（CapEx/R&D/政策/庫存/訂單能見度）
     - 財報數據相對於真實需求的「時間延遲」大約多久？
     - 哪一段（上/中/下游）最早反映真實變化？
   - **Step 2: 上中下游行為抽象**（標準化輸入）
     - 程式只提供結構化資料（不判斷、不貼標籤）
   - **Step 3: 一致性與異常推演**（AI 責任）
     - 依據 Step 1 定義的產業生態
     - 解釋目前上中下游行為是否：高度一致 / 正常延遲 / 結構性背離 / 非典型但可解釋
     - 若出現背離，提出 2-3 種可能解釋，並標示「需要進一步監控」或「已具轉折風險」

---

## 📊 比對結果

### ✅ 保留原設計（不需要改變）

1. **Mode 1: Baseline Builder**
   - ✅ 產業鏈地圖繪製（完全保留）
   - ✅ 關鍵節點識別（完全保留）
   - ✅ 風險識別（完全保留）
   - ✅ 職權邊界（完全保留）

2. **基本架構**
   - ✅ 執行頻率：季度（Mode 1）保留
   - ✅ AI 模型：Claude Opus 4.5（執行者）+ GPT-5.2（審查者）
   - ✅ 輸出格式：`industry_chain_map_json`（保留作為 Mode 1 輸出）

### ⭐ 需要增強的部分

#### 1. **雙模式設計**（必須實現）

**現狀**：只有 Mode 1（Baseline Builder）

**需要新增**：
- **Mode 2: Chain Dynamics Monitor**
  - 觸發條件：P1 已建立公司池 + 月度/季度更新
  - 輸入：P1 公司池 + P2 財務數據（營收、CapEx、庫存、訂單等）
  - 功能：監控上中下游行為一致性
  - 輸出格式：`chain_dynamics_monitor_json`（新增）

**實現方式**：
- 在 `P0_5_Execute()` 中判斷是否有 P1 公司池
- 如果有 → Mode 2（監控模式）
- 如果沒有 → Mode 1（Baseline Builder）

---

#### 2. **三階段推理流程**（必須實現）

**現狀**：Prompt 中沒有要求 AI 先識別產業生態

**需要新增**：
- **Step 1: 產業生態識別**（必須先完成）
  - 要求 AI 先回答產業核心驅動問題
  - 要求 AI 判斷財報數據時間延遲
  - 要求 AI 判斷最早反映段
  
- **Step 2: 上中下游行為抽象**（需要從 P1/P2 獲取數據）
  - 從 P1 公司池讀取公司列表（按上中下游分類）
  - 從 P2 財務數據讀取相關指標（營收、CapEx、庫存、訂單等）
  - 程式提供標準化數據給 AI（不判斷、不貼標籤）

- **Step 3: 一致性與異常推演**（AI 任務）
  - 要求 AI 根據 Step 1 的產業生態自行建模
  - 要求 AI 解釋上中下游行為是否一致
  - 要求 AI 識別異常並提出可能解釋

**實現方式**：
- 更新 `buildP0_5Prompt()` 加入三階段推理要求
- 新增 `collectChainBehaviorData()` 函數（從 P1/P2 讀取數據）
- 新增 `buildChainDynamicsPrompt()` 函數（Mode 2 專用 Prompt）

---

#### 3. **數據收集機制**（必須實現）⭐ **已確認數據來源**

**現狀**：沒有從公司池讀取財務數據的機制

**需要新增**：
- **從 P1 讀取公司池**：
  - 讀取 `Phase1_Company_Pool` 表格
  - 按 `Supply_Chain_Position`（Upstream/Midstream/Downstream）分類
  - 取得每個公司的 ticker 和基本資訊

- **從 P2 讀取財務數據**（⭐ 已確認）：
  - ✅ **從 P2 收集的最新當月(台股)當季(美日股)所有營收數據**
  - ✅ **P2 的台股營收要月度更新，美日股維持季度**
  - ✅ **以權威網站為主**
  - 讀取 `Phase2_Output` 表格
  - 提取相關指標：
    - **上游**：CapEx 趨勢（台股月營收 + 季報 CapEx proxy）、擴產計劃、交期變化、接單敘事
    - **中游**：營收趨勢、出貨/產能、庫存變化、毛利變化、產能利用率
    - **下游**：拉貨節奏（pull-in/push-out）、庫存/渠道措辭、終端需求能見度、訂單能見度

**實現方式**：
- 新增 `collectChainBehaviorData()` 函數
- 新增 `classifyCompaniesByChainPosition()` 函數
- 新增 `extractChainBehaviorIndicators()` 函數

---

#### 4. **輸出格式擴充**（必須實現）

**現狀**：只有 `industry_chain_map_json`（Mode 1 輸出）

**需要新增**：⭐ **Mode 2 輸出格式**：`chain_dynamics_monitor_json`（4 區結構）

```json
{
  "meta": {
    "version": "0.1",
    "as_of": "2026-02-10",
    "cadence": "MONTHLY" / "QUARTERLY",
    "industry_id": "AI_SERVERS",
    "universe_scope": {
      "us": true,
      "tw": true,
      "jp": true
    },
    "coverage_level": "TW_MONTHLY_US_QUARTERLY"
  },
  "signals": [
    {
      "signal_id": "S1",
      "signal_name": "demand_pull_downstream",
      "value": 75,
      "direction": "UP" | "DOWN" | "FLAT" | "DIVERGE",
      "strength": 0-100,
      "window": "1M" | "3M" | "6M",
      "evidence": {
        "source": "P2_Output",
        "tickers": ["AAPL", "MSFT"],
        "metric": "Revenue_YoY",
        "notes": "下游需求拉動（出貨/營收動能）"
      }
    },
    // ... 其他 7 個核心信號
  ],
  "diagnosis": {
    "current_chain_state": "ACCELERATING" | "HEALTHY_EXPANSION" | "LATE_TIGHTENING" | "INVENTORY_BUILD" | "DEMAND_SOFTENING" | "MIXED_SIGNALS" | "UNKNOWN",
    "state_confidence": "HIGH" | "MEDIUM" | "LOW",
    "state_rationale": "<= 120字（只允許引用 signals，不得引入外部敘事）",
    "industry_ecology_profile": "AI 針對該產業生態自動產出（如：長周期資本密集型 / 平台型 / 政策驅動型）",
    "anomalies": [
      {
        "pattern_id": "ANOMALY_001",
        "description": "上游CapEx放緩但中游仍擴張",
        "likely_explanations": [
          "新一代產品正在準備（世代交替）",
          "預期未來缺料，提前備庫存",
          "長約產業反應延遲"
        ],
        "what_to_watch_next": [
          "下季上游CapEx是否持續放緩",
          "中游庫存是否開始累積",
          "訂單能見度是否下降"
        ]
      }
    ]
  },
  "handoff": {
    "p0_7_evidence_pack": {
      "demand_trend": {"direction": "UP" | "DOWN" | "FLAT", "strength": 0-100},
      "capex_trend": {"direction": "UP" | "DOWN" | "FLAT", "strength": 0-100},
      "inventory_proxy": {"direction": "BUILD" | "DRAW" | "FLAT", "strength": 0-100},
      "pricing_tightness": {"direction": "TIGHT" | "LOOSENING" | "STABLE", "strength": 0-100},
      "divergence_flags": ["UPSTREAM_DOWNSTREAM_MISMATCH", ...],
      "notes": "短（不推論、只給證據）"
    },
    "p1_inputs": {
      "nodes_to_prioritize": ["UPSTREAM_001", "MIDSTREAM_001"],
      "nodes_to_watch_victims": ["DOWNSTREAM_001"],
      "risk_flags": ["STRUCTURAL_WEAKENING"]
    },
    "p2_inputs": {
      "capex_verification_priority": ["TSMC", "ASML"],
      "rpo_tracking_priority": ["NVDA", "AMD"],
      "executability_focus": "CapEx是否真的在動、RPO是否上升"
    },
    "p5_weekly_flags": {
      "LATE_CYCLE_RISK": true | false,
      "DIVERGENCE_ALERT": true | false,
      "INVENTORY_BUILD_WARNING": true | false,
      "PRICING_LOOSENING": true | false
    }
  },
  "p0_7_time_window_constraints": {
    "cycle_position": "Early" | "Mid" | "Late",
    "turning_point_risk": "LOW" | "MED" | "HIGH",
    "dominant_loops": ["R_LOOP_DEMAND", "B_LOOP_SUPPLY"],
    "key_delays": [
      {"name": "capacity coming online", "expected_months": 6},
      {"name": "pricing peak", "expected_months": 3}
    ],
    "watch_list": ["capacity coming online", "pricing peak", "inventory reversal"]
  }
}
```

**8 個核心信號（signals）**：
1. `demand_pull_downstream`：下游需求拉動（出貨/營收動能）
2. `capacity_build_upstream`：上游擴產/CapEx 動能（台股月營收 + 季報 CapEx proxy）
3. `inventory_pressure_midstream`：中游庫存/交期壓力
4. `pricing_power_node`：瓶頸節點是否仍有訂價權
5. `order_visibility`：訂單能見度（RPO/合約負債/Backlog proxy）
6. `substitution_pressure`：替代/被替代壓力
7. `capex_mismatch_divergence`：上游 vs 下游不同步異常偵測（王牌）
8. `credit_stress_chain`：產業鏈信用壓力

**實現方式**：
- 更新 `P0_5_SNAPSHOT_SCHEMA`，新增 `chain_dynamics_monitor_json` 欄位
- 更新 `saveP0_5Snapshot()` 函數處理新欄位

---

#### 5. **執行頻率調整**（需要明確）

**現狀**：執行頻率為季度（與 P0 同步）

**需要調整**：
- **Mode 1（Baseline Builder）**：季度（與 P0 同步，不變）
- **Mode 2（Chain Dynamics Monitor）**：月度或季度（需要公司公布營收或財報）
  - 判斷邏輯：如果本月/本季有公司公布財報 → 觸發監控
  - 如果沒有財報公布 → 跳過（不強制執行）

**實現方式**：
- 新增 `checkFinancialReportAvailability()` 函數
- 在 `P0_5_Execute()` 中判斷是否應該執行 Mode 2

---

#### 6. **與下游模組的銜接**（需要明確）

**現狀**：輸出只提供給 P1 作為參考

**需要增強**：
- **給 P0.7（系統動力學）**：
  - 如果 `coherence_assessment` = "明顯背離" 或 `risk_level` = "HIGH"
  - 提供給 P0.7 作為驗證訊號，強化 Turning Point Risk

- **給 P1（產業鏈定位）**：
  - 如果發現上游鬆動、替代節點活躍
  - 標記 Tier S/A 公司的 `risk_flag: STRUCTURAL_WEAKENING`

- **給 P2（成長/未來潛力）**：
  - 如果 `coherence_assessment` = "明顯背離"
  - 影響 Future Breakout Grade 上限（Time Window Penalty）

- **給 P5 Weekly（中央大腦）**：
  - 提供產業當前狀態（順風/亂流/即將轉向）
  - 作為策略制定的參考因子

**實現方式**：
- 在快照中保存 `chain_dynamics_monitor_json`
- 下游模組讀取快照時檢查此欄位

---

## 📝 增強項目清單

### 高優先級（必須實現）

1. ⭐ **雙模式設計**
   - [ ] 在 `P0_5_Execute()` 中判斷 Mode（檢查 P1 公司池是否存在）
   - [ ] Mode 1：保留現有 Baseline Builder 功能
   - [ ] Mode 2：新增 Chain Dynamics Monitor 功能

2. ⭐ **三階段推理流程**
   - [ ] 更新 Prompt，要求 AI 先完成 Step 1（產業生態識別）
   - [ ] 新增 `collectChainBehaviorData()` 函數（從 P1/P2 讀取數據）
   - [ ] 新增 `buildChainDynamicsPrompt()` 函數（Mode 2 專用 Prompt）

3. ⭐ **數據收集機制**
   - [ ] 新增 `classifyCompaniesByChainPosition()` 函數
   - [ ] 新增 `extractChainBehaviorIndicators()` 函數
   - [ ] 從 P1 讀取公司池（按上中下游分類）
   - [ ] 從 P2 讀取財務數據（營收、CapEx、庫存、訂單等）

4. ⭐ **輸出格式擴充**
   - [ ] 更新 `P0_5_SNAPSHOT_SCHEMA`，新增 `chain_dynamics_monitor_json` 欄位
   - [ ] 更新 `saveP0_5Snapshot()` 函數處理新欄位
   - [ ] 更新輸出格式，包含 `industry_ecosystem_model`、`chain_behavior_summary`、`coherence_assessment`、`anomaly_analysis` 等

5. ⭐ **執行頻率邏輯**
   - [ ] 新增 `checkFinancialReportAvailability()` 函數
   - [ ] Mode 2 只在有財報公布時執行

### 中優先級（建議實現）

6. ⭐ **與下游模組的銜接**
   - [ ] 在快照中保存 `chain_dynamics_monitor_json`
   - [ ] 更新 P0.7/P1/P2/P5 讀取快照時的檢查邏輯

---

## 🎯 設計原則總結

### 核心哲學

> **「與其試圖用財務模型猜產業，不如直接觀察上中下游彼此的真實行為是否一致。」**

### 關鍵原則

1. **不寫死情境與產業生態**
   - 讓 AI 根據產業生態自行建模
   - 禁止 if-then 情境硬編碼

2. **雙模式設計**
   - Mode 1：第一次跑，只畫地圖
   - Mode 2：後續監控，觀察行為一致性

3. **三階段推理**
   - Step 1：產業生態識別（必須先完成）
   - Step 2：行為抽象（程式提供數據）
   - Step 3：一致性推演（AI 責任）

4. **監控頻率**
   - Mode 2 只在有財報公布時執行（月度/季度）

5. **職權邊界**
   - P0.5 不下投資結論
   - 只提供狀態訊號給下游模組

---

## ✅ 確認事項（已確認）

1. **執行頻率**：
   - ✅ **Mode 2 是整個產業鏈的監控，不是單一公司**
   - ✅ **台股月度、美日股季度**
   - ✅ **台股月營收可以提前預判全球產業循環**（台股是上游，上游一轉全球會跟）
   - ✅ **這是 P0.5 + P5 Weekly 的優勢系統化**

2. **數據來源**：
   - ✅ **從 P2 收集的最新當月(台股)當季(美日股)所有營收數據**
   - ✅ **P2 的台股營收要月度更新，美日股維持季度**
   - ✅ **以權威網站為主**

3. **輸出格式**：
   - ✅ **不要寫散文，拆成 4 區：meta / signals / diagnosis / handoff**
   - ✅ **signals：8 個核心信號，統一格式**
   - ✅ **diagnosis：受限輸出，固定框架**
   - ✅ **handoff：給後續模組用的接口欄位**

4. **與 P0.7 的關係**：
   - ✅ **P0.5 → P0.7：提供 `p0_7_evidence_pack`（證據包）**
   - ✅ **P0.7 → P0.5：回寫 `p0_7_time_window_constraints`（時間窗口約束）**
   - ✅ **P0.5 只做偵測與推演，不做時間定位裁決**（禁止輸出 Early/Mid/Late 結論）

---

## 📋 下一步行動

1. **等待用戶確認**：比對報告是否正確理解需求
2. **討論待確認事項**：解決上述問題
3. **定案設計**：確認最終設計方案
4. **開始實現**：按照定案設計開始編碼

---

**此文檔完成 P0.5 增強設計比對，等待用戶確認後開始定案與實現。**
