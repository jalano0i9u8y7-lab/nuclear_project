# P6 盤中監測系統詳細規格

> **版本**：V8.0  
> **日期**：2025-01-17  
> **定位**：盤中風險雷達（Intraday Risk Radar），純程式處理，0 Token 成本

---

## 📋 一、系統架構總覽

### 1.1 核心定位

**P6 盤中監測系統** = **全天候風險哨兵**

- **不做**：盤中交易決策、AI 判斷、頻繁訊號
- **只做**：異常偵測、風險警報、緊急撤退觸發、目標價監控（台股）
- **成本**：$0（GOOGLEFINANCE + Rule-Based 邏輯）

---

### 1.2 監控對象

#### A. 持倉股票（最高優先級）
- **來源**：P4 最新快照（`allocations_json`）
- **數量**：動態（通常 20-50 檔）
- **監控頻率**：每 20 分鐘

#### B. 選擇權個股（特殊頻率）
- **識別方式**：檢查 `DERIVATIVES_DAILY` 表格，有期權數據的個股
- **監控頻率**：每 5 分鐘（更頻繁）
- **原因**：選擇權個股波動度通常較高，需要更密集監控

#### C. 主要指數（市場大盤）
- **美股**：
  - `INDEXSP:.INX`（S&P 500）
  - `INDEXNASDAQ:.IXIC`（NASDAQ）
  - `INDEXDJX:.DJI`（道瓊）
- **台股**：
  - `TPE:^TWII`（加權指數，需確認代碼）
- **日股**：
  - `TYO:^N225`（日經 225，需確認代碼）
- **監控頻率**：每 20 分鐘

#### D. 重大板塊 ETF
- **SPDR Sector ETFs**：
  - XLK, XLF, XLE, XLV, XLI, XLP, XLY, XLU, XLB, XLRE, XLC
- **監控頻率**：每 20 分鐘

#### E. 追蹤池股票（Phase1_Tracking_Pool）
- **來源**：Phase1_Tracking_Pool 表格
- **監控頻率**：每 20 分鐘
- **優先級**：中等

---

## ⏰ 二、觸發頻率與時間設定

### 2.1 監控頻率

#### 一般監控：每 20 分鐘
- **適用對象**：
  - 持倉股票（無選擇權）
  - 主要指數
  - 板塊 ETF
  - 追蹤池股票

#### 密集監控：每 5 分鐘
- **適用對象**：
  - 有選擇權的個股（從 `DERIVATIVES_DAILY` 識別）

---

### 2.2 市場開盤時間

#### 台股
- **開盤時間**：台灣時間 09:00 - 13:30
- **監控時段**：09:00 - 13:30（每 20 分鐘）
- **每日監控次數**：約 14 次（4.5 小時 ÷ 20 分鐘）

#### 日股
- **開盤時間**：台灣時間 08:00 - 14:00
- **監控時段**：08:00 - 14:00（每 20 分鐘）
- **每日監控次數**：約 18 次（6 小時 ÷ 20 分鐘）

#### 美股
- **開盤時間**：
  - 盤前：台灣時間 17:00 - 22:30（冬令）/ 16:00 - 21:30（夏令）
  - 盤中：台灣時間 22:30 - 05:00（冬令）/ 21:30 - 04:00（夏令）
  - 盤後：台灣時間 05:00 - 08:00（冬令）/ 04:00 - 07:00（夏令）
- **監控時段**：盤前 + 盤中 + 盤後（每 20 分鐘）
- **每日監控次數**：約 36 次（12 小時 ÷ 20 分鐘）

#### 選擇權個股（每 5 分鐘）
- **監控時段**：與所屬市場相同
- **每日監控次數**：約 72-144 次（取決於市場）

---

### 2.3 Time-driven Trigger 設定

#### 方案：統一 Trigger + 市場判斷
- **設定**：每 20 分鐘執行一次（全天候）
- **腳本內判斷**：
  - 檢查當前時間是否在市場開盤時段
  - 如果在開盤時段，執行監控
  - 如果不在開盤時段，跳過

#### 選擇權個股特殊處理
- **額外 Trigger**：每 5 分鐘執行一次（僅針對選擇權個股）
- **或**：在 20 分鐘循環中，優先處理選擇權個股

---

## 🗑️ 三、清除舊資料機制

### 3.1 資料保留策略

#### 原則：僅保留當天完整盤中監控資料

#### 清除時機
- **每日午夜 00:00**：清除前一天的資料
- **或**：每日第一次執行時檢查日期，如果日期變更，清除舊資料

#### 清除範圍
1. **P6_INTRADAY_ALERTS**：清除前一天的所有警報記錄
2. **P6_TARGET_ALERTS**：清除前一天的目標價警報
3. **P6_DEFCON_SIGNALS**：清除前一天的 DEFCON 信號
4. **P6_MONITOR_SNAPSHOT**：清除前一天的監控快照
5. **MONITOR_LIST**：保留（但清除 `last_check_price`、`last_alert_time` 等臨時欄位）

---

### 3.2 實現方式

#### 方案 1：每日午夜自動清除
- **Trigger**：Time-driven trigger，每日 00:00 執行
- **函數**：`P6_ClearOldData()`

#### 方案 2：首次執行時檢查
- **邏輯**：每次執行 `P6_RunIntradayMonitor()` 時
- **檢查**：當前日期 vs 上次執行日期
- **如果日期變更**：先清除舊資料，再執行監控

---

## ⚙️ 四、監控項目與波動度微調

### 4.1 監控項目（Rule-Based）

#### A. 單日跌幅/漲幅超閾值
- **邏輯**：`changepct <= threshold_drop` 或 `>= threshold_spike`
- **預設閾值**：
  - 跌幅：-6%
  - 漲幅：+8%
- **可微調因素**：
  - **市場特性**：台股波動度較高，可放寬至 -7% / +10%
  - **個股性質**：高 Beta 股票可放寬至 -8% / +12%

#### B. 20 分鐘內急殺/急拉
- **邏輯**：`(當前價 - 20分前價) / 20分前價 <= threshold_interval_drop` 或 `>= threshold_interval_spike`
- **預設閾值**：
  - 急殺：-2%
  - 急拉：+3%
- **可微調因素**：
  - **選擇權個股**：可放寬至 -1.5% / +2.5%（因為監控頻率更高）
  - **指數**：可放寬至 -1% / +1.5%（指數波動度較低）

#### C. 成交量異常（相對平均量）
- **邏輯**：`volume / volumeavg >= threshold_volume`
- **預設閾值**：2.5 倍
- **可微調因素**：
  - **小盤股**：可降低至 2.0 倍（小盤股爆量更容易）
  - **大盤股**：可提高至 3.0 倍（大盤股需要更大的量才異常）

#### D. 盤中高低幅度過大
- **邏輯**：`(high - low) / price >= threshold_range`
- **預設閾值**：7%
- **可微調因素**：
  - **台股**：可提高至 8%（台股波動度較高）
  - **日股**：可降低至 6%（日股波動度較低）

#### E. 目標價到價（僅台股）
- **邏輯**：
  - `price <= buy_target_price`（跌到買點）
  - `price >= sell_target_price`（漲到賣點）
- **緩衝區**：可設定 ±0.5% 緩衝，避免頻繁通知

---

### 4.2 波動度微調配置

#### 配置結構
```javascript
const P6_VOLATILITY_CONFIG = {
  // 市場特性調整
  market_adjustments: {
    "TW": {
      drop_threshold: -0.07,      // 台股：-7%
      spike_threshold: 0.10,       // 台股：+10%
      interval_drop: -0.02,       // 20分鐘急殺：-2%
      interval_spike: 0.03,        // 20分鐘急拉：+3%
      volume_threshold: 2.5,      // 爆量：2.5倍
      range_threshold: 0.08        // 振幅：8%
    },
    "US": {
      drop_threshold: -0.06,      // 美股：-6%
      spike_threshold: 0.08,       // 美股：+8%
      interval_drop: -0.02,
      interval_spike: 0.03,
      volume_threshold: 3.0,      // 美股大盤股需要更大爆量
      range_threshold: 0.07
    },
    "JP": {
      drop_threshold: -0.06,
      spike_threshold: 0.08,
      interval_drop: -0.015,       // 日股：-1.5%
      interval_spike: 0.025,       // 日股：+2.5%
      volume_threshold: 2.5,
      range_threshold: 0.06        // 日股：6%
    }
  },
  
  // 個股性質調整（Beta 係數）
  beta_adjustments: {
    "HIGH_BETA": {  // Beta > 1.5
      drop_threshold_multiplier: 1.2,    // 放寬 20%
      spike_threshold_multiplier: 1.2,
      interval_drop_multiplier: 1.15,
      interval_spike_multiplier: 1.15
    },
    "LOW_BETA": {   // Beta < 0.8
      drop_threshold_multiplier: 0.9,    // 收緊 10%
      spike_threshold_multiplier: 0.9,
      interval_drop_multiplier: 0.9,
      interval_spike_multiplier: 0.9
    }
  },
  
  // 選擇權個股調整（因為監控頻率更高，可放寬）
  options_adjustments: {
    drop_threshold_multiplier: 1.15,     // 放寬 15%
    spike_threshold_multiplier: 1.15,
    interval_drop: -0.015,                // 5分鐘急殺：-1.5%
    interval_spike: 0.025                 // 5分鐘急拉：+2.5%
  }
};
```

---

## 🎯 五、目標價監控（僅台股）

### 5.1 目標價來源

#### 從 P3 技術分析快照讀取
- **讀取**：`getLatestP3Snapshot()`
- **提取**：`technical_results_json` 中的買賣點
- **格式**：
  - `buy1_price`, `buy2_price`, `buy3_price`
  - `sell1_price`, `sell2_price`, `sell3_price`

#### 目標價設定邏輯
- **買入目標**：使用 `buy2_price` 或 `buy3_price`（較保守）
- **賣出目標**：使用 `sell1_price` 或 `sell2_price`（較保守）

---

### 5.2 到價通知邏輯

#### 緩衝區設定
- **買入緩衝區**：`price <= buy_target * 1.005`（允許 0.5% 誤差）
- **賣出緩衝區**：`price >= sell_target * 0.995`（允許 0.5% 誤差）

#### Cooldown 機制
- **同一目標價**：24 小時內只通知一次
- **避免重複通知**：記錄到 `P6_TARGET_ALERTS`，檢查是否已通知

---

## 🚨 六、整合撤退機制（P4.6）

### 6.1 盤中觸發 P4.6 的條件

#### 觸發條件（擴展版）

1. **單檔持倉暴跌**
   - **條件**：持倉股票單日跌幅 > 6%（或 20 分鐘內急殺 > 2%）
   - **動作**：觸發 P4.6，減倉該檔股票 50%

2. **持倉組合整體跌幅**
   - **條件**：持倉組合加權平均跌幅 > 5%
   - **動作**：觸發 P4.6，整體減倉 30%

3. **多檔同時爆量**
   - **條件**：3 檔以上持倉股票同時爆量（> 2.5 倍）
   - **動作**：觸發 P4.6，減倉爆量股票 40%

4. **主要指數暴跌**
   - **條件**：S&P 500 或 NASDAQ 單日跌幅 > 4%
   - **動作**：觸發 P4.6，整體減倉 25%

5. **DEFCON 盤中升級**
   - **條件**：DEFCON 盤中調整至 DEFCON_1 或 DEFCON_2
   - **動作**：觸發 P4.6，減倉比例根據 DEFCON 等級

---

### 6.2 撤退執行與記錄

#### 執行流程
```
P6 偵測異常 → 判斷觸發條件 → 調用 P4_6_EmergencyExit() → 
→ 生成撤退計劃 → 記錄到 P6_EMERGENCY_EXIT_LOG → 
→ 等待用戶確認（或自動執行，根據配置）
```

#### 記錄內容（P6_EMERGENCY_EXIT_LOG）
| 欄位 | 說明 |
|------|------|
| **exit_id** | 撤退 ID |
| **timestamp** | 觸發時間 |
| **trigger_type** | 觸發類型（P6_INTRADAY_DROP / P6_PORTFOLIO_DROP / P6_INDEX_DROP / P6_DEFCON_UPGRADE） |
| **trigger_details** | 觸發詳情（JSON） |
| **reduction_pct** | 減倉比例 |
| **stocks_to_sell** | 要賣出的股票列表（JSON） |
| **sell_quantities** | 每檔股票的賣出數量（JSON） |
| **execution_status** | 執行狀態（PENDING / EXECUTED / CANCELLED） |
| **p4_6_exit_plan** | P4.6 生成的撤退計劃（JSON） |

---

## 🛡️ 七、DEFCON 盤中調整機制

### 7.1 盤中 DEFCON 調整邏輯（純程式）

#### 調整觸發條件

1. **多檔急殺信號**
   - **條件**：5 檔以上持倉股票在 20 分鐘內急殺 > 2%
   - **調整**：DEFCON 臨時提高 1 級（例如 DEFCON_4 → DEFCON_3）

2. **主要指數暴跌**
   - **條件**：S&P 500 或 NASDAQ 單日跌幅 > 3%
   - **調整**：DEFCON 臨時提高 1 級

3. **異常爆量集中**
   - **條件**：3 檔以上持倉股票同時爆量（> 3 倍）
   - **調整**：DEFCON 臨時提高 0.5 級（流動性壓力增加）

4. **VIX 盤中飆升**
   - **條件**：VIX 盤中漲幅 > 15%（從開盤價）
   - **調整**：DEFCON 臨時提高 1 級

---

### 7.2 DEFCON 盤中調整實現

#### 調整邏輯（純程式）
```javascript
function adjustDEFCONIntraday(p6Signals, currentDEFCON) {
  let adjustment = 0;  // 調整級數（正數 = 提高風險，負數 = 降低風險）
  
  // 1. 多檔急殺檢查
  const rapidDropCount = p6Signals.filter(s => 
    s.alert_type === "RAPID_DROP" && s.alert_level === "CRITICAL"
  ).length;
  if (rapidDropCount >= 5) {
    adjustment += 1;
  }
  
  // 2. 主要指數暴跌檢查
  const indexDrop = p6Signals.find(s => 
    s.ticker.includes("INDEX") && s.change_pct <= -0.03
  );
  if (indexDrop) {
    adjustment += 1;
  }
  
  // 3. 異常爆量集中檢查
  const volumeSpikeCount = p6Signals.filter(s => 
    s.alert_type === "VOLUME_SPIKE" && s.volume_ratio >= 3.0
  ).length;
  if (volumeSpikeCount >= 3) {
    adjustment += 0.5;
  }
  
  // 4. VIX 盤中飆升檢查
  const vixSignal = p6Signals.find(s => s.ticker === "INDEXCBOE:VIX");
  if (vixSignal && vixSignal.change_pct >= 0.15) {
    adjustment += 1;
  }
  
  // 計算調整後的 DEFCON
  const defconLevels = ["DEFCON_1", "DEFCON_2", "DEFCON_3", "DEFCON_4", "DEFCON_5"];
  const currentIndex = defconLevels.indexOf(currentDEFCON);
  const newIndex = Math.max(0, Math.min(4, currentIndex + Math.round(adjustment)));
  
  return {
    original_defcon: currentDEFCON,
    adjusted_defcon: defconLevels[newIndex],
    adjustment: adjustment,
    reasons: [...]
  };
}
```

#### 記錄到 P6_DEFCON_SIGNALS
- **記錄內容**：調整前 DEFCON、調整後 DEFCON、調整原因、時間戳
- **用途**：P5 Weekly 計算 DEFCON 時，讀取盤中調整記錄，作為參考

---

## 📊 八、監控對象清單

### 8.1 持倉股票（從 P4 讀取）

#### 讀取方式
- **函數**：`getLatestP4Snapshot()`
- **提取**：`allocations_json` 中的 `ticker` 列表
- **格式轉換**：將系統 ticker 轉換為 GOOGLEFINANCE 格式
  - 美股：`NASDAQ:NVDA`, `NYSE:TSM`
  - 台股：`TPE:2330`
  - 日股：`TYO:8035`

---

### 8.2 主要指數

#### 美股指數
- **S&P 500**：`INDEXSP:.INX`
- **NASDAQ**：`INDEXNASDAQ:.IXIC`
- **道瓊**：`INDEXDJX:.DJI`
- **VIX**：`INDEXCBOE:VIX`

#### 台股指數
- **加權指數**：`TPE:^TWII`（需確認代碼）
- **或使用 ETF**：`TPE:0050`（台灣 50 ETF）

#### 日股指數
- **日經 225**：`TYO:^N225`（需確認代碼）
- **或使用 ETF**：`TYO:1321`（日經 225 ETF）

---

### 8.3 重大板塊 ETF

#### SPDR Sector ETFs（11 個）
- XLK, XLF, XLE, XLV, XLI, XLP, XLY, XLU, XLB, XLRE, XLC
- **格式**：`NYSEARCA:XLK`

---

### 8.4 選擇權個股識別

#### 識別方式
- **讀取**：`DERIVATIVES_DAILY` 表格
- **條件**：`put_call_ratio` 不為空 或 `iv_30d` 不為空
- **結果**：列出所有有選擇權數據的個股
- **特殊處理**：這些個股使用 5 分鐘監控頻率

---

## 📝 九、數據統整到 Daily

### 9.1 P6 異常記錄統整

#### 統整目標
- **表格**：`P5_DAILY_STATUS` 或新增 `P6_INTRADAY_SUMMARY`
- **內容**：當天所有 P6 監控異常的摘要

#### 統整內容

| 欄位 | 說明 |
|------|------|
| **date** | 日期 |
| **total_alerts** | 總警報數 |
| **critical_alerts** | Critical 級別警報數 |
| **rapid_drop_count** | 急殺警報數 |
| **volume_spike_count** | 爆量警報數 |
| **target_hit_count** | 目標價到價數（台股） |
| **p4_6_triggered** | 是否觸發 P4.6 |
| **defcon_adjustments** | DEFCON 盤中調整記錄（JSON） |
| **alerts_summary** | 警報摘要（JSON，包含前 10 筆重要警報） |
| **created_at** | 創建時間 |

---

### 9.2 成為 Weekly 策略來源

#### 整合到 P5 Weekly
- **讀取**：P5 Weekly 執行時，讀取當週的 P6 異常記錄
- **用途**：
  1. **風險評估**：盤中異常頻率 → 市場風險判斷
  2. **策略調整**：盤中急殺/爆量 → 是否需要調整持倉
  3. **DEFCON 參考**：盤中 DEFCON 調整 → 週級別 DEFCON 計算參考

#### 整合方式
- **P5 Weekly 讀取**：`getP6WeeklySummary(weekStartDate, weekEndDate)`
- **返回**：當週的 P6 異常統計和重要事件
- **納入策略制定**：作為 P5 Weekly 的輸入數據之一

---

## 🔔 十、通知機制（暫不實作 LINE Bot）

### 10.1 通知方式（第一階段）

#### 記錄到表格
- **P6_INTRADAY_ALERTS**：所有警報記錄
- **P6_TARGET_ALERTS**：目標價到價記錄
- **P6_EMERGENCY_EXIT_LOG**：緊急撤退記錄

#### 用戶查看方式
- **手動查看**：打開 Google Sheets，查看相關表格
- **或**：UI 側邊欄顯示最新警報（後續實作）

---

### 10.2 通知分級（簡化版）

#### 原則：除非極端情況，緊急通知頻率不高，不須特別分級

#### 極端情況定義
- **觸發 P4.6**：Critical 級別
- **DEFCON 升級至 DEFCON_1**：Critical 級別
- **主要指數暴跌 > 5%**：Critical 級別

#### 一般情況
- **其他警報**：統一記錄到表格，不分級
- **後續 UI 設計**：可以根據 `alert_type` 和 `trigger_value` 自動分級顯示

---

## 📋 十一、數據結構設計

### 11.1 MONITOR_LIST 表格（監控清單）

| 欄位 | 說明 | 數據來源 |
|------|------|---------|
| **ticker** | 股票代碼（GOOGLEFINANCE 格式） | 從 P4/P1/手動輸入 |
| **name** | 股票名稱 | 手動輸入或自動填充 |
| **market** | 市場（US/TW/JP） | 自動判斷 |
| **type** | 類型（STOCK/INDEX/ETF） | 自動判斷 |
| **priority** | 優先級（HOLDING/OPTIONS/INDEX/ETF/TRACKING） | 自動判斷 |
| **monitor_frequency** | 監控頻率（20/5 分鐘） | 自動判斷（選擇權=5分鐘） |
| **current_price** | `=GOOGLEFINANCE(ticker, "price")` | GOOGLEFINANCE |
| **changepct** | `=GOOGLEFINANCE(ticker, "changepct")` | GOOGLEFINANCE |
| **volume** | `=GOOGLEFINANCE(ticker, "volume")` | GOOGLEFINANCE |
| **volumeavg** | `=GOOGLEFINANCE(ticker, "volumeavg")` | GOOGLEFINANCE |
| **high** | `=GOOGLEFINANCE(ticker, "high")` | GOOGLEFINANCE |
| **low** | `=GOOGLEFINANCE(ticker, "low")` | GOOGLEFINANCE |
| **last_check_price** | 20 分鐘前價格（GAS 寫入） | GAS 腳本 |
| **last_check_time** | 上次檢查時間 | GAS 腳本 |
| **buy_target** | 買入目標價（僅台股，從 P3 讀取） | P3 快照 |
| **sell_target** | 賣出目標價（僅台股，從 P3 讀取） | P3 快照 |
| **last_alert_time** | 上次警報時間（防重複） | GAS 腳本 |
| **volatility_config** | 波動度配置（JSON，可微調） | 配置或自動判斷 |

---

### 11.2 P6_INTRADAY_ALERTS 表格（警報記錄）

| 欄位 | 說明 |
|------|------|
| **alert_id** | 警報 ID（格式：P6_ALERT_YYYYMMDD_HHMMSS_TICKER） |
| **timestamp** | 警報時間 |
| **date** | 日期（用於清除舊資料） |
| **ticker** | 股票代碼 |
| **name** | 股票名稱 |
| **market** | 市場 |
| **alert_type** | 警報類型（DAILY_DROP/DAILY_SPIKE/RAPID_DROP/RAPID_SPIKE/VOLUME_SPIKE/RANGE/TARGET） |
| **trigger_value** | 觸發數值 |
| **current_price** | 當前價格 |
| **change_pct** | 變化百分比 |
| **volume_ratio** | 成交量倍數（volume/volumeavg） |
| **interval_change_pct** | 20 分鐘內變化百分比 |
| **message** | 警報訊息 |
| **p4_6_triggered** | 是否觸發 P4.6（true/false） |
| **defcon_impact** | 對 DEFCON 的影響（JSON） |

---

### 11.3 P6_TARGET_ALERTS 表格（目標價警報，僅台股）

| 欄位 | 說明 |
|------|------|
| **alert_id** | 警報 ID |
| **timestamp** | 警報時間 |
| **date** | 日期 |
| **ticker** | 股票代碼 |
| **name** | 股票名稱 |
| **target_type** | 目標類型（BUY/SELL） |
| **target_price** | 目標價格 |
| **current_price** | 當前價格 |
| **p3_snapshot_id** | P3 快照 ID（追溯性） |
| **buy_level** | 買入級別（buy1/buy2/buy3） |
| **sell_level** | 賣出級別（sell1/sell2/sell3） |

---

### 11.4 P6_EMERGENCY_EXIT_LOG 表格（緊急撤退記錄）

| 欄位 | 說明 |
|------|------|
| **exit_id** | 撤退 ID |
| **timestamp** | 觸發時間 |
| **date** | 日期 |
| **trigger_type** | 觸發類型（P6_INTRADAY_DROP / P6_PORTFOLIO_DROP / P6_INDEX_DROP / P6_DEFCON_UPGRADE） |
| **trigger_details** | 觸發詳情（JSON） |
| **reduction_pct** | 減倉比例 |
| **stocks_to_sell** | 要賣出的股票列表（JSON） |
| **sell_quantities** | 每檔股票的賣出數量（JSON） |
| **execution_status** | 執行狀態（PENDING / EXECUTED / CANCELLED） |
| **p4_6_exit_plan** | P4.6 生成的撤退計劃（JSON） |
| **executed_at** | 執行時間（如果已執行） |

---

### 11.5 P6_DEFCON_SIGNALS 表格（DEFCON 盤中調整記錄）

| 欄位 | 說明 |
|------|------|
| **signal_id** | 信號 ID |
| **timestamp** | 時間戳 |
| **date** | 日期 |
| **original_defcon** | 原始 DEFCON 等級 |
| **adjusted_defcon** | 調整後 DEFCON 等級 |
| **adjustment** | 調整級數（+1, +0.5, -1 等） |
| **adjustment_reasons** | 調整原因（JSON） |
| **p6_signals_count** | 觸發的 P6 信號數量 |
| **impact_score** | 影響評分（0-100） |

---

### 11.6 P6_INTRADAY_SUMMARY 表格（每日摘要）

| 欄位 | 說明 |
|------|------|
| **date** | 日期 |
| **total_alerts** | 總警報數 |
| **critical_alerts** | Critical 級別警報數 |
| **rapid_drop_count** | 急殺警報數 |
| **rapid_spike_count** | 急拉警報數 |
| **volume_spike_count** | 爆量警報數 |
| **range_alert_count** | 振幅過大警報數 |
| **target_hit_count** | 目標價到價數（台股） |
| **p4_6_triggered_count** | 觸發 P4.6 次數 |
| **defcon_adjustments_count** | DEFCON 調整次數 |
| **defcon_final_level** | 當日最終 DEFCON 等級 |
| **alerts_summary** | 警報摘要（JSON，前 10 筆重要警報） |
| **created_at** | 創建時間 |

---

## 🔄 十二、執行流程設計

### 12.1 主執行函數：`P6_RunIntradayMonitor()`

#### 執行步驟

1. **檢查日期變更**
   - 如果日期變更，清除前一天資料

2. **讀取監控清單**
   - 從 P4 快照讀取持倉股票
   - 從 Phase1_Tracking_Pool 讀取追蹤池
   - 讀取主要指數和板塊 ETF
   - 識別選擇權個股

3. **更新 MONITOR_LIST**
   - 寫入 GOOGLEFINANCE 公式（如果尚未寫入）
   - 更新 `last_check_price`（殘影機制）

4. **執行監控檢查**
   - 讀取當前價格、漲跌幅、成交量等
   - 計算 20 分鐘內變化
   - 判斷各項監控條件

5. **生成警報**
   - 如果觸發條件，記錄到 `P6_INTRADAY_ALERTS`
   - 檢查是否觸發 P4.6
   - 檢查是否需要調整 DEFCON

6. **目標價監控（僅台股）**
   - 檢查是否到達目標價
   - 記錄到 `P6_TARGET_ALERTS`

7. **更新殘影**
   - 將當前價格寫入 `last_check_price`

8. **生成每日摘要**
   - 統計當天警報
   - 更新 `P6_INTRADAY_SUMMARY`

---

### 12.2 選擇權個股特殊處理

#### 額外執行函數：`P6_RunOptionsMonitor()`

- **頻率**：每 5 分鐘
- **對象**：僅選擇權個股
- **邏輯**：與主監控相同，但使用更頻繁的殘影更新（5 分鐘）

---

## 📊 十三、整合點總結

### 13.1 與 P4.6 整合
- **觸發**：P6 偵測異常 → 調用 `P4_6_EmergencyExit()`
- **記錄**：`P6_EMERGENCY_EXIT_LOG`
- **執行**：生成撤退計劃，記錄賣出股票和數量

### 13.2 與 DEFCON 整合
- **調整**：P6 盤中信號 → 調整 DEFCON 等級
- **記錄**：`P6_DEFCON_SIGNALS`
- **使用**：P5 Weekly 計算 DEFCON 時參考

### 13.3 與 P3 整合
- **讀取**：P3 快照中的目標價位
- **監控**：僅台股，到價通知

### 13.4 與 P4 整合
- **讀取**：P4 快照中的持倉列表
- **監控**：優先監控持倉股票

### 13.5 與 P5 Daily 整合
- **統整**：P6 異常記錄 → `P6_INTRADAY_SUMMARY`
- **用途**：P5 Daily 可以讀取當天 P6 摘要

### 13.6 與 P5 Weekly 整合
- **讀取**：當週的 P6 異常記錄
- **用途**：作為策略制定的數據來源之一

---

## 🎯 十四、實施優先級

### 第一階段（MVP）
1. ✅ 監控清單建立（持倉 + 指數 + ETF）
2. ✅ 基礎監控邏輯（單日跌幅/漲幅、成交量異常）
3. ✅ 清除舊資料機制
4. ✅ 記錄到表格（P6_INTRADAY_ALERTS）

### 第二階段
5. ✅ 20 分鐘變化監控（殘影機制）
6. ✅ 目標價監控（僅台股）
7. ✅ 選擇權個股特殊處理（5 分鐘頻率）

### 第三階段
8. ✅ 與 P4.6 整合
9. ✅ DEFCON 盤中調整機制
10. ✅ 每日摘要生成

### 第四階段
11. ✅ 與 P5 Daily/Weekly 整合
12. ✅ UI 顯示（後續與 LINE Bot 一起設計）

---

## ⚠️ 十五、注意事項

### 15.1 數據延遲
- **GOOGLEFINANCE 延遲**：15-20 分鐘
- **影響**：盤中監控有延遲，但對中長期投資可接受

### 15.2 市場開盤判斷
- **需要判斷**：當前時間是否在市場開盤時段
- **實現**：時間範圍檢查函數

### 15.3 選擇權個股識別
- **需要定期更新**：從 `DERIVATIVES_DAILY` 讀取
- **建議**：每日第一次執行時更新一次

### 15.4 波動度微調
- **初始配置**：使用預設值
- **後續優化**：根據實際運行情況調整

---

**生成時間**：2025-01-17  
**狀態**：待實施  
**建議**：分階段實施，先做 MVP，再逐步完善
