# V8.12 數據源測試檢查清單與建議

**日期**：2026-01-19  
**版本**：V8.12

---

## ✅ 已完成的工作

### 1. UI選單更新
- ✅ 已將三個測試功能分開為獨立按鈕（UI選單已更新）
- ✅ 菜單路徑：`🧪 數據源測試 (V8.12)` → 三個獨立選項

### 2. CSE配對確認
- ✅ **P5_NEWS** CSE：用於一般新聞收集
  - 配置位置：`02_M0_CONFIG.js` → `GOOGLE_CSE_CONFIG["P5_NEWS"]`
  - 使用位置：`24_P5_DAILY_NEWS.js` → `collectRawNews()` → `cse_type: "P5_NEWS"`
  - PropertiesService Key：`GOOGLE_CSE_CX_P5_NEWS`
  
- ✅ **P5_INSTITUTIONAL_RATINGS** CSE：用於機構評級收集
  - 配置位置：`02_M0_CONFIG.js` → `GOOGLE_CSE_CONFIG["P5_INSTITUTIONAL_RATINGS"]`
  - 使用位置：`24_P5_DAILY_INSTITUTIONAL_RATINGS.js` → `collectRatingsForTicker()` → `cse_type: "P5_INSTITUTIONAL_RATINGS"`
  - PropertiesService Key：`GOOGLE_CSE_CX_P5_INSTITUTIONAL_RATINGS`

- ✅ **市場數據**：不使用CSE，直接使用Google Finance API

### 3. 新聞收集數量調整
- ✅ 英文：50則
- ✅ 中文：25則
- ✅ 日文：25則
- ✅ 已在 `collectRawNews()` 中更新

### 4. 測試模式時效性調整
- ✅ 一般新聞測試：時效性放寬到前一天
- ✅ 機構評級測試：不限制時效性
- ✅ 已在相關函數中添加 `isTestMode` 參數支持

---

## 📋 三個測試功能說明

### 測試 1：Daily 市場數據測試

**功能**：`menuTestDailyMarketData()`

**測試內容**：
- 測試宏觀數據收集（油價、貴金屬、匯率、國債利率、VIX等）
- 檢查V8.12新增的所有Tier 1 + Tier 2數據是否正確收集
  - Tier 1：TLT波動率（MOVE Proxy）、LQD、RSP
  - Tier 2：BITO/IBIT、XME、LIT、REMX、URA、TAN、XLK、SOXX/SMH、IGV等

**測試方式**：
- 直接調用 `collectMacroData()`
- 檢查收集結果和Tier標記

---

### 測試 2：一般當日新聞測試

**功能**：`menuTestDailyNews()`

**測試重點**：
1. ✅ **收集數量**：英文50則、中文25則、日文25則
2. ✅ **時效性檢查**：測試模式放寬到前一天（正式版為當日±6小時）
3. ✅ **Flash清洗**：雜訊過濾、時效性檢查
4. ✅ **Gemini Pro處理**：
   - 多語去重
   - 多維度標籤分類（事件屬性、影響層級、情緒極性、關聯股票代碼）
5. ✅ **驗證機制**：數據驗證、Proxy驗證（使用Daily DB硬數據）
6. ✅ **個股索引**：建立反向索引（`STOCK_NEWS_INDEX_DAILY`）

**測試方式**：
- 調用 `collectNewsAtoms([], { isTestMode: true })`
- 檢查收集結果、多維度標籤、驗證標記、個股索引

**⚠️ 注意**：
- 測試時效性放寬到前一天（因為是當下直接抓，可能沒有當天的新聞）
- 正式版需要按照各地區時區與該地區媒體更新時間來調整時效性檢查

---

### 測試 3：機構評級新聞測試

**功能**：`menuTestInstitutionalRatings()`

**測試重點**：
1. ✅ **測試股票**：10檔隨機股票（美股5檔、台股3檔、日股2檔）
2. ✅ **時效性**：測試模式不限制時效性（正式版限制當日±6小時）
3. ✅ **Flash清洗**：雜訊過濾
4. ✅ **Gemini Pro處理**：多語去重
5. ✅ **個股索引**：建立反向索引（從收集結果統計）

**測試方式**：
- 調用 `collectInstitutionalRatings({ testTickers: [...], isTestMode: true })`
- 檢查收集結果、個股索引

**⚠️ 注意**：
- 正式版只抓持股與觀察清單
- 測試先不管時效性，先抓10檔隨機的來測試就好

---

## 🔍 CSE配對檢查

### ✅ 一般新聞 CSE
- **CSE類型**：`"P5_NEWS"`
- **配置檔案**：`02_M0_CONFIG.js` → `GOOGLE_CSE_CONFIG["P5_NEWS"]`
- **使用位置**：`24_P5_DAILY_NEWS.js` → `collectRawNews()` → `cse_type: "P5_NEWS"`
- **PropertiesService Key**：`GOOGLE_CSE_CX_P5_NEWS`
- **白名單網站**：reuters.com, ft.com, wsj.com, nikkei.com, 各國央行/財政部官網等

### ✅ 機構評級 CSE
- **CSE類型**：`"P5_INSTITUTIONAL_RATINGS"`
- **配置檔案**：`02_M0_CONFIG.js` → `GOOGLE_CSE_CONFIG["P5_INSTITUTIONAL_RATINGS"]`
- **使用位置**：`24_P5_DAILY_INSTITUTIONAL_RATINGS.js` → `collectRatingsForTicker()` → `cse_type: "P5_INSTITUTIONAL_RATINGS"`
- **PropertiesService Key**：`GOOGLE_CSE_CX_P5_INSTITUTIONAL_RATINGS`
- **白名單網站**：thefly.com, streetinsider.com, benzinga.com, anue.com.tw, minkabu.jp等

### ✅ 市場數據
- **不使用CSE**：直接使用Google Finance API（`fetchGoogleFinanceSafe`）

---

## 📝 測試建議與調整

### 1. 一般當日新聞測試

**✅ 已調整**：
- 收集數量：英文50則、中文25則、日文25則
- 測試模式時效性：放寬到前一天

**⚠️ 測試時需注意**：
- 時效性檢查在Flash清洗階段進行，測試模式會接受前一天的新聞
- 驗證機制會使用Daily DB數據（如果Daily DB沒有數據，驗證可能無法執行）
- 個股索引會自動建立（即使沒有關聯ticker的新聞也會處理）

**💡 建議**：
- 測試前先執行一次Daily市場數據測試，確保Daily DB有數據可供驗證使用
- 檢查Logger輸出，確認多維度標籤是否正確提取
- 檢查 `STOCK_NEWS_INDEX_DAILY` 表格是否正確建立

---

### 2. 機構評級新聞測試

**✅ 已調整**：
- 測試模式：接受testTickers參數，不限制時效性
- 個股索引：從收集結果自動統計

**⚠️ 測試時需注意**：
- 測試使用10檔隨機股票，正式版只抓持股與觀察清單
- 如果某檔股票沒有評級新聞，會返回空結果（這是正常的）
- CSE搜尋可能會返回舊新聞（測試模式不限制時效性）

**💡 建議**：
- 確認CSE後台白名單設定正確（thefly.com, anue.com.tw, minkabu.jp等）
- 檢查各市場的評級新聞是否正確收集（美股、台股、日股）
- 確認個股索引統計是否正確

---

### 3. Daily 市場數據測試

**✅ 已調整**：
- 新增所有V8.12要求的Tier 1 + Tier 2數據收集
- Tier標記機制已建立

**⚠️ 測試時需注意**：
- 某些ETF可能無法從Google Finance獲取（會嘗試CSE備援）
- TLT波動率（MOVE Proxy）可能需要特殊處理
- 檢查Tier 1和Tier 2數據是否都正確標記

**💡 建議**：
- 確認所有新增的ETF都能正確收集
- 檢查Tier標記是否正確（Tier 1 vs Tier 2）
- 確認數據源標記（GOOGLE_INTERNAL vs CSE_YAHOO_FINANCE）

---

## ⚠️ 待確認事項

### 1. PropertiesService配置
確認以下CSE CX ID已正確配置：
- `GOOGLE_CSE_CX_P5_NEWS`（一般新聞）
- `GOOGLE_CSE_CX_P5_INSTITUTIONAL_RATINGS`（機構評級）

### 2. CSE後台白名單設定
確認CSE後台已正確設定白名單：
- **P5_NEWS**：權威新聞媒體 + 官方敘事源
- **P5_INSTITUTIONAL_RATINGS**：The Fly、鉅亨網、Minkabu等快訊聚合網站

### 3. 正式版時效性調整
- 測試完成後，需要根據各地區時區與媒體更新時間調整時效性檢查
- 例如：美國媒體通常在美東時間早上更新，亞洲媒體在當地時間更新

---

## 🎯 測試執行順序建議

1. **先執行 Daily 市場數據測試**
   - 確保Daily DB有數據
   - 確認所有Tier 1 + Tier 2數據都能正確收集

2. **再執行 一般當日新聞測試**
   - 使用Daily DB數據進行驗證
   - 確認多維度標籤、驗證機制、個股索引都正常運作

3. **最後執行 機構評級新聞測試**
   - 確認CSE配對正確
   - 確認個股索引統計正確

---

## 📊 測試結果檢查重點

### 一般當日新聞測試結果檢查：
- ✅ 收集到的新聞數量是否符合預期（總數應接近100則）
- ✅ 多維度標籤是否正確提取（event_type, impact_scope, sentiment_polarity）
- ✅ 關聯股票代碼是否正確提取（related_tickers_json）
- ✅ 驗證標記是否正確（data_verification, narrative_direction等）
- ✅ 個股索引是否正確建立（STOCK_NEWS_INDEX_DAILY表格）

### 機構評級新聞測試結果檢查：
- ✅ 收集到的評級數量
- ✅ 各市場（美股/台股/日股）是否都有收集到數據
- ✅ 個股索引統計是否正確

### Daily 市場數據測試結果檢查：
- ✅ 所有Tier 1數據是否都收集到
- ✅ 所有Tier 2數據是否都收集到
- ✅ Tier標記是否正確

---

**狀態**：✅ **所有測試功能已實現，可開始測試**
