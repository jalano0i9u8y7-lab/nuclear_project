# V8.13 Weekly決策Memory Pack整合設計

**日期**：2026-01-19  
**目標**：說明每週Weekly做決策時，如何提供歷史學習經驗給AI，以及使用什麼prompt

---

## 🎯 核心流程

### 每週Weekly決策時的流程

1. **Step 1：生成Market Tags和Executive Summary**
   - 使用`generateMarketTags()`生成當前市場標籤
   - 使用`generateExecutiveSummary()`生成本週短摘要（<=300字）

2. **Step 2：組裝Memory Pack**
   - 使用`buildWeeklyMemoryPack(currentContext)`組裝三層記憶
   - 包含：Principles、Short-term Memory（最近4週）、Contextual Recall（相似歷史案例）

3. **Step 3：整合到Weekly Prompt**
   - 在`buildP5WeeklyIntegratedPrompt()`中整合Memory Pack
   - 將Memory Pack格式化為prompt的一部分

4. **Step 4：AI決策**
   - AI根據Memory Pack中的歷史學習經驗調整策略
   - AI自己判斷如何用過去的經驗調整現在的策略

---

## 📐 Memory Pack結構

### 三層漏斗（固定順序）

#### Layer 1: Principles（憲法，永不砍）
- **來源**：`P5__LEARNING_STATE.principles_summary`
- **內容**：長期原則（Markdown，<=12條）
- **用途**：給AI的憲法級原則，禁止修改SSOT憲法級原則

#### Layer 2: Short-term Memory（最近4週）
- **來源**：`P5__STRATEGY_SNAPSHOT` + `P5__OUTCOME_SNAPSHOT`
- **內容**：每週的`executive_summary` + `scorecard` + `top_lessons`（只取top 2 lessons）
- **用途**：讓AI知道最近4週發生了什麼，策略結果如何

#### Layer 3: Contextual Recall（相似歷史案例，Top 3-5）
- **來源**：使用`retrieveSimilarCases(currentTags)`檢索
- **內容**：每個案例只包含：
  - 情境tags
  - 1段教訓（lesson）
  - 1行結果（return/mdd）
  - evidence ids
- **用途**：讓AI知道歷史上相似情境下發生了什麼，避免重複錯誤

---

## 🔧 Prompt整合設計

### 現有Prompt結構（`buildP5WeeklyIntegratedPrompt`）

目前的prompt包含：
- 宏觀世界觀分析
- 個股策略分析
- 歷史世界觀更新（最近4週）
- 歷史學習日誌（最近4週）

### 需要整合Memory Pack的部分

**新增Memory Pack Section**：

```markdown
## 📚 歷史學習經驗（Memory Pack）

### Layer 1: 長期原則（Principles）
${memoryPack.layer_1_principles || "無"}

### Layer 2: 短期記憶（最近4週）
${memoryPack.layer_2_short_term.map(week => `
**${week.period_id}**：
- 摘要：${week.executive_summary}
- Scorecard：準度${(week.scorecard.accuracy * 100).toFixed(1)}%，MDD ${week.scorecard.max_drawdown.toFixed(1)}%
- 教訓：${week.top_lessons.join('; ')}
`).join('\n')}

### Layer 3: 相似歷史案例（Contextual Recall）
${memoryPack.layer_3_contextual_recall.map(case_ => `
**案例 ${case_.snapshot_id}**（標籤：${case_.tags.join(', ')}）：
- 教訓：${case_.lesson.join('; ')}
- 結果：${case_.result_summary}
- 證據ID：${case_.evidence_ids.join(', ')}
`).join('\n')}

**重要**：
- 這些歷史經驗僅供參考，AI需要根據當前情況判斷如何應用
- 不得直接複製歷史策略，必須根據當前市場狀態調整
- 如果歷史案例顯示高風險（MDD>5%），需要提高風險控制
```

---

## 🚀 實施步驟

### Step 1: 在Weekly Core中整合Memory Pack

**位置**：`src/24_P5_WEEKLY_CORE.js` → Step 9（構建整合Prompt之前）

**新增代碼**：
```javascript
// ========================================
// Step 8.5: ⭐ V8.13新增：組裝Memory Pack
// ========================================

Logger.log("P5 Weekly V8.13：開始組裝Memory Pack");
const currentContext = {
  market_tags: generateMarketTags(allData.macro_data, worldview),
  worldview: worldview,
  events: events
};

const memoryPack = buildWeeklyMemoryPack(currentContext);
Logger.log(`P5 Weekly V8.13：Memory Pack組裝完成 - Principles: ${memoryPack.layer_1_principles ? '有' : '無'}, Short-term: ${memoryPack.layer_2_short_term.length}週, Contextual: ${memoryPack.layer_3_contextual_recall.length}案例`);
```

### Step 2: 修改Prompt構建函數

**位置**：`src/24_P5_WEEKLY_PROMPT.js` → `buildP5WeeklyIntegratedPrompt()`

**新增參數**：
```javascript
function buildP5WeeklyIntegratedPrompt(data) {
  const {
    worldview = {},
    events = {},
    stockStrategies = {},
    allData = {},
    memoryPack = null  // ⭐ V8.13新增：Memory Pack
  } = data;
  
  // ... 現有prompt內容 ...
  
  // ⭐ V8.13新增：Memory Pack Section
  let memoryPackSection = "";
  if (memoryPack) {
    memoryPackSection = formatMemoryPackForPrompt(memoryPack);
  }
  
  return `
    ${existingPrompt}
    
    ${memoryPackSection}
  `;
}
```

### Step 3: 實現Memory Pack格式化函數

**位置**：`src/24_P5_WEEKLY_PROMPT.js`（新增函數）

**函數**：
```javascript
/**
 * 格式化Memory Pack為Prompt格式 ⭐ V8.13新增
 * 
 * @param {Object} memoryPack - Memory Pack
 * @returns {string} formattedMemoryPack - 格式化後的Memory Pack（用於prompt）
 */
function formatMemoryPackForPrompt(memoryPack) {
  let formatted = "\n## 📚 歷史學習經驗（Memory Pack）\n\n";
  
  // Layer 1: Principles
  formatted += "### Layer 1: 長期原則（Principles）\n\n";
  if (memoryPack.layer_1_principles) {
    formatted += memoryPack.layer_1_principles + "\n\n";
  } else {
    formatted += "無（尚未建立長期原則）\n\n";
  }
  
  // Layer 2: Short-term Memory
  formatted += "### Layer 2: 短期記憶（最近4週）\n\n";
  if (memoryPack.layer_2_short_term && memoryPack.layer_2_short_term.length > 0) {
    for (const week of memoryPack.layer_2_short_term) {
      formatted += `**${week.period_id || '未知週期'}**：\n`;
      formatted += `- 摘要：${week.executive_summary || '無'}\n`;
      if (week.scorecard) {
        formatted += `- Scorecard：準度${((week.scorecard.accuracy || 0) * 100).toFixed(1)}%，MDD ${(week.scorecard.max_drawdown || 0).toFixed(1)}%\n`;
      }
      if (week.top_lessons && week.top_lessons.length > 0) {
        formatted += `- 教訓：${week.top_lessons.join('; ')}\n`;
      }
      formatted += "\n";
    }
  } else {
    formatted += "無（尚未有足夠的歷史數據）\n\n";
  }
  
  // Layer 3: Contextual Recall
  formatted += "### Layer 3: 相似歷史案例（Contextual Recall）\n\n";
  if (memoryPack.layer_3_contextual_recall && memoryPack.layer_3_contextual_recall.length > 0) {
    for (const case_ of memoryPack.layer_3_contextual_recall) {
      formatted += `**案例 ${case_.snapshot_id || '未知'}**（標籤：${(case_.tags || []).join(', ') || '無'}）：\n`;
      if (case_.lesson && case_.lesson.length > 0) {
        formatted += `- 教訓：${case_.lesson.join('; ')}\n`;
      }
      if (case_.result_summary) {
        formatted += `- 結果：${case_.result_summary}\n`;
      }
      if (case_.evidence_ids && case_.evidence_ids.length > 0) {
        formatted += `- 證據ID：${case_.evidence_ids.join(', ')}\n`;
      }
      formatted += "\n";
    }
  } else {
    formatted += "無（尚未找到相似歷史案例）\n\n";
  }
  
  // 重要提醒
  formatted += "**重要**：\n";
  formatted += "- 這些歷史經驗僅供參考，AI需要根據當前情況判斷如何應用\n";
  formatted += "- 不得直接複製歷史策略，必須根據當前市場狀態調整\n";
  formatted += "- 如果歷史案例顯示高風險（MDD>5%），需要提高風險控制\n";
  formatted += "- 如果歷史案例顯示成功經驗，可以參考但不可盲目複製\n\n";
  
  return formatted;
}
```

---

## 📋 完整Prompt結構（整合後）

### 1. 任務目標
- 宏觀世界觀分析
- 個股策略生成

### 2. 本週數據
- 宏觀數據
- 市場數據
- 新聞數據
- 技術指標

### 3. 歷史學習經驗（Memory Pack）⭐ V8.13新增
- **Layer 1: Principles**（長期原則）
- **Layer 2: Short-term Memory**（最近4週）
- **Layer 3: Contextual Recall**（相似歷史案例）

### 4. 歷史世界觀更新（最近4週）
- 保留現有功能

### 5. 歷史學習日誌（最近4週）
- 保留現有功能

### 6. 輸出格式要求
- 保留現有功能

---

## ⚠️ 重要提醒

### AI如何使用Memory Pack

1. **參考而非複製**：
   - AI應該參考歷史經驗，但不應該直接複製歷史策略
   - 必須根據當前市場狀態調整

2. **風險控制**：
   - 如果歷史案例顯示高風險（MDD>5%），AI應該提高風險控制
   - 如果歷史案例顯示成功經驗，可以參考但不可盲目複製

3. **Principles的權威性**：
   - Principles是憲法級原則，AI必須遵守
   - 但AI可以根據當前情況靈活應用

4. **Token控制**：
   - Memory Pack必須控制token，不超載
   - 如果超出預算，先砍Layer 3，再砍Layer 2最舊

---

## 🚀 實施檢查清單

- [ ] 在`24_P5_WEEKLY_CORE.js`中整合Memory Pack組裝
- [ ] 在`24_P5_WEEKLY_PROMPT.js`中新增`formatMemoryPackForPrompt()`函數
- [ ] 修改`buildP5WeeklyIntegratedPrompt()`整合Memory Pack
- [ ] 測試Memory Pack是否正確組裝
- [ ] 測試Prompt是否正確包含Memory Pack
- [ ] 測試AI是否正確使用Memory Pack

---

**此文檔定義了Weekly決策時如何提供歷史學習經驗給AI，以及如何整合到prompt中。**
