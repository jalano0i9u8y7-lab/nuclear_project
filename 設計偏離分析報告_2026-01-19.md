# 設計偏離分析報告

**報告時間**：2026-01-19  
**問題**：程式設計偏離原計劃設計概念

---

## 🔍 問題分析

### 1. **原設計概念（從SSOT和對話歷史推斷）**

根據用戶的明確要求：
> "我們要抓的新聞不是所有財經的新聞都要，然後給後續處理做篩選去重跟分類十大類嗎?"

**原設計應該是**：
- ✅ **收集所有財經新聞**（不限於特定ticker）
- ✅ **由後續AI處理進行篩選、去重、分類**
- ✅ **分類為十大類**（市場概況、財報、IPO/M&A、監管、宏觀經濟、板塊輪動、衍生品、技術分析、籌碼面、其他）

### 2. **實際實現（偏離）**

**當前實現**：
- ❌ **針對每個ticker收集新聞**（`collectRawNews(tickers)` 函數中為每個ticker構建搜尋查詢）
- ❌ **搜尋查詢格式**：`${ticker} stock news today`、`${ticker} 股票 新聞 今日`、`${ticker} 株価 ニュース 今日`
- ❌ **結果**：只收集與特定ticker相關的新聞，無法測試CSE的蒐集新聞品質以及後續AI清洗跟去重的能力

### 3. **偏離原因分析**

**可能原因**：
1. **測試版簡化**：為了快速測試單一標的（AAPL）的新聞收集流程，臨時簡化為針對特定ticker
2. **理解偏差**：可能誤解了設計需求，認為應該針對持股清單收集新聞
3. **實現順序問題**：先實現了針對ticker的版本，但忘記改回收集所有財經新聞的版本

**嚴重性評估**：
- ⚠️ **如果是一開始就偏離**：**嚴重** - 需要立即修正並建立對照機制
- ⚠️ **如果是測試版簡化**：**中等** - 需要明確標記為測試版，並在正式版恢復

---

## 📋 原設計概念（需要保留的計劃案）

### P5 Daily 新聞收集設計（正確版本）

#### 1. **收集範圍**
- ✅ **收集所有財經新聞**（不限於特定ticker）
- ✅ **使用通用財經新聞搜尋查詢**（多語支持）
- ✅ **由後續AI處理識別相關ticker**（如果有）

#### 2. **搜尋查詢設計**
```
英文：
- "financial news today"
- "stock market news today"
- "business news today"
- "economic news today"

中文：
- "財經新聞 今日"
- "股市新聞 今日"
- "經濟新聞 今日"
- "金融新聞 今日"

日文：
- "金融ニュース 今日"
- "株式市場ニュース 今日"
- "経済ニュース 今日"
```

#### 3. **後續處理流程**
1. **CSE搜尋** → 收集原始新聞（所有財經新聞）
2. **Gemini Flash原子化清洗** → 過濾雜訊、提取核心資訊
3. **Gemini Pro多語去重** → 識別同一事件的不同語言版本
4. **Gemini Pro分類** → 分類為十大類
5. **AI識別相關ticker** → 如果有提到特定股票，標記相關ticker

#### 4. **數據結構**
- `ticker` 欄位：**可為null**（如果新聞不涉及特定股票，則為null）
- `category` 欄位：**必須分類為十大類之一**
- `source` 欄位：**必須正確識別來源**（從URL提取）

---

## 🔧 修正方案

### 1. **立即修正**
- ✅ 已修正 `collectRawNews()` 函數，改為收集所有財經新聞
- ✅ 搜尋查詢改為通用財經新聞查詢（多語支持）
- ✅ `ticker` 欄位改為 `null`，由後續AI處理識別

### 2. **測試版要求**
根據用戶要求：
- **新聞測試版**：先去抓英語中文日語新聞各十篇，然後完成後續步驟
- **機構評級新聞**：因為今天不一定有新的機構評級，所以先看白名單CSE內有沒有足夠非當日評級，測試版先不要求當日最新，但正式版未來要恢復

### 3. **建立對照機制**
- ✅ 創建本報告文檔，記錄原設計概念
- ✅ 在SSOT中明確標註P5 Daily新聞收集的設計
- ✅ 建立設計對照檢查清單

---

## 📝 設計對照檢查清單

### P5 Daily 新聞收集
- [x] **收集範圍**：所有財經新聞（不限於特定ticker）✅
- [x] **搜尋查詢**：通用財經新聞查詢（多語支持）✅
- [x] **後續處理**：AI篩選、去重、分類✅
- [x] **分類系統**：十大類分類✅
- [x] **ticker識別**：由AI處理識別相關ticker✅

### P5 Daily 機構評級收集
- [x] **收集範圍**：只收錄有持股的歷史評級✅
- [x] **時效性要求**：測試版不要求當日最新，正式版恢復✅
- [x] **後續處理**：AI原子化清洗、多語去重✅
- [x] **數據存儲**：按機構分開存儲✅

---

## 🎯 後續行動

1. **更新SSOT**：明確標註P5 Daily新聞收集的正確設計
2. **修正測試版**：按照用戶要求，抓取英語中文日語新聞各十篇
3. **修正機構評級**：測試版不要求當日最新，但保留正式版要求
4. **建立檢查機制**：每次實現新功能前，先對照SSOT確認設計

---

**報告生成時間**：2026-01-19  
**狀態**：已修正並建立對照機制
