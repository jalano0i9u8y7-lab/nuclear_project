# V8.17 工程地雷修復報告

## 修復日期
2026-01-19

## 修復項目

### ✅ 地雷 1：AI 記憶體無限膨脹（100% 必須修）

**問題**：
- 每週儲存決策回顧，會無限累積
- Google Sheets 50,000 字限制
- Token 成本爆炸
- 路徑依賴（Policy Lock-in）

**修復方案**：三層記憶模型（Memory Layering）

**實現位置**：`src/24_P5_WEEKLY_MEMORY_MANAGER.js`

**實現內容**：
- **L1 STM（Short-Term Memory）**：最近 6 週完整保留
- **L2 MTM（Mid-Term Memory）**：7-12 週壓縮為「Decision → Outcome → Lesson」
- **L3 LTM（Long-Term Memory）**：超過 12 週，每週最多 2 條「可遷移教訓」
- **自動壓縮和歸檔**：`compressAndArchiveOldMemory()` 函數自動執行
- **Token Budget 控制**：按優先級裁切（L5 → L4 → L3 → L2）

**新增函數**：
- `readMidTermMemory()` - 讀取中期記憶（壓縮版）
- `readLongTermMemory()` - 讀取長期記憶（只保留教訓）
- `compressAndArchiveOldMemory()` - 自動壓縮和歸檔舊記憶

**配置**：
```javascript
const MEMORY_LAYER_CONFIG = {
  L1_STM_WEEKS: 6,      // L1: 最近 6 週完整保留
  L2_MTM_WEEKS: 6,      // L2: 7-12 週（6週）壓縮
  L3_LTM_MAX_LESSONS: 2 // L3: 超過 12 週，每週最多 2 條教訓
};
```

**價值**：
- AI 不會失憶，但不會被自己過去綁架
- 防止記憶無限膨脹
- 控制 Token 成本
- 避免路徑依賴

---

### ✅ 地雷 2：GAS 6 分鐘斷頭台（100% 必須修）

**問題**：
- GAS 單次執行限制（6 分鐘，企業版 30 分鐘）
- 處理 100 檔股票可能超時
- 狀態標記可能卡在 "RUNNING"
- 部分更新導致邏輯不一致

**修復方案**：可重入設計（Re-entrant Design）

**實現位置**：
- `src/24_P5_WEEKLY_REENTRANT.js`（新建）
- `src/24_P5_WEEKLY_CORE.js`（整合）

**實現內容**：
- **原子操作**：每檔股票處理完成後立即寫入結果
- **狀態可回復**：系統啟動時載入已處理股票列表
- **邏輯一致性**：任何 crash 都不會造成邏輯不一致
- **處理狀態追蹤**：`P5__WEEKLY_PROCESSING_STATE` 表格追蹤每檔股票狀態

**Weekly Processing Contract**：
- 每支 ticker 處理完成後：`writeResult(ticker)` + `markProcessed(ticker, timestamp)`
- 系統啟動時：`loadProcessedTickers()` + skip already processed
- 系統結束時：only mark `WEEKLY_DONE` if all tickers processed

**新增函數**：
- `loadProcessedTickers(weekId)` - 載入已處理股票列表
- `markTickerProcessing(weekId, ticker)` - 標記股票為處理中
- `markTickerCompleted(weekId, ticker, result)` - 標記股票為已完成
- `markTickerFailed(weekId, ticker, errorMessage)` - 標記股票為失敗
- `processTickerReentrant(weekId, ticker, processFunction, context)` - 可重入處理單檔股票
- `checkAllTickersCompleted(weekId, allTickers)` - 檢查所有股票是否處理完成
- `markWeeklyDone(weekId)` - 標記週次為完成

**價值**：
- 即使中途死 3 次，也不會亂
- 狀態可回復，不會卡在 "RUNNING"
- 部分更新不會導致邏輯不一致

---

### ✅ 地雷 3：殭屍 Trigger 堆疊（100% 必須修）

**問題**：
- 動態建立的 Trigger 如果程式崩潰可能不會被刪除
- 觸發器數量達到上限（20個）
- 系統徹底癱瘓，無法建立新任務

**修復方案**：命名空間 + 清掃機制

**實現位置**：`src/26_TRIGGER_SETUP.js`

**實現內容**：
- **命名空間清掃**：`cleanTriggersByNamespace(prefix)` 函數
- **系統啟動順序**：`systemBootSequence()` 函數
- **狀態驗證**：`validateSystemState()` 函數

**System Boot Sequence**：
1. Clean triggers (weekly_*, batch_*, p5_*, p6_*)
2. Validate system state
3. Create fresh triggers

**新增函數**：
- `cleanTriggersByNamespace(prefix)` - 按命名空間清掃觸發器
- `systemBootSequence()` - 系統啟動順序
- `validateSystemState()` - 驗證系統狀態

**價值**：
- 確保「只有一個我在跑」
- 防止觸發器數量達到上限
- 防止殭屍觸發器堆疊

---

### ✅ 地雷 4：人類訊號被 AI 覆蓋（哲學 + 工程雙重致命）

**問題**：
- AI 可能覆蓋人類手動決策
- 系統本質上不可控
- 治理失敗

**修復方案**：Human Lock 機制

**實現位置**：
- `src/25_UI_HUMAN_SIGNAL.js`（Human Lock 管理）
- `src/24_P5_WEEKLY_FINAL_OUTPUT.js`（檢查 Human Lock）
- `src/01_SHEETS_STRUCTURE.js`（Schema 更新）

**實現內容**：
- **優先級層級**：Human LOCK > Risk Kill Switch > AI Strategy > Programmatic Adjustment
- **Human Lock 配置**：`{locked, action, reason, timestamp, expiry}`
- **狀態鎖檢查**：在 P5 Weekly 寫入前檢查 Human Lock
- **覆蓋日誌**：記錄所有 Human Override 操作

**新增函數**：
- `checkHumanLock(ticker)` - 檢查是否有鎖定的人類決策
- `applyHumanLockIfExists(ticker, aiStrategy)` - 應用 Human Lock
- `logHumanOverride(ticker, humanDecision)` - 記錄 Human Override 日誌

**Schema 更新**：
- `HUMAN_SIGNAL_SCHEMA` 新增 `human_lock_json` 欄位
- 新增 `type: "TRADE_ACTION"` 類型

**價值**：
- Human = Governor，不是 Analyst
- 人類永遠在最上層
- 系統可控，不會被 AI 無視

---

## 修改檔案

1. **`src/24_P5_WEEKLY_MEMORY_MANAGER.js`**
   - 實現三層記憶模型
   - 新增 `readMidTermMemory()`, `readLongTermMemory()`, `compressAndArchiveOldMemory()` 函數
   - 更新 `buildWeeklyMemoryPack()` 使用三層記憶模型

2. **`src/24_P5_WEEKLY_REENTRANT.js`**（新建）
   - 實現可重入設計
   - 新增所有可重入處理函數

3. **`src/24_P5_WEEKLY_CORE.js`**
   - 整合可重入邏輯
   - 在處理股票前檢查已處理狀態
   - 在所有股票處理完成後標記週次為完成

4. **`src/26_TRIGGER_SETUP.js`**
   - 實現命名空間清掃機制
   - 新增 `cleanTriggersByNamespace()`, `systemBootSequence()`, `validateSystemState()` 函數
   - 更新 `setupAllTriggers()` 使用系統啟動順序

5. **`src/25_UI_HUMAN_SIGNAL.js`**
   - 實現 Human Lock 機制
   - 新增 `checkHumanLock()`, `applyHumanLockIfExists()`, `logHumanOverride()` 函數
   - 更新 `UI_SubmitHumanSignal()` 支援 Human Lock 配置

6. **`src/24_P5_WEEKLY_FINAL_OUTPUT.js`**
   - 在生成最終產出前檢查 Human Lock
   - 如果存在 Human Lock，跳過 AI 策略，應用人類決策

7. **`src/01_SHEETS_STRUCTURE.js`**
   - 更新 `HUMAN_SIGNAL_SCHEMA` 新增 `human_lock_json` 欄位
   - 新增 `type: "TRADE_ACTION"` 類型

---

## 總結

✅ **所有 4 個地雷已修復**

- 地雷 1：AI 記憶體無限膨脹 ✅
- 地雷 2：GAS 6 分鐘斷頭台 ✅
- 地雷 3：殭屍 Trigger 堆疊 ✅
- 地雷 4：人類訊號被 AI 覆蓋 ✅

**系統改進**：
- 防止記憶無限膨脹，控制 Token 成本
- 可重入設計，狀態可回復，不會卡死
- 防止殭屍觸發器堆疊
- 人類永遠在最上層，系統可控

**下一步**：
- 測試可重入設計（模擬超時情況）
- 測試 Human Lock 機制（模擬人類覆蓋 AI 決策）
- 監控記憶壓縮效果（檢查 Token 使用量）
