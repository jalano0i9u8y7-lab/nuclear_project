# SSOT 架構師級審查報告 V8.34（2026-01-26）

**審查依據**：`架構師級SSOT檢查清單_V8.md` 五大區塊共 17 項。  
**審查對象**：`V8.0架構定案文檔_SSOT.md`（至 V8.33 目標架構為止）。  
**目的**：找出邏輯錯誤、系統打架、重複工作、無用工作、I/O 遺失、接口錯誤、無限迴圈、結構錯位、系統無法收斂等「未來會爆炸的點」。

---

## 一、架構層（Structure Integrity）

| # | 檢查項 | 結果 | 說明與建議 |
|---|--------|------|------------|
| **1** | Phase 職責唯一性 | ✅ 基本符合，⚠️ 一處需釐清 | **符合**：Regime 僅在 P5.7/WB-1 產出；risk_overlay 僅在 P3 計算，P4/P5 引用；DSFP 身份裁決僅在 WB-1；worldview 由 WB-1 產出、WB-2 引用。**需釐清**：現行 P5-B/P5-A 與目標 WB-1/WB-2/W-A 並存期間，「世界觀產出」的 Source of Truth 應明文化為「WB-1 實現完成前為 P5-B+P5-A，完成後為 WB-1」，避免雙軌並存時兩邊都改同一概念。 |
| **2** | 上游覆寫下游風險 | ✅ 符合 | One-Way 架構已明文化（後段不得改動前段結論；只能標註風險、降權、剔除）。P4 的 Market Climate Override 是「讀取 P5 世界觀後覆寫 U」，屬數據流覆寫而非 P5 改寫 P2/P3。Snapshot 設計為「每個 Phase 執行後保存、自動比對、觸發下游」；建議在 SSOT 中補一句：**下游必須引用 Snapshot/Delta Pack，不得重算上游結論**。 |
| **3** | 模組邊界模糊度 | ✅ 可接受 | 單一函數影響多 Phase 的案例（如 `risk_overlay_level` 在 P3 算、P4/P5 讀）已透過「單一產出、多處引用」界定清楚。DSFP 加強塊散見各 Phase，屬「同一規範多處植入」，非職責重疊。 |

**架構層小結**：無嚴重衝突。建議補強「下游僅引用 Snapshot、不重算」與「雙軌期間世界觀 SoT」的明文化。

---

## 二、邏輯層（Logic Conflict）

| # | 檢查項 | 結果 | 說明與建議 |
|---|--------|------|------------|
| **4** | 同一決策是否被多次計算 | ✅ 符合 | Regime 僅在 P5.7/WB-1；risk_overlay 僅在 P3；IDENTITY_DRIFT 僅在 WB-1；P4/P5 均為引用。 |
| **5** | 衝突優先權是否可見 | ⚠️ 部分符合 | **已有**：Market Climate Override > P4 Allocation > P5 Strategy > Individual Buy；Layer 1 硬約束 > Layer 2 軟引導 > Layer 3 自由空間；Learning constraints override strategy preferences。**建議**：在 SSOT 新增一節「**規則衝突優先權總表**」，集中列出：風控 > 市場氣候 > P4 U > IDENTITY_DRIFT 行為 > P5 策略 > 個股買入，以及 Hard Constraints 與 Scout/Deep Auditor 覆寫順序，方便工程師一眼查找。 |
| **6** | 隱性寫死 | ✅ 已處理 | V8.26 Prompt 調整原則已將「禁止」改為「謹慎 + 例外說明」；Layer 1 為風控寫死、Layer 2 為強烈建議+例外。 |

**邏輯層小結**：建議新增「規則衝突優先權總表」一節，其餘無打架。

---

## 三、資料流（Data Flow）

| # | 檢查項 | 結果 | 說明與建議 |
|---|--------|------|------------|
| **7** | 是否重複抓資料 | ✅ 目標架構已考慮 | 目標架構要求資料源抽象層、cache、fallback；P3 優先從結構化存儲讀、不足才補。建議在「數據源」或工程備忘錄中明確：**同一 API 由單一層/快取提供，多 Phase 從快取/DB 讀**，避免實作時各 Phase 各自打同一 API。 |
| **8** | 資料來源一致性 | ✅ 原則已有 | P2 統一數據源（財報狗/buffet code）；OHLCV/宏觀目標為可靠 API、單一來源。單位與粒度在 P2/P3/機構評級等處有分別說明，無發現同一指標多來源並存。 |
| **9** | Snapshot 真正有被用嗎 | ⚠️ 建議補強 | SSOT 已規定每個 Phase 保存快照、自動比對、觸發下游；P5 Weekly 必須使用 Delta Pack。**建議**：在「快照機制」或「One-Way 架構」下明文化「**下游僅能引用當次 Run 的 Snapshot/Delta Pack，不得重新執行上游 Phase 以取得結論**」，防止實作時「假引用、真重算」。 |

**資料流小結**：建議補「下游僅引用 Snapshot/Delta、不重算」與「同一 API 集中快取」的明文化。

---

## 四、AI 決策層（AI Freedom vs Constraint）

| # | 檢查項 | 結果 | 說明與建議 |
|---|--------|------|------------|
| **10** | Prompt 是否存在「自由區」 | ✅ 符合 | P5 Weekly 三層決策架構（硬約束 + 軟引導 + 自由空間）；Prompt 調整原則分 Layer 1～4（硬約束、強烈建議、軟引導、自由空間）。 |
| **11** | 是否允許例外 | ✅ 符合 | 例外機制已明文化（謹慎 + 說明理由）；Order Plan、財報前清倉等已軟化為強烈建議+例外。 |
| **12** | 是否有「不決策」出口 | ⚠️ 部分符合 | **已有**：GLOBAL_SYSTEM_BLOCK_DSFP_V1 規定「資料不足時標記 INSUFFICIENT_STATE_DATA，不得腦補」。**建議**：在「各階段 Prompt 補強參考」或 SSOT 的 AI 決策原則中，統一規定決策類 Prompt 應支援「不決策」出口，例如：**DATA_INSUFFICIENT**、**NEED_MORE_CONTEXT**、**FRAME_UNCERTAIN**，並規定輸出時需簡述理由，避免逼 AI 硬猜。 |
| **13** | 決策是否被 Prompt 提前鎖死 | ✅ 原則已有 | 角色校準器與未來對齊三問、反敘事義務等，有助於避免問題偏向單一結論。建議實作時在審查清單中保留「問題中立、不暗示答案」一項。 |

**AI 決策層小結**：建議在 SSOT 中統一規定「不決策」出口（DATA_INSUFFICIENT / NEED_MORE_CONTEXT / FRAME_UNCERTAIN）及使用情境。

---

## 五、系統健康層（Meta / 維運）

| # | 檢查項 | 結果 | 說明與建議 |
|---|--------|------|------------|
| **14** | 規則 TTL（過期機制） | ⚠️ 未明文化 | 目前未見「規則何時失效、由誰覆寫」的總則。**建議**：在 SSOT 原則或工程備忘錄中新增「**規則生命週期**」：例如風控規則由版本號/變更日標記、策略與權重建議由 Learning 與季度審查更新、Prompt 區塊由 SSOT 版本對應；重大規則變更須經審查並更新 SSOT 版本。 |
| **15** | 記憶壓力檢查 | ✅ 已考慮 | 三層記憶模型與壓縮機制、單 Cell 字數上限、compressAndArchiveOldMemory；Learning State 與 Safety Lock 有影響行為。可補一句原則：「**未影響行為的記憶應壓縮或歸檔，避免噪音**」。 |
| **16** | 模型替換彈性 | ⚠️ 未明文化 | 模型配置表綁定具體模型名；未見「換模型不應崩潰、Prompt 避免模型專用語法」的設計原則。**建議**：在 M0 或 Prompt 規範中新增「**模型無關原則**」：Prompt 與輸出 schema 不依賴單一模型特性；換模型時僅調整 M0 配置與必要參數，不重寫業務邏輯。 |
| **17** | 決策可視化能力 | ✅ 部分已有 | run_id/trace_id 全鏈路追蹤、Hard Constraints 程式覆寫寫入 audit_log 已在目標架構中。**建議**：明文化「**決策可追溯三層原因**」（例如：觸發規則 / 輸入狀態 / 輸出結論），供除錯與合規使用。 |

**系統健康層小結**：建議補「規則 TTL/生命週期」「模型無關原則」「決策可追溯三層原因」。

---

## 六、其他潛在風險（未在清單但審查中發現）

| 項目 | 風險 | 建議 |
|------|------|------|
| **WB-1/WB-2 與 P5-B/P5-A 雙軌** | 並存期間同一概念（如 worldview、Regime）可能來自兩套流程，介面不一致 | 在 SSOT 或工程備忘錄中定義「雙軌介面對齊表」，確保 P4/Learning 等消費者只依一組欄位名稱與型別讀取 |
| **P4 讀取 P5 世界觀** | Market Climate Override 需 P4 讀取「最新 world view」；若 P5 未寫入或延遲，P4 可能用舊值 | 明文化「P5 Weekly 必須將本輪 world view / regime 寫入 P4 可讀取處，且寫入順序在 P4 計算 U 之前」或由任務隊列順序保證 |
| **無限迴圈** | 未發現明顯「A 觸發 B、B 又觸發 A」的設計；可重入為過渡、目標為任務隊列，有助於避免 Trigger 串接造成的重複觸發 | 在任務隊列設計中明文化「同一 job_id 在 COMPLETED 前不重複排程」 |

---

## 七、建議補入 SSOT 的項目（優先級）

1. **高**  
   - **下游僅引用 Snapshot/Delta，不重算上游結論**（架構/快照機制）。  
   - **AI 決策「不決策」出口**：支援 DATA_INSUFFICIENT、NEED_MORE_CONTEXT、FRAME_UNCERTAIN，並簡述理由。  
   - **規則衝突優先權總表**：集中一節，列出風控 > 市場氣候 > P4 U > IDENTITY_DRIFT > P5 策略 > 個股，以及 Hard Constraints/審查覆寫順序。

2. **中**  
   - **規則生命週期/TTL 原則**：規則版本、覆寫權限、與 SSOT 版本對應。  
   - **模型無關原則**：Prompt 與 schema 不綁死單一模型；換模型僅改配置。  
   - **決策可追溯三層原因**：觸發規則、輸入狀態、輸出結論，並納入 audit/trace。

3. **低**  
   - 「未影響行為的記憶應壓縮或歸檔」。  
   - 「同一 API 由單一層/快取提供，多 Phase 自快取/DB 讀」。  
   - 雙軌期間「世界觀 SoT」與「P4 讀取 P5 世界觀」的順序保證。

---

## 八、結論

- **架構層、邏輯層、資料流**：未發現致命邏輯錯誤或系統打架；Regime/risk_overlay/IDENTITY_DRIFT 均為單一產出、多處引用。  
- **AI 決策層**：三層架構與例外機制已具備；建議補「不決策」出口的統一規範。  
- **系統健康層**：記憶與可追溯已有基礎；建議補規則 TTL、模型無關、決策可追溯三層原因。  

**整體**：SSOT 在五大區塊上大體對齊目標，無明顯「未來必爆」的結構性錯誤。依本報告「建議補入 SSOT 的項目」補強後，可作為定案與 Python 重建的穩定依據。

---

**報告完成日期**：2026-01-26  
**對應清單**：`架構師級SSOT檢查清單_V8.md`  
**對應 SSOT 版本**：V8.0 架構定案文檔（至 V8.33）
