# V8.13 ä¿®æ­£ï¼šå¾ Rule Engine â†’ Memory Managerï¼ˆæ¥µç°¡ RAGï¼‰

**æ—¥æœŸ**ï¼š2026-01-19  
**ä¿®æ­£åŸå› **ï¼šV7è¨­è¨ˆæ–¹å‘éŒ¯èª¤ - ä¸æ‡‰è©²ç”¨ç¨‹å¼å¯«å‹•æ…‹å­¸ç¿’ç³»çµ±ï¼Œæ‡‰è©²åšå¤–éƒ¨è¨˜æ†¶ç³»çµ±è®“AIæ¢å¾©è¨˜æ†¶

---

## ğŸ¯ æ ¸å¿ƒå“²å­¸è½‰è®Š

### âŒ éŒ¯èª¤æ–¹å‘ï¼ˆV7åŸå§‹è¨­è¨ˆï¼‰
- ç”¨ç¨‹å¼å¯«å‹•æ…‹å­¸ç¿’ç³»çµ±
- ç¨‹å¼è‡ªå‹•èª¿åƒã€è‡ªå‹•æ­¸å› ã€è‡ªå‹•æ±ºç­–

### âœ… æ­£ç¢ºæ–¹å‘ï¼ˆV8.13ä¿®æ­£ï¼‰
- **GASæ˜¯Librarianï¼ˆåœ–æ›¸é¤¨ç®¡ç†å“¡ï¼‰ï¼ŒAIæ˜¯Readerï¼ˆè®€è€…ï¼‰**
- GASè² è²¬æŠŠæœ€æœ‰ç”¨çš„è¨˜æ†¶ï¼ˆMemory Packï¼‰æ”¾åˆ°AIæ¡Œä¸Š
- AIè‡ªå·±åˆ¤æ–·å¦‚ä½•ç”¨éå»çš„ç¶“é©—èª¿æ•´ç¾åœ¨çš„ç­–ç•¥
- æ¯æ¬¡å‘¼å«AIéƒ½è®“ä»–å¤–æ¥è¨˜æ†¶åº«ï¼ŒçŸ¥é“ä¹‹å‰ç™¼ç”Ÿéä»€éº¼äº‹æƒ…

---

## ğŸ“‹ ä¿®æ­£å…§å®¹

### 0. ç›®æ¨™ï¼ˆç…§æŠ„ï¼‰

**æˆ‘å€‘ä¸åšç¨‹å¼å­¸ç¿’AIã€‚æˆ‘å€‘åšå¤–éƒ¨è¨˜æ†¶ç³»çµ±ï¼šä¿å­˜â†’æ‘˜è¦â†’æª¢ç´¢â†’çµ„è£Memory Packï¼Œè®“æ¯æ¬¡P5 Weeklyå‘¼å«AIéƒ½èƒ½"æ¢å¾©è¨˜æ†¶"ã€‚**

---

### 1. Keep vs Refactor

#### A) Traceabilityï¼ˆä¿ç•™ï¼‰

**ä¿ç•™ä¸¦æŒçºŒå¯«å…¥**ï¼š
- `P5__STRATEGY_SNAPSHOT`
- `P5__OUTCOME_SNAPSHOT`

**Snapshotå¿…é ˆåŒ…å«**ï¼š
- `executive_summary`ï¼ˆçŸ­æ‘˜è¦ï¼Œå¿…å¡«ï¼Œ<=300å­—ï¼Œç”±Weekly AIç”Ÿæˆï¼‰
- `claims_json`ï¼ˆMVP claimsï¼šDIRECTION / RISK_REGIME / FOCUS_BUCKETï¼‰
- `data_sources_json`
- `market_tags_json`ï¼ˆå¿…å¡«ï¼Œmust in allow-listï¼‰
- `full_strategy_json`ï¼ˆåŸå§‹å¤§æª”ï¼Œåƒ…å­˜æª”ï¼Œä¸é€²Promptï¼‰

#### B) Scorecardï¼ˆç°¡åŒ–ä¿ç•™ï¼Œåªåšæ•¸å­¸ï¼‰

**ç¨‹å¼åªç®—å®¢è§€æŒ‡æ¨™ï¼Œç¦æ­¢è§£é‡‹**ï¼š
- `directional_accuracy`ï¼ˆ0/1ï¼‰
- `timing_gap_days`ï¼ˆå¯ç”¨proxyï¼‰
- `magnitude_bias`ï¼ˆå¯ç”¨proxyï¼‰
- `max_drawdown`

**è¼¸å‡ºå­˜å…¥`scorecard_json`**ï¼Œä¸åŒ…å«ä»»ä½•è§£é‡‹æˆ–å»ºè­°ã€‚

#### C) Attribution Engine â†’ Reflection Agentï¼ˆé‡æ§‹ï¼šLogicâ†’Promptï¼‰

**åˆªé™¤**ï¼šä»»ä½•JS if-thenæ­¸å› æ¨¹

**æ–°å¢**ï¼š`generateReflectionWithAI(strategy_snapshot, outcome_snapshot, scorecard)`

**è¼¸å‡ºå›ºå®šschema**ï¼Œä¸¦å­˜å…¥DBï¼š
```json
{
  "root_cause": "A|B|C|D|UNCERTAIN",
  "lesson_learned": ["...max 3"],
  "evidence_pointers": ["snapshot_id/cluster_id/..."],
  "confidence": 0.0-1.0,
  "parameter_recommendations": {...}  // åƒ…å»ºè­°ï¼Œä¸è‡ªå‹•ç”Ÿæ•ˆ
}
```

**Guardrail**ï¼š`evidence_pointers`ç©º â†’ `root_cause`å¿…é ˆé™ç´š`UNCERTAIN`ã€‚

#### D) LEARNING_STATE â†’ Calibration Summary + Principlesï¼ˆé‡å¤§ä¿®æ­£ï¼‰

**LEARNING_STATEä¸å†æ˜¯ç¨‹å¼è‡ªå‹•èª¿åƒçš„æ§åˆ¶å™¨ï¼Œè€Œæ˜¯ã€Œçµ¦AIçš„æ ¡æº–æ‘˜è¦ã€ã€‚**

**çµæ§‹**ï¼š
- `calibration_summary_json`ï¼ˆæ•¸å­—çµ±è¨ˆèˆ‡è¶¨å‹¢ï¼‰
- `principles_summary`ï¼ˆé•·æœŸåŸå‰‡ï¼Œæœ€å¤š12æ¢ï¼ŒMarkdownæ ¼å¼ï¼‰
- `recommendations_json`ï¼ˆåƒæ•¸å»ºè­°ï¼Œåƒ…ä¾›promptåƒè€ƒï¼Œä¸è‡ªå‹•ç”Ÿæ•ˆï¼‰

**Principlesæ›´æ–°æ²»ç†**ï¼š
- åªå…è¨±Monthlyæ›´æ–°ä¸€æ¬¡ï¼ˆMonthly Reviewï¼‰
- å¿…é ˆå»é‡åˆä½µã€é™åˆ¶æ¢æ•¸ï¼ˆ<=12ï¼‰
- æ¯æ¢åŸå‰‡éœ€é™„ï¼š
  - `scope`ï¼ˆé©ç”¨æƒ…å¢ƒï¼‰
  - `exceptions`ï¼ˆä¾‹å¤–ï¼‰
  - `supporting_cases[]`ï¼ˆæ¡ˆä¾‹idï¼‰
  - `last_updated`
- **ç¦æ­¢ä¿®æ”¹SSOTæ†²æ³•ç´šåŸå‰‡**ï¼ˆæ¬Šè²¬åˆ†é›¢ç­‰ï¼‰

#### E) Scenario Memory â†’ Context Retrieverï¼ˆç°¡åŒ–ï¼šTag Retrievalï¼‰

**æ¯é€±ç”¢ç”Ÿ`market_tags[]`ï¼ˆallow-listï¼‰ï¼Œå¯«å…¥strategy/outcome snapshotã€‚**

**æ–°å¢**ï¼š`retrieveSimilarCases(tags)`
- å…ˆç”¨tagsæ’ˆæ­·å²æ¡ˆä¾‹
- å†æŒ‰ã€Œæœ€æ…˜/æœ€æœ‰æ•™è¨“ã€æ’åºï¼ˆä¾‹å¦‚drawdownå¤§ã€confidenceé«˜ï¼‰
- è¿”å›top 3â€“5çš„çŸ­æ‘˜è¦ï¼ˆä¸è¿”å›åŸå§‹é•·æ–‡ï¼‰

---

### 2. æ ¸å¿ƒï¼šMemory Pack Builderï¼ˆå¿…åšï¼‰

**æ–°å¢**ï¼š`buildWeeklyMemoryPack(current_context)`

**è¼¸å‡º**ï¼š`MEMORY_PACK_WEEKLY.json`ï¼Œæ§åˆ¶tokenï¼Œä¸è¶…è¼‰ã€‚

**Memory Packä¸‰å±¤æ¼æ–—ï¼ˆå›ºå®šé †åºï¼‰**ï¼š

1. **Short-term Memoryï¼ˆæœ€è¿‘4é€±ï¼‰**
   - åªå¡æ¯é€±`executive_summary` + `scorecard` + `top_lessons`
   - ç¦æ­¢å¡å®Œæ•´`strategy_output`

2. **Contextual Recallï¼ˆç›¸ä¼¼æ­·å²top 3â€“5ï¼‰**
   - æ¯å€‹æ¡ˆä¾‹åªå¡ï¼š
     - æƒ…å¢ƒtags
     - 1æ®µæ•™è¨“ï¼ˆlessonï¼‰
     - 1è¡Œçµæœï¼ˆreturn/mddï¼‰
     - evidence ids

3. **Long-term Principlesï¼ˆæ†²æ³•ï¼‰**
   - å¡`principles_summary`ï¼ˆ<=12æ¢ï¼‰

**Token Budget**ï¼š
- è¶…étoken budgetï¼šå…ˆç similar casesï¼Œå†ç çŸ­æœŸé€±æ•¸ï¼Œæœ€å¾Œæ‰ç principlesã€‚

---

### 3. ç¦æ­¢äº‹é …ï¼ˆå¯«æ­»ï¼‰

1. **ç¦æ­¢ä»»ä½•æ¨¡çµ„ç›´æ¥æ”¹ç­–ç•¥é‚è¼¯/if-then**
2. **AIçš„`parameter_recommendations`ä¸å¾—ç›´æ¥å¥—ç”¨åˆ°ç¨‹å¼åŸ·è¡Œå±¤**
3. **Safety Lockåªèƒ½è¼¸å‡ºã€Œå»ºè­°é™åˆ¶ã€ï¼Œç”±Weeklyæ±ºç­–æ¡ç”¨æˆ–overrideï¼ˆéœ€ç†ç”±+ç•™å­˜ï¼‰**

---

### 4. é–‹ç™¼é †åºï¼ˆé¿å…é‡å·¥ï¼‰

1. **å…ˆåšexecutive_summaryçš„ç”¢ç”Ÿèˆ‡å­˜æª”**ï¼ˆæ¯é€±ä¸€æ®µçŸ­æ‘˜è¦ï¼‰
2. **åšReflection Agent**ï¼ˆç”Ÿæˆlessonï¼‰
3. **åšTags allow-list + tagger**
4. **åšMemory Pack Builder**
5. **æœ€å¾Œæ‰åšMonthly Principles Summarizer**ï¼ˆæ²»ç†ï¼‰

---

## ğŸ“ Schema Refactoringï¼ˆ01_SHEETS_STRUCTURE.jsï¼‰

### A) P5__STRATEGY_SNAPSHOTï¼ˆWeeklyï¼‰

```javascript
{
  snapshot_id: "UUID",
  period_id: "2026-W03",
  period_start: "YYYY-MM-DD",
  period_end: "YYYY-MM-DD",
  executive_summary: "stringï¼ˆå¿…å¡«ï¼Œ<=300å­—ï¼Œç”±Weekly AIç”Ÿæˆï¼‰",
  market_tags_json: "arrayï¼ˆå¿…å¡«ï¼Œmust in allow-listï¼‰",
  claims_json: "arrayï¼ˆClaims MVP onlyï¼šDIRECTION / RISK_REGIME / FOCUS_BUCKETï¼‰",
  full_strategy_json: "objectï¼ˆåŸå§‹å¤§æª”ï¼Œåƒ…å­˜æª”ï¼Œä¸é€²Promptï¼‰",
  data_sources_json: "object",
  created_at: "timestamp"
}
```

### B) P5__OUTCOME_SNAPSHOTï¼ˆWeekly T+1ï¼‰

```javascript
{
  outcome_id: "UUID",
  ref_snapshot_id: "UUID",
  period_id: "2026-W03",
  scorecard_json: {
    accuracy: 0/1,
    timing_gap_days: "int|null",
    magnitude_bias: "float|null",
    max_drawdown: "float",
    notes: []
  },
  reflection_json: {
    root_cause: "A|B|C|D|UNCERTAIN",
    lessons: ["...max 3"],
    evidence_pointers: ["..."],  // empty => root_cause must be UNCERTAIN
    confidence: "0-1",
    parameter_suggestions: {}  // å»ºè­°ï¼Œä¸è‡ªå‹•ç”Ÿæ•ˆ
  },
  created_at: "timestamp"
}
```

### C) P5__LEARNING_STATEï¼ˆMonthlyï¼‰

```javascript
{
  state_id: "UUID",
  updated_at: "timestamp",
  principles_summary: "stringï¼ˆMarkdownï¼Œ<=12æ¢ï¼‰",
  active_calibration: "jsonï¼ˆå»ºè­°æ‘˜è¦ï¼›ä¾›promptåƒè€ƒï¼Œä¸ç›´æ¥æ”¹åŸ·è¡Œï¼‰"
}
```

---

## ğŸ”§ Module Specsï¼ˆ24_P5_WEEKLY_LEARNING.jsï¼‰

### A. Reflection Agentï¼ˆæ¯é€±æª¢è¨ï¼‰

**å‡½æ•¸**ï¼š`generateReflectionWithAI(strategy_snapshot, outcome_snapshot, scorecard)`

**ç›®æ¨™**ï¼šç”Ÿæˆã€Œæ•™è¨“ + è­‰æ“šã€é€±è¨˜ï¼Œä¸åšç¨‹å¼æ­¸å› æ¨¹

**Guardrail**ï¼šç„¡evidence â‡’ UNCERTAIN

### B. Context Retrieverï¼ˆæ¨™ç±¤æª¢ç´¢ï¼‰

**å®šç¾©**ï¼š`MARKET_TAGS_ALLOWLIST`ï¼ˆ30â€“50å€‹æ¨™ç±¤ï¼‰

**å‡½æ•¸**ï¼š`retrieveSimilarCases(current_tags)`

**é‚è¼¯**ï¼š
- `match_count`è¨ˆç®—ï¼ˆtagså‘½ä¸­æ•¸ï¼‰
- éæ¿¾ï¼šFAILæˆ–MDD>5%
- æ’åºï¼š`match_count desc â†’ drawdown desc â†’ recency desc`
- Top 2æ…˜æ¡ˆ + Top 1æˆåŠŸæ¡ˆï¼ˆé¿å…PTSDéåº¦ä¿å®ˆï¼‰
- å›å‚³ï¼š`executive_summary` + `lessons`ï¼ˆç¦æ­¢`full_strategy_json`ï¼‰

### C. Memory Pack Builder

**å‡½æ•¸**ï¼š`buildWeeklyMemoryPack(current_context)`

**ä¸‰å±¤çµæ§‹**ï¼š
1. **Layer 1 Principles**ï¼ˆæ°¸ä¸ç ï¼‰
2. **Layer 2 Short-term**ï¼ˆæœ€è¿‘4é€±ï¼š`executive_summary` + `scorecard` + `lessons`ï¼‰
3. **Layer 3 Contextual Recall**ï¼ˆTop 3ç›¸ä¼¼æ¡ˆä¾‹æ‘˜è¦ï¼‰

**Token Budget**ï¼šç”¨å€å¡Šé ç®—ï¼Œä¸ç”¨å­—æ•¸ï¼›è¶…å‡ºä¾åºè£åˆ‡ï¼ˆå…ˆç Layer 3ï¼Œå†ç Layer 2æœ€èˆŠï¼‰

### D. Principles Governorï¼ˆæœˆåº¦æ²»ç†ï¼‰

**å‡½æ•¸**ï¼š`updatePrinciples(monthly_reflections)`

**è¦å‰‡**ï¼š
- æ¯æœˆä¸€æ¬¡åˆä½µå»é‡ã€è¡çªç”¨Exceptionã€<=12æ¢
- Prompt guardrailï¼šç¦æ­¢ä¿®æ”¹SSOTæ†²æ³•ç´šåŸå‰‡ï¼ˆP3è¦–è§’ã€æ¬Šè²¬åˆ†å·¥ç­‰ï¼‰

---

## ğŸš€ Implementation Path

### Step 1: Tagger & Summarizer
- å¯¦ç¾`market_tags`ç”Ÿæˆï¼ˆallow-listï¼‰
- å¯¦ç¾`executive_summary`ç”Ÿæˆï¼ˆWeekly AIç”Ÿæˆï¼Œ<=300å­—ï¼‰

### Step 2: Reflection Agent
- å¯¦ç¾`generateReflectionWithAI()`
- å¯¦ç¾Guardrailæª¢æŸ¥

### Step 3: Memory Pack Builder
- å¯¦ç¾`buildWeeklyMemoryPack()`
- å¯¦ç¾ä¸‰å±¤æ¼æ–—å’ŒToken Budgetæ§åˆ¶

### Step 4: Monthly Governor
- å¯¦ç¾`updatePrinciples()`
- å¯¦ç¾Principlesæ²»ç†è¦å‰‡

---

## âš ï¸ é‡è¦æé†’

1. **æ ¸å¿ƒå“²å­¸**ï¼šGASæ˜¯Librarianï¼ŒAIæ˜¯Reader
2. **ç¦æ­¢è‡ªå‹•èª¿åƒ**ï¼šæ‰€æœ‰å»ºè­°éƒ½åªæ˜¯çµ¦AIåƒè€ƒï¼Œä¸è‡ªå‹•ç”Ÿæ•ˆ
3. **ç¦æ­¢æ”¹é‚è¼¯**ï¼šä»»ä½•æ¨¡çµ„ä¸å¾—ç›´æ¥æ”¹ç­–ç•¥é‚è¼¯/if-then
4. **Tokenæ§åˆ¶**ï¼šMemory Packå¿…é ˆæ§åˆ¶tokenï¼Œä¸è¶…è¼‰

---

**æ­¤æ–‡æª”å®šç¾©äº†V8.13ä¿®æ­£å¾Œçš„Memory Manageræ¶æ§‹ï¼Œå¾Rule Engineè½‰å‘æ¥µç°¡RAGç³»çµ±ã€‚**
