# V8.0 批次處理實現總結

**實現日期**：2026-01-17  
**狀態**：✅ 已完成

---

## 📋 實現內容

### ✅ 已實現的批次處理功能

#### 1. **P2 基本面分析批次處理** ✅
- **檔案**：`src/21_P2_FUNDAMENTAL_ANALYSIS.js`
- **批次大小**：6 家/批
- **實現內容**：
  - 添加 `P2_CONFIG.BATCH_SIZE = 6` 和 `P2_CONFIG.BATCH_DELAY_MS = 2000`
  - 修改 `P2_Execute` 函數，添加批次處理邏輯
  - 創建 `buildP2BatchPrompt` 函數（批次 Prompt 構建）
  - 創建 `waitForM0JobResultP2` 函數（等待批次結果）
  - 創建 `mergeP2BatchResults` 函數（合併批次結果）
- **Prompt 更新**：
  - 在 `buildP2Prompt` 中添加批次處理格式說明
  - 使用 `<<<COMPANY: TICKER>>>` 分隔符確保隔離

---

#### 2. **P2.5 機構級籌碼面分析批次處理** ✅
- **檔案**：`src/21_P2_5_SMART_MONEY.js`、`src/21_P2_5_PROMPT.js`
- **批次大小**：6 家/批
- **實現內容**：
  - 添加 `P2_5_CONFIG.BATCH_SIZE = 6` 和 `P2_5_CONFIG.BATCH_DELAY_MS = 2000`
  - 修改 `P2_5_Execute` 函數，添加批次處理邏輯
  - 創建 `buildP2_5BatchPrompt` 函數（批次 Prompt 構建）
  - 創建 `submitToM0JobQueue` 函數（P2.5 專用）
- **Prompt 更新**：
  - 在 `buildP2_5Prompt` 中添加批次處理格式說明
  - 使用 `<<<COMPANY: TICKER>>>` 分隔符確保隔離

---

#### 3. **P3 技術面分析批次處理** ✅
- **檔案**：`src/22_P3_CORE.js`、`src/22_P3_AI_ANALYSIS.js`
- **批次大小**：5 家/批（接近 200K 限制，必須保守）
- **實現內容**：
  - 添加 `P3_CONFIG.BATCH_SIZE = 5` 和 `P3_CONFIG.BATCH_DELAY_MS = 2000`
  - 修改 `P3_Execute` 函數，添加批次處理邏輯
  - 創建 `buildP3BatchPrompt` 函數（批次 Prompt 構建）
- **Prompt 更新**：
  - 在 `buildP3Prompt` 中添加批次處理格式說明
  - 使用 `<<<COMPANY: TICKER>>>` 分隔符確保隔離

---

#### 4. **M0 層面 Token 追蹤功能** ✅
- **檔案**：`src/03_M0_CORE.js`、`src/01_SHEETS_STRUCTURE.js`
- **實現內容**：
  - 在 `executeFlow` 函數中添加 Token 使用量追蹤
  - 累計每個步驟的 input/output tokens
  - 按模型記錄 Token 使用量和成本
  - 支援 Gemini Pro 超過 200K 的階梯價格計算
  - 更新 `saveJobResult` 函數，保存 Token 使用量到 M0__RESULT
  - 更新 `M0_RESULT_SCHEMA`，添加 `input_tokens`、`output_tokens`、`estimated_cost`、`token_usage_json` 欄位
  - 在 `M0__CROSSCHECK_LOG` 中記錄每步的 tokens（`input_tokens`、`output_tokens`）

---

## 🔧 技術細節

### 批次處理邏輯

所有批次處理函數都遵循相同的模式：

```javascript
// 1. 計算批次數
const BATCH_SIZE = CONFIG.BATCH_SIZE;
const totalBatches = Math.ceil(items.length / BATCH_SIZE);

// 2. 分批處理
for (let i = 0; i < items.length; i += BATCH_SIZE) {
  const batch = items.slice(i, i + BATCH_SIZE);
  const batchNumber = Math.floor(i / BATCH_SIZE) + 1;
  
  // 3. 構建批次 Prompt（包含批次隔離說明）
  const batchPrompt = buildBatchPrompt(batch, ..., batchNumber, totalBatches);
  
  // 4. 提交批次到 M0 Job Queue
  const batchJobId = submitToM0JobQueue(projectId, requestedFlow, {
    ...batchPayload,
    batch_number: batchNumber,
    total_batches: totalBatches,
    is_batch_processing: true
  });
  
  // 5. 批次間延遲（避免 API 限流）
  if (i + BATCH_SIZE < items.length) {
    Utilities.sleep(CONFIG.BATCH_DELAY_MS);
  }
}

// 6. 返回所有批次 job ID
return {
  status: "SUBMITTED",
  job_ids: allBatchJobIds,
  total_batches: totalBatches
};
```

---

### 批次隔離機制

**Prompt 層面**：
- 在批次 Prompt 開頭明確說明「批次處理模式」
- 要求使用 `<<<COMPANY: TICKER>>>` 分隔符分隔每檔股票
- 明確說明「每檔股票必須獨立分析，不得混線或交叉污染」

**輸出格式**：
- 要求每檔股票分別輸出結果
- 使用 ticker 作為 JSON key
- 在輸出中也使用 `<<<COMPANY: TICKER>>>` 標記（可選，主要用於驗證）

---

### Token 追蹤機制

**追蹤層級**：
1. **步驟層級**：每個步驟（EXECUTOR、AUDITOR）的 input/output tokens
2. **模型層級**：每個模型的累計 tokens 和成本
3. **任務層級**：整個任務的總 tokens 和總成本

**記錄位置**：
- `M0__RESULT` 表格：總 tokens、總成本、詳細使用量（JSON）
- `M0__CROSSCHECK_LOG` 表格：每步的 tokens（用於審計）

**成本計算**：
- 自動根據模型配置計算成本
- 支援 Gemini Pro 超過 200K 的階梯價格
- 使用 `estimateCost` 函數統一計算

---

## 📊 成本估算確認

**80 檔股票，月度成本**：**$404.64/月**

此估算基於：
- ✅ P2、P2.5、P3 已實現批次處理
- ✅ P5 Weekly 策略已實現批次處理
- ✅ P5 Daily 只做簡單快照留存（無 AI 推理）
- ✅ P3 週度只處理有變動的股票（假設 20%）

---

## 🎯 未來優化方向

### 1. 動態批次大小調整

**目標**：根據實際 Token 使用量動態調整批次大小，降低成本

**實現方式**：
1. 從 `M0__RESULT` 表格讀取實際 Token 使用量
2. 分析每批次的 Token 使用率（例如：156K / 200K = 78%）
3. 如果使用率低於 70%，可以增加批次大小（例如：6 家 → 7 家）
4. 如果使用率高於 90%，降低批次大小（例如：6 家 → 5 家）

**預期節省**：$20-50/月

---

### 2. Token 使用量分析報告

**目標**：定期分析 Token 使用量，找出優化機會

**分析維度**：
- 按階段分析（P2、P2.5、P3、P5 Weekly 策略）
- 按模型分析（Sonnet、GPT、Gemini）
- 按批次大小分析（5 家/批 vs 6 家/批）
- 找出異常高 Token 使用量的任務

**輸出**：
- 每週/每月 Token 使用量報告
- 成本優化建議（例如：哪個階段可以增加批次大小）

---

### 3. 批次結果合併自動化

**當前狀態**：
- P2 已實現測試模式下的批次結果合併
- P2.5 和 P3 批次結果需要手動合併（或等待 M0 自動處理）

**未來優化**：
- 實現統一的批次結果合併機制
- 支援異步批次處理（所有批次完成後自動合併）
- 批次結果驗證機制（確保所有批次都成功）

---

## ✅ 確認事項

1. ✅ **成本估算**：80 檔股票，約每月 $404.64（基於批次處理實現）
2. ✅ **批次處理實現**：P2、P2.5、P3 都已實現批次處理
3. ✅ **Token 追蹤功能**：M0 層面已實現 Token 使用量追蹤
4. ✅ **未來優化準備**：可以根據實際 Token 使用量動態調整批次大小

---

## 📝 注意事項

1. **M0__RESULT 表格結構更新**：
   - 已添加新欄位（`input_tokens`、`output_tokens`、`estimated_cost`、`token_usage_json`）
   - 如果表格已有數據，可能需要手動更新表格結構
   - 建議在初始化時檢查表格結構，自動添加缺失欄位

2. **批次結果處理**：
   - P2 在測試模式下會自動合併批次結果
   - P2.5 和 P3 批次結果需要通過 M0 自動處理（每個批次會單獨調用 `P2_5_ProcessM0Result` 或 `P3_ProcessM0Result`）
   - 未來需要實現統一的批次結果合併機制

3. **批次隔離驗證**：
   - 建議在實際使用中驗證批次隔離是否有效
   - 檢查輸出中是否出現不同股票的數據混線
   - 如果發現混線，需要調整 Prompt 或降低批次大小

---

**文檔版本**：V1.0  
**最後更新**：2026-01-17  
**狀態**：✅ 批次處理功能已全部實現完成
