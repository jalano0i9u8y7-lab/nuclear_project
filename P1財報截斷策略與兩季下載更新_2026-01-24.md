# P1財報截斷策略與兩季下載更新 - 2026-01-24

## 📋 問題與解決方案

### 問題 1：證據截斷會遺漏重要財報資訊

**原策略**：
- 按證據長度排序，移除最長的證據
- 問題：會完全遺漏某些證據條目

**新策略（智能截斷）**：
1. **優先保留所有證據條目**：不刪除整個證據
2. **截斷單個證據的內容**：如果單個證據的 `content` 超過 2000 字符，只截斷該證據的內容
3. **最後手段**：如果截斷內容後仍然超過 45000 字符，才移除最長的證據

---

### 問題 2：初次分析改為下載最新兩季

**原策略**：
- 初次分析：最新 10-K + 最新 2 個 10-Q（共 3 季）
- 季度更新：最新 10-Q（1 季）

**新策略**：
- 初次分析：最新 10-K + 最新 1 個 10-Q（共 2 季），或最新 2 個 10-Q（如果沒有 10-K）
- 季度更新：最新 10-Q（1 季）

---

## ✅ 實現細節

### 1. 智能截斷策略

```javascript
function smartTruncateEvidence(evidenceList, evidenceType) {
  // 步驟 1：截斷單個證據的內容（保留前 2000 字符）
  let truncated = evidenceList.map(evidence => {
    if (evidence.content && evidence.content.length > 2000) {
      return {
        ...evidence,
        content: evidence.content.substring(0, 2000) + '...[內容已截斷]'
      };
    }
    return evidence;
  });
  
  // 步驟 2：檢查總長度
  if (JSON.stringify(truncated).length > 45000) {
    // 步驟 3：如果仍然超過，移除最長的證據
    truncated = [...truncated].sort((a, b) => {
      return JSON.stringify(a).length - JSON.stringify(b).length;
    });
    
    while (truncated.length > 0 && JSON.stringify(truncated).length > 45000) {
      truncated.pop();  // 移除最長的
    }
  }
  
  return truncated;
}
```

### 2. 兩季下載邏輯

```javascript
if (isInitialAnalysis) {
  // 初次分析：最新 10-K + 最新 1 個 10-Q
  latest10K = findLatestFilingFromIndex_(cik, "10-K");
  latest10Qs = findLatestN10QsFromIndex_(cik, 1);  // 只取 1 個 10-Q
  
  // 處理 10-K（如果有）
  if (latest10K) { ... }
  
  // 處理 10-Q（1 個）
  for (const latest10Q of latest10Qs) { ... }
} else {
  // 季度更新：只下載最新 10-Q
  latest10Q = findLatestFilingFromIndex_(cik, "10-Q");
  if (latest10Q) { ... }
}
```

---

## 📊 效果對比

### 舊策略（移除證據）

**AMD 案例**：
- 原始：28 條 P1 證據
- 處理後：20 條（移除 8 條最長的證據）
- 問題：完全遺漏 8 條證據的資訊

### 新策略（截斷內容）

**AMD 案例**：
- 原始：28 條 P1 證據
- 處理後：28 條（保留所有證據）
  - 如果單個證據超過 2000 字符，截斷內容
  - 如果總長度仍然超過 45000 字符，才移除最長的證據
- 優點：盡量保留所有證據條目，只截斷內容

---

## 🎯 截斷策略優先級

1. **第一優先**：保留所有證據條目，只截斷單個證據的 `content` 字段
2. **第二優先**：如果截斷後仍然超過限制，移除最長的證據
3. **標記**：在日誌中記錄哪些證據被截斷或移除

---

## 📝 日誌輸出

### 情況 1：只截斷內容，保留所有證據

```
P1 財報：AMD P1 證據內容已截斷（保留所有 28 條證據，但部分內容已截斷）
```

### 情況 2：需要移除證據

```
P1 財報：AMD P1 證據過長（52000 字元），開始移除最長證據...
P1 財報：AMD P1 移除最長證據（3500 字元）
P1 財報：AMD P1 證據已截斷至 27 條（原始 28 條，45000 字元）
```

---

## ⚙️ 配置參數

```javascript
const MAX_CELL_CHARS = 45000;  // Google Sheets 單格最大字元數（留 5000 緩衝）
const MAX_EVIDENCE_CONTENT_CHARS = 2000;  // 單個證據內容最大長度（保留完整段落）
```

---

## ✅ 優點

1. **盡量保留完整段落**：優先截斷內容而非移除證據
2. **減少資訊遺漏**：所有證據條目都會保留（除非總長度仍然超過）
3. **智能處理**：根據實際情況自動選擇最佳策略
4. **完整日誌**：記錄所有截斷操作，便於追蹤

---

## 📊 初次分析改為兩季的影響

### 下載時間

- **舊策略**：3 季財報（10-K + 2 個 10-Q）
- **新策略**：2 季財報（10-K + 1 個 10-Q）
- **節省時間**：約 33% 的下載時間

### 資料完整性

- **10-K**：年度報告，包含完整年度資訊
- **10-Q**：季度報告，包含季度資訊
- **兩季足夠**：10-K + 最新 10-Q 通常包含足夠的資訊進行初次分析

---

**更新日期**：2026-01-24  
**狀態**：✅ **智能截斷策略已實現，初次分析改為兩季，已上傳到 GAS**
