# V8.13 V7設計與現有實現統整分析

**日期**：2026-01-19  
**目標**：統整V7設計與現有實現，避免重複工作，識別待實現項目

---

## 📊 現有實現狀況（V8.13）

### ✅ 已實現項目

#### 1. 策略比對機制（基礎版）
- **函數**：`compareStrategyWithReality(periodsAgo, periodType)`
- **位置**：`src/24_P5_WEEKLY_LEARNING.js`
- **功能**：
  - ✅ 支援週/月/季三種時間週期
  - ✅ 讀取前一時間週期的策略（從`P5__WEEKLY_STOCK_STRATEGIES`）
  - ✅ 讀取當前時間週期的市場真實反應（從`MARKET_OHLCV_DAILY`）
  - ✅ 計算方向準度（alignment_rate）
  - ✅ 區分對齊/未對齊策略
- **整合位置**：
  - ✅ `24_P5_WEEKLY_CORE.js`：Step 5.5（比對上一週）
  - ✅ `24_P5_MONTHLY.js`：Step 5.5（比對上一月）
  - ✅ `24_P5_QUARTERLY.js`：Step 3.5（比對上一季）

#### 2. 學習日誌保存
- **函數**：`saveStrategyComparisonToLearningLog(comparison, frequency)`
- **位置**：`src/24_P5_WEEKLY_LEARNING.js`
- **功能**：
  - ✅ 保存比對結果到`P5__LEARNING_LOG`
  - ✅ 支援WEEKLY/MONTHLY/QUARTERLY三種頻率
- **表格**：`P5__LEARNING_LOG`（已定義Schema）

#### 3. 數據-策略-結果追蹤鏈（部分實現）
- **函數**：`trackStockStrategies(stockStrategies, snapshot, dataSources)`
- **位置**：`src/24_P5_WEEKLY_LEARNING.js`
- **功能**：
  - ✅ 記錄策略產出時使用的數據來源（`data_sources_json`）
  - ✅ 保存到`P5__WEEKLY_STOCK_STRATEGIES`
- **表格欄位**：`data_sources_json`（已定義在Schema中）

---

## ❌ V7設計要求但未實現項目

### A. 數據–策略–結果追蹤鏈（完整版）

#### 1. STRATEGY_SNAPSHOT（策略快照）
- **狀態**：❌ 未實現
- **V7要求**：
  - 表格：`P5__STRATEGY_SNAPSHOT`
  - 欄位：`snapshot_id`, `created_at`, `period_type`, `period_id`, `data_summary_json`, `claims_json`（**核心**）, `strategy_output_json`, `data_sources_json`, `version`
  - **Claims結構化**：每個可驗證命題包含`claim_id`, `claim_type`, `claim_content`, `verification_window`, `verification_condition`
- **現有替代**：目前只有`P5__WEEKLY_STOCK_STRATEGIES`，沒有Claims結構化

#### 2. OUTCOME_SNAPSHOT（結果快照）
- **狀態**：❌ 未實現
- **V7要求**：
  - 表格：`P5__OUTCOME_SNAPSHOT`
  - 欄位：`outcome_id`, `strategy_snapshot_id`（外鍵）, `created_at`, `period_type`, `period_id`, `market_data_json`, `claims_verification_json`（**核心**）, `scorecard_json`, `attribution_json`, `version`
  - **Claims驗證**：對照STRATEGY_SNAPSHOT中的Claims，驗證是否通過
- **現有替代**：目前只有`P5__LEARNING_LOG`，沒有結構化的Claims驗證

### B. 策略比對機制（完整版 - 四項Scorecard）

#### 現有實現（部分）
- ✅ 方向準度（Directional Accuracy）：已實現（`alignment_rate`）
- ❌ 時機偏差（Timing Bias，日）：未實現
- ❌ 幅度偏差（Magnitude Bias，%）：未實現
- ❌ 最大回撤（Max Drawdown，%）：未實現

**V7要求**：
- 必須計算四項Scorecard
- 保存到OUTCOME_SNAPSHOT的`scorecard_json`欄位
- 用於觸發錯誤歸因（當Scorecard低於閾值時）

### C. 錯誤歸因引擎（Attribution Engine）

- **狀態**：❌ 未實現
- **V7要求**：
  - Type A：數據源污染（Data Source Contamination）
  - Type B：邏輯幻覺（Logic Hallucination）
  - Type C：執行滑價（Execution Slippage）
  - Type D：黑天鵝（Black Swan）
  - 必須選擇單一主因（可選次因）
  - 必須附Evidence pointers
  - 缺證據時標記`UNCERTAIN_CAUSE`，不得驅動回寫
  - 保存到OUTCOME_SNAPSHOT的`attribution_json`欄位

### D. 參數校準（LEARNING_STATE）

- **狀態**：❌ 未實現
- **V7要求**：
  - 表格：`P5__LEARNING_STATE`
  - 欄位：`state_id`, `created_at`, `updated_at`, `learning_state_json`（**核心**）
  - **權重呼吸（Breathing Weights）**：
    - `fundamental`, `chips`, `tech`, `macro`, `sentiment`（範圍：0.0-1.0，總和=1.0）
    - 每週最多 ±0.05
    - 每月才允許重新平衡到新穩態
  - **關鍵閾值縮放（Threshold Scaling）**：
    - `entry_confirmation_atr_multiple`（預設1.5）
    - `lock_profit_atr_multiple`（預設2.0）
    - `narrative_downgrade_strength`（預設0.3）
    - `risk_off_trigger_vix`（預設25.0）
    - `max_position_size`（預設0.15）
    - 每次調整幅度不超過±10%
  - **禁止事項**：禁止修改策略邏輯、if-then決策、程式邏輯
  - **唯一可回寫檔**：LEARNING_STATE.json（其他地方禁止寫參數）

### E. 情境記憶（SCENARIO_MEMORY / PTSD）

- **狀態**：❌ 未實現
- **V7要求**：
  - 表格：`P5__SCENARIO_MEMORY`
  - 欄位：`scenario_id`, `created_at`, `updated_at`, `scenario_signature_json`（**核心**）, `historical_occurrences_json`, `safety_lock_recommendations_json`
  - **情境簽章**：包含`vix_level`, `market_regime`, `sector_rotation`, `macro_indicators`, `news_sentiment`, `technical_signals`
  - **Safety Lock機制**：
    - 當死亡率>0.5時，輸出Safety Lock建議
    - 不得硬鎖執行，只能給Weekly限制建議
    - 可由Weekly Override，但必須留下理由
    - 納入下一輪比對

### F. 工程限制清單（5條）

- **狀態**：⚠️ 部分遵守
- **V7要求**：
  1. ✅ 唯一可回寫檔：LEARNING_STATE.json（目前沒有LEARNING_STATE，所以沒有違反）
  2. ❌ 回寫頻率限制：權重每週最多 ±0.05；每月才允許重新平衡到新穩態（未實現）
  3. ❌ Safety Lock不得硬鎖執行：只能給Weekly限制建議（未實現）
  4. ❌ 歸因無證據不得回寫：先標UNCERTAIN_CAUSE（未實現）
  5. ❌ Claims才評分：沒有被結構化成Claim的策略敘述不評分（未實現）

---

## 🔄 統整方案（避免重複工作）

### 方案1：擴展現有實現，而非重寫

#### A. STRATEGY_SNAPSHOT和OUTCOME_SNAPSHOT
- **策略**：在現有`trackStockStrategies()`基礎上擴充
- **修改點**：
  1. `trackStockStrategies()`：同時創建STRATEGY_SNAPSHOT（包含Claims結構化）
  2. `compareStrategyWithReality()`：創建OUTCOME_SNAPSHOT（包含Claims驗證和四項Scorecard）
  3. 保留現有`P5__WEEKLY_STOCK_STRATEGIES`（用於查詢和追蹤）

#### B. 四項Scorecard
- **策略**：擴展現有`compareStrategyWithReality()`函數
- **修改點**：
  1. 保留現有方向準度計算
  2. 新增時機偏差計算（需要策略中的timing信息）
  3. 新增幅度偏差計算（需要策略中的target_price或預期幅度）
  4. 新增最大回撤計算（需要策略執行期間的OHLCV數據）
  5. 保存到OUTCOME_SNAPSHOT的`scorecard_json`欄位

#### C. 錯誤歸因引擎
- **策略**：新增函數，在OUTCOME_SNAPSHOT創建後調用
- **修改點**：
  1. 新增`attributionEngine(scorecard, strategySnapshot, outcomeSnapshot)`函數
  2. 當Scorecard低於閾值時，觸發錯誤歸因
  3. 使用AI模型（Gemini Pro）進行歸因分析
  4. 保存到OUTCOME_SNAPSHOT的`attribution_json`欄位

#### D. LEARNING_STATE
- **策略**：新增表格和函數，與現有學習系統整合
- **修改點**：
  1. 新增`P5__LEARNING_STATE`表格Schema
  2. 新增`updateLearningState(attribution, scorecard)`函數
  3. 在錯誤歸因完成後，根據歸因結果更新LEARNING_STATE
  4. 實現回寫頻率限制檢查

#### E. SCENARIO_MEMORY
- **策略**：新增表格和函數，在策略輸出時提取情境簽章
- **修改點**：
  1. 新增`P5__SCENARIO_MEMORY`表格Schema
  2. 新增`extractScenarioSignature(strategySnapshot, marketData)`函數
  3. 在創建STRATEGY_SNAPSHOT時，同時提取情境簽章
  4. 新增`checkScenarioMemory(scenarioSignature)`函數（比對歷史，計算死亡率）
  5. 新增`generateSafetyLockRecommendations(mortalityRate)`函數

---

## 📋 實施優先級（避免重複工作）

### 優先級1：核心追蹤鏈（必須先實現）

1. **STRATEGY_SNAPSHOT和Claims結構化**
   - 擴展`trackStockStrategies()`，同時創建STRATEGY_SNAPSHOT
   - 實現Claims結構化函數（從策略中提取可驗證命題）
   - **注意**：保留現有`P5__WEEKLY_STOCK_STRATEGIES`，不刪除

2. **OUTCOME_SNAPSHOT和四項Scorecard**
   - 擴展`compareStrategyWithReality()`，創建OUTCOME_SNAPSHOT
   - 實現四項Scorecard計算（方向準度、時機偏差、幅度偏差、最大回撤）
   - **注意**：保留現有`P5__LEARNING_LOG`，OUTCOME_SNAPSHOT作為更結構化的版本

### 優先級2：錯誤歸因和參數校準

3. **錯誤歸因引擎**
   - 新增`attributionEngine()`函數
   - 整合到OUTCOME_SNAPSHOT創建流程

4. **LEARNING_STATE**
   - 新增表格Schema
   - 實現參數校準函數（權重呼吸、閾值縮放）
   - 實現回寫頻率限制檢查

### 優先級3：情境記憶

5. **SCENARIO_MEMORY和Safety Lock**
   - 新增表格Schema
   - 實現情境簽章提取和比對
   - 實現Safety Lock建議機制

---

## ⚠️ 重要注意事項

### 1. 保留現有實現
- **不刪除**：`P5__WEEKLY_STOCK_STRATEGIES`、`P5__LEARNING_LOG`、`compareStrategyWithReality()`、`saveStrategyComparisonToLearningLog()`
- **擴展而非重寫**：在現有基礎上擴充，而非重寫

### 2. 避免重複數據
- STRATEGY_SNAPSHOT和`P5__WEEKLY_STOCK_STRATEGIES`：STRATEGY_SNAPSHOT包含Claims結構化，`P5__WEEKLY_STOCK_STRATEGIES`保留用於查詢
- OUTCOME_SNAPSHOT和`P5__LEARNING_LOG`：OUTCOME_SNAPSHOT包含結構化的Claims驗證和Scorecard，`P5__LEARNING_LOG`保留用於歷史查詢

### 3. 向後兼容
- 現有的週度/月度/季度調用不需要修改
- 新功能作為擴展，不影響現有流程

---

## 🚀 實施計劃

### 第一步：實現STRATEGY_SNAPSHOT和Claims結構化
1. 新增表格Schema（`P5__STRATEGY_SNAPSHOT`）
2. 擴展`trackStockStrategies()`，同時創建STRATEGY_SNAPSHOT
3. 實現`extractClaimsFromStrategy(strategy)`函數（從策略中提取可驗證命題）

### 第二步：實現OUTCOME_SNAPSHOT和四項Scorecard
1. 新增表格Schema（`P5__OUTCOME_SNAPSHOT`）
2. 擴展`compareStrategyWithReality()`，創建OUTCOME_SNAPSHOT
3. 實現四項Scorecard計算函數

### 第三步：實現錯誤歸因引擎
1. 實現`attributionEngine()`函數
2. 整合到OUTCOME_SNAPSHOT創建流程

### 第四步：實現LEARNING_STATE
1. 新增表格Schema（`P5__LEARNING_STATE`）
2. 實現參數校準函數
3. 實現回寫頻率限制檢查

### 第五步：實現SCENARIO_MEMORY
1. 新增表格Schema（`P5__SCENARIO_MEMORY`）
2. 實現情境簽章提取和比對
3. 實現Safety Lock建議機制

---

**此文檔用於統整V7設計與現有實現，確保實施時不重複工作，不遺漏細節。**
